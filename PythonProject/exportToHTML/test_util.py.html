<html>
<head>
<title>test_util.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_util.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Tests for distutils.util.&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">email</span>
<span class="s2">import </span><span class="s1">email</span><span class="s3">.</span><span class="s1">generator</span>
<span class="s2">import </span><span class="s1">email</span><span class="s3">.</span><span class="s1">policy</span>
<span class="s2">import </span><span class="s1">io</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">pathlib</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">sysconfig </span><span class="s2">as </span><span class="s1">stdlib_sysconfig</span>
<span class="s2">import </span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">mock </span><span class="s2">as </span><span class="s1">mock</span>
<span class="s2">from </span><span class="s1">copy </span><span class="s2">import </span><span class="s1">copy</span>
<span class="s2">from </span><span class="s1">distutils </span><span class="s2">import </span><span class="s1">sysconfig</span><span class="s3">, </span><span class="s1">util</span>
<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">DistutilsByteCompileError</span><span class="s3">, </span><span class="s1">DistutilsPlatformError</span>
<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">util </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">byte_compile</span><span class="s3">,</span>
    <span class="s1">change_root</span><span class="s3">,</span>
    <span class="s1">check_environ</span><span class="s3">,</span>
    <span class="s1">convert_path</span><span class="s3">,</span>
    <span class="s1">get_host_platform</span><span class="s3">,</span>
    <span class="s1">get_platform</span><span class="s3">,</span>
    <span class="s1">grok_environment_error</span><span class="s3">,</span>
    <span class="s1">rfc822_escape</span><span class="s3">,</span>
    <span class="s1">split_quoted</span><span class="s3">,</span>
    <span class="s1">strtobool</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">import </span><span class="s1">pytest</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">autouse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">environment</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">os</span><span class="s3">, </span><span class="s4">'name'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">, </span><span class="s4">'platform'</span><span class="s3">, </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform</span><span class="s3">)</span>
    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">, </span><span class="s4">'version'</span><span class="s3">, </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version</span><span class="s3">)</span>
    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">os</span><span class="s3">, </span><span class="s4">'sep'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>
    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s4">'join'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">)</span>
    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s4">'isabs'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isabs</span><span class="s3">)</span>
    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s4">'splitdrive'</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitdrive</span><span class="s3">)</span>
    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">sysconfig</span><span class="s3">, </span><span class="s4">'_config_vars'</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">(</span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">_config_vars</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">'save_env'</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestUtil</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_get_host_platform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">(</span><span class="s4">'os.name'</span><span class="s3">, </span><span class="s4">'nt'</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">(</span><span class="s4">'sys.version'</span><span class="s3">, </span><span class="s4">'... [... (ARM64)]'</span><span class="s3">):</span>
                <span class="s2">assert </span><span class="s1">get_host_platform</span><span class="s3">() == </span><span class="s4">'win-arm64'</span>
            <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">(</span><span class="s4">'sys.version'</span><span class="s3">, </span><span class="s4">'... [... (ARM)]'</span><span class="s3">):</span>
                <span class="s2">assert </span><span class="s1">get_host_platform</span><span class="s3">() == </span><span class="s4">'win-arm32'</span>

        <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">(</span><span class="s4">'sys.version_info'</span><span class="s3">, (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s4">'final'</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)):</span>
            <span class="s2">assert </span><span class="s1">get_host_platform</span><span class="s3">() == </span><span class="s1">stdlib_sysconfig</span><span class="s3">.</span><span class="s1">get_platform</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_get_platform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">(</span><span class="s4">'os.name'</span><span class="s3">, </span><span class="s4">'nt'</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">.</span><span class="s1">dict</span><span class="s3">(</span><span class="s4">'os.environ'</span><span class="s3">, {</span><span class="s4">'VSCMD_ARG_TGT_ARCH'</span><span class="s3">: </span><span class="s4">'x86'</span><span class="s3">}):</span>
                <span class="s2">assert </span><span class="s1">get_platform</span><span class="s3">() == </span><span class="s4">'win32'</span>
            <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">.</span><span class="s1">dict</span><span class="s3">(</span><span class="s4">'os.environ'</span><span class="s3">, {</span><span class="s4">'VSCMD_ARG_TGT_ARCH'</span><span class="s3">: </span><span class="s4">'x64'</span><span class="s3">}):</span>
                <span class="s2">assert </span><span class="s1">get_platform</span><span class="s3">() == </span><span class="s4">'win-amd64'</span>
            <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">.</span><span class="s1">dict</span><span class="s3">(</span><span class="s4">'os.environ'</span><span class="s3">, {</span><span class="s4">'VSCMD_ARG_TGT_ARCH'</span><span class="s3">: </span><span class="s4">'arm'</span><span class="s3">}):</span>
                <span class="s2">assert </span><span class="s1">get_platform</span><span class="s3">() == </span><span class="s4">'win-arm32'</span>
            <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">.</span><span class="s1">dict</span><span class="s3">(</span><span class="s4">'os.environ'</span><span class="s3">, {</span><span class="s4">'VSCMD_ARG_TGT_ARCH'</span><span class="s3">: </span><span class="s4">'arm64'</span><span class="s3">}):</span>
                <span class="s2">assert </span><span class="s1">get_platform</span><span class="s3">() == </span><span class="s4">'win-arm64'</span>

    <span class="s2">def </span><span class="s1">test_convert_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">.</span><span class="s1">join</span><span class="s3">((</span><span class="s4">''</span><span class="s3">, </span><span class="s4">'home'</span><span class="s3">, </span><span class="s4">'to'</span><span class="s3">, </span><span class="s4">'my'</span><span class="s3">, </span><span class="s4">'stuff'</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">convert_path</span><span class="s3">(</span><span class="s4">'/home/to/my/stuff'</span><span class="s3">) == </span><span class="s1">expected</span>
        <span class="s2">assert </span><span class="s1">convert_path</span><span class="s3">(</span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s4">'/home/to/my/stuff'</span><span class="s3">)) == </span><span class="s1">expected</span>
        <span class="s2">assert </span><span class="s1">convert_path</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">) == </span><span class="s1">os</span><span class="s3">.</span><span class="s1">curdir</span>

    <span class="s2">def </span><span class="s1">test_change_root</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># linux/mac</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s4">'posix'</span>

        <span class="s2">def </span><span class="s1">_isabs</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">path</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">'/'</span>

        <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isabs </span><span class="s3">= </span><span class="s1">_isabs</span>

        <span class="s2">def </span><span class="s1">_join</span><span class="s3">(*</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s4">'/'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>

        <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join </span><span class="s3">= </span><span class="s1">_join</span>

        <span class="s2">assert </span><span class="s1">change_root</span><span class="s3">(</span><span class="s4">'/root'</span><span class="s3">, </span><span class="s4">'/old/its/here'</span><span class="s3">) == </span><span class="s4">'/root/old/its/here'</span>
        <span class="s2">assert </span><span class="s1">change_root</span><span class="s3">(</span><span class="s4">'/root'</span><span class="s3">, </span><span class="s4">'its/here'</span><span class="s3">) == </span><span class="s4">'/root/its/here'</span>

        <span class="s6"># windows</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s4">'nt'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">sep </span><span class="s3">= </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">'</span>

        <span class="s2">def </span><span class="s1">_isabs</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">path</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'c:</span><span class="s2">\\</span><span class="s4">'</span><span class="s3">)</span>

        <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isabs </span><span class="s3">= </span><span class="s1">_isabs</span>

        <span class="s2">def </span><span class="s1">_splitdrive</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">path</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'c:'</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s3">(</span><span class="s4">''</span><span class="s3">, </span><span class="s1">path</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'c:'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">))</span>
            <span class="s2">return </span><span class="s3">(</span><span class="s4">''</span><span class="s3">, </span><span class="s1">path</span><span class="s3">)</span>

        <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitdrive </span><span class="s3">= </span><span class="s1">_splitdrive</span>

        <span class="s2">def </span><span class="s1">_join</span><span class="s3">(*</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>

        <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join </span><span class="s3">= </span><span class="s1">_join</span>

        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">change_root</span><span class="s3">(</span><span class="s4">'c:</span><span class="s2">\\</span><span class="s4">root'</span><span class="s3">, </span><span class="s4">'c:</span><span class="s2">\\</span><span class="s4">old</span><span class="s2">\\</span><span class="s4">its</span><span class="s2">\\</span><span class="s4">here'</span><span class="s3">) == </span><span class="s4">'c:</span><span class="s2">\\</span><span class="s4">root</span><span class="s2">\\</span><span class="s4">old</span><span class="s2">\\</span><span class="s4">its</span><span class="s2">\\</span><span class="s4">here'</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">change_root</span><span class="s3">(</span><span class="s4">'c:</span><span class="s2">\\</span><span class="s4">root'</span><span class="s3">, </span><span class="s4">'its</span><span class="s2">\\</span><span class="s4">here'</span><span class="s3">) == </span><span class="s4">'c:</span><span class="s2">\\</span><span class="s4">root</span><span class="s2">\\</span><span class="s4">its</span><span class="s2">\\</span><span class="s4">here'</span>

        <span class="s6"># BugsBunny os (it's a great os)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s4">'BugsBunny'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">DistutilsPlatformError</span><span class="s3">):</span>
            <span class="s1">change_root</span><span class="s3">(</span><span class="s4">'c:</span><span class="s2">\\</span><span class="s4">root'</span><span class="s3">, </span><span class="s4">'its</span><span class="s2">\\</span><span class="s4">here'</span><span class="s3">)</span>

        <span class="s6"># XXX platforms to be covered: mac</span>

    <span class="s2">def </span><span class="s1">test_check_environ</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">util</span><span class="s3">.</span><span class="s1">check_environ</span><span class="s3">.</span><span class="s1">cache_clear</span><span class="s3">()</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">'HOME'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

        <span class="s1">check_environ</span><span class="s3">()</span>

        <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s4">'PLAT'</span><span class="s3">] == </span><span class="s1">get_platform</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s4">&quot;os.name != 'posix'&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_check_environ_getpwuid</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">util</span><span class="s3">.</span><span class="s1">check_environ</span><span class="s3">.</span><span class="s1">cache_clear</span><span class="s3">()</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">'HOME'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

        <span class="s2">import </span><span class="s1">pwd</span>

        <span class="s6"># only set pw_dir field, other fields are not used</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">pwd</span><span class="s3">.</span><span class="s1">struct_passwd</span><span class="s3">((</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s4">'/home/distutils'</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
        <span class="s3">))</span>
        <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">.</span><span class="s1">object</span><span class="s3">(</span><span class="s1">pwd</span><span class="s3">, </span><span class="s4">'getpwuid'</span><span class="s3">, </span><span class="s1">return_value</span><span class="s3">=</span><span class="s1">result</span><span class="s3">):</span>
            <span class="s1">check_environ</span><span class="s3">()</span>
            <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s4">'HOME'</span><span class="s3">] == </span><span class="s4">'/home/distutils'</span>

        <span class="s1">util</span><span class="s3">.</span><span class="s1">check_environ</span><span class="s3">.</span><span class="s1">cache_clear</span><span class="s3">()</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">'HOME'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

        <span class="s6"># bpo-10496: Catch pwd.getpwuid() error</span>
        <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">.</span><span class="s1">object</span><span class="s3">(</span><span class="s1">pwd</span><span class="s3">, </span><span class="s4">'getpwuid'</span><span class="s3">, </span><span class="s1">side_effect</span><span class="s3">=</span><span class="s1">KeyError</span><span class="s3">):</span>
            <span class="s1">check_environ</span><span class="s3">()</span>
            <span class="s2">assert </span><span class="s4">'HOME' </span><span class="s2">not in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span>

    <span class="s2">def </span><span class="s1">test_split_quoted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">split_quoted</span><span class="s3">(</span><span class="s4">'&quot;&quot;one&quot;&quot; &quot;two&quot; </span><span class="s2">\'</span><span class="s4">three</span><span class="s2">\' \\</span><span class="s4">four'</span><span class="s3">) == [</span>
            <span class="s4">'one'</span><span class="s3">,</span>
            <span class="s4">'two'</span><span class="s3">,</span>
            <span class="s4">'three'</span><span class="s3">,</span>
            <span class="s4">'four'</span><span class="s3">,</span>
        <span class="s3">]</span>

    <span class="s2">def </span><span class="s1">test_strtobool</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">yes </span><span class="s3">= (</span><span class="s4">'y'</span><span class="s3">, </span><span class="s4">'Y'</span><span class="s3">, </span><span class="s4">'yes'</span><span class="s3">, </span><span class="s4">'True'</span><span class="s3">, </span><span class="s4">'t'</span><span class="s3">, </span><span class="s4">'true'</span><span class="s3">, </span><span class="s4">'True'</span><span class="s3">, </span><span class="s4">'On'</span><span class="s3">, </span><span class="s4">'on'</span><span class="s3">, </span><span class="s4">'1'</span><span class="s3">)</span>
        <span class="s1">no </span><span class="s3">= (</span><span class="s4">'n'</span><span class="s3">, </span><span class="s4">'no'</span><span class="s3">, </span><span class="s4">'f'</span><span class="s3">, </span><span class="s4">'false'</span><span class="s3">, </span><span class="s4">'off'</span><span class="s3">, </span><span class="s4">'0'</span><span class="s3">, </span><span class="s4">'Off'</span><span class="s3">, </span><span class="s4">'No'</span><span class="s3">, </span><span class="s4">'N'</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">y </span><span class="s2">in </span><span class="s1">yes</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">strtobool</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">no</span><span class="s3">:</span>
            <span class="s2">assert not </span><span class="s1">strtobool</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>

    <span class="s1">indent </span><span class="s3">= </span><span class="s5">8 </span><span class="s3">* </span><span class="s4">' '</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;given,wanted&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s6"># 0x0b, 0x0c, ..., etc are also considered a line break by Python</span>
            <span class="s3">(</span><span class="s4">&quot;hello</span><span class="s2">\x0b\n</span><span class="s4">world</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">f&quot;hello</span><span class="s2">\x0b{</span><span class="s1">indent</span><span class="s2">}\n{</span><span class="s1">indent</span><span class="s2">}</span><span class="s4">world</span><span class="s2">\n{</span><span class="s1">indent</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;hello</span><span class="s2">\x1e</span><span class="s4">world&quot;</span><span class="s3">, </span><span class="s4">f&quot;hello</span><span class="s2">\x1e{</span><span class="s1">indent</span><span class="s2">}</span><span class="s4">world&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s4">&quot;I am a</span><span class="s2">\n</span><span class="s4">poor</span><span class="s2">\n</span><span class="s4">lonesome</span><span class="s2">\n</span><span class="s4">header</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;I am a</span><span class="s2">\n{</span><span class="s1">indent</span><span class="s2">}</span><span class="s4">poor</span><span class="s2">\n{</span><span class="s1">indent</span><span class="s2">}</span><span class="s4">lonesome</span><span class="s2">\n{</span><span class="s1">indent</span><span class="s2">}</span><span class="s4">header</span><span class="s2">\n{</span><span class="s1">indent</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_rfc822_escape</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">given</span><span class="s3">, </span><span class="s1">wanted</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        We want to ensure a multi-line header parses correctly. 
 
        For interoperability, the escaped value should also &quot;round-trip&quot; over 
        `email.generator.Generator.flatten` and `email.message_from_*` 
        (see pypa/setuptools#4033). 
 
        The main issue is that internally `email.policy.EmailPolicy` uses 
        `splitlines` which will split on some control chars. If all the new lines 
        are not prefixed with spaces, the parser will interrupt reading 
        the current header and produce an incomplete value, while 
        incorrectly interpreting the rest of the headers as part of the payload. 
        &quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">rfc822_escape</span><span class="s3">(</span><span class="s1">given</span><span class="s3">)</span>

        <span class="s1">policy </span><span class="s3">= </span><span class="s1">email</span><span class="s3">.</span><span class="s1">policy</span><span class="s3">.</span><span class="s1">EmailPolicy</span><span class="s3">(</span>
            <span class="s1">utf8</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s1">mangle_from_</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">max_line_length</span><span class="s3">=</span><span class="s5">0</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">with </span><span class="s1">io</span><span class="s3">.</span><span class="s1">StringIO</span><span class="s3">() </span><span class="s2">as </span><span class="s1">buffer</span><span class="s3">:</span>
            <span class="s1">raw </span><span class="s3">= </span><span class="s4">f&quot;header: </span><span class="s2">{</span><span class="s1">res</span><span class="s2">}\n</span><span class="s4">other-header: 42</span><span class="s2">\n\n</span><span class="s4">payload</span><span class="s2">\n</span><span class="s4">&quot;</span>
            <span class="s1">orig </span><span class="s3">= </span><span class="s1">email</span><span class="s3">.</span><span class="s1">message_from_string</span><span class="s3">(</span><span class="s1">raw</span><span class="s3">)</span>
            <span class="s1">email</span><span class="s3">.</span><span class="s1">generator</span><span class="s3">.</span><span class="s1">Generator</span><span class="s3">(</span><span class="s1">buffer</span><span class="s3">, </span><span class="s1">policy</span><span class="s3">=</span><span class="s1">policy</span><span class="s3">).</span><span class="s1">flatten</span><span class="s3">(</span><span class="s1">orig</span><span class="s3">)</span>
            <span class="s1">buffer</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
            <span class="s1">regen </span><span class="s3">= </span><span class="s1">email</span><span class="s3">.</span><span class="s1">message_from_file</span><span class="s3">(</span><span class="s1">buffer</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">msg </span><span class="s2">in </span><span class="s3">(</span><span class="s1">orig</span><span class="s3">, </span><span class="s1">regen</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">msg</span><span class="s3">.</span><span class="s1">get_payload</span><span class="s3">() == </span><span class="s4">&quot;payload</span><span class="s2">\n</span><span class="s4">&quot;</span>
            <span class="s2">assert </span><span class="s1">msg</span><span class="s3">[</span><span class="s4">&quot;other-header&quot;</span><span class="s3">] == </span><span class="s4">&quot;42&quot;</span>
            <span class="s6"># Generator may replace control chars with `\n`</span>
            <span class="s2">assert </span><span class="s1">set</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">[</span><span class="s4">&quot;header&quot;</span><span class="s3">].</span><span class="s1">splitlines</span><span class="s3">()) == </span><span class="s1">set</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">splitlines</span><span class="s3">())</span>

        <span class="s2">assert </span><span class="s1">res </span><span class="s3">== </span><span class="s1">wanted</span>

    <span class="s2">def </span><span class="s1">test_dont_write_bytecode</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># makes sure byte_compile raise a DistutilsError</span>
        <span class="s6"># if sys.dont_write_bytecode is True</span>
        <span class="s1">old_dont_write_bytecode </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">dont_write_bytecode</span>
        <span class="s1">sys</span><span class="s3">.</span><span class="s1">dont_write_bytecode </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">DistutilsByteCompileError</span><span class="s3">):</span>
                <span class="s1">byte_compile</span><span class="s3">([])</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">sys</span><span class="s3">.</span><span class="s1">dont_write_bytecode </span><span class="s3">= </span><span class="s1">old_dont_write_bytecode</span>

    <span class="s2">def </span><span class="s1">test_grok_environment_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test obsolete function to ensure backward compat (#4931)</span>
        <span class="s1">exc </span><span class="s3">= </span><span class="s1">OSError</span><span class="s3">(</span><span class="s4">&quot;Unable to find batch file&quot;</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s1">grok_environment_error</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">msg </span><span class="s3">== </span><span class="s4">&quot;error: Unable to find batch file&quot;</span>
</pre>
</body>
</html>