<html>
<head>
<title>builders.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
builders.py</font>
</center></td></tr></table>
<pre><span class="s0">#  Copyright 2008-2015 Nokia Networks</span>
<span class="s0">#  Copyright 2016-     Robot Framework Foundation</span>
<span class="s0">#</span>
<span class="s0">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0">#  you may not use this file except in compliance with the License.</span>
<span class="s0">#  You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="s0">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0">#  See the License for the specific language governing permissions and</span>
<span class="s0">#  limitations under the License.</span>

<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">normpath</span>
<span class="s2">from </span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">Path</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">cast</span><span class="s3">, </span><span class="s1">Sequence</span>

<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">conf </span><span class="s2">import </span><span class="s1">LanguagesLike</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">DataError</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">output </span><span class="s2">import </span><span class="s1">LOGGER</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">parsing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">SuiteDirectory</span><span class="s3">, </span><span class="s1">SuiteFile</span><span class="s3">, </span><span class="s1">SuiteStructure</span><span class="s3">, </span><span class="s1">SuiteStructureBuilder</span><span class="s3">,</span>
    <span class="s1">SuiteStructureVisitor</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">Importer</span><span class="s3">, </span><span class="s1">seq2str</span><span class="s3">, </span><span class="s1">split_args_from_name_or_path</span><span class="s3">, </span><span class="s1">type_name</span>

<span class="s2">from </span><span class="s3">..</span><span class="s1">model </span><span class="s2">import </span><span class="s1">TestSuite</span>
<span class="s2">from </span><span class="s3">..</span><span class="s1">resourcemodel </span><span class="s2">import </span><span class="s1">ResourceFile</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">parsers </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">CustomParser</span><span class="s3">, </span><span class="s1">JsonParser</span><span class="s3">, </span><span class="s1">NoInitFileDirectoryParser</span><span class="s3">, </span><span class="s1">Parser</span><span class="s3">, </span><span class="s1">RestParser</span><span class="s3">, </span><span class="s1">RobotParser</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">settings </span><span class="s2">import </span><span class="s1">TestDefaults</span>


<span class="s2">class </span><span class="s1">TestSuiteBuilder</span><span class="s3">:</span>
    <span class="s4">&quot;&quot;&quot;Builder to construct ``TestSuite`` objects based on data on the disk. 
 
    The :meth:`build` method constructs executable 
    :class:`~robot.running.model.TestSuite` objects based on test data files 
    or directories. There are two main use cases for this API: 
 
    - Execute the created suite by using its 
      :meth:`~robot.running.model.TestSuite.run` method. The suite can be 
      modified before execution if needed. 
 
    - Inspect the suite to see, for example, what tests it has or what tags 
      tests have. This can be more convenient than using the lower level 
      :mod:`~robot.parsing` APIs. 
 
    Both modifying the suite and inspecting what data it contains are easiest 
    done by using the :mod:`~robot.model.visitor` interface. 
 
    This class is part of the public API and should be imported via the 
    :mod:`robot.api` package. An alternative is using the 
    :meth:`TestSuite.from_file_system &lt;robot.running.model.TestSuite.from_file_system&gt;` 
    classmethod that uses this class internally. 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">included_suites</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s5">&quot;DEPRECATED&quot;</span><span class="s3">,</span>
        <span class="s1">included_extensions</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = (</span><span class="s5">&quot;.robot&quot;</span><span class="s3">, </span><span class="s5">&quot;.rbt&quot;</span><span class="s3">, </span><span class="s5">&quot;.robot.rst&quot;</span><span class="s3">),</span>
        <span class="s1">included_files</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = (),</span>
        <span class="s1">custom_parsers</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = (),</span>
        <span class="s1">defaults</span><span class="s3">: </span><span class="s5">&quot;TestDefaults|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">rpa</span><span class="s3">: </span><span class="s5">&quot;bool|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">lang</span><span class="s3">: </span><span class="s1">LanguagesLike </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">allow_empty_suite</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">process_curdir</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot; 
        :param included_suites: 
            This argument used to be used for limiting what suite file to parse. 
            It is deprecated and has no effect starting from RF 6.1. Use the 
            new ``included_files`` argument or filter the created suite after 
            parsing instead. 
        :param included_extensions: 
            List of extensions of files to parse. Same as ``--extension``. 
        :param included_files: 
            List of names, paths or directory paths of files to parse. All files 
            are parsed by default. Same as `--parse-include`. New in RF 6.1. 
        :param custom_parsers: 
            Custom parsers as names or paths (same as ``--parser``) or as 
            parser objects. New in RF 6.1. 
        :param defaults: 
            Possible test specific defaults from suite initialization files. 
            New in RF 6.1. 
        :param rpa: 
            Explicit execution mode. ``True`` for RPA and ``False`` for test 
            automation. By default, mode is got from data file headers. 
            Same as ``--rpa`` or ``--norpa``. 
        :param lang: 
            Additional languages to be supported during parsing. 
            Can be a string matching any of the supported language codes or names, 
            an initialized :class:`~robot.conf.languages.Language` subclass, 
            a list containing such strings or instances, or a 
            :class:`~robot.conf.languages.Languages` instance. 
        :param allow_empty_suite: 
            Specify is it an error if the built suite contains no tests. 
            Same as ``--runemptysuite``. 
        :param process_curdir: 
            Control processing the special ``${CURDIR}`` variable. It is 
            resolved already at parsing time by default, but that can be 
            changed by giving this argument ``False`` value. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">standard_parsers </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_standard_parsers</span><span class="s3">(</span><span class="s1">lang</span><span class="s3">, </span><span class="s1">process_curdir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">custom_parsers </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_custom_parsers</span><span class="s3">(</span><span class="s1">custom_parsers</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">defaults </span><span class="s3">= </span><span class="s1">defaults</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">included_extensions </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">included_extensions </span><span class="s2">or </span><span class="s3">())</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">included_files </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">included_files </span><span class="s2">or </span><span class="s3">())</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rpa </span><span class="s3">= </span><span class="s1">rpa</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">allow_empty_suite </span><span class="s3">= </span><span class="s1">allow_empty_suite</span>
        <span class="s0"># TODO: Remove in RF 8.0.</span>
        <span class="s2">if </span><span class="s1">included_suites </span><span class="s3">!= </span><span class="s5">&quot;DEPRECATED&quot;</span><span class="s3">:</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                <span class="s5">&quot;'TestSuiteBuilder' argument 'included_suites' is deprecated and &quot;</span>
                <span class="s5">&quot;has no effect. Use the new 'included_files' argument or filter &quot;</span>
                <span class="s5">&quot;the created suite instead.&quot;</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_standard_parsers</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">lang</span><span class="s3">: </span><span class="s1">LanguagesLike</span><span class="s3">,</span>
        <span class="s1">process_curdir</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">&quot;dict[str, Parser]&quot;</span><span class="s3">:</span>
        <span class="s1">robot_parser </span><span class="s3">= </span><span class="s1">RobotParser</span><span class="s3">(</span><span class="s1">lang</span><span class="s3">, </span><span class="s1">process_curdir</span><span class="s3">)</span>
        <span class="s1">rest_parser </span><span class="s3">= </span><span class="s1">RestParser</span><span class="s3">(</span><span class="s1">lang</span><span class="s3">, </span><span class="s1">process_curdir</span><span class="s3">)</span>
        <span class="s1">json_parser </span><span class="s3">= </span><span class="s1">JsonParser</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s3">{</span>
            <span class="s5">&quot;robot&quot;</span><span class="s3">: </span><span class="s1">robot_parser</span><span class="s3">,</span>
            <span class="s5">&quot;rst&quot;</span><span class="s3">: </span><span class="s1">rest_parser</span><span class="s3">,</span>
            <span class="s5">&quot;rest&quot;</span><span class="s3">: </span><span class="s1">rest_parser</span><span class="s3">,</span>
            <span class="s5">&quot;robot.rst&quot;</span><span class="s3">: </span><span class="s1">rest_parser</span><span class="s3">,</span>
            <span class="s5">&quot;rbt&quot;</span><span class="s3">: </span><span class="s1">json_parser</span><span class="s3">,</span>
            <span class="s5">&quot;json&quot;</span><span class="s3">: </span><span class="s1">json_parser</span><span class="s3">,</span>
        <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">_get_custom_parsers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">parsers</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s5">&quot;dict[str, CustomParser]&quot;</span><span class="s3">:</span>
        <span class="s1">custom_parsers </span><span class="s3">= {}</span>
        <span class="s1">importer </span><span class="s3">= </span><span class="s1">Importer</span><span class="s3">(</span><span class="s5">&quot;parser&quot;</span><span class="s3">, </span><span class="s1">LOGGER</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">parser </span><span class="s2">in </span><span class="s1">parsers</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">, (</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Path</span><span class="s3">)):</span>
                <span class="s1">name</span><span class="s3">, </span><span class="s1">args </span><span class="s3">= </span><span class="s1">split_args_from_name_or_path</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">)</span>
                <span class="s1">parser </span><span class="s3">= </span><span class="s1">importer</span><span class="s3">.</span><span class="s1">import_class_or_module</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">type_name</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">custom_parser </span><span class="s3">= </span><span class="s1">CustomParser</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">TypeError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s5">f&quot;Importing parser '</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s5">' failed: </span><span class="s2">{</span><span class="s1">err</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">ext </span><span class="s2">in </span><span class="s1">custom_parser</span><span class="s3">.</span><span class="s1">extensions</span><span class="s3">:</span>
                <span class="s1">custom_parsers</span><span class="s3">[</span><span class="s1">ext</span><span class="s3">] = </span><span class="s1">custom_parser</span>
        <span class="s2">return </span><span class="s1">custom_parsers</span>

    <span class="s2">def </span><span class="s1">build</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">paths</span><span class="s3">: </span><span class="s5">&quot;Path|str&quot;</span><span class="s3">) </span><span class="s1">-&gt; TestSuite</span><span class="s3">:</span>
        <span class="s4">&quot;&quot;&quot; 
        :param paths: Paths to test data files or directories. 
        :return: :class:`~robot.running.model.TestSuite` instance. 
        &quot;&quot;&quot;</span>
        <span class="s1">paths </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_normalize_paths</span><span class="s3">(</span><span class="s1">paths</span><span class="s3">)</span>
        <span class="s1">extensions </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">included_extensions </span><span class="s3">+ </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">custom_parsers</span><span class="s3">)</span>
        <span class="s1">structure </span><span class="s3">= </span><span class="s1">SuiteStructureBuilder</span><span class="s3">(</span><span class="s1">extensions</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">included_files</span><span class="s3">).</span><span class="s1">build</span><span class="s3">(*</span><span class="s1">paths</span><span class="s3">)</span>
        <span class="s1">suite </span><span class="s3">= </span><span class="s1">SuiteStructureParser</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_get_parsers</span><span class="s3">(</span><span class="s1">paths</span><span class="s3">),</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">defaults</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">rpa</span><span class="s3">,</span>
        <span class="s3">).</span><span class="s1">parse</span><span class="s3">(</span><span class="s1">structure</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">allow_empty_suite</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_validate_not_empty</span><span class="s3">(</span><span class="s1">suite</span><span class="s3">, </span><span class="s1">multi_source</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">paths</span><span class="s3">) &gt; </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">suite</span><span class="s3">.</span><span class="s1">remove_empty_suites</span><span class="s3">(</span><span class="s1">preserve_direct_children</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">paths</span><span class="s3">) &gt; </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">suite</span>

    <span class="s2">def </span><span class="s1">_normalize_paths</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">paths</span><span class="s3">: </span><span class="s5">&quot;Sequence[Path|str]&quot;</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">&quot;tuple[Path, ...]&quot;</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">paths</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s5">&quot;One or more source paths required.&quot;</span><span class="s3">)</span>
        <span class="s0"># Cannot use `Path.resolve()` here because it resolves all symlinks which</span>
        <span class="s0"># isn't desired. `Path` doesn't have any methods for normalizing paths</span>
        <span class="s0"># so need to use `os.path.normpath()`. Also that _may_ resolve symlinks,</span>
        <span class="s0"># but we need to do it for backwards compatibility.</span>
        <span class="s1">paths </span><span class="s3">= [</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">p</span><span class="s3">)).</span><span class="s1">absolute</span><span class="s3">() </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">paths</span><span class="s3">]</span>
        <span class="s1">non_existing </span><span class="s3">= [</span><span class="s1">p </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">paths </span><span class="s2">if not </span><span class="s1">p</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">()]</span>
        <span class="s2">if </span><span class="s1">non_existing</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span>
                <span class="s5">f&quot;Parsing </span><span class="s2">{</span><span class="s1">seq2str</span><span class="s3">(</span><span class="s1">non_existing</span><span class="s3">)</span><span class="s2">} </span><span class="s5">failed: &quot;</span>
                <span class="s5">f&quot;File or directory to execute does not exist.&quot;</span>
            <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">paths</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_parsers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">paths</span><span class="s3">: </span><span class="s5">&quot;Sequence[Path]&quot;</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">&quot;dict[str|None, Parser]&quot;</span><span class="s3">:</span>
        <span class="s1">parsers </span><span class="s3">= {</span><span class="s2">None</span><span class="s3">: </span><span class="s1">NoInitFileDirectoryParser</span><span class="s3">(), **</span><span class="s1">self</span><span class="s3">.</span><span class="s1">custom_parsers</span><span class="s3">}</span>
        <span class="s1">robot_parser </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">standard_parsers</span><span class="s3">[</span><span class="s5">&quot;robot&quot;</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">ext </span><span class="s2">in </span><span class="s3">(</span>
            <span class="s3">*</span><span class="s1">self</span><span class="s3">.</span><span class="s1">included_extensions</span><span class="s3">,</span>
            <span class="s3">*[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_ext</span><span class="s3">(</span><span class="s1">pattern</span><span class="s3">) </span><span class="s2">for </span><span class="s1">pattern </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">included_files</span><span class="s3">],</span>
            <span class="s3">*[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_ext</span><span class="s3">(</span><span class="s1">pth</span><span class="s3">) </span><span class="s2">for </span><span class="s1">pth </span><span class="s2">in </span><span class="s1">paths </span><span class="s2">if </span><span class="s1">pth</span><span class="s3">.</span><span class="s1">is_file</span><span class="s3">()],</span>
        <span class="s3">):</span>
            <span class="s1">ext </span><span class="s3">= </span><span class="s1">ext</span><span class="s3">.</span><span class="s1">lstrip</span><span class="s3">(</span><span class="s5">&quot;.&quot;</span><span class="s3">).</span><span class="s1">lower</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">ext </span><span class="s2">not in </span><span class="s1">parsers </span><span class="s2">and </span><span class="s1">ext</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">&quot;.&quot;</span><span class="s3">, </span><span class="s5">&quot;&quot;</span><span class="s3">).</span><span class="s1">isalnum</span><span class="s3">():</span>
                <span class="s1">parsers</span><span class="s3">[</span><span class="s1">ext</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">standard_parsers</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">, </span><span class="s1">robot_parser</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">parsers</span>

    <span class="s2">def </span><span class="s1">_get_ext</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">: </span><span class="s5">&quot;str|Path&quot;</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">Path</span><span class="s3">):</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s5">&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">path</span><span class="s3">.</span><span class="s1">suffixes</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_validate_not_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">suite</span><span class="s3">: </span><span class="s1">TestSuite</span><span class="s3">, </span><span class="s1">multi_source</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">multi_source</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">child </span><span class="s2">in </span><span class="s1">suite</span><span class="s3">.</span><span class="s1">suites</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_validate_not_empty</span><span class="s3">(</span><span class="s1">child</span><span class="s3">)</span>
        <span class="s2">elif not </span><span class="s1">suite</span><span class="s3">.</span><span class="s1">has_tests</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s5">f&quot;Suite '</span><span class="s2">{</span><span class="s1">suite</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s5">' contains no tests or tasks.&quot;</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">SuiteStructureParser</span><span class="s3">(</span><span class="s1">SuiteStructureVisitor</span><span class="s3">):</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">parsers</span><span class="s3">: </span><span class="s5">&quot;dict[str|None, Parser]&quot;</span><span class="s3">,</span>
        <span class="s1">defaults</span><span class="s3">: </span><span class="s5">&quot;TestDefaults|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">rpa</span><span class="s3">: </span><span class="s5">&quot;bool|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">parsers </span><span class="s3">= </span><span class="s1">parsers</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rpa </span><span class="s3">= </span><span class="s1">rpa</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">defaults </span><span class="s3">= </span><span class="s1">defaults</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">suite</span><span class="s3">: </span><span class="s5">&quot;TestSuite|None&quot; </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">: </span><span class="s5">&quot;list[tuple[TestSuite, TestDefaults]]&quot; </span><span class="s3">= []</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">parent_defaults</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">&quot;TestDefaults|None&quot;</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][-</span><span class="s6">1</span><span class="s3">] </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack </span><span class="s2">else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">defaults</span>

    <span class="s2">def </span><span class="s1">parse</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">structure</span><span class="s3">: </span><span class="s1">SuiteStructure</span><span class="s3">) </span><span class="s1">-&gt; TestSuite</span><span class="s3">:</span>
        <span class="s1">structure</span><span class="s3">.</span><span class="s1">visit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">TestSuite</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">suite</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">visit_file</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">structure</span><span class="s3">: </span><span class="s1">SuiteFile</span><span class="s3">):</span>
        <span class="s1">LOGGER</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">f&quot;Parsing file '</span><span class="s2">{</span><span class="s1">structure</span><span class="s3">.</span><span class="s1">source</span><span class="s2">}</span><span class="s5">'.&quot;</span><span class="s3">)</span>
        <span class="s1">suite </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_build_suite_file</span><span class="s3">(</span><span class="s1">structure</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rpa </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">suite</span><span class="s3">.</span><span class="s1">rpa </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rpa</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">suite </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">suite </span><span class="s3">= </span><span class="s1">suite</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">].</span><span class="s1">suites</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">suite</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">start_directory</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">structure</span><span class="s3">: </span><span class="s1">SuiteDirectory</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">structure</span><span class="s3">.</span><span class="s1">source</span><span class="s3">:</span>
            <span class="s1">LOGGER</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">f&quot;Parsing directory '</span><span class="s2">{</span><span class="s1">structure</span><span class="s3">.</span><span class="s1">source</span><span class="s2">}</span><span class="s5">'.&quot;</span><span class="s3">)</span>
        <span class="s1">suite</span><span class="s3">, </span><span class="s1">defaults </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_build_suite_directory</span><span class="s3">(</span><span class="s1">structure</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">suite </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">suite </span><span class="s3">= </span><span class="s1">suite</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">].</span><span class="s1">suites</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">suite</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">suite</span><span class="s3">, </span><span class="s1">defaults</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">end_directory</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">structure</span><span class="s3">: </span><span class="s1">SuiteDirectory</span><span class="s3">):</span>
        <span class="s1">suite</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rpa </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">suite</span><span class="s3">.</span><span class="s1">rpa </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rpa</span>
        <span class="s2">elif </span><span class="s1">suite</span><span class="s3">.</span><span class="s1">rpa </span><span class="s2">is None and </span><span class="s1">suite</span><span class="s3">.</span><span class="s1">suites</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">all</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">rpa </span><span class="s2">is False for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">suite</span><span class="s3">.</span><span class="s1">suites</span><span class="s3">):</span>
                <span class="s1">suite</span><span class="s3">.</span><span class="s1">rpa </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">elif </span><span class="s1">all</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">rpa </span><span class="s2">is True for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">suite</span><span class="s3">.</span><span class="s1">suites</span><span class="s3">):</span>
                <span class="s1">suite</span><span class="s3">.</span><span class="s1">rpa </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">def </span><span class="s1">_build_suite_file</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">structure</span><span class="s3">: </span><span class="s1">SuiteFile</span><span class="s3">):</span>
        <span class="s1">source </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">Path</span><span class="s3">, </span><span class="s1">structure</span><span class="s3">.</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s1">defaults </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parent_defaults </span><span class="s2">or </span><span class="s1">TestDefaults</span><span class="s3">()</span>
        <span class="s1">parser </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parsers</span><span class="s3">[</span><span class="s1">structure</span><span class="s3">.</span><span class="s1">extension</span><span class="s3">]</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">suite </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">parse_suite_file</span><span class="s3">(</span><span class="s1">source</span><span class="s3">, </span><span class="s1">defaults</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">suite</span><span class="s3">.</span><span class="s1">tests</span><span class="s3">:</span>
                <span class="s1">LOGGER</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">f&quot;Data source '</span><span class="s2">{</span><span class="s1">source</span><span class="s2">}</span><span class="s5">' has no tests or tasks.&quot;</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">DataError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s5">f&quot;Parsing '</span><span class="s2">{</span><span class="s1">source</span><span class="s2">}</span><span class="s5">' failed: </span><span class="s2">{</span><span class="s1">err</span><span class="s3">.</span><span class="s1">message</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">) </span><span class="s2">from </span><span class="s1">err</span>
        <span class="s2">return </span><span class="s1">suite</span>

    <span class="s2">def </span><span class="s1">_build_suite_directory</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">structure</span><span class="s3">: </span><span class="s1">SuiteDirectory</span><span class="s3">):</span>
        <span class="s1">source </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">Path</span><span class="s3">, </span><span class="s1">structure</span><span class="s3">.</span><span class="s1">init_file </span><span class="s2">or </span><span class="s1">structure</span><span class="s3">.</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s1">defaults </span><span class="s3">= </span><span class="s1">TestDefaults</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">parent_defaults</span><span class="s3">)</span>
        <span class="s1">parser </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parsers</span><span class="s3">[</span><span class="s1">structure</span><span class="s3">.</span><span class="s1">extension</span><span class="s3">]</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">suite </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">parse_init_file</span><span class="s3">(</span><span class="s1">source</span><span class="s3">, </span><span class="s1">defaults</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">structure</span><span class="s3">.</span><span class="s1">is_multi_source</span><span class="s3">:</span>
                <span class="s1">suite</span><span class="s3">.</span><span class="s1">config</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s5">&quot;&quot;</span><span class="s3">, </span><span class="s1">source</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">DataError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s5">f&quot;Parsing '</span><span class="s2">{</span><span class="s1">source</span><span class="s2">}</span><span class="s5">' failed: </span><span class="s2">{</span><span class="s1">err</span><span class="s3">.</span><span class="s1">message</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">suite</span><span class="s3">, </span><span class="s1">defaults</span>


<span class="s2">class </span><span class="s1">ResourceFileBuilder</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">lang</span><span class="s3">: </span><span class="s1">LanguagesLike </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">process_curdir</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">lang </span><span class="s3">= </span><span class="s1">lang</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">process_curdir </span><span class="s3">= </span><span class="s1">process_curdir</span>

    <span class="s2">def </span><span class="s1">build</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">source</span><span class="s3">: </span><span class="s1">Path</span><span class="s3">) </span><span class="s1">-&gt; ResourceFile</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">source</span><span class="s3">, </span><span class="s1">Path</span><span class="s3">):</span>
            <span class="s1">source </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s1">LOGGER</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">f&quot;Parsing resource file '</span><span class="s2">{</span><span class="s1">source</span><span class="s2">}</span><span class="s5">'.&quot;</span><span class="s3">)</span>
        <span class="s1">resource </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parse</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">resource</span><span class="s3">.</span><span class="s1">imports </span><span class="s2">or </span><span class="s1">resource</span><span class="s3">.</span><span class="s1">variables </span><span class="s2">or </span><span class="s1">resource</span><span class="s3">.</span><span class="s1">keywords</span><span class="s3">:</span>
            <span class="s1">kws </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">resource</span><span class="s3">.</span><span class="s1">keywords</span><span class="s3">)</span>
            <span class="s1">LOGGER</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">f&quot;Imported resource file '</span><span class="s2">{</span><span class="s1">source</span><span class="s2">}</span><span class="s5">' (</span><span class="s2">{</span><span class="s1">kws</span><span class="s2">} </span><span class="s5">keywords).&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">LOGGER</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s5">f&quot;Imported resource file '</span><span class="s2">{</span><span class="s1">source</span><span class="s2">}</span><span class="s5">' is empty.&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">resource</span>

    <span class="s2">def </span><span class="s1">_parse</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">source</span><span class="s3">: </span><span class="s1">Path</span><span class="s3">) </span><span class="s1">-&gt; ResourceFile</span><span class="s3">:</span>
        <span class="s1">suffix </span><span class="s3">= </span><span class="s1">source</span><span class="s3">.</span><span class="s1">suffix</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">suffix </span><span class="s2">in </span><span class="s3">(</span><span class="s5">&quot;.rst&quot;</span><span class="s3">, </span><span class="s5">&quot;.rest&quot;</span><span class="s3">):</span>
            <span class="s1">parser </span><span class="s3">= </span><span class="s1">RestParser</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">lang</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">process_curdir</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">suffix </span><span class="s2">in </span><span class="s3">(</span><span class="s5">&quot;.json&quot;</span><span class="s3">, </span><span class="s5">&quot;.rsrc&quot;</span><span class="s3">):</span>
            <span class="s1">parser </span><span class="s3">= </span><span class="s1">JsonParser</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">parser </span><span class="s3">= </span><span class="s1">RobotParser</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">lang</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">process_curdir</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">parse_resource_file</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
</pre>
</body>
</html>