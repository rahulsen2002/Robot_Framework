<html>
<head>
<title>_windows_cffi.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_windows_cffi.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">enum</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">TYPE_CHECKING</span><span class="s2">, </span><span class="s1">NewType</span><span class="s2">, </span><span class="s1">NoReturn</span><span class="s2">, </span><span class="s1">Protocol</span><span class="s2">, </span><span class="s1">cast</span>

<span class="s0">if </span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">typing_extensions </span><span class="s0">import </span><span class="s1">TypeAlias</span>

<span class="s0">import </span><span class="s1">cffi</span>

<span class="s3">################################################################</span>
<span class="s3"># Functions and types</span>
<span class="s3">################################################################</span>

<span class="s1">LIB </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
// https://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx 
typedef int BOOL; 
typedef unsigned char BYTE; 
typedef BYTE BOOLEAN; 
typedef void* PVOID; 
typedef PVOID HANDLE; 
typedef unsigned long DWORD; 
typedef unsigned long ULONG; 
typedef unsigned int NTSTATUS; 
typedef unsigned long u_long; 
typedef ULONG *PULONG; 
typedef const void *LPCVOID; 
typedef void *LPVOID; 
typedef const wchar_t *LPCWSTR; 
 
typedef uintptr_t ULONG_PTR; 
typedef uintptr_t UINT_PTR; 
 
typedef UINT_PTR SOCKET; 
 
typedef struct _OVERLAPPED { 
    ULONG_PTR Internal; 
    ULONG_PTR InternalHigh; 
    union { 
        struct { 
            DWORD Offset; 
            DWORD OffsetHigh; 
        } DUMMYSTRUCTNAME; 
        PVOID Pointer; 
    } DUMMYUNIONNAME; 
 
    HANDLE  hEvent; 
} OVERLAPPED, *LPOVERLAPPED; 
 
typedef OVERLAPPED WSAOVERLAPPED; 
typedef LPOVERLAPPED LPWSAOVERLAPPED; 
typedef PVOID LPSECURITY_ATTRIBUTES; 
typedef PVOID LPCSTR; 
 
typedef struct _OVERLAPPED_ENTRY { 
    ULONG_PTR lpCompletionKey; 
    LPOVERLAPPED lpOverlapped; 
    ULONG_PTR Internal; 
    DWORD dwNumberOfBytesTransferred; 
} OVERLAPPED_ENTRY, *LPOVERLAPPED_ENTRY; 
 
// kernel32.dll 
HANDLE WINAPI CreateIoCompletionPort( 
  _In_     HANDLE    FileHandle, 
  _In_opt_ HANDLE    ExistingCompletionPort, 
  _In_     ULONG_PTR CompletionKey, 
  _In_     DWORD     NumberOfConcurrentThreads 
); 
 
BOOL SetFileCompletionNotificationModes( 
  HANDLE FileHandle, 
  UCHAR  Flags 
); 
 
HANDLE CreateFileW( 
  LPCWSTR               lpFileName, 
  DWORD                 dwDesiredAccess, 
  DWORD                 dwShareMode, 
  LPSECURITY_ATTRIBUTES lpSecurityAttributes, 
  DWORD                 dwCreationDisposition, 
  DWORD                 dwFlagsAndAttributes, 
  HANDLE                hTemplateFile 
); 
 
BOOL WINAPI CloseHandle( 
  _In_ HANDLE hObject 
); 
 
BOOL WINAPI PostQueuedCompletionStatus( 
  _In_     HANDLE       CompletionPort, 
  _In_     DWORD        dwNumberOfBytesTransferred, 
  _In_     ULONG_PTR    dwCompletionKey, 
  _In_opt_ LPOVERLAPPED lpOverlapped 
); 
 
BOOL WINAPI GetQueuedCompletionStatusEx( 
  _In_  HANDLE             CompletionPort, 
  _Out_ LPOVERLAPPED_ENTRY lpCompletionPortEntries, 
  _In_  ULONG              ulCount, 
  _Out_ PULONG             ulNumEntriesRemoved, 
  _In_  DWORD              dwMilliseconds, 
  _In_  BOOL               fAlertable 
); 
 
BOOL WINAPI CancelIoEx( 
  _In_     HANDLE       hFile, 
  _In_opt_ LPOVERLAPPED lpOverlapped 
); 
 
BOOL WriteFile( 
  HANDLE       hFile, 
  LPCVOID      lpBuffer, 
  DWORD        nNumberOfBytesToWrite, 
  LPDWORD      lpNumberOfBytesWritten, 
  LPOVERLAPPED lpOverlapped 
); 
 
BOOL ReadFile( 
  HANDLE       hFile, 
  LPVOID       lpBuffer, 
  DWORD        nNumberOfBytesToRead, 
  LPDWORD      lpNumberOfBytesRead, 
  LPOVERLAPPED lpOverlapped 
); 
 
BOOL WINAPI SetConsoleCtrlHandler( 
  _In_opt_ void*            HandlerRoutine, 
  _In_     BOOL             Add 
); 
 
HANDLE CreateEventA( 
  LPSECURITY_ATTRIBUTES lpEventAttributes, 
  BOOL                  bManualReset, 
  BOOL                  bInitialState, 
  LPCSTR                lpName 
); 
 
BOOL SetEvent( 
  HANDLE hEvent 
); 
 
BOOL ResetEvent( 
  HANDLE hEvent 
); 
 
DWORD WaitForSingleObject( 
  HANDLE hHandle, 
  DWORD  dwMilliseconds 
); 
 
DWORD WaitForMultipleObjects( 
  DWORD        nCount, 
  HANDLE       *lpHandles, 
  BOOL         bWaitAll, 
  DWORD        dwMilliseconds 
); 
 
ULONG RtlNtStatusToDosError( 
  NTSTATUS Status 
); 
 
int WSAIoctl( 
  SOCKET                             s, 
  DWORD                              dwIoControlCode, 
  LPVOID                             lpvInBuffer, 
  DWORD                              cbInBuffer, 
  LPVOID                             lpvOutBuffer, 
  DWORD                              cbOutBuffer, 
  LPDWORD                            lpcbBytesReturned, 
  LPWSAOVERLAPPED                    lpOverlapped, 
  // actually LPWSAOVERLAPPED_COMPLETION_ROUTINE 
  void* lpCompletionRoutine 
); 
 
int WSAGetLastError(); 
 
BOOL DeviceIoControl( 
  HANDLE       hDevice, 
  DWORD        dwIoControlCode, 
  LPVOID       lpInBuffer, 
  DWORD        nInBufferSize, 
  LPVOID       lpOutBuffer, 
  DWORD        nOutBufferSize, 
  LPDWORD      lpBytesReturned, 
  LPOVERLAPPED lpOverlapped 
); 
 
// From https://github.com/piscisaureus/wepoll/blob/master/src/afd.h 
typedef struct _AFD_POLL_HANDLE_INFO { 
  HANDLE Handle; 
  ULONG Events; 
  NTSTATUS Status; 
} AFD_POLL_HANDLE_INFO, *PAFD_POLL_HANDLE_INFO; 
 
// This is really defined as a messy union to allow stuff like 
// i.DUMMYSTRUCTNAME.LowPart, but we don't need those complications. 
// Under all that it's just an int64. 
typedef int64_t LARGE_INTEGER; 
 
typedef struct _AFD_POLL_INFO { 
  LARGE_INTEGER Timeout; 
  ULONG NumberOfHandles; 
  ULONG Exclusive; 
  AFD_POLL_HANDLE_INFO Handles[1]; 
} AFD_POLL_INFO, *PAFD_POLL_INFO; 
 
&quot;&quot;&quot;</span>

<span class="s3"># cribbed from pywincffi</span>
<span class="s3"># programmatically strips out those annotations MSDN likes, like _In_</span>
<span class="s1">REGEX_SAL_ANNOTATION </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
    <span class="s4">r&quot;\b(_In_|_Inout_|_Out_|_Outptr_|_Reserved_)(opt_)?\b&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s1">LIB </span><span class="s2">= </span><span class="s1">REGEX_SAL_ANNOTATION</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">(</span><span class="s4">&quot; &quot;</span><span class="s2">, </span><span class="s1">LIB</span><span class="s2">)</span>

<span class="s3"># Other fixups:</span>
<span class="s3"># - get rid of FAR, cffi doesn't like it</span>
<span class="s1">LIB </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">(</span><span class="s4">r&quot;\bFAR\b&quot;</span><span class="s2">, </span><span class="s4">&quot; &quot;</span><span class="s2">, </span><span class="s1">LIB</span><span class="s2">)</span>
<span class="s3"># - PASCAL is apparently an alias for __stdcall (on modern compilers - modern</span>
<span class="s3">#   being _MSC_VER &gt;= 800)</span>
<span class="s1">LIB </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">(</span><span class="s4">r&quot;\bPASCAL\b&quot;</span><span class="s2">, </span><span class="s4">&quot;__stdcall&quot;</span><span class="s2">, </span><span class="s1">LIB</span><span class="s2">)</span>

<span class="s1">ffi </span><span class="s2">= </span><span class="s1">cffi</span><span class="s2">.</span><span class="s1">api</span><span class="s2">.</span><span class="s1">FFI</span><span class="s2">()</span>
<span class="s1">ffi</span><span class="s2">.</span><span class="s1">cdef</span><span class="s2">(</span><span class="s1">LIB</span><span class="s2">)</span>

<span class="s1">CData</span><span class="s2">: </span><span class="s1">TypeAlias </span><span class="s2">= </span><span class="s1">cffi</span><span class="s2">.</span><span class="s1">api</span><span class="s2">.</span><span class="s1">FFI</span><span class="s2">.</span><span class="s1">CData</span>
<span class="s1">CType</span><span class="s2">: </span><span class="s1">TypeAlias </span><span class="s2">= </span><span class="s1">cffi</span><span class="s2">.</span><span class="s1">api</span><span class="s2">.</span><span class="s1">FFI</span><span class="s2">.</span><span class="s1">CType</span>
<span class="s1">AlwaysNull</span><span class="s2">: </span><span class="s1">TypeAlias </span><span class="s2">= </span><span class="s1">CType  </span><span class="s3"># We currently always pass ffi.NULL here.</span>
<span class="s1">Handle </span><span class="s2">= </span><span class="s1">NewType</span><span class="s2">(</span><span class="s4">&quot;Handle&quot;</span><span class="s2">, </span><span class="s1">CData</span><span class="s2">)</span>
<span class="s1">HandleArray </span><span class="s2">= </span><span class="s1">NewType</span><span class="s2">(</span><span class="s4">&quot;HandleArray&quot;</span><span class="s2">, </span><span class="s1">CData</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_Kernel32</span><span class="s2">(</span><span class="s1">Protocol</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Statically typed version of the kernel32.dll functions we use.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">CreateIoCompletionPort</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">FileHandle</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">,</span>
        <span class="s1">ExistingCompletionPort</span><span class="s2">: </span><span class="s1">CData </span><span class="s2">| </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s1">CompletionKey</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">NumberOfConcurrentThreads</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; Handle</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">CreateEventA</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">lpEventAttributes</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s1">bManualReset</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">,</span>
        <span class="s1">bInitialState</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">,</span>
        <span class="s1">lpName</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; Handle</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">SetFileCompletionNotificationModes</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">handle</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">,</span>
        <span class="s1">flags</span><span class="s2">: </span><span class="s1">CompletionModes</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">PostQueuedCompletionStatus</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">CompletionPort</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">,</span>
        <span class="s1">dwNumberOfBytesTransferred</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">dwCompletionKey</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">lpOverlapped</span><span class="s2">: </span><span class="s1">CData </span><span class="s2">| </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">CancelIoEx</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">hFile</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">,</span>
        <span class="s1">lpOverlapped</span><span class="s2">: </span><span class="s1">CData </span><span class="s2">| </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">WriteFile</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">hFile</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">,</span>
        <span class="s3"># not sure about this type</span>
        <span class="s1">lpBuffer</span><span class="s2">: </span><span class="s1">CData</span><span class="s2">,</span>
        <span class="s1">nNumberOfBytesToWrite</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">lpNumberOfBytesWritten</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s1">lpOverlapped</span><span class="s2">: </span><span class="s1">_Overlapped</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">ReadFile</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">hFile</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">,</span>
        <span class="s3"># not sure about this type</span>
        <span class="s1">lpBuffer</span><span class="s2">: </span><span class="s1">CData</span><span class="s2">,</span>
        <span class="s1">nNumberOfBytesToRead</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">lpNumberOfBytesRead</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s1">lpOverlapped</span><span class="s2">: </span><span class="s1">_Overlapped</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">GetQueuedCompletionStatusEx</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">CompletionPort</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">,</span>
        <span class="s1">lpCompletionPortEntries</span><span class="s2">: </span><span class="s1">CData</span><span class="s2">,</span>
        <span class="s1">ulCount</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">ulNumEntriesRemoved</span><span class="s2">: </span><span class="s1">CData</span><span class="s2">,</span>
        <span class="s1">dwMilliseconds</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">fAlertable</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">| </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; CData</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">CreateFileW</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">lpFileName</span><span class="s2">: </span><span class="s1">CData</span><span class="s2">,</span>
        <span class="s1">dwDesiredAccess</span><span class="s2">: </span><span class="s1">FileFlags</span><span class="s2">,</span>
        <span class="s1">dwShareMode</span><span class="s2">: </span><span class="s1">FileFlags</span><span class="s2">,</span>
        <span class="s1">lpSecurityAttributes</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s1">dwCreationDisposition</span><span class="s2">: </span><span class="s1">FileFlags</span><span class="s2">,</span>
        <span class="s1">dwFlagsAndAttributes</span><span class="s2">: </span><span class="s1">FileFlags</span><span class="s2">,</span>
        <span class="s1">hTemplateFile</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; Handle</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">WaitForSingleObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hHandle</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">, </span><span class="s1">dwMilliseconds</span><span class="s2">: </span><span class="s1">int</span><span class="s2">, /) </span><span class="s1">-&gt; CData</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">WaitForMultipleObjects</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">nCount</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">lpHandles</span><span class="s2">: </span><span class="s1">HandleArray</span><span class="s2">,</span>
        <span class="s1">bWaitAll</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">,</span>
        <span class="s1">dwMilliseconds</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; ErrorCodes</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">SetEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">handle</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">, /) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">CloseHandle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">handle</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">, /) </span><span class="s1">-&gt; bool</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">DeviceIoControl</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">hDevice</span><span class="s2">: </span><span class="s1">Handle</span><span class="s2">,</span>
        <span class="s1">dwIoControlCode</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s3"># this is wrong (it's not always null)</span>
        <span class="s1">lpInBuffer</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s1">nInBufferSize</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s3"># this is also wrong</span>
        <span class="s1">lpOutBuffer</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s1">nOutBufferSize</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">lpBytesReturned</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s1">lpOverlapped</span><span class="s2">: </span><span class="s1">CData</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">: ...</span>


<span class="s0">class </span><span class="s1">_Nt</span><span class="s2">(</span><span class="s1">Protocol</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Statically typed version of the dtdll.dll functions we use.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">RtlNtStatusToDosError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">status</span><span class="s2">: </span><span class="s1">int</span><span class="s2">, /) </span><span class="s1">-&gt; ErrorCodes</span><span class="s2">: ...</span>


<span class="s0">class </span><span class="s1">_Ws2</span><span class="s2">(</span><span class="s1">Protocol</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Statically typed version of the ws2_32.dll functions we use.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">WSAGetLastError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">: ...</span>

    <span class="s0">def </span><span class="s1">WSAIoctl</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">socket</span><span class="s2">: </span><span class="s1">CData</span><span class="s2">,</span>
        <span class="s1">dwIoControlCode</span><span class="s2">: </span><span class="s1">WSAIoctls</span><span class="s2">,</span>
        <span class="s1">lpvInBuffer</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s1">cbInBuffer</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">lpvOutBuffer</span><span class="s2">: </span><span class="s1">CData</span><span class="s2">,</span>
        <span class="s1">cbOutBuffer</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
        <span class="s1">lpcbBytesReturned</span><span class="s2">: </span><span class="s1">CData</span><span class="s2">,  </span><span class="s3"># int*</span>
        <span class="s1">lpOverlapped</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s3"># actually LPWSAOVERLAPPED_COMPLETION_ROUTINE</span>
        <span class="s1">lpCompletionRoutine</span><span class="s2">: </span><span class="s1">AlwaysNull</span><span class="s2">,</span>
        <span class="s2">/,</span>
    <span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">: ...</span>


<span class="s0">class </span><span class="s1">_DummyStruct</span><span class="s2">(</span><span class="s1">Protocol</span><span class="s2">):</span>
    <span class="s1">Offset</span><span class="s2">: </span><span class="s1">int</span>
    <span class="s1">OffsetHigh</span><span class="s2">: </span><span class="s1">int</span>


<span class="s0">class </span><span class="s1">_DummyUnion</span><span class="s2">(</span><span class="s1">Protocol</span><span class="s2">):</span>
    <span class="s1">DUMMYSTRUCTNAME</span><span class="s2">: </span><span class="s1">_DummyStruct</span>
    <span class="s1">Pointer</span><span class="s2">: </span><span class="s1">object</span>


<span class="s0">class </span><span class="s1">_Overlapped</span><span class="s2">(</span><span class="s1">Protocol</span><span class="s2">):</span>
    <span class="s1">Internal</span><span class="s2">: </span><span class="s1">int</span>
    <span class="s1">InternalHigh</span><span class="s2">: </span><span class="s1">int</span>
    <span class="s1">DUMMYUNIONNAME</span><span class="s2">: </span><span class="s1">_DummyUnion</span>
    <span class="s1">hEvent</span><span class="s2">: </span><span class="s1">Handle</span>


<span class="s1">kernel32 </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;_Kernel32&quot;</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">dlopen</span><span class="s2">(</span><span class="s4">&quot;kernel32.dll&quot;</span><span class="s2">))</span>
<span class="s1">ntdll </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;_Nt&quot;</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">dlopen</span><span class="s2">(</span><span class="s4">&quot;ntdll.dll&quot;</span><span class="s2">))</span>
<span class="s1">ws2_32 </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;_Ws2&quot;</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">dlopen</span><span class="s2">(</span><span class="s4">&quot;ws2_32.dll&quot;</span><span class="s2">))</span>

<span class="s3">################################################################</span>
<span class="s3"># Magic numbers</span>
<span class="s3">################################################################</span>

<span class="s3"># Here's a great resource for looking these up:</span>
<span class="s3">#   https://www.magnumdb.com</span>
<span class="s3"># (Tip: check the box to see &quot;Hex value&quot;)</span>

<span class="s1">INVALID_HANDLE_VALUE </span><span class="s2">= </span><span class="s1">Handle</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;HANDLE&quot;</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">ErrorCodes</span><span class="s2">(</span><span class="s1">enum</span><span class="s2">.</span><span class="s1">IntEnum</span><span class="s2">):</span>
    <span class="s1">STATUS_TIMEOUT </span><span class="s2">= </span><span class="s6">0x102</span>
    <span class="s1">WAIT_TIMEOUT </span><span class="s2">= </span><span class="s6">0x102</span>
    <span class="s1">WAIT_ABANDONED </span><span class="s2">= </span><span class="s6">0x80</span>
    <span class="s1">WAIT_OBJECT_0 </span><span class="s2">= </span><span class="s6">0x00  </span><span class="s3"># object is signaled</span>
    <span class="s1">WAIT_FAILED </span><span class="s2">= </span><span class="s6">0xFFFFFFFF</span>
    <span class="s1">ERROR_IO_PENDING </span><span class="s2">= </span><span class="s6">997</span>
    <span class="s1">ERROR_OPERATION_ABORTED </span><span class="s2">= </span><span class="s6">995</span>
    <span class="s1">ERROR_ABANDONED_WAIT_0 </span><span class="s2">= </span><span class="s6">735</span>
    <span class="s1">ERROR_INVALID_HANDLE </span><span class="s2">= </span><span class="s6">6</span>
    <span class="s1">ERROR_INVALID_PARAMETER </span><span class="s2">= </span><span class="s6">87</span>
    <span class="s1">ERROR_NOT_FOUND </span><span class="s2">= </span><span class="s6">1168</span>
    <span class="s1">ERROR_NOT_SOCKET </span><span class="s2">= </span><span class="s6">10038</span>


<span class="s0">class </span><span class="s1">FileFlags</span><span class="s2">(</span><span class="s1">enum</span><span class="s2">.</span><span class="s1">IntFlag</span><span class="s2">):</span>
    <span class="s1">GENERIC_READ </span><span class="s2">= </span><span class="s6">0x80000000</span>
    <span class="s1">SYNCHRONIZE </span><span class="s2">= </span><span class="s6">0x00100000</span>
    <span class="s1">FILE_FLAG_OVERLAPPED </span><span class="s2">= </span><span class="s6">0x40000000</span>
    <span class="s1">FILE_SHARE_READ </span><span class="s2">= </span><span class="s6">1</span>
    <span class="s1">FILE_SHARE_WRITE </span><span class="s2">= </span><span class="s6">2</span>
    <span class="s1">FILE_SHARE_DELETE </span><span class="s2">= </span><span class="s6">4</span>
    <span class="s1">CREATE_NEW </span><span class="s2">= </span><span class="s6">1</span>
    <span class="s1">CREATE_ALWAYS </span><span class="s2">= </span><span class="s6">2</span>
    <span class="s1">OPEN_EXISTING </span><span class="s2">= </span><span class="s6">3</span>
    <span class="s1">OPEN_ALWAYS </span><span class="s2">= </span><span class="s6">4</span>
    <span class="s1">TRUNCATE_EXISTING </span><span class="s2">= </span><span class="s6">5</span>


<span class="s0">class </span><span class="s1">AFDPollFlags</span><span class="s2">(</span><span class="s1">enum</span><span class="s2">.</span><span class="s1">IntFlag</span><span class="s2">):</span>
    <span class="s3"># These are drawn from a combination of:</span>
    <span class="s3">#   https://github.com/piscisaureus/wepoll/blob/master/src/afd.h</span>
    <span class="s3">#   https://github.com/reactos/reactos/blob/master/sdk/include/reactos/drivers/afd/shared.h</span>
    <span class="s1">AFD_POLL_RECEIVE </span><span class="s2">= </span><span class="s6">0x0001</span>
    <span class="s1">AFD_POLL_RECEIVE_EXPEDITED </span><span class="s2">= </span><span class="s6">0x0002  </span><span class="s3"># OOB/urgent data</span>
    <span class="s1">AFD_POLL_SEND </span><span class="s2">= </span><span class="s6">0x0004</span>
    <span class="s1">AFD_POLL_DISCONNECT </span><span class="s2">= </span><span class="s6">0x0008  </span><span class="s3"># received EOF (FIN)</span>
    <span class="s1">AFD_POLL_ABORT </span><span class="s2">= </span><span class="s6">0x0010  </span><span class="s3"># received RST</span>
    <span class="s1">AFD_POLL_LOCAL_CLOSE </span><span class="s2">= </span><span class="s6">0x0020  </span><span class="s3"># local socket object closed</span>
    <span class="s1">AFD_POLL_CONNECT </span><span class="s2">= </span><span class="s6">0x0040  </span><span class="s3"># socket is successfully connected</span>
    <span class="s1">AFD_POLL_ACCEPT </span><span class="s2">= </span><span class="s6">0x0080  </span><span class="s3"># you can call accept on this socket</span>
    <span class="s1">AFD_POLL_CONNECT_FAIL </span><span class="s2">= </span><span class="s6">0x0100  </span><span class="s3"># connect() terminated unsuccessfully</span>
    <span class="s3"># See WSAEventSelect docs for more details on these four:</span>
    <span class="s1">AFD_POLL_QOS </span><span class="s2">= </span><span class="s6">0x0200</span>
    <span class="s1">AFD_POLL_GROUP_QOS </span><span class="s2">= </span><span class="s6">0x0400</span>
    <span class="s1">AFD_POLL_ROUTING_INTERFACE_CHANGE </span><span class="s2">= </span><span class="s6">0x0800</span>
    <span class="s1">AFD_POLL_EVENT_ADDRESS_LIST_CHANGE </span><span class="s2">= </span><span class="s6">0x1000</span>


<span class="s0">class </span><span class="s1">WSAIoctls</span><span class="s2">(</span><span class="s1">enum</span><span class="s2">.</span><span class="s1">IntEnum</span><span class="s2">):</span>
    <span class="s1">SIO_BASE_HANDLE </span><span class="s2">= </span><span class="s6">0x48000022</span>
    <span class="s1">SIO_BSP_HANDLE_SELECT </span><span class="s2">= </span><span class="s6">0x4800001C</span>
    <span class="s1">SIO_BSP_HANDLE_POLL </span><span class="s2">= </span><span class="s6">0x4800001D</span>


<span class="s0">class </span><span class="s1">CompletionModes</span><span class="s2">(</span><span class="s1">enum</span><span class="s2">.</span><span class="s1">IntFlag</span><span class="s2">):</span>
    <span class="s1">FILE_SKIP_COMPLETION_PORT_ON_SUCCESS </span><span class="s2">= </span><span class="s6">0x1</span>
    <span class="s1">FILE_SKIP_SET_EVENT_ON_HANDLE </span><span class="s2">= </span><span class="s6">0x2</span>


<span class="s0">class </span><span class="s1">IoControlCodes</span><span class="s2">(</span><span class="s1">enum</span><span class="s2">.</span><span class="s1">IntEnum</span><span class="s2">):</span>
    <span class="s1">IOCTL_AFD_POLL </span><span class="s2">= </span><span class="s6">0x00012024</span>


<span class="s3">################################################################</span>
<span class="s3"># Generic helpers</span>
<span class="s3">################################################################</span>


<span class="s0">def </span><span class="s1">_handle</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s1">CData</span><span class="s2">) </span><span class="s1">-&gt; Handle</span><span class="s2">:</span>
    <span class="s3"># For now, represent handles as either cffi HANDLEs or as ints.  If you</span>
    <span class="s3"># try to pass in a file descriptor instead, it's not going to work</span>
    <span class="s3"># out. (For that msvcrt.get_osfhandle does the trick, but I don't know if</span>
    <span class="s3"># we'll actually need that for anything...) For sockets this doesn't</span>
    <span class="s3"># matter, Python never allocates an fd. So let's wait until we actually</span>
    <span class="s3"># encounter the problem before worrying about it.</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Handle</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;HANDLE&quot;</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">Handle</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">handle_array</span><span class="s2">(</span><span class="s1">count</span><span class="s2">: </span><span class="s1">int</span><span class="s2">) </span><span class="s1">-&gt; HandleArray</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Make an array of handles.&quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">HandleArray</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">new</span><span class="s2">(</span><span class="s4">f&quot;HANDLE[</span><span class="s0">{</span><span class="s1">count</span><span class="s0">}</span><span class="s4">]&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">raise_winerror</span><span class="s2">(</span>
    <span class="s1">winerror</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">*,</span>
    <span class="s1">filename</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">filename2</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; NoReturn</span><span class="s2">:</span>
    <span class="s3"># assert sys.platform == &quot;win32&quot;  # TODO: make this work in MyPy</span>
    <span class="s3"># ... in the meanwhile, ffi.getwinerror() is undefined on non-Windows, necessitating the type</span>
    <span class="s3"># ignores.</span>

    <span class="s0">if </span><span class="s1">winerror </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">err </span><span class="s2">= </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">getwinerror</span><span class="s2">()  </span><span class="s3"># type: ignore[attr-defined,unused-ignore]</span>
        <span class="s0">if </span><span class="s1">err </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;No error set?&quot;</span><span class="s2">)</span>
        <span class="s1">winerror</span><span class="s2">, </span><span class="s1">msg </span><span class="s2">= </span><span class="s1">err</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">err </span><span class="s2">= </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">getwinerror</span><span class="s2">(</span><span class="s1">winerror</span><span class="s2">)  </span><span class="s3"># type: ignore[attr-defined,unused-ignore]</span>
        <span class="s0">if </span><span class="s1">err </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;No error set?&quot;</span><span class="s2">)</span>
        <span class="s1">_</span><span class="s2">, </span><span class="s1">msg </span><span class="s2">= </span><span class="s1">err</span>
    <span class="s3"># https://docs.python.org/3/library/exceptions.html#OSError</span>
    <span class="s0">raise </span><span class="s1">OSError</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">winerror</span><span class="s2">, </span><span class="s1">filename2</span><span class="s2">)</span>
</pre>
</body>
</html>