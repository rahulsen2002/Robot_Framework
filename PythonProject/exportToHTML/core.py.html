<html>
<head>
<title>core.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
core.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;distutils.core 
 
The only module that needs to be imported to use the Distutils; provides 
the 'setup' function (which is to be called from the setup script).  Also 
indirectly provides the Distribution and Command classes, although they are 
really defined in distutils.dist and distutils.cmd. 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">tokenize</span>
<span class="s2">from </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">abc </span><span class="s2">import </span><span class="s1">Iterable</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">cmd </span><span class="s2">import </span><span class="s1">Command</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">debug </span><span class="s2">import </span><span class="s1">DEBUG</span>

<span class="s4"># Mainly import these so setup scripts can &quot;from distutils.core import&quot; them.</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">dist </span><span class="s2">import </span><span class="s1">Distribution</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">CCompilerError</span><span class="s3">,</span>
    <span class="s1">DistutilsArgError</span><span class="s3">,</span>
    <span class="s1">DistutilsError</span><span class="s3">,</span>
    <span class="s1">DistutilsSetupError</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">extension </span><span class="s2">import </span><span class="s1">Extension</span>

<span class="s1">__all__ </span><span class="s3">= [</span><span class="s5">'Distribution'</span><span class="s3">, </span><span class="s5">'Command'</span><span class="s3">, </span><span class="s5">'Extension'</span><span class="s3">, </span><span class="s5">'setup'</span><span class="s3">]</span>

<span class="s4"># This is a barebones help message generated displayed when the user</span>
<span class="s4"># runs the setup script with no arguments at all.  More useful help</span>
<span class="s4"># is generated with various --help options: global help, list commands,</span>
<span class="s4"># and per-command help.</span>
<span class="s1">USAGE </span><span class="s3">= </span><span class="s5">&quot;&quot;&quot;</span><span class="s2">\ 
</span><span class="s5">usage: %(script)s [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...] 
   or: %(script)s --help [cmd1 cmd2 ...] 
   or: %(script)s --help-commands 
   or: %(script)s cmd --help 
&quot;&quot;&quot;</span>


<span class="s2">def </span><span class="s1">gen_usage</span><span class="s3">(</span><span class="s1">script_name</span><span class="s3">):</span>
    <span class="s1">script </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">script_name</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">USAGE </span><span class="s3">% </span><span class="s1">locals</span><span class="s3">()</span>


<span class="s4"># Some mild magic to control the behaviour of 'setup()' from 'run_setup()'.</span>
<span class="s1">_setup_stop_after </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">_setup_distribution </span><span class="s3">= </span><span class="s2">None</span>

<span class="s4"># Legal keyword arguments for the setup() function</span>
<span class="s1">setup_keywords </span><span class="s3">= (</span>
    <span class="s5">'distclass'</span><span class="s3">,</span>
    <span class="s5">'script_name'</span><span class="s3">,</span>
    <span class="s5">'script_args'</span><span class="s3">,</span>
    <span class="s5">'options'</span><span class="s3">,</span>
    <span class="s5">'name'</span><span class="s3">,</span>
    <span class="s5">'version'</span><span class="s3">,</span>
    <span class="s5">'author'</span><span class="s3">,</span>
    <span class="s5">'author_email'</span><span class="s3">,</span>
    <span class="s5">'maintainer'</span><span class="s3">,</span>
    <span class="s5">'maintainer_email'</span><span class="s3">,</span>
    <span class="s5">'url'</span><span class="s3">,</span>
    <span class="s5">'license'</span><span class="s3">,</span>
    <span class="s5">'description'</span><span class="s3">,</span>
    <span class="s5">'long_description'</span><span class="s3">,</span>
    <span class="s5">'keywords'</span><span class="s3">,</span>
    <span class="s5">'platforms'</span><span class="s3">,</span>
    <span class="s5">'classifiers'</span><span class="s3">,</span>
    <span class="s5">'download_url'</span><span class="s3">,</span>
    <span class="s5">'requires'</span><span class="s3">,</span>
    <span class="s5">'provides'</span><span class="s3">,</span>
    <span class="s5">'obsoletes'</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s4"># Legal keyword arguments for the Extension constructor</span>
<span class="s1">extension_keywords </span><span class="s3">= (</span>
    <span class="s5">'name'</span><span class="s3">,</span>
    <span class="s5">'sources'</span><span class="s3">,</span>
    <span class="s5">'include_dirs'</span><span class="s3">,</span>
    <span class="s5">'define_macros'</span><span class="s3">,</span>
    <span class="s5">'undef_macros'</span><span class="s3">,</span>
    <span class="s5">'library_dirs'</span><span class="s3">,</span>
    <span class="s5">'libraries'</span><span class="s3">,</span>
    <span class="s5">'runtime_library_dirs'</span><span class="s3">,</span>
    <span class="s5">'extra_objects'</span><span class="s3">,</span>
    <span class="s5">'extra_compile_args'</span><span class="s3">,</span>
    <span class="s5">'extra_link_args'</span><span class="s3">,</span>
    <span class="s5">'swig_opts'</span><span class="s3">,</span>
    <span class="s5">'export_symbols'</span><span class="s3">,</span>
    <span class="s5">'depends'</span><span class="s3">,</span>
    <span class="s5">'language'</span><span class="s3">,</span>
<span class="s3">)</span>


<span class="s2">def </span><span class="s1">setup</span><span class="s3">(**</span><span class="s1">attrs</span><span class="s3">):  </span><span class="s4"># noqa: C901</span>
    <span class="s0">&quot;&quot;&quot;The gateway to the Distutils: do everything your setup script needs 
    to do, in a highly flexible and user-driven way.  Briefly: create a 
    Distribution instance; find and parse config files; parse the command 
    line; run each Distutils command found there, customized by the options 
    supplied to 'setup()' (as keyword arguments), in config files, and on 
    the command line. 
 
    The Distribution instance might be an instance of a class supplied via 
    the 'distclass' keyword argument to 'setup'; if no such class is 
    supplied, then the Distribution class (in dist.py) is instantiated. 
    All other arguments to 'setup' (except for 'cmdclass') are used to set 
    attributes of the Distribution instance. 
 
    The 'cmdclass' argument, if supplied, is a dictionary mapping command 
    names to command classes.  Each command encountered on the command line 
    will be turned into a command class, which is in turn instantiated; any 
    class found in 'cmdclass' is used in place of the default, which is 
    (for command 'foo_bar') class 'foo_bar' in module 
    'distutils.command.foo_bar'.  The command class must provide a 
    'user_options' attribute which is a list of option specifiers for 
    'distutils.fancy_getopt'.  Any command-line options between the current 
    and the next command are used to set attributes of the current command 
    object. 
 
    When the entire command-line has been successfully parsed, calls the 
    'run()' method on each command object in turn.  This method will be 
    driven entirely by the Distribution object (which each command object 
    has a reference to, thanks to its constructor), and the 
    command-specific options that became attributes of each command 
    object. 
    &quot;&quot;&quot;</span>

    <span class="s2">global </span><span class="s1">_setup_stop_after</span><span class="s3">, </span><span class="s1">_setup_distribution</span>

    <span class="s4"># Determine the distribution class -- either caller-supplied or</span>
    <span class="s4"># our Distribution (see below).</span>
    <span class="s1">klass </span><span class="s3">= </span><span class="s1">attrs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'distclass'</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">klass</span><span class="s3">:</span>
        <span class="s1">attrs</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s5">'distclass'</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">klass </span><span class="s3">= </span><span class="s1">Distribution</span>

    <span class="s2">if </span><span class="s5">'script_name' </span><span class="s2">not in </span><span class="s1">attrs</span><span class="s3">:</span>
        <span class="s1">attrs</span><span class="s3">[</span><span class="s5">'script_name'</span><span class="s3">] = </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s2">if </span><span class="s5">'script_args' </span><span class="s2">not in </span><span class="s1">attrs</span><span class="s3">:</span>
        <span class="s1">attrs</span><span class="s3">[</span><span class="s5">'script_args'</span><span class="s3">] = </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:]</span>

    <span class="s4"># Create the Distribution instance, using the remaining arguments</span>
    <span class="s4"># (ie. everything except distclass) to initialize it</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">_setup_distribution </span><span class="s3">= </span><span class="s1">dist </span><span class="s3">= </span><span class="s1">klass</span><span class="s3">(</span><span class="s1">attrs</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">DistutilsSetupError </span><span class="s2">as </span><span class="s1">msg</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s5">'name' </span><span class="s2">not in </span><span class="s1">attrs</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">SystemExit</span><span class="s3">(</span><span class="s5">f&quot;error in setup command: </span><span class="s2">{</span><span class="s1">msg</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">SystemExit</span><span class="s3">(</span><span class="s5">&quot;error in {} setup command: {}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">attrs</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">], </span><span class="s1">msg</span><span class="s3">))</span>

    <span class="s2">if </span><span class="s1">_setup_stop_after </span><span class="s3">== </span><span class="s5">&quot;init&quot;</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">dist</span>

    <span class="s4"># Find and parse the config file(s): they will override options from</span>
    <span class="s4"># the setup script, but be overridden by the command line.</span>
    <span class="s1">dist</span><span class="s3">.</span><span class="s1">parse_config_files</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">DEBUG</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s5">&quot;options (after parsing config files):&quot;</span><span class="s3">)</span>
        <span class="s1">dist</span><span class="s3">.</span><span class="s1">dump_option_dicts</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">_setup_stop_after </span><span class="s3">== </span><span class="s5">&quot;config&quot;</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">dist</span>

    <span class="s4"># Parse the command line and override config files; any</span>
    <span class="s4"># command-line errors are the end user's fault, so turn them into</span>
    <span class="s4"># SystemExit to suppress tracebacks.</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">ok </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">parse_command_line</span><span class="s3">()</span>
    <span class="s2">except </span><span class="s1">DistutilsArgError </span><span class="s2">as </span><span class="s1">msg</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">SystemExit</span><span class="s3">(</span><span class="s1">gen_usage</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">script_name</span><span class="s3">) + </span><span class="s5">f&quot;</span><span class="s2">\n</span><span class="s5">error: </span><span class="s2">{</span><span class="s1">msg</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">DEBUG</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s5">&quot;options (after parsing command line):&quot;</span><span class="s3">)</span>
        <span class="s1">dist</span><span class="s3">.</span><span class="s1">dump_option_dicts</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">_setup_stop_after </span><span class="s3">== </span><span class="s5">&quot;commandline&quot;</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">dist</span>

    <span class="s4"># And finally, run all the commands found on the command line.</span>
    <span class="s2">if </span><span class="s1">ok</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">run_commands</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">dist</span>


<span class="s4"># setup ()</span>


<span class="s2">def </span><span class="s1">run_commands</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Given a Distribution object run all the commands, 
    raising ``SystemExit`` errors in the case of failure. 
 
    This function assumes that either ``sys.argv`` or ``dist.script_args`` 
    is already set accordingly. 
    &quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">dist</span><span class="s3">.</span><span class="s1">run_commands</span><span class="s3">()</span>
    <span class="s2">except </span><span class="s1">KeyboardInterrupt</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">SystemExit</span><span class="s3">(</span><span class="s5">&quot;interrupted&quot;</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">OSError </span><span class="s2">as </span><span class="s1">exc</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">DEBUG</span><span class="s3">:</span>
            <span class="s1">sys</span><span class="s3">.</span><span class="s1">stderr</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s5">f&quot;error: </span><span class="s2">{</span><span class="s1">exc</span><span class="s2">}\n</span><span class="s5">&quot;</span><span class="s3">)</span>
            <span class="s2">raise</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">SystemExit</span><span class="s3">(</span><span class="s5">f&quot;error: </span><span class="s2">{</span><span class="s1">exc</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>

    <span class="s2">except </span><span class="s3">(</span><span class="s1">DistutilsError</span><span class="s3">, </span><span class="s1">CCompilerError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">msg</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">DEBUG</span><span class="s3">:</span>
            <span class="s2">raise</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">SystemExit</span><span class="s3">(</span><span class="s5">&quot;error: &quot; </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">))</span>

    <span class="s2">return </span><span class="s1">dist</span>


<span class="s2">def </span><span class="s1">run_setup</span><span class="s3">(</span><span class="s1">script_name</span><span class="s3">, </span><span class="s1">script_args</span><span class="s3">: </span><span class="s1">Iterable</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] | </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">stop_after</span><span class="s3">=</span><span class="s5">&quot;run&quot;</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Run a setup script in a somewhat controlled environment, and 
    return the Distribution instance that drives things.  This is useful 
    if you need to find out the distribution meta-data (passed as 
    keyword args from 'script' to 'setup()', or the contents of the 
    config files or command-line. 
 
    'script_name' is a file that will be read and run with 'exec()'; 
    'sys.argv[0]' will be replaced with 'script' for the duration of the 
    call.  'script_args' is a list of strings; if supplied, 
    'sys.argv[1:]' will be replaced by 'script_args' for the duration of 
    the call. 
 
    'stop_after' tells 'setup()' when to stop processing; possible 
    values: 
      init 
        stop after the Distribution instance has been created and 
        populated with the keyword arguments to 'setup()' 
      config 
        stop after config files have been parsed (and their data 
        stored in the Distribution instance) 
      commandline 
        stop after the command-line ('sys.argv[1:]' or 'script_args') 
        have been parsed (and the data stored in the Distribution) 
      run [default] 
        stop after all commands have been run (the same as if 'setup()' 
        had been called in the usual way 
 
    Returns the Distribution instance, which provides all information 
    used to drive the Distutils. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">stop_after </span><span class="s2">not in </span><span class="s3">(</span><span class="s5">'init'</span><span class="s3">, </span><span class="s5">'config'</span><span class="s3">, </span><span class="s5">'commandline'</span><span class="s3">, </span><span class="s5">'run'</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">f&quot;invalid value for 'stop_after': </span><span class="s2">{</span><span class="s1">stop_after</span><span class="s2">!r}</span><span class="s5">&quot;</span><span class="s3">)</span>

    <span class="s2">global </span><span class="s1">_setup_stop_after</span><span class="s3">, </span><span class="s1">_setup_distribution</span>
    <span class="s1">_setup_stop_after </span><span class="s3">= </span><span class="s1">stop_after</span>

    <span class="s1">save_argv </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">g </span><span class="s3">= {</span><span class="s5">'__file__'</span><span class="s3">: </span><span class="s1">script_name</span><span class="s3">, </span><span class="s5">'__name__'</span><span class="s3">: </span><span class="s5">'__main__'</span><span class="s3">}</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">sys</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] = </span><span class="s1">script_name</span>
            <span class="s2">if </span><span class="s1">script_args </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">sys</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:] = </span><span class="s1">script_args</span>
            <span class="s4"># tokenize.open supports automatic encoding detection</span>
            <span class="s2">with </span><span class="s1">tokenize</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">script_name</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">code </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">r'\r\n'</span><span class="s3">, </span><span class="s5">r'\n'</span><span class="s3">)</span>
                <span class="s1">exec</span><span class="s3">(</span><span class="s1">code</span><span class="s3">, </span><span class="s1">g</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">sys</span><span class="s3">.</span><span class="s1">argv </span><span class="s3">= </span><span class="s1">save_argv</span>
            <span class="s1">_setup_stop_after </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">except </span><span class="s1">SystemExit</span><span class="s3">:</span>
        <span class="s4"># Hmm, should we do something if exiting with a non-zero code</span>
        <span class="s4"># (ie. error)?</span>
        <span class="s2">pass</span>

    <span class="s2">if </span><span class="s1">_setup_distribution </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span>
            <span class="s5">&quot;'distutils.core.setup()' was never called -- &quot;</span>
            <span class="s5">f&quot;perhaps '</span><span class="s2">{</span><span class="s1">script_name</span><span class="s2">}</span><span class="s5">' is not a Distutils setup script?&quot;</span>
        <span class="s3">)</span>

    <span class="s4"># I wonder if the setup script's namespace -- g and l -- would be of</span>
    <span class="s4"># any interest to callers?</span>
    <span class="s4"># print &quot;_setup_distribution:&quot;, _setup_distribution</span>
    <span class="s2">return </span><span class="s1">_setup_distribution</span>


<span class="s4"># run_setup ()</span>
</pre>
</body>
</html>