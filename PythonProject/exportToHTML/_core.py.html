<html>
<head>
<title>_core.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_core.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">socket</span>
<span class="s0">import </span><span class="s1">struct</span>
<span class="s0">import </span><span class="s1">threading</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Optional</span><span class="s2">, </span><span class="s1">Union</span>

<span class="s3"># websocket modules</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_abnf </span><span class="s0">import </span><span class="s1">ABNF</span><span class="s2">, </span><span class="s1">STATUS_NORMAL</span><span class="s2">, </span><span class="s1">continuous_frame</span><span class="s2">, </span><span class="s1">frame_buffer</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_exceptions </span><span class="s0">import </span><span class="s1">WebSocketProtocolException</span><span class="s2">, </span><span class="s1">WebSocketConnectionClosedException</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_handshake </span><span class="s0">import </span><span class="s1">SUPPORTED_REDIRECT_STATUSES</span><span class="s2">, </span><span class="s1">handshake</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_http </span><span class="s0">import </span><span class="s1">connect</span><span class="s2">, </span><span class="s1">proxy_info</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_logging </span><span class="s0">import </span><span class="s1">debug</span><span class="s2">, </span><span class="s1">error</span><span class="s2">, </span><span class="s1">trace</span><span class="s2">, </span><span class="s1">isEnabledForError</span><span class="s2">, </span><span class="s1">isEnabledForTrace</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_socket </span><span class="s0">import </span><span class="s1">getdefaulttimeout</span><span class="s2">, </span><span class="s1">recv</span><span class="s2">, </span><span class="s1">send</span><span class="s2">, </span><span class="s1">sock_opt</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_ssl_compat </span><span class="s0">import </span><span class="s1">ssl</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_utils </span><span class="s0">import </span><span class="s1">NoLock</span>

<span class="s4">&quot;&quot;&quot; 
_core.py 
websocket - WebSocket client library for Python 
 
Copyright 2024 engn33r 
 
Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); 
you may not use this file except in compliance with the License. 
You may obtain a copy of the License at 
 
    http://www.apache.org/licenses/LICENSE-2.0 
 
Unless required by applicable law or agreed to in writing, software 
distributed under the License is distributed on an &quot;AS IS&quot; BASIS, 
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
See the License for the specific language governing permissions and 
limitations under the License. 
&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s4">&quot;WebSocket&quot;</span><span class="s2">, </span><span class="s4">&quot;create_connection&quot;</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">WebSocket</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot; 
    Low level WebSocket interface. 
 
    This class is based on the WebSocket protocol `draft-hixie-thewebsocketprotocol-76 &lt;http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76&gt;`_ 
 
    We can connect to the websocket server and send/receive data. 
    The following example is an echo client. 
 
    &gt;&gt;&gt; import websocket 
    &gt;&gt;&gt; ws = websocket.WebSocket() 
    &gt;&gt;&gt; ws.connect(&quot;ws://echo.websocket.events&quot;) 
    &gt;&gt;&gt; ws.recv() 
    'echo.websocket.events sponsored by Lob.com' 
    &gt;&gt;&gt; ws.send(&quot;Hello, Server&quot;) 
    19 
    &gt;&gt;&gt; ws.recv() 
    'Hello, Server' 
    &gt;&gt;&gt; ws.close() 
 
    Parameters 
    ---------- 
    get_mask_key: func 
        A callable function to get new mask keys, see the 
        WebSocket.set_mask_key's docstring for more information. 
    sockopt: tuple 
        Values for socket.setsockopt. 
        sockopt must be tuple and each element is argument of sock.setsockopt. 
    sslopt: dict 
        Optional dict object for ssl socket options. See FAQ for details. 
    fire_cont_frame: bool 
        Fire recv event for each cont frame. Default is False. 
    enable_multithread: bool 
        If set to True, lock send method. 
    skip_utf8_validation: bool 
        Skip utf8 validation. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">get_mask_key</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">sockopt</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">sslopt</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">fire_cont_frame</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">enable_multithread</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">skip_utf8_validation</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">_</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Initialize WebSocket object. 
 
        Parameters 
        ---------- 
        sslopt: dict 
            Optional dict object for ssl socket options. See FAQ for details. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sock_opt </span><span class="s2">= </span><span class="s1">sock_opt</span><span class="s2">(</span><span class="s1">sockopt</span><span class="s2">, </span><span class="s1">sslopt</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">] = </span><span class="s0">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">connected </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">get_mask_key </span><span class="s2">= </span><span class="s1">get_mask_key</span>
        <span class="s3"># These buffer over the build-up of a single frame.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">frame_buffer </span><span class="s2">= </span><span class="s1">frame_buffer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_recv</span><span class="s2">, </span><span class="s1">skip_utf8_validation</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cont_frame </span><span class="s2">= </span><span class="s1">continuous_frame</span><span class="s2">(</span><span class="s1">fire_cont_frame</span><span class="s2">, </span><span class="s1">skip_utf8_validation</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">enable_multithread</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lock </span><span class="s2">= </span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Lock</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">readlock </span><span class="s2">= </span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Lock</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lock </span><span class="s2">= </span><span class="s1">NoLock</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">readlock </span><span class="s2">= </span><span class="s1">NoLock</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Allow iteration over websocket, implying sequential `recv` executions. 
        &quot;&quot;&quot;</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__next__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">next</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__next__</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">fileno</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">set_mask_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Set function to create mask key. You can customize mask key generator. 
        Mainly, this is for testing purpose. 
 
        Parameters 
        ---------- 
        func: func 
            callable object. the func takes 1 argument as integer. 
            The argument means length of mask key. 
            This func must return string(byte array), 
            which length is argument specified. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">get_mask_key </span><span class="s2">= </span><span class="s1">func</span>

    <span class="s0">def </span><span class="s1">gettimeout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; Union</span><span class="s2">[</span><span class="s1">float</span><span class="s2">, </span><span class="s1">int</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
        <span class="s5">&quot;&quot;&quot; 
        Get the websocket timeout (in seconds) as an int or float 
 
        Returns 
        ---------- 
        timeout: int or float 
             returns timeout value (in seconds). This value could be either float/integer. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock_opt</span><span class="s2">.</span><span class="s1">timeout</span>

    <span class="s0">def </span><span class="s1">settimeout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">float</span><span class="s2">, </span><span class="s1">int</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]):</span>
        <span class="s5">&quot;&quot;&quot; 
        Set the timeout to the websocket. 
 
        Parameters 
        ---------- 
        timeout: int or float 
            timeout time (in seconds). This value could be either float/integer. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sock_opt</span><span class="s2">.</span><span class="s1">timeout </span><span class="s2">= </span><span class="s1">timeout</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">settimeout</span><span class="s2">(</span><span class="s1">timeout</span><span class="s2">)</span>

    <span class="s1">timeout </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">gettimeout</span><span class="s2">, </span><span class="s1">settimeout</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getsubprotocol</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Get subprotocol 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response</span><span class="s2">.</span><span class="s1">subprotocol</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return None</span>

    <span class="s1">subprotocol </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">getsubprotocol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getstatus</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Get handshake status 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response</span><span class="s2">.</span><span class="s1">status</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return None</span>

    <span class="s1">status </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">getstatus</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getheaders</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Get handshake response header 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response</span><span class="s2">.</span><span class="s1">headers</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">is_ssl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">SSLSocket</span><span class="s2">)</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s0">return False</span>

    <span class="s1">headers </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">getheaders</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">url</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Connect to url. url is websocket url scheme. 
        ie. ws://host:port/resource 
        You can customize using 'options'. 
        If you set &quot;header&quot; list object, you can set your own custom header. 
 
        &gt;&gt;&gt; ws = WebSocket() 
        &gt;&gt;&gt; ws.connect(&quot;ws://echo.websocket.events&quot;, 
                ...     header=[&quot;User-Agent: MyProgram&quot;, 
                ...             &quot;x-custom: header&quot;]) 
 
        Parameters 
        ---------- 
        header: list or dict 
            Custom http header list or dict. 
        cookie: str 
            Cookie value. 
        origin: str 
            Custom origin url. 
        connection: str 
            Custom connection header value. 
            Default value &quot;Upgrade&quot; set in _handshake.py 
        suppress_origin: bool 
            Suppress outputting origin header. 
        host: str 
            Custom host header string. 
        timeout: int or float 
            Socket timeout time. This value is an integer or float. 
            If you set None for this value, it means &quot;use default_timeout value&quot; 
        http_proxy_host: str 
            HTTP proxy host name. 
        http_proxy_port: str or int 
            HTTP proxy port. Default is 80. 
        http_no_proxy: list 
            Whitelisted host names that don't use the proxy. 
        http_proxy_auth: tuple 
            HTTP proxy auth information. Tuple of username and password. Default is None. 
        http_proxy_timeout: int or float 
            HTTP proxy timeout, default is 60 sec as per python-socks. 
        redirect_limit: int 
            Number of redirects to follow. 
        subprotocols: list 
            List of available subprotocols. Default is None. 
        socket: socket 
            Pre-initialized stream socket. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sock_opt</span><span class="s2">.</span><span class="s1">timeout </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;timeout&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock_opt</span><span class="s2">.</span><span class="s1">timeout</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">addrs </span><span class="s2">= </span><span class="s1">connect</span><span class="s2">(</span>
            <span class="s1">url</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock_opt</span><span class="s2">, </span><span class="s1">proxy_info</span><span class="s2">(**</span><span class="s1">options</span><span class="s2">), </span><span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;socket&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response </span><span class="s2">= </span><span class="s1">handshake</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">url</span><span class="s2">, *</span><span class="s1">addrs</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;redirect_limit&quot;</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response</span><span class="s2">.</span><span class="s1">status </span><span class="s0">in </span><span class="s1">SUPPORTED_REDIRECT_STATUSES</span><span class="s2">:</span>
                    <span class="s1">url </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">[</span><span class="s4">&quot;location&quot;</span><span class="s2">]</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">addrs </span><span class="s2">= </span><span class="s1">connect</span><span class="s2">(</span>
                        <span class="s1">url</span><span class="s2">,</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">sock_opt</span><span class="s2">,</span>
                        <span class="s1">proxy_info</span><span class="s2">(**</span><span class="s1">options</span><span class="s2">),</span>
                        <span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;socket&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
                    <span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_response </span><span class="s2">= </span><span class="s1">handshake</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">url</span><span class="s2">, *</span><span class="s1">addrs</span><span class="s2">, **</span><span class="s1">options</span>
                    <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connected </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sock </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">raise</span>

    <span class="s0">def </span><span class="s1">send</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">payload</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">str</span><span class="s2">], </span><span class="s1">opcode</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_TEXT</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot; 
        Send the data as string. 
 
        Parameters 
        ---------- 
        payload: str 
            Payload must be utf-8 string or unicode, 
            If the opcode is OPCODE_TEXT. 
            Otherwise, it must be string(byte array). 
        opcode: int 
            Operation code (opcode) to send. 
        &quot;&quot;&quot;</span>

        <span class="s1">frame </span><span class="s2">= </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">create_frame</span><span class="s2">(</span><span class="s1">payload</span><span class="s2">, </span><span class="s1">opcode</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">send_frame</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">send_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">text_data</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot; 
        Sends UTF-8 encoded text. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">text_data</span><span class="s2">, </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_TEXT</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">send_bytes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">bytearray</span><span class="s2">]) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot; 
        Sends a sequence of bytes. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_BINARY</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">send_frame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot; 
        Send the data frame. 
 
        &gt;&gt;&gt; ws = create_connection(&quot;ws://echo.websocket.events&quot;) 
        &gt;&gt;&gt; frame = ABNF.create_frame(&quot;Hello&quot;, ABNF.OPCODE_TEXT) 
        &gt;&gt;&gt; ws.send_frame(frame) 
        &gt;&gt;&gt; cont_frame = ABNF.create_frame(&quot;My name is &quot;, ABNF.OPCODE_CONT, 0) 
        &gt;&gt;&gt; ws.send_frame(frame) 
        &gt;&gt;&gt; cont_frame = ABNF.create_frame(&quot;Foo Bar&quot;, ABNF.OPCODE_CONT, 1) 
        &gt;&gt;&gt; ws.send_frame(frame) 
 
        Parameters 
        ---------- 
        frame: ABNF frame 
            frame data created by ABNF.create_frame 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_mask_key</span><span class="s2">:</span>
            <span class="s1">frame</span><span class="s2">.</span><span class="s1">get_mask_key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_mask_key</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">format</span><span class="s2">()</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isEnabledForTrace</span><span class="s2">():</span>
            <span class="s1">trace</span><span class="s2">(</span><span class="s4">f&quot;++Sent raw: </span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s1">trace</span><span class="s2">(</span><span class="s4">f&quot;++Sent decoded: </span><span class="s0">{</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">__str__</span><span class="s2">()</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lock</span><span class="s2">:</span>
            <span class="s0">while </span><span class="s1">data</span><span class="s2">:</span>
                <span class="s1">l </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_send</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s1">l</span><span class="s2">:]</span>

        <span class="s0">return </span><span class="s1">length</span>

    <span class="s0">def </span><span class="s1">send_binary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">payload</span><span class="s2">: </span><span class="s1">bytes</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot; 
        Send a binary message (OPCODE_BINARY). 
 
        Parameters 
        ---------- 
        payload: bytes 
            payload of message to send. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">payload</span><span class="s2">, </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_BINARY</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">ping</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">payload</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Send ping data. 
 
        Parameters 
        ---------- 
        payload: str 
            data payload to send server. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">payload</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">payload </span><span class="s2">= </span><span class="s1">payload</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">payload</span><span class="s2">, </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_PING</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">pong</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">payload</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Send pong data. 
 
        Parameters 
        ---------- 
        payload: str 
            data payload to send server. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">payload</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">payload </span><span class="s2">= </span><span class="s1">payload</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">payload</span><span class="s2">, </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_PONG</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">recv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">]:</span>
        <span class="s5">&quot;&quot;&quot; 
        Receive string data(byte array) from the server. 
 
        Returns 
        ---------- 
        data: string (byte array) value. 
        &quot;&quot;&quot;</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readlock</span><span class="s2">:</span>
            <span class="s1">opcode</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_data</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">opcode </span><span class="s2">== </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_TEXT</span><span class="s2">:</span>
            <span class="s1">data_received</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">str</span><span class="s2">] = </span><span class="s1">data</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data_received</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">data_received</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data_received</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">data_received</span>
        <span class="s0">elif </span><span class="s1">opcode </span><span class="s2">== </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_BINARY</span><span class="s2">:</span>
            <span class="s1">data_binary</span><span class="s2">: </span><span class="s1">bytes </span><span class="s2">= </span><span class="s1">data</span>
            <span class="s0">return </span><span class="s1">data_binary</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s4">&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">recv_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">control_frame</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot; 
        Receive data with operation code. 
 
        Parameters 
        ---------- 
        control_frame: bool 
            a boolean flag indicating whether to return control frame 
            data, defaults to False 
 
        Returns 
        ------- 
        opcode, frame.data: tuple 
            tuple of operation code and string(byte array) value. 
        &quot;&quot;&quot;</span>
        <span class="s1">opcode</span><span class="s2">, </span><span class="s1">frame </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_data_frame</span><span class="s2">(</span><span class="s1">control_frame</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">opcode</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">recv_data_frame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">control_frame</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot; 
        Receive data with operation code. 
 
        If a valid ping message is received, a pong response is sent. 
 
        Parameters 
        ---------- 
        control_frame: bool 
            a boolean flag indicating whether to return control frame 
            data, defaults to False 
 
        Returns 
        ------- 
        frame.opcode, frame: tuple 
            tuple of operation code and string(byte array) value. 
        &quot;&quot;&quot;</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s1">frame </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_frame</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">isEnabledForTrace</span><span class="s2">():</span>
                <span class="s1">trace</span><span class="s2">(</span><span class="s4">f&quot;++Rcv raw: </span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">format</span><span class="s2">())</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s1">trace</span><span class="s2">(</span><span class="s4">f&quot;++Rcv decoded: </span><span class="s0">{</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">__str__</span><span class="s2">()</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">frame</span><span class="s2">:</span>
                <span class="s3"># handle error:</span>
                <span class="s3"># 'NoneType' object has no attribute 'opcode'</span>
                <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s4">f&quot;Not a valid frame </span><span class="s0">{</span><span class="s1">frame</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode </span><span class="s0">in </span><span class="s2">(</span>
                <span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_TEXT</span><span class="s2">,</span>
                <span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_BINARY</span><span class="s2">,</span>
                <span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_CONT</span><span class="s2">,</span>
            <span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cont_frame</span><span class="s2">.</span><span class="s1">validate</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">cont_frame</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">)</span>

                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cont_frame</span><span class="s2">.</span><span class="s1">is_fire</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">):</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cont_frame</span><span class="s2">.</span><span class="s1">extract</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">)</span>

            <span class="s0">elif </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode </span><span class="s2">== </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_CLOSE</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">send_close</span><span class="s2">()</span>
                <span class="s0">return </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode</span><span class="s2">, </span><span class="s1">frame</span>
            <span class="s0">elif </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode </span><span class="s2">== </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_PING</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">data</span><span class="s2">) &lt; </span><span class="s6">126</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pong</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s4">&quot;Ping message is too long&quot;</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">control_frame</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode</span><span class="s2">, </span><span class="s1">frame</span>
            <span class="s0">elif </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode </span><span class="s2">== </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_PONG</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">control_frame</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode</span><span class="s2">, </span><span class="s1">frame</span>

    <span class="s0">def </span><span class="s1">recv_frame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Receive data as frame from server. 
 
        Returns 
        ------- 
        self.frame_buffer.recv_frame(): ABNF frame object 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">frame_buffer</span><span class="s2">.</span><span class="s1">recv_frame</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">send_close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">status</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">STATUS_NORMAL</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">: </span><span class="s1">bytes </span><span class="s2">= </span><span class="s7">b&quot;&quot;</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Send close data to the server. 
 
        Parameters 
        ---------- 
        status: int 
            Status code to send. See STATUS_XXX. 
        reason: str or bytes 
            The reason to close. This must be string or UTF-8 bytes. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">status </span><span class="s2">&lt; </span><span class="s6">0 </span><span class="s0">or </span><span class="s1">status </span><span class="s2">&gt;= </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">LENGTH_16</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">&quot;code is invalid range&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">connected </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s4">&quot;!H&quot;</span><span class="s2">, </span><span class="s1">status</span><span class="s2">) + </span><span class="s1">reason</span><span class="s2">, </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_CLOSE</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">status</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">STATUS_NORMAL</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">: </span><span class="s1">bytes </span><span class="s2">= </span><span class="s7">b&quot;&quot;</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Close Websocket object 
 
        Parameters 
        ---------- 
        status: int 
            Status code to send. See VALID_CLOSE_STATUS in ABNF. 
        reason: bytes 
            The reason to close in UTF-8. 
        timeout: int or float 
            Timeout until receive a close frame. 
            If None, it will wait forever until receive a close frame. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connected</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">status </span><span class="s2">&lt; </span><span class="s6">0 </span><span class="s0">or </span><span class="s1">status </span><span class="s2">&gt;= </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">LENGTH_16</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">&quot;code is invalid range&quot;</span><span class="s2">)</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connected </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s4">&quot;!H&quot;</span><span class="s2">, </span><span class="s1">status</span><span class="s2">) + </span><span class="s1">reason</span><span class="s2">, </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_CLOSE</span><span class="s2">)</span>
            <span class="s1">sock_timeout </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">gettimeout</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">settimeout</span><span class="s2">(</span><span class="s1">timeout</span><span class="s2">)</span>
            <span class="s1">start_time </span><span class="s2">= </span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">()</span>
            <span class="s0">while </span><span class="s1">timeout </span><span class="s0">is None or </span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">() - </span><span class="s1">start_time </span><span class="s2">&lt; </span><span class="s1">timeout</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">frame </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_frame</span><span class="s2">()</span>
                    <span class="s0">if </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode </span><span class="s2">!= </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_CLOSE</span><span class="s2">:</span>
                        <span class="s0">continue</span>
                    <span class="s0">if </span><span class="s1">isEnabledForError</span><span class="s2">():</span>
                        <span class="s1">recv_status </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s4">&quot;!H&quot;</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">:</span><span class="s6">2</span><span class="s2">])[</span><span class="s6">0</span><span class="s2">]</span>
                        <span class="s0">if </span><span class="s1">recv_status </span><span class="s2">&gt;= </span><span class="s6">3000 </span><span class="s0">and </span><span class="s1">recv_status </span><span class="s2">&lt;= </span><span class="s6">4999</span><span class="s2">:</span>
                            <span class="s1">debug</span><span class="s2">(</span><span class="s4">f&quot;close status: </span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">recv_status</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                        <span class="s0">elif </span><span class="s1">recv_status </span><span class="s2">!= </span><span class="s1">STATUS_NORMAL</span><span class="s2">:</span>
                            <span class="s1">error</span><span class="s2">(</span><span class="s4">f&quot;close status: </span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">recv_status</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                    <span class="s0">break</span>
                <span class="s0">except</span><span class="s2">:</span>
                    <span class="s0">break</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">settimeout</span><span class="s2">(</span><span class="s1">sock_timeout</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SHUT_RDWR</span><span class="s2">)</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s0">pass</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">abort</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Low-level asynchronous abort, wakes up other threads that are waiting in recv_* 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connected</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SHUT_RDWR</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        close socket, immediately. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sock </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connected </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">_send</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">]):</span>
        <span class="s0">return </span><span class="s1">send</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_recv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bufsize</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">recv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">bufsize</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">WebSocketConnectionClosedException</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sock </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connected </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">raise</span>


<span class="s0">def </span><span class="s1">create_connection</span><span class="s2">(</span><span class="s1">url</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">class_</span><span class="s2">=</span><span class="s1">WebSocket</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Connect to url and return websocket object. 
 
    Connect to url and return the WebSocket object. 
    Passing optional timeout parameter will set the timeout on the socket. 
    If no timeout is supplied, 
    the global default timeout setting returned by getdefaulttimeout() is used. 
    You can customize using 'options'. 
    If you set &quot;header&quot; list object, you can set your own custom header. 
 
    &gt;&gt;&gt; conn = create_connection(&quot;ws://echo.websocket.events&quot;, 
         ...     header=[&quot;User-Agent: MyProgram&quot;, 
         ...             &quot;x-custom: header&quot;]) 
 
    Parameters 
    ---------- 
    class_: class 
        class to instantiate when creating the connection. It has to implement 
        settimeout and connect. It's __init__ should be compatible with 
        WebSocket.__init__, i.e. accept all of it's kwargs. 
    header: list or dict 
        custom http header list or dict. 
    cookie: str 
        Cookie value. 
    origin: str 
        custom origin url. 
    suppress_origin: bool 
        suppress outputting origin header. 
    host: str 
        custom host header string. 
    timeout: int or float 
        socket timeout time. This value could be either float/integer. 
        If set to None, it uses the default_timeout value. 
    http_proxy_host: str 
        HTTP proxy host name. 
    http_proxy_port: str or int 
        HTTP proxy port. If not set, set to 80. 
    http_no_proxy: list 
        Whitelisted host names that don't use the proxy. 
    http_proxy_auth: tuple 
        HTTP proxy auth information. tuple of username and password. Default is None. 
    http_proxy_timeout: int or float 
        HTTP proxy timeout, default is 60 sec as per python-socks. 
    enable_multithread: bool 
        Enable lock for multithread. 
    redirect_limit: int 
        Number of redirects to follow. 
    sockopt: tuple 
        Values for socket.setsockopt. 
        sockopt must be a tuple and each element is an argument of sock.setsockopt. 
    sslopt: dict 
        Optional dict object for ssl socket options. See FAQ for details. 
    subprotocols: list 
        List of available subprotocols. Default is None. 
    skip_utf8_validation: bool 
        Skip utf8 validation. 
    socket: socket 
        Pre-initialized stream socket. 
    &quot;&quot;&quot;</span>
    <span class="s1">sockopt </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;sockopt&quot;</span><span class="s2">, [])</span>
    <span class="s1">sslopt </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;sslopt&quot;</span><span class="s2">, {})</span>
    <span class="s1">fire_cont_frame </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;fire_cont_frame&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">enable_multithread </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;enable_multithread&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">skip_utf8_validation </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;skip_utf8_validation&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">websock </span><span class="s2">= </span><span class="s1">class_</span><span class="s2">(</span>
        <span class="s1">sockopt</span><span class="s2">=</span><span class="s1">sockopt</span><span class="s2">,</span>
        <span class="s1">sslopt</span><span class="s2">=</span><span class="s1">sslopt</span><span class="s2">,</span>
        <span class="s1">fire_cont_frame</span><span class="s2">=</span><span class="s1">fire_cont_frame</span><span class="s2">,</span>
        <span class="s1">enable_multithread</span><span class="s2">=</span><span class="s1">enable_multithread</span><span class="s2">,</span>
        <span class="s1">skip_utf8_validation</span><span class="s2">=</span><span class="s1">skip_utf8_validation</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">options</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">websock</span><span class="s2">.</span><span class="s1">settimeout</span><span class="s2">(</span><span class="s1">timeout </span><span class="s0">if </span><span class="s1">timeout </span><span class="s0">is not None else </span><span class="s1">getdefaulttimeout</span><span class="s2">())</span>
    <span class="s1">websock</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">url</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">websock</span>
</pre>
</body>
</html>