<html>
<head>
<title>connectioncache.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
connectioncache.py</font>
</center></td></tr></table>
<pre><span class="s0">#  Copyright 2008-2015 Nokia Networks</span>
<span class="s0">#  Copyright 2016-     Robot Framework Foundation</span>
<span class="s0">#</span>
<span class="s0">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0">#  you may not use this file except in compliance with the License.</span>
<span class="s0">#  You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="s0">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0">#  See the License for the specific language governing permissions and</span>
<span class="s0">#  limitations under the License.</span>

<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">normalizing </span><span class="s2">import </span><span class="s1">NormalizedDict</span>

<span class="s1">Connection </span><span class="s3">= </span><span class="s1">Any</span>


<span class="s2">class </span><span class="s1">ConnectionCache</span><span class="s3">:</span>
    <span class="s4">&quot;&quot;&quot;Cache for libraries to use with concurrent connections, processes, etc. 
 
    The cache stores the registered connections (or other objects) and allows 
    switching between them using generated indices, user given aliases or 
    connection objects themselves. This is useful with any library having a need 
    for multiple concurrent connections, processes, etc. 
 
    This class is used also outside the core framework by SeleniumLibrary, 
    SSHLibrary, etc. Backwards compatibility is thus important when doing changes. 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">no_current_msg</span><span class="s3">=</span><span class="s5">&quot;No open connection.&quot;</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_no_current </span><span class="s3">= </span><span class="s1">NoConnection</span><span class="s3">(</span><span class="s1">no_current_msg</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">current </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_no_current  </span><span class="s0">#: Current active connection.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_connections </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_aliases </span><span class="s3">= </span><span class="s1">NormalizedDict</span><span class="s3">[</span><span class="s1">int</span><span class="s3">]()</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">current_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">&quot;int|None&quot;</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">for </span><span class="s1">index</span><span class="s3">, </span><span class="s1">conn </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">conn </span><span class="s2">is </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">index </span><span class="s3">+ </span><span class="s6">1</span>

    <span class="s3">@</span><span class="s1">current_index</span><span class="s3">.</span><span class="s1">setter</span>
    <span class="s2">def </span><span class="s1">current_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">index</span><span class="s3">: </span><span class="s5">&quot;int|None&quot;</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">index </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">current </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_no_current</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">current </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">[</span><span class="s1">index </span><span class="s3">- </span><span class="s6">1</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">register</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">: </span><span class="s1">Connection</span><span class="s3">, </span><span class="s1">alias</span><span class="s3">: </span><span class="s5">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Registers given connection with optional alias and returns its index. 
 
        Given connection is set to be the :attr:`current` connection. 
 
        If alias is given, it must be a string. Aliases are case and space 
        insensitive. 
 
        The index of the first connection after initialization, and after 
        :meth:`close_all` or :meth:`empty_cache`, is 1, second is 2, etc. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">current </span><span class="s3">= </span><span class="s1">connection</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">alias</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_aliases</span><span class="s3">[</span><span class="s1">alias</span><span class="s3">] = </span><span class="s1">index</span>
        <span class="s2">return </span><span class="s1">index</span>

    <span class="s2">def </span><span class="s1">switch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">identifier</span><span class="s3">: </span><span class="s5">&quot;int|str|Connection&quot;</span><span class="s3">) </span><span class="s1">-&gt; Connection</span><span class="s3">:</span>
        <span class="s4">&quot;&quot;&quot;Switches to the connection specified using the ``identifier``. 
 
        Identifier can be an index, an alias, or a registered connection. 
        Raises an error if no matching connection is found. 
 
        Updates :attr:`current` and also returns its new value. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">current </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_connection</span><span class="s3">(</span><span class="s1">identifier</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current</span>

    <span class="s2">def </span><span class="s1">get_connection</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">identifier</span><span class="s3">: </span><span class="s5">&quot;int|str|Connection|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Connection</span><span class="s3">:</span>
        <span class="s4">&quot;&quot;&quot;Returns the connection specified using the ``identifier``. 
 
        Identifier can be an index (integer or string), an alias, a registered 
        connection or ``None``. If the identifier is ``None``, returns the 
        current connection if it is active and raises an error if it is not. 
        Raises an error also if no matching connection is found. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">identifier </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">current</span><span class="s3">.</span><span class="s1">raise_error</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">index </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_connection_index</span><span class="s3">(</span><span class="s1">identifier</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s1">err</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">[</span><span class="s1">index </span><span class="s3">- </span><span class="s6">1</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">get_connection_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">identifier</span><span class="s3">: </span><span class="s5">&quot;int|str|Connection&quot;</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s4">&quot;&quot;&quot;Returns the index of the connection specified using the ``identifier``. 
 
        Identifier can be an index (integer or string), an alias, or a registered 
        connection. 
 
        New in Robot Framework 7.0. :meth:`resolve_alias_or_index` can be used 
        with earlier versions. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">identifier</span><span class="s3">, </span><span class="s1">str</span><span class="s3">) </span><span class="s2">and </span><span class="s1">identifier </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_aliases</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_aliases</span><span class="s3">[</span><span class="s1">identifier</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">identifier </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s1">identifier</span><span class="s3">) + </span><span class="s6">1</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">index </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">identifier</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">index </span><span class="s3">= -</span><span class="s6">1</span>
        <span class="s2">if </span><span class="s6">0 </span><span class="s3">&lt; </span><span class="s1">index </span><span class="s3">&lt;= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">index</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">f&quot;Non-existing index or alias '</span><span class="s2">{</span><span class="s1">identifier</span><span class="s2">}</span><span class="s5">'.&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">resolve_alias_or_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">alias_or_index</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Deprecated in RF 7.0. Use :meth:`get_connection_index` instead.&quot;&quot;&quot;</span>
        <span class="s0"># This was initially added for SeleniumLibrary in RF 3.1.2.</span>
        <span class="s0"># https://github.com/robotframework/robotframework/issues/3125</span>
        <span class="s0"># The new method was added in RF 7.0. We can loudly deprecate this</span>
        <span class="s0"># earliest in RF 8.0.</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_connection_index</span><span class="s3">(</span><span class="s1">alias_or_index</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">close_all</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">closer_method</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s5">&quot;close&quot;</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Closes connections using the specified closer method and empties cache. 
 
        If simply calling the closer method is not adequate for closing 
        connections, clients should close connections themselves and use 
        :meth:`empty_cache` afterward. 
        &quot;&quot;&quot;</span>
        <span class="s2">for </span><span class="s1">conn </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">:</span>
            <span class="s1">getattr</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">closer_method</span><span class="s3">)()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">empty_cache</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current</span>

    <span class="s2">def </span><span class="s1">empty_cache</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Empties the connection cache. 
 
        Indexes of the new connections starts from 1 after this. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">current </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_no_current</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_connections </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_aliases </span><span class="s3">= </span><span class="s1">NormalizedDict</span><span class="s3">()</span>

    <span class="s1">__getitem__ </span><span class="s3">= </span><span class="s1">get_connection</span>

    <span class="s2">def </span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">iter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__len__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__bool__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current </span><span class="s2">is not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_no_current</span>


<span class="s2">class </span><span class="s1">NoConnection</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">message</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">message </span><span class="s3">= </span><span class="s1">message</span>

    <span class="s2">def </span><span class="s1">__getattr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">name</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;__&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">name</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s5">&quot;__&quot;</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">AttributeError</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">raise_error</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">raise_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">message</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__bool__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return False</span>
</pre>
</body>
</html>