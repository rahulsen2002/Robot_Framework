<html>
<head>
<title>test_sysconfig.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_sysconfig.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Tests for distutils.sysconfig.&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">contextlib</span>
<span class="s2">import </span><span class="s1">distutils</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">pathlib</span>
<span class="s2">import </span><span class="s1">subprocess</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">from </span><span class="s1">distutils </span><span class="s2">import </span><span class="s1">sysconfig</span>
<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">ccompiler </span><span class="s2">import </span><span class="s1">new_compiler  </span><span class="s4"># noqa: F401</span>
<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">unixccompiler </span><span class="s2">import </span><span class="s1">UnixCCompiler</span>

<span class="s2">import </span><span class="s1">jaraco</span><span class="s3">.</span><span class="s1">envs</span>
<span class="s2">import </span><span class="s1">path</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">jaraco</span><span class="s3">.</span><span class="s1">text </span><span class="s2">import </span><span class="s1">trim</span>
<span class="s2">from </span><span class="s1">test</span><span class="s3">.</span><span class="s1">support </span><span class="s2">import </span><span class="s1">swap_item</span>


<span class="s2">def </span><span class="s1">_gen_makefile</span><span class="s3">(</span><span class="s1">root</span><span class="s3">, </span><span class="s1">contents</span><span class="s3">):</span>
    <span class="s1">jaraco</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">build</span><span class="s3">({</span><span class="s5">'Makefile'</span><span class="s3">: </span><span class="s1">trim</span><span class="s3">(</span><span class="s1">contents</span><span class="s3">)}, </span><span class="s1">root</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">root </span><span class="s3">/ </span><span class="s5">'Makefile'</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s5">'save_env'</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestSysconfig</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_get_config_h_filename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">config_h </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_h_filename</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">config_h</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">&quot;platform.system() == 'Windows'&quot;</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">&quot;sys.implementation.name != 'cpython'&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_get_makefile_filename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">makefile </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_makefile_filename</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">makefile</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_get_python_lib</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_python_lib</span><span class="s3">() != </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_python_lib</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">=</span><span class="s1">tmp_path</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_get_config_vars</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cvars </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_vars</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">cvars</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">cvars</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">'sysconfig.IS_PYPY'</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">'sysconfig.python_build'</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s5">'platform.system() == &quot;Windows&quot;'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_srcdir_simple</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># See #15364.</span>
        <span class="s1">srcdir </span><span class="s3">= </span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'srcdir'</span><span class="s3">))</span>

        <span class="s2">assert </span><span class="s1">srcdir</span><span class="s3">.</span><span class="s1">absolute</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">srcdir</span><span class="s3">.</span><span class="s1">is_dir</span><span class="s3">()</span>

        <span class="s1">makefile </span><span class="s3">= </span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_makefile_filename</span><span class="s3">())</span>
        <span class="s2">assert </span><span class="s1">makefile</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">.</span><span class="s1">samefile</span><span class="s3">(</span><span class="s1">srcdir</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">'sysconfig.IS_PYPY'</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">'not sysconfig.python_build'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_srcdir_python_build</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># See #15364.</span>
        <span class="s1">srcdir </span><span class="s3">= </span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'srcdir'</span><span class="s3">))</span>

        <span class="s4"># The python executable has not been installed so srcdir</span>
        <span class="s4"># should be a full source checkout.</span>
        <span class="s1">Python_h </span><span class="s3">= </span><span class="s1">srcdir</span><span class="s3">.</span><span class="s1">joinpath</span><span class="s3">(</span><span class="s5">'Include'</span><span class="s3">, </span><span class="s5">'Python.h'</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">Python_h</span><span class="s3">.</span><span class="s1">is_file</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">_is_python_source_dir</span><span class="s3">(</span><span class="s1">srcdir</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">_is_python_source_dir</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">srcdir</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_srcdir_independent_of_cwd</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        srcdir should be independent of the current working directory 
        &quot;&quot;&quot;</span>
        <span class="s4"># See #15364.</span>
        <span class="s1">srcdir </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'srcdir'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">path</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s5">'..'</span><span class="s3">):</span>
            <span class="s1">srcdir2 </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'srcdir'</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">srcdir </span><span class="s3">== </span><span class="s1">srcdir2</span>

    <span class="s2">def </span><span class="s1">customize_compiler</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># make sure AR gets caught</span>
        <span class="s2">class </span><span class="s1">compiler</span><span class="s3">:</span>
            <span class="s1">compiler_type </span><span class="s3">= </span><span class="s5">'unix'</span>
            <span class="s1">executables </span><span class="s3">= </span><span class="s1">UnixCCompiler</span><span class="s3">.</span><span class="s1">executables</span>

            <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">exes </span><span class="s3">= {}</span>

            <span class="s2">def </span><span class="s1">set_executables</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
                <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">v</span>

        <span class="s1">sysconfig_vars </span><span class="s3">= {</span>
            <span class="s5">'AR'</span><span class="s3">: </span><span class="s5">'sc_ar'</span><span class="s3">,</span>
            <span class="s5">'CC'</span><span class="s3">: </span><span class="s5">'sc_cc'</span><span class="s3">,</span>
            <span class="s5">'CXX'</span><span class="s3">: </span><span class="s5">'sc_cxx'</span><span class="s3">,</span>
            <span class="s5">'ARFLAGS'</span><span class="s3">: </span><span class="s5">'--sc-arflags'</span><span class="s3">,</span>
            <span class="s5">'CFLAGS'</span><span class="s3">: </span><span class="s5">'--sc-cflags'</span><span class="s3">,</span>
            <span class="s5">'CCSHARED'</span><span class="s3">: </span><span class="s5">'--sc-ccshared'</span><span class="s3">,</span>
            <span class="s5">'LDSHARED'</span><span class="s3">: </span><span class="s5">'sc_ldshared'</span><span class="s3">,</span>
            <span class="s5">'SHLIB_SUFFIX'</span><span class="s3">: </span><span class="s5">'sc_shutil_suffix'</span><span class="s3">,</span>
        <span class="s3">}</span>

        <span class="s1">comp </span><span class="s3">= </span><span class="s1">compiler</span><span class="s3">()</span>
        <span class="s2">with </span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">ExitStack</span><span class="s3">() </span><span class="s2">as </span><span class="s1">cm</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">sysconfig_vars</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s1">cm</span><span class="s3">.</span><span class="s1">enter_context</span><span class="s3">(</span><span class="s1">swap_item</span><span class="s3">(</span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">_config_vars</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">))</span>
            <span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">customize_compiler</span><span class="s3">(</span><span class="s1">comp</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">comp</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">&quot;not isinstance(new_compiler(), UnixCCompiler)&quot;</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s5">'disable_macos_customization'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_customize_compiler</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Make sure that sysconfig._config_vars is initialized</span>
        <span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_vars</span><span class="s3">()</span>

        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'AR'</span><span class="s3">] = </span><span class="s5">'env_ar'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CC'</span><span class="s3">] = </span><span class="s5">'env_cc'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CPP'</span><span class="s3">] = </span><span class="s5">'env_cpp'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CXX'</span><span class="s3">] = </span><span class="s5">'env_cxx --env-cxx-flags'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'LDSHARED'</span><span class="s3">] = </span><span class="s5">'env_ldshared'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'LDFLAGS'</span><span class="s3">] = </span><span class="s5">'--env-ldflags'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'ARFLAGS'</span><span class="s3">] = </span><span class="s5">'--env-arflags'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CFLAGS'</span><span class="s3">] = </span><span class="s5">'--env-cflags'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CPPFLAGS'</span><span class="s3">] = </span><span class="s5">'--env-cppflags'</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'RANLIB'</span><span class="s3">] = </span><span class="s5">'env_ranlib'</span>

        <span class="s1">comp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">customize_compiler</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'archiver'</span><span class="s3">] == </span><span class="s5">'env_ar --env-arflags'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'preprocessor'</span><span class="s3">] == </span><span class="s5">'env_cpp --env-cppflags'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'compiler'</span><span class="s3">] == </span><span class="s5">'env_cc --env-cflags --env-cppflags'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'compiler_so'</span><span class="s3">] == (</span>
            <span class="s5">'env_cc --env-cflags --env-cppflags --sc-ccshared'</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'compiler_cxx'</span><span class="s3">]</span>
            <span class="s3">== </span><span class="s5">'env_cxx --env-cxx-flags --sc-cflags --env-cppflags'</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'linker_exe'</span><span class="s3">] == </span><span class="s5">'env_cc'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'linker_so'</span><span class="s3">] == (</span>
            <span class="s5">'env_ldshared --env-ldflags --env-cflags --env-cppflags'</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">shared_lib_extension </span><span class="s3">== </span><span class="s5">'sc_shutil_suffix'</span>

        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s5">&quot;darwin&quot;</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'ranlib'</span><span class="s3">] == </span><span class="s5">'env_ranlib'</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s5">'ranlib' </span><span class="s2">not in </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span>

        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'AR'</span><span class="s3">]</span>
        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CC'</span><span class="s3">]</span>
        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CPP'</span><span class="s3">]</span>
        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CXX'</span><span class="s3">]</span>
        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'LDSHARED'</span><span class="s3">]</span>
        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'LDFLAGS'</span><span class="s3">]</span>
        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'ARFLAGS'</span><span class="s3">]</span>
        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CFLAGS'</span><span class="s3">]</span>
        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'CPPFLAGS'</span><span class="s3">]</span>
        <span class="s2">del </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">'RANLIB'</span><span class="s3">]</span>

        <span class="s1">comp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">customize_compiler</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'archiver'</span><span class="s3">] == </span><span class="s5">'sc_ar --sc-arflags'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'preprocessor'</span><span class="s3">] == </span><span class="s5">'sc_cc -E'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'compiler'</span><span class="s3">] == </span><span class="s5">'sc_cc --sc-cflags'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'compiler_so'</span><span class="s3">] == </span><span class="s5">'sc_cc --sc-cflags --sc-ccshared'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'compiler_cxx'</span><span class="s3">] == </span><span class="s5">'sc_cxx --sc-cflags'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'linker_exe'</span><span class="s3">] == </span><span class="s5">'sc_cc'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span><span class="s3">[</span><span class="s5">'linker_so'</span><span class="s3">] == </span><span class="s5">'sc_ldshared'</span>
        <span class="s2">assert </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">shared_lib_extension </span><span class="s3">== </span><span class="s5">'sc_shutil_suffix'</span>
        <span class="s2">assert </span><span class="s5">'ranlib' </span><span class="s2">not in </span><span class="s1">comp</span><span class="s3">.</span><span class="s1">exes</span>

    <span class="s2">def </span><span class="s1">test_parse_makefile_base</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">):</span>
        <span class="s1">makefile </span><span class="s3">= </span><span class="s1">_gen_makefile</span><span class="s3">(</span>
            <span class="s1">tmp_path</span><span class="s3">,</span>
            <span class="s5">&quot;&quot;&quot; 
            CONFIG_ARGS=  '--arg1=optarg1' 'ENV=LIB' 
            VAR=$OTHER 
            OTHER=foo 
            &quot;&quot;&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">parse_makefile</span><span class="s3">(</span><span class="s1">makefile</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">d </span><span class="s3">== {</span><span class="s5">'CONFIG_ARGS'</span><span class="s3">: </span><span class="s5">&quot;'--arg1=optarg1' 'ENV=LIB'&quot;</span><span class="s3">, </span><span class="s5">'OTHER'</span><span class="s3">: </span><span class="s5">'foo'</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">test_parse_makefile_literal_dollar</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">):</span>
        <span class="s1">makefile </span><span class="s3">= </span><span class="s1">_gen_makefile</span><span class="s3">(</span>
            <span class="s1">tmp_path</span><span class="s3">,</span>
            <span class="s5">&quot;&quot;&quot; 
            CONFIG_ARGS=  '--arg1=optarg1' 'ENV=</span><span class="s2">\\</span><span class="s5">$$LIB' 
            VAR=$OTHER 
            OTHER=foo 
            &quot;&quot;&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">parse_makefile</span><span class="s3">(</span><span class="s1">makefile</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">d </span><span class="s3">== {</span><span class="s5">'CONFIG_ARGS'</span><span class="s3">: </span><span class="s5">r&quot;'--arg1=optarg1' 'ENV=\$LIB'&quot;</span><span class="s3">, </span><span class="s5">'OTHER'</span><span class="s3">: </span><span class="s5">'foo'</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">test_sysconfig_module</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">import </span><span class="s1">sysconfig </span><span class="s2">as </span><span class="s1">global_sysconfig</span>

        <span class="s2">assert </span><span class="s1">global_sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'CFLAGS'</span><span class="s3">) == </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span>
            <span class="s5">'CFLAGS'</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">global_sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'LDFLAGS'</span><span class="s3">) == </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span>
            <span class="s5">'LDFLAGS'</span>
        <span class="s3">)</span>

    <span class="s4"># On macOS, binary installers support extension module building on</span>
    <span class="s4"># various levels of the operating system with differing Xcode</span>
    <span class="s4"># configurations, requiring customization of some of the</span>
    <span class="s4"># compiler configuration directives to suit the environment on</span>
    <span class="s4"># the installed machine. Some of these customizations may require</span>
    <span class="s4"># running external programs and are thus deferred until needed by</span>
    <span class="s4"># the first extension module build. Only</span>
    <span class="s4"># the Distutils version of sysconfig is used for extension module</span>
    <span class="s4"># builds, which happens earlier in the Distutils tests. This may</span>
    <span class="s4"># cause the following tests to fail since no tests have caused</span>
    <span class="s4"># the global version of sysconfig to call the customization yet.</span>
    <span class="s4"># The solution for now is to simply skip this test in this case.</span>
    <span class="s4"># The longer-term solution is to only have one version of sysconfig.</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">&quot;sysconfig.get_config_var('CUSTOMIZED_OSX_COMPILER')&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_sysconfig_compiler_vars</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">import </span><span class="s1">sysconfig </span><span class="s2">as </span><span class="s1">global_sysconfig</span>

        <span class="s2">if </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'CUSTOMIZED_OSX_COMPILER'</span><span class="s3">):</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s5">'compiler flags customized'</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">global_sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'LDSHARED'</span><span class="s3">) == </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span>
            <span class="s5">'LDSHARED'</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">global_sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'CC'</span><span class="s3">) == </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'CC'</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">&quot;not sysconfig.get_config_var('EXT_SUFFIX')&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_SO_deprecation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">DeprecationWarning</span><span class="s3">):</span>
            <span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">'SO'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_customize_compiler_before_get_config_vars</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">):</span>
        <span class="s4"># Issue #21923: test that a Distribution compiler</span>
        <span class="s4"># instance can be called without an explicit call to</span>
        <span class="s4"># get_config_vars().</span>
        <span class="s1">jaraco</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">build</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s5">'file'</span><span class="s3">: </span><span class="s1">trim</span><span class="s3">(</span><span class="s5">&quot;&quot;&quot; 
                    from distutils.core import Distribution 
                    config = Distribution().get_command_obj('config') 
                    # try_compile may pass or it may fail if no compiler 
                    # is found but it should not raise an exception. 
                    rc = config.try_compile('int x;') 
                    &quot;&quot;&quot;</span><span class="s3">)</span>
            <span class="s3">},</span>
            <span class="s1">tmp_path</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">Popen</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">executable</span><span class="s3">, </span><span class="s1">tmp_path </span><span class="s3">/ </span><span class="s5">'file'</span><span class="s3">],</span>
            <span class="s1">stdout</span><span class="s3">=</span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">PIPE</span><span class="s3">,</span>
            <span class="s1">stderr</span><span class="s3">=</span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">STDOUT</span><span class="s3">,</span>
            <span class="s1">universal_newlines</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s1">encoding</span><span class="s3">=</span><span class="s5">'utf-8'</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">outs</span><span class="s3">, </span><span class="s1">errs </span><span class="s3">= </span><span class="s1">p</span><span class="s3">.</span><span class="s1">communicate</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s6">0 </span><span class="s3">== </span><span class="s1">p</span><span class="s3">.</span><span class="s1">returncode</span><span class="s3">, </span><span class="s5">&quot;Subprocess failed: &quot; </span><span class="s3">+ </span><span class="s1">outs</span>

    <span class="s2">def </span><span class="s1">test_parse_config_h</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">config_h </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_h_filename</span><span class="s3">()</span>
        <span class="s1">input </span><span class="s3">= {}</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">config_h</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">parse_config_h</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">g</span><span class="s3">=</span><span class="s1">input</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">input </span><span class="s2">is </span><span class="s1">result</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">config_h</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">parse_config_h</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">&quot;platform.system() != 'Windows'&quot;</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">&quot;sys.implementation.name != 'cpython'&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_win_ext_suffix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">&quot;EXT_SUFFIX&quot;</span><span class="s3">).</span><span class="s1">endswith</span><span class="s3">(</span><span class="s5">&quot;.pyd&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s5">&quot;EXT_SUFFIX&quot;</span><span class="s3">) != </span><span class="s5">&quot;.pyd&quot;</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">&quot;platform.system() != 'Windows'&quot;</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s5">&quot;sys.implementation.name != 'cpython'&quot;</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span>
        <span class="s5">'</span><span class="s2">\\</span><span class="s5">PCbuild</span><span class="s2">\\</span><span class="s5">'</span><span class="s3">.</span><span class="s1">casefold</span><span class="s3">() </span><span class="s2">not in </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">executable</span><span class="s3">.</span><span class="s1">casefold</span><span class="s3">(),</span>
        <span class="s1">reason</span><span class="s3">=</span><span class="s5">'Need sys.executable to be in a source tree'</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_win_build_venv_from_source_tree</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Ensure distutils.sysconfig detects venvs from source tree builds.&quot;&quot;&quot;</span>
        <span class="s1">env </span><span class="s3">= </span><span class="s1">jaraco</span><span class="s3">.</span><span class="s1">envs</span><span class="s3">.</span><span class="s1">VEnv</span><span class="s3">()</span>
        <span class="s1">env</span><span class="s3">.</span><span class="s1">create_opts </span><span class="s3">= </span><span class="s1">env</span><span class="s3">.</span><span class="s1">clean_opts</span>
        <span class="s1">env</span><span class="s3">.</span><span class="s1">root </span><span class="s3">= </span><span class="s1">tmp_path</span>
        <span class="s1">env</span><span class="s3">.</span><span class="s1">ensure_env</span><span class="s3">()</span>
        <span class="s1">cmd </span><span class="s3">= [</span>
            <span class="s1">env</span><span class="s3">.</span><span class="s1">exe</span><span class="s3">(),</span>
            <span class="s5">&quot;-c&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;import distutils.sysconfig; print(distutils.sysconfig.python_build)&quot;</span><span class="s3">,</span>
        <span class="s3">]</span>
        <span class="s1">distutils_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">__file__</span><span class="s3">))</span>
        <span class="s1">out </span><span class="s3">= </span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">check_output</span><span class="s3">(</span>
            <span class="s1">cmd</span><span class="s3">, </span><span class="s1">env</span><span class="s3">={**</span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">, </span><span class="s5">&quot;PYTHONPATH&quot;</span><span class="s3">: </span><span class="s1">distutils_path</span><span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">out </span><span class="s3">== </span><span class="s5">&quot;True&quot;</span>

    <span class="s2">def </span><span class="s1">test_get_python_inc_missing_config_dir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">monkeypatch</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        In portable Python installations, the sysconfig will be broken, 
        pointing to the directories where the installation was built and 
        not where it currently is. In this case, ensure that the missing 
        directory isn't used for get_python_inc. 
 
        See pypa/distutils#178. 
        &quot;&quot;&quot;</span>

        <span class="s2">def </span><span class="s1">override</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">name </span><span class="s3">== </span><span class="s5">'INCLUDEPY'</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s5">'/does-not-exist'</span>
            <span class="s2">return </span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

        <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">sysconfig</span><span class="s3">, </span><span class="s5">'get_config_var'</span><span class="s3">, </span><span class="s1">override</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">sysconfig</span><span class="s3">.</span><span class="s1">get_python_inc</span><span class="s3">())</span>
</pre>
</body>
</html>