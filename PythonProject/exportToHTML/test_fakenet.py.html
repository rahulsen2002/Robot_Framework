<html>
<head>
<title>test_fakenet.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_fakenet.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">errno</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">socket</span>
<span class="s0">import </span><span class="s1">sys</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">trio</span>
<span class="s0">from </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">_fake_net </span><span class="s0">import </span><span class="s1">FakeNet</span>

<span class="s3"># ENOTCONN gives different messages on different platforms</span>
<span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;linux&quot;</span><span class="s2">:</span>
    <span class="s1">ENOTCONN_MSG </span><span class="s2">= </span><span class="s4">r&quot;^\[Errno 107\] (Transport endpoint is|Socket) not connected$&quot;</span>
<span class="s0">elif </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;darwin&quot;</span><span class="s2">:</span>
    <span class="s1">ENOTCONN_MSG </span><span class="s2">= </span><span class="s4">r&quot;^\[Errno 57\] Socket is not connected$&quot;</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s1">ENOTCONN_MSG </span><span class="s2">= </span><span class="s4">r&quot;^\[Errno 10057\] Unknown error$&quot;</span>


<span class="s0">def </span><span class="s1">fn</span><span class="s2">() </span><span class="s1">-&gt; FakeNet</span><span class="s2">:</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">FakeNet</span><span class="s2">()</span>
    <span class="s1">fn</span><span class="s2">.</span><span class="s1">enable</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">fn</span>


<span class="s0">async def </span><span class="s1">test_basic_udp</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">fn</span><span class="s2">()</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s1">s2 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>

    <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">ip</span><span class="s2">, </span><span class="s1">port </span><span class="s2">= </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ip </span><span class="s2">== </span><span class="s4">&quot;127.0.0.1&quot;</span>
    <span class="s0">assert </span><span class="s1">port </span><span class="s2">!= </span><span class="s5">0</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">OSError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^\[\w+ \d+\] Invalid argument$&quot;</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:  </span><span class="s3"># Cannot rebind.</span>
        <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;192.0.2.1&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">errno </span><span class="s2">== </span><span class="s1">errno</span><span class="s2">.</span><span class="s1">EINVAL</span>

    <span class="s3"># Cannot bind multiple sockets to the same address</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">OSError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^\[\w+ \d+\] (Address (already )?in use|Unknown error)$&quot;</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s1">port</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">errno </span><span class="s2">== </span><span class="s1">errno</span><span class="s2">.</span><span class="s1">EADDRINUSE</span>

    <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;xyz&quot;</span><span class="s2">, </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
    <span class="s1">data</span><span class="s2">, </span><span class="s1">addr </span><span class="s2">= </span><span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">recvfrom</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">data </span><span class="s2">== </span><span class="s6">b&quot;xyz&quot;</span>
    <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>
    <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;abc&quot;</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
    <span class="s1">data</span><span class="s2">, </span><span class="s1">addr </span><span class="s2">= </span><span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">recvfrom</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">data </span><span class="s2">== </span><span class="s6">b&quot;abc&quot;</span>
    <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_msg_trunc</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">fn</span><span class="s2">()</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s1">s2 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
    <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;xyz&quot;</span><span class="s2">, </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
    <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">recvfrom</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_recv_methods</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s7">&quot;&quot;&quot;Test all recv methods for codecov&quot;&quot;&quot;</span>
    <span class="s1">fn</span><span class="s2">()</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s1">s2 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>

    <span class="s3"># receiving on an unbound socket is a bad idea (I think?)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;code will most likely hang&quot;</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>

    <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">ip</span><span class="s2">, </span><span class="s1">port </span><span class="s2">= </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ip </span><span class="s2">== </span><span class="s4">&quot;127.0.0.1&quot;</span>
    <span class="s0">assert </span><span class="s1">port </span><span class="s2">!= </span><span class="s5">0</span>

    <span class="s3"># recvfrom</span>
    <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;abc&quot;</span><span class="s2">, </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
    <span class="s1">data</span><span class="s2">, </span><span class="s1">addr </span><span class="s2">= </span><span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">recvfrom</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">data </span><span class="s2">== </span><span class="s6">b&quot;abc&quot;</span>
    <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

    <span class="s3"># recv</span>
    <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;def&quot;</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">data </span><span class="s2">== </span><span class="s6">b&quot;def&quot;</span>

    <span class="s3"># recvfrom_into</span>
    <span class="s0">assert await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;ghi&quot;</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()) == </span><span class="s5">3</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^partial recvfrom_into$&quot;</span><span class="s2">):</span>
        <span class="s2">(</span><span class="s1">nbytes</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">recvfrom_into</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">nbytes</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s2">(</span><span class="s1">nbytes</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">recvfrom_into</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">nbytes </span><span class="s2">== </span><span class="s5">3</span>
    <span class="s0">assert </span><span class="s1">buf </span><span class="s2">== </span><span class="s6">b&quot;ghi&quot; </span><span class="s2">+ </span><span class="s6">b&quot;</span><span class="s0">\x00</span><span class="s6">&quot; </span><span class="s2">* </span><span class="s5">7</span>
    <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

    <span class="s3"># recv_into</span>
    <span class="s0">assert await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;jkl&quot;</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()) == </span><span class="s5">3</span>
    <span class="s1">buf2 </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">nbytes </span><span class="s2">= </span><span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">recv_into</span><span class="s2">(</span><span class="s1">buf2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">nbytes </span><span class="s2">== </span><span class="s5">3</span>
    <span class="s0">assert </span><span class="s1">buf2 </span><span class="s2">== </span><span class="s6">b&quot;jkl&quot; </span><span class="s2">+ </span><span class="s6">b&quot;</span><span class="s0">\x00</span><span class="s6">&quot; </span><span class="s2">* </span><span class="s5">7</span>

    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;linux&quot; </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">implementation</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;cpython&quot;</span><span class="s2">:</span>
        <span class="s1">flags</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">MSG_MORE</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">flags </span><span class="s2">= </span><span class="s5">1</span>

    <span class="s3"># Send seems explicitly non-functional</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">OSError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">ENOTCONN_MSG</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;mno&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">errno </span><span class="s2">== </span><span class="s1">errno</span><span class="s2">.</span><span class="s1">ENOTCONN</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^FakeNet send flags must be 0, not&quot;</span>
    <span class="s2">):</span>
        <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;mno&quot;</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">)</span>

    <span class="s3"># sendto errors</span>
    <span class="s3"># it's successfully used earlier</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^FakeNet send flags must be 0, not&quot;</span>
    <span class="s2">):</span>
        <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;mno&quot;</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;wrong number of arguments$&quot;</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;mno&quot;</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">(), </span><span class="s4">&quot;extra arg&quot;</span><span class="s2">)  </span><span class="s3"># type: ignore[call-overload]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;win32&quot;</span><span class="s2">,</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;functions not in socket on windows&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">async def </span><span class="s1">test_nonwindows_functionality</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s3"># mypy doesn't support a good way of aborting typechecking on different platforms</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s4">&quot;win32&quot;</span><span class="s2">:  </span><span class="s3"># pragma: no branch</span>
        <span class="s1">fn</span><span class="s2">()</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>

        <span class="s3"># sendmsg</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">OSError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">ENOTCONN_MSG</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">sendmsg</span><span class="s2">([</span><span class="s6">b&quot;mno&quot;</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">errno </span><span class="s2">== </span><span class="s1">errno</span><span class="s2">.</span><span class="s1">ENOTCONN</span>

        <span class="s0">assert await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">sendmsg</span><span class="s2">([</span><span class="s6">b&quot;jkl&quot;</span><span class="s2">], (), </span><span class="s5">0</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()) == </span><span class="s5">3</span>
        <span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">ancdata</span><span class="s2">, </span><span class="s1">msg_flags</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">recvmsg</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">data </span><span class="s2">== </span><span class="s6">b&quot;jkl&quot;</span>
        <span class="s0">assert </span><span class="s1">ancdata </span><span class="s2">== []</span>
        <span class="s0">assert </span><span class="s1">msg_flags </span><span class="s2">== </span><span class="s5">0</span>
        <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

        <span class="s3"># TODO: recvmsg</span>

        <span class="s3"># recvmsg_into</span>
        <span class="s0">assert await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;xyzw&quot;</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()) == </span><span class="s5">4</span>
        <span class="s1">buf1 </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">buf2 </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">recvmsg_into</span><span class="s2">([</span><span class="s1">buf1</span><span class="s2">, </span><span class="s1">buf2</span><span class="s2">])</span>
        <span class="s2">(</span><span class="s1">nbytes</span><span class="s2">, </span><span class="s1">ancdata</span><span class="s2">, </span><span class="s1">msg_flags</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s1">ret</span>
        <span class="s0">assert </span><span class="s1">nbytes </span><span class="s2">== </span><span class="s5">4</span>
        <span class="s0">assert </span><span class="s1">buf1 </span><span class="s2">== </span><span class="s6">b&quot;xy&quot;</span>
        <span class="s0">assert </span><span class="s1">buf2 </span><span class="s2">== </span><span class="s6">b&quot;zw&quot; </span><span class="s2">+ </span><span class="s6">b&quot;</span><span class="s0">\x00</span><span class="s6">&quot;</span>
        <span class="s0">assert </span><span class="s1">ancdata </span><span class="s2">== []</span>
        <span class="s0">assert </span><span class="s1">msg_flags </span><span class="s2">== </span><span class="s5">0</span>
        <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

        <span class="s3"># recvmsg_into with MSG_TRUNC set</span>
        <span class="s0">assert await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;xyzwv&quot;</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()) == </span><span class="s5">5</span>
        <span class="s1">buf1 </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">recvmsg_into</span><span class="s2">([</span><span class="s1">buf1</span><span class="s2">])</span>
        <span class="s2">(</span><span class="s1">nbytes</span><span class="s2">, </span><span class="s1">ancdata</span><span class="s2">, </span><span class="s1">msg_flags</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s1">ret</span>
        <span class="s0">assert </span><span class="s1">nbytes </span><span class="s2">== </span><span class="s5">2</span>
        <span class="s0">assert </span><span class="s1">buf1 </span><span class="s2">== </span><span class="s6">b&quot;xy&quot;</span>
        <span class="s0">assert </span><span class="s1">ancdata </span><span class="s2">== []</span>
        <span class="s0">assert </span><span class="s1">msg_flags </span><span class="s2">== </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">MSG_TRUNC</span>
        <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">AttributeError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^'FakeSocket' object has no attribute 'share'$&quot;</span><span class="s2">,</span>
        <span class="s2">):</span>
            <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">share</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)  </span><span class="s3"># type: ignore[attr-defined]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s4">&quot;win32&quot;</span><span class="s2">,</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;windows-specific fakesocket testing&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">async def </span><span class="s1">test_windows_functionality</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s3"># mypy doesn't support a good way of aborting typechecking on different platforms</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;win32&quot;</span><span class="s2">:  </span><span class="s3"># pragma: no branch</span>
        <span class="s1">fn</span><span class="s2">()</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">AttributeError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^'FakeSocket' object has no attribute 'sendmsg'$&quot;</span><span class="s2">,</span>
        <span class="s2">):</span>
            <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">sendmsg</span><span class="s2">([</span><span class="s6">b&quot;jkl&quot;</span><span class="s2">], (), </span><span class="s5">0</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())  </span><span class="s3"># type: ignore[attr-defined]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">AttributeError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^'FakeSocket' object has no attribute 'recvmsg'$&quot;</span><span class="s2">,</span>
        <span class="s2">):</span>
            <span class="s1">s2</span><span class="s2">.</span><span class="s1">recvmsg</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)  </span><span class="s3"># type: ignore[attr-defined]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">AttributeError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^'FakeSocket' object has no attribute 'recvmsg_into'$&quot;</span><span class="s2">,</span>
        <span class="s2">):</span>
            <span class="s1">s2</span><span class="s2">.</span><span class="s1">recvmsg_into</span><span class="s2">([])  </span><span class="s3"># type: ignore[attr-defined]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">):</span>
            <span class="s1">s1</span><span class="s2">.</span><span class="s1">share</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_basic_tcp</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">fn</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">):</span>
        <span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_not_implemented_functions</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">fn</span><span class="s2">()</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>

    <span class="s3"># getsockopt</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">OSError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^FakeNet doesn't implement getsockopt\(\d, \d\)$&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockopt</span><span class="s2">(</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">IPPROTO_TCP</span><span class="s2">, </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">TCP_NODELAY</span><span class="s2">)</span>

    <span class="s3"># setsockopt</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">NotImplementedError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^FakeNet always has IPV6_V6ONLY=True$&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">s1</span><span class="s2">.</span><span class="s1">setsockopt</span><span class="s2">(</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">IPPROTO_IPV6</span><span class="s2">, </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">IPV6_V6ONLY</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">OSError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^FakeNet doesn't implement setsockopt\(\d+, \d+, \.\.\.\)$&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">s1</span><span class="s2">.</span><span class="s1">setsockopt</span><span class="s2">(</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">IPPROTO_IPV6</span><span class="s2">, </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">IPV6_V6ONLY</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">OSError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^FakeNet doesn't implement setsockopt\(\d+, \d+, \.\.\.\)$&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">s1</span><span class="s2">.</span><span class="s1">setsockopt</span><span class="s2">(</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOL_SOCKET</span><span class="s2">, </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SO_REUSEADDR</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s3"># set_inheritable</span>
    <span class="s1">s1</span><span class="s2">.</span><span class="s1">set_inheritable</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">NotImplementedError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^FakeNet can't make inheritable sockets$&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">s1</span><span class="s2">.</span><span class="s1">set_inheritable</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s3"># get_inheritable</span>
    <span class="s0">assert not </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">get_inheritable</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_getpeername</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">fn</span><span class="s2">()</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">OSError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">ENOTCONN_MSG</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
        <span class="s1">s1</span><span class="s2">.</span><span class="s1">getpeername</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">errno </span><span class="s2">== </span><span class="s1">errno</span><span class="s2">.</span><span class="s1">ENOTCONN</span>

    <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">AssertionError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;^This method seems to assume that self._binding has a remote UDPEndpoint$&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">s1</span><span class="s2">.</span><span class="s1">getpeername</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_init</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">fn</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">NotImplementedError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
            <span class="s4">f&quot;FakeNet doesn't (yet) support type=</span><span class="s0">{</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_STREAM</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">()</span>

    <span class="s3"># getsockname on unbound ipv4 socket</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">() == (</span><span class="s4">&quot;0.0.0.0&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s3"># getsockname on bound ipv4 socket</span>
    <span class="s0">await </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;0.0.0.0&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">ip</span><span class="s2">, </span><span class="s1">port </span><span class="s2">= </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ip </span><span class="s2">== </span><span class="s4">&quot;127.0.0.1&quot;</span>
    <span class="s0">assert </span><span class="s1">port </span><span class="s2">!= </span><span class="s5">0</span>

    <span class="s3"># getsockname on unbound ipv6 socket</span>
    <span class="s1">s2 </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">AF_INET6</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">() == (</span><span class="s4">&quot;::&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s3"># getsockname on bound ipv6 socket</span>
    <span class="s0">await </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;::&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">ip</span><span class="s2">, </span><span class="s1">port</span><span class="s2">, *</span><span class="s1">_ </span><span class="s2">= </span><span class="s1">s2</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ip </span><span class="s2">== </span><span class="s4">&quot;::1&quot;</span>
    <span class="s0">assert </span><span class="s1">port </span><span class="s2">!= </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s1">_ </span><span class="s2">== [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
</pre>
</body>
</html>