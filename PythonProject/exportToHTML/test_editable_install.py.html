<html>
<head>
<title>test_editable_install.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_editable_install.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">stat</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">copy </span><span class="s0">import </span><span class="s1">deepcopy</span>
<span class="s0">from </span><span class="s1">importlib </span><span class="s0">import </span><span class="s1">import_module</span>
<span class="s0">from </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">machinery </span><span class="s0">import </span><span class="s1">EXTENSION_SUFFIXES</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">textwrap </span><span class="s0">import </span><span class="s1">dedent</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Any</span>
<span class="s0">from </span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">mock </span><span class="s0">import </span><span class="s1">Mock</span>
<span class="s0">from </span><span class="s1">uuid </span><span class="s0">import </span><span class="s1">uuid4</span>

<span class="s0">import </span><span class="s1">jaraco</span><span class="s2">.</span><span class="s1">envs</span>
<span class="s0">import </span><span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">path </span><span class="s0">import </span><span class="s1">Path </span><span class="s0">as </span><span class="s1">_Path</span>

<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">_importlib </span><span class="s0">import </span><span class="s1">resources </span><span class="s0">as </span><span class="s1">importlib_resources</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">command</span><span class="s2">.</span><span class="s1">editable_wheel </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_DebuggingTips</span><span class="s2">,</span>
    <span class="s1">_encode_pth</span><span class="s2">,</span>
    <span class="s1">_find_namespaces</span><span class="s2">,</span>
    <span class="s1">_find_package_roots</span><span class="s2">,</span>
    <span class="s1">_find_virtual_namespaces</span><span class="s2">,</span>
    <span class="s1">_finder_template</span><span class="s2">,</span>
    <span class="s1">_LinkTree</span><span class="s2">,</span>
    <span class="s1">_TopLevelFinder</span><span class="s2">,</span>
    <span class="s1">editable_wheel</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">dist </span><span class="s0">import </span><span class="s1">Distribution</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">extension </span><span class="s0">import </span><span class="s1">Extension</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">warnings </span><span class="s0">import </span><span class="s1">SetuptoolsDeprecationWarning</span>

<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">contexts</span><span class="s2">, </span><span class="s1">namespaces</span>

<span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">run_setup</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s3">&quot;strict&quot;</span><span class="s2">, </span><span class="s3">&quot;lenient&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">editable_opts</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param </span><span class="s2">== </span><span class="s3">&quot;strict&quot;</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s3">&quot;--config-settings&quot;</span><span class="s2">, </span><span class="s3">&quot;editable-mode=strict&quot;</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s2">[]</span>


<span class="s1">EXAMPLE </span><span class="s2">= {</span>
    <span class="s3">'pyproject.toml'</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span>
        <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">[build-system] 
        requires = [&quot;setuptools&quot;] 
        build-backend = &quot;setuptools.build_meta&quot; 
 
        [project] 
        name = &quot;mypkg&quot; 
        version = &quot;3.14159&quot; 
        license = {text = &quot;MIT&quot;} 
        description = &quot;This is a Python package&quot; 
        dynamic = [&quot;readme&quot;] 
        classifiers = [ 
            &quot;Development Status :: 5 - Production/Stable&quot;, 
            &quot;Intended Audience :: Developers&quot; 
        ] 
        urls = {Homepage = &quot;https://github.com&quot;} 
 
        [tool.setuptools] 
        package-dir = {&quot;&quot; = &quot;src&quot;} 
        packages = {find = {where = [&quot;src&quot;]}} 
        license-files = [&quot;LICENSE*&quot;] 
 
        [tool.setuptools.dynamic] 
        readme = {file = &quot;README.rst&quot;} 
 
        [tool.distutils.egg_info] 
        tag-build = &quot;.post0&quot; 
        &quot;&quot;&quot;</span>
    <span class="s2">),</span>
    <span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span>
        <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">global-include *.py *.txt 
        global-exclude *.py[cod] 
        prune dist 
        prune build 
        &quot;&quot;&quot;</span>
    <span class="s2">).</span><span class="s1">strip</span><span class="s2">(),</span>
    <span class="s3">&quot;README.rst&quot;</span><span class="s2">: </span><span class="s3">&quot;This is a ``README``&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;LICENSE.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;---- placeholder MIT license ----&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;src&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;mypkg&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
                </span><span class="s3">import sys 
                from importlib.metadata import PackageNotFoundError, version 
 
                try: 
                    __version__ = version(__name__) 
                except PackageNotFoundError: 
                    __version__ = &quot;unknown&quot; 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;__main__.py&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
                </span><span class="s3">from importlib.resources import read_text 
                from . import __version__, __name__ as parent 
                from .mod import x 
 
                data = read_text(parent, &quot;data.txt&quot;) 
                print(__version__, data, x) 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;mod.py&quot;</span><span class="s2">: </span><span class="s3">&quot;x = ''&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;data.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;Hello World&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
    <span class="s2">},</span>
<span class="s2">}</span>


<span class="s1">SETUP_SCRIPT_STUB </span><span class="s2">= </span><span class="s3">&quot;__import__('setuptools').setup()&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">&quot;darwin&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;pypa/setuptools#4328&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;files&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">{**</span><span class="s1">EXAMPLE</span><span class="s2">, </span><span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">SETUP_SCRIPT_STUB</span><span class="s2">},</span>
        <span class="s1">EXAMPLE</span><span class="s2">,  </span><span class="s4"># No setup.py script</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_editable_with_pyproject</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">editable_opts</span><span class="s2">):</span>
    <span class="s1">project </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;mypkg&quot;</span>
    <span class="s1">project</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">()</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">project</span><span class="s2">)</span>

    <span class="s1">cmd </span><span class="s2">= [</span>
        <span class="s3">&quot;python&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;-m&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;pip&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;install&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;--no-build-isolation&quot;</span><span class="s2">,  </span><span class="s4"># required to force current version of setuptools</span>
        <span class="s3">&quot;-e&quot;</span><span class="s2">,</span>
        <span class="s1">str</span><span class="s2">(</span><span class="s1">project</span><span class="s2">),</span>
        <span class="s2">*</span><span class="s1">editable_opts</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">))</span>

    <span class="s1">cmd </span><span class="s2">= [</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;mypkg&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">() == </span><span class="s3">&quot;3.14159.post0 Hello World&quot;</span>

    <span class="s2">(</span><span class="s1">project </span><span class="s2">/ </span><span class="s3">&quot;src/mypkg/data.txt&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s3">&quot;foobar&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s2">(</span><span class="s1">project </span><span class="s2">/ </span><span class="s3">&quot;src/mypkg/mod.py&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s3">&quot;x = 42&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">() == </span><span class="s3">&quot;3.14159.post0 foobar 42&quot;</span>


<span class="s0">def </span><span class="s1">test_editable_with_flat_layout</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">editable_opts</span><span class="s2">):</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s3">&quot;mypkg&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
                </span><span class="s3">[build-system] 
                requires = [&quot;setuptools&quot;, &quot;wheel&quot;] 
                build-backend = &quot;setuptools.build_meta&quot; 
 
                [project] 
                name = &quot;mypkg&quot; 
                version = &quot;3.14159&quot; 
 
                [tool.setuptools] 
                packages = [&quot;pkg&quot;] 
                py-modules = [&quot;mod&quot;] 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;pkg&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 4&quot;</span><span class="s2">},</span>
            <span class="s3">&quot;mod.py&quot;</span><span class="s2">: </span><span class="s3">&quot;b = 2&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
    <span class="s2">}</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">project </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;mypkg&quot;</span>

    <span class="s1">cmd </span><span class="s2">= [</span>
        <span class="s3">&quot;python&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;-m&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;pip&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;install&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;--no-build-isolation&quot;</span><span class="s2">,  </span><span class="s4"># required to force current version of setuptools</span>
        <span class="s3">&quot;-e&quot;</span><span class="s2">,</span>
        <span class="s1">str</span><span class="s2">(</span><span class="s1">project</span><span class="s2">),</span>
        <span class="s2">*</span><span class="s1">editable_opts</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">))</span>
    <span class="s1">cmd </span><span class="s2">= [</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;import pkg, mod; print(pkg.a, mod.b)&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">() == </span><span class="s3">&quot;4 2&quot;</span>


<span class="s0">def </span><span class="s1">test_editable_with_single_module</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">editable_opts</span><span class="s2">):</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s3">&quot;mypkg&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
                </span><span class="s3">[build-system] 
                requires = [&quot;setuptools&quot;, &quot;wheel&quot;] 
                build-backend = &quot;setuptools.build_meta&quot; 
 
                [project] 
                name = &quot;mod&quot; 
                version = &quot;3.14159&quot; 
 
                [tool.setuptools] 
                py-modules = [&quot;mod&quot;] 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;mod.py&quot;</span><span class="s2">: </span><span class="s3">&quot;b = 2&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
    <span class="s2">}</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">project </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;mypkg&quot;</span>

    <span class="s1">cmd </span><span class="s2">= [</span>
        <span class="s3">&quot;python&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;-m&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;pip&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;install&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;--no-build-isolation&quot;</span><span class="s2">,  </span><span class="s4"># required to force current version of setuptools</span>
        <span class="s3">&quot;-e&quot;</span><span class="s2">,</span>
        <span class="s1">str</span><span class="s2">(</span><span class="s1">project</span><span class="s2">),</span>
        <span class="s2">*</span><span class="s1">editable_opts</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">))</span>
    <span class="s1">cmd </span><span class="s2">= [</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;import mod; print(mod.b)&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">() == </span><span class="s3">&quot;2&quot;</span>


<span class="s0">class </span><span class="s1">TestLegacyNamespaces</span><span class="s2">:</span>
    <span class="s4"># legacy =&gt; pkg_resources.declare_namespace(...) + setup(namespace_packages=...)</span>

    <span class="s0">def </span><span class="s1">test_nspkg_file_is_unique</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
        <span class="s1">deprecation </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span>
            <span class="s1">SetuptoolsDeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;.*namespace_packages parameter.*&quot;</span>
        <span class="s2">)</span>
        <span class="s1">installation_dir </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;.installation_dir&quot;</span>
        <span class="s1">installation_dir</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">()</span>
        <span class="s1">examples </span><span class="s2">= (</span>
            <span class="s3">&quot;myns.pkgA&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;myns.pkgB&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;myns.n.pkgA&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;myns.n.pkgB&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">examples</span><span class="s2">:</span>
            <span class="s1">pkg </span><span class="s2">= </span><span class="s1">namespaces</span><span class="s2">.</span><span class="s1">build_namespace_package</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s3">&quot;42&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">deprecation</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">context</span><span class="s2">() </span><span class="s0">as </span><span class="s1">ctx</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">)</span>
                <span class="s1">dist </span><span class="s2">= </span><span class="s1">run_setup</span><span class="s2">(</span><span class="s3">&quot;setup.py&quot;</span><span class="s2">, </span><span class="s1">stop_after</span><span class="s2">=</span><span class="s3">&quot;config&quot;</span><span class="s2">)</span>
                <span class="s1">cmd </span><span class="s2">= </span><span class="s1">editable_wheel</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
                <span class="s1">cmd</span><span class="s2">.</span><span class="s1">finalize_options</span><span class="s2">()</span>
                <span class="s1">editable_name </span><span class="s2">= </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">get_finalized_command</span><span class="s2">(</span><span class="s3">&quot;dist_info&quot;</span><span class="s2">).</span><span class="s1">name</span>
                <span class="s1">cmd</span><span class="s2">.</span><span class="s1">_install_namespaces</span><span class="s2">(</span><span class="s1">installation_dir</span><span class="s2">, </span><span class="s1">editable_name</span><span class="s2">)</span>

        <span class="s1">files </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">installation_dir</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;*-nspkg.pth&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">files</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">examples</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;impl&quot;</span><span class="s2">,</span>
        <span class="s2">(</span>
            <span class="s3">&quot;pkg_resources&quot;</span><span class="s2">,</span>
            <span class="s4">#  &quot;pkgutil&quot;,  =&gt; does not work</span>
        <span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;ns&quot;</span><span class="s2">, (</span><span class="s3">&quot;myns.n&quot;</span><span class="s2">,))</span>
    <span class="s0">def </span><span class="s1">test_namespace_package_importable</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">ns</span><span class="s2">, </span><span class="s1">impl</span><span class="s2">, </span><span class="s1">editable_opts</span>
    <span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Installing two packages sharing the same namespace, one installed 
        naturally using pip or `--single-version-externally-managed` 
        and the other installed in editable mode should leave the namespace 
        intact and both packages reachable by import. 
        (Ported from test_develop). 
        &quot;&quot;&quot;</span>
        <span class="s1">build_system </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">[build-system] 
        requires = [&quot;setuptools&quot;] 
        build-backend = &quot;setuptools.build_meta&quot; 
        &quot;&quot;&quot;</span>
        <span class="s1">pkg_A </span><span class="s2">= </span><span class="s1">namespaces</span><span class="s2">.</span><span class="s1">build_namespace_package</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">ns</span><span class="s0">}</span><span class="s3">.pkgA&quot;</span><span class="s2">, </span><span class="s1">impl</span><span class="s2">=</span><span class="s1">impl</span><span class="s2">)</span>
        <span class="s1">pkg_B </span><span class="s2">= </span><span class="s1">namespaces</span><span class="s2">.</span><span class="s1">build_namespace_package</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">ns</span><span class="s0">}</span><span class="s3">.pkgB&quot;</span><span class="s2">, </span><span class="s1">impl</span><span class="s2">=</span><span class="s1">impl</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">pkg_A </span><span class="s2">/ </span><span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">build_system</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">pkg_B </span><span class="s2">/ </span><span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">build_system</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s4"># use pip to install to the target directory</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">editable_opts</span><span class="s2">[:]</span>
        <span class="s1">opts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;--no-build-isolation&quot;</span><span class="s2">)  </span><span class="s4"># force current version of setuptools</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;pip&quot;</span><span class="s2">, </span><span class="s3">&quot;install&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">pkg_A</span><span class="s2">), *</span><span class="s1">opts</span><span class="s2">])</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;pip&quot;</span><span class="s2">, </span><span class="s3">&quot;install&quot;</span><span class="s2">, </span><span class="s3">&quot;-e&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">pkg_B</span><span class="s2">), *</span><span class="s1">opts</span><span class="s2">])</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">f&quot;import </span><span class="s0">{</span><span class="s1">ns</span><span class="s0">}</span><span class="s3">.pkgA; import </span><span class="s0">{</span><span class="s1">ns</span><span class="s0">}</span><span class="s3">.pkgB&quot;</span><span class="s2">])</span>
        <span class="s4"># additionally ensure that pkg_resources import works</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;import pkg_resources&quot;</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">TestPep420Namespaces</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_namespace_package_importable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">editable_opts</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Installing two packages sharing the same namespace, one installed 
        normally using pip and the other installed in editable mode 
        should allow importing both packages. 
        &quot;&quot;&quot;</span>
        <span class="s1">pkg_A </span><span class="s2">= </span><span class="s1">namespaces</span><span class="s2">.</span><span class="s1">build_pep420_namespace_package</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s3">'myns.n.pkgA'</span><span class="s2">)</span>
        <span class="s1">pkg_B </span><span class="s2">= </span><span class="s1">namespaces</span><span class="s2">.</span><span class="s1">build_pep420_namespace_package</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s3">'myns.n.pkgB'</span><span class="s2">)</span>
        <span class="s4"># use pip to install to the target directory</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">editable_opts</span><span class="s2">[:]</span>
        <span class="s1">opts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;--no-build-isolation&quot;</span><span class="s2">)  </span><span class="s4"># force current version of setuptools</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;pip&quot;</span><span class="s2">, </span><span class="s3">&quot;install&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">pkg_A</span><span class="s2">), *</span><span class="s1">opts</span><span class="s2">])</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;pip&quot;</span><span class="s2">, </span><span class="s3">&quot;install&quot;</span><span class="s2">, </span><span class="s3">&quot;-e&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">pkg_B</span><span class="s2">), *</span><span class="s1">opts</span><span class="s2">])</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;import myns.n.pkgA; import myns.n.pkgB&quot;</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_namespace_created_via_package_dir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">editable_opts</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Currently users can create a namespace by tweaking `package_dir`&quot;&quot;&quot;</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;pkgA&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span>
                    <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
                    </span><span class="s3">[build-system] 
                    requires = [&quot;setuptools&quot;, &quot;wheel&quot;] 
                    build-backend = &quot;setuptools.build_meta&quot; 
 
                    [project] 
                    name = &quot;pkgA&quot; 
                    version = &quot;3.14159&quot; 
 
                    [tool.setuptools] 
                    package-dir = {&quot;myns.n.pkgA&quot; = &quot;src&quot;} 
                    &quot;&quot;&quot;</span>
                <span class="s2">),</span>
                <span class="s3">&quot;src&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 1&quot;</span><span class="s2">},</span>
            <span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">pkg_A </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;pkgA&quot;</span>
        <span class="s1">pkg_B </span><span class="s2">= </span><span class="s1">namespaces</span><span class="s2">.</span><span class="s1">build_pep420_namespace_package</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s3">'myns.n.pkgB'</span><span class="s2">)</span>
        <span class="s1">pkg_C </span><span class="s2">= </span><span class="s1">namespaces</span><span class="s2">.</span><span class="s1">build_pep420_namespace_package</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s3">'myns.n.pkgC'</span><span class="s2">)</span>

        <span class="s4"># use pip to install to the target directory</span>
        <span class="s1">opts </span><span class="s2">= </span><span class="s1">editable_opts</span><span class="s2">[:]</span>
        <span class="s1">opts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;--no-build-isolation&quot;</span><span class="s2">)  </span><span class="s4"># force current version of setuptools</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;pip&quot;</span><span class="s2">, </span><span class="s3">&quot;install&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">pkg_A</span><span class="s2">), *</span><span class="s1">opts</span><span class="s2">])</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;pip&quot;</span><span class="s2">, </span><span class="s3">&quot;install&quot;</span><span class="s2">, </span><span class="s3">&quot;-e&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">pkg_B</span><span class="s2">), *</span><span class="s1">opts</span><span class="s2">])</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;pip&quot;</span><span class="s2">, </span><span class="s3">&quot;install&quot;</span><span class="s2">, </span><span class="s3">&quot;-e&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">pkg_C</span><span class="s2">), *</span><span class="s1">opts</span><span class="s2">])</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;from myns.n import pkgA, pkgB, pkgC&quot;</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_namespace_accidental_config_in_lenient_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Sometimes users might specify an ``include`` pattern that ignores parent 
        packages. In a normal installation this would ignore all modules inside the 
        parent packages, and make them namespaces (reported in issue #3504), 
        so the editable mode should preserve this behaviour. 
        &quot;&quot;&quot;</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;pkgA&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span>
                    <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
                    </span><span class="s3">[build-system] 
                    requires = [&quot;setuptools&quot;, &quot;wheel&quot;] 
                    build-backend = &quot;setuptools.build_meta&quot; 
 
                    [project] 
                    name = &quot;pkgA&quot; 
                    version = &quot;3.14159&quot; 
 
                    [tool.setuptools] 
                    packages.find.include = [&quot;mypkg.*&quot;] 
                    &quot;&quot;&quot;</span>
                <span class="s2">),</span>
                <span class="s3">&quot;mypkg&quot;</span><span class="s2">: {</span>
                    <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;other.py&quot;</span><span class="s2">: </span><span class="s3">&quot;b = 1&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;n&quot;</span><span class="s2">: {</span>
                        <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;pkgA.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 1&quot;</span><span class="s2">,</span>
                    <span class="s2">},</span>
                <span class="s2">},</span>
                <span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">: </span><span class="s1">EXAMPLE</span><span class="s2">[</span><span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">],</span>
            <span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">pkg_A </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;pkgA&quot;</span>

        <span class="s4"># use pip to install to the target directory</span>
        <span class="s1">opts </span><span class="s2">= [</span><span class="s3">&quot;--no-build-isolation&quot;</span><span class="s2">]  </span><span class="s4"># force current version of setuptools</span>
        <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;pip&quot;</span><span class="s2">, </span><span class="s3">&quot;-v&quot;</span><span class="s2">, </span><span class="s3">&quot;install&quot;</span><span class="s2">, </span><span class="s3">&quot;-e&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">pkg_A</span><span class="s2">), *</span><span class="s1">opts</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;from mypkg.n import pkgA; print(pkgA.a)&quot;</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">out</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">() == </span><span class="s3">&quot;1&quot;</span>
        <span class="s1">cmd </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">try: 
            import mypkg.other 
        except ImportError: 
            print(&quot;mypkg.other not defined&quot;) 
        &quot;&quot;&quot;</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">)])</span>
        <span class="s0">assert </span><span class="s3">&quot;mypkg.other not defined&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_editable_with_prefix</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">sample_project</span><span class="s2">, </span><span class="s1">editable_opts</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Editable install to a prefix should be discoverable. 
    &quot;&quot;&quot;</span>
    <span class="s1">prefix </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">'prefix'</span>

    <span class="s4"># figure out where pip will likely install the package</span>
    <span class="s1">site_packages_all </span><span class="s2">= [</span>
        <span class="s1">prefix </span><span class="s2">/ </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">).</span><span class="s1">relative_to</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">prefix</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span>
        <span class="s0">if </span><span class="s3">'site-packages' </span><span class="s0">in </span><span class="s1">path </span><span class="s0">and </span><span class="s1">path</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">prefix</span><span class="s2">)</span>
    <span class="s2">]</span>

    <span class="s0">for </span><span class="s1">sp </span><span class="s0">in </span><span class="s1">site_packages_all</span><span class="s2">:</span>
        <span class="s1">sp</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">parents</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s4"># install workaround</span>
    <span class="s1">_addsitedirs</span><span class="s2">(</span><span class="s1">site_packages_all</span><span class="s2">)</span>

    <span class="s1">env </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">, </span><span class="s1">PYTHONPATH</span><span class="s2">=</span><span class="s1">os</span><span class="s2">.</span><span class="s1">pathsep</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">str</span><span class="s2">, </span><span class="s1">site_packages_all</span><span class="s2">)))</span>
    <span class="s1">cmd </span><span class="s2">= [</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">,</span>
        <span class="s3">'-m'</span><span class="s2">,</span>
        <span class="s3">'pip'</span><span class="s2">,</span>
        <span class="s3">'install'</span><span class="s2">,</span>
        <span class="s3">'--editable'</span><span class="s2">,</span>
        <span class="s1">str</span><span class="s2">(</span><span class="s1">sample_project</span><span class="s2">),</span>
        <span class="s3">'--prefix'</span><span class="s2">,</span>
        <span class="s1">str</span><span class="s2">(</span><span class="s1">prefix</span><span class="s2">),</span>
        <span class="s3">'--no-build-isolation'</span><span class="s2">,</span>
        <span class="s2">*</span><span class="s1">editable_opts</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_call</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">)</span>

    <span class="s4"># now run 'sample' with the prefix on the PYTHONPATH</span>
    <span class="s1">bin </span><span class="s2">= </span><span class="s3">'Scripts' </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">system</span><span class="s2">() == </span><span class="s3">'Windows' </span><span class="s0">else </span><span class="s3">'bin'</span>
    <span class="s1">exe </span><span class="s2">= </span><span class="s1">prefix </span><span class="s2">/ </span><span class="s1">bin </span><span class="s2">/ </span><span class="s3">'sample'</span>
    <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_call</span><span class="s2">([</span><span class="s1">exe</span><span class="s2">], </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFinderTemplate</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;This test focus in getting a particular implementation detail right. 
    If at some point in time the implementation is changed for something different, 
    this test can be modified or even excluded. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">finder</span><span class="s2">):</span>
        <span class="s1">loc </span><span class="s2">= {}</span>
        <span class="s1">exec</span><span class="s2">(</span><span class="s1">finder</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">loc</span><span class="s2">[</span><span class="s3">&quot;install&quot;</span><span class="s2">]()</span>

    <span class="s0">def </span><span class="s1">test_packages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;src1&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;pkg1&quot;</span><span class="s2">: {</span>
                    <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;subpkg&quot;</span><span class="s2">: {</span><span class="s3">&quot;mod1.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 42&quot;</span><span class="s2">},</span>
                <span class="s2">},</span>
            <span class="s2">},</span>
            <span class="s3">&quot;src2&quot;</span><span class="s2">: {</span><span class="s3">&quot;mod2.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 43&quot;</span><span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">mapping </span><span class="s2">= {</span>
            <span class="s3">&quot;pkg1&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src1/pkg1&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;mod2&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src2/mod2&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">template </span><span class="s2">= </span><span class="s1">_finder_template</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()), </span><span class="s1">mapping</span><span class="s2">, {})</span>

        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">mod </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;pkg1&quot;</span><span class="s2">, </span><span class="s3">&quot;pkg1.subpkg&quot;</span><span class="s2">, </span><span class="s3">&quot;pkg1.subpkg.mod1&quot;</span><span class="s2">, </span><span class="s3">&quot;mod2&quot;</span><span class="s2">):</span>
                <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">template</span><span class="s2">)</span>
            <span class="s1">mod1 </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;pkg1.subpkg.mod1&quot;</span><span class="s2">)</span>
            <span class="s1">mod2 </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;mod2&quot;</span><span class="s2">)</span>
            <span class="s1">subpkg </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;pkg1.subpkg&quot;</span><span class="s2">)</span>

            <span class="s0">assert </span><span class="s1">mod1</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s6">42</span>
            <span class="s0">assert </span><span class="s1">mod2</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s6">43</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">str</span><span class="s2">((</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src1/pkg1/subpkg&quot;</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">())</span>
            <span class="s1">assert_path</span><span class="s2">(</span><span class="s1">subpkg</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_namespace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span><span class="s3">&quot;pkg&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 13&quot;</span><span class="s2">, </span><span class="s3">&quot;text.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;abc&quot;</span><span class="s2">}}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">mapping </span><span class="s2">= {</span><span class="s3">&quot;ns.othername&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;pkg&quot;</span><span class="s2">)}</span>
        <span class="s1">namespaces </span><span class="s2">= {</span><span class="s3">&quot;ns&quot;</span><span class="s2">: []}</span>

        <span class="s1">template </span><span class="s2">= </span><span class="s1">_finder_template</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()), </span><span class="s1">mapping</span><span class="s2">, </span><span class="s1">namespaces</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">mod </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;ns&quot;</span><span class="s2">, </span><span class="s3">&quot;ns.othername&quot;</span><span class="s2">):</span>
                <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">template</span><span class="s2">)</span>
            <span class="s1">pkg </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;ns.othername&quot;</span><span class="s2">)</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s1">importlib_resources</span><span class="s2">.</span><span class="s1">files</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">) / </span><span class="s3">&quot;text.txt&quot;</span>

            <span class="s1">expected </span><span class="s2">= </span><span class="s1">str</span><span class="s2">((</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;pkg&quot;</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">())</span>
            <span class="s1">assert_path</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">pkg</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s6">13</span>

            <span class="s4"># Make sure resources can also be found</span>
            <span class="s0">assert </span><span class="s1">text</span><span class="s2">.</span><span class="s1">read_text</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) == </span><span class="s3">&quot;abc&quot;</span>

    <span class="s0">def </span><span class="s1">test_combine_namespaces</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;src1&quot;</span><span class="s2">: {</span><span class="s3">&quot;ns&quot;</span><span class="s2">: {</span><span class="s3">&quot;pkg1&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 13&quot;</span><span class="s2">}}},</span>
            <span class="s3">&quot;src2&quot;</span><span class="s2">: {</span><span class="s3">&quot;ns&quot;</span><span class="s2">: {</span><span class="s3">&quot;mod2.py&quot;</span><span class="s2">: </span><span class="s3">&quot;b = 37&quot;</span><span class="s2">}},</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">mapping </span><span class="s2">= {</span>
            <span class="s3">&quot;ns.pkgA&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src1/ns/pkg1&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;ns&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src2/ns&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">namespaces_ </span><span class="s2">= {</span><span class="s3">&quot;ns&quot;</span><span class="s2">: [</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src1&quot;</span><span class="s2">), </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src2&quot;</span><span class="s2">)]}</span>
        <span class="s1">template </span><span class="s2">= </span><span class="s1">_finder_template</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()), </span><span class="s1">mapping</span><span class="s2">, </span><span class="s1">namespaces_</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">mod </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;ns&quot;</span><span class="s2">, </span><span class="s3">&quot;ns.pkgA&quot;</span><span class="s2">, </span><span class="s3">&quot;ns.mod2&quot;</span><span class="s2">):</span>
                <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">template</span><span class="s2">)</span>
            <span class="s1">pkgA </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;ns.pkgA&quot;</span><span class="s2">)</span>
            <span class="s1">mod2 </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;ns.mod2&quot;</span><span class="s2">)</span>

            <span class="s1">expected </span><span class="s2">= </span><span class="s1">str</span><span class="s2">((</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src1/ns/pkg1&quot;</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">())</span>
            <span class="s1">assert_path</span><span class="s2">(</span><span class="s1">pkgA</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">pkgA</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s6">13</span>
            <span class="s0">assert </span><span class="s1">mod2</span><span class="s2">.</span><span class="s1">b </span><span class="s2">== </span><span class="s6">37</span>

    <span class="s0">def </span><span class="s1">test_combine_namespaces_nested</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Users may attempt to combine namespace packages in a nested way via 
        ``package_dir`` as shown in pypa/setuptools#4248. 
        &quot;&quot;&quot;</span>

        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;src&quot;</span><span class="s2">: {</span><span class="s3">&quot;my_package&quot;</span><span class="s2">: {</span><span class="s3">&quot;my_module.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 13&quot;</span><span class="s2">}},</span>
            <span class="s3">&quot;src2&quot;</span><span class="s2">: {</span><span class="s3">&quot;my_package2&quot;</span><span class="s2">: {</span><span class="s3">&quot;my_module2.py&quot;</span><span class="s2">: </span><span class="s3">&quot;b = 37&quot;</span><span class="s2">}},</span>
        <span class="s2">}</span>

        <span class="s1">stack </span><span class="s2">= </span><span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">DirectoryStack</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">stack</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
            <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>
            <span class="s1">attrs </span><span class="s2">= {</span>
                <span class="s3">&quot;script_name&quot;</span><span class="s2">: </span><span class="s3">&quot;%PEP 517%&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;package_dir&quot;</span><span class="s2">: {</span>
                    <span class="s3">&quot;different_name&quot;</span><span class="s2">: </span><span class="s3">&quot;src/my_package&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;different_name.subpkg&quot;</span><span class="s2">: </span><span class="s3">&quot;src2/my_package2&quot;</span><span class="s2">,</span>
                <span class="s2">},</span>
                <span class="s3">&quot;packages&quot;</span><span class="s2">: [</span><span class="s3">&quot;different_name&quot;</span><span class="s2">, </span><span class="s3">&quot;different_name.subpkg&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
            <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">)</span>
            <span class="s1">finder </span><span class="s2">= </span><span class="s1">_TopLevelFinder</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()))</span>
            <span class="s1">code </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">v </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">finder</span><span class="s2">.</span><span class="s1">get_implementation</span><span class="s2">() </span><span class="s0">if </span><span class="s1">k</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">&quot;.py&quot;</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">mod </span><span class="s0">in </span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;packages&quot;</span><span class="s2">]:</span>
                <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">code</span><span class="s2">)</span>
            <span class="s1">mod1 </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;different_name.my_module&quot;</span><span class="s2">)</span>
            <span class="s1">mod2 </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;different_name.subpkg.my_module2&quot;</span><span class="s2">)</span>

            <span class="s1">expected </span><span class="s2">= </span><span class="s1">str</span><span class="s2">((</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src/my_package/my_module.py&quot;</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">())</span>
            <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">mod1</span><span class="s2">.</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">()) == </span><span class="s1">expected</span>

            <span class="s1">expected </span><span class="s2">= </span><span class="s1">str</span><span class="s2">((</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src2/my_package2/my_module2.py&quot;</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">())</span>
            <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">mod2</span><span class="s2">.</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">()) == </span><span class="s1">expected</span>

            <span class="s0">assert </span><span class="s1">mod1</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s6">13</span>
            <span class="s0">assert </span><span class="s1">mod2</span><span class="s2">.</span><span class="s1">b </span><span class="s2">== </span><span class="s6">37</span>

    <span class="s0">def </span><span class="s1">test_dynamic_path_computation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s4"># Follows the example in PEP 420</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;project1&quot;</span><span class="s2">: {</span><span class="s3">&quot;parent&quot;</span><span class="s2">: {</span><span class="s3">&quot;child&quot;</span><span class="s2">: {</span><span class="s3">&quot;one.py&quot;</span><span class="s2">: </span><span class="s3">&quot;x = 1&quot;</span><span class="s2">}}},</span>
            <span class="s3">&quot;project2&quot;</span><span class="s2">: {</span><span class="s3">&quot;parent&quot;</span><span class="s2">: {</span><span class="s3">&quot;child&quot;</span><span class="s2">: {</span><span class="s3">&quot;two.py&quot;</span><span class="s2">: </span><span class="s3">&quot;x = 2&quot;</span><span class="s2">}}},</span>
            <span class="s3">&quot;project3&quot;</span><span class="s2">: {</span><span class="s3">&quot;parent&quot;</span><span class="s2">: {</span><span class="s3">&quot;child&quot;</span><span class="s2">: {</span><span class="s3">&quot;three.py&quot;</span><span class="s2">: </span><span class="s3">&quot;x = 3&quot;</span><span class="s2">}}},</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">mapping </span><span class="s2">= {}</span>
        <span class="s1">namespaces_ </span><span class="s2">= {</span><span class="s3">&quot;parent&quot;</span><span class="s2">: [</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;project1/parent&quot;</span><span class="s2">)]}</span>
        <span class="s1">template </span><span class="s2">= </span><span class="s1">_finder_template</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()), </span><span class="s1">mapping</span><span class="s2">, </span><span class="s1">namespaces_</span><span class="s2">)</span>

        <span class="s1">mods </span><span class="s2">= (</span><span class="s3">f&quot;parent.child.</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s3">&quot;three&quot;</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">mod </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;parent&quot;</span><span class="s2">, </span><span class="s3">&quot;parent.child&quot;</span><span class="s2">, </span><span class="s3">&quot;parent.child&quot;</span><span class="s2">, *</span><span class="s1">mods</span><span class="s2">):</span>
                <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">template</span><span class="s2">)</span>

            <span class="s1">one </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;parent.child.one&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">one</span><span class="s2">.</span><span class="s1">x </span><span class="s2">== </span><span class="s6">1</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;parent.child.two&quot;</span><span class="s2">)</span>

            <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;project2&quot;</span><span class="s2">))</span>
            <span class="s1">two </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;parent.child.two&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">two</span><span class="s2">.</span><span class="s1">x </span><span class="s2">== </span><span class="s6">2</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;parent.child.three&quot;</span><span class="s2">)</span>

            <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;project3&quot;</span><span class="s2">))</span>
            <span class="s1">three </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;parent.child.three&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">three</span><span class="s2">.</span><span class="s1">x </span><span class="s2">== </span><span class="s6">3</span>

    <span class="s0">def </span><span class="s1">test_no_recursion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s4"># See issue #3550</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;pkg&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;from . import pkg&quot;</span><span class="s2">,</span>
            <span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">mapping </span><span class="s2">= {</span>
            <span class="s3">&quot;pkg&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;pkg&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">template </span><span class="s2">= </span><span class="s1">_finder_template</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()), </span><span class="s1">mapping</span><span class="s2">, {})</span>

        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">&quot;pkg&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">template</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;pkg&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;pkg&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_similar_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;foo&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;bar&quot;</span><span class="s2">: {</span>
                    <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                <span class="s2">},</span>
            <span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">mapping </span><span class="s2">= {</span>
            <span class="s3">&quot;foo&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;foo&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">template </span><span class="s2">= </span><span class="s1">_finder_template</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()), </span><span class="s1">mapping</span><span class="s2">, {})</span>

        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">&quot;foo.bar&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">template</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;foobar&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;foobar&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_case_sensitivity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;foo&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;lowercase.py&quot;</span><span class="s2">: </span><span class="s3">&quot;x = 1&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;bar&quot;</span><span class="s2">: {</span>
                    <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;lowercase.py&quot;</span><span class="s2">: </span><span class="s3">&quot;x = 2&quot;</span><span class="s2">,</span>
                <span class="s2">},</span>
            <span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">mapping </span><span class="s2">= {</span>
            <span class="s3">&quot;foo&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;foo&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">template </span><span class="s2">= </span><span class="s1">_finder_template</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()), </span><span class="s1">mapping</span><span class="s2">, {})</span>
        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">template</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;'FOO'&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;FOO&quot;</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;'foo</span><span class="s0">\\</span><span class="s3">.LOWERCASE'&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;foo.LOWERCASE&quot;</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;'foo</span><span class="s0">\\</span><span class="s3">.bar</span><span class="s0">\\</span><span class="s3">.Lowercase'&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;foo.bar.Lowercase&quot;</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;'foo</span><span class="s0">\\</span><span class="s3">.BAR'&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;foo.BAR.lowercase&quot;</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;'FOO'&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;FOO.bar.lowercase&quot;</span><span class="s2">)</span>

            <span class="s1">mod </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;foo.lowercase&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">mod</span><span class="s2">.</span><span class="s1">x </span><span class="s2">== </span><span class="s6">1</span>

            <span class="s1">mod </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;foo.bar.lowercase&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">mod</span><span class="s2">.</span><span class="s1">x </span><span class="s2">== </span><span class="s6">2</span>

    <span class="s0">def </span><span class="s1">test_namespace_case_sensitivity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;pkg&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 13&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;foo&quot;</span><span class="s2">: {</span>
                    <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;b = 37&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;bar.py&quot;</span><span class="s2">: </span><span class="s3">&quot;c = 42&quot;</span><span class="s2">,</span>
                <span class="s2">},</span>
            <span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">mapping </span><span class="s2">= {</span><span class="s3">&quot;ns.othername&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;pkg&quot;</span><span class="s2">)}</span>
        <span class="s1">namespaces </span><span class="s2">= {</span><span class="s3">&quot;ns&quot;</span><span class="s2">: []}</span>

        <span class="s1">template </span><span class="s2">= </span><span class="s1">_finder_template</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()), </span><span class="s1">mapping</span><span class="s2">, </span><span class="s1">namespaces</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">mod </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;ns&quot;</span><span class="s2">, </span><span class="s3">&quot;ns.othername&quot;</span><span class="s2">):</span>
                <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">template</span><span class="s2">)</span>
            <span class="s1">pkg </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;ns.othername&quot;</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">str</span><span class="s2">((</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;pkg&quot;</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">())</span>
            <span class="s1">assert_path</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">pkg</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s6">13</span>

            <span class="s1">foo </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;ns.othername.foo&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">foo</span><span class="s2">.</span><span class="s1">b </span><span class="s2">== </span><span class="s6">37</span>

            <span class="s1">bar </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;ns.othername.foo.bar&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">bar</span><span class="s2">.</span><span class="s1">c </span><span class="s2">== </span><span class="s6">42</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;'NS'&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;NS.othername.foo&quot;</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;'ns</span><span class="s0">\\</span><span class="s3">.othername</span><span class="s0">\\</span><span class="s3">.FOO</span><span class="s0">\\</span><span class="s3">'&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;ns.othername.FOO&quot;</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;'ns</span><span class="s0">\\</span><span class="s3">.othername</span><span class="s0">\\</span><span class="s3">.foo</span><span class="s0">\\</span><span class="s3">.BAR</span><span class="s0">\\</span><span class="s3">'&quot;</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;ns.othername.foo.BAR&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_intermediate_packages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        The finder should not import ``fullname`` if the intermediate segments 
        don't exist (see pypa/setuptools#4019). 
        &quot;&quot;&quot;</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;src&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;mypkg&quot;</span><span class="s2">: {</span>
                    <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;config.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 13&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;helloworld.py&quot;</span><span class="s2">: </span><span class="s3">&quot;b = 13&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;components&quot;</span><span class="s2">: {</span>
                        <span class="s3">&quot;config.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 37&quot;</span><span class="s2">,</span>
                    <span class="s2">},</span>
                <span class="s2">},</span>
            <span class="s2">}</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">mapping </span><span class="s2">= {</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src/mypkg&quot;</span><span class="s2">)}</span>
        <span class="s1">template </span><span class="s2">= </span><span class="s1">_finder_template</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">uuid4</span><span class="s2">()), </span><span class="s1">mapping</span><span class="s2">, {})</span>

        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_paths</span><span class="s2">(), </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_sys_modules</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">mod </span><span class="s0">in </span><span class="s2">(</span>
                <span class="s3">&quot;mypkg&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;mypkg.config&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;mypkg.helloworld&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;mypkg.components&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;mypkg.components.config&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;mypkg.components.helloworld&quot;</span><span class="s2">,</span>
            <span class="s2">):</span>
                <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">install_finder</span><span class="s2">(</span><span class="s1">template</span><span class="s2">)</span>

            <span class="s1">config </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;mypkg.components.config&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">config</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s6">37</span>

            <span class="s1">helloworld </span><span class="s2">= </span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;mypkg.helloworld&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">helloworld</span><span class="s2">.</span><span class="s1">b </span><span class="s2">== </span><span class="s6">13</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">):</span>
                <span class="s1">import_module</span><span class="s2">(</span><span class="s3">&quot;mypkg.components.helloworld&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pkg_roots</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;This test focus in getting a particular implementation detail right. 
    If at some point in time the implementation is changed for something different, 
    this test can be modified or even excluded. 
    &quot;&quot;&quot;</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s3">&quot;a&quot;</span><span class="s2">: {</span><span class="s3">&quot;b&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;ab = 1&quot;</span><span class="s2">}, </span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;a = 1&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;d&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;d = 1&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;de = 1&quot;</span><span class="s2">}},</span>
        <span class="s3">&quot;f&quot;</span><span class="s2">: {</span><span class="s3">&quot;g&quot;</span><span class="s2">: {</span><span class="s3">&quot;h&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;fgh = 1&quot;</span><span class="s2">}}},</span>
        <span class="s3">&quot;other&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;abc = 1&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;another&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;abcxyz = 1&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;yet_another&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;mnopq = 1&quot;</span><span class="s2">},</span>
    <span class="s2">}</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">package_dir </span><span class="s2">= {</span>
        <span class="s3">&quot;a.b.c&quot;</span><span class="s2">: </span><span class="s3">&quot;other&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;a.b.c.x.y.z&quot;</span><span class="s2">: </span><span class="s3">&quot;another&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;m.n.o.p.q&quot;</span><span class="s2">: </span><span class="s3">&quot;yet_another&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s1">packages </span><span class="s2">= [</span>
        <span class="s3">&quot;a&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;a.b&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;a.b.c&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;a.b.c.x.y&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;a.b.c.x.y.z&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;d.e&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;f&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;f.g&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;f.g.h&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;m.n.o.p.q&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">roots </span><span class="s2">= </span><span class="s1">_find_package_roots</span><span class="s2">(</span><span class="s1">packages</span><span class="s2">, </span><span class="s1">package_dir</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">roots </span><span class="s2">== {</span>
        <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;a&quot;</span><span class="s2">),</span>
        <span class="s3">&quot;a.b.c&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;other&quot;</span><span class="s2">),</span>
        <span class="s3">&quot;a.b.c.x.y.z&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;another&quot;</span><span class="s2">),</span>
        <span class="s3">&quot;d&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;d&quot;</span><span class="s2">),</span>
        <span class="s3">&quot;f&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;f&quot;</span><span class="s2">),</span>
        <span class="s3">&quot;m.n.o.p.q&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;yet_another&quot;</span><span class="s2">),</span>
    <span class="s2">}</span>

    <span class="s1">ns </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">_find_namespaces</span><span class="s2">(</span><span class="s1">packages</span><span class="s2">, </span><span class="s1">roots</span><span class="s2">)))</span>
    <span class="s0">assert </span><span class="s1">ns </span><span class="s2">== {</span><span class="s3">&quot;f&quot;</span><span class="s2">, </span><span class="s3">&quot;f.g&quot;</span><span class="s2">}</span>

    <span class="s1">ns </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">_find_virtual_namespaces</span><span class="s2">(</span><span class="s1">roots</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">ns </span><span class="s2">== {</span><span class="s3">&quot;a.b&quot;</span><span class="s2">, </span><span class="s3">&quot;a.b.c.x&quot;</span><span class="s2">, </span><span class="s3">&quot;a.b.c.x.y&quot;</span><span class="s2">, </span><span class="s3">&quot;m&quot;</span><span class="s2">, </span><span class="s3">&quot;m.n&quot;</span><span class="s2">, </span><span class="s3">&quot;m.n.o&quot;</span><span class="s2">, </span><span class="s3">&quot;m.n.o.p&quot;</span><span class="s2">}</span>


<span class="s0">class </span><span class="s1">TestOverallBehaviour</span><span class="s2">:</span>
    <span class="s1">PYPROJECT </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">[build-system] 
        requires = [&quot;setuptools&quot;] 
        build-backend = &quot;setuptools.build_meta&quot; 
 
        [project] 
        name = &quot;mypkg&quot; 
        version = &quot;3.14159&quot; 
        &quot;&quot;&quot;</span>

    <span class="s4"># Any: Would need a TypedDict. Keep it simple for tests</span>
    <span class="s1">FLAT_LAYOUT</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">] = {</span>
        <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">PYPROJECT</span><span class="s2">),</span>
        <span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">: </span><span class="s1">EXAMPLE</span><span class="s2">[</span><span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">],</span>
        <span class="s3">&quot;otherfile.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;mypkg&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;mod1.py&quot;</span><span class="s2">: </span><span class="s3">&quot;var = 42&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;subpackage&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;mod2.py&quot;</span><span class="s2">: </span><span class="s3">&quot;var = 13&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;resource_file.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;resource 39&quot;</span><span class="s2">,</span>
            <span class="s2">},</span>
        <span class="s2">},</span>
    <span class="s2">}</span>

    <span class="s1">EXAMPLES </span><span class="s2">= {</span>
        <span class="s3">&quot;flat-layout&quot;</span><span class="s2">: </span><span class="s1">FLAT_LAYOUT</span><span class="s2">,</span>
        <span class="s3">&quot;src-layout&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">PYPROJECT</span><span class="s2">),</span>
            <span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">: </span><span class="s1">EXAMPLE</span><span class="s2">[</span><span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">],</span>
            <span class="s3">&quot;otherfile.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;src&quot;</span><span class="s2">: {</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">: </span><span class="s1">FLAT_LAYOUT</span><span class="s2">[</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">]},</span>
        <span class="s2">},</span>
        <span class="s3">&quot;custom-layout&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">PYPROJECT</span><span class="s2">)</span>
            <span class="s2">+ </span><span class="s1">dedent</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
                </span><span class="s3">[tool.setuptools] 
                packages = [&quot;mypkg&quot;, &quot;mypkg.subpackage&quot;] 
 
                [tool.setuptools.package-dir] 
                &quot;mypkg.subpackage&quot; = &quot;other&quot; 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">: </span><span class="s1">EXAMPLE</span><span class="s2">[</span><span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">],</span>
            <span class="s3">&quot;otherfile.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;mypkg&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;mod1.py&quot;</span><span class="s2">: </span><span class="s1">FLAT_LAYOUT</span><span class="s2">[</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">][</span><span class="s3">&quot;mod1.py&quot;</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s3">&quot;other&quot;</span><span class="s2">: </span><span class="s1">FLAT_LAYOUT</span><span class="s2">[</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">][</span><span class="s3">&quot;subpackage&quot;</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s3">&quot;namespace&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">PYPROJECT</span><span class="s2">),</span>
            <span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">: </span><span class="s1">EXAMPLE</span><span class="s2">[</span><span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">],</span>
            <span class="s3">&quot;otherfile.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;src&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;mypkg&quot;</span><span class="s2">: {</span>
                    <span class="s3">&quot;mod1.py&quot;</span><span class="s2">: </span><span class="s1">FLAT_LAYOUT</span><span class="s2">[</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">][</span><span class="s3">&quot;mod1.py&quot;</span><span class="s2">],</span>
                    <span class="s3">&quot;subpackage&quot;</span><span class="s2">: </span><span class="s1">FLAT_LAYOUT</span><span class="s2">[</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">][</span><span class="s3">&quot;subpackage&quot;</span><span class="s2">],</span>
                <span class="s2">},</span>
            <span class="s2">},</span>
        <span class="s2">},</span>
    <span class="s2">}</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">&quot;darwin&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;pypa/setuptools#4328&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;layout&quot;</span><span class="s2">, </span><span class="s1">EXAMPLES</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
    <span class="s0">def </span><span class="s1">test_editable_install</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">, </span><span class="s1">editable_opts</span><span class="s2">):</span>
        <span class="s1">project</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">install_project</span><span class="s2">(</span>
            <span class="s3">&quot;mypkg&quot;</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">EXAMPLES</span><span class="s2">[</span><span class="s1">layout</span><span class="s2">], *</span><span class="s1">editable_opts</span>
        <span class="s2">)</span>

        <span class="s4"># Ensure stray files are not importable</span>
        <span class="s1">cmd_import_error </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">try: 
            import otherfile 
        except ImportError as ex: 
            print(ex) 
        &quot;&quot;&quot;</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">cmd_import_error</span><span class="s2">)])</span>
        <span class="s0">assert </span><span class="s3">&quot;No module named 'otherfile'&quot; </span><span class="s0">in </span><span class="s1">out</span>

        <span class="s4"># Ensure the modules are importable</span>
        <span class="s1">cmd_get_vars </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">import mypkg, mypkg.mod1, mypkg.subpackage.mod2 
        print(mypkg.mod1.var, mypkg.subpackage.mod2.var) 
        &quot;&quot;&quot;</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">cmd_get_vars</span><span class="s2">)])</span>
        <span class="s0">assert </span><span class="s3">&quot;42 13&quot; </span><span class="s0">in </span><span class="s1">out</span>

        <span class="s4"># Ensure resources are reachable</span>
        <span class="s1">cmd_get_resource </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">import mypkg.subpackage 
        from setuptools._importlib import resources as importlib_resources 
        text = importlib_resources.files(mypkg.subpackage) / &quot;resource_file.txt&quot; 
        print(text.read_text(encoding=&quot;utf-8&quot;)) 
        &quot;&quot;&quot;</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">cmd_get_resource</span><span class="s2">)])</span>
        <span class="s0">assert </span><span class="s3">&quot;resource 39&quot; </span><span class="s0">in </span><span class="s1">out</span>

        <span class="s4"># Ensure files are editable</span>
        <span class="s1">mod1 </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">project</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;**/mod1.py&quot;</span><span class="s2">))</span>
        <span class="s1">mod2 </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">project</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;**/mod2.py&quot;</span><span class="s2">))</span>
        <span class="s1">resource_file </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">project</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;**/resource_file.txt&quot;</span><span class="s2">))</span>

        <span class="s1">mod1</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s3">&quot;var = 17&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s1">mod2</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s3">&quot;var = 781&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s1">resource_file</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s3">&quot;resource 374&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">cmd_get_vars</span><span class="s2">)])</span>
        <span class="s0">assert </span><span class="s3">&quot;42 13&quot; </span><span class="s0">not in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s3">&quot;17 781&quot; </span><span class="s0">in </span><span class="s1">out</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">cmd_get_resource</span><span class="s2">)])</span>
        <span class="s0">assert </span><span class="s3">&quot;resource 39&quot; </span><span class="s0">not in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s3">&quot;resource 374&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">class </span><span class="s1">TestLinkTree</span><span class="s2">:</span>
    <span class="s1">FILES </span><span class="s2">= </span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">TestOverallBehaviour</span><span class="s2">.</span><span class="s1">EXAMPLES</span><span class="s2">[</span><span class="s3">&quot;src-layout&quot;</span><span class="s2">])</span>
    <span class="s1">FILES</span><span class="s2">[</span><span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">] += </span><span class="s1">dedent</span><span class="s2">(</span>
        <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">[tool.setuptools] 
        # Temporary workaround: both `include-package-data` and `package-data` configs 
        # can be removed after #3260 is fixed. 
        include-package-data = false 
        package-data = {&quot;*&quot; = [&quot;*.txt&quot;]} 
 
        [tool.setuptools.packages.find] 
        where = [&quot;src&quot;] 
        exclude = [&quot;*.subpackage*&quot;] 
        &quot;&quot;&quot;</span>
    <span class="s2">)</span>
    <span class="s1">FILES</span><span class="s2">[</span><span class="s3">&quot;src&quot;</span><span class="s2">][</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">][</span><span class="s3">&quot;resource.not_in_manifest&quot;</span><span class="s2">] = </span><span class="s3">&quot;abc&quot;</span>

    <span class="s0">def </span><span class="s1">test_generated_tree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">_Path</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;mypkg-3.14159&quot;</span>
            <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">({</span><span class="s3">&quot;script_name&quot;</span><span class="s2">: </span><span class="s3">&quot;%PEP 517%&quot;</span><span class="s2">})</span>
            <span class="s1">dist</span><span class="s2">.</span><span class="s1">parse_config_files</span><span class="s2">()</span>

            <span class="s1">wheel </span><span class="s2">= </span><span class="s1">Mock</span><span class="s2">()</span>
            <span class="s1">aux </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;.aux&quot;</span>
            <span class="s1">build </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;.build&quot;</span>
            <span class="s1">aux</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">()</span>
            <span class="s1">build</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">()</span>

            <span class="s1">build_py </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_command_obj</span><span class="s2">(</span><span class="s3">&quot;build_py&quot;</span><span class="s2">)</span>
            <span class="s1">build_py</span><span class="s2">.</span><span class="s1">editable_mode </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">build_py</span><span class="s2">.</span><span class="s1">build_lib </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">build</span><span class="s2">)</span>
            <span class="s1">build_py</span><span class="s2">.</span><span class="s1">ensure_finalized</span><span class="s2">()</span>
            <span class="s1">outputs </span><span class="s2">= </span><span class="s1">build_py</span><span class="s2">.</span><span class="s1">get_outputs</span><span class="s2">()</span>
            <span class="s1">output_mapping </span><span class="s2">= </span><span class="s1">build_py</span><span class="s2">.</span><span class="s1">get_output_mapping</span><span class="s2">()</span>

            <span class="s1">make_tree </span><span class="s2">= </span><span class="s1">_LinkTree</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">build</span><span class="s2">)</span>
            <span class="s1">make_tree</span><span class="s2">(</span><span class="s1">wheel</span><span class="s2">, </span><span class="s1">outputs</span><span class="s2">, </span><span class="s1">output_mapping</span><span class="s2">)</span>

            <span class="s1">mod1 </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">aux</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;**/mod1.py&quot;</span><span class="s2">))</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;src/mypkg/mod1.py&quot;</span>
            <span class="s1">assert_link_to</span><span class="s2">(</span><span class="s1">mod1</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

            <span class="s0">assert </span><span class="s1">next</span><span class="s2">(</span><span class="s1">aux</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;**/subpackage&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">) </span><span class="s0">is None</span>
            <span class="s0">assert </span><span class="s1">next</span><span class="s2">(</span><span class="s1">aux</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;**/mod2.py&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">) </span><span class="s0">is None</span>
            <span class="s0">assert </span><span class="s1">next</span><span class="s2">(</span><span class="s1">aux</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;**/resource_file.txt&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">) </span><span class="s0">is None</span>

            <span class="s0">assert </span><span class="s1">next</span><span class="s2">(</span><span class="s1">aux</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;**/resource.not_in_manifest&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s0">def </span><span class="s1">test_strict_install</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">):</span>
        <span class="s1">opts </span><span class="s2">= [</span><span class="s3">&quot;--config-settings&quot;</span><span class="s2">, </span><span class="s3">&quot;editable-mode=strict&quot;</span><span class="s2">]</span>
        <span class="s1">install_project</span><span class="s2">(</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">, *</span><span class="s1">opts</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;import mypkg.mod1; print(mypkg.mod1.var)&quot;</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s3">&quot;42&quot; </span><span class="s0">in </span><span class="s1">out</span>

        <span class="s4"># Ensure packages excluded from distribution are not importable</span>
        <span class="s1">cmd_import_error </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">try: 
            from mypkg import subpackage 
        except ImportError as ex: 
            print(ex) 
        &quot;&quot;&quot;</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">cmd_import_error</span><span class="s2">)])</span>
        <span class="s0">assert </span><span class="s3">&quot;cannot import name 'subpackage'&quot; </span><span class="s0">in </span><span class="s1">out</span>

        <span class="s4"># Ensure resource files excluded from distribution are not reachable</span>
        <span class="s1">cmd_get_resource </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s3">import mypkg 
        from setuptools._importlib import resources as importlib_resources 
        try: 
            text = importlib_resources.files(mypkg) / &quot;resource.not_in_manifest&quot; 
            print(text.read_text(encoding=&quot;utf-8&quot;)) 
        except FileNotFoundError as ex: 
            print(ex) 
        &quot;&quot;&quot;</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">cmd_get_resource</span><span class="s2">)])</span>
        <span class="s0">assert </span><span class="s3">&quot;No such file or directory&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s3">&quot;resource.not_in_manifest&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore:.*compat.*:setuptools.SetuptoolsDeprecationWarning&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_compat_install</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">):</span>
    <span class="s4"># TODO: Remove `compat` after Dec/2022.</span>
    <span class="s1">opts </span><span class="s2">= [</span><span class="s3">&quot;--config-settings&quot;</span><span class="s2">, </span><span class="s3">&quot;editable-mode=compat&quot;</span><span class="s2">]</span>
    <span class="s1">files </span><span class="s2">= </span><span class="s1">TestOverallBehaviour</span><span class="s2">.</span><span class="s1">EXAMPLES</span><span class="s2">[</span><span class="s3">&quot;custom-layout&quot;</span><span class="s2">]</span>
    <span class="s1">install_project</span><span class="s2">(</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, *</span><span class="s1">opts</span><span class="s2">)</span>

    <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;import mypkg.mod1; print(mypkg.mod1.var)&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s3">&quot;42&quot; </span><span class="s0">in </span><span class="s1">out</span>

    <span class="s1">expected_path </span><span class="s2">= </span><span class="s1">comparable_path</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">))</span>

    <span class="s4"># Compatible behaviour will make spurious modules and excluded</span>
    <span class="s4"># files importable directly from the original path</span>
    <span class="s0">for </span><span class="s1">cmd </span><span class="s0">in </span><span class="s2">(</span>
        <span class="s3">&quot;import otherfile; print(otherfile)&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;import other; print(other)&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;import mypkg; print(mypkg)&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">comparable_path</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">cmd</span><span class="s2">]))</span>
        <span class="s0">assert </span><span class="s1">expected_path </span><span class="s0">in </span><span class="s1">out</span>

    <span class="s4"># Compatible behaviour will not consider custom mappings</span>
    <span class="s1">cmd </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
    </span><span class="s3">try: 
        from mypkg import subpackage; 
    except ImportError as ex: 
        print(ex) 
    &quot;&quot;&quot;</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">dedent</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">)])</span>
    <span class="s0">assert </span><span class="s3">&quot;cannot import name 'subpackage'&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_pbr_integration</span><span class="s2">(</span><span class="s1">pbr_package</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">editable_opts</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Ensure editable installs work with pbr, issue #3500&quot;&quot;&quot;</span>
    <span class="s1">cmd </span><span class="s2">= [</span>
        <span class="s3">'python'</span><span class="s2">,</span>
        <span class="s3">'-m'</span><span class="s2">,</span>
        <span class="s3">'pip'</span><span class="s2">,</span>
        <span class="s3">'-v'</span><span class="s2">,</span>
        <span class="s3">'install'</span><span class="s2">,</span>
        <span class="s3">'--editable'</span><span class="s2">,</span>
        <span class="s1">pbr_package</span><span class="s2">,</span>
        <span class="s2">*</span><span class="s1">editable_opts</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">stderr</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">STDOUT</span><span class="s2">)</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;import mypkg.hello&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s3">&quot;Hello world!&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">class </span><span class="s1">TestCustomBuildPy</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot; 
    Issue #3501 indicates that some plugins/customizations might rely on: 
 
    1. ``build_py`` not running 
    2. ``build_py`` always copying files to ``build_lib`` 
 
    During the transition period setuptools should prevent potential errors from 
    happening due to those assumptions. 
    &quot;&quot;&quot;</span>

    <span class="s4"># TODO: Remove tests after _run_build_steps is removed.</span>

    <span class="s1">FILES </span><span class="s2">= {</span>
        <span class="s2">**</span><span class="s1">TestOverallBehaviour</span><span class="s2">.</span><span class="s1">EXAMPLES</span><span class="s2">[</span><span class="s3">&quot;flat-layout&quot;</span><span class="s2">],</span>
        <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">dedent</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
            </span><span class="s3">import pathlib 
            from setuptools import setup 
            from setuptools.command.build_py import build_py as orig 
 
            class my_build_py(orig): 
                def run(self): 
                    super().run() 
                    raise ValueError(&quot;TEST_RAISE&quot;) 
 
            setup(cmdclass={&quot;build_py&quot;: my_build_py}) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">test_safeguarded_from_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Ensure that errors in custom build_py are reported as warnings&quot;&quot;&quot;</span>
        <span class="s4"># Warnings should show up</span>
        <span class="s1">_</span><span class="s2">, </span><span class="s1">out </span><span class="s2">= </span><span class="s1">install_project</span><span class="s2">(</span><span class="s3">&quot;mypkg&quot;</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s3">&quot;SetuptoolsDeprecationWarning&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s3">&quot;ValueError: TEST_RAISE&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s4"># but installation should be successful</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s3">&quot;import mypkg.mod1; print(mypkg.mod1.var)&quot;</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s3">&quot;42&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">class </span><span class="s1">TestCustomBuildWheel</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">install_custom_build_wheel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">):</span>
        <span class="s1">bdist_wheel_cls </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_command_class</span><span class="s2">(</span><span class="s3">&quot;bdist_wheel&quot;</span><span class="s2">)</span>

        <span class="s0">class </span><span class="s1">MyBdistWheel</span><span class="s2">(</span><span class="s1">bdist_wheel_cls</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">get_tag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s4"># In issue #3513, we can see that some extensions may try to access</span>
                <span class="s4"># the `plat_name` property in bdist_wheel</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">plat_name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;macosx-&quot;</span><span class="s2">):</span>
                    <span class="s1">_ </span><span class="s2">= </span><span class="s3">&quot;macOS platform&quot;</span>
                <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">get_tag</span><span class="s2">()</span>

        <span class="s1">dist</span><span class="s2">.</span><span class="s1">cmdclass</span><span class="s2">[</span><span class="s3">&quot;bdist_wheel&quot;</span><span class="s2">] = </span><span class="s1">MyBdistWheel</span>

    <span class="s0">def </span><span class="s1">test_access_plat_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s4"># Even when a custom bdist_wheel tries to access plat_name the build should</span>
        <span class="s4"># be successful</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">({</span><span class="s3">&quot;module.py&quot;</span><span class="s2">: </span><span class="s3">&quot;x = 42&quot;</span><span class="s2">})</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">()</span>
        <span class="s1">dist</span><span class="s2">.</span><span class="s1">script_name </span><span class="s2">= </span><span class="s3">&quot;setup.py&quot;</span>
        <span class="s1">dist</span><span class="s2">.</span><span class="s1">set_defaults</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">install_custom_build_wheel</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">cmd </span><span class="s2">= </span><span class="s1">editable_wheel</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">cmd</span><span class="s2">.</span><span class="s1">ensure_finalized</span><span class="s2">()</span>
        <span class="s1">cmd</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>
        <span class="s1">wheel_file </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">().</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">'dist/*.whl'</span><span class="s2">)))</span>
        <span class="s0">assert </span><span class="s3">&quot;editable&quot; </span><span class="s0">in </span><span class="s1">wheel_file</span>


<span class="s0">class </span><span class="s1">TestCustomBuildExt</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">install_custom_build_ext_distutils</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">command</span><span class="s2">.</span><span class="s1">build_ext </span><span class="s0">import </span><span class="s1">build_ext </span><span class="s0">as </span><span class="s1">build_ext_cls</span>

        <span class="s0">class </span><span class="s1">MyBuildExt</span><span class="s2">(</span><span class="s1">build_ext_cls</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s1">dist</span><span class="s2">.</span><span class="s1">cmdclass</span><span class="s2">[</span><span class="s3">&quot;build_ext&quot;</span><span class="s2">] = </span><span class="s1">MyBuildExt</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s3">&quot;linux&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;compilers may fail without correct setup&quot;</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_distutils_leave_inplace_files</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">({</span><span class="s3">&quot;module.c&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">})</span>
        <span class="s1">attrs </span><span class="s2">= {</span>
            <span class="s3">&quot;ext_modules&quot;</span><span class="s2">: [</span><span class="s1">Extension</span><span class="s2">(</span><span class="s3">&quot;module&quot;</span><span class="s2">, [</span><span class="s3">&quot;module.c&quot;</span><span class="s2">])],</span>
        <span class="s2">}</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s1">dist</span><span class="s2">.</span><span class="s1">script_name </span><span class="s2">= </span><span class="s3">&quot;setup.py&quot;</span>
        <span class="s1">dist</span><span class="s2">.</span><span class="s1">set_defaults</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">install_custom_build_ext_distutils</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">cmd </span><span class="s2">= </span><span class="s1">editable_wheel</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">cmd</span><span class="s2">.</span><span class="s1">ensure_finalized</span><span class="s2">()</span>
        <span class="s1">cmd</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>
        <span class="s1">wheel_file </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">().</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">'dist/*.whl'</span><span class="s2">)))</span>
        <span class="s0">assert </span><span class="s3">&quot;editable&quot; </span><span class="s0">in </span><span class="s1">wheel_file</span>
        <span class="s1">files </span><span class="s2">= [</span><span class="s1">p </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">Path</span><span class="s2">().</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;module.*&quot;</span><span class="s2">) </span><span class="s0">if </span><span class="s1">p</span><span class="s2">.</span><span class="s1">suffix </span><span class="s2">!= </span><span class="s3">&quot;.c&quot;</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">files</span><span class="s2">) == </span><span class="s6">1</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s1">files</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">name</span>
        <span class="s0">assert </span><span class="s1">any</span><span class="s2">(</span><span class="s1">name</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">ext</span><span class="s2">) </span><span class="s0">for </span><span class="s1">ext </span><span class="s0">in </span><span class="s1">EXTENSION_SUFFIXES</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_debugging_tips</span><span class="s2">(</span><span class="s1">tmpdir_cwd</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Make sure to display useful debugging tips to the user.&quot;&quot;&quot;</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">({</span><span class="s3">&quot;module.py&quot;</span><span class="s2">: </span><span class="s3">&quot;x = 42&quot;</span><span class="s2">})</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">()</span>
    <span class="s1">dist</span><span class="s2">.</span><span class="s1">script_name </span><span class="s2">= </span><span class="s3">&quot;setup.py&quot;</span>
    <span class="s1">dist</span><span class="s2">.</span><span class="s1">set_defaults</span><span class="s2">()</span>
    <span class="s1">cmd </span><span class="s2">= </span><span class="s1">editable_wheel</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">ensure_finalized</span><span class="s2">()</span>

    <span class="s1">SimulatedErr </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s3">&quot;SimulatedErr&quot;</span><span class="s2">, (</span><span class="s1">Exception</span><span class="s2">,), {})</span>
    <span class="s1">simulated_failure </span><span class="s2">= </span><span class="s1">Mock</span><span class="s2">(</span><span class="s1">side_effect</span><span class="s2">=</span><span class="s1">SimulatedErr</span><span class="s2">())</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s3">&quot;get_finalized_command&quot;</span><span class="s2">, </span><span class="s1">simulated_failure</span><span class="s2">)</span>

    <span class="s1">expected_msg </span><span class="s2">= </span><span class="s3">&quot;following steps are recommended to help debug&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">SimulatedErr</span><span class="s2">), </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">_DebuggingTips</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_msg</span><span class="s2">):</span>
        <span class="s1">cmd</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;error&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_encode_pth</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Ensure _encode_pth function does not produce encoding warnings&quot;&quot;&quot;</span>
    <span class="s1">content </span><span class="s2">= </span><span class="s1">_encode_pth</span><span class="s2">(</span><span class="s3">&quot;tkmilan__utf8&quot;</span><span class="s2">)  </span><span class="s4"># no warnings (would be turned into errors)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">content</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">install_project</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, *</span><span class="s1">opts</span><span class="s2">):</span>
    <span class="s1">project </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">name</span>
    <span class="s1">project</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">()</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">project</span><span class="s2">)</span>
    <span class="s1">opts </span><span class="s2">= [*</span><span class="s1">opts</span><span class="s2">, </span><span class="s3">&quot;--no-build-isolation&quot;</span><span class="s2">]  </span><span class="s4"># force current version of setuptools</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;-m&quot;</span><span class="s2">, </span><span class="s3">&quot;pip&quot;</span><span class="s2">, </span><span class="s3">&quot;-v&quot;</span><span class="s2">, </span><span class="s3">&quot;install&quot;</span><span class="s2">, </span><span class="s3">&quot;-e&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">project</span><span class="s2">), *</span><span class="s1">opts</span><span class="s2">],</span>
        <span class="s1">stderr</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">STDOUT</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">project</span><span class="s2">, </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">_addsitedirs</span><span class="s2">(</span><span class="s1">new_dirs</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;To use this function, it is necessary to insert new_dir in front of sys.path. 
    The Python process will try to import a ``sitecustomize`` module on startup. 
    If we manipulate sys.path/PYTHONPATH, we can force it to run our code, 
    which invokes ``addsitedir`` and ensure ``.pth`` files are loaded. 
    &quot;&quot;&quot;</span>
    <span class="s1">content </span><span class="s2">= </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s3">&quot;import site&quot;</span><span class="s2">,)</span>
        <span class="s2">+ </span><span class="s1">tuple</span><span class="s2">(</span><span class="s3">f&quot;site.addsitedir(</span><span class="s0">{</span><span class="s1">os</span><span class="s2">.</span><span class="s1">fspath</span><span class="s2">(</span><span class="s1">new_dir</span><span class="s2">)</span><span class="s0">!r}</span><span class="s3">)&quot; </span><span class="s0">for </span><span class="s1">new_dir </span><span class="s0">in </span><span class="s1">new_dirs</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s2">(</span><span class="s1">new_dirs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] / </span><span class="s3">&quot;sitecustomize.py&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">content</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>


<span class="s4"># ---- Assertion Helpers ----</span>


<span class="s0">def </span><span class="s1">assert_path</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s4"># __path__ is not guaranteed to exist, so we have to account for that</span>
    <span class="s0">if </span><span class="s1">pkg</span><span class="s2">.</span><span class="s1">__path__</span><span class="s2">:</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">iter</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">.</span><span class="s1">__path__</span><span class="s2">), </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">()) == </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">assert_link_to</span><span class="s2">(</span><span class="s1">file</span><span class="s2">: </span><span class="s1">Path</span><span class="s2">, </span><span class="s1">other</span><span class="s2">: </span><span class="s1">Path</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">if </span><span class="s1">file</span><span class="s2">.</span><span class="s1">is_symlink</span><span class="s2">():</span>
        <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">file</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">()) == </span><span class="s1">str</span><span class="s2">(</span><span class="s1">other</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">())</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">file_stat </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">()</span>
        <span class="s1">other_stat </span><span class="s2">= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">file_stat</span><span class="s2">[</span><span class="s1">stat</span><span class="s2">.</span><span class="s1">ST_INO</span><span class="s2">] == </span><span class="s1">other_stat</span><span class="s2">[</span><span class="s1">stat</span><span class="s2">.</span><span class="s1">ST_INO</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">file_stat</span><span class="s2">[</span><span class="s1">stat</span><span class="s2">.</span><span class="s1">ST_DEV</span><span class="s2">] == </span><span class="s1">other_stat</span><span class="s2">[</span><span class="s1">stat</span><span class="s2">.</span><span class="s1">ST_DEV</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">comparable_path</span><span class="s2">(</span><span class="s1">str_with_path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s0">return </span><span class="s1">str_with_path</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">().</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">, </span><span class="s3">&quot;/&quot;</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">&quot;//&quot;</span><span class="s2">, </span><span class="s3">&quot;/&quot;</span><span class="s2">)</span>
</pre>
</body>
</html>