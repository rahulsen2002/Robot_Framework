<html>
<head>
<title>_deprecate.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_deprecate.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">wraps</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">TYPE_CHECKING</span><span class="s2">, </span><span class="s1">ClassVar</span><span class="s2">, </span><span class="s1">TypeVar</span>

<span class="s0">import </span><span class="s1">attrs</span>

<span class="s0">if </span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc </span><span class="s0">import </span><span class="s1">Callable</span>

    <span class="s0">from </span><span class="s1">typing_extensions </span><span class="s0">import </span><span class="s1">ParamSpec</span>

    <span class="s1">ArgsT </span><span class="s2">= </span><span class="s1">ParamSpec</span><span class="s2">(</span><span class="s3">&quot;ArgsT&quot;</span><span class="s2">)</span>

<span class="s1">RetT </span><span class="s2">= </span><span class="s1">TypeVar</span><span class="s2">(</span><span class="s3">&quot;RetT&quot;</span><span class="s2">)</span>


<span class="s4"># We want our warnings to be visible by default (at least for now), but we</span>
<span class="s4"># also want it to be possible to override that using the -W switch. AFAICT</span>
<span class="s4"># this means we cannot inherit from DeprecationWarning, because the only way</span>
<span class="s4"># to make it visible by default then would be to add our own filter at import</span>
<span class="s4"># time, but that would override -W switches...</span>
<span class="s0">class </span><span class="s1">TrioDeprecationWarning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Warning emitted if you use deprecated Trio functionality. 
 
    While a relatively mature project, Trio remains committed to refining its 
    design and improving usability. As part of this, we occasionally deprecate 
    or remove functionality that proves suboptimal. If you use Trio, we 
    recommend `subscribing to issue #1 
    &lt;https://github.com/python-trio/trio/issues/1&gt;`__ to get information about 
    upcoming deprecations and other backwards compatibility breaking changes. 
 
    Despite the name, this class currently inherits from 
    :class:`FutureWarning`, not :class:`DeprecationWarning`, because until a 
    1.0 release, we want these warnings to be visible by default. You can hide 
    them by installing a filter or with the ``-W`` switch: see the 
    :mod:`warnings` documentation for details. 
    &quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">_url_for_issue</span><span class="s2">(</span><span class="s1">issue</span><span class="s2">: </span><span class="s1">int</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s0">return </span><span class="s3">f&quot;https://github.com/python-trio/trio/issues/</span><span class="s0">{</span><span class="s1">issue</span><span class="s0">}</span><span class="s3">&quot;</span>


<span class="s0">def </span><span class="s1">_stringify</span><span class="s2">(</span><span class="s1">thing</span><span class="s2">: </span><span class="s1">object</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">thing</span><span class="s2">, </span><span class="s3">&quot;__module__&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">thing</span><span class="s2">, </span><span class="s3">&quot;__qualname__&quot;</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">thing</span><span class="s2">.</span><span class="s1">__module__</span><span class="s0">}</span><span class="s3">.</span><span class="s0">{</span><span class="s1">thing</span><span class="s2">.</span><span class="s1">__qualname__</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s0">return </span><span class="s1">str</span><span class="s2">(</span><span class="s1">thing</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">warn_deprecated</span><span class="s2">(</span>
    <span class="s1">thing</span><span class="s2">: </span><span class="s1">object</span><span class="s2">,</span>
    <span class="s1">version</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s2">*,</span>
    <span class="s1">issue</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">instead</span><span class="s2">: </span><span class="s1">object</span><span class="s2">,</span>
    <span class="s1">stacklevel</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">2</span><span class="s2">,</span>
    <span class="s1">use_triodeprecationwarning</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">stacklevel </span><span class="s2">+= </span><span class="s6">1</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">_stringify</span><span class="s2">(</span><span class="s1">thing</span><span class="s2">)</span><span class="s0">} </span><span class="s3">is deprecated since Trio </span><span class="s0">{</span><span class="s1">version</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s0">if </span><span class="s1">instead </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">+= </span><span class="s3">&quot; with no replacement&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">+= </span><span class="s3">f&quot;; use </span><span class="s0">{</span><span class="s1">_stringify</span><span class="s2">(</span><span class="s1">instead</span><span class="s2">)</span><span class="s0">} </span><span class="s3">instead&quot;</span>
    <span class="s0">if </span><span class="s1">issue </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">+= </span><span class="s3">f&quot; (</span><span class="s0">{</span><span class="s1">_url_for_issue</span><span class="s2">(</span><span class="s1">issue</span><span class="s2">)</span><span class="s0">}</span><span class="s3">)&quot;</span>
    <span class="s0">if </span><span class="s1">use_triodeprecationwarning</span><span class="s2">:</span>
        <span class="s1">warning_class</span><span class="s2">: </span><span class="s1">type</span><span class="s2">[</span><span class="s1">Warning</span><span class="s2">] = </span><span class="s1">TrioDeprecationWarning</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">warning_class </span><span class="s2">= </span><span class="s1">DeprecationWarning</span>
    <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s1">warning_class</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">), </span><span class="s1">stacklevel</span><span class="s2">=</span><span class="s1">stacklevel</span><span class="s2">)</span>


<span class="s4"># @deprecated(&quot;0.2.0&quot;, issue=..., instead=...)</span>
<span class="s4"># def ...</span>
<span class="s0">def </span><span class="s1">deprecated</span><span class="s2">(</span>
    <span class="s1">version</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s2">*,</span>
    <span class="s1">thing</span><span class="s2">: </span><span class="s1">object </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">issue</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">instead</span><span class="s2">: </span><span class="s1">object</span><span class="s2">,</span>
    <span class="s1">use_triodeprecationwarning</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; Callable</span><span class="s2">[[</span><span class="s1">Callable</span><span class="s2">[</span><span class="s1">ArgsT</span><span class="s2">, </span><span class="s1">RetT</span><span class="s2">]], </span><span class="s1">Callable</span><span class="s2">[</span><span class="s1">ArgsT</span><span class="s2">, </span><span class="s1">RetT</span><span class="s2">]]:</span>
    <span class="s0">def </span><span class="s1">do_wrap</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">: </span><span class="s1">Callable</span><span class="s2">[</span><span class="s1">ArgsT</span><span class="s2">, </span><span class="s1">RetT</span><span class="s2">]) </span><span class="s1">-&gt; Callable</span><span class="s2">[</span><span class="s1">ArgsT</span><span class="s2">, </span><span class="s1">RetT</span><span class="s2">]:</span>
        <span class="s0">nonlocal </span><span class="s1">thing</span>

        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">wrapper</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">ArgsT</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">: </span><span class="s1">ArgsT</span><span class="s2">.</span><span class="s1">kwargs</span><span class="s2">) </span><span class="s1">-&gt; RetT</span><span class="s2">:</span>
            <span class="s1">warn_deprecated</span><span class="s2">(</span>
                <span class="s1">thing</span><span class="s2">,</span>
                <span class="s1">version</span><span class="s2">,</span>
                <span class="s1">instead</span><span class="s2">=</span><span class="s1">instead</span><span class="s2">,</span>
                <span class="s1">issue</span><span class="s2">=</span><span class="s1">issue</span><span class="s2">,</span>
                <span class="s1">use_triodeprecationwarning</span><span class="s2">=</span><span class="s1">use_triodeprecationwarning</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s4"># If our __module__ or __qualname__ get modified, we want to pick up</span>
        <span class="s4"># on that, so we read them off the wrapper object instead of the (now</span>
        <span class="s4"># hidden) fn object</span>
        <span class="s0">if </span><span class="s1">thing </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">thing </span><span class="s2">= </span><span class="s1">wrapper</span>

        <span class="s0">if </span><span class="s1">wrapper</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">doc </span><span class="s2">= </span><span class="s1">wrapper</span><span class="s2">.</span><span class="s1">__doc__</span>
            <span class="s1">doc </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">()</span>
            <span class="s1">doc </span><span class="s2">+= </span><span class="s3">&quot;</span><span class="s0">\n\n</span><span class="s3">&quot;</span>
            <span class="s1">doc </span><span class="s2">+= </span><span class="s3">f&quot;.. deprecated:: </span><span class="s0">{</span><span class="s1">version</span><span class="s0">}\n</span><span class="s3">&quot;</span>
            <span class="s0">if </span><span class="s1">instead </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">doc </span><span class="s2">+= </span><span class="s3">f&quot;   Use </span><span class="s0">{</span><span class="s1">_stringify</span><span class="s2">(</span><span class="s1">instead</span><span class="s2">)</span><span class="s0">} </span><span class="s3">instead.</span><span class="s0">\n</span><span class="s3">&quot;</span>
            <span class="s0">if </span><span class="s1">issue </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">doc </span><span class="s2">+= </span><span class="s3">f&quot;   For details, see `issue #</span><span class="s0">{</span><span class="s1">issue</span><span class="s0">} </span><span class="s3">&lt;</span><span class="s0">{</span><span class="s1">_url_for_issue</span><span class="s2">(</span><span class="s1">issue</span><span class="s2">)</span><span class="s0">}</span><span class="s3">&gt;`__.</span><span class="s0">\n</span><span class="s3">&quot;</span>
            <span class="s1">doc </span><span class="s2">+= </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span>
            <span class="s1">wrapper</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">doc</span>

        <span class="s0">return </span><span class="s1">wrapper</span>

    <span class="s0">return </span><span class="s1">do_wrap</span>


<span class="s0">def </span><span class="s1">deprecated_alias</span><span class="s2">(</span>
    <span class="s1">old_qualname</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">new_fn</span><span class="s2">: </span><span class="s1">Callable</span><span class="s2">[</span><span class="s1">ArgsT</span><span class="s2">, </span><span class="s1">RetT</span><span class="s2">],</span>
    <span class="s1">version</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s2">*,</span>
    <span class="s1">issue</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s0">None</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; Callable</span><span class="s2">[</span><span class="s1">ArgsT</span><span class="s2">, </span><span class="s1">RetT</span><span class="s2">]:</span>
    <span class="s2">@</span><span class="s1">deprecated</span><span class="s2">(</span><span class="s1">version</span><span class="s2">, </span><span class="s1">issue</span><span class="s2">=</span><span class="s1">issue</span><span class="s2">, </span><span class="s1">instead</span><span class="s2">=</span><span class="s1">new_fn</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">new_fn</span><span class="s2">, </span><span class="s1">assigned</span><span class="s2">=(</span><span class="s3">&quot;__module__&quot;</span><span class="s2">, </span><span class="s3">&quot;__annotations__&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">wrapper</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">ArgsT</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">: </span><span class="s1">ArgsT</span><span class="s2">.</span><span class="s1">kwargs</span><span class="s2">) </span><span class="s1">-&gt; RetT</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Deprecated alias.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">new_fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s1">wrapper</span><span class="s2">.</span><span class="s1">__qualname__ </span><span class="s2">= </span><span class="s1">old_qualname</span>
    <span class="s1">wrapper</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s2">= </span><span class="s1">old_qualname</span><span class="s2">.</span><span class="s1">rpartition</span><span class="s2">(</span><span class="s3">&quot;.&quot;</span><span class="s2">)[-</span><span class="s6">1</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s1">wrapper</span>


<span class="s2">@</span><span class="s1">attrs</span><span class="s2">.</span><span class="s1">frozen</span><span class="s2">(</span><span class="s1">slots</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">DeprecatedAttribute</span><span class="s2">:</span>
    <span class="s1">_not_set</span><span class="s2">: </span><span class="s1">ClassVar</span><span class="s2">[</span><span class="s1">object</span><span class="s2">] = </span><span class="s1">object</span><span class="s2">()</span>

    <span class="s1">value</span><span class="s2">: </span><span class="s1">object</span>
    <span class="s1">version</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">issue</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s0">None</span>
    <span class="s1">instead</span><span class="s2">: </span><span class="s1">object </span><span class="s2">= </span><span class="s1">_not_set</span>


<span class="s0">def </span><span class="s1">deprecate_attributes</span><span class="s2">(</span>
    <span class="s1">module_name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">deprecated_attributes</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">DeprecatedAttribute</span><span class="s2">]</span>
<span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; object</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">deprecated_attributes</span><span class="s2">:</span>
            <span class="s1">info </span><span class="s2">= </span><span class="s1">deprecated_attributes</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
            <span class="s1">instead </span><span class="s2">= </span><span class="s1">info</span><span class="s2">.</span><span class="s1">instead</span>
            <span class="s0">if </span><span class="s1">instead </span><span class="s0">is </span><span class="s1">DeprecatedAttribute</span><span class="s2">.</span><span class="s1">_not_set</span><span class="s2">:</span>
                <span class="s1">instead </span><span class="s2">= </span><span class="s1">info</span><span class="s2">.</span><span class="s1">value</span>
            <span class="s1">thing </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">module_name</span><span class="s0">}</span><span class="s3">.</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s1">warn_deprecated</span><span class="s2">(</span><span class="s1">thing</span><span class="s2">, </span><span class="s1">info</span><span class="s2">.</span><span class="s1">version</span><span class="s2">, </span><span class="s1">issue</span><span class="s2">=</span><span class="s1">info</span><span class="s2">.</span><span class="s1">issue</span><span class="s2">, </span><span class="s1">instead</span><span class="s2">=</span><span class="s1">instead</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">info</span><span class="s2">.</span><span class="s1">value</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;module '{}' has no attribute '{}'&quot;</span>
        <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">module_name</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>

    <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s1">module_name</span><span class="s2">].</span><span class="s1">__getattr__ </span><span class="s2">= </span><span class="s1">__getattr__  </span><span class="s4"># type: ignore[method-assign]</span>
</pre>
</body>
</html>