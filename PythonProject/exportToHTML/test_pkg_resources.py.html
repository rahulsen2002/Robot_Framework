<html>
<head>
<title>test_pkg_resources.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_pkg_resources.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">builtins</span>
<span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">inspect</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">plistlib</span>
<span class="s0">import </span><span class="s1">stat</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">tempfile</span>
<span class="s0">import </span><span class="s1">zipfile</span>
<span class="s0">from </span><span class="s1">unittest </span><span class="s0">import </span><span class="s1">mock</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pkg_resources</span>
<span class="s0">from </span><span class="s1">pkg_resources </span><span class="s0">import </span><span class="s1">DistInfoDistribution</span><span class="s2">, </span><span class="s1">Distribution</span><span class="s2">, </span><span class="s1">EggInfoDistribution</span>

<span class="s0">import </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">command</span><span class="s2">.</span><span class="s1">install_egg_info</span>
<span class="s0">import </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">dist</span>


<span class="s0">class </span><span class="s1">EggRemover</span><span class="s2">(</span><span class="s1">str</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestZipProvider</span><span class="s2">:</span>
    <span class="s1">finalizers</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">EggRemover</span><span class="s2">] = []</span>

    <span class="s1">ref_time </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">25</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s4">&quot;A reference time for a file modification&quot;</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s5">&quot;create a zip egg and add it to sys.path&quot;</span>
        <span class="s1">egg </span><span class="s2">= </span><span class="s1">tempfile</span><span class="s2">.</span><span class="s1">NamedTemporaryFile</span><span class="s2">(</span><span class="s1">suffix</span><span class="s2">=</span><span class="s4">'.egg'</span><span class="s2">, </span><span class="s1">delete</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">zip_egg </span><span class="s2">= </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">egg</span><span class="s2">, </span><span class="s4">'w'</span><span class="s2">)</span>
        <span class="s1">zip_info </span><span class="s2">= </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">ZipInfo</span><span class="s2">()</span>
        <span class="s1">zip_info</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s4">'mod.py'</span>
        <span class="s1">zip_info</span><span class="s2">.</span><span class="s1">date_time </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">ref_time</span><span class="s2">.</span><span class="s1">timetuple</span><span class="s2">()</span>
        <span class="s1">zip_egg</span><span class="s2">.</span><span class="s1">writestr</span><span class="s2">(</span><span class="s1">zip_info</span><span class="s2">, </span><span class="s4">'x = 3</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">)</span>
        <span class="s1">zip_info </span><span class="s2">= </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">ZipInfo</span><span class="s2">()</span>
        <span class="s1">zip_info</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s4">'data.dat'</span>
        <span class="s1">zip_info</span><span class="s2">.</span><span class="s1">date_time </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">ref_time</span><span class="s2">.</span><span class="s1">timetuple</span><span class="s2">()</span>
        <span class="s1">zip_egg</span><span class="s2">.</span><span class="s1">writestr</span><span class="s2">(</span><span class="s1">zip_info</span><span class="s2">, </span><span class="s4">'hello, world!'</span><span class="s2">)</span>
        <span class="s1">zip_info </span><span class="s2">= </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">ZipInfo</span><span class="s2">()</span>
        <span class="s1">zip_info</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s4">'subdir/mod2.py'</span>
        <span class="s1">zip_info</span><span class="s2">.</span><span class="s1">date_time </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">ref_time</span><span class="s2">.</span><span class="s1">timetuple</span><span class="s2">()</span>
        <span class="s1">zip_egg</span><span class="s2">.</span><span class="s1">writestr</span><span class="s2">(</span><span class="s1">zip_info</span><span class="s2">, </span><span class="s4">'x = 6</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">)</span>
        <span class="s1">zip_info </span><span class="s2">= </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">ZipInfo</span><span class="s2">()</span>
        <span class="s1">zip_info</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s4">'subdir/data2.dat'</span>
        <span class="s1">zip_info</span><span class="s2">.</span><span class="s1">date_time </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">ref_time</span><span class="s2">.</span><span class="s1">timetuple</span><span class="s2">()</span>
        <span class="s1">zip_egg</span><span class="s2">.</span><span class="s1">writestr</span><span class="s2">(</span><span class="s1">zip_info</span><span class="s2">, </span><span class="s4">'goodbye, world!'</span><span class="s2">)</span>
        <span class="s1">zip_egg</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">egg</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">egg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">subdir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">egg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s4">'subdir'</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">subdir</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">finalizers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">EggRemover</span><span class="s2">(</span><span class="s1">subdir</span><span class="s2">))</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">finalizers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">EggRemover</span><span class="s2">(</span><span class="s1">egg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">teardown_class</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">finalizer </span><span class="s0">in </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">finalizers</span><span class="s2">:</span>
            <span class="s1">finalizer</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_resource_listdir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">import </span><span class="s1">mod  </span><span class="s6"># pyright: ignore[reportMissingImports] # Temporary package for test</span>

        <span class="s1">zp </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">ZipProvider</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">)</span>

        <span class="s1">expected_root </span><span class="s2">= [</span><span class="s4">'data.dat'</span><span class="s2">, </span><span class="s4">'mod.py'</span><span class="s2">, </span><span class="s4">'subdir'</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">zp</span><span class="s2">.</span><span class="s1">resource_listdir</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)) == </span><span class="s1">expected_root</span>

        <span class="s1">expected_subdir </span><span class="s2">= [</span><span class="s4">'data2.dat'</span><span class="s2">, </span><span class="s4">'mod2.py'</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">zp</span><span class="s2">.</span><span class="s1">resource_listdir</span><span class="s2">(</span><span class="s4">'subdir'</span><span class="s2">)) == </span><span class="s1">expected_subdir</span>
        <span class="s0">assert </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">zp</span><span class="s2">.</span><span class="s1">resource_listdir</span><span class="s2">(</span><span class="s4">'subdir/'</span><span class="s2">)) == </span><span class="s1">expected_subdir</span>

        <span class="s0">assert </span><span class="s1">zp</span><span class="s2">.</span><span class="s1">resource_listdir</span><span class="s2">(</span><span class="s4">'nonexistent'</span><span class="s2">) == []</span>
        <span class="s0">assert </span><span class="s1">zp</span><span class="s2">.</span><span class="s1">resource_listdir</span><span class="s2">(</span><span class="s4">'nonexistent/'</span><span class="s2">) == []</span>

        <span class="s0">import </span><span class="s1">mod2  </span><span class="s6"># pyright: ignore[reportMissingImports] # Temporary package for test</span>

        <span class="s1">zp2 </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">ZipProvider</span><span class="s2">(</span><span class="s1">mod2</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">zp2</span><span class="s2">.</span><span class="s1">resource_listdir</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)) == </span><span class="s1">expected_subdir</span>

        <span class="s0">assert </span><span class="s1">zp2</span><span class="s2">.</span><span class="s1">resource_listdir</span><span class="s2">(</span><span class="s4">'subdir'</span><span class="s2">) == []</span>
        <span class="s0">assert </span><span class="s1">zp2</span><span class="s2">.</span><span class="s1">resource_listdir</span><span class="s2">(</span><span class="s4">'subdir/'</span><span class="s2">) == []</span>

    <span class="s0">def </span><span class="s1">test_resource_filename_rewrites_on_change</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        If a previous call to get_resource_filename has saved the file, but 
        the file has been subsequently mutated with different file of the 
        same size and modification time, it should not be overwritten on a 
        subsequent call to get_resource_filename. 
        &quot;&quot;&quot;</span>
        <span class="s0">import </span><span class="s1">mod  </span><span class="s6"># pyright: ignore[reportMissingImports] # Temporary package for test</span>

        <span class="s1">manager </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">ResourceManager</span><span class="s2">()</span>
        <span class="s1">zp </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">ZipProvider</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">)</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s1">zp</span><span class="s2">.</span><span class="s1">get_resource_filename</span><span class="s2">(</span><span class="s1">manager</span><span class="s2">, </span><span class="s4">'data.dat'</span><span class="s2">)</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">fromtimestamp</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">).</span><span class="s1">st_mtime</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">actual </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ref_time</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s4">'w'</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">'hello, world?'</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">ts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ref_time</span><span class="s2">.</span><span class="s1">timestamp</span><span class="s2">()</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">utime</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, (</span><span class="s1">ts</span><span class="s2">, </span><span class="s1">ts</span><span class="s2">))</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s1">zp</span><span class="s2">.</span><span class="s1">get_resource_filename</span><span class="s2">(</span><span class="s1">manager</span><span class="s2">, </span><span class="s4">'data.dat'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">() == </span><span class="s4">'hello, world!'</span>
        <span class="s1">manager</span><span class="s2">.</span><span class="s1">cleanup_resources</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestResourceManager</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_get_cache_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">mgr </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">ResourceManager</span><span class="s2">()</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">mgr</span><span class="s2">.</span><span class="s1">get_cache_path</span><span class="s2">(</span><span class="s4">'foo'</span><span class="s2">)</span>
        <span class="s1">type_ </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>
        <span class="s1">message </span><span class="s2">= </span><span class="s4">&quot;Unexpected type from get_cache_path: &quot; </span><span class="s2">+ </span><span class="s1">type_</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">str</span><span class="s2">), </span><span class="s1">message</span>

    <span class="s0">def </span><span class="s1">test_get_cache_path_race</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">):</span>
        <span class="s6"># Patch to os.path.isdir to create a race condition</span>
        <span class="s0">def </span><span class="s1">patched_isdir</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">unpatched_isdir</span><span class="s2">=</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">):</span>
            <span class="s1">patched_isdir</span><span class="s2">.</span><span class="s1">dirnames</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>

            <span class="s1">was_dir </span><span class="s2">= </span><span class="s1">unpatched_isdir</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">was_dir</span><span class="s2">:</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">was_dir</span>

        <span class="s1">patched_isdir</span><span class="s2">.</span><span class="s1">dirnames </span><span class="s2">= []</span>

        <span class="s6"># Get a cache path with a &quot;race condition&quot;</span>
        <span class="s1">mgr </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">ResourceManager</span><span class="s2">()</span>
        <span class="s1">mgr</span><span class="s2">.</span><span class="s1">set_extraction_path</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">))</span>

        <span class="s1">archive_name </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">.</span><span class="s1">join</span><span class="s2">((</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s4">'bar'</span><span class="s2">, </span><span class="s4">'baz'</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">mock</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">object</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">, </span><span class="s4">'isdir'</span><span class="s2">, </span><span class="s1">new</span><span class="s2">=</span><span class="s1">patched_isdir</span><span class="s2">):</span>
            <span class="s1">mgr</span><span class="s2">.</span><span class="s1">get_cache_path</span><span class="s2">(</span><span class="s1">archive_name</span><span class="s2">)</span>

        <span class="s6"># Because this test relies on the implementation details of this</span>
        <span class="s6"># function, these assertions are a sentinel to ensure that the</span>
        <span class="s6"># test suite will not fail silently if the implementation changes.</span>
        <span class="s1">called_dirnames </span><span class="s2">= </span><span class="s1">patched_isdir</span><span class="s2">.</span><span class="s1">dirnames</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">called_dirnames</span><span class="s2">) == </span><span class="s3">2</span>
        <span class="s0">assert </span><span class="s1">called_dirnames</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">)[-</span><span class="s3">2</span><span class="s2">:] == [</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s4">'bar'</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">called_dirnames</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">)[-</span><span class="s3">1</span><span class="s2">:] == [</span><span class="s4">'foo'</span><span class="s2">]</span>

    <span class="s4">&quot;&quot;&quot; 
    Tests to ensure that pkg_resources runs independently from setuptools. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">test_setuptools_not_imported</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        In a separate Python environment, import pkg_resources and assert 
        that action doesn't cause setuptools to be imported. 
        &quot;&quot;&quot;</span>
        <span class="s1">lines </span><span class="s2">= (</span>
            <span class="s4">'import pkg_resources'</span><span class="s2">,</span>
            <span class="s4">'import sys'</span><span class="s2">,</span>
            <span class="s2">(</span><span class="s4">'assert &quot;setuptools&quot; not in sys.modules, &quot;setuptools was imported&quot;'</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">cmd </span><span class="s2">= [</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">, </span><span class="s4">'-c'</span><span class="s2">, </span><span class="s4">'; '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)]</span>
        <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_call</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">make_test_distribution</span><span class="s2">(</span><span class="s1">metadata_path</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Make a test Distribution object, and return it. 
 
    :param metadata_path: the path to the metadata file that should be 
        created. This should be inside a distribution directory that should 
        also be created. For example, an argument value might end with 
        &quot;&lt;project&gt;.dist-info/METADATA&quot;. 
    :param metadata: the desired contents of the metadata file, as bytes. 
    &quot;&quot;&quot;</span>
    <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">metadata_path</span><span class="s2">)</span>
    <span class="s1">os</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">metadata_path</span><span class="s2">, </span><span class="s4">'wb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">)</span>
    <span class="s1">dists </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">distributions_from_metadata</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">))</span>
    <span class="s2">(</span><span class="s1">dist</span><span class="s2">,) = </span><span class="s1">dists</span>

    <span class="s0">return </span><span class="s1">dist</span>


<span class="s0">def </span><span class="s1">test_get_metadata__bad_utf8</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Test a metadata file with bytes that can't be decoded as utf-8. 
    &quot;&quot;&quot;</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s4">'METADATA'</span>
    <span class="s6"># Convert the tmpdir LocalPath object to a string before joining.</span>
    <span class="s1">metadata_path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">), </span><span class="s4">'foo.dist-info'</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>
    <span class="s6"># Encode a non-ascii string with the wrong encoding (not utf-8).</span>
    <span class="s1">metadata </span><span class="s2">= </span><span class="s4">'née'</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">'iso-8859-1'</span><span class="s2">)</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">make_test_distribution</span><span class="s2">(</span><span class="s1">metadata_path</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">metadata</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">UnicodeDecodeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s1">dist</span><span class="s2">.</span><span class="s1">get_metadata</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

    <span class="s1">exc </span><span class="s2">= </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= (</span>
        <span class="s6"># The error message starts with &quot;'utf-8' codec ...&quot; However, the</span>
        <span class="s6"># spelling of &quot;utf-8&quot; can vary (e.g. &quot;utf8&quot;) so we don't include it</span>
        <span class="s4">&quot;codec can't decode byte 0xe9 in position 1: &quot;</span>
        <span class="s4">'invalid continuation byte in METADATA file at path: '</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">actual</span><span class="s2">, </span><span class="s4">f'actual: </span><span class="s0">{</span><span class="s1">actual</span><span class="s0">}</span><span class="s4">'</span>
    <span class="s0">assert </span><span class="s1">actual</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">metadata_path</span><span class="s2">), </span><span class="s4">f'actual: </span><span class="s0">{</span><span class="s1">actual</span><span class="s0">}</span><span class="s4">'</span>


<span class="s0">def </span><span class="s1">make_distribution_no_version</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">basename</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Create a distribution directory with no file containing the version. 
    &quot;&quot;&quot;</span>
    <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s1">basename</span>
    <span class="s1">dist_dir</span><span class="s2">.</span><span class="s1">ensure_dir</span><span class="s2">()</span>
    <span class="s6"># Make the directory non-empty so distributions_from_metadata()</span>
    <span class="s6"># will detect it and yield it.</span>
    <span class="s1">dist_dir</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">'temp.txt'</span><span class="s2">).</span><span class="s1">ensure</span><span class="s2">()</span>

    <span class="s1">dists </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">distributions_from_metadata</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dists</span><span class="s2">) == </span><span class="s3">1</span>
    <span class="s2">(</span><span class="s1">dist</span><span class="s2">,) = </span><span class="s1">dists</span>

    <span class="s0">return </span><span class="s1">dist</span><span class="s2">, </span><span class="s1">dist_dir</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s4">&quot;suffix&quot;</span><span class="s2">, </span><span class="s4">&quot;expected_filename&quot;</span><span class="s2">, </span><span class="s4">&quot;expected_dist_type&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">'egg-info'</span><span class="s2">, </span><span class="s4">'PKG-INFO'</span><span class="s2">, </span><span class="s1">EggInfoDistribution</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">'dist-info'</span><span class="s2">, </span><span class="s4">'METADATA'</span><span class="s2">, </span><span class="s1">DistInfoDistribution</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[:</span><span class="s3">2</span><span class="s2">] == (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">) </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">.</span><span class="s1">releaselevel </span><span class="s2">!= </span><span class="s4">'final'</span><span class="s2">,</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;https://github.com/python/cpython/issues/103632&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_distribution_version_missing</span><span class="s2">(</span>
    <span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">suffix</span><span class="s2">, </span><span class="s1">expected_filename</span><span class="s2">, </span><span class="s1">expected_dist_type</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Test Distribution.version when the &quot;Version&quot; header is missing. 
    &quot;&quot;&quot;</span>
    <span class="s1">basename </span><span class="s2">= </span><span class="s4">f'foo.</span><span class="s0">{</span><span class="s1">suffix</span><span class="s0">}</span><span class="s4">'</span>
    <span class="s1">dist</span><span class="s2">, </span><span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">make_distribution_no_version</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">basename</span><span class="s2">)</span>

    <span class="s1">expected_text </span><span class="s2">= (</span>
        <span class="s4">f&quot;Missing 'Version:' header and/or </span><span class="s0">{</span><span class="s1">expected_filename</span><span class="s0">} </span><span class="s4">file at path: &quot;</span>
    <span class="s2">)</span>
    <span class="s1">metadata_path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">, </span><span class="s1">expected_filename</span><span class="s2">)</span>

    <span class="s6"># Now check the exception raised when the &quot;version&quot; attribute is accessed.</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s1">dist</span><span class="s2">.</span><span class="s1">version</span>

    <span class="s1">err </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
    <span class="s6"># Include a string expression after the assert so the full strings</span>
    <span class="s6"># will be visible for inspection on failure.</span>
    <span class="s0">assert </span><span class="s1">expected_text </span><span class="s0">in </span><span class="s1">err</span><span class="s2">, </span><span class="s1">str</span><span class="s2">((</span><span class="s1">expected_text</span><span class="s2">, </span><span class="s1">err</span><span class="s2">))</span>

    <span class="s6"># Also check the args passed to the ValueError.</span>
    <span class="s1">msg</span><span class="s2">, </span><span class="s1">dist </span><span class="s2">= </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">args</span>
    <span class="s0">assert </span><span class="s1">expected_text </span><span class="s0">in </span><span class="s1">msg</span>
    <span class="s6"># Check that the message portion contains the path.</span>
    <span class="s0">assert </span><span class="s1">metadata_path </span><span class="s0">in </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">str</span><span class="s2">((</span><span class="s1">metadata_path</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">) </span><span class="s0">is </span><span class="s1">expected_dist_type</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[:</span><span class="s3">2</span><span class="s2">] == (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">) </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">.</span><span class="s1">releaselevel </span><span class="s2">!= </span><span class="s4">'final'</span><span class="s2">,</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;https://github.com/python/cpython/issues/103632&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_distribution_version_missing_undetected_path</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot; 
    Test Distribution.version when the &quot;Version&quot; header is missing and 
    the path can't be detected. 
    &quot;&quot;&quot;</span>
    <span class="s6"># Create a Distribution object with no metadata argument, which results</span>
    <span class="s6"># in an empty metadata provider.</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">(</span><span class="s4">'/foo'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s1">dist</span><span class="s2">.</span><span class="s1">version</span>

    <span class="s1">msg</span><span class="s2">, </span><span class="s1">dist </span><span class="s2">= </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">args</span>
    <span class="s1">expected </span><span class="s2">= (</span>
        <span class="s4">&quot;Missing 'Version:' header and/or PKG-INFO file at path: [could not detect]&quot;</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">msg </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'only'</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_dist_info_is_not_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">only</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Test path containing a file with dist-info extension.&quot;&quot;&quot;</span>
    <span class="s1">dist_info </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">'foobar.dist-info'</span>
    <span class="s1">dist_info</span><span class="s2">.</span><span class="s1">touch</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">dist_factory</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">), </span><span class="s1">str</span><span class="s2">(</span><span class="s1">dist_info</span><span class="s2">), </span><span class="s1">only</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_macos_vers_fallback</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Regression test for pkg_resources._macos_vers&quot;&quot;&quot;</span>
    <span class="s1">orig_open </span><span class="s2">= </span><span class="s1">builtins</span><span class="s2">.</span><span class="s1">open</span>

    <span class="s6"># Pretend we need to use the plist file</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s4">'platform.mac_ver'</span><span class="s2">, </span><span class="s1">mock</span><span class="s2">.</span><span class="s1">Mock</span><span class="s2">(</span><span class="s1">return_value</span><span class="s2">=(</span><span class="s4">''</span><span class="s2">, (), </span><span class="s4">''</span><span class="s2">)))</span>

    <span class="s6"># Create fake content for the fake plist file</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">'fake.plist'</span><span class="s2">, </span><span class="s4">'wb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fake_file</span><span class="s2">:</span>
        <span class="s1">plistlib</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">({</span><span class="s4">&quot;ProductVersion&quot;</span><span class="s2">: </span><span class="s4">&quot;11.4&quot;</span><span class="s2">}, </span><span class="s1">fake_file</span><span class="s2">)</span>

    <span class="s6"># Pretend the fake file exists</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s4">'os.path.exists'</span><span class="s2">, </span><span class="s1">mock</span><span class="s2">.</span><span class="s1">Mock</span><span class="s2">(</span><span class="s1">return_value</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">fake_open</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">orig_open</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">'fake.plist'</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s6"># Ensure that the _macos_vers works correctly</span>
    <span class="s0">with </span><span class="s1">mock</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">(</span><span class="s4">'builtins.open'</span><span class="s2">, </span><span class="s1">mock</span><span class="s2">.</span><span class="s1">Mock</span><span class="s2">(</span><span class="s1">side_effect</span><span class="s2">=</span><span class="s1">fake_open</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">m</span><span class="s2">:</span>
        <span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_macos_vers</span><span class="s2">.</span><span class="s1">cache_clear</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_macos_vers</span><span class="s2">() == [</span><span class="s4">&quot;11&quot;</span><span class="s2">, </span><span class="s4">&quot;4&quot;</span><span class="s2">]</span>
        <span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_macos_vers</span><span class="s2">.</span><span class="s1">cache_clear</span><span class="s2">()</span>

    <span class="s1">m</span><span class="s2">.</span><span class="s1">assert_called</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestDeepVersionLookupDistutils</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">env</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Create a package environment, similar to a virtualenv, 
        in which packages are installed. 
        &quot;&quot;&quot;</span>

        <span class="s0">class </span><span class="s1">Environment</span><span class="s2">(</span><span class="s1">str</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s1">env </span><span class="s2">= </span><span class="s1">Environment</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">)</span>
        <span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">chmod</span><span class="s2">(</span><span class="s1">stat</span><span class="s2">.</span><span class="s1">S_IRWXU</span><span class="s2">)</span>
        <span class="s1">subs </span><span class="s2">= </span><span class="s4">'home'</span><span class="s2">, </span><span class="s4">'lib'</span><span class="s2">, </span><span class="s4">'scripts'</span><span class="s2">, </span><span class="s4">'data'</span><span class="s2">, </span><span class="s4">'egg-base'</span>
        <span class="s1">env</span><span class="s2">.</span><span class="s1">paths </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">((</span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s1">dirname</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">dirname </span><span class="s0">in </span><span class="s1">subs</span><span class="s2">)</span>
        <span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">, </span><span class="s1">env</span><span class="s2">.</span><span class="s1">paths</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()))</span>
        <span class="s0">return </span><span class="s1">env</span>

    <span class="s0">def </span><span class="s1">create_foo_pkg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">env</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Create a foo package installed (distutils-style) to env.paths['lib'] 
        as version. 
        &quot;&quot;&quot;</span>
        <span class="s1">ld </span><span class="s2">= </span><span class="s4">&quot;This package has unicode metadata! ❄&quot;</span>
        <span class="s1">attrs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">, </span><span class="s1">long_description</span><span class="s2">=</span><span class="s1">ld</span><span class="s2">)</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">Distribution</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s1">iei_cmd </span><span class="s2">= </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">command</span><span class="s2">.</span><span class="s1">install_egg_info</span><span class="s2">.</span><span class="s1">install_egg_info</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">iei_cmd</span><span class="s2">.</span><span class="s1">initialize_options</span><span class="s2">()</span>
        <span class="s1">iei_cmd</span><span class="s2">.</span><span class="s1">install_dir </span><span class="s2">= </span><span class="s1">env</span><span class="s2">.</span><span class="s1">paths</span><span class="s2">[</span><span class="s4">'lib'</span><span class="s2">]</span>
        <span class="s1">iei_cmd</span><span class="s2">.</span><span class="s1">finalize_options</span><span class="s2">()</span>
        <span class="s1">iei_cmd</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_version_resolved_from_egg_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">env</span><span class="s2">):</span>
        <span class="s1">version </span><span class="s2">= </span><span class="s4">'1.11.0.dev0+2329eae'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">create_foo_pkg</span><span class="s2">(</span><span class="s1">env</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>

        <span class="s6"># this requirement parsing will raise a VersionConflict unless the</span>
        <span class="s6"># .egg-info file is parsed (see #419 on BitBucket)</span>
        <span class="s1">req </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s4">'foo&gt;=1.9'</span><span class="s2">)</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">WorkingSet</span><span class="s2">([</span><span class="s1">env</span><span class="s2">.</span><span class="s1">paths</span><span class="s2">[</span><span class="s4">'lib'</span><span class="s2">]]).</span><span class="s1">find</span><span class="s2">(</span><span class="s1">req</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">version </span><span class="s2">== </span><span class="s1">version</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s4">&quot;unnormalized&quot;</span><span class="s2">, </span><span class="s4">&quot;normalized&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s4">'foo'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">'foo/'</span><span class="s2">, </span><span class="s4">'foo'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">'foo/bar'</span><span class="s2">, </span><span class="s4">'foo/bar'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">'foo/bar/'</span><span class="s2">, </span><span class="s4">'foo/bar'</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_normalize_path_trailing_sep</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">unnormalized</span><span class="s2">, </span><span class="s1">normalized</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Ensure the trailing slash is cleaned for path comparison. 
 
        See pypa/setuptools#1519. 
        &quot;&quot;&quot;</span>
        <span class="s1">result_from_unnormalized </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">normalize_path</span><span class="s2">(</span><span class="s1">unnormalized</span><span class="s2">)</span>
        <span class="s1">result_from_normalized </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">normalize_path</span><span class="s2">(</span><span class="s1">normalized</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result_from_unnormalized </span><span class="s2">== </span><span class="s1">result_from_normalized</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s4">'A'</span><span class="s2">) != </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">),</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s4">'Testing case-insensitive filesystems.'</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s4">&quot;unnormalized&quot;</span><span class="s2">, </span><span class="s4">&quot;normalized&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s4">'MiXeD/CasE'</span><span class="s2">, </span><span class="s4">'mixed/case'</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_normalize_path_normcase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">unnormalized</span><span class="s2">, </span><span class="s1">normalized</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Ensure mixed case is normalized on case-insensitive filesystems.&quot;&quot;&quot;</span>
        <span class="s1">result_from_unnormalized </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">normalize_path</span><span class="s2">(</span><span class="s1">unnormalized</span><span class="s2">)</span>
        <span class="s1">result_from_normalized </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">normalize_path</span><span class="s2">(</span><span class="s1">normalized</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result_from_unnormalized </span><span class="s2">== </span><span class="s1">result_from_normalized</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">sep </span><span class="s2">!= </span><span class="s4">'</span><span class="s0">\\</span><span class="s4">'</span><span class="s2">,</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s4">'Testing systems using backslashes as path separators.'</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s4">&quot;unnormalized&quot;</span><span class="s2">, </span><span class="s4">&quot;expected&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s4">'forward/slash'</span><span class="s2">, </span><span class="s4">'forward</span><span class="s0">\\</span><span class="s4">slash'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">'forward/slash/'</span><span class="s2">, </span><span class="s4">'forward</span><span class="s0">\\</span><span class="s4">slash'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">'backward</span><span class="s0">\\</span><span class="s4">slash</span><span class="s0">\\</span><span class="s4">'</span><span class="s2">, </span><span class="s4">'backward</span><span class="s0">\\</span><span class="s4">slash'</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_normalize_path_backslash_sep</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">unnormalized</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Ensure path seps are cleaned on backslash path sep systems.&quot;&quot;&quot;</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">normalize_path</span><span class="s2">(</span><span class="s1">unnormalized</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestWorkdirRequire</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">fake_site_packages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">dist_files</span><span class="s2">):</span>
        <span class="s1">site_packages </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;site-packages&quot;</span>
        <span class="s1">site_packages</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">file</span><span class="s2">, </span><span class="s1">content </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">site_packages </span><span class="s2">/ </span><span class="s1">file</span>
            <span class="s1">path</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parents</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">path</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">cleandoc</span><span class="s2">(</span><span class="s1">content</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">, </span><span class="s4">&quot;path&quot;</span><span class="s2">, [</span><span class="s1">site_packages</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">fspath</span><span class="s2">(</span><span class="s1">site_packages</span><span class="s2">)</span>

    <span class="s1">FILES </span><span class="s2">= {</span>
        <span class="s4">&quot;pkg1_mod-1.2.3.dist-info/METADATA&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;&quot; 
            Metadata-Version: 2.4 
            Name: pkg1.mod 
            Version: 1.2.3 
            &quot;&quot;&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;pkg2.mod-0.42.dist-info/METADATA&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;&quot; 
            Metadata-Version: 2.1 
            Name: pkg2.mod 
            Version: 0.42 
            &quot;&quot;&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;pkg3_mod.egg-info/PKG-INFO&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;&quot; 
            Name: pkg3.mod 
            Version: 1.2.3.4 
            &quot;&quot;&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;pkg4.mod.egg-info/PKG-INFO&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;&quot; 
            Name: pkg4.mod 
            Version: 0.42.1 
            &quot;&quot;&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s4">&quot;version&quot;</span><span class="s2">, </span><span class="s4">&quot;requirement&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s4">&quot;1.2.3&quot;</span><span class="s2">, </span><span class="s4">&quot;pkg1.mod&gt;=1&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;0.42&quot;</span><span class="s2">, </span><span class="s4">&quot;pkg2.mod&gt;=0.4&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;1.2.3.4&quot;</span><span class="s2">, </span><span class="s4">&quot;pkg3.mod&lt;=2&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;0.42.1&quot;</span><span class="s2">, </span><span class="s4">&quot;pkg4.mod&gt;0.2,&lt;1&quot;</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_require_non_normalised_name</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">requirement</span>
    <span class="s2">):</span>
        <span class="s6"># https://github.com/pypa/setuptools/issues/4853</span>
        <span class="s1">site_packages </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fake_site_packages</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">)</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">WorkingSet</span><span class="s2">([</span><span class="s1">site_packages</span><span class="s2">])</span>

        <span class="s0">for </span><span class="s1">req </span><span class="s0">in </span><span class="s2">[</span><span class="s1">requirement</span><span class="s2">, </span><span class="s1">requirement</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;.&quot;</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">)]:</span>
            <span class="s2">[</span><span class="s1">dist</span><span class="s2">] = </span><span class="s1">ws</span><span class="s2">.</span><span class="s1">require</span><span class="s2">(</span><span class="s1">req</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">version </span><span class="s2">== </span><span class="s1">version</span>
            <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">samefile</span><span class="s2">(</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">commonpath</span><span class="s2">([</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">location</span><span class="s2">, </span><span class="s1">site_packages</span><span class="s2">]), </span><span class="s1">site_packages</span>
            <span class="s2">)</span>
</pre>
</body>
</html>