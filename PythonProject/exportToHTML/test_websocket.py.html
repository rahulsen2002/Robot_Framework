<html>
<head>
<title>test_websocket.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_websocket.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s0">#</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span>
<span class="s2">import </span><span class="s1">socket</span>
<span class="s2">import </span><span class="s1">unittest</span>
<span class="s2">from </span><span class="s1">base64 </span><span class="s2">import </span><span class="s1">decodebytes </span><span class="s2">as </span><span class="s1">base64decode</span>

<span class="s2">import </span><span class="s1">websocket </span><span class="s2">as </span><span class="s1">ws</span>
<span class="s2">from </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_exceptions </span><span class="s2">import </span><span class="s1">WebSocketBadStatusException</span><span class="s3">, </span><span class="s1">WebSocketAddressException</span>
<span class="s2">from </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_handshake </span><span class="s2">import </span><span class="s1">_create_sec_websocket_key</span>
<span class="s2">from </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_handshake </span><span class="s2">import </span><span class="s1">_validate </span><span class="s2">as </span><span class="s1">_validate_header</span>
<span class="s2">from </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_http </span><span class="s2">import </span><span class="s1">read_headers</span>
<span class="s2">from </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_utils </span><span class="s2">import </span><span class="s1">validate_utf8</span>

<span class="s4">&quot;&quot;&quot; 
test_websocket.py 
websocket - WebSocket client library for Python 
 
Copyright 2024 engn33r 
 
Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); 
you may not use this file except in compliance with the License. 
You may obtain a copy of the License at 
 
    http://www.apache.org/licenses/LICENSE-2.0 
 
Unless required by applicable law or agreed to in writing, software 
distributed under the License is distributed on an &quot;AS IS&quot; BASIS, 
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
See the License for the specific language governing permissions and 
limitations under the License. 
&quot;&quot;&quot;</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">ssl</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s0"># dummy class of SSLError for ssl none-support environment.</span>
    <span class="s2">class </span><span class="s1">SSLError</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">):</span>
        <span class="s2">pass</span>


<span class="s0"># Skip test to access the internet unless TEST_WITH_INTERNET == 1</span>
<span class="s1">TEST_WITH_INTERNET </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;TEST_WITH_INTERNET&quot;</span><span class="s3">, </span><span class="s4">&quot;0&quot;</span><span class="s3">) == </span><span class="s4">&quot;1&quot;</span>
<span class="s0"># Skip tests relying on local websockets server unless LOCAL_WS_SERVER_PORT != -1</span>
<span class="s1">LOCAL_WS_SERVER_PORT </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;LOCAL_WS_SERVER_PORT&quot;</span><span class="s3">, </span><span class="s4">&quot;-1&quot;</span><span class="s3">)</span>
<span class="s1">TEST_WITH_LOCAL_SERVER </span><span class="s3">= </span><span class="s1">LOCAL_WS_SERVER_PORT </span><span class="s3">!= </span><span class="s4">&quot;-1&quot;</span>
<span class="s1">TRACEABLE </span><span class="s3">= </span><span class="s2">True</span>


<span class="s2">def </span><span class="s1">create_mask_key</span><span class="s3">(</span><span class="s1">_</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">&quot;abcd&quot;</span>


<span class="s2">class </span><span class="s1">SockMock</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">data </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sent </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">add_packet</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">gettimeout</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">recv</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">bufsize</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">:</span>
            <span class="s1">e </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">Exception</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">e</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) &gt; </span><span class="s1">bufsize</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">e</span><span class="s3">[</span><span class="s1">bufsize</span><span class="s3">:])</span>
            <span class="s2">return </span><span class="s1">e</span><span class="s3">[:</span><span class="s1">bufsize</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">send</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sent</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">pass</span>


<span class="s2">class </span><span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s1">SockMock</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fname</span><span class="s3">):</span>
        <span class="s1">SockMock</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">__file__</span><span class="s3">), </span><span class="s1">fname</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>


<span class="s2">class </span><span class="s1">WebSocketTest</span><span class="s3">(</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">TestCase</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">setUp</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">ws</span><span class="s3">.</span><span class="s1">enableTrace</span><span class="s3">(</span><span class="s1">TRACEABLE</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">tearDown</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">test_default_timeout</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">getdefaulttimeout</span><span class="s3">(), </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">ws</span><span class="s3">.</span><span class="s1">setdefaulttimeout</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">getdefaulttimeout</span><span class="s3">(), </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">ws</span><span class="s3">.</span><span class="s1">setdefaulttimeout</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ws_key</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">key </span><span class="s3">= </span><span class="s1">_create_sec_websocket_key</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertTrue</span><span class="s3">(</span><span class="s1">key </span><span class="s3">!= </span><span class="s5">24</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertTrue</span><span class="s3">(</span><span class="s4">&quot;¥n&quot; </span><span class="s2">not in </span><span class="s1">key</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_nonce</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;WebSocket key should be a random 16-byte nonce.&quot;&quot;&quot;</span>
        <span class="s1">key </span><span class="s3">= </span><span class="s1">_create_sec_websocket_key</span><span class="s3">()</span>
        <span class="s1">nonce </span><span class="s3">= </span><span class="s1">base64decode</span><span class="s3">(</span><span class="s1">key</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s5">16</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">nonce</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_ws_utils</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">key </span><span class="s3">= </span><span class="s4">&quot;c6b8hTg4EeGb2gQMztV1/g==&quot;</span>
        <span class="s1">required_header </span><span class="s3">= {</span>
            <span class="s4">&quot;upgrade&quot;</span><span class="s3">: </span><span class="s4">&quot;websocket&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;connection&quot;</span><span class="s3">: </span><span class="s4">&quot;upgrade&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;sec-websocket-accept&quot;</span><span class="s3">: </span><span class="s4">&quot;Kxep+hNu9n51529fGidYu7a3wO0=&quot;</span><span class="s3">,</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">required_header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

        <span class="s1">header </span><span class="s3">= </span><span class="s1">required_header</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;upgrade&quot;</span><span class="s3">] = </span><span class="s4">&quot;http&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>
        <span class="s2">del </span><span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;upgrade&quot;</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

        <span class="s1">header </span><span class="s3">= </span><span class="s1">required_header</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;connection&quot;</span><span class="s3">] = </span><span class="s4">&quot;something&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>
        <span class="s2">del </span><span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;connection&quot;</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

        <span class="s1">header </span><span class="s3">= </span><span class="s1">required_header</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;sec-websocket-accept&quot;</span><span class="s3">] = </span><span class="s4">&quot;something&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>
        <span class="s2">del </span><span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;sec-websocket-accept&quot;</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

        <span class="s1">header </span><span class="s3">= </span><span class="s1">required_header</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;sec-websocket-protocol&quot;</span><span class="s3">] = </span><span class="s4">&quot;sub1&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, [</span><span class="s4">&quot;sub1&quot;</span><span class="s3">, </span><span class="s4">&quot;sub2&quot;</span><span class="s3">]), (</span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;sub1&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s0"># This case will print out a logging error using the error() function, but that is expected</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, [</span><span class="s4">&quot;sub2&quot;</span><span class="s3">, </span><span class="s4">&quot;sub3&quot;</span><span class="s3">]), (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

        <span class="s1">header </span><span class="s3">= </span><span class="s1">required_header</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;sec-websocket-protocol&quot;</span><span class="s3">] = </span><span class="s4">&quot;sUb1&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, [</span><span class="s4">&quot;Sub1&quot;</span><span class="s3">, </span><span class="s4">&quot;suB2&quot;</span><span class="s3">]), (</span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;sub1&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>

        <span class="s1">header </span><span class="s3">= </span><span class="s1">required_header</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s0"># This case will print out a logging error using the error() function, but that is expected</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">_validate_header</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, [</span><span class="s4">&quot;Sub1&quot;</span><span class="s3">, </span><span class="s4">&quot;suB2&quot;</span><span class="s3">]), (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_read_header</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">status</span><span class="s3">, </span><span class="s1">header</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">read_headers</span><span class="s3">(</span><span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s4">&quot;data/header01.txt&quot;</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">status</span><span class="s3">, </span><span class="s5">101</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;connection&quot;</span><span class="s3">], </span><span class="s4">&quot;Upgrade&quot;</span><span class="s3">)</span>

        <span class="s1">status</span><span class="s3">, </span><span class="s1">header</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">read_headers</span><span class="s3">(</span><span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s4">&quot;data/header03.txt&quot;</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">status</span><span class="s3">, </span><span class="s5">101</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;connection&quot;</span><span class="s3">], </span><span class="s4">&quot;Upgrade, Keep-Alive&quot;</span><span class="s3">)</span>

        <span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s4">&quot;data/header02.txt&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketException</span><span class="s3">, </span><span class="s1">read_headers</span><span class="s3">, </span><span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s4">&quot;data/header02.txt&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_send</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># TODO: add longer frame data</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">sock</span><span class="s3">.</span><span class="s1">set_mask_key</span><span class="s3">(</span><span class="s1">create_mask_key</span><span class="s3">)</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s4">&quot;data/header01.txt&quot;</span><span class="s3">)</span>
        <span class="s1">sock</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s4">&quot;Hello&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">sent</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s7">b&quot;</span><span class="s2">\x81\x85</span><span class="s7">abcd)</span><span class="s2">\x07\x0f\x08\x0e</span><span class="s7">&quot;</span><span class="s3">)</span>

        <span class="s1">sock</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s4">&quot;こんにちは&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">s</span><span class="s3">.</span><span class="s1">sent</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],</span>
            <span class="s7">b&quot;</span><span class="s2">\x81\x8f</span><span class="s7">abcd</span><span class="s2">\x82\xe3\xf0\x87\xe3\xf1\x80\xe5\xca\x81\xe2\xc5\x82\xe3\xcc</span><span class="s7">&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s0">#        sock.send(&quot;x&quot; * 5000)</span>
        <span class="s0">#        self.assertEqual(s.sent[1], b'\x81\x8fabcd\x82\xe3\xf0\x87\xe3\xf1\x80\xe5\xca\x81\xe2\xc5\x82\xe3\xcc&quot;)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">sock</span><span class="s3">.</span><span class="s1">send_binary</span><span class="s3">(</span><span class="s7">b&quot;1111111111101&quot;</span><span class="s3">), </span><span class="s5">19</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_recv</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># TODO: add longer frame data</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">SockMock</span><span class="s3">()</span>
        <span class="s1">something </span><span class="s3">= (</span>
            <span class="s7">b&quot;</span><span class="s2">\x81\x8f</span><span class="s7">abcd</span><span class="s2">\x82\xe3\xf0\x87\xe3\xf1\x80\xe5\xca\x81\xe2\xc5\x82\xe3\xcc</span><span class="s7">&quot;</span>
        <span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s1">something</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s4">&quot;こんにちは&quot;</span><span class="s3">)</span>

        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x81\x85</span><span class="s7">abcd)</span><span class="s2">\x07\x0f\x08\x0e</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s4">&quot;Hello&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span><span class="s1">TEST_WITH_INTERNET</span><span class="s3">, </span><span class="s4">&quot;Internet-requiring tests are disabled&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_iter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">count </span><span class="s3">= </span><span class="s5">2</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">create_connection</span><span class="s3">(</span><span class="s4">&quot;wss://api.bitfinex.com/ws/2&quot;</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s4">'{&quot;event&quot;: &quot;subscribe&quot;, &quot;channel&quot;: &quot;ticker&quot;}'</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">s</span><span class="s3">:</span>
            <span class="s1">count </span><span class="s3">-= </span><span class="s5">1</span>
            <span class="s2">if </span><span class="s1">count </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s2">break</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span><span class="s1">TEST_WITH_INTERNET</span><span class="s3">, </span><span class="s4">&quot;Internet-requiring tests are disabled&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_next</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">create_connection</span><span class="s3">(</span><span class="s4">&quot;wss://api.bitfinex.com/ws/2&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">type</span><span class="s3">(</span><span class="s1">next</span><span class="s3">(</span><span class="s1">sock</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">test_internal_recv_strict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">SockMock</span><span class="s3">()</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;foo&quot;</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s1">socket</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">())</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;bar&quot;</span><span class="s3">)</span>
        <span class="s0"># s.add_packet(SSLError(&quot;The read operation timed out&quot;))</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;baz&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketTimeoutException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">frame_buffer</span><span class="s3">.</span><span class="s1">recv_strict</span><span class="s3">(</span><span class="s5">9</span><span class="s3">)</span>
        <span class="s0">#     with self.assertRaises(SSLError):</span>
        <span class="s0">#         data = sock._recv_strict(9)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">frame_buffer</span><span class="s3">.</span><span class="s1">recv_strict</span><span class="s3">(</span><span class="s5">9</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s7">b&quot;foobarbaz&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketConnectionClosedException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">frame_buffer</span><span class="s3">.</span><span class="s1">recv_strict</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_recv_timeout</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">SockMock</span><span class="s3">()</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x81</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s1">socket</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">())</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x8d</span><span class="s7">abcd</span><span class="s2">\x29\x07\x0f\x08\x0e</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s1">socket</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">())</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x4e\x43\x33\x0e\x10\x0f\x00\x40</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketTimeoutException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketTimeoutException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s4">&quot;Hello, World!&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketConnectionClosedException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_recv_with_simple_fragmentation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">SockMock</span><span class="s3">()</span>
        <span class="s0"># OPCODE=TEXT, FIN=0, MSG=&quot;Brevity is &quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x01\x8b</span><span class="s7">abcd#</span><span class="s2">\x10\x06\x12\x08\x16\x1a</span><span class="s7">D</span><span class="s2">\x08\x11</span><span class="s7">C&quot;</span><span class="s3">)</span>
        <span class="s0"># OPCODE=CONT, FIN=1, MSG=&quot;the soul of wit&quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x80\x8f</span><span class="s7">abcd</span><span class="s2">\x15\n\x06</span><span class="s7">D</span><span class="s2">\x12\r\x16\x08</span><span class="s7">A</span><span class="s2">\r\x05</span><span class="s7">D</span><span class="s2">\x16\x0b\x17</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s4">&quot;Brevity is the soul of wit&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketConnectionClosedException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_recv_with_fire_event_of_fragmentation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">(</span><span class="s1">fire_cont_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">SockMock</span><span class="s3">()</span>
        <span class="s0"># OPCODE=TEXT, FIN=0, MSG=&quot;Brevity is &quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x01\x8b</span><span class="s7">abcd#</span><span class="s2">\x10\x06\x12\x08\x16\x1a</span><span class="s7">D</span><span class="s2">\x08\x11</span><span class="s7">C&quot;</span><span class="s3">)</span>
        <span class="s0"># OPCODE=CONT, FIN=0, MSG=&quot;Brevity is &quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x00\x8b</span><span class="s7">abcd#</span><span class="s2">\x10\x06\x12\x08\x16\x1a</span><span class="s7">D</span><span class="s2">\x08\x11</span><span class="s7">C&quot;</span><span class="s3">)</span>
        <span class="s0"># OPCODE=CONT, FIN=1, MSG=&quot;the soul of wit&quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x80\x8f</span><span class="s7">abcd</span><span class="s2">\x15\n\x06</span><span class="s7">D</span><span class="s2">\x12\r\x16\x08</span><span class="s7">A</span><span class="s2">\r\x05</span><span class="s7">D</span><span class="s2">\x16\x0b\x17</span><span class="s7">&quot;</span><span class="s3">)</span>

        <span class="s1">_</span><span class="s3">, </span><span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv_data</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s7">b&quot;Brevity is &quot;</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv_data</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s7">b&quot;Brevity is &quot;</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv_data</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s7">b&quot;the soul of wit&quot;</span><span class="s3">)</span>

        <span class="s0"># OPCODE=CONT, FIN=0, MSG=&quot;Brevity is &quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x80\x8b</span><span class="s7">abcd#</span><span class="s2">\x10\x06\x12\x08\x16\x1a</span><span class="s7">D</span><span class="s2">\x08\x11</span><span class="s7">C&quot;</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">recv_data</span><span class="s3">()</span>

        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketConnectionClosedException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">sock</span><span class="s3">.</span><span class="s1">connected </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">sock</span><span class="s3">.</span><span class="s1">close</span>

        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">SockMock</span><span class="s3">()</span>
        <span class="s1">sock</span><span class="s3">.</span><span class="s1">connected </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x88\x80\x17\x98</span><span class="s7">p</span><span class="s2">\x84</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">sock</span><span class="s3">.</span><span class="s1">connected</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_recv_cont_fragmentation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">SockMock</span><span class="s3">()</span>
        <span class="s0"># OPCODE=CONT, FIN=1, MSG=&quot;the soul of wit&quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x80\x8f</span><span class="s7">abcd</span><span class="s2">\x15\n\x06</span><span class="s7">D</span><span class="s2">\x12\r\x16\x08</span><span class="s7">A</span><span class="s2">\r\x05</span><span class="s7">D</span><span class="s2">\x16\x0b\x17</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketException</span><span class="s3">, </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_recv_with_prolonged_fragmentation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">SockMock</span><span class="s3">()</span>
        <span class="s0"># OPCODE=TEXT, FIN=0, MSG=&quot;Once more unto the breach, &quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span>
            <span class="s7">b&quot;</span><span class="s2">\x01\x9b</span><span class="s7">abcd.</span><span class="s2">\x0c\x00\x01</span><span class="s7">A</span><span class="s2">\x0f\x0c\x16\x04</span><span class="s7">B</span><span class="s2">\x16\n\x15\r</span><span class="s7">C</span><span class="s2">\x10\t\x07</span><span class="s7">C</span><span class="s2">\x06\x13\x07\x02\x07\t</span><span class="s7">NC&quot;</span>
        <span class="s3">)</span>
        <span class="s0"># OPCODE=CONT, FIN=0, MSG=&quot;dear friends, &quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x00\x8e</span><span class="s7">abcd</span><span class="s2">\x05\x07\x02\x16</span><span class="s7">A</span><span class="s2">\x04\x11\r\x04\x0c\x07\x17</span><span class="s7">MB&quot;</span><span class="s3">)</span>
        <span class="s0"># OPCODE=CONT, FIN=1, MSG=&quot;once more&quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x80\x89</span><span class="s7">abcd</span><span class="s2">\x0e\x0c\x00\x01</span><span class="s7">A</span><span class="s2">\x0f\x0c\x16\x04</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s4">&quot;Once more unto the breach, dear friends, once more&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketConnectionClosedException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_recv_with_fragmentation_and_control_frame</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sock </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">sock</span><span class="s3">.</span><span class="s1">set_mask_key</span><span class="s3">(</span><span class="s1">create_mask_key</span><span class="s3">)</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">sock </span><span class="s3">= </span><span class="s1">SockMock</span><span class="s3">()</span>
        <span class="s0"># OPCODE=TEXT, FIN=0, MSG=&quot;Too much &quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x01\x89</span><span class="s7">abcd5</span><span class="s2">\r\x0c</span><span class="s7">D</span><span class="s2">\x0c\x17\x00\x0c</span><span class="s7">A&quot;</span><span class="s3">)</span>
        <span class="s0"># OPCODE=PING, FIN=1, MSG=&quot;Please PONG this&quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x89\x90</span><span class="s7">abcd1</span><span class="s2">\x0e\x06\x05\x12\x07</span><span class="s7">C4.,$D</span><span class="s2">\x15\n\n\x17</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s0"># OPCODE=CONT, FIN=1, MSG=&quot;of a good thing&quot;</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\x80\x8f</span><span class="s7">abcd</span><span class="s2">\x0e\x04</span><span class="s7">C</span><span class="s2">\x05</span><span class="s7">A</span><span class="s2">\x05\x0c\x0b\x05</span><span class="s7">B</span><span class="s2">\x17\x0c\x08\x0c\x04</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s4">&quot;Too much of a good thing&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketConnectionClosedException</span><span class="s3">):</span>
            <span class="s1">sock</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">s</span><span class="s3">.</span><span class="s1">sent</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s7">b&quot;</span><span class="s2">\x8a\x90</span><span class="s7">abcd1</span><span class="s2">\x0e\x06\x05\x12\x07</span><span class="s7">C4.,$D</span><span class="s2">\x15\n\n\x17</span><span class="s7">&quot;</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span>
        <span class="s1">TEST_WITH_LOCAL_SERVER</span><span class="s3">, </span><span class="s4">&quot;Tests using local websocket server are disabled&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_websocket</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">create_connection</span><span class="s3">(</span><span class="s4">f&quot;ws://127.0.0.1:</span><span class="s2">{</span><span class="s1">LOCAL_WS_SERVER_PORT</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertNotEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s4">&quot;Hello, World&quot;</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">next</span><span class="s3">()</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">fileno</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s4">&quot;Hello, World&quot;</span><span class="s3">)</span>

        <span class="s1">s</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s4">&quot;こにゃにゃちは、世界&quot;</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s4">&quot;こにゃにゃちは、世界&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">s</span><span class="s3">.</span><span class="s1">send_close</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span>
        <span class="s1">TEST_WITH_LOCAL_SERVER</span><span class="s3">, </span><span class="s4">&quot;Tests using local websocket server are disabled&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_ping_pong</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">create_connection</span><span class="s3">(</span><span class="s4">f&quot;ws://127.0.0.1:</span><span class="s2">{</span><span class="s1">LOCAL_WS_SERVER_PORT</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertNotEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">ping</span><span class="s3">(</span><span class="s4">&quot;Hello&quot;</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">pong</span><span class="s3">(</span><span class="s4">&quot;Hi&quot;</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span><span class="s1">TEST_WITH_INTERNET</span><span class="s3">, </span><span class="s4">&quot;Internet-requiring tests are disabled&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_support_redirect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">WebSocketBadStatusException</span><span class="s3">, </span><span class="s1">s</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">, </span><span class="s4">&quot;ws://google.com/&quot;</span><span class="s3">)</span>
        <span class="s0"># Need to find a URL that has a redirect code leading to a websocket</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span><span class="s1">TEST_WITH_INTERNET</span><span class="s3">, </span><span class="s4">&quot;Internet-requiring tests are disabled&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_secure_websocket</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">create_connection</span><span class="s3">(</span><span class="s4">&quot;wss://api.bitfinex.com/ws/2&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertNotEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertTrue</span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">sock</span><span class="s3">, </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">SSLSocket</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">getstatus</span><span class="s3">(), </span><span class="s5">101</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertNotEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">getheaders</span><span class="s3">(), </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">settimeout</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">gettimeout</span><span class="s3">(), </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">getsubprotocol</span><span class="s3">(), </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">abort</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span>
        <span class="s1">TEST_WITH_LOCAL_SERVER</span><span class="s3">, </span><span class="s4">&quot;Tests using local websocket server are disabled&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_websocket_with_custom_header</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">create_connection</span><span class="s3">(</span>
            <span class="s4">f&quot;ws://127.0.0.1:</span><span class="s2">{</span><span class="s1">LOCAL_WS_SERVER_PORT</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
            <span class="s1">headers</span><span class="s3">={</span><span class="s4">&quot;User-Agent&quot;</span><span class="s3">: </span><span class="s4">&quot;PythonWebsocketClient&quot;</span><span class="s3">},</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertNotEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">getsubprotocol</span><span class="s3">(), </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s4">&quot;Hello, World&quot;</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s4">&quot;Hello, World&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">s</span><span class="s3">.</span><span class="s1">close</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span>
        <span class="s1">TEST_WITH_LOCAL_SERVER</span><span class="s3">, </span><span class="s4">&quot;Tests using local websocket server are disabled&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_after_close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">create_connection</span><span class="s3">(</span><span class="s4">f&quot;ws://127.0.0.1:</span><span class="s2">{</span><span class="s1">LOCAL_WS_SERVER_PORT</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertNotEqual</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketConnectionClosedException</span><span class="s3">, </span><span class="s1">s</span><span class="s3">.</span><span class="s1">send</span><span class="s3">, </span><span class="s4">&quot;Hello&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocketConnectionClosedException</span><span class="s3">, </span><span class="s1">s</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">SockOptTest</span><span class="s3">(</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">TestCase</span><span class="s3">):</span>
    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span>
        <span class="s1">TEST_WITH_LOCAL_SERVER</span><span class="s3">, </span><span class="s4">&quot;Tests using local websocket server are disabled&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_sockopt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sockopt </span><span class="s3">= ((</span><span class="s1">socket</span><span class="s3">.</span><span class="s1">IPPROTO_TCP</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">TCP_NODELAY</span><span class="s3">, </span><span class="s5">1</span><span class="s3">),)</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">create_connection</span><span class="s3">(</span>
            <span class="s4">f&quot;ws://127.0.0.1:</span><span class="s2">{</span><span class="s1">LOCAL_WS_SERVER_PORT</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">sockopt</span><span class="s3">=</span><span class="s1">sockopt</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertNotEqual</span><span class="s3">(</span>
            <span class="s1">s</span><span class="s3">.</span><span class="s1">sock</span><span class="s3">.</span><span class="s1">getsockopt</span><span class="s3">(</span><span class="s1">socket</span><span class="s3">.</span><span class="s1">IPPROTO_TCP</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">TCP_NODELAY</span><span class="s3">), </span><span class="s5">0</span>
        <span class="s3">)</span>
        <span class="s1">s</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">UtilsTest</span><span class="s3">(</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">TestCase</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">test_utf8_validator</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">state </span><span class="s3">= </span><span class="s1">validate_utf8</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\xf0\x90\x80\x80</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">state </span><span class="s3">= </span><span class="s1">validate_utf8</span><span class="s3">(</span>
            <span class="s7">b&quot;</span><span class="s2">\xce\xba\xe1\xbd\xb9\xcf\x83\xce\xbc\xce\xb5\xed\xa0\x80</span><span class="s7">edited&quot;</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">state </span><span class="s3">= </span><span class="s1">validate_utf8</span><span class="s3">(</span><span class="s7">b&quot;&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">HandshakeTest</span><span class="s3">(</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">TestCase</span><span class="s3">):</span>
    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span><span class="s1">TEST_WITH_INTERNET</span><span class="s3">, </span><span class="s4">&quot;Internet-requiring tests are disabled&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_http_ssl</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">websock1 </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">(</span>
            <span class="s1">sslopt</span><span class="s3">={</span><span class="s4">&quot;cert_chain&quot;</span><span class="s3">: </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">get_default_verify_paths</span><span class="s3">().</span><span class="s1">capath</span><span class="s3">},</span>
            <span class="s1">enable_multithread</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">websock1</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">, </span><span class="s4">&quot;wss://api.bitfinex.com/ws/2&quot;</span><span class="s3">)</span>
        <span class="s1">websock2 </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">(</span><span class="s1">sslopt</span><span class="s3">={</span><span class="s4">&quot;certfile&quot;</span><span class="s3">: </span><span class="s4">&quot;myNonexistentCertFile&quot;</span><span class="s3">})</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">FileNotFoundError</span><span class="s3">, </span><span class="s1">websock2</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">, </span><span class="s4">&quot;wss://api.bitfinex.com/ws/2&quot;</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span><span class="s1">TEST_WITH_INTERNET</span><span class="s3">, </span><span class="s4">&quot;Internet-requiring tests are disabled&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_manual_headers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">websock3 </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">(</span>
            <span class="s1">sslopt</span><span class="s3">={</span>
                <span class="s4">&quot;ca_certs&quot;</span><span class="s3">: </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">get_default_verify_paths</span><span class="s3">().</span><span class="s1">cafile</span><span class="s3">,</span>
                <span class="s4">&quot;ca_cert_path&quot;</span><span class="s3">: </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">get_default_verify_paths</span><span class="s3">().</span><span class="s1">capath</span><span class="s3">,</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">WebSocketBadStatusException</span><span class="s3">,</span>
            <span class="s1">websock3</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">,</span>
            <span class="s4">&quot;wss://api.bitfinex.com/ws/2&quot;</span><span class="s3">,</span>
            <span class="s1">cookie</span><span class="s3">=</span><span class="s4">&quot;chocolate&quot;</span><span class="s3">,</span>
            <span class="s1">origin</span><span class="s3">=</span><span class="s4">&quot;testing_websockets.com&quot;</span><span class="s3">,</span>
            <span class="s1">host</span><span class="s3">=</span><span class="s4">&quot;echo.websocket.events/websocket-client-test&quot;</span><span class="s3">,</span>
            <span class="s1">subprotocols</span><span class="s3">=[</span><span class="s4">&quot;testproto&quot;</span><span class="s3">],</span>
            <span class="s1">connection</span><span class="s3">=</span><span class="s4">&quot;Upgrade&quot;</span><span class="s3">,</span>
            <span class="s1">header</span><span class="s3">={</span>
                <span class="s4">&quot;CustomHeader1&quot;</span><span class="s3">: </span><span class="s4">&quot;123&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;Cookie&quot;</span><span class="s3">: </span><span class="s4">&quot;TestValue&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;Sec-WebSocket-Key&quot;</span><span class="s3">: </span><span class="s4">&quot;k9kFAUWNAMmf5OEMfTlOEA==&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;Sec-WebSocket-Protocol&quot;</span><span class="s3">: </span><span class="s4">&quot;newprotocol&quot;</span><span class="s3">,</span>
            <span class="s3">},</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ipv6</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">websock2 </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">websock2</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">, </span><span class="s4">&quot;2001:4860:4860::8888&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_urls</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">websock3 </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">websock3</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">, </span><span class="s4">&quot;ws//example.com&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">WebSocketAddressException</span><span class="s3">, </span><span class="s1">websock3</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">, </span><span class="s4">&quot;ws://example&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">websock3</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">, </span><span class="s4">&quot;example.com&quot;</span><span class="s3">)</span>


<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s4">&quot;__main__&quot;</span><span class="s3">:</span>
    <span class="s1">unittest</span><span class="s3">.</span><span class="s1">main</span><span class="s3">()</span>
</pre>
</body>
</html>