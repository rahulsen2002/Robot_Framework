<html>
<head>
<title>testlibraries.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
testlibraries.py</font>
</center></td></tr></table>
<pre><span class="s0">#  Copyright 2008-2015 Nokia Networks</span>
<span class="s0">#  Copyright 2016-     Robot Framework Foundation</span>
<span class="s0">#</span>
<span class="s0">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0">#  you may not use this file except in compliance with the License.</span>
<span class="s0">#  You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="s0">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0">#  See the License for the specific language governing permissions and</span>
<span class="s0">#  limitations under the License.</span>

<span class="s2">import </span><span class="s1">inspect</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">cached_property</span><span class="s3">, </span><span class="s1">partial</span>
<span class="s2">from </span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">Path</span>
<span class="s2">from </span><span class="s1">types </span><span class="s2">import </span><span class="s1">ModuleType</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span><span class="s3">, </span><span class="s1">Literal</span><span class="s3">, </span><span class="s1">overload</span><span class="s3">, </span><span class="s1">Sequence</span><span class="s3">, </span><span class="s1">TypeVar</span>

<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">DataError</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">libraries </span><span class="s2">import </span><span class="s1">STDLIBS</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">output </span><span class="s2">import </span><span class="s1">LOGGER</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">get_error_details</span><span class="s3">, </span><span class="s1">getdoc</span><span class="s3">, </span><span class="s1">Importer</span><span class="s3">, </span><span class="s1">is_dict_like</span><span class="s3">, </span><span class="s1">is_list_like</span><span class="s3">, </span><span class="s1">normalize</span><span class="s3">,</span>
    <span class="s1">NormalizedDict</span><span class="s3">, </span><span class="s1">seq2str2</span><span class="s3">, </span><span class="s1">setter</span><span class="s3">, </span><span class="s1">type_name</span>
<span class="s3">)</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">arguments </span><span class="s2">import </span><span class="s1">CustomArgumentConverters</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">dynamicmethods </span><span class="s2">import </span><span class="s1">GetKeywordDocumentation</span><span class="s3">, </span><span class="s1">GetKeywordNames</span><span class="s3">, </span><span class="s1">RunKeyword</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">keywordfinder </span><span class="s2">import </span><span class="s1">KeywordFinder</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">librarykeyword </span><span class="s2">import </span><span class="s1">DynamicKeyword</span><span class="s3">, </span><span class="s1">LibraryInit</span><span class="s3">, </span><span class="s1">LibraryKeyword</span><span class="s3">, </span><span class="s1">StaticKeyword</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">libraryscopes </span><span class="s2">import </span><span class="s1">Scope</span><span class="s3">, </span><span class="s1">ScopeManager</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">outputcapture </span><span class="s2">import </span><span class="s1">OutputCapturer</span>

<span class="s1">Self </span><span class="s3">= </span><span class="s1">TypeVar</span><span class="s3">(</span><span class="s4">&quot;Self&quot;</span><span class="s3">, </span><span class="s1">bound</span><span class="s3">=</span><span class="s4">&quot;TestLibrary&quot;</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestLibrary</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;Represents imported test library.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">code</span><span class="s3">: </span><span class="s4">&quot;type|ModuleType&quot;</span><span class="s3">,</span>
        <span class="s1">init</span><span class="s3">: </span><span class="s1">LibraryInit</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">real_name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">source</span><span class="s3">: </span><span class="s4">&quot;Path|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">logger</span><span class="s3">=</span><span class="s1">LOGGER</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">code </span><span class="s3">= </span><span class="s1">code</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">init </span><span class="s3">= </span><span class="s1">init</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">init</span><span class="s3">.</span><span class="s1">owner </span><span class="s3">= </span><span class="s1">self</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">instance </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s1">name </span><span class="s2">or </span><span class="s1">code</span><span class="s3">.</span><span class="s1">__name__</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">real_name </span><span class="s3">= </span><span class="s1">real_name </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">source </span><span class="s3">= </span><span class="s1">source</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_logger </span><span class="s3">= </span><span class="s1">logger</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">keywords</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">LibraryKeyword</span><span class="s3">] = []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_has_listeners </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scope_manager </span><span class="s3">= </span><span class="s1">ScopeManager</span><span class="s3">.</span><span class="s1">for_library</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">keyword_finder </span><span class="s3">= </span><span class="s1">KeywordFinder</span><span class="s3">[</span><span class="s1">LibraryKeyword</span><span class="s3">](</span><span class="s1">self</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">instance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Any</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Current library instance. 
 
        With module based libraries this is the module itself. 
 
        With class based libraries this is an instance of the class. Instances are 
        cleared automatically during execution based on their scope. Accessing this 
        property creates a new instance if needed. 
 
        :attr:`code` contains the original library code. With module based libraries 
        it is the same as :attr:`instance`. With class based libraries it is 
        the library class. 
        &quot;&quot;&quot;</span>
        <span class="s1">instance </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">code </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_instance </span><span class="s2">is None else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_instance</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_listeners </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_has_listeners </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_instance_has_listeners</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">instance</span>

    <span class="s3">@</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">setter</span>
    <span class="s2">def </span><span class="s1">instance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_instance </span><span class="s3">= </span><span class="s1">instance</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">listeners</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;list[Any]&quot;</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_listeners </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_has_listeners </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_instance_has_listeners</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">instance</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_listeners </span><span class="s2">is False</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">[]</span>
        <span class="s1">listener </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">ROBOT_LIBRARY_LISTENER</span>
        <span class="s2">return </span><span class="s1">list</span><span class="s3">(</span><span class="s1">listener</span><span class="s3">) </span><span class="s2">if </span><span class="s1">is_list_like</span><span class="s3">(</span><span class="s1">listener</span><span class="s3">) </span><span class="s2">else </span><span class="s3">[</span><span class="s1">listener</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">_instance_has_listeners</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">, </span><span class="s4">&quot;ROBOT_LIBRARY_LISTENER&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">) </span><span class="s2">is not None</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">converters</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;CustomArgumentConverters|None&quot;</span><span class="s3">:</span>
        <span class="s1">converters </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">code</span><span class="s3">, </span><span class="s4">&quot;ROBOT_LIBRARY_CONVERTERS&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">converters</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">if not </span><span class="s1">is_dict_like</span><span class="s3">(</span><span class="s1">converters</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">report_error</span><span class="s3">(</span>
                <span class="s4">f&quot;Argument converters must be given as a dictionary, &quot;</span>
                <span class="s4">f&quot;got </span><span class="s2">{</span><span class="s1">type_name</span><span class="s3">(</span><span class="s1">converters</span><span class="s3">)</span><span class="s2">}</span><span class="s4">.&quot;</span>
            <span class="s3">)</span>
            <span class="s2">return None</span>
        <span class="s2">return </span><span class="s1">CustomArgumentConverters</span><span class="s3">.</span><span class="s1">from_dict</span><span class="s3">(</span><span class="s1">converters</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">doc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">getdoc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">instance</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">doc_format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_attr</span><span class="s3">(</span><span class="s4">&quot;ROBOT_LIBRARY_DOC_FORMAT&quot;</span><span class="s3">, </span><span class="s1">upper</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">scope</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Scope</span><span class="s3">:</span>
        <span class="s1">scope </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_attr</span><span class="s3">(</span><span class="s4">&quot;ROBOT_LIBRARY_SCOPE&quot;</span><span class="s3">, </span><span class="s4">&quot;TEST&quot;</span><span class="s3">, </span><span class="s1">upper</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">scope </span><span class="s3">== </span><span class="s4">&quot;GLOBAL&quot;</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">Scope</span><span class="s3">.</span><span class="s1">GLOBAL</span>
        <span class="s2">if </span><span class="s1">scope </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;SUITE&quot;</span><span class="s3">, </span><span class="s4">&quot;TESTSUITE&quot;</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">Scope</span><span class="s3">.</span><span class="s1">SUITE</span>
        <span class="s2">return </span><span class="s1">Scope</span><span class="s3">.</span><span class="s1">TEST</span>

    <span class="s3">@</span><span class="s1">setter</span>
    <span class="s2">def </span><span class="s1">source</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">source</span><span class="s3">: </span><span class="s4">&quot;Path|str|None&quot;</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;Path|None&quot;</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">source</span><span class="s3">) </span><span class="s2">if </span><span class="s1">source </span><span class="s2">else None</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">version</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_attr</span><span class="s3">(</span><span class="s4">&quot;ROBOT_LIBRARY_VERSION&quot;</span><span class="s3">) </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_attr</span><span class="s3">(</span><span class="s4">&quot;__version__&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">lineno</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s6">1</span>

    <span class="s2">def </span><span class="s1">_attr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">default</span><span class="s3">=</span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s1">upper</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">code</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">default</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">upper</span><span class="s3">:</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">ignore</span><span class="s3">=</span><span class="s4">&quot;_&quot;</span><span class="s3">).</span><span class="s1">upper</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">value</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">from_name</span><span class="s3">(</span>
        <span class="s1">cls</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">real_name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">args</span><span class="s3">: </span><span class="s4">&quot;Sequence[str]|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">variables</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">create_keywords</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">logger</span><span class="s3">=</span><span class="s1">LOGGER</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;TestLibrary&quot;</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">STDLIBS</span><span class="s3">:</span>
            <span class="s1">import_name </span><span class="s3">= </span><span class="s4">&quot;robot.libraries.&quot; </span><span class="s3">+ </span><span class="s1">name</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">import_name </span><span class="s3">= </span><span class="s1">name</span>
        <span class="s2">if </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">name</span><span class="s3">).</span><span class="s1">exists</span><span class="s3">():</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">name</span><span class="s3">).</span><span class="s1">stem</span>
        <span class="s2">with </span><span class="s1">OutputCapturer</span><span class="s3">(</span><span class="s1">library_import</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s1">importer </span><span class="s3">= </span><span class="s1">Importer</span><span class="s3">(</span><span class="s4">&quot;library&quot;</span><span class="s3">, </span><span class="s1">logger</span><span class="s3">=</span><span class="s1">logger</span><span class="s3">)</span>
            <span class="s1">code</span><span class="s3">, </span><span class="s1">source </span><span class="s3">= </span><span class="s1">importer</span><span class="s3">.</span><span class="s1">import_class_or_module</span><span class="s3">(</span>
                <span class="s1">import_name</span><span class="s3">, </span><span class="s1">return_source</span><span class="s3">=</span><span class="s2">True</span>
            <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">from_code</span><span class="s3">(</span>
            <span class="s1">code</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">real_name</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">variables</span><span class="s3">, </span><span class="s1">create_keywords</span><span class="s3">, </span><span class="s1">logger</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">from_code</span><span class="s3">(</span>
        <span class="s1">cls</span><span class="s3">,</span>
        <span class="s1">code</span><span class="s3">: </span><span class="s4">&quot;type|ModuleType&quot;</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">real_name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">source</span><span class="s3">: </span><span class="s4">&quot;Path|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">args</span><span class="s3">: </span><span class="s4">&quot;Sequence[str]|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">variables</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">create_keywords</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">logger</span><span class="s3">=</span><span class="s1">LOGGER</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;TestLibrary&quot;</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">ismodule</span><span class="s3">(</span><span class="s1">code</span><span class="s3">):</span>
            <span class="s1">lib </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">from_module</span><span class="s3">(</span>
                <span class="s1">code</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">real_name</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">create_keywords</span><span class="s3">, </span><span class="s1">logger</span>
            <span class="s3">)</span>
            <span class="s2">if </span><span class="s1">args</span><span class="s3">:  </span><span class="s0"># Resolving arguments reports an error.</span>
                <span class="s1">lib</span><span class="s3">.</span><span class="s1">init</span><span class="s3">.</span><span class="s1">resolve_arguments</span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">variables</span><span class="s3">=</span><span class="s1">variables</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">lib</span>
        <span class="s2">if </span><span class="s1">args </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">args </span><span class="s3">= ()</span>
        <span class="s2">return </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">from_class</span><span class="s3">(</span>
            <span class="s1">code</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">real_name</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">variables</span><span class="s3">, </span><span class="s1">create_keywords</span><span class="s3">, </span><span class="s1">logger</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">from_module</span><span class="s3">(</span>
        <span class="s1">cls</span><span class="s3">,</span>
        <span class="s1">module</span><span class="s3">: </span><span class="s1">ModuleType</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">real_name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">source</span><span class="s3">: </span><span class="s4">&quot;Path|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">create_keywords</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">logger</span><span class="s3">=</span><span class="s1">LOGGER</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;TestLibrary&quot;</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">ModuleLibrary</span><span class="s3">.</span><span class="s1">from_module</span><span class="s3">(</span>
            <span class="s1">module</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">real_name</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">create_keywords</span><span class="s3">, </span><span class="s1">logger</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">from_class</span><span class="s3">(</span>
        <span class="s1">cls</span><span class="s3">,</span>
        <span class="s1">klass</span><span class="s3">: </span><span class="s1">type</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">real_name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">source</span><span class="s3">: </span><span class="s4">&quot;Path|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">args</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = (),</span>
        <span class="s1">variables</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">create_keywords</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">logger</span><span class="s3">=</span><span class="s1">LOGGER</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;TestLibrary&quot;</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">GetKeywordNames</span><span class="s3">(</span><span class="s1">klass</span><span class="s3">):</span>
            <span class="s1">library </span><span class="s3">= </span><span class="s1">ClassLibrary</span>
        <span class="s2">elif not </span><span class="s1">RunKeyword</span><span class="s3">(</span><span class="s1">klass</span><span class="s3">):</span>
            <span class="s1">library </span><span class="s3">= </span><span class="s1">HybridLibrary</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">library </span><span class="s3">= </span><span class="s1">DynamicLibrary</span>
        <span class="s2">return </span><span class="s1">library</span><span class="s3">.</span><span class="s1">from_class</span><span class="s3">(</span>
            <span class="s1">klass</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">real_name</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">variables</span><span class="s3">, </span><span class="s1">create_keywords</span><span class="s3">, </span><span class="s1">logger</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">create_keywords</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>

    <span class="s3">@</span><span class="s1">overload</span>
    <span class="s2">def </span><span class="s1">find_keywords</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">count</span><span class="s3">: </span><span class="s1">Literal</span><span class="s3">[</span><span class="s6">1</span><span class="s3">],</span>
    <span class="s3">) </span><span class="s1">-&gt; LibraryKeyword</span><span class="s3">: ...</span>

    <span class="s3">@</span><span class="s1">overload</span>
    <span class="s2">def </span><span class="s1">find_keywords</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">count</span><span class="s3">: </span><span class="s4">&quot;int|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;list[LibraryKeyword]&quot;</span><span class="s3">: ...</span>

    <span class="s2">def </span><span class="s1">find_keywords</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">count</span><span class="s3">: </span><span class="s4">&quot;int|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;list[LibraryKeyword]|LibraryKeyword&quot;</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">keyword_finder</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">count</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">copy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">: </span><span class="s1">Self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; Self</span><span class="s3">:</span>
        <span class="s1">lib </span><span class="s3">= </span><span class="s1">type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">code</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">init</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(),</span>
            <span class="s1">name</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">real_name</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">source</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_logger</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">lib</span><span class="s3">.</span><span class="s1">instance </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">instance</span>
        <span class="s1">lib</span><span class="s3">.</span><span class="s1">keywords </span><span class="s3">= [</span><span class="s1">kw</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">owner</span><span class="s3">=</span><span class="s1">lib</span><span class="s3">) </span><span class="s2">for </span><span class="s1">kw </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">keywords</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">lib</span>

    <span class="s2">def </span><span class="s1">report_error</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">message</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">details</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">level</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;ERROR&quot;</span><span class="s3">,</span>
        <span class="s1">details_level</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;INFO&quot;</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">prefix </span><span class="s3">= </span><span class="s4">&quot;Error in&quot; </span><span class="s2">if </span><span class="s1">level </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;ERROR&quot;</span><span class="s3">, </span><span class="s4">&quot;WARN&quot;</span><span class="s3">) </span><span class="s2">else </span><span class="s4">&quot;In&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_logger</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">prefix</span><span class="s2">} </span><span class="s4">library '</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">': </span><span class="s2">{</span><span class="s1">message</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">level</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">details</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_logger</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">f&quot;Details:</span><span class="s2">\n{</span><span class="s1">details</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">details_level</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">ModuleLibrary</span><span class="s3">(</span><span class="s1">TestLibrary</span><span class="s3">):</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">scope</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Scope</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">Scope</span><span class="s3">.</span><span class="s1">GLOBAL</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">from_module</span><span class="s3">(</span>
        <span class="s1">cls</span><span class="s3">,</span>
        <span class="s1">module</span><span class="s3">: </span><span class="s1">ModuleType</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">real_name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">source</span><span class="s3">: </span><span class="s4">&quot;Path|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">create_keywords</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">logger</span><span class="s3">=</span><span class="s1">LOGGER</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;ModuleLibrary&quot;</span><span class="s3">:</span>
        <span class="s1">library </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">(</span><span class="s1">module</span><span class="s3">, </span><span class="s1">LibraryInit</span><span class="s3">.</span><span class="s1">null</span><span class="s3">(), </span><span class="s1">name</span><span class="s3">, </span><span class="s1">real_name</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">logger</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">create_keywords</span><span class="s3">:</span>
            <span class="s1">library</span><span class="s3">.</span><span class="s1">create_keywords</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">library</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">from_class</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kws</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;TestLibrary&quot;</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s4">f&quot;Cannot create '</span><span class="s2">{</span><span class="s1">cls</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">}</span><span class="s4">' from class.&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">create_keywords</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">includes </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">code</span><span class="s3">, </span><span class="s4">&quot;__all__&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">StaticKeywordCreator</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">included_names</span><span class="s3">=</span><span class="s1">includes</span><span class="s3">).</span><span class="s1">create_keywords</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">ClassLibrary</span><span class="s3">(</span><span class="s1">TestLibrary</span><span class="s3">):</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">instance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Any</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_instance </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">positional</span><span class="s3">, </span><span class="s1">named </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">init</span><span class="s3">.</span><span class="s1">positional</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">init</span><span class="s3">.</span><span class="s1">named</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">OutputCapturer</span><span class="s3">(</span><span class="s1">library_import</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_instance </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">code</span><span class="s3">(*</span><span class="s1">positional</span><span class="s3">, **</span><span class="s1">named</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
                <span class="s1">message</span><span class="s3">, </span><span class="s1">details </span><span class="s3">= </span><span class="s1">get_error_details</span><span class="s3">()</span>
                <span class="s2">if </span><span class="s1">positional </span><span class="s2">or </span><span class="s1">named</span><span class="s3">:</span>
                    <span class="s1">args </span><span class="s3">= </span><span class="s1">seq2str2</span><span class="s3">(</span><span class="s1">positional </span><span class="s3">+ [</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">n</span><span class="s2">}</span><span class="s4">=</span><span class="s2">{</span><span class="s1">named</span><span class="s3">[</span><span class="s1">n</span><span class="s3">]</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">named</span><span class="s3">])</span>
                    <span class="s1">args_text </span><span class="s3">= </span><span class="s4">f&quot;arguments </span><span class="s2">{</span><span class="s1">args</span><span class="s2">}</span><span class="s4">&quot;</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">args_text </span><span class="s3">= </span><span class="s4">&quot;no arguments&quot;</span>
                <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span>
                    <span class="s4">f&quot;Initializing library '</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">' with </span><span class="s2">{</span><span class="s1">args_text</span><span class="s2">} </span><span class="s4">&quot;</span>
                    <span class="s4">f&quot;failed: </span><span class="s2">{</span><span class="s1">message</span><span class="s2">}\n{</span><span class="s1">details</span><span class="s2">}</span><span class="s4">&quot;</span>
                <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_listeners </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_has_listeners </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_instance_has_listeners</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_instance</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_instance</span>

    <span class="s3">@</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">setter</span>
    <span class="s2">def </span><span class="s1">instance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_instance </span><span class="s3">= </span><span class="s1">instance</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">lineno</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">lines</span><span class="s3">, </span><span class="s1">start_lineno </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">getsourcelines</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">code</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">OSError</span><span class="s3">, </span><span class="s1">IOError</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s6">1</span>
        <span class="s2">for </span><span class="s1">increment</span><span class="s3">, </span><span class="s1">line </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">line</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;class &quot;</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">start_lineno </span><span class="s3">+ </span><span class="s1">increment</span>
        <span class="s2">return </span><span class="s1">start_lineno</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">from_module</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kws</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;TestLibrary&quot;</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s4">f&quot;Cannot create '</span><span class="s2">{</span><span class="s1">cls</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">}</span><span class="s4">' from module.&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">from_class</span><span class="s3">(</span>
        <span class="s1">cls</span><span class="s3">,</span>
        <span class="s1">klass</span><span class="s3">: </span><span class="s1">type</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">real_name</span><span class="s3">: </span><span class="s4">&quot;str|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">source</span><span class="s3">: </span><span class="s4">&quot;Path|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">args</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = (),</span>
        <span class="s1">variables</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">create_keywords</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">logger</span><span class="s3">=</span><span class="s1">LOGGER</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;ClassLibrary&quot;</span><span class="s3">:</span>
        <span class="s1">init </span><span class="s3">= </span><span class="s1">LibraryInit</span><span class="s3">.</span><span class="s1">from_class</span><span class="s3">(</span><span class="s1">klass</span><span class="s3">)</span>
        <span class="s1">library </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">(</span><span class="s1">klass</span><span class="s3">, </span><span class="s1">init</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">real_name</span><span class="s3">, </span><span class="s1">source</span><span class="s3">, </span><span class="s1">logger</span><span class="s3">)</span>
        <span class="s1">positional</span><span class="s3">, </span><span class="s1">named </span><span class="s3">= </span><span class="s1">init</span><span class="s3">.</span><span class="s1">args</span><span class="s3">.</span><span class="s1">resolve</span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">variables</span><span class="s3">=</span><span class="s1">variables</span><span class="s3">)</span>
        <span class="s1">init</span><span class="s3">.</span><span class="s1">positional</span><span class="s3">, </span><span class="s1">init</span><span class="s3">.</span><span class="s1">named </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">positional</span><span class="s3">), </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">named</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">create_keywords</span><span class="s3">:</span>
            <span class="s1">library</span><span class="s3">.</span><span class="s1">create_keywords</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">library</span>

    <span class="s2">def </span><span class="s1">create_keywords</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">StaticKeywordCreator</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">avoid_properties</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">create_keywords</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">HybridLibrary</span><span class="s3">(</span><span class="s1">ClassLibrary</span><span class="s3">):</span>

    <span class="s2">def </span><span class="s1">create_keywords</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">names </span><span class="s3">= </span><span class="s1">DynamicKeywordCreator</span><span class="s3">(</span><span class="s1">self</span><span class="s3">).</span><span class="s1">get_keyword_names</span><span class="s3">()</span>
        <span class="s1">creator </span><span class="s3">= </span><span class="s1">StaticKeywordCreator</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">getting_method_failed_level</span><span class="s3">=</span><span class="s4">&quot;ERROR&quot;</span><span class="s3">)</span>
        <span class="s1">creator</span><span class="s3">.</span><span class="s1">create_keywords</span><span class="s3">(</span><span class="s1">names</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">DynamicLibrary</span><span class="s3">(</span><span class="s1">ClassLibrary</span><span class="s3">):</span>
    <span class="s1">_supports_named_args </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">supports_named_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_supports_named_args </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_supports_named_args </span><span class="s3">= </span><span class="s1">RunKeyword</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">instance</span><span class="s3">).</span><span class="s1">supports_named_args</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_supports_named_args</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">doc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">GetKeywordDocumentation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">instance</span><span class="s3">)(</span><span class="s4">&quot;__intro__&quot;</span><span class="s3">) </span><span class="s2">or </span><span class="s1">super</span><span class="s3">().</span><span class="s1">doc</span>

    <span class="s2">def </span><span class="s1">create_keywords</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">DynamicKeywordCreator</span><span class="s3">(</span><span class="s1">self</span><span class="s3">).</span><span class="s1">create_keywords</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">KeywordCreator</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">library</span><span class="s3">: </span><span class="s1">TestLibrary</span><span class="s3">, </span><span class="s1">getting_method_failed_level</span><span class="s3">=</span><span class="s4">&quot;INFO&quot;</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">library </span><span class="s3">= </span><span class="s1">library</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">getting_method_failed_level </span><span class="s3">= </span><span class="s1">getting_method_failed_level</span>

    <span class="s2">def </span><span class="s1">get_keyword_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;list[str]&quot;</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>

    <span class="s2">def </span><span class="s1">create_keywords</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">names</span><span class="s3">: </span><span class="s4">&quot;list[str]|None&quot; </span><span class="s3">= </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">library </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">library</span>
        <span class="s1">library</span><span class="s3">.</span><span class="s1">keyword_finder</span><span class="s3">.</span><span class="s1">invalidate_cache</span><span class="s3">()</span>
        <span class="s1">instance </span><span class="s3">= </span><span class="s1">library</span><span class="s3">.</span><span class="s1">instance</span>
        <span class="s1">keywords </span><span class="s3">= </span><span class="s1">library</span><span class="s3">.</span><span class="s1">keywords </span><span class="s3">= []</span>
        <span class="s2">if </span><span class="s1">names </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">names </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_keyword_names</span><span class="s3">()</span>
        <span class="s1">seen </span><span class="s3">= </span><span class="s1">NormalizedDict</span><span class="s3">(</span><span class="s1">ignore</span><span class="s3">=</span><span class="s4">&quot;_&quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">names</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">kw </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_create_keyword</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">DataError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_adding_keyword_failed</span><span class="s3">(</span>
                    <span class="s1">name</span><span class="s3">, </span><span class="s1">err</span><span class="s3">.</span><span class="s1">message</span><span class="s3">, </span><span class="s1">err</span><span class="s3">.</span><span class="s1">details</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getting_method_failed_level</span>
                <span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">kw</span><span class="s3">:</span>
                    <span class="s2">continue</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">embedded</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_validate_embedded</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_duplicates</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">, </span><span class="s1">seen</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">DataError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_adding_keyword_failed</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">err</span><span class="s3">.</span><span class="s1">message</span><span class="s3">, </span><span class="s1">err</span><span class="s3">.</span><span class="s1">details</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">keywords</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">)</span>
                    <span class="s1">library</span><span class="s3">.</span><span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">f&quot;Created keyword '</span><span class="s2">{</span><span class="s1">kw</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">'.&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_create_keyword</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;LibraryKeyword|None&quot;</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>

    <span class="s2">def </span><span class="s1">_handle_duplicates</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kw</span><span class="s3">: </span><span class="s1">LibraryKeyword</span><span class="s3">, </span><span class="s1">seen</span><span class="s3">: </span><span class="s1">NormalizedDict</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">name </span><span class="s2">in </span><span class="s1">seen</span><span class="s3">:</span>
            <span class="s1">error </span><span class="s3">= </span><span class="s4">&quot;Keyword with same name defined multiple times.&quot;</span>
            <span class="s1">seen</span><span class="s3">[</span><span class="s1">kw</span><span class="s3">.</span><span class="s1">name</span><span class="s3">].</span><span class="s1">error </span><span class="s3">= </span><span class="s1">error</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s1">error</span><span class="s3">)</span>
        <span class="s1">seen</span><span class="s3">[</span><span class="s1">kw</span><span class="s3">.</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">kw</span>

    <span class="s2">def </span><span class="s1">_validate_embedded</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kw</span><span class="s3">: </span><span class="s1">LibraryKeyword</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">.</span><span class="s1">embedded</span><span class="s3">.</span><span class="s1">args</span><span class="s3">) &gt; </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">args</span><span class="s3">.</span><span class="s1">maxargs</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span>
                <span class="s4">&quot;Keyword must accept at least as many positional arguments &quot;</span>
                <span class="s4">&quot;as it has embedded arguments.&quot;</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">any</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">.</span><span class="s1">embedded</span><span class="s3">.</span><span class="s1">types</span><span class="s3">):</span>
            <span class="s1">arg</span><span class="s3">, </span><span class="s1">typ </span><span class="s3">= </span><span class="s1">next</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">t</span><span class="s3">) </span><span class="s2">for </span><span class="s1">a</span><span class="s3">, </span><span class="s1">t </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">.</span><span class="s1">embedded</span><span class="s3">.</span><span class="s1">args</span><span class="s3">, </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">embedded</span><span class="s3">.</span><span class="s1">types</span><span class="s3">) </span><span class="s2">if </span><span class="s1">t</span>
            <span class="s3">)</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span>
                <span class="s4">f&quot;Library keywords do not support type information with &quot;</span>
                <span class="s4">f&quot;embedded arguments like '$</span><span class="s2">{{{</span><span class="s1">arg</span><span class="s2">}</span><span class="s4">: </span><span class="s2">{</span><span class="s1">typ</span><span class="s2">}}}</span><span class="s4">'. &quot;</span>
                <span class="s4">f&quot;Use type hints with function arguments instead.&quot;</span>
            <span class="s3">)</span>
        <span class="s1">kw</span><span class="s3">.</span><span class="s1">args</span><span class="s3">.</span><span class="s1">embedded </span><span class="s3">= </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">embedded</span><span class="s3">.</span><span class="s1">args</span>

    <span class="s2">def </span><span class="s1">_adding_keyword_failed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">error</span><span class="s3">, </span><span class="s1">details</span><span class="s3">, </span><span class="s1">level</span><span class="s3">=</span><span class="s4">&quot;ERROR&quot;</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">library</span><span class="s3">.</span><span class="s1">report_error</span><span class="s3">(</span>
            <span class="s4">f&quot;Adding keyword '</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s4">' failed: </span><span class="s2">{</span><span class="s1">error</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
            <span class="s1">details</span><span class="s3">,</span>
            <span class="s1">level</span><span class="s3">=</span><span class="s1">level</span><span class="s3">,</span>
            <span class="s1">details_level</span><span class="s3">=</span><span class="s4">&quot;DEBUG&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s2">class </span><span class="s1">StaticKeywordCreator</span><span class="s3">(</span><span class="s1">KeywordCreator</span><span class="s3">):</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">library</span><span class="s3">: </span><span class="s1">TestLibrary</span><span class="s3">,</span>
        <span class="s1">getting_method_failed_level</span><span class="s3">=</span><span class="s4">&quot;INFO&quot;</span><span class="s3">,</span>
        <span class="s1">included_names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">avoid_properties</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">library</span><span class="s3">, </span><span class="s1">getting_method_failed_level</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">included_names </span><span class="s3">= </span><span class="s1">included_names</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">avoid_properties </span><span class="s3">= </span><span class="s1">avoid_properties</span>

    <span class="s2">def </span><span class="s1">get_keyword_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;list[str]&quot;</span><span class="s3">:</span>
        <span class="s1">instance </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">library</span><span class="s3">.</span><span class="s1">instance</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_names</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s1">message</span><span class="s3">, </span><span class="s1">details </span><span class="s3">= </span><span class="s1">get_error_details</span><span class="s3">()</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span>
                <span class="s4">f&quot;Getting keyword names from library '</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">library</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">' &quot;</span>
                <span class="s4">f&quot;failed: </span><span class="s2">{</span><span class="s1">message</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s1">details</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;list[str]&quot;</span><span class="s3">:</span>
        <span class="s1">names </span><span class="s3">= []</span>
        <span class="s1">auto_keywords </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">, </span><span class="s4">&quot;ROBOT_AUTO_KEYWORDS&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">included_names </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">included_names</span>
        <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_included</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">auto_keywords</span><span class="s3">, </span><span class="s1">included_names</span><span class="s3">):</span>
                <span class="s1">names</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">names</span>

    <span class="s2">def </span><span class="s1">_is_included</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">auto_keywords</span><span class="s3">, </span><span class="s1">included_names</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s3">(</span>
            <span class="s1">auto_keywords</span>
            <span class="s2">and </span><span class="s1">name</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">] != </span><span class="s4">&quot;_&quot;</span>
            <span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_explicitly_included</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s2">return False</span>
        <span class="s2">return </span><span class="s1">included_names </span><span class="s2">is None or </span><span class="s1">name </span><span class="s2">in </span><span class="s1">included_names</span>

    <span class="s2">def </span><span class="s1">_is_explicitly_included</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">candidate </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">getattr_static</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:  </span><span class="s0"># Attribute is dynamic. Try harder.</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">candidate </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:  </span><span class="s0"># Attribute is invalid. Report.</span>
                <span class="s1">msg</span><span class="s3">, </span><span class="s1">details </span><span class="s3">= </span><span class="s1">get_error_details</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_adding_keyword_failed</span><span class="s3">(</span>
                    <span class="s1">name</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">, </span><span class="s1">details</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getting_method_failed_level</span>
                <span class="s3">)</span>
                <span class="s2">return False</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">candidate</span><span class="s3">, (</span><span class="s1">classmethod</span><span class="s3">, </span><span class="s1">staticmethod</span><span class="s3">)):</span>
            <span class="s1">candidate </span><span class="s3">= </span><span class="s1">candidate</span><span class="s3">.</span><span class="s1">__func__</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">candidate</span><span class="s3">, </span><span class="s4">&quot;robot_name&quot;</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s2">return False</span>

    <span class="s2">def </span><span class="s1">_create_keyword</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;StaticKeyword|None&quot;</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">avoid_properties</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_pre_validate_method</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">method </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s1">message</span><span class="s3">, </span><span class="s1">details </span><span class="s3">= </span><span class="s1">get_error_details</span><span class="s3">()</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s4">f&quot;Getting handler method failed: </span><span class="s2">{</span><span class="s1">message</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">details</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_validate_method</span><span class="s3">(</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">StaticKeyword</span><span class="s3">.</span><span class="s1">from_name</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">library</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">DataError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_adding_keyword_failed</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">err</span><span class="s3">.</span><span class="s1">message</span><span class="s3">, </span><span class="s1">err</span><span class="s3">.</span><span class="s1">details</span><span class="s3">)</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">_pre_validate_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">candidate </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">getattr_static</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:  </span><span class="s0"># Attribute is dynamic. Cannot pre-validate.</span>
            <span class="s2">return</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">candidate</span><span class="s3">, </span><span class="s1">classmethod</span><span class="s3">):</span>
            <span class="s1">candidate </span><span class="s3">= </span><span class="s1">candidate</span><span class="s3">.</span><span class="s1">__func__</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">candidate</span><span class="s3">, </span><span class="s1">cached_property</span><span class="s3">) </span><span class="s2">or not </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">isroutine</span><span class="s3">(</span><span class="s1">candidate</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s4">&quot;Not a method or function.&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_validate_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">candidate</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s3">(</span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">isroutine</span><span class="s3">(</span><span class="s1">candidate</span><span class="s3">) </span><span class="s2">or </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">candidate</span><span class="s3">, </span><span class="s1">partial</span><span class="s3">)):</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s4">&quot;Not a method or function.&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">candidate</span><span class="s3">, </span><span class="s4">&quot;robot_not_keyword&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span><span class="s4">&quot;Not exposed as a keyword.&quot;</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">DynamicKeywordCreator</span><span class="s3">(</span><span class="s1">KeywordCreator</span><span class="s3">):</span>
    <span class="s1">library</span><span class="s3">: </span><span class="s1">DynamicLibrary</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">library</span><span class="s3">: </span><span class="s4">&quot;DynamicLibrary|HybridLibrary&quot;</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">library</span><span class="s3">, </span><span class="s1">getting_method_failed_level</span><span class="s3">=</span><span class="s4">&quot;ERROR&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_keyword_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;list[str]&quot;</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">GetKeywordNames</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">library</span><span class="s3">.</span><span class="s1">instance</span><span class="s3">)()</span>
        <span class="s2">except </span><span class="s1">DataError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DataError</span><span class="s3">(</span>
                <span class="s4">f&quot;Getting keyword names from library '</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">library</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">' &quot;</span>
                <span class="s4">f&quot;failed: </span><span class="s2">{</span><span class="s1">err</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_create_keyword</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">name</span><span class="s3">) </span><span class="s1">-&gt; DynamicKeyword</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">DynamicKeyword</span><span class="s3">.</span><span class="s1">from_name</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">library</span><span class="s3">)</span>
</pre>
</body>
</html>