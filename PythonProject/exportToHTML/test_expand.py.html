<html>
<head>
<title>test_expand.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #a5c261;}
.s6 { color: #2aacb8;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_expand.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">_static </span><span class="s0">import </span><span class="s1">is_static</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">config </span><span class="s0">import </span><span class="s1">expand</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">discovery </span><span class="s0">import </span><span class="s1">find_package_path</span>

<span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">DistutilsOptionError</span>


<span class="s0">def </span><span class="s1">write_files</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">root_dir</span><span class="s2">):</span>
    <span class="s0">for </span><span class="s1">file</span><span class="s2">, </span><span class="s1">content </span><span class="s0">in </span><span class="s1">files</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">root_dir </span><span class="s2">/ </span><span class="s1">file</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parents</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">content</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_glob_relative</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s3">&quot;dir1/dir2/dir3/file1.txt&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;dir1/dir2/file2.txt&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;dir1/file3.txt&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;a.ini&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;b.ini&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;dir1/c.ini&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;dir1/dir2/a.ini&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>

    <span class="s1">write_files</span><span class="s2">({</span><span class="s1">k</span><span class="s2">: </span><span class="s3">&quot;&quot; </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">files</span><span class="s2">}, </span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">patterns </span><span class="s2">= [</span><span class="s3">&quot;**/*.txt&quot;</span><span class="s2">, </span><span class="s3">&quot;[ab].*&quot;</span><span class="s2">, </span><span class="s3">&quot;**/[ac].ini&quot;</span><span class="s2">]</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">expand</span><span class="s2">.</span><span class="s1">glob_relative</span><span class="s2">(</span><span class="s1">patterns</span><span class="s2">)) == </span><span class="s1">files</span>
    <span class="s4"># Make sure the same APIs work outside cwd</span>
    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">expand</span><span class="s2">.</span><span class="s1">glob_relative</span><span class="s2">(</span><span class="s1">patterns</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)) == </span><span class="s1">files</span>


<span class="s0">def </span><span class="s1">test_read_files</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">dir_ </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;dir_&quot;</span>
    <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;_dir&quot;</span><span class="s2">).</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;a.txt&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>
    <span class="s1">files </span><span class="s2">= {</span><span class="s3">&quot;a.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;dir1/b.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;dir1/dir2/c.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;c&quot;</span><span class="s2">}</span>
    <span class="s1">write_files</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">dir_</span><span class="s2">)</span>

    <span class="s1">secrets </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">dir_</span><span class="s2">) + </span><span class="s3">&quot;secrets&quot;</span><span class="s2">)</span>
    <span class="s1">secrets</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">write_files</span><span class="s2">({</span><span class="s3">&quot;secrets.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;secret keys&quot;</span><span class="s2">}, </span><span class="s1">secrets</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">context</span><span class="s2">() </span><span class="s0">as </span><span class="s1">m</span><span class="s2">:</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dir_</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_files</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)) == </span><span class="s3">&quot;a</span><span class="s0">\n</span><span class="s3">b</span><span class="s0">\n</span><span class="s3">c&quot;</span>

        <span class="s1">cannot_access_msg </span><span class="s2">= </span><span class="s3">r&quot;Cannot access '.*\.\..a\.txt'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">DistutilsOptionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">cannot_access_msg</span><span class="s2">):</span>
            <span class="s1">expand</span><span class="s2">.</span><span class="s1">read_files</span><span class="s2">([</span><span class="s3">&quot;../a.txt&quot;</span><span class="s2">])</span>

        <span class="s1">cannot_access_secrets_msg </span><span class="s2">= </span><span class="s3">r&quot;Cannot access '.*secrets\.txt'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">DistutilsOptionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">cannot_access_secrets_msg</span><span class="s2">):</span>
            <span class="s1">expand</span><span class="s2">.</span><span class="s1">read_files</span><span class="s2">([</span><span class="s3">&quot;../dir_secrets/secrets.txt&quot;</span><span class="s2">])</span>

    <span class="s4"># Make sure the same APIs work outside cwd</span>
    <span class="s0">assert </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_files</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">files</span><span class="s2">), </span><span class="s1">dir_</span><span class="s2">) == </span><span class="s3">&quot;a</span><span class="s0">\n</span><span class="s3">b</span><span class="s0">\n</span><span class="s3">c&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">DistutilsOptionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">cannot_access_msg</span><span class="s2">):</span>
        <span class="s1">expand</span><span class="s2">.</span><span class="s1">read_files</span><span class="s2">([</span><span class="s3">&quot;../a.txt&quot;</span><span class="s2">], </span><span class="s1">dir_</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestReadAttr</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;example&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s4"># No cookie means UTF-8:</span>
            <span class="s5">b&quot;__version__ = '</span><span class="s0">\xc3\xa9</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">raise SystemExit(1)</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s2">,</span>
            <span class="s4"># If a cookie is present, honor it:</span>
            <span class="s5">b&quot;# -*- coding: utf-8 -*-</span><span class="s0">\n</span><span class="s5">__version__ = '</span><span class="s0">\xc3\xa9</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">raise SystemExit(1)</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s2">,</span>
            <span class="s5">b&quot;# -*- coding: latin1 -*-</span><span class="s0">\n</span><span class="s5">__version__ = '</span><span class="s0">\xe9</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">raise SystemExit(1)</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_read_attr_encoding_cookie</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">example</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;mod.py&quot;</span><span class="s2">).</span><span class="s1">write_bytes</span><span class="s2">(</span><span class="s1">example</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_attr</span><span class="s2">(</span><span class="s3">'mod.__version__'</span><span class="s2">, </span><span class="s1">root_dir</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">) == </span><span class="s3">'é'</span>

    <span class="s0">def </span><span class="s1">test_read_attr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;pkg/__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pkg/sub/__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;VERSION = '0.1.1'&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pkg/sub/mod.py&quot;</span><span class="s2">: (</span>
                <span class="s3">&quot;VALUES = {'a': 0, 'b': {42}, 'c': (0, 1, 1)}</span><span class="s0">\n</span><span class="s3">raise SystemExit(1)&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">write_files</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">context</span><span class="s2">() </span><span class="s0">as </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s1">m</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>
            <span class="s4"># Make sure it can read the attr statically without evaluating the module</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_attr</span><span class="s2">(</span><span class="s3">'pkg.sub.VERSION'</span><span class="s2">)</span>
            <span class="s1">values </span><span class="s2">= </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_attr</span><span class="s2">(</span><span class="s3">'lib.mod.VALUES'</span><span class="s2">, {</span><span class="s3">'lib'</span><span class="s2">: </span><span class="s3">'pkg/sub'</span><span class="s2">})</span>

        <span class="s0">assert </span><span class="s1">version </span><span class="s2">== </span><span class="s3">'0.1.1'</span>
        <span class="s0">assert </span><span class="s1">is_static</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">values</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] == </span><span class="s6">0</span>
        <span class="s0">assert </span><span class="s1">values</span><span class="s2">[</span><span class="s3">'b'</span><span class="s2">] == {</span><span class="s6">42</span><span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">is_static</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>

        <span class="s4"># Make sure the same APIs work outside cwd</span>
        <span class="s0">assert </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_attr</span><span class="s2">(</span><span class="s3">'pkg.sub.VERSION'</span><span class="s2">, </span><span class="s1">root_dir</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">) == </span><span class="s3">'0.1.1'</span>
        <span class="s1">values </span><span class="s2">= </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_attr</span><span class="s2">(</span><span class="s3">'lib.mod.VALUES'</span><span class="s2">, {</span><span class="s3">'lib'</span><span class="s2">: </span><span class="s3">'pkg/sub'</span><span class="s2">}, </span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">values</span><span class="s2">[</span><span class="s3">'c'</span><span class="s2">] == (</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;example&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s3">&quot;VERSION: str</span><span class="s0">\n</span><span class="s3">VERSION = '0.1.1'</span><span class="s0">\n</span><span class="s3">raise SystemExit(1)</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;VERSION: str = '0.1.1'</span><span class="s0">\n</span><span class="s3">raise SystemExit(1)</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_read_annotated_attr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">example</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;pkg/__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pkg/sub/__init__.py&quot;</span><span class="s2">: </span><span class="s1">example</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s1">write_files</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s4"># Make sure this attribute can be read statically</span>
        <span class="s1">version </span><span class="s2">= </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_attr</span><span class="s2">(</span><span class="s3">'pkg.sub.VERSION'</span><span class="s2">, </span><span class="s1">root_dir</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">version </span><span class="s2">== </span><span class="s3">'0.1.1'</span>
        <span class="s0">assert </span><span class="s1">is_static</span><span class="s2">(</span><span class="s1">version</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;example&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s3">&quot;VERSION = (lambda: '0.1.1')()</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;def fn(): return '0.1.1'</span><span class="s0">\n</span><span class="s3">VERSION = fn()</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;VERSION: str = (lambda: '0.1.1')()</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_read_dynamic_attr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">example</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;pkg/__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pkg/sub/__init__.py&quot;</span><span class="s2">: </span><span class="s1">example</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s1">write_files</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">version </span><span class="s2">= </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_attr</span><span class="s2">(</span><span class="s3">'pkg.sub.VERSION'</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">version </span><span class="s2">== </span><span class="s3">'0.1.1'</span>
        <span class="s0">assert not </span><span class="s1">is_static</span><span class="s2">(</span><span class="s1">version</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_import_order</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s7">&quot;&quot;&quot; 
        Sometimes the import machinery will import the parent package of a nested 
        module, which triggers side-effects and might create problems (see issue #3176) 
 
        ``read_attr`` should bypass these limitations by resolving modules statically 
        (via ast.literal_eval). 
        &quot;&quot;&quot;</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">&quot;src/pkg/__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;from .main import func</span><span class="s0">\n</span><span class="s3">from .about import version&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;src/pkg/main.py&quot;</span><span class="s2">: </span><span class="s3">&quot;import super_complicated_dep</span><span class="s0">\n</span><span class="s3">def func(): return 42&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;src/pkg/about.py&quot;</span><span class="s2">: </span><span class="s3">&quot;version = '42'&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s1">write_files</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">attr_desc </span><span class="s2">= </span><span class="s3">&quot;pkg.about.version&quot;</span>
        <span class="s1">package_dir </span><span class="s2">= {</span><span class="s3">&quot;&quot;</span><span class="s2">: </span><span class="s3">&quot;src&quot;</span><span class="s2">}</span>
        <span class="s4"># `import super_complicated_dep` should not run, otherwise the build fails</span>
        <span class="s0">assert </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">read_attr</span><span class="s2">(</span><span class="s1">attr_desc</span><span class="s2">, </span><span class="s1">package_dir</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">) == </span><span class="s3">&quot;42&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;package_dir&quot;</span><span class="s2">, </span><span class="s3">&quot;file&quot;</span><span class="s2">, </span><span class="s3">&quot;module&quot;</span><span class="s2">, </span><span class="s3">&quot;return_value&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">({</span><span class="s3">&quot;&quot;</span><span class="s2">: </span><span class="s3">&quot;src&quot;</span><span class="s2">}, </span><span class="s3">&quot;src/pkg/main.py&quot;</span><span class="s2">, </span><span class="s3">&quot;pkg.main&quot;</span><span class="s2">, </span><span class="s6">42</span><span class="s2">),</span>
        <span class="s2">({</span><span class="s3">&quot;pkg&quot;</span><span class="s2">: </span><span class="s3">&quot;lib&quot;</span><span class="s2">}, </span><span class="s3">&quot;lib/main.py&quot;</span><span class="s2">, </span><span class="s3">&quot;pkg.main&quot;</span><span class="s2">, </span><span class="s6">13</span><span class="s2">),</span>
        <span class="s2">({}, </span><span class="s3">&quot;single_module.py&quot;</span><span class="s2">, </span><span class="s3">&quot;single_module&quot;</span><span class="s2">, </span><span class="s6">70</span><span class="s2">),</span>
        <span class="s2">({}, </span><span class="s3">&quot;flat_layout/pkg.py&quot;</span><span class="s2">, </span><span class="s3">&quot;flat_layout.pkg&quot;</span><span class="s2">, </span><span class="s6">836</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_resolve_class</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">package_dir</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">module</span><span class="s2">, </span><span class="s1">return_value</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">, </span><span class="s3">&quot;modules&quot;</span><span class="s2">, {})  </span><span class="s4"># reproducibility</span>
    <span class="s1">files </span><span class="s2">= {</span><span class="s1">file</span><span class="s2">: </span><span class="s3">f&quot;class Custom:</span><span class="s0">\n    </span><span class="s3">def testing(self): return </span><span class="s0">{</span><span class="s1">return_value</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">}</span>
    <span class="s1">write_files</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">cls </span><span class="s2">= </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">resolve_class</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">module</span><span class="s0">}</span><span class="s3">.Custom&quot;</span><span class="s2">, </span><span class="s1">package_dir</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">cls</span><span class="s2">().</span><span class="s1">testing</span><span class="s2">() == </span><span class="s1">return_value</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;args&quot;</span><span class="s2">, </span><span class="s3">&quot;pkgs&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">({</span><span class="s3">&quot;where&quot;</span><span class="s2">: [</span><span class="s3">&quot;.&quot;</span><span class="s2">], </span><span class="s3">&quot;namespaces&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">}, {</span><span class="s3">&quot;pkg&quot;</span><span class="s2">, </span><span class="s3">&quot;other&quot;</span><span class="s2">}),</span>
        <span class="s2">({</span><span class="s3">&quot;where&quot;</span><span class="s2">: [</span><span class="s3">&quot;.&quot;</span><span class="s2">, </span><span class="s3">&quot;dir1&quot;</span><span class="s2">], </span><span class="s3">&quot;namespaces&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">}, {</span><span class="s3">&quot;pkg&quot;</span><span class="s2">, </span><span class="s3">&quot;other&quot;</span><span class="s2">, </span><span class="s3">&quot;dir2&quot;</span><span class="s2">}),</span>
        <span class="s2">({</span><span class="s3">&quot;namespaces&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}, {</span><span class="s3">&quot;pkg&quot;</span><span class="s2">, </span><span class="s3">&quot;other&quot;</span><span class="s2">, </span><span class="s3">&quot;dir1&quot;</span><span class="s2">, </span><span class="s3">&quot;dir1.dir2&quot;</span><span class="s2">}),</span>
        <span class="s2">({}, {</span><span class="s3">&quot;pkg&quot;</span><span class="s2">, </span><span class="s3">&quot;other&quot;</span><span class="s2">, </span><span class="s3">&quot;dir1&quot;</span><span class="s2">, </span><span class="s3">&quot;dir1.dir2&quot;</span><span class="s2">}),  </span><span class="s4"># default value for `namespaces`</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_find_packages</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">pkgs</span><span class="s2">):</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s3">&quot;pkg/__init__.py&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;other/__init__.py&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;dir1/dir2/__init__.py&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s1">write_files</span><span class="s2">({</span><span class="s1">k</span><span class="s2">: </span><span class="s3">&quot;&quot; </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">files</span><span class="s2">}, </span><span class="s1">tmp_path</span><span class="s2">)</span>

    <span class="s1">package_dir </span><span class="s2">= {}</span>
    <span class="s1">kwargs </span><span class="s2">= {</span><span class="s3">&quot;root_dir&quot;</span><span class="s2">: </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s3">&quot;fill_package_dir&quot;</span><span class="s2">: </span><span class="s1">package_dir</span><span class="s2">, **</span><span class="s1">args</span><span class="s2">}</span>
    <span class="s1">where </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;where&quot;</span><span class="s2">, [</span><span class="s3">&quot;.&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">expand</span><span class="s2">.</span><span class="s1">find_packages</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)) == </span><span class="s1">pkgs</span>
    <span class="s0">for </span><span class="s1">pkg </span><span class="s0">in </span><span class="s1">pkgs</span><span class="s2">:</span>
        <span class="s1">pkg_path </span><span class="s2">= </span><span class="s1">find_package_path</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">, </span><span class="s1">package_dir</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">pkg_path</span><span class="s2">)</span>

    <span class="s4"># Make sure the same APIs work outside cwd</span>
    <span class="s1">where </span><span class="s2">= [</span>
        <span class="s1">str</span><span class="s2">((</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">p</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">()).</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">, </span><span class="s3">&quot;/&quot;</span><span class="s2">)  </span><span class="s4"># ensure posix-style paths</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">args</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">&quot;where&quot;</span><span class="s2">, [</span><span class="s3">&quot;.&quot;</span><span class="s2">])</span>
    <span class="s2">]</span>

    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">expand</span><span class="s2">.</span><span class="s1">find_packages</span><span class="s2">(</span><span class="s1">where</span><span class="s2">=</span><span class="s1">where</span><span class="s2">, **</span><span class="s1">args</span><span class="s2">)) == </span><span class="s1">pkgs</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;files&quot;</span><span class="s2">, </span><span class="s3">&quot;where&quot;</span><span class="s2">, </span><span class="s3">&quot;expected_package_dir&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s3">&quot;pkg1/__init__.py&quot;</span><span class="s2">, </span><span class="s3">&quot;pkg1/other.py&quot;</span><span class="s2">], [</span><span class="s3">&quot;.&quot;</span><span class="s2">], {}),</span>
        <span class="s2">([</span><span class="s3">&quot;pkg1/__init__.py&quot;</span><span class="s2">, </span><span class="s3">&quot;pkg2/__init__.py&quot;</span><span class="s2">], [</span><span class="s3">&quot;.&quot;</span><span class="s2">], {}),</span>
        <span class="s2">([</span><span class="s3">&quot;src/pkg1/__init__.py&quot;</span><span class="s2">, </span><span class="s3">&quot;src/pkg1/other.py&quot;</span><span class="s2">], [</span><span class="s3">&quot;src&quot;</span><span class="s2">], {</span><span class="s3">&quot;&quot;</span><span class="s2">: </span><span class="s3">&quot;src&quot;</span><span class="s2">}),</span>
        <span class="s2">([</span><span class="s3">&quot;src/pkg1/__init__.py&quot;</span><span class="s2">, </span><span class="s3">&quot;src/pkg2/__init__.py&quot;</span><span class="s2">], [</span><span class="s3">&quot;src&quot;</span><span class="s2">], {</span><span class="s3">&quot;&quot;</span><span class="s2">: </span><span class="s3">&quot;src&quot;</span><span class="s2">}),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s3">&quot;src1/pkg1/__init__.py&quot;</span><span class="s2">, </span><span class="s3">&quot;src2/pkg2/__init__.py&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;src1&quot;</span><span class="s2">, </span><span class="s3">&quot;src2&quot;</span><span class="s2">],</span>
            <span class="s2">{</span><span class="s3">&quot;pkg1&quot;</span><span class="s2">: </span><span class="s3">&quot;src1/pkg1&quot;</span><span class="s2">, </span><span class="s3">&quot;pkg2&quot;</span><span class="s2">: </span><span class="s3">&quot;src2/pkg2&quot;</span><span class="s2">},</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s3">&quot;src/pkg1/__init__.py&quot;</span><span class="s2">, </span><span class="s3">&quot;pkg2/__init__.py&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;src&quot;</span><span class="s2">, </span><span class="s3">&quot;.&quot;</span><span class="s2">],</span>
            <span class="s2">{</span><span class="s3">&quot;pkg1&quot;</span><span class="s2">: </span><span class="s3">&quot;src/pkg1&quot;</span><span class="s2">},</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_fill_package_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">where</span><span class="s2">, </span><span class="s1">expected_package_dir</span><span class="s2">):</span>
    <span class="s1">write_files</span><span class="s2">({</span><span class="s1">k</span><span class="s2">: </span><span class="s3">&quot;&quot; </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">files</span><span class="s2">}, </span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">pkg_dir </span><span class="s2">= {}</span>
    <span class="s1">kwargs </span><span class="s2">= {</span><span class="s3">&quot;root_dir&quot;</span><span class="s2">: </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s3">&quot;fill_package_dir&quot;</span><span class="s2">: </span><span class="s1">pkg_dir</span><span class="s2">, </span><span class="s3">&quot;namespaces&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">}</span>
    <span class="s1">pkgs </span><span class="s2">= </span><span class="s1">expand</span><span class="s2">.</span><span class="s1">find_packages</span><span class="s2">(</span><span class="s1">where</span><span class="s2">=</span><span class="s1">where</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">pkg_dir</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()) == </span><span class="s1">set</span><span class="s2">(</span><span class="s1">expected_package_dir</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
    <span class="s0">for </span><span class="s1">pkg </span><span class="s0">in </span><span class="s1">pkgs</span><span class="s2">:</span>
        <span class="s1">pkg_path </span><span class="s2">= </span><span class="s1">find_package_path</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">, </span><span class="s1">pkg_dir</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">pkg_path</span><span class="s2">)</span>
</pre>
</body>
</html>