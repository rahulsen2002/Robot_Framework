<html>
<head>
<title>pylock.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pylock.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">dataclasses</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">from </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc </span><span class="s0">import </span><span class="s1">Iterable</span>
<span class="s0">from </span><span class="s1">dataclasses </span><span class="s0">import </span><span class="s1">dataclass</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">TYPE_CHECKING</span><span class="s2">, </span><span class="s1">Any</span>

<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor </span><span class="s0">import </span><span class="s1">tomli_w</span>

<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">direct_url </span><span class="s0">import </span><span class="s1">ArchiveInfo</span><span class="s2">, </span><span class="s1">DirInfo</span><span class="s2">, </span><span class="s1">VcsInfo</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">link </span><span class="s0">import </span><span class="s1">Link</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">req</span><span class="s2">.</span><span class="s1">req_install </span><span class="s0">import </span><span class="s1">InstallRequirement</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">urls </span><span class="s0">import </span><span class="s1">url_to_path</span>

<span class="s0">if </span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">typing_extensions </span><span class="s0">import </span><span class="s1">Self</span>

<span class="s1">PYLOCK_FILE_NAME_RE </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s3">r&quot;^pylock\.([^.]+)\.toml$&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">is_valid_pylock_file_name</span><span class="s2">(</span><span class="s1">path</span><span class="s2">: </span><span class="s1">Path</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s0">return </span><span class="s1">path</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;pylock.toml&quot; </span><span class="s0">or </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">PYLOCK_FILE_NAME_RE</span><span class="s2">, </span><span class="s1">path</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_toml_dict_factory</span><span class="s2">(</span><span class="s1">data</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">]]) </span><span class="s1">-&gt; dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">]:</span>
    <span class="s0">return </span><span class="s2">{</span><span class="s1">key</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">&quot;_&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">): </span><span class="s1">value </span><span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">data </span><span class="s0">if </span><span class="s1">value </span><span class="s0">is not None</span><span class="s2">}</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">PackageVcs</span><span class="s2">:</span>
    <span class="s1">type</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">url</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span>
    <span class="s4"># (not supported) path: Optional[str]</span>
    <span class="s1">requested_revision</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span>
    <span class="s1">commit_id</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">subdirectory</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">PackageDirectory</span><span class="s2">:</span>
    <span class="s1">path</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">editable</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">| </span><span class="s0">None</span>
    <span class="s1">subdirectory</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">PackageArchive</span><span class="s2">:</span>
    <span class="s1">url</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span>
    <span class="s4"># (not supported) path: Optional[str]</span>
    <span class="s4"># (not supported) size: Optional[int]</span>
    <span class="s4"># (not supported) upload_time: Optional[datetime]</span>
    <span class="s1">hashes</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]</span>
    <span class="s1">subdirectory</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">PackageSdist</span><span class="s2">:</span>
    <span class="s1">name</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s4"># (not supported) upload_time: Optional[datetime]</span>
    <span class="s1">url</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span>
    <span class="s4"># (not supported) path: Optional[str]</span>
    <span class="s4"># (not supported) size: Optional[int]</span>
    <span class="s1">hashes</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">PackageWheel</span><span class="s2">:</span>
    <span class="s1">name</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s4"># (not supported) upload_time: Optional[datetime]</span>
    <span class="s1">url</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span>
    <span class="s4"># (not supported) path: Optional[str]</span>
    <span class="s4"># (not supported) size: Optional[int]</span>
    <span class="s1">hashes</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">Package</span><span class="s2">:</span>
    <span class="s1">name</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">version</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s4"># (not supported) marker: Optional[str]</span>
    <span class="s4"># (not supported) requires_python: Optional[str]</span>
    <span class="s4"># (not supported) dependencies</span>
    <span class="s1">vcs</span><span class="s2">: </span><span class="s1">PackageVcs </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">directory</span><span class="s2">: </span><span class="s1">PackageDirectory </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">archive</span><span class="s2">: </span><span class="s1">PackageArchive </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s4"># (not supported) index: Optional[str]</span>
    <span class="s1">sdist</span><span class="s2">: </span><span class="s1">PackageSdist </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">wheels</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">PackageWheel</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s4"># (not supported) attestation_identities: Optional[List[Dict[str, Any]]]</span>
    <span class="s4"># (not supported) tool: Optional[Dict[str, Any]]</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">from_install_requirement</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">ireq</span><span class="s2">: </span><span class="s1">InstallRequirement</span><span class="s2">, </span><span class="s1">base_dir</span><span class="s2">: </span><span class="s1">Path</span><span class="s2">) </span><span class="s1">-&gt; Self</span><span class="s2">:</span>
        <span class="s1">base_dir </span><span class="s2">= </span><span class="s1">base_dir</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">()</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">ireq</span><span class="s2">.</span><span class="s1">get_dist</span><span class="s2">()</span>
        <span class="s1">download_info </span><span class="s2">= </span><span class="s1">ireq</span><span class="s2">.</span><span class="s1">download_info</span>
        <span class="s0">assert </span><span class="s1">download_info</span>
        <span class="s1">package </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">canonical_name</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ireq</span><span class="s2">.</span><span class="s1">is_direct</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, </span><span class="s1">VcsInfo</span><span class="s2">):</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">vcs </span><span class="s2">= </span><span class="s1">PackageVcs</span><span class="s2">(</span>
                    <span class="s1">type</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">vcs</span><span class="s2">,</span>
                    <span class="s1">url</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">url</span><span class="s2">,</span>
                    <span class="s1">requested_revision</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">requested_revision</span><span class="s2">,</span>
                    <span class="s1">commit_id</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">commit_id</span><span class="s2">,</span>
                    <span class="s1">subdirectory</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">subdirectory</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, </span><span class="s1">DirInfo</span><span class="s2">):</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">directory </span><span class="s2">= </span><span class="s1">PackageDirectory</span><span class="s2">(</span>
                    <span class="s1">path</span><span class="s2">=(</span>
                        <span class="s1">Path</span><span class="s2">(</span><span class="s1">url_to_path</span><span class="s2">(</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">url</span><span class="s2">))</span>
                        <span class="s2">.</span><span class="s1">resolve</span><span class="s2">()</span>
                        <span class="s2">.</span><span class="s1">relative_to</span><span class="s2">(</span><span class="s1">base_dir</span><span class="s2">)</span>
                        <span class="s2">.</span><span class="s1">as_posix</span><span class="s2">()</span>
                    <span class="s2">),</span>
                    <span class="s1">editable</span><span class="s2">=(</span>
                        <span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">editable</span>
                        <span class="s0">if </span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">editable</span>
                        <span class="s0">else None</span>
                    <span class="s2">),</span>
                    <span class="s1">subdirectory</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">subdirectory</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, </span><span class="s1">ArchiveInfo</span><span class="s2">):</span>
                <span class="s0">if not </span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">hashes</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">()</span>
                <span class="s1">package</span><span class="s2">.</span><span class="s1">archive </span><span class="s2">= </span><span class="s1">PackageArchive</span><span class="s2">(</span>
                    <span class="s1">url</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">url</span><span class="s2">,</span>
                    <span class="s1">hashes</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">hashes</span><span class="s2">,</span>
                    <span class="s1">subdirectory</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">subdirectory</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s4"># should never happen</span>
                <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">package</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, </span><span class="s1">ArchiveInfo</span><span class="s2">):</span>
                <span class="s0">if not </span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">hashes</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">()</span>
                <span class="s1">link </span><span class="s2">= </span><span class="s1">Link</span><span class="s2">(</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">url</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">link</span><span class="s2">.</span><span class="s1">is_wheel</span><span class="s2">:</span>
                    <span class="s1">package</span><span class="s2">.</span><span class="s1">wheels </span><span class="s2">= [</span>
                        <span class="s1">PackageWheel</span><span class="s2">(</span>
                            <span class="s1">name</span><span class="s2">=</span><span class="s1">link</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">,</span>
                            <span class="s1">url</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">url</span><span class="s2">,</span>
                            <span class="s1">hashes</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">hashes</span><span class="s2">,</span>
                        <span class="s2">)</span>
                    <span class="s2">]</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">package</span><span class="s2">.</span><span class="s1">sdist </span><span class="s2">= </span><span class="s1">PackageSdist</span><span class="s2">(</span>
                        <span class="s1">name</span><span class="s2">=</span><span class="s1">link</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">,</span>
                        <span class="s1">url</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">url</span><span class="s2">,</span>
                        <span class="s1">hashes</span><span class="s2">=</span><span class="s1">download_info</span><span class="s2">.</span><span class="s1">info</span><span class="s2">.</span><span class="s1">hashes</span><span class="s2">,</span>
                    <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s4"># should never happen</span>
                <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">package</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">Pylock</span><span class="s2">:</span>
    <span class="s1">lock_version</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;1.0&quot;</span>
    <span class="s4"># (not supported) environments: Optional[List[str]]</span>
    <span class="s4"># (not supported) requires_python: Optional[str]</span>
    <span class="s4"># (not supported) extras: List[str] = []</span>
    <span class="s4"># (not supported) dependency_groups: List[str] = []</span>
    <span class="s1">created_by</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;pip&quot;</span>
    <span class="s1">packages</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">Package</span><span class="s2">] = </span><span class="s1">dataclasses</span><span class="s2">.</span><span class="s1">field</span><span class="s2">(</span><span class="s1">default_factory</span><span class="s2">=</span><span class="s1">list</span><span class="s2">)</span>
    <span class="s4"># (not supported) tool: Optional[Dict[str, Any]]</span>

    <span class="s0">def </span><span class="s1">as_toml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">tomli_w</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">dataclasses</span><span class="s2">.</span><span class="s1">asdict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dict_factory</span><span class="s2">=</span><span class="s1">_toml_dict_factory</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">from_install_requirements</span><span class="s2">(</span>
        <span class="s1">cls</span><span class="s2">, </span><span class="s1">install_requirements</span><span class="s2">: </span><span class="s1">Iterable</span><span class="s2">[</span><span class="s1">InstallRequirement</span><span class="s2">], </span><span class="s1">base_dir</span><span class="s2">: </span><span class="s1">Path</span>
    <span class="s2">) </span><span class="s1">-&gt; Self</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span>
            <span class="s1">packages</span><span class="s2">=</span><span class="s1">sorted</span><span class="s2">(</span>
                <span class="s2">(</span>
                    <span class="s1">Package</span><span class="s2">.</span><span class="s1">from_install_requirement</span><span class="s2">(</span><span class="s1">ireq</span><span class="s2">, </span><span class="s1">base_dir</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">ireq </span><span class="s0">in </span><span class="s1">install_requirements</span>
                <span class="s2">),</span>
                <span class="s1">key</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">p</span><span class="s2">: </span><span class="s1">p</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
</pre>
</body>
</html>