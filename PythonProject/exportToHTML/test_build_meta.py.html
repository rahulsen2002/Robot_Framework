<html>
<head>
<title>test_build_meta.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_build_meta.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">contextlib</span>
<span class="s0">import </span><span class="s1">importlib</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">signal</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">tarfile</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">concurrent </span><span class="s0">import </span><span class="s1">futures</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Callable</span>
<span class="s0">from </span><span class="s1">zipfile </span><span class="s0">import </span><span class="s1">ZipFile</span>

<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">jaraco </span><span class="s0">import </span><span class="s1">path</span>
<span class="s0">from </span><span class="s1">packaging</span><span class="s2">.</span><span class="s1">requirements </span><span class="s0">import </span><span class="s1">Requirement</span>

<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">warnings </span><span class="s0">import </span><span class="s1">SetuptoolsDeprecationWarning</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">textwrap </span><span class="s0">import </span><span class="s1">DALS</span>

<span class="s1">SETUP_SCRIPT_STUB </span><span class="s2">= </span><span class="s3">&quot;__import__('setuptools').setup()&quot;</span>


<span class="s1">TIMEOUT </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">getenv</span><span class="s2">(</span><span class="s3">&quot;TIMEOUT_BACKEND_TEST&quot;</span><span class="s2">, </span><span class="s3">&quot;180&quot;</span><span class="s2">))  </span><span class="s4"># in seconds</span>
<span class="s1">IS_PYPY </span><span class="s2">= </span><span class="s3">'__pypy__' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">builtin_module_names</span>


<span class="s1">pytestmark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">&quot;win32&quot; </span><span class="s0">and </span><span class="s1">IS_PYPY</span><span class="s2">,</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;The combination of PyPy + Windows + pytest-xdist + ProcessPoolExecutor &quot;</span>
    <span class="s3">&quot;is flaky and problematic&quot;</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s0">class </span><span class="s1">BuildBackendBase</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cwd</span><span class="s2">=</span><span class="s3">'.'</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">backend_name</span><span class="s2">=</span><span class="s3">'setuptools.build_meta'</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cwd </span><span class="s2">= </span><span class="s1">cwd</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">env </span><span class="s2">= </span><span class="s1">env </span><span class="s0">or </span><span class="s2">{}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">backend_name </span><span class="s2">= </span><span class="s1">backend_name</span>


<span class="s0">class </span><span class="s1">BuildBackend</span><span class="s2">(</span><span class="s1">BuildBackendBase</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;PEP 517 Build Backend&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pool </span><span class="s2">= </span><span class="s1">futures</span><span class="s2">.</span><span class="s1">ProcessPoolExecutor</span><span class="s2">(</span><span class="s1">max_workers</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; Callable</span><span class="s2">[..., </span><span class="s1">Any</span><span class="s2">]:</span>
        <span class="s5">&quot;&quot;&quot;Handles arbitrary function invocations on the build backend.&quot;&quot;&quot;</span>

        <span class="s0">def </span><span class="s1">method</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
            <span class="s1">root </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cwd</span><span class="s2">)</span>
            <span class="s1">caller </span><span class="s2">= </span><span class="s1">BuildBackendCaller</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backend_name</span><span class="s2">)</span>
            <span class="s1">pid </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">pid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pool</span><span class="s2">.</span><span class="s1">submit</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">getpid</span><span class="s2">).</span><span class="s1">result</span><span class="s2">(</span><span class="s1">TIMEOUT</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pool</span><span class="s2">.</span><span class="s1">submit</span><span class="s2">(</span><span class="s1">caller</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">).</span><span class="s1">result</span><span class="s2">(</span><span class="s1">TIMEOUT</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">futures</span><span class="s2">.</span><span class="s1">TimeoutError</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pool</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">wait</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)  </span><span class="s4"># doesn't stop already running processes</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_kill</span><span class="s2">(</span><span class="s1">pid</span><span class="s2">)</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s3">f&quot;Backend did not respond before timeout (</span><span class="s0">{</span><span class="s1">TIMEOUT</span><span class="s0">} </span><span class="s3">s)&quot;</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s2">(</span><span class="s1">futures</span><span class="s2">.</span><span class="s1">process</span><span class="s2">.</span><span class="s1">BrokenProcessPool</span><span class="s2">, </span><span class="s1">MemoryError</span><span class="s2">, </span><span class="s1">OSError</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">IS_PYPY</span><span class="s2">:</span>
                    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s3">&quot;PyPy frequently fails tests with ProcessPoolExector&quot;</span><span class="s2">)</span>
                <span class="s0">raise</span>

        <span class="s0">return </span><span class="s1">method</span>

    <span class="s0">def </span><span class="s1">_kill</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pid</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">pid </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s0">with </span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">suppress</span><span class="s2">(</span><span class="s1">ProcessLookupError</span><span class="s2">, </span><span class="s1">OSError</span><span class="s2">):</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">kill</span><span class="s2">(</span><span class="s1">pid</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">SIGTERM </span><span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;nt&quot; </span><span class="s0">else </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">SIGKILL</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BuildBackendCaller</span><span class="s2">(</span><span class="s1">BuildBackendBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">backend_name</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backend_obj</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backend_name</span><span class="s2">.</span><span class="s1">partition</span><span class="s2">(</span><span class="s3">':'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Handles arbitrary function invocations on the build backend.&quot;&quot;&quot;</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cwd</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">)</span>
        <span class="s1">mod </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">backend_name</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backend_obj</span><span class="s2">:</span>
            <span class="s1">backend </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">mod</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backend_obj</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">backend </span><span class="s2">= </span><span class="s1">mod</span>

        <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>


<span class="s1">defns </span><span class="s2">= [</span>
    <span class="s2">{  </span><span class="s4"># simple setup.py script</span>
        <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            __import__('setuptools').setup( 
                name='foo', 
                version='0.0.0', 
                py_modules=['hello'], 
                setup_requires=['six'], 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            def run(): 
                print('hello') 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">},</span>
    <span class="s2">{  </span><span class="s4"># setup.py that relies on __name__</span>
        <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            assert __name__ == '__main__' 
            __import__('setuptools').setup( 
                name='foo', 
                version='0.0.0', 
                py_modules=['hello'], 
                setup_requires=['six'], 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            def run(): 
                print('hello') 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">},</span>
    <span class="s2">{  </span><span class="s4"># setup.py script that runs arbitrary code</span>
        <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            variable = True 
            def function(): 
                return variable 
            assert variable 
            __import__('setuptools').setup( 
                name='foo', 
                version='0.0.0', 
                py_modules=['hello'], 
                setup_requires=['six'], 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            def run(): 
                print('hello') 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">},</span>
    <span class="s2">{  </span><span class="s4"># setup.py script that constructs temp files to be included in the distribution</span>
        <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            # Some packages construct files on the fly, include them in the package, 
            # and immediately remove them after `setup()` (e.g. pybind11==2.9.1). 
            # Therefore, we cannot use `distutils.core.run_setup(..., stop_after=...)` 
            # to obtain a distribution object first, and then run the distutils 
            # commands later, because these files will be removed in the meantime. 
 
            with open('world.py', 'w', encoding=&quot;utf-8&quot;) as f: 
                f.write('x = 42') 
 
            try: 
                __import__('setuptools').setup( 
                    name='foo', 
                    version='0.0.0', 
                    py_modules=['world'], 
                    setup_requires=['six'], 
                ) 
            finally: 
                # Some packages will clean temporary files 
                __import__('os').unlink('world.py') 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">},</span>
    <span class="s2">{  </span><span class="s4"># setup.cfg only</span>
        <span class="s3">'setup.cfg'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
        [metadata] 
        name = foo 
        version = 0.0.0 
 
        [options] 
        py_modules=hello 
        setup_requires=six 
        &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
        def run(): 
            print('hello') 
        &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">},</span>
    <span class="s2">{  </span><span class="s4"># setup.cfg and setup.py</span>
        <span class="s3">'setup.cfg'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
        [metadata] 
        name = foo 
        version = 0.0.0 
 
        [options] 
        py_modules=hello 
        setup_requires=six 
        &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s3">&quot;__import__('setuptools').setup()&quot;</span><span class="s2">,</span>
        <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
        def run(): 
            print('hello') 
        &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">},</span>
<span class="s2">]</span>


<span class="s0">class </span><span class="s1">TestBuildMetaBackend</span><span class="s2">:</span>
    <span class="s1">backend_name </span><span class="s2">= </span><span class="s3">'setuptools.build_meta'</span>

    <span class="s0">def </span><span class="s1">get_build_backend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">BuildBackend</span><span class="s2">(</span><span class="s1">backend_name</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">backend_name</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=</span><span class="s1">defns</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">build_backend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
            <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_get_requires_for_build_wheel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_backend</span><span class="s2">):</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">get_requires_for_build_wheel</span><span class="s2">()</span>
        <span class="s1">expected </span><span class="s2">= [</span><span class="s3">'six'</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">) == </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_get_requires_for_build_sdist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_backend</span><span class="s2">):</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">get_requires_for_build_sdist</span><span class="s2">()</span>
        <span class="s1">expected </span><span class="s2">= [</span><span class="s3">'six'</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">) == </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_build_wheel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_backend</span><span class="s2">):</span>
        <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">'pip-wheel'</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>
        <span class="s1">wheel_name </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_wheel</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>

        <span class="s1">wheel_file </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">, </span><span class="s1">wheel_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">wheel_file</span><span class="s2">)</span>

        <span class="s4"># Temporary files should be removed</span>
        <span class="s0">assert not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s3">'world.py'</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">wheel_file</span><span class="s2">) </span><span class="s0">as </span><span class="s1">zipfile</span><span class="s2">:</span>
            <span class="s1">wheel_contents </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">())</span>

        <span class="s4"># Each one of the examples have a single module</span>
        <span class="s4"># that should be included in the distribution</span>
        <span class="s1">python_scripts </span><span class="s2">= (</span><span class="s1">f </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">wheel_contents </span><span class="s0">if </span><span class="s1">f</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'.py'</span><span class="s2">))</span>
        <span class="s1">modules </span><span class="s2">= [</span><span class="s1">f </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">python_scripts </span><span class="s0">if not </span><span class="s1">f</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'setup.py'</span><span class="s2">)]</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">modules</span><span class="s2">) == </span><span class="s6">1</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'build_type'</span><span class="s2">, (</span><span class="s3">'wheel'</span><span class="s2">, </span><span class="s3">'sdist'</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_build_with_existing_file_present</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_type</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s4"># Building a sdist/wheel should still succeed if there's</span>
        <span class="s4"># already a sdist/wheel in the destination directory.</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s3">&quot;from setuptools import setup</span><span class="s0">\n</span><span class="s3">setup()&quot;</span><span class="s2">,</span>
            <span class="s3">'VERSION'</span><span class="s2">: </span><span class="s3">&quot;0.0.1&quot;</span><span class="s2">,</span>
            <span class="s3">'setup.cfg'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                [metadata] 
                name = foo 
                version = file: VERSION 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">'pyproject.toml'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                [build-system] 
                requires = [&quot;setuptools&quot;, &quot;wheel&quot;] 
                build-backend = &quot;setuptools.build_meta&quot; 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>

        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>

        <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">'preexisting-' </span><span class="s2">+ </span><span class="s1">build_type</span><span class="s2">)</span>

        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">build_method </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">build_backend</span><span class="s2">, </span><span class="s3">'build_' </span><span class="s2">+ </span><span class="s1">build_type</span><span class="s2">)</span>

        <span class="s4"># Build a first sdist/wheel.</span>
        <span class="s4"># Note: this also check the destination directory is</span>
        <span class="s4"># successfully created if it does not exist already.</span>
        <span class="s1">first_result </span><span class="s2">= </span><span class="s1">build_method</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>

        <span class="s4"># Change version.</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s3">&quot;VERSION&quot;</span><span class="s2">, </span><span class="s3">&quot;wt&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">version_file</span><span class="s2">:</span>
            <span class="s1">version_file</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">&quot;0.0.2&quot;</span><span class="s2">)</span>

        <span class="s4"># Build a *second* sdist/wheel.</span>
        <span class="s1">second_result </span><span class="s2">= </span><span class="s1">build_method</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">, </span><span class="s1">first_result</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">first_result </span><span class="s2">!= </span><span class="s1">second_result</span>

        <span class="s4"># And if rebuilding the exact same sdist/wheel?</span>
        <span class="s1">open</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">, </span><span class="s1">second_result</span><span class="s2">), </span><span class="s3">'wb'</span><span class="s2">).</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">third_result </span><span class="s2">= </span><span class="s1">build_method</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">third_result </span><span class="s2">== </span><span class="s1">second_result</span>
        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">getsize</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">, </span><span class="s1">third_result</span><span class="s2">)) &gt; </span><span class="s6">0</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;setup_script&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s1">SETUP_SCRIPT_STUB</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_build_with_pyproject_config</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">setup_script</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">'pyproject.toml'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                [build-system] 
                requires = [&quot;setuptools&quot;, &quot;wheel&quot;] 
                build-backend = &quot;setuptools.build_meta&quot; 
 
                [project] 
                name = &quot;foo&quot; 
                license = {text = &quot;MIT&quot;} 
                description = &quot;This is a Python package&quot; 
                dynamic = [&quot;version&quot;, &quot;readme&quot;] 
                classifiers = [ 
                    &quot;Development Status :: 5 - Production/Stable&quot;, 
                    &quot;Intended Audience :: Developers&quot; 
                ] 
                urls = {Homepage = &quot;http://github.com&quot;} 
                dependencies = [ 
                    &quot;appdirs&quot;, 
                ] 
 
                [project.optional-dependencies] 
                all = [ 
                    &quot;tomli&gt;=1&quot;, 
                    &quot;pyscaffold&gt;=4,&lt;5&quot;, 
                    'importlib; python_version == &quot;2.6&quot;', 
                ] 
 
                [project.scripts] 
                foo = &quot;foo.cli:main&quot; 
 
                [tool.setuptools] 
                zip-safe = false 
                package-dir = {&quot;&quot; = &quot;src&quot;} 
                packages = {find = {where = [&quot;src&quot;]}} 
                license-files = [&quot;LICENSE*&quot;] 
 
                [tool.setuptools.dynamic] 
                version = {attr = &quot;foo.__version__&quot;} 
                readme = {file = &quot;README.rst&quot;} 
 
                [tool.distutils.sdist] 
                formats = &quot;gztar&quot; 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;MANIFEST.in&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                global-include *.py *.txt 
                global-exclude *.py[cod] 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;README.rst&quot;</span><span class="s2">: </span><span class="s3">&quot;This is a ``README``&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;LICENSE.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;---- placeholder MIT license ----&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;src&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;foo&quot;</span><span class="s2">: {</span>
                    <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;__version__ = '0.1'&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;__init__.pyi&quot;</span><span class="s2">: </span><span class="s3">&quot;__version__: str&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;cli.py&quot;</span><span class="s2">: </span><span class="s3">&quot;def main(): print('hello world')&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;data.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;def main(): print('hello world')&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;py.typed&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                <span class="s2">}</span>
            <span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s0">if </span><span class="s1">setup_script</span><span class="s2">:</span>
            <span class="s1">files</span><span class="s2">[</span><span class="s3">&quot;setup.py&quot;</span><span class="s2">] = </span><span class="s1">setup_script</span>

        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
            <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>
            <span class="s1">msgs </span><span class="s2">= [</span>
                <span class="s3">&quot;'tool.setuptools.license-files' is deprecated in favor of 'project.license-files'&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;`project.license` as a TOML table is deprecated&quot;</span><span class="s2">,</span>
            <span class="s2">]</span>
            <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
                <span class="s0">for </span><span class="s1">msg </span><span class="s0">in </span><span class="s1">msgs</span><span class="s2">:</span>
                    <span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore&quot;</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">SetuptoolsDeprecationWarning</span><span class="s2">)</span>
                <span class="s1">sdist_path </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>
                <span class="s1">wheel_file </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_wheel</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s3">&quot;temp&quot;</span><span class="s2">, </span><span class="s1">sdist_path</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">tar</span><span class="s2">:</span>
            <span class="s1">sdist_contents </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">tar</span><span class="s2">.</span><span class="s1">getnames</span><span class="s2">())</span>

        <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s3">&quot;temp&quot;</span><span class="s2">, </span><span class="s1">wheel_file</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">zipfile</span><span class="s2">:</span>
            <span class="s1">wheel_contents </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">())</span>
            <span class="s1">metadata </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s3">&quot;foo-0.1.dist-info/METADATA&quot;</span><span class="s2">), </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
            <span class="s1">license </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span>
                <span class="s1">zipfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s3">&quot;foo-0.1.dist-info/licenses/LICENSE.txt&quot;</span><span class="s2">), </span><span class="s3">&quot;utf-8&quot;</span>
            <span class="s2">)</span>
            <span class="s1">epoints </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s3">&quot;foo-0.1.dist-info/entry_points.txt&quot;</span><span class="s2">), </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">sdist_contents </span><span class="s2">- {</span><span class="s3">&quot;foo-0.1/setup.py&quot;</span><span class="s2">} == {</span>
            <span class="s3">'foo-0.1'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/LICENSE.txt'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/MANIFEST.in'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/PKG-INFO'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/README.rst'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/pyproject.toml'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/setup.cfg'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo/__init__.py'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo/__init__.pyi'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo/cli.py'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo/data.txt'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo/py.typed'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo.egg-info'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo.egg-info/PKG-INFO'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo.egg-info/SOURCES.txt'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo.egg-info/dependency_links.txt'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo.egg-info/entry_points.txt'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo.egg-info/requires.txt'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo.egg-info/top_level.txt'</span><span class="s2">,</span>
            <span class="s3">'foo-0.1/src/foo.egg-info/not-zip-safe'</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">wheel_contents </span><span class="s2">== {</span>
            <span class="s3">&quot;foo/__init__.py&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;foo/__init__.pyi&quot;</span><span class="s2">,  </span><span class="s4"># include type information by default</span>
            <span class="s3">&quot;foo/cli.py&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;foo/data.txt&quot;</span><span class="s2">,  </span><span class="s4"># include_package_data defaults to True</span>
            <span class="s3">&quot;foo/py.typed&quot;</span><span class="s2">,  </span><span class="s4"># include type information by default</span>
            <span class="s3">&quot;foo-0.1.dist-info/licenses/LICENSE.txt&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;foo-0.1.dist-info/METADATA&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;foo-0.1.dist-info/WHEEL&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;foo-0.1.dist-info/entry_points.txt&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;foo-0.1.dist-info/top_level.txt&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;foo-0.1.dist-info/RECORD&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">license </span><span class="s2">== </span><span class="s3">&quot;---- placeholder MIT license ----&quot;</span>

        <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s2">(</span>
            <span class="s3">&quot;Summary: This is a Python package&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;License: MIT&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;License-File: LICENSE.txt&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Classifier: Intended Audience :: Developers&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Requires-Dist: appdirs&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Requires-Dist: &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">Requirement</span><span class="s2">(</span><span class="s3">'tomli&gt;=1 ; extra == &quot;all&quot;'</span><span class="s2">)),</span>
            <span class="s3">&quot;Requires-Dist: &quot;</span>
            <span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">Requirement</span><span class="s2">(</span><span class="s3">'importlib; python_version==&quot;2.6&quot; and extra ==&quot;all&quot;'</span><span class="s2">)),</span>
        <span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">line </span><span class="s0">in </span><span class="s1">metadata</span><span class="s2">, (</span><span class="s1">line</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">metadata</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">&quot;This is a ``README``&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">epoints</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">() == </span><span class="s3">&quot;[console_scripts]</span><span class="s0">\n</span><span class="s3">foo = foo.cli:main&quot;</span>

    <span class="s0">def </span><span class="s1">test_static_metadata_in_pyproject_config</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">):</span>
        <span class="s4"># Make sure static metadata in pyproject.toml is not overwritten by setup.py</span>
        <span class="s4"># as required by PEP 621</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">'pyproject.toml'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                [build-system] 
                requires = [&quot;setuptools&quot;, &quot;wheel&quot;] 
                build-backend = &quot;setuptools.build_meta&quot; 
 
                [project] 
                name = &quot;foo&quot; 
                description = &quot;This is a Python package&quot; 
                version = &quot;42&quot; 
                dependencies = [&quot;six&quot;] 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                def run(): 
                    print('hello') 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                __import__('setuptools').setup( 
                    name='bar', 
                    version='13', 
                ) 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
            <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>
            <span class="s1">sdist_path </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>
            <span class="s1">wheel_file </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_wheel</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s3">&quot;temp/foo-42.tar.gz&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s3">&quot;temp/foo-42-py3-none-any.whl&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s3">&quot;temp/bar-13.tar.gz&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s3">&quot;temp/bar-42.tar.gz&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s3">&quot;temp/foo-13.tar.gz&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s3">&quot;temp/bar-13-py3-none-any.whl&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s3">&quot;temp/bar-42-py3-none-any.whl&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s3">&quot;temp/foo-13-py3-none-any.whl&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>

        <span class="s0">with </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s3">&quot;temp&quot;</span><span class="s2">, </span><span class="s1">sdist_path</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">tar</span><span class="s2">:</span>
            <span class="s1">pkg_info </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tar</span><span class="s2">.</span><span class="s1">extractfile</span><span class="s2">(</span><span class="s3">'foo-42/PKG-INFO'</span><span class="s2">).</span><span class="s1">read</span><span class="s2">(), </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
            <span class="s1">members </span><span class="s2">= </span><span class="s1">tar</span><span class="s2">.</span><span class="s1">getnames</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s3">&quot;bar-13/PKG-INFO&quot; </span><span class="s0">not in </span><span class="s1">members</span>

        <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s3">&quot;temp&quot;</span><span class="s2">, </span><span class="s1">wheel_file</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">zipfile</span><span class="s2">:</span>
            <span class="s1">metadata </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s3">&quot;foo-42.dist-info/METADATA&quot;</span><span class="s2">), </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
            <span class="s1">members </span><span class="s2">= </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s3">&quot;bar-13.dist-info/METADATA&quot; </span><span class="s0">not in </span><span class="s1">members</span>

        <span class="s0">for </span><span class="s1">file </span><span class="s0">in </span><span class="s1">pkg_info</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;Name: foo&quot;</span><span class="s2">, </span><span class="s3">&quot;Version: 42&quot;</span><span class="s2">):</span>
                <span class="s0">assert </span><span class="s1">line </span><span class="s0">in </span><span class="s1">file</span>
            <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;Name: bar&quot;</span><span class="s2">, </span><span class="s3">&quot;Version: 13&quot;</span><span class="s2">):</span>
                <span class="s0">assert </span><span class="s1">line </span><span class="s0">not in </span><span class="s1">file</span>

    <span class="s0">def </span><span class="s1">test_build_sdist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_backend</span><span class="s2">):</span>
        <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">'pip-sdist'</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>
        <span class="s1">sdist_name </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">, </span><span class="s1">sdist_name</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_prepare_metadata_for_build_wheel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_backend</span><span class="s2">):</span>
        <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">'pip-dist-info'</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>

        <span class="s1">dist_info </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">prepare_metadata_for_build_wheel</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">, </span><span class="s1">dist_info</span><span class="s2">, </span><span class="s3">'METADATA'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_prepare_metadata_inplace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_backend</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Some users might pass metadata_directory pre-populated with `.tox` or `.venv`. 
        See issue #3523. 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">pre_existing </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s3">&quot;.tox/python/lib/python3.10/site-packages/attrs-22.1.0.dist-info&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;.tox/python/lib/python3.10/site-packages/autocommand-2.2.1.dist-info&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;.nox/python/lib/python3.10/site-packages/build-0.8.0.dist-info&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;.venv/python3.10/site-packages/click-8.1.3.dist-info&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;venv/python3.10/site-packages/distlib-0.3.5.dist-info&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;env/python3.10/site-packages/docutils-0.19.dist-info&quot;</span><span class="s2">,</span>
        <span class="s2">]:</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">pre_existing</span><span class="s2">, </span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">dist_info </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">prepare_metadata_for_build_wheel</span><span class="s2">(</span><span class="s3">&quot;.&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_info</span><span class="s2">, </span><span class="s3">'METADATA'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_build_sdist_explicit_dist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_backend</span><span class="s2">):</span>
        <span class="s4"># explicitly specifying the dist folder should work</span>
        <span class="s4"># the folder sdist_directory and the ``--dist-dir`` can be the same</span>
        <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">'dist'</span><span class="s2">)</span>
        <span class="s1">sdist_name </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">, </span><span class="s1">sdist_name</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_build_sdist_version_change</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_backend</span><span class="s2">):</span>
        <span class="s1">sdist_into_directory </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">&quot;out_sdist&quot;</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">sdist_into_directory</span><span class="s2">)</span>

        <span class="s1">sdist_name </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s1">sdist_into_directory</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">sdist_into_directory</span><span class="s2">, </span><span class="s1">sdist_name</span><span class="s2">))</span>

        <span class="s4"># if the setup.py changes subsequent call of the build meta</span>
        <span class="s4"># should still succeed, given the</span>
        <span class="s4"># sdist_directory the frontend specifies is empty</span>
        <span class="s1">setup_loc </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">&quot;setup.py&quot;</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">setup_loc</span><span class="s2">):</span>
            <span class="s1">setup_loc </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">&quot;setup.cfg&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">setup_loc</span><span class="s2">, </span><span class="s3">'rt'</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">file_handler</span><span class="s2">:</span>
            <span class="s1">content </span><span class="s2">= </span><span class="s1">file_handler</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">setup_loc</span><span class="s2">, </span><span class="s3">'wt'</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">file_handler</span><span class="s2">:</span>
            <span class="s1">file_handler</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">content</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">&quot;version='0.0.0'&quot;</span><span class="s2">, </span><span class="s3">&quot;version='0.0.1'&quot;</span><span class="s2">))</span>

        <span class="s1">shutil</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">sdist_into_directory</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">sdist_into_directory</span><span class="s2">)</span>

        <span class="s1">sdist_name </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;out_sdist&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">&quot;out_sdist&quot;</span><span class="s2">), </span><span class="s1">sdist_name</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_build_sdist_pyproject_toml_exists</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                __import__('setuptools').setup( 
                    name='foo', 
                    version='0.0.0', 
                    py_modules=['hello'] 
                )&quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s3">''</span><span class="s2">,</span>
            <span class="s3">'pyproject.toml'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                [build-system] 
                requires = [&quot;setuptools&quot;, &quot;wheel&quot;] 
                build-backend = &quot;setuptools.build_meta&quot; 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>
        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">targz_path </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">, </span><span class="s1">targz_path</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">tar</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">any</span><span class="s2">(</span><span class="s3">'pyproject.toml' </span><span class="s0">in </span><span class="s1">name </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">tar</span><span class="s2">.</span><span class="s1">getnames</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_build_sdist_setup_py_exists</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s4"># If build_sdist is called from a script other than setup.py,</span>
        <span class="s4"># ensure setup.py is included</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">defns</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>

        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">targz_path </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">, </span><span class="s1">targz_path</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">tar</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">any</span><span class="s2">(</span><span class="s3">'setup.py' </span><span class="s0">in </span><span class="s1">name </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">tar</span><span class="s2">.</span><span class="s1">getnames</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_build_sdist_setup_py_manifest_excluded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s4"># Ensure that MANIFEST.in can exclude setup.py</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
        __import__('setuptools').setup( 
            name='foo', 
            version='0.0.0', 
            py_modules=['hello'] 
        )&quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s3">''</span><span class="s2">,</span>
            <span class="s3">'MANIFEST.in'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
        exclude setup.py 
        &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>

        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>

        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">targz_path </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">, </span><span class="s1">targz_path</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">tar</span><span class="s2">:</span>
            <span class="s0">assert not </span><span class="s1">any</span><span class="s2">(</span><span class="s3">'setup.py' </span><span class="s0">in </span><span class="s1">name </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">tar</span><span class="s2">.</span><span class="s1">getnames</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_build_sdist_builds_targz_even_if_zip_indicated</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                __import__('setuptools').setup( 
                    name='foo', 
                    version='0.0.0', 
                    py_modules=['hello'] 
                )&quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s3">''</span><span class="s2">,</span>
            <span class="s3">'setup.cfg'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                [sdist] 
                formats=zip 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>

        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>

        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>

    <span class="s1">_relative_path_import_files </span><span class="s2">= {</span>
        <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            __import__('setuptools').setup( 
                name='foo', 
                version=__import__('hello').__version__, 
                py_modules=['hello'] 
            )&quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s3">'__version__ = &quot;0.0.0&quot;'</span><span class="s2">,</span>
        <span class="s3">'setup.cfg'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            [sdist] 
            formats=zip 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">test_build_sdist_relative_path_import</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_relative_path_import_files</span><span class="s2">)</span>
        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;^No module named 'hello'$&quot;</span><span class="s2">):</span>
            <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>

    <span class="s1">_simple_pyproject_example </span><span class="s2">= {</span>
        <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            [project] 
            name = &quot;proj&quot; 
            version = &quot;42&quot; 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">&quot;src&quot;</span><span class="s2">: {</span><span class="s3">&quot;proj&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">}},</span>
    <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">_assert_link_tree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parent_dir</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;All files in the directory should be either links or hard links&quot;&quot;&quot;</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">parent_dir</span><span class="s2">).</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;**/*&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">files  </span><span class="s4"># Should not be empty</span>
        <span class="s0">for </span><span class="s1">file </span><span class="s0">in </span><span class="s1">files</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">file</span><span class="s2">.</span><span class="s1">is_symlink</span><span class="s2">() </span><span class="s0">or </span><span class="s1">os</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">(</span><span class="s1">file</span><span class="s2">).</span><span class="s1">st_nlink </span><span class="s2">&gt; </span><span class="s6">0</span>

    <span class="s0">def </span><span class="s1">test_editable_without_config_settings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Sanity check to ensure tests with --mode=strict are different from the ones 
        without --mode. 
 
        --mode=strict should create a local directory with a package tree. 
        The directory should not get created otherwise. 
        &quot;&quot;&quot;</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_simple_pyproject_example</span><span class="s2">)</span>
        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s1">Path</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_editable</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">Path</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_build_wheel_inplace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">config_settings </span><span class="s2">= {</span><span class="s3">&quot;--build-option&quot;</span><span class="s2">: [</span><span class="s3">&quot;build_ext&quot;</span><span class="s2">, </span><span class="s3">&quot;--inplace&quot;</span><span class="s2">]}</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_simple_pyproject_example</span><span class="s2">)</span>
        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s1">Path</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s1">Path</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">).</span><span class="s1">mkdir</span><span class="s2">()</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">prepare_metadata_for_build_wheel</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">, </span><span class="s1">config_settings</span><span class="s2">)</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_wheel</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">, </span><span class="s1">config_settings</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">Path</span><span class="s2">(</span><span class="s3">&quot;build/proj-42-py3-none-any.whl&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;config_settings&quot;</span><span class="s2">, [{</span><span class="s3">&quot;editable-mode&quot;</span><span class="s2">: </span><span class="s3">&quot;strict&quot;</span><span class="s2">}])</span>
    <span class="s0">def </span><span class="s1">test_editable_with_config_settings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">, </span><span class="s1">config_settings</span><span class="s2">):</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">({**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_simple_pyproject_example</span><span class="s2">, </span><span class="s3">'_meta'</span><span class="s2">: {}})</span>
        <span class="s0">assert not </span><span class="s1">Path</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>
        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">prepare_metadata_for_build_editable</span><span class="s2">(</span><span class="s3">&quot;_meta&quot;</span><span class="s2">, </span><span class="s1">config_settings</span><span class="s2">)</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_editable</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">, </span><span class="s1">config_settings</span><span class="s2">, </span><span class="s3">&quot;_meta&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_link_tree</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">).</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;__editable__.*&quot;</span><span class="s2">)))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s3">&quot;setup_literal&quot;</span><span class="s2">, </span><span class="s3">&quot;requirements&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s3">&quot;'foo'&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">&quot;['foo']&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">r&quot;'foo\n'&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">r&quot;'foo\n\n'&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">&quot;['foo', 'bar']&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s3">'bar'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">r&quot;'# Has a comment line\nfoo'&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">r&quot;'foo # Has an inline comment'&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">r&quot;'foo \\\n &gt;=3.0'&quot;</span><span class="s2">, [</span><span class="s3">'foo&gt;=3.0'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">r&quot;'foo\nbar'&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s3">'bar'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">r&quot;'foo\nbar\n'&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s3">'bar'</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">r&quot;['foo\n', 'bar\n']&quot;</span><span class="s2">, [</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s3">'bar'</span><span class="s2">]),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'use_wheel'</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_setup_requires</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">setup_literal</span><span class="s2">, </span><span class="s1">requirements</span><span class="s2">, </span><span class="s1">use_wheel</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                from setuptools import setup 
 
                setup( 
                    name=&quot;qux&quot;, 
                    version=&quot;0.0.0&quot;, 
                    py_modules=[&quot;hello&quot;], 
                    setup_requires={setup_literal}, 
                ) 
            &quot;&quot;&quot;</span>
            <span class="s2">).</span><span class="s1">format</span><span class="s2">(</span><span class="s1">setup_literal</span><span class="s2">=</span><span class="s1">setup_literal</span><span class="s2">),</span>
            <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
            def run(): 
                print('hello') 
            &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>

        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>

        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">use_wheel</span><span class="s2">:</span>
            <span class="s1">get_requires </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">get_requires_for_build_wheel</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">get_requires </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">get_requires_for_build_sdist</span>

        <span class="s4"># Ensure that the build requirements are properly parsed</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">requirements</span><span class="s2">)</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">get_requires</span><span class="s2">()</span>

        <span class="s0">assert </span><span class="s1">expected </span><span class="s2">== </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_setup_requires_with_auto_discovery</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s4"># Make sure patches introduced to retrieve setup_requires don't accidentally</span>
        <span class="s4"># activate auto-discovery and cause problems due to the incomplete set of</span>
        <span class="s4"># attributes passed to MinimalDistribution</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">'pyproject.toml'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                [project] 
                name = &quot;proj&quot; 
                version = &quot;42&quot; 
            &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                __import__('setuptools').setup( 
                    setup_requires=[&quot;foo&quot;], 
                    py_modules = [&quot;hello&quot;, &quot;world&quot;] 
                ) 
            &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s3">&quot;'hello'&quot;</span><span class="s2">,</span>
            <span class="s3">'world.py'</span><span class="s2">: </span><span class="s3">&quot;'world'&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>
        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">setup_requires </span><span class="s2">= </span><span class="s1">build_backend</span><span class="s2">.</span><span class="s1">get_requires_for_build_wheel</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">setup_requires </span><span class="s2">== [</span><span class="s3">&quot;foo&quot;</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_dont_install_setup_requires</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span>
            <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                        from setuptools import setup 
 
                        setup( 
                            name=&quot;qux&quot;, 
                            version=&quot;0.0.0&quot;, 
                            py_modules=[&quot;hello&quot;], 
                            setup_requires=[&quot;does-not-exist &gt;99&quot;], 
                        ) 
                    &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">'hello.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                    def run(): 
                        print('hello') 
                    &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>

        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>

        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>

        <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s3">'pip-dist-info'</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>

        <span class="s4"># does-not-exist can't be satisfied, so if it attempts to install</span>
        <span class="s4"># setup_requires, it will fail.</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">prepare_metadata_for_build_wheel</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)</span>

    <span class="s1">_sys_argv_0_passthrough </span><span class="s2">= {</span>
        <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            import os 
            import sys 
 
            __import__('setuptools').setup( 
                name='foo', 
                version='0.0.0', 
            ) 
 
            sys_argv = os.path.abspath(sys.argv[0]) 
            file_path = os.path.abspath('setup.py') 
            assert sys_argv == file_path 
            &quot;&quot;&quot;</span>
        <span class="s2">)</span>
    <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">test_sys_argv_passthrough</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sys_argv_0_passthrough</span><span class="s2">)</span>
        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
            <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>

    <span class="s1">_setup_py_file_abspath </span><span class="s2">= {</span>
        <span class="s3">'setup.py'</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            import os 
            assert os.path.isabs(__file__) 
            __import__('setuptools').setup( 
                name='foo', 
                version='0.0.0', 
                py_modules=['hello'], 
                setup_requires=['six'], 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">)</span>
    <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">test_setup_py_file_abspath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_py_file_abspath</span><span class="s2">)</span>
        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'build_hook'</span><span class="s2">, (</span><span class="s3">'build_sdist'</span><span class="s2">, </span><span class="s3">'build_wheel'</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_build_with_empty_setuppy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">build_backend</span><span class="s2">, </span><span class="s1">build_hook</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= {</span><span class="s3">'setup.py'</span><span class="s2">: </span><span class="s3">''</span><span class="s2">}</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s3">'No distribution was found.'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">getattr</span><span class="s2">(</span><span class="s1">build_backend</span><span class="s2">, </span><span class="s1">build_hook</span><span class="s2">)(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestBuildMetaLegacyBackend</span><span class="s2">(</span><span class="s1">TestBuildMetaBackend</span><span class="s2">):</span>
    <span class="s1">backend_name </span><span class="s2">= </span><span class="s3">'setuptools.build_meta:__legacy__'</span>

    <span class="s4"># build_meta_legacy-specific tests</span>
    <span class="s0">def </span><span class="s1">test_build_sdist_relative_path_import</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s4"># This must fail in build_meta, but must pass in build_meta_legacy</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_relative_path_import_files</span><span class="s2">)</span>

        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sys_argv_passthrough</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sys_argv_0_passthrough</span><span class="s2">)</span>

        <span class="s1">build_backend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_build_backend</span><span class="s2">()</span>
        <span class="s1">build_backend</span><span class="s2">.</span><span class="s1">build_sdist</span><span class="s2">(</span><span class="s3">&quot;temp&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore::setuptools.SetuptoolsDeprecationWarning&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sys_exit_0_in_setuppy</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Setuptools should be resilient to setup.py with ``sys.exit(0)`` (#3973).&quot;&quot;&quot;</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">setuppy </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
        import sys, setuptools 
        setuptools.setup(name='foo', version='0.0.0') 
        sys.exit(0) 
        &quot;&quot;&quot;</span>
    <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;setup.py&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">setuppy</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s1">backend </span><span class="s2">= </span><span class="s1">BuildBackend</span><span class="s2">(</span><span class="s1">backend_name</span><span class="s2">=</span><span class="s3">&quot;setuptools.build_meta&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">get_requires_for_build_wheel</span><span class="s2">() == []</span>


<span class="s0">def </span><span class="s1">test_system_exit_in_setuppy</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">setuppy </span><span class="s2">= </span><span class="s3">&quot;import sys; sys.exit('some error')&quot;</span>
    <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;setup.py&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">setuppy</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">SystemExit</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;some error&quot;</span><span class="s2">):</span>
        <span class="s1">backend </span><span class="s2">= </span><span class="s1">BuildBackend</span><span class="s2">(</span><span class="s1">backend_name</span><span class="s2">=</span><span class="s3">&quot;setuptools.build_meta&quot;</span><span class="s2">)</span>
        <span class="s1">backend</span><span class="s2">.</span><span class="s1">get_requires_for_build_wheel</span><span class="s2">()</span>
</pre>
</body>
</html>