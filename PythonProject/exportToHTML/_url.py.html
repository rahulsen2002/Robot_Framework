<html>
<head>
<title>_url.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_url.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">socket</span>
<span class="s0">import </span><span class="s1">struct</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Optional</span>
<span class="s0">from </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">parse </span><span class="s0">import </span><span class="s1">unquote</span><span class="s2">, </span><span class="s1">urlparse</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_exceptions </span><span class="s0">import </span><span class="s1">WebSocketProxyException</span>

<span class="s3">&quot;&quot;&quot; 
_url.py 
websocket - WebSocket client library for Python 
 
Copyright 2024 engn33r 
 
Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); 
you may not use this file except in compliance with the License. 
You may obtain a copy of the License at 
 
    http://www.apache.org/licenses/LICENSE-2.0 
 
Unless required by applicable law or agreed to in writing, software 
distributed under the License is distributed on an &quot;AS IS&quot; BASIS, 
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
See the License for the specific language governing permissions and 
limitations under the License. 
&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">&quot;parse_url&quot;</span><span class="s2">, </span><span class="s3">&quot;get_proxy_info&quot;</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">parse_url</span><span class="s2">(</span><span class="s1">url</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot; 
    parse url and the result is tuple of 
    (hostname, port, resource path and the flag of secure mode) 
 
    Parameters 
    ---------- 
    url: str 
        url string. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s3">&quot;:&quot; </span><span class="s0">not in </span><span class="s1">url</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;url is invalid&quot;</span><span class="s2">)</span>

    <span class="s1">scheme</span><span class="s2">, </span><span class="s1">url </span><span class="s2">= </span><span class="s1">url</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">parsed </span><span class="s2">= </span><span class="s1">urlparse</span><span class="s2">(</span><span class="s1">url</span><span class="s2">, </span><span class="s1">scheme</span><span class="s2">=</span><span class="s3">&quot;http&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">hostname</span><span class="s2">:</span>
        <span class="s1">hostname </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">hostname</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;hostname is invalid&quot;</span><span class="s2">)</span>
    <span class="s1">port </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">if </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">port</span><span class="s2">:</span>
        <span class="s1">port </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">port</span>

    <span class="s1">is_secure </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s0">if </span><span class="s1">scheme </span><span class="s2">== </span><span class="s3">&quot;ws&quot;</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">port</span><span class="s2">:</span>
            <span class="s1">port </span><span class="s2">= </span><span class="s5">80</span>
    <span class="s0">elif </span><span class="s1">scheme </span><span class="s2">== </span><span class="s3">&quot;wss&quot;</span><span class="s2">:</span>
        <span class="s1">is_secure </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if not </span><span class="s1">port</span><span class="s2">:</span>
            <span class="s1">port </span><span class="s2">= </span><span class="s5">443</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;scheme %s is invalid&quot; </span><span class="s2">% </span><span class="s1">scheme</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">resource </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">path</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">resource </span><span class="s2">= </span><span class="s3">&quot;/&quot;</span>

    <span class="s0">if </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">query</span><span class="s2">:</span>
        <span class="s1">resource </span><span class="s2">+= </span><span class="s3">f&quot;?</span><span class="s0">{</span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">query</span><span class="s0">}</span><span class="s3">&quot;</span>

    <span class="s0">return </span><span class="s1">hostname</span><span class="s2">, </span><span class="s1">port</span><span class="s2">, </span><span class="s1">resource</span><span class="s2">, </span><span class="s1">is_secure</span>


<span class="s1">DEFAULT_NO_PROXY_HOST </span><span class="s2">= [</span><span class="s3">&quot;localhost&quot;</span><span class="s2">, </span><span class="s3">&quot;127.0.0.1&quot;</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">_is_ip_address</span><span class="s2">(</span><span class="s1">addr</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">socket</span><span class="s2">.</span><span class="s1">inet_aton</span><span class="s2">(</span><span class="s1">addr</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">error</span><span class="s2">:</span>
        <span class="s0">return False</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return True</span>


<span class="s0">def </span><span class="s1">_is_subnet_address</span><span class="s2">(</span><span class="s1">hostname</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">addr</span><span class="s2">, </span><span class="s1">netmask </span><span class="s2">= </span><span class="s1">hostname</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;/&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">_is_ip_address</span><span class="s2">(</span><span class="s1">addr</span><span class="s2">) </span><span class="s0">and </span><span class="s5">0 </span><span class="s2">&lt;= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">netmask</span><span class="s2">) &lt; </span><span class="s5">32</span>
    <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
        <span class="s0">return False</span>


<span class="s0">def </span><span class="s1">_is_address_in_network</span><span class="s2">(</span><span class="s1">ip</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">net</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s1">ipaddr</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;!I&quot;</span><span class="s2">, </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">inet_aton</span><span class="s2">(</span><span class="s1">ip</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">netaddr</span><span class="s2">, </span><span class="s1">netmask </span><span class="s2">= </span><span class="s1">net</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;/&quot;</span><span class="s2">)</span>
    <span class="s1">netaddr</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;!I&quot;</span><span class="s2">, </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">inet_aton</span><span class="s2">(</span><span class="s1">netaddr</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s1">netmask </span><span class="s2">= (</span><span class="s5">0xFFFFFFFF </span><span class="s2">&lt;&lt; (</span><span class="s5">32 </span><span class="s2">- </span><span class="s1">int</span><span class="s2">(</span><span class="s1">netmask</span><span class="s2">))) &amp; </span><span class="s5">0xFFFFFFFF</span>
    <span class="s0">return </span><span class="s1">ipaddr </span><span class="s2">&amp; </span><span class="s1">netmask </span><span class="s2">== </span><span class="s1">netaddr</span>


<span class="s0">def </span><span class="s1">_is_no_proxy_host</span><span class="s2">(</span><span class="s1">hostname</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">no_proxy</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">list</span><span class="s2">]) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s0">if not </span><span class="s1">no_proxy</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">v </span><span class="s2">:= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;no_proxy&quot;</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;NO_PROXY&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)).</span><span class="s1">replace</span><span class="s2">(</span>
            <span class="s3">&quot; &quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span>
        <span class="s2">):</span>
            <span class="s1">no_proxy </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">no_proxy</span><span class="s2">:</span>
        <span class="s1">no_proxy </span><span class="s2">= </span><span class="s1">DEFAULT_NO_PROXY_HOST</span>

    <span class="s0">if </span><span class="s3">&quot;*&quot; </span><span class="s0">in </span><span class="s1">no_proxy</span><span class="s2">:</span>
        <span class="s0">return True</span>
    <span class="s0">if </span><span class="s1">hostname </span><span class="s0">in </span><span class="s1">no_proxy</span><span class="s2">:</span>
        <span class="s0">return True</span>
    <span class="s0">if </span><span class="s1">_is_ip_address</span><span class="s2">(</span><span class="s1">hostname</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">any</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">_is_address_in_network</span><span class="s2">(</span><span class="s1">hostname</span><span class="s2">, </span><span class="s1">subnet</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">subnet </span><span class="s0">in </span><span class="s1">no_proxy</span>
                <span class="s0">if </span><span class="s1">_is_subnet_address</span><span class="s2">(</span><span class="s1">subnet</span><span class="s2">)</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">for </span><span class="s1">domain </span><span class="s0">in </span><span class="s2">[</span><span class="s1">domain </span><span class="s0">for </span><span class="s1">domain </span><span class="s0">in </span><span class="s1">no_proxy </span><span class="s0">if </span><span class="s1">domain</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;.&quot;</span><span class="s2">)]:</span>
        <span class="s0">if </span><span class="s1">hostname</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">domain</span><span class="s2">):</span>
            <span class="s0">return True</span>
    <span class="s0">return False</span>


<span class="s0">def </span><span class="s1">get_proxy_info</span><span class="s2">(</span>
    <span class="s1">hostname</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">is_secure</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">,</span>
    <span class="s1">proxy_host</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">proxy_port</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s5">0</span><span class="s2">,</span>
    <span class="s1">proxy_auth</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">no_proxy</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">list</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">proxy_type</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;http&quot;</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot; 
    Try to retrieve proxy host and port from environment 
    if not provided in options. 
    Result is (proxy_host, proxy_port, proxy_auth). 
    proxy_auth is tuple of username and password 
    of proxy authentication information. 
 
    Parameters 
    ---------- 
    hostname: str 
        Websocket server name. 
    is_secure: bool 
        Is the connection secure? (wss) looks for &quot;https_proxy&quot; in env 
        instead of &quot;http_proxy&quot; 
    proxy_host: str 
        http proxy host name. 
    proxy_port: str or int 
        http proxy port. 
    no_proxy: list 
        Whitelisted host names that don't use the proxy. 
    proxy_auth: tuple 
        HTTP proxy auth information. Tuple of username and password. Default is None. 
    proxy_type: str 
        Specify the proxy protocol (http, socks4, socks4a, socks5, socks5h). Default is &quot;http&quot;. 
        Use socks4a or socks5h if you want to send DNS requests through the proxy. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">_is_no_proxy_host</span><span class="s2">(</span><span class="s1">hostname</span><span class="s2">, </span><span class="s1">no_proxy</span><span class="s2">):</span>
        <span class="s0">return None</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s0">None</span>

    <span class="s0">if </span><span class="s1">proxy_host</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">proxy_port</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">WebSocketProxyException</span><span class="s2">(</span><span class="s3">&quot;Cannot use port 0 when proxy_host specified&quot;</span><span class="s2">)</span>
        <span class="s1">port </span><span class="s2">= </span><span class="s1">proxy_port</span>
        <span class="s1">auth </span><span class="s2">= </span><span class="s1">proxy_auth</span>
        <span class="s0">return </span><span class="s1">proxy_host</span><span class="s2">, </span><span class="s1">port</span><span class="s2">, </span><span class="s1">auth</span>

    <span class="s1">env_key </span><span class="s2">= </span><span class="s3">&quot;https_proxy&quot; </span><span class="s0">if </span><span class="s1">is_secure </span><span class="s0">else </span><span class="s3">&quot;http_proxy&quot;</span>
    <span class="s1">value </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">env_key</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">env_key</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">(), </span><span class="s3">&quot;&quot;</span><span class="s2">)).</span><span class="s1">replace</span><span class="s2">(</span>
        <span class="s3">&quot; &quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">value</span><span class="s2">:</span>
        <span class="s1">proxy </span><span class="s2">= </span><span class="s1">urlparse</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">auth </span><span class="s2">= (</span>
            <span class="s2">(</span><span class="s1">unquote</span><span class="s2">(</span><span class="s1">proxy</span><span class="s2">.</span><span class="s1">username</span><span class="s2">), </span><span class="s1">unquote</span><span class="s2">(</span><span class="s1">proxy</span><span class="s2">.</span><span class="s1">password</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">proxy</span><span class="s2">.</span><span class="s1">username</span>
            <span class="s0">else None</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">proxy</span><span class="s2">.</span><span class="s1">hostname</span><span class="s2">, </span><span class="s1">proxy</span><span class="s2">.</span><span class="s1">port</span><span class="s2">, </span><span class="s1">auth</span>

    <span class="s0">return None</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s0">None</span>
</pre>
</body>
</html>