<html>
<head>
<title>_writer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_writer.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">from </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc </span><span class="s0">import </span><span class="s1">Mapping</span>
<span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">date</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">, </span><span class="s1">time</span>
<span class="s0">from </span><span class="s1">types </span><span class="s0">import </span><span class="s1">MappingProxyType</span>

<span class="s1">TYPE_CHECKING </span><span class="s2">= </span><span class="s0">False</span>
<span class="s0">if </span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc </span><span class="s0">import </span><span class="s1">Generator</span>
    <span class="s0">from </span><span class="s1">decimal </span><span class="s0">import </span><span class="s1">Decimal</span>
    <span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">IO</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Final</span>

<span class="s1">ASCII_CTRL </span><span class="s2">= </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s1">chr</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">32</span><span class="s2">)) | </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s1">chr</span><span class="s2">(</span><span class="s3">127</span><span class="s2">))</span>
<span class="s1">ILLEGAL_BASIC_STR_CHARS </span><span class="s2">= </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s4">'&quot;</span><span class="s0">\\</span><span class="s4">'</span><span class="s2">) | </span><span class="s1">ASCII_CTRL </span><span class="s2">- </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s0">\t</span><span class="s4">&quot;</span><span class="s2">)</span>
<span class="s1">BARE_KEY_CHARS </span><span class="s2">= </span><span class="s1">frozenset</span><span class="s2">(</span>
    <span class="s4">&quot;abcdefghijklmnopqrstuvwxyz&quot; &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot; &quot;0123456789&quot; &quot;-_&quot;</span>
<span class="s2">)</span>
<span class="s1">ARRAY_TYPES </span><span class="s2">= (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
<span class="s1">MAX_LINE_LENGTH </span><span class="s2">= </span><span class="s3">100</span>

<span class="s1">COMPACT_ESCAPES </span><span class="s2">= </span><span class="s1">MappingProxyType</span><span class="s2">(</span>
    <span class="s2">{</span>
        <span class="s4">&quot;</span><span class="s0">\u0008</span><span class="s4">&quot;</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">b&quot;</span><span class="s2">,  </span><span class="s5"># backspace</span>
        <span class="s4">&quot;</span><span class="s0">\u000A</span><span class="s4">&quot;</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">n&quot;</span><span class="s2">,  </span><span class="s5"># linefeed</span>
        <span class="s4">&quot;</span><span class="s0">\u000C</span><span class="s4">&quot;</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">f&quot;</span><span class="s2">,  </span><span class="s5"># form feed</span>
        <span class="s4">&quot;</span><span class="s0">\u000D</span><span class="s4">&quot;</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">r&quot;</span><span class="s2">,  </span><span class="s5"># carriage return</span>
        <span class="s4">&quot;</span><span class="s0">\u0022</span><span class="s4">&quot;</span><span class="s2">: </span><span class="s4">'</span><span class="s0">\\</span><span class="s4">&quot;'</span><span class="s2">,  </span><span class="s5"># quote</span>
        <span class="s4">&quot;</span><span class="s0">\u005C</span><span class="s4">&quot;</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\\\\</span><span class="s4">&quot;</span><span class="s2">,  </span><span class="s5"># backslash</span>
    <span class="s2">}</span>
<span class="s2">)</span>


<span class="s0">class </span><span class="s1">Context</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">allow_multiline</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">, </span><span class="s1">indent</span><span class="s2">: </span><span class="s1">int</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">indent </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">&quot;Indent width must be non-negative&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">allow_multiline</span><span class="s2">: </span><span class="s1">Final </span><span class="s2">= </span><span class="s1">allow_multiline</span>
        <span class="s5"># cache rendered inline tables (mapping from object id to rendered inline table)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inline_table_cache</span><span class="s2">: </span><span class="s1">Final</span><span class="s2">[</span><span class="s1">dict</span><span class="s2">[</span><span class="s1">int</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]] = {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">indent_str</span><span class="s2">: </span><span class="s1">Final </span><span class="s2">= </span><span class="s4">&quot; &quot; </span><span class="s2">* </span><span class="s1">indent</span>


<span class="s0">def </span><span class="s1">dump</span><span class="s2">(</span>
    <span class="s1">obj</span><span class="s2">: </span><span class="s1">Mapping</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">],</span>
    <span class="s1">fp</span><span class="s2">: </span><span class="s1">IO</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">],</span>
    <span class="s2">/,</span>
    <span class="s2">*,</span>
    <span class="s1">multiline_strings</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">indent</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s3">4</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">ctx </span><span class="s2">= </span><span class="s1">Context</span><span class="s2">(</span><span class="s1">multiline_strings</span><span class="s2">, </span><span class="s1">indent</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">gen_table_chunks</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;&quot;</span><span class="s2">):</span>
        <span class="s1">fp</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">dumps</span><span class="s2">(</span>
    <span class="s1">obj</span><span class="s2">: </span><span class="s1">Mapping</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">], /, *, </span><span class="s1">multiline_strings</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">, </span><span class="s1">indent</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s3">4</span>
<span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s1">ctx </span><span class="s2">= </span><span class="s1">Context</span><span class="s2">(</span><span class="s1">multiline_strings</span><span class="s2">, </span><span class="s1">indent</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s4">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">gen_table_chunks</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">gen_table_chunks</span><span class="s2">(</span>
    <span class="s1">table</span><span class="s2">: </span><span class="s1">Mapping</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">],</span>
    <span class="s1">ctx</span><span class="s2">: </span><span class="s1">Context</span><span class="s2">,</span>
    <span class="s2">*,</span>
    <span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">inside_aot</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; Generator</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
    <span class="s1">yielded </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">literals </span><span class="s2">= []</span>
    <span class="s1">tables</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">]] = []  </span><span class="s5"># =&gt; [(key, value, inside_aot)]</span>
    <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">table</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">Mapping</span><span class="s2">):</span>
            <span class="s1">tables</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">k</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">is_aot</span><span class="s2">(</span><span class="s1">v</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">all</span><span class="s2">(</span><span class="s1">is_suitable_inline_table</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">v</span><span class="s2">):</span>
            <span class="s1">tables</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span><span class="s1">k</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">literals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">k</span><span class="s2">, </span><span class="s1">v</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">inside_aot </span><span class="s0">or </span><span class="s1">name </span><span class="s0">and </span><span class="s2">(</span><span class="s1">literals </span><span class="s0">or not </span><span class="s1">tables</span><span class="s2">):</span>
        <span class="s1">yielded </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">yield </span><span class="s4">f&quot;[[</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s4">]]</span><span class="s0">\n</span><span class="s4">&quot; </span><span class="s0">if </span><span class="s1">inside_aot </span><span class="s0">else </span><span class="s4">f&quot;[</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s4">]</span><span class="s0">\n</span><span class="s4">&quot;</span>

    <span class="s0">if </span><span class="s1">literals</span><span class="s2">:</span>
        <span class="s1">yielded </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">literals</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">format_key_part</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span><span class="s0">} </span><span class="s4">= </span><span class="s0">{</span><span class="s1">format_literal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">)</span><span class="s0">}\n</span><span class="s4">&quot;</span>

    <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">in_aot </span><span class="s0">in </span><span class="s1">tables</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">yielded</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">yielded </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">key_part </span><span class="s2">= </span><span class="s1">format_key_part</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">display_name </span><span class="s2">= </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s4">.</span><span class="s0">{</span><span class="s1">key_part</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">if </span><span class="s1">name </span><span class="s0">else </span><span class="s1">key_part</span>
        <span class="s0">yield from </span><span class="s1">gen_table_chunks</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">display_name</span><span class="s2">, </span><span class="s1">inside_aot</span><span class="s2">=</span><span class="s1">in_aot</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">format_literal</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">object</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">: </span><span class="s1">Context</span><span class="s2">, *, </span><span class="s1">nest_level</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s3">0</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s4">&quot;true&quot; </span><span class="s0">if </span><span class="s1">obj </span><span class="s0">else </span><span class="s4">&quot;false&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, (</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">date</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">)):</span>
        <span class="s0">return </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">time</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">tzinfo</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">&quot;TOML does not support offset times&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">format_string</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">allow_multiline</span><span class="s2">=</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">allow_multiline</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ARRAY_TYPES</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">format_inline_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">nest_level</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">Mapping</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">format_inline_table</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">)</span>

    <span class="s5"># Lazy import to improve module import time</span>
    <span class="s0">from </span><span class="s1">decimal </span><span class="s0">import </span><span class="s1">Decimal</span>

    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">Decimal</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">format_decimal</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
    <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span>
        <span class="s4">f&quot;Object of type '</span><span class="s0">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">).</span><span class="s1">__qualname__</span><span class="s0">}</span><span class="s4">' is not TOML serializable&quot;</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">format_decimal</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Decimal</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s0">if </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">is_nan</span><span class="s2">():</span>
        <span class="s0">return </span><span class="s4">&quot;nan&quot;</span>
    <span class="s0">if </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">is_infinite</span><span class="s2">():</span>
        <span class="s0">return </span><span class="s4">&quot;-inf&quot; </span><span class="s0">if </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">is_signed</span><span class="s2">() </span><span class="s0">else </span><span class="s4">&quot;inf&quot;</span>
    <span class="s1">dec_str </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">).</span><span class="s1">lower</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">dec_str </span><span class="s0">if </span><span class="s4">&quot;.&quot; </span><span class="s0">in </span><span class="s1">dec_str </span><span class="s0">or </span><span class="s4">&quot;e&quot; </span><span class="s0">in </span><span class="s1">dec_str </span><span class="s0">else </span><span class="s1">dec_str </span><span class="s2">+ </span><span class="s4">&quot;.0&quot;</span>


<span class="s0">def </span><span class="s1">format_inline_table</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Mapping</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">: </span><span class="s1">Context</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s5"># check cache first</span>
    <span class="s1">obj_id </span><span class="s2">= </span><span class="s1">id</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">obj_id </span><span class="s0">in </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">inline_table_cache</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">inline_table_cache</span><span class="s2">[</span><span class="s1">obj_id</span><span class="s2">]</span>

    <span class="s0">if not </span><span class="s1">obj</span><span class="s2">:</span>
        <span class="s1">rendered </span><span class="s2">= </span><span class="s4">&quot;{}&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">rendered </span><span class="s2">= (</span>
            <span class="s4">&quot;{ &quot;</span>
            <span class="s2">+ </span><span class="s4">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
                <span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">format_key_part</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span><span class="s0">} </span><span class="s4">= </span><span class="s0">{</span><span class="s1">format_literal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span>
                <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span>
            <span class="s2">)</span>
            <span class="s2">+ </span><span class="s4">&quot; }&quot;</span>
        <span class="s2">)</span>
    <span class="s1">ctx</span><span class="s2">.</span><span class="s1">inline_table_cache</span><span class="s2">[</span><span class="s1">obj_id</span><span class="s2">] = </span><span class="s1">rendered</span>
    <span class="s0">return </span><span class="s1">rendered</span>


<span class="s0">def </span><span class="s1">format_inline_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">tuple </span><span class="s2">| </span><span class="s1">list</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">: </span><span class="s1">Context</span><span class="s2">, </span><span class="s1">nest_level</span><span class="s2">: </span><span class="s1">int</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s0">if not </span><span class="s1">obj</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s4">&quot;[]&quot;</span>
    <span class="s1">item_indent </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">indent_str </span><span class="s2">* (</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">nest_level</span><span class="s2">)</span>
    <span class="s1">closing_bracket_indent </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">indent_str </span><span class="s2">* </span><span class="s1">nest_level</span>
    <span class="s0">return </span><span class="s2">(</span>
        <span class="s4">&quot;[</span><span class="s0">\n</span><span class="s4">&quot;</span>
        <span class="s2">+ </span><span class="s4">&quot;,</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
            <span class="s1">item_indent </span><span class="s2">+ </span><span class="s1">format_literal</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">nest_level</span><span class="s2">=</span><span class="s1">nest_level </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">obj</span>
        <span class="s2">)</span>
        <span class="s2">+ </span><span class="s4">f&quot;,</span><span class="s0">\n{</span><span class="s1">closing_bracket_indent</span><span class="s0">}</span><span class="s4">]&quot;</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">format_key_part</span><span class="s2">(</span><span class="s1">part</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">only_bare_key_chars </span><span class="s2">= </span><span class="s1">BARE_KEY_CHARS</span><span class="s2">.</span><span class="s1">issuperset</span><span class="s2">(</span><span class="s1">part</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span>
            <span class="s4">f&quot;Invalid mapping key '</span><span class="s0">{</span><span class="s1">part</span><span class="s0">}</span><span class="s4">' of type '</span><span class="s0">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">part</span><span class="s2">).</span><span class="s1">__qualname__</span><span class="s0">}</span><span class="s4">'.&quot;</span>
            <span class="s4">&quot; A string is required.&quot;</span>
        <span class="s2">) </span><span class="s0">from None</span>

    <span class="s0">if </span><span class="s1">part </span><span class="s0">and </span><span class="s1">only_bare_key_chars</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">part</span>
    <span class="s0">return </span><span class="s1">format_string</span><span class="s2">(</span><span class="s1">part</span><span class="s2">, </span><span class="s1">allow_multiline</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">format_string</span><span class="s2">(</span><span class="s1">s</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, *, </span><span class="s1">allow_multiline</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s1">do_multiline </span><span class="s2">= </span><span class="s1">allow_multiline </span><span class="s0">and </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot; </span><span class="s0">in </span><span class="s1">s</span>
    <span class="s0">if </span><span class="s1">do_multiline</span><span class="s2">:</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s4">'&quot;&quot;&quot;</span><span class="s0">\n</span><span class="s4">'</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">s</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s0">\r\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s4">'&quot;'</span>

    <span class="s1">pos </span><span class="s2">= </span><span class="s1">seq_start </span><span class="s2">= </span><span class="s3">0</span>
    <span class="s0">while True</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">char </span><span class="s2">= </span><span class="s1">s</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
            <span class="s1">result </span><span class="s2">+= </span><span class="s1">s</span><span class="s2">[</span><span class="s1">seq_start</span><span class="s2">:</span><span class="s1">pos</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">do_multiline</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">result </span><span class="s2">+ </span><span class="s4">'&quot;&quot;&quot;'</span>
            <span class="s0">return </span><span class="s1">result </span><span class="s2">+ </span><span class="s4">'&quot;'</span>
        <span class="s0">if </span><span class="s1">char </span><span class="s0">in </span><span class="s1">ILLEGAL_BASIC_STR_CHARS</span><span class="s2">:</span>
            <span class="s1">result </span><span class="s2">+= </span><span class="s1">s</span><span class="s2">[</span><span class="s1">seq_start</span><span class="s2">:</span><span class="s1">pos</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">char </span><span class="s0">in </span><span class="s1">COMPACT_ESCAPES</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">do_multiline </span><span class="s0">and </span><span class="s1">char </span><span class="s2">== </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">:</span>
                    <span class="s1">result </span><span class="s2">+= </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">result </span><span class="s2">+= </span><span class="s1">COMPACT_ESCAPES</span><span class="s2">[</span><span class="s1">char</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">result </span><span class="s2">+= </span><span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">u&quot; </span><span class="s2">+ </span><span class="s1">hex</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">(</span><span class="s1">char</span><span class="s2">))[</span><span class="s3">2</span><span class="s2">:].</span><span class="s1">rjust</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s4">&quot;0&quot;</span><span class="s2">)</span>
            <span class="s1">seq_start </span><span class="s2">= </span><span class="s1">pos </span><span class="s2">+ </span><span class="s3">1</span>
        <span class="s1">pos </span><span class="s2">+= </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">is_aot</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s6">&quot;&quot;&quot;Decides if an object behaves as an array of tables (i.e. a nonempty list 
    of dicts).&quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span>
        <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ARRAY_TYPES</span><span class="s2">)</span>
        <span class="s0">and </span><span class="s1">obj</span>
        <span class="s0">and </span><span class="s1">all</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">Mapping</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">obj</span><span class="s2">)</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">is_suitable_inline_table</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Mapping</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">: </span><span class="s1">Context</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s6">&quot;&quot;&quot;Use heuristics to decide if the inline-style representation is a good 
    choice for a given table.&quot;&quot;&quot;</span>
    <span class="s1">rendered_inline </span><span class="s2">= </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">indent_str</span><span class="s0">}{</span><span class="s1">format_inline_table</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">)</span><span class="s0">}</span><span class="s4">,&quot;</span>
    <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">rendered_inline</span><span class="s2">) &lt;= </span><span class="s1">MAX_LINE_LENGTH </span><span class="s0">and </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot; </span><span class="s0">not in </span><span class="s1">rendered_inline</span>
</pre>
</body>
</html>