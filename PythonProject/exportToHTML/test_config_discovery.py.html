<html>
<head>
<title>test_config_discovery.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_config_discovery.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">configparser </span><span class="s0">import </span><span class="s1">ConfigParser</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">product</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">cast</span>

<span class="s0">import </span><span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">path </span><span class="s0">import </span><span class="s1">Path</span>

<span class="s0">import </span><span class="s1">setuptools  </span><span class="s3"># noqa: F401 # force distutils.core to be patched</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">command</span><span class="s2">.</span><span class="s1">sdist </span><span class="s0">import </span><span class="s1">sdist</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">discovery </span><span class="s0">import </span><span class="s1">find_package_path</span><span class="s2">, </span><span class="s1">find_parent_package</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">dist </span><span class="s0">import </span><span class="s1">Distribution</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">PackageDiscoveryError</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">contexts </span><span class="s0">import </span><span class="s1">quiet</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">integration</span><span class="s2">.</span><span class="s1">helpers </span><span class="s0">import </span><span class="s1">get_sdist_members</span><span class="s2">, </span><span class="s1">get_wheel_members</span><span class="s2">, </span><span class="s1">run</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">textwrap </span><span class="s0">import </span><span class="s1">DALS</span>

<span class="s0">import </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">core</span>


<span class="s0">class </span><span class="s1">TestFindParentPackage</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_single_package</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s3"># find_parent_package should find a non-namespace parent package</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;src/namespace/pkg/nested&quot;</span><span class="s2">).</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parents</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;src/namespace/pkg/nested/__init__.py&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;src/namespace/pkg/__init__.py&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>
        <span class="s1">packages </span><span class="s2">= [</span><span class="s4">&quot;namespace&quot;</span><span class="s2">, </span><span class="s4">&quot;namespace.pkg&quot;</span><span class="s2">, </span><span class="s4">&quot;namespace.pkg.nested&quot;</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">find_parent_package</span><span class="s2">(</span><span class="s1">packages</span><span class="s2">, {</span><span class="s4">&quot;&quot;</span><span class="s2">: </span><span class="s4">&quot;src&quot;</span><span class="s2">}, </span><span class="s1">tmp_path</span><span class="s2">) == </span><span class="s4">&quot;namespace.pkg&quot;</span>

    <span class="s0">def </span><span class="s1">test_multiple_toplevel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s3"># find_parent_package should return null if the given list of packages does not</span>
        <span class="s3"># have a single parent package</span>
        <span class="s1">multiple </span><span class="s2">= [</span><span class="s4">&quot;pkg&quot;</span><span class="s2">, </span><span class="s4">&quot;pkg1&quot;</span><span class="s2">, </span><span class="s4">&quot;pkg2&quot;</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">multiple</span><span class="s2">:</span>
            <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">f&quot;src/</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">).</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parents</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">f&quot;src/</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s4">/__init__.py&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">find_parent_package</span><span class="s2">(</span><span class="s1">multiple</span><span class="s2">, {</span><span class="s4">&quot;&quot;</span><span class="s2">: </span><span class="s4">&quot;src&quot;</span><span class="s2">}, </span><span class="s1">tmp_path</span><span class="s2">) </span><span class="s0">is None</span>


<span class="s0">class </span><span class="s1">TestDiscoverPackagesAndPyModules</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Make sure discovered values for ``packages`` and ``py_modules`` work 
    similarly to explicit configuration for the simple scenarios. 
    &quot;&quot;&quot;</span>

    <span class="s1">OPTIONS </span><span class="s2">= {</span>
        <span class="s3"># Different options according to the circumstance being tested</span>
        <span class="s4">&quot;explicit-src&quot;</span><span class="s2">: {</span><span class="s4">&quot;package_dir&quot;</span><span class="s2">: {</span><span class="s4">&quot;&quot;</span><span class="s2">: </span><span class="s4">&quot;src&quot;</span><span class="s2">}, </span><span class="s4">&quot;packages&quot;</span><span class="s2">: [</span><span class="s4">&quot;pkg&quot;</span><span class="s2">]},</span>
        <span class="s4">&quot;variation-lib&quot;</span><span class="s2">: {</span>
            <span class="s4">&quot;package_dir&quot;</span><span class="s2">: {</span><span class="s4">&quot;&quot;</span><span class="s2">: </span><span class="s4">&quot;lib&quot;</span><span class="s2">},  </span><span class="s3"># variation of the source-layout</span>
        <span class="s2">},</span>
        <span class="s4">&quot;explicit-flat&quot;</span><span class="s2">: {</span><span class="s4">&quot;packages&quot;</span><span class="s2">: [</span><span class="s4">&quot;pkg&quot;</span><span class="s2">]},</span>
        <span class="s4">&quot;explicit-single_module&quot;</span><span class="s2">: {</span><span class="s4">&quot;py_modules&quot;</span><span class="s2">: [</span><span class="s4">&quot;pkg&quot;</span><span class="s2">]},</span>
        <span class="s4">&quot;explicit-namespace&quot;</span><span class="s2">: {</span><span class="s4">&quot;packages&quot;</span><span class="s2">: [</span><span class="s4">&quot;ns&quot;</span><span class="s2">, </span><span class="s4">&quot;ns.pkg&quot;</span><span class="s2">]},</span>
        <span class="s4">&quot;automatic-src&quot;</span><span class="s2">: {},</span>
        <span class="s4">&quot;automatic-flat&quot;</span><span class="s2">: {},</span>
        <span class="s4">&quot;automatic-single_module&quot;</span><span class="s2">: {},</span>
        <span class="s4">&quot;automatic-namespace&quot;</span><span class="s2">: {},</span>
    <span class="s2">}</span>
    <span class="s1">FILES </span><span class="s2">= {</span>
        <span class="s4">&quot;src&quot;</span><span class="s2">: [</span><span class="s4">&quot;src/pkg/__init__.py&quot;</span><span class="s2">, </span><span class="s4">&quot;src/pkg/main.py&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;lib&quot;</span><span class="s2">: [</span><span class="s4">&quot;lib/pkg/__init__.py&quot;</span><span class="s2">, </span><span class="s4">&quot;lib/pkg/main.py&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;flat&quot;</span><span class="s2">: [</span><span class="s4">&quot;pkg/__init__.py&quot;</span><span class="s2">, </span><span class="s4">&quot;pkg/main.py&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;single_module&quot;</span><span class="s2">: [</span><span class="s4">&quot;pkg.py&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;namespace&quot;</span><span class="s2">: [</span><span class="s4">&quot;ns/pkg/__init__.py&quot;</span><span class="s2">],</span>
    <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">_get_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">circumstance</span><span class="s2">):</span>
        <span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">layout </span><span class="s2">= </span><span class="s1">circumstance</span><span class="s2">.</span><span class="s1">partition</span><span class="s2">(</span><span class="s4">&quot;-&quot;</span><span class="s2">)</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">[</span><span class="s1">layout</span><span class="s2">]</span>
        <span class="s1">options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">OPTIONS</span><span class="s2">[</span><span class="s1">circumstance</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">files</span><span class="s2">, </span><span class="s1">options</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;circumstance&quot;</span><span class="s2">, </span><span class="s1">OPTIONS</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
    <span class="s0">def </span><span class="s1">test_sdist_filelist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">circumstance</span><span class="s2">):</span>
        <span class="s1">files</span><span class="s2">, </span><span class="s1">options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_info</span><span class="s2">(</span><span class="s1">circumstance</span><span class="s2">)</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">options</span><span class="s2">)</span>

        <span class="s1">_</span><span class="s2">, </span><span class="s1">cmd </span><span class="s2">= </span><span class="s1">_run_sdist_programatically</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">options</span><span class="s2">)</span>

        <span class="s1">manifest </span><span class="s2">= [</span><span class="s1">f</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">, </span><span class="s4">&quot;/&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">filelist</span><span class="s2">.</span><span class="s1">files</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">file </span><span class="s0">in </span><span class="s1">files</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">any</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">file</span><span class="s2">) </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">manifest</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;circumstance&quot;</span><span class="s2">, </span><span class="s1">OPTIONS</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
    <span class="s0">def </span><span class="s1">test_project</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">circumstance</span><span class="s2">):</span>
        <span class="s1">files</span><span class="s2">, </span><span class="s1">options </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_info</span><span class="s2">(</span><span class="s1">circumstance</span><span class="s2">)</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">options</span><span class="s2">)</span>

        <span class="s3"># Simulate a pre-existing `build` directory</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;build&quot;</span><span class="s2">).</span><span class="s1">mkdir</span><span class="s2">()</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;build/lib&quot;</span><span class="s2">).</span><span class="s1">mkdir</span><span class="s2">()</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;build/bdist.linux-x86_64&quot;</span><span class="s2">).</span><span class="s1">mkdir</span><span class="s2">()</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;build/bdist.linux-x86_64/file.py&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;build/lib/__init__.py&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;build/lib/file.py&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;dist&quot;</span><span class="s2">).</span><span class="s1">mkdir</span><span class="s2">()</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;dist/file.py&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>

        <span class="s1">_run_build</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">sdist_files </span><span class="s2">= </span><span class="s1">get_sdist_members</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s4">&quot;dist/*.tar.gz&quot;</span><span class="s2">)))</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;~~~~~ sdist_members ~~~~~&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">'</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">sdist_files</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">sdist_files </span><span class="s2">&gt;= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>

        <span class="s1">wheel_files </span><span class="s2">= </span><span class="s1">get_wheel_members</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s4">&quot;dist/*.whl&quot;</span><span class="s2">)))</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;~~~~~ wheel_members ~~~~~&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">'</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">wheel_files</span><span class="s2">))</span>
        <span class="s1">orig_files </span><span class="s2">= {</span><span class="s1">f</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;src/&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;lib/&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">files</span><span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">wheel_files </span><span class="s2">&gt;= </span><span class="s1">orig_files</span>

        <span class="s3"># Make sure build files are not included by mistake</span>
        <span class="s0">for </span><span class="s1">file </span><span class="s0">in </span><span class="s1">wheel_files</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s4">&quot;build&quot; </span><span class="s0">not in </span><span class="s1">files</span>
            <span class="s0">assert </span><span class="s4">&quot;dist&quot; </span><span class="s0">not in </span><span class="s1">files</span>

    <span class="s1">PURPOSEFULLY_EMPY </span><span class="s2">= {</span>
        <span class="s4">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            [metadata] 
            name = myproj 
            version = 0.0.0 
 
            [options] 
            {param} = 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s4">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            __import__('setuptools').setup( 
                name=&quot;myproj&quot;, 
                version=&quot;0.0.0&quot;, 
                {param}=[] 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            [build-system] 
            requires = [] 
            build-backend = 'setuptools.build_meta' 
 
            [project] 
            name = &quot;myproj&quot; 
            version = &quot;0.0.0&quot; 
 
            [tool.setuptools] 
            {param} = [] 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s4">&quot;template-pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            [build-system] 
            requires = [] 
            build-backend = 'setuptools.build_meta' 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">}</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s4">&quot;config_file&quot;</span><span class="s2">, </span><span class="s4">&quot;param&quot;</span><span class="s2">, </span><span class="s4">&quot;circumstance&quot;</span><span class="s2">),</span>
        <span class="s1">product</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s4">&quot;setup.cfg&quot;</span><span class="s2">, </span><span class="s4">&quot;setup.py&quot;</span><span class="s2">, </span><span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">&quot;packages&quot;</span><span class="s2">, </span><span class="s4">&quot;py_modules&quot;</span><span class="s2">],</span>
            <span class="s1">FILES</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">(),</span>
        <span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_purposefully_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">config_file</span><span class="s2">, </span><span class="s1">param</span><span class="s2">, </span><span class="s1">circumstance</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">[</span><span class="s1">circumstance</span><span class="s2">] + [</span><span class="s4">&quot;mod.py&quot;</span><span class="s2">, </span><span class="s4">&quot;other.py&quot;</span><span class="s2">, </span><span class="s4">&quot;src/pkg/__init__.py&quot;</span><span class="s2">]</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, {})</span>

        <span class="s0">if </span><span class="s1">config_file </span><span class="s2">== </span><span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">:</span>
            <span class="s1">template_param </span><span class="s2">= </span><span class="s1">param</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;_&quot;</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s3"># Make sure build works with or without setup.cfg</span>
            <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">PURPOSEFULLY_EMPY</span><span class="s2">[</span><span class="s4">&quot;template-pyproject.toml&quot;</span><span class="s2">]</span>
            <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
            <span class="s1">template_param </span><span class="s2">= </span><span class="s1">param</span>

        <span class="s1">config </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">PURPOSEFULLY_EMPY</span><span class="s2">[</span><span class="s1">config_file</span><span class="s2">].</span><span class="s1">format</span><span class="s2">(</span><span class="s1">param</span><span class="s2">=</span><span class="s1">template_param</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">config_file</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

        <span class="s1">dist </span><span class="s2">= </span><span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>
        <span class="s3"># When either parameter package or py_modules is an empty list,</span>
        <span class="s3"># then there should be no discovery</span>
        <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">param</span><span class="s2">) == []</span>
        <span class="s1">other </span><span class="s2">= {</span><span class="s4">&quot;py_modules&quot;</span><span class="s2">: </span><span class="s4">&quot;packages&quot;</span><span class="s2">, </span><span class="s4">&quot;packages&quot;</span><span class="s2">: </span><span class="s4">&quot;py_modules&quot;</span><span class="s2">}[</span><span class="s1">param</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">other</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s4">&quot;extra_files&quot;</span><span class="s2">, </span><span class="s4">&quot;pkgs&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">([</span><span class="s4">&quot;venv/bin/simulate_venv&quot;</span><span class="s2">], {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">}),</span>
            <span class="s2">([</span><span class="s4">&quot;pkg-stubs/__init__.pyi&quot;</span><span class="s2">], {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">, </span><span class="s4">&quot;pkg-stubs&quot;</span><span class="s2">}),</span>
            <span class="s2">([</span><span class="s4">&quot;other-stubs/__init__.pyi&quot;</span><span class="s2">], {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">, </span><span class="s4">&quot;other-stubs&quot;</span><span class="s2">}),</span>
            <span class="s2">(</span>
                <span class="s3"># Type stubs can also be namespaced</span>
                <span class="s2">[</span><span class="s4">&quot;namespace-stubs/pkg/__init__.pyi&quot;</span><span class="s2">],</span>
                <span class="s2">{</span><span class="s4">&quot;pkg&quot;</span><span class="s2">, </span><span class="s4">&quot;namespace-stubs&quot;</span><span class="s2">, </span><span class="s4">&quot;namespace-stubs.pkg&quot;</span><span class="s2">},</span>
            <span class="s2">),</span>
            <span class="s2">(</span>
                <span class="s3"># Just the top-level package can have `-stubs`, ignore nested ones</span>
                <span class="s2">[</span><span class="s4">&quot;namespace-stubs/pkg-stubs/__init__.pyi&quot;</span><span class="s2">],</span>
                <span class="s2">{</span><span class="s4">&quot;pkg&quot;</span><span class="s2">, </span><span class="s4">&quot;namespace-stubs&quot;</span><span class="s2">},</span>
            <span class="s2">),</span>
            <span class="s2">([</span><span class="s4">&quot;_hidden/file.py&quot;</span><span class="s2">], {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">}),</span>
            <span class="s2">([</span><span class="s4">&quot;news/finalize.py&quot;</span><span class="s2">], {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">}),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_flat_layout_with_extra_files</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">extra_files</span><span class="s2">, </span><span class="s1">pkgs</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">[</span><span class="s4">&quot;flat&quot;</span><span class="s2">] + </span><span class="s1">extra_files</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, {})</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">) == </span><span class="s1">pkgs</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s4">&quot;extra_files&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">&quot;other/__init__.py&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">&quot;other/finalize.py&quot;</span><span class="s2">],</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_flat_layout_with_dangerous_extra_files</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">extra_files</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">[</span><span class="s4">&quot;flat&quot;</span><span class="s2">] + </span><span class="s1">extra_files</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, {})</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">PackageDiscoveryError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;multiple (packages|modules)&quot;</span><span class="s2">):</span>
            <span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>

    <span class="s0">def </span><span class="s1">test_flat_layout_with_single_module</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">[</span><span class="s4">&quot;single_module&quot;</span><span class="s2">] + [</span><span class="s4">&quot;invalid-module-name.py&quot;</span><span class="s2">]</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, {})</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">py_modules</span><span class="s2">) == {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">}</span>

    <span class="s0">def </span><span class="s1">test_flat_layout_with_multiple_modules</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FILES</span><span class="s2">[</span><span class="s4">&quot;single_module&quot;</span><span class="s2">] + [</span><span class="s4">&quot;valid_module_name.py&quot;</span><span class="s2">]</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, {})</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">PackageDiscoveryError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;multiple (packages|modules)&quot;</span><span class="s2">):</span>
            <span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>

    <span class="s0">def </span><span class="s1">test_py_modules_when_wheel_dir_is_cwd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Regression for issue 3692&quot;&quot;&quot;</span>
        <span class="s0">from </span><span class="s1">setuptools </span><span class="s0">import </span><span class="s1">build_meta</span>

        <span class="s1">pyproject </span><span class="s2">= </span><span class="s4">'[project]</span><span class="s0">\n</span><span class="s4">name = &quot;test&quot;</span><span class="s0">\n</span><span class="s4">version = &quot;1&quot;'</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;foo.py&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">DirectoryStack</span><span class="s2">().</span><span class="s1">context</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
            <span class="s1">build_meta</span><span class="s2">.</span><span class="s1">build_wheel</span><span class="s2">(</span><span class="s4">&quot;.&quot;</span><span class="s2">)</span>
        <span class="s3"># Ensure py_modules are found</span>
        <span class="s1">wheel_files </span><span class="s2">= </span><span class="s1">get_wheel_members</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s4">&quot;*.whl&quot;</span><span class="s2">)))</span>
        <span class="s0">assert </span><span class="s4">&quot;foo.py&quot; </span><span class="s0">in </span><span class="s1">wheel_files</span>


<span class="s0">class </span><span class="s1">TestNoConfig</span><span class="s2">:</span>
    <span class="s1">DEFAULT_VERSION </span><span class="s2">= </span><span class="s4">&quot;0.0.0&quot;  </span><span class="s3"># Default version given by setuptools</span>

    <span class="s1">EXAMPLES </span><span class="s2">= {</span>
        <span class="s4">&quot;pkg1&quot;</span><span class="s2">: [</span><span class="s4">&quot;src/pkg1.py&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;pkg2&quot;</span><span class="s2">: [</span><span class="s4">&quot;src/pkg2/__init__.py&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;pkg3&quot;</span><span class="s2">: [</span><span class="s4">&quot;src/pkg3/__init__.py&quot;</span><span class="s2">, </span><span class="s4">&quot;src/pkg3-stubs/__init__.py&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;pkg4&quot;</span><span class="s2">: [</span><span class="s4">&quot;pkg4/__init__.py&quot;</span><span class="s2">, </span><span class="s4">&quot;pkg4-stubs/__init__.py&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;ns.nested.pkg1&quot;</span><span class="s2">: [</span><span class="s4">&quot;src/ns/nested/pkg1/__init__.py&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;ns.nested.pkg2&quot;</span><span class="s2">: [</span><span class="s4">&quot;ns/nested/pkg2/__init__.py&quot;</span><span class="s2">],</span>
    <span class="s2">}</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;example&quot;</span><span class="s2">, </span><span class="s1">EXAMPLES</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
    <span class="s0">def </span><span class="s1">test_discover_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">example</span><span class="s2">):</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">EXAMPLES</span><span class="s2">[</span><span class="s1">example</span><span class="s2">], {})</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_name</span><span class="s2">() == </span><span class="s1">example</span>

    <span class="s0">def </span><span class="s1">test_build_with_discovered_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= [</span><span class="s4">&quot;src/ns/nested/pkg/__init__.py&quot;</span><span class="s2">]</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, {})</span>
        <span class="s1">_run_build</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s4">&quot;--sdist&quot;</span><span class="s2">)</span>
        <span class="s3"># Expected distribution file</span>
        <span class="s1">dist_file </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">f&quot;dist/ns_nested_pkg-</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">DEFAULT_VERSION</span><span class="s0">}</span><span class="s4">.tar.gz&quot;</span>
        <span class="s0">assert </span><span class="s1">dist_file</span><span class="s2">.</span><span class="s1">is_file</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestWithAttrDirective</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s4">&quot;folder&quot;</span><span class="s2">, </span><span class="s4">&quot;opts&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s4">&quot;src&quot;</span><span class="s2">, {}),</span>
            <span class="s2">(</span><span class="s4">&quot;lib&quot;</span><span class="s2">, {</span><span class="s4">&quot;packages&quot;</span><span class="s2">: </span><span class="s4">&quot;find:&quot;</span><span class="s2">, </span><span class="s4">&quot;packages.find&quot;</span><span class="s2">: {</span><span class="s4">&quot;where&quot;</span><span class="s2">: </span><span class="s4">&quot;lib&quot;</span><span class="s2">}}),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_setupcfg_metadata</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">folder</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= [</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">folder</span><span class="s0">}</span><span class="s4">/pkg/__init__.py&quot;</span><span class="s2">, </span><span class="s4">&quot;setup.cfg&quot;</span><span class="s2">]</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">)</span>

        <span class="s1">config </span><span class="s2">= (</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;setup.cfg&quot;</span><span class="s2">).</span><span class="s1">read_text</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s1">overwrite </span><span class="s2">= {</span>
            <span class="s1">folder</span><span class="s2">: {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">: {</span><span class="s4">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s4">&quot;version = 42&quot;</span><span class="s2">}},</span>
            <span class="s4">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s4">&quot;[metadata]</span><span class="s0">\n</span><span class="s4">version = attr: pkg.version</span><span class="s0">\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s1">config</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">overwrite</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">dist </span><span class="s2">= </span><span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_name</span><span class="s2">() == </span><span class="s4">&quot;pkg&quot;</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_version</span><span class="s2">() == </span><span class="s4">&quot;42&quot;</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">package_dir</span>
        <span class="s1">package_path </span><span class="s2">= </span><span class="s1">find_package_path</span><span class="s2">(</span><span class="s4">&quot;pkg&quot;</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">package_dir</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">package_path</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">folder </span><span class="s0">in </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">package_path</span><span class="s2">).</span><span class="s1">parts</span><span class="s2">()</span>

        <span class="s1">_run_build</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s4">&quot;--sdist&quot;</span><span class="s2">)</span>
        <span class="s1">dist_file </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;dist/pkg-42.tar.gz&quot;</span>
        <span class="s0">assert </span><span class="s1">dist_file</span><span class="s2">.</span><span class="s1">is_file</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_pyproject_metadata</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, [</span><span class="s4">&quot;src/pkg/__init__.py&quot;</span><span class="s2">], {})</span>

        <span class="s1">overwrite </span><span class="s2">= {</span>
            <span class="s4">&quot;src&quot;</span><span class="s2">: {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">: {</span><span class="s4">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s4">&quot;version = 42&quot;</span><span class="s2">}},</span>
            <span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">: (</span>
                <span class="s4">&quot;[project]</span><span class="s0">\n</span><span class="s4">name = 'pkg'</span><span class="s0">\n</span><span class="s4">dynamic = ['version']</span><span class="s0">\n</span><span class="s4">&quot;</span>
                <span class="s4">&quot;[tool.setuptools.dynamic]</span><span class="s0">\n</span><span class="s4">version = {attr = 'pkg.version'}</span><span class="s0">\n</span><span class="s4">&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">overwrite</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">dist </span><span class="s2">= </span><span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_version</span><span class="s2">() == </span><span class="s4">&quot;42&quot;</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">package_dir </span><span class="s2">== {</span><span class="s4">&quot;&quot;</span><span class="s2">: </span><span class="s4">&quot;src&quot;</span><span class="s2">}</span>


<span class="s0">class </span><span class="s1">TestWithCExtension</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">_simulate_package_with_extension</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s3"># This example is based on: https://github.com/nucleic/kiwi/tree/1.4.0</span>
        <span class="s1">files </span><span class="s2">= [</span>
            <span class="s4">&quot;benchmarks/file.py&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;docs/Makefile&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;docs/requirements.txt&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;docs/source/conf.py&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;proj/header.h&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;proj/file.py&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;py/proj.cpp&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;py/other.cpp&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;py/file.py&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;py/py.typed&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;py/tests/test_proj.py&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;README.rst&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, {})</span>

        <span class="s1">setup_script </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
            from setuptools import Extension, setup 
 
            ext_modules = [ 
                Extension( 
                    &quot;proj&quot;, 
                    [&quot;py/proj.cpp&quot;, &quot;py/other.cpp&quot;], 
                    include_dirs=[&quot;.&quot;], 
                    language=&quot;c++&quot;, 
                ), 
            ] 
            setup(ext_modules=ext_modules) 
        &quot;&quot;&quot;</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;setup.py&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">setup_script</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_skip_discovery_with_setupcfg_metadata</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Ensure that auto-discovery is not triggered when the project is based on 
        C-extensions only, for backward compatibility. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_simulate_package_with_extension</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">pyproject </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
            [build-system] 
            requires = [] 
            build-backend = 'setuptools.build_meta' 
        &quot;&quot;&quot;</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

        <span class="s1">setupcfg </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
            [metadata] 
            name = proj 
            version = 42 
        &quot;&quot;&quot;</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;setup.cfg&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">setupcfg</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

        <span class="s1">dist </span><span class="s2">= </span><span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_name</span><span class="s2">() == </span><span class="s4">&quot;proj&quot;</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_version</span><span class="s2">() == </span><span class="s4">&quot;42&quot;</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">py_modules </span><span class="s0">is None</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">packages </span><span class="s0">is None</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">ext_modules</span><span class="s2">) == </span><span class="s6">1</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">ext_modules</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;proj&quot;</span>

    <span class="s0">def </span><span class="s1">test_dont_skip_discovery_with_pyproject_metadata</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;When opting-in to pyproject.toml metadata, auto-discovery will be active if 
        the package lists C-extensions, but does not configure py-modules or packages. 
 
        This way we ensure users with complex package layouts that would lead to the 
        discovery of multiple top-level modules/packages see errors and are forced to 
        explicitly set ``packages`` or ``py-modules``. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_simulate_package_with_extension</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">pyproject </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
            [project] 
            name = 'proj' 
            version = '42' 
        &quot;&quot;&quot;</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">PackageDiscoveryError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;multiple (packages|modules)&quot;</span><span class="s2">):</span>
            <span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, {})</span>


<span class="s0">class </span><span class="s1">TestWithPackageData</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">_simulate_package_with_data_files</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">src_root</span><span class="s2">):</span>
        <span class="s1">files </span><span class="s2">= [</span>
            <span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">src_root</span><span class="s0">}</span><span class="s4">/proj/__init__.py&quot;</span><span class="s2">,</span>
            <span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">src_root</span><span class="s0">}</span><span class="s4">/proj/file1.txt&quot;</span><span class="s2">,</span>
            <span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">src_root</span><span class="s0">}</span><span class="s4">/proj/nested/file2.txt&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>
        <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, {})</span>

        <span class="s1">manifest </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
            global-include *.py *.txt 
        &quot;&quot;&quot;</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;MANIFEST.in&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">manifest</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s1">EXAMPLE_SETUPCFG </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
    [metadata] 
    name = proj 
    version = 42 
 
    [options] 
    include_package_data = True 
    &quot;&quot;&quot;</span>
    <span class="s1">EXAMPLE_PYPROJECT </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
    [project] 
    name = &quot;proj&quot; 
    version = &quot;42&quot; 
    &quot;&quot;&quot;</span>

    <span class="s1">PYPROJECT_PACKAGE_DIR </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
    [tool.setuptools] 
    package-dir = {&quot;&quot; = &quot;src&quot;} 
    &quot;&quot;&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s4">&quot;src_root&quot;</span><span class="s2">, </span><span class="s4">&quot;files&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s4">&quot;.&quot;</span><span class="s2">, {</span><span class="s4">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">EXAMPLE_SETUPCFG</span><span class="s2">)}),</span>
            <span class="s2">(</span><span class="s4">&quot;.&quot;</span><span class="s2">, {</span><span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">EXAMPLE_PYPROJECT</span><span class="s2">)}),</span>
            <span class="s2">(</span><span class="s4">&quot;src&quot;</span><span class="s2">, {</span><span class="s4">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">EXAMPLE_SETUPCFG</span><span class="s2">)}),</span>
            <span class="s2">(</span><span class="s4">&quot;src&quot;</span><span class="s2">, {</span><span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">EXAMPLE_PYPROJECT</span><span class="s2">)}),</span>
            <span class="s2">(</span>
                <span class="s4">&quot;src&quot;</span><span class="s2">,</span>
                <span class="s2">{</span>
                    <span class="s4">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">EXAMPLE_SETUPCFG</span><span class="s2">)</span>
                    <span class="s2">+ </span><span class="s1">DALS</span><span class="s2">(</span>
                        <span class="s4">&quot;&quot;&quot; 
                        packages = find: 
                        package_dir = 
                            =src 
 
                        [options.packages.find] 
                        where = src 
                        &quot;&quot;&quot;</span>
                    <span class="s2">)</span>
                <span class="s2">},</span>
            <span class="s2">),</span>
            <span class="s2">(</span>
                <span class="s4">&quot;src&quot;</span><span class="s2">,</span>
                <span class="s2">{</span>
                    <span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span><span class="s1">EXAMPLE_PYPROJECT</span><span class="s2">)</span>
                    <span class="s2">+ </span><span class="s1">DALS</span><span class="s2">(</span>
                        <span class="s4">&quot;&quot;&quot; 
                        [tool.setuptools] 
                        package-dir = {&quot;&quot; = &quot;src&quot;} 
                        &quot;&quot;&quot;</span>
                    <span class="s2">)</span>
                <span class="s2">},</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_include_package_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">src_root</span><span class="s2">, </span><span class="s1">files</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Make sure auto-discovery does not affect package include_package_data. 
        See issue #3196. 
        &quot;&quot;&quot;</span>
        <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_simulate_package_with_data_files</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">src_root</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= {</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">src_root</span><span class="s0">}</span><span class="s4">/proj/file1.txt&quot;</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">, </span><span class="s4">&quot;/&quot;</span><span class="s2">),</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">src_root</span><span class="s0">}</span><span class="s4">/proj/nested/file2.txt&quot;</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">, </span><span class="s4">&quot;/&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>

        <span class="s1">_run_build</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s1">sdist_files </span><span class="s2">= </span><span class="s1">get_sdist_members</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s4">&quot;dist/*.tar.gz&quot;</span><span class="s2">)))</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;~~~~~ sdist_members ~~~~~&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">'</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">sdist_files</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">sdist_files </span><span class="s2">&gt;= </span><span class="s1">expected</span>

        <span class="s1">wheel_files </span><span class="s2">= </span><span class="s1">get_wheel_members</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s4">&quot;dist/*.whl&quot;</span><span class="s2">)))</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;~~~~~ wheel_members ~~~~~&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">'</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">wheel_files</span><span class="s2">))</span>
        <span class="s1">orig_files </span><span class="s2">= {</span><span class="s1">f</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;src/&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;lib/&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">wheel_files </span><span class="s2">&gt;= </span><span class="s1">orig_files</span>


<span class="s0">def </span><span class="s1">test_compatible_with_numpy_configuration</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">files </span><span class="s2">= [</span>
        <span class="s4">&quot;dir1/__init__.py&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;dir2/__init__.py&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;file.py&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, {})</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">({})</span>
    <span class="s1">dist</span><span class="s2">.</span><span class="s1">configuration </span><span class="s2">= </span><span class="s1">object</span><span class="s2">()</span>
    <span class="s1">dist</span><span class="s2">.</span><span class="s1">set_defaults</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">py_modules </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">packages </span><span class="s0">is None</span>


<span class="s0">def </span><span class="s1">test_name_discovery_doesnt_break_cli</span><span class="s2">(</span><span class="s1">tmpdir_cwd</span><span class="s2">):</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">({</span><span class="s4">&quot;pkg.py&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;</span><span class="s2">})</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">({})</span>
    <span class="s1">dist</span><span class="s2">.</span><span class="s1">script_args </span><span class="s2">= [</span><span class="s4">&quot;--name&quot;</span><span class="s2">]</span>
    <span class="s1">dist</span><span class="s2">.</span><span class="s1">set_defaults</span><span class="s2">()</span>
    <span class="s1">dist</span><span class="s2">.</span><span class="s1">parse_command_line</span><span class="s2">()  </span><span class="s3"># &lt;-- no exception should be raised here.</span>
    <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_name</span><span class="s2">() == </span><span class="s4">&quot;pkg&quot;</span>


<span class="s0">def </span><span class="s1">test_preserve_explicit_name_with_dynamic_version</span><span class="s2">(</span><span class="s1">tmpdir_cwd</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;According to #3545 it seems that ``name`` discovery is running, 
    even when the project already explicitly sets it. 
    This seems to be related to parsing of dynamic versions (via ``attr`` directive), 
    which requires the auto-discovery of ``package_dir``. 
    &quot;&quot;&quot;</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s4">&quot;src&quot;</span><span class="s2">: {</span>
            <span class="s4">&quot;pkg&quot;</span><span class="s2">: {</span><span class="s4">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s4">&quot;__version__ = 42</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">},</span>
        <span class="s2">},</span>
        <span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            [project] 
            name = &quot;myproj&quot;  # purposefully different from package name 
            dynamic = [&quot;version&quot;] 
            [tool.setuptools.dynamic] 
            version = {&quot;attr&quot; = &quot;pkg.__version__&quot;} 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">}</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">({})</span>
    <span class="s1">orig_analyse_name </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">set_defaults</span><span class="s2">.</span><span class="s1">analyse_name</span>

    <span class="s0">def </span><span class="s1">spy_analyse_name</span><span class="s2">():</span>
        <span class="s3"># We can check if name discovery was triggered by ensuring the original</span>
        <span class="s3"># name remains instead of the package name.</span>
        <span class="s1">orig_analyse_name</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_name</span><span class="s2">() == </span><span class="s4">&quot;myproj&quot;</span>

    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">set_defaults</span><span class="s2">, </span><span class="s4">&quot;analyse_name&quot;</span><span class="s2">, </span><span class="s1">spy_analyse_name</span><span class="s2">)</span>
    <span class="s1">dist</span><span class="s2">.</span><span class="s1">parse_config_files</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_version</span><span class="s2">() == </span><span class="s4">&quot;42&quot;</span>
    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">packages</span><span class="s2">) == {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">}</span>


<span class="s0">def </span><span class="s1">_populate_project_dir</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">options</span><span class="s2">):</span>
    <span class="s3"># NOTE: Currently pypa/build will refuse to build the project if no</span>
    <span class="s3"># `pyproject.toml` or `setup.py` is found. So it is impossible to do</span>
    <span class="s3"># completely &quot;config-less&quot; projects.</span>
    <span class="s1">basic </span><span class="s2">= {</span>
        <span class="s4">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s4">&quot;import setuptools</span><span class="s0">\n</span><span class="s4">setuptools.setup()&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;README.md&quot;</span><span class="s2">: </span><span class="s4">&quot;# Example Package&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;LICENSE&quot;</span><span class="s2">: </span><span class="s4">&quot;Copyright (c) 2018&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">basic</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">root</span><span class="s2">)</span>
    <span class="s1">_write_setupcfg</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">options</span><span class="s2">)</span>
    <span class="s1">paths </span><span class="s2">= (</span><span class="s1">root </span><span class="s2">/ </span><span class="s1">f </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">files</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">paths</span><span class="s2">:</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parents</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">touch</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">_write_setupcfg</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">options</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">options</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;~~~~~ **NO** setup.cfg ~~~~~&quot;</span><span class="s2">)</span>
        <span class="s0">return</span>
    <span class="s1">setupcfg </span><span class="s2">= </span><span class="s1">ConfigParser</span><span class="s2">()</span>
    <span class="s1">setupcfg</span><span class="s2">.</span><span class="s1">add_section</span><span class="s2">(</span><span class="s4">&quot;options&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">options</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s4">&quot;packages.find&quot;</span><span class="s2">:</span>
            <span class="s1">setupcfg</span><span class="s2">.</span><span class="s1">add_section</span><span class="s2">(</span><span class="s4">f&quot;options.</span><span class="s0">{</span><span class="s1">key</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s1">setupcfg</span><span class="s2">[</span><span class="s4">f&quot;options.</span><span class="s0">{</span><span class="s1">key</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">].</span><span class="s1">update</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
            <span class="s1">setupcfg</span><span class="s2">[</span><span class="s4">&quot;options&quot;</span><span class="s2">][</span><span class="s1">key</span><span class="s2">] = </span><span class="s4">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
            <span class="s1">str_value </span><span class="s2">= </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">\t{</span><span class="s1">k</span><span class="s0">} </span><span class="s4">= </span><span class="s0">{</span><span class="s1">v</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
            <span class="s1">setupcfg</span><span class="s2">[</span><span class="s4">&quot;options&quot;</span><span class="s2">][</span><span class="s1">key</span><span class="s2">] = </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s1">str_value</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">setupcfg</span><span class="s2">[</span><span class="s4">&quot;options&quot;</span><span class="s2">][</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">str</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">root </span><span class="s2">/ </span><span class="s4">&quot;setup.cfg&quot;</span><span class="s2">, </span><span class="s4">&quot;w&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">setupcfg</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;~~~~~ setup.cfg ~~~~~&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">((</span><span class="s1">root </span><span class="s2">/ </span><span class="s4">&quot;setup.cfg&quot;</span><span class="s2">).</span><span class="s1">read_text</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_run_build</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, *</span><span class="s1">flags</span><span class="s2">):</span>
    <span class="s1">cmd </span><span class="s2">= [</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">, </span><span class="s4">&quot;-m&quot;</span><span class="s2">, </span><span class="s4">&quot;build&quot;</span><span class="s2">, </span><span class="s4">&quot;--no-isolation&quot;</span><span class="s2">, *</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)]</span>
    <span class="s0">return </span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">env</span><span class="s2">={</span><span class="s4">'DISTUTILS_DEBUG'</span><span class="s2">: </span><span class="s4">''</span><span class="s2">})</span>


<span class="s0">def </span><span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
    <span class="s1">root </span><span class="s2">= </span><span class="s4">&quot;/&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">))  </span><span class="s3"># POSIX-style</span>

    <span class="s1">script </span><span class="s2">= </span><span class="s1">dist_path </span><span class="s2">/ </span><span class="s4">'setup.py'</span>
    <span class="s0">if </span><span class="s1">script</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">):</span>
            <span class="s1">dist </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span>
                <span class="s1">Distribution</span><span class="s2">,</span>
                <span class="s1">distutils</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">run_setup</span><span class="s2">(</span><span class="s4">&quot;setup.py&quot;</span><span class="s2">, {}, </span><span class="s1">stop_after</span><span class="s2">=</span><span class="s4">&quot;init&quot;</span><span class="s2">),</span>
            <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">)</span>

    <span class="s1">dist</span><span class="s2">.</span><span class="s1">src_root </span><span class="s2">= </span><span class="s1">root</span>
    <span class="s1">dist</span><span class="s2">.</span><span class="s1">script_name </span><span class="s2">= </span><span class="s4">&quot;setup.py&quot;</span>
    <span class="s0">with </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">):</span>
        <span class="s1">dist</span><span class="s2">.</span><span class="s1">parse_config_files</span><span class="s2">()</span>

    <span class="s1">dist</span><span class="s2">.</span><span class="s1">set_defaults</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">dist</span>


<span class="s0">def </span><span class="s1">_run_sdist_programatically</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">_get_dist</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>
    <span class="s1">cmd </span><span class="s2">= </span><span class="s1">sdist</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">ensure_finalized</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">distribution</span><span class="s2">.</span><span class="s1">packages </span><span class="s0">or </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">distribution</span><span class="s2">.</span><span class="s1">py_modules</span>

    <span class="s0">with </span><span class="s1">quiet</span><span class="s2">(), </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">):</span>
        <span class="s1">cmd</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>

    <span class="s0">return </span><span class="s1">dist</span><span class="s2">, </span><span class="s1">cmd</span>
</pre>
</body>
</html>