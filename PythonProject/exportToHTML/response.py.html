<html>
<head>
<title>response.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
response.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">json </span><span class="s0">as </span><span class="s1">_json</span>
<span class="s0">import </span><span class="s1">logging</span>
<span class="s0">import </span><span class="s1">typing</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">contextmanager</span>
<span class="s0">from </span><span class="s1">dataclasses </span><span class="s0">import </span><span class="s1">dataclass</span>
<span class="s0">from </span><span class="s1">http</span><span class="s2">.</span><span class="s1">client </span><span class="s0">import </span><span class="s1">HTTPException </span><span class="s0">as </span><span class="s1">HTTPException</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span><span class="s2">, </span><span class="s1">IOBase</span>

<span class="s0">from </span><span class="s2">...</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">InvalidHeader</span><span class="s2">, </span><span class="s1">TimeoutError</span>
<span class="s0">from </span><span class="s2">...</span><span class="s1">response </span><span class="s0">import </span><span class="s1">BaseHTTPResponse</span>
<span class="s0">from </span><span class="s2">...</span><span class="s1">util</span><span class="s2">.</span><span class="s1">retry </span><span class="s0">import </span><span class="s1">Retry</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">request </span><span class="s0">import </span><span class="s1">EmscriptenRequest</span>

<span class="s0">if </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s2">...</span><span class="s1">_base_connection </span><span class="s0">import </span><span class="s1">BaseHTTPConnection</span><span class="s2">, </span><span class="s1">BaseHTTPSConnection</span>

<span class="s1">log </span><span class="s2">= </span><span class="s1">logging</span><span class="s2">.</span><span class="s1">getLogger</span><span class="s2">(</span><span class="s1">__name__</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">EmscriptenResponse</span><span class="s2">:</span>
    <span class="s1">status_code</span><span class="s2">: </span><span class="s1">int</span>
    <span class="s1">headers</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]</span>
    <span class="s1">body</span><span class="s2">: </span><span class="s1">IOBase </span><span class="s2">| </span><span class="s1">bytes</span>
    <span class="s1">request</span><span class="s2">: </span><span class="s1">EmscriptenRequest</span>


<span class="s0">class </span><span class="s1">EmscriptenHttpResponseWrapper</span><span class="s2">(</span><span class="s1">BaseHTTPResponse</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">internal_response</span><span class="s2">: </span><span class="s1">EmscriptenResponse</span><span class="s2">,</span>
        <span class="s1">url</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">connection</span><span class="s2">: </span><span class="s1">BaseHTTPConnection </span><span class="s2">| </span><span class="s1">BaseHTTPSConnection </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pool </span><span class="s2">= </span><span class="s0">None  </span><span class="s3"># set by pool class</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_body </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_response </span><span class="s2">= </span><span class="s1">internal_response</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_url </span><span class="s2">= </span><span class="s1">url</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_connection </span><span class="s2">= </span><span class="s1">connection</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_closed </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">headers</span><span class="s2">=</span><span class="s1">internal_response</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">,</span>
            <span class="s1">status</span><span class="s2">=</span><span class="s1">internal_response</span><span class="s2">.</span><span class="s1">status_code</span><span class="s2">,</span>
            <span class="s1">request_url</span><span class="s2">=</span><span class="s1">url</span><span class="s2">,</span>
            <span class="s1">version</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
            <span class="s1">version_string</span><span class="s2">=</span><span class="s5">&quot;HTTP/?&quot;</span><span class="s2">,</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">decode_content</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">length_remaining </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_init_length</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">request</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">length_is_certain </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">url</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str </span><span class="s2">| </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_url</span>

    <span class="s2">@</span><span class="s1">url</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">url</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">url</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_url </span><span class="s2">= </span><span class="s1">url</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">connection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; BaseHTTPConnection </span><span class="s2">| </span><span class="s1">BaseHTTPSConnection </span><span class="s2">| </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_connection</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">retries</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; Retry </span><span class="s2">| </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_retries</span>

    <span class="s2">@</span><span class="s1">retries</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">retries</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">retries</span><span class="s2">: </span><span class="s1">Retry </span><span class="s2">| </span><span class="s0">None</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3"># Override the request_url if retries has a redirect location.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_retries </span><span class="s2">= </span><span class="s1">retries</span>

    <span class="s0">def </span><span class="s1">stream</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">amt</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s4">2</span><span class="s2">**</span><span class="s4">16</span><span class="s2">, </span><span class="s1">decode_content</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Generator</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">]:</span>
        <span class="s6">&quot;&quot;&quot; 
        A generator wrapper for the read() method. A call will block until 
        ``amt`` bytes have been read from the connection or until the 
        connection is closed. 
 
        :param amt: 
            How much of the content to read. The generator will return up to 
            much data per iteration, but may return less. This is particularly 
            likely when using compressed data. However, the empty string will 
            never be returned. 
 
        :param decode_content: 
            If True, will attempt to decode the body based on the 
            'content-encoding' header. 
        &quot;&quot;&quot;</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">amt</span><span class="s2">=</span><span class="s1">amt</span><span class="s2">, </span><span class="s1">decode_content</span><span class="s2">=</span><span class="s1">decode_content</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">data</span><span class="s2">:</span>
                <span class="s0">yield </span><span class="s1">data</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">break</span>

    <span class="s0">def </span><span class="s1">_init_length</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request_method</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None</span><span class="s2">) </span><span class="s1">-&gt; int </span><span class="s2">| </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">length</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s0">None</span>
        <span class="s1">content_length</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">&quot;content-length&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">content_length </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s3"># RFC 7230 section 3.3.2 specifies multiple content lengths can</span>
                <span class="s3"># be sent in a single Content-Length header</span>
                <span class="s3"># (e.g. Content-Length: 42, 42). This line ensures the values</span>
                <span class="s3"># are all valid ints and that as long as the `set` length is 1,</span>
                <span class="s3"># all values are the same. Otherwise, the header is invalid.</span>
                <span class="s1">lengths </span><span class="s2">= {</span><span class="s1">int</span><span class="s2">(</span><span class="s1">val</span><span class="s2">) </span><span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">content_length</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">&quot;,&quot;</span><span class="s2">)}</span>
                <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lengths</span><span class="s2">) &gt; </span><span class="s4">1</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">InvalidHeader</span><span class="s2">(</span>
                        <span class="s5">&quot;Content-Length contained multiple &quot;</span>
                        <span class="s5">&quot;unmatching values (%s)&quot; </span><span class="s2">% </span><span class="s1">content_length</span>
                    <span class="s2">)</span>
                <span class="s1">length </span><span class="s2">= </span><span class="s1">lengths</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
                <span class="s1">length </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">length </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">length </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">else</span><span class="s2">:  </span><span class="s3"># if content_length is None</span>
            <span class="s1">length </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s3"># Check for responses that shouldn't include a body</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">status </span><span class="s0">in </span><span class="s2">(</span><span class="s4">204</span><span class="s2">, </span><span class="s4">304</span><span class="s2">)</span>
            <span class="s0">or </span><span class="s4">100 </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">status </span><span class="s2">&lt; </span><span class="s4">200</span>
            <span class="s0">or </span><span class="s1">request_method </span><span class="s2">== </span><span class="s5">&quot;HEAD&quot;</span>
        <span class="s2">):</span>
            <span class="s1">length </span><span class="s2">= </span><span class="s4">0</span>

        <span class="s0">return </span><span class="s1">length</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">amt</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">decode_content</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,  </span><span class="s3"># ignored because browser decodes always</span>
        <span class="s1">cache_content</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_closed</span>
            <span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response </span><span class="s0">is None</span>
            <span class="s0">or </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">, </span><span class="s1">IOBase</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">closed</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s0">return </span><span class="s7">b&quot;&quot;</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_error_catcher</span><span class="s2">():</span>
            <span class="s3"># body has been preloaded as a string by XmlHttpRequest</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">, </span><span class="s1">IOBase</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">length_remaining </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">length_is_certain </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s3"># wrap body in IOStream</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">amt </span><span class="s0">is not None and </span><span class="s1">amt </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s3"># don't cache partial content</span>
                <span class="s1">cache_content </span><span class="s2">= </span><span class="s0">False</span>
                <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">amt</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:  </span><span class="s3"># read all we can (and cache it)</span>
                <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">cache_content</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_body </span><span class="s2">= </span><span class="s1">data</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">length_remaining </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">length_remaining </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">length_remaining </span><span class="s2">- </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) == </span><span class="s4">0 </span><span class="s0">or </span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">length_is_certain </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">length_remaining </span><span class="s2">== </span><span class="s4">0</span>
            <span class="s2">):</span>
                <span class="s3"># definitely finished reading, close response stream</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read_chunked</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">amt</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">decode_content</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Generator</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">]:</span>
        <span class="s3"># chunked is handled by browser</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s1">bytes </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">amt</span><span class="s2">, </span><span class="s1">decode_content</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">bytes</span><span class="s2">:</span>
                <span class="s0">break</span>
            <span class="s0">yield </span><span class="s1">bytes</span>

    <span class="s0">def </span><span class="s1">release_conn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pool </span><span class="s0">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_connection</span><span class="s2">:</span>
            <span class="s0">return None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pool</span><span class="s2">.</span><span class="s1">_put_conn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_connection</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_connection </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">drain_conn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_body</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_body</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">cache_content</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">json</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">:</span>
        <span class="s6">&quot;&quot;&quot; 
        Deserializes the body of the HTTP response as a Python object. 
 
        The body of the HTTP response must be encoded using UTF-8, as per 
        `RFC 8529 Section 8.1 &lt;https://www.rfc-editor.org/rfc/rfc8259#section-8.1&gt;`_. 
 
        To use a custom JSON decoder pass the result of :attr:`HTTPResponse.data` to 
        your custom decoder instead. 
 
        If the body of the HTTP response is not decodable to UTF-8, a 
        `UnicodeDecodeError` will be raised. If the body of the HTTP response is not a 
        valid JSON document, a `json.JSONDecodeError` will be raised. 
 
        Read more :ref:`here &lt;json_content&gt;`. 
 
        :returns: The body of the HTTP response as a Python object. 
        &quot;&quot;&quot;</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">_json</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_closed</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">, </span><span class="s1">IOBase</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_connection</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_connection</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_connection </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_closed </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s2">@</span><span class="s1">contextmanager</span>
    <span class="s0">def </span><span class="s1">_error_catcher</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Generator</span><span class="s2">[</span><span class="s0">None</span><span class="s2">]:</span>
        <span class="s6">&quot;&quot;&quot; 
        Catch Emscripten specific exceptions thrown by fetch.py, 
        instead re-raising urllib3 variants, so that low-level exceptions 
        are not leaked in the high-level api. 
 
        On exit, release the connection back to the pool. 
        &quot;&quot;&quot;</span>
        <span class="s0">from </span><span class="s2">.</span><span class="s1">fetch </span><span class="s0">import </span><span class="s1">_RequestError</span><span class="s2">, </span><span class="s1">_TimeoutError  </span><span class="s3"># avoid circular import</span>

        <span class="s1">clean_exit </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">yield</span>
            <span class="s3"># If no exception is thrown, we should avoid cleaning up</span>
            <span class="s3"># unnecessarily.</span>
            <span class="s1">clean_exit </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">except </span><span class="s1">_TimeoutError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">TimeoutError</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">))</span>
        <span class="s0">except </span><span class="s1">_RequestError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">HTTPException</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">))</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s3"># If we didn't terminate cleanly, we need to throw away our</span>
            <span class="s3"># connection.</span>
            <span class="s0">if not </span><span class="s1">clean_exit</span><span class="s2">:</span>
                <span class="s3"># The response may not be closed but we're not going to use it</span>
                <span class="s3"># anymore so close it now</span>
                <span class="s0">if </span><span class="s2">(</span>
                    <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">, </span><span class="s1">IOBase</span><span class="s2">)</span>
                    <span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">closed</span>
                <span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
                <span class="s3"># release the connection back to the pool</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">release_conn</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s3"># If we have read everything from the response stream,</span>
                <span class="s3"># return the connection back to the pool.</span>
                <span class="s0">if </span><span class="s2">(</span>
                    <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">, </span><span class="s1">IOBase</span><span class="s2">)</span>
                    <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_response</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">closed</span>
                <span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">release_conn</span><span class="s2">()</span>
</pre>
</body>
</html>