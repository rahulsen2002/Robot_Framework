<html>
<head>
<title>automain.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
automain.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright 2014-2015 Nathan West</span>
<span class="s0">#</span>
<span class="s0"># This file is part of autocommand.</span>
<span class="s0">#</span>
<span class="s0"># autocommand is free software: you can redistribute it and/or modify</span>
<span class="s0"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="s0"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="s0"># (at your option) any later version.</span>
<span class="s0">#</span>
<span class="s0"># autocommand is distributed in the hope that it will be useful,</span>
<span class="s0"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s0"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="s0"># GNU Lesser General Public License for more details.</span>
<span class="s0">#</span>
<span class="s0"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="s0"># along with autocommand.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">AutocommandError</span>


<span class="s2">class </span><span class="s1">AutomainRequiresModuleError</span><span class="s3">(</span><span class="s1">AutocommandError</span><span class="s3">, </span><span class="s1">TypeError</span><span class="s3">):</span>
    <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">automain</span><span class="s3">(</span><span class="s1">module</span><span class="s3">, *, </span><span class="s1">args</span><span class="s3">=(), </span><span class="s1">kwargs</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s4">''' 
    This decorator automatically invokes a function if the module is being run 
    as the &quot;__main__&quot; module. Optionally, provide args or kwargs with which to 
    call the function. If `module` is &quot;__main__&quot;, the function is called, and 
    the program is `sys.exit`ed with the return value. You can also pass `True` 
    to cause the function to be called unconditionally. If the function is not 
    called, it is returned unchanged by the decorator. 
 
    Usage: 
 
    @automain(__name__)  # Pass __name__ to check __name__==&quot;__main__&quot; 
    def main(): 
        ... 
 
    If __name__ is &quot;__main__&quot; here, the main function is called, and then 
    sys.exit called with the return value. 
    '''</span>

    <span class="s0"># Check that @automain(...) was called, rather than @automain</span>
    <span class="s2">if </span><span class="s1">callable</span><span class="s3">(</span><span class="s1">module</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">AutomainRequiresModuleError</span><span class="s3">(</span><span class="s1">module</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">module </span><span class="s3">== </span><span class="s5">'__main__' </span><span class="s2">or </span><span class="s1">module </span><span class="s2">is True</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">kwargs </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">kwargs </span><span class="s3">= {}</span>

        <span class="s0"># Use a function definition instead of a lambda for a neater traceback</span>
        <span class="s2">def </span><span class="s1">automain_decorator</span><span class="s3">(</span><span class="s1">main</span><span class="s3">):</span>
            <span class="s1">sys</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s1">main</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">automain_decorator</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return lambda </span><span class="s1">main</span><span class="s3">: </span><span class="s1">main</span>
</pre>
</body>
</html>