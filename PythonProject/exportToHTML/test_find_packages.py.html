<html>
<head>
<title>test_find_packages.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_find_packages.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Tests for automatic package discovery&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">tempfile</span>

<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">setuptools </span><span class="s2">import </span><span class="s1">find_namespace_packages</span><span class="s3">, </span><span class="s1">find_packages</span>
<span class="s2">from </span><span class="s1">setuptools</span><span class="s3">.</span><span class="s1">discovery </span><span class="s2">import </span><span class="s1">FlatLayoutPackageFinder</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">compat</span><span class="s3">.</span><span class="s1">py39 </span><span class="s2">import </span><span class="s1">os_helper</span>


<span class="s2">class </span><span class="s1">TestFindPackages</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir </span><span class="s3">= </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">mkdtemp</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_make_pkg_structure</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">teardown_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">shutil</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_make_pkg_structure</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Make basic package structure. 
 
        dist/ 
            docs/ 
                conf.py 
            pkg/ 
                __pycache__/ 
                nspkg/ 
                    mod.py 
                subpkg/ 
                    assets/ 
                        asset 
                    __init__.py 
            setup.py 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">docs_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'docs'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'conf.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">docs_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'pkg'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'__pycache__'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ns_pkg_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'nspkg'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'mod.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ns_pkg_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sub_pkg_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'subpkg'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">asset_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'assets'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub_pkg_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'asset'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">asset_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub_pkg_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'setup.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">parent_dir</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">parent_dir</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parent_dir</span><span class="s3">, </span><span class="s1">path</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">path</span>

    <span class="s2">def </span><span class="s1">_touch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">dir_</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">dir_</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dir_</span><span class="s3">, </span><span class="s1">path</span><span class="s3">)</span>
        <span class="s1">open</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s4">'wb'</span><span class="s3">).</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">path</span>

    <span class="s2">def </span><span class="s1">test_regular_package</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">packages </span><span class="s3">== [</span><span class="s4">'pkg'</span><span class="s3">, </span><span class="s4">'pkg.subpkg'</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">test_exclude</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">, </span><span class="s1">exclude</span><span class="s3">=(</span><span class="s4">'pkg.*'</span><span class="s3">,))</span>
        <span class="s2">assert </span><span class="s1">packages </span><span class="s3">== [</span><span class="s4">'pkg'</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">test_exclude_recursive</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Excluding a parent package should not exclude child packages as well. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub_pkg_dir</span><span class="s3">)</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">, </span><span class="s1">exclude</span><span class="s3">=(</span><span class="s4">'pkg'</span><span class="s3">,))</span>
        <span class="s2">assert </span><span class="s1">packages </span><span class="s3">== [</span><span class="s4">'pkg.subpkg'</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">test_include_excludes_other</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        If include is specified, other packages should be excluded. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">alt_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'other_pkg'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">alt_dir</span><span class="s3">)</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">, </span><span class="s1">include</span><span class="s3">=[</span><span class="s4">'other_pkg'</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">packages </span><span class="s3">== [</span><span class="s4">'other_pkg'</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">test_dir_with_dot_is_skipped</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">shutil</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">, </span><span class="s4">'pkg/subpkg/assets'</span><span class="s3">))</span>
        <span class="s1">data_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'some.data'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">data_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'file.dat'</span><span class="s3">, </span><span class="s1">data_dir</span><span class="s3">)</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s4">'pkg.some.data' </span><span class="s2">not in </span><span class="s1">packages</span>

    <span class="s2">def </span><span class="s1">test_dir_with_packages_in_subdir_is_excluded</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Ensure that a package in a non-package such as build/pkg/__init__.py 
        is excluded. 
        &quot;&quot;&quot;</span>
        <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'build'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s1">build_pkg_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mkdir</span><span class="s3">(</span><span class="s4">'pkg'</span><span class="s3">, </span><span class="s1">build_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">build_pkg_dir</span><span class="s3">)</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s4">'build.pkg' </span><span class="s2">not in </span><span class="s1">packages</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">os_helper</span><span class="s3">.</span><span class="s1">can_symlink</span><span class="s3">(), </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">'Symlink support required'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_symlinked_packages_are_included</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        A symbolically-linked directory should be treated like any other 
        directory when matched as a package. 
 
        Create a link from lpkg -&gt; pkg. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">linked_pkg </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">, </span><span class="s4">'lpkg'</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">symlink</span><span class="s3">(</span><span class="s4">'pkg'</span><span class="s3">, </span><span class="s1">linked_pkg</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">linked_pkg</span><span class="s3">)</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s4">'lpkg' </span><span class="s2">in </span><span class="s1">packages</span>

    <span class="s2">def </span><span class="s1">_assert_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">actual</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">set</span><span class="s3">(</span><span class="s1">actual</span><span class="s3">) == </span><span class="s1">set</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pep420_ns_package</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_namespace_packages</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">, </span><span class="s1">include</span><span class="s3">=[</span><span class="s4">'pkg*'</span><span class="s3">], </span><span class="s1">exclude</span><span class="s3">=[</span><span class="s4">'pkg.subpkg.assets'</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_assert_packages</span><span class="s3">(</span><span class="s1">packages</span><span class="s3">, [</span><span class="s4">'pkg'</span><span class="s3">, </span><span class="s4">'pkg.nspkg'</span><span class="s3">, </span><span class="s4">'pkg.subpkg'</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_pep420_ns_package_no_includes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_namespace_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">, </span><span class="s1">exclude</span><span class="s3">=[</span><span class="s4">'pkg.subpkg.assets'</span><span class="s3">])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_assert_packages</span><span class="s3">(</span><span class="s1">packages</span><span class="s3">, [</span><span class="s4">'docs'</span><span class="s3">, </span><span class="s4">'pkg'</span><span class="s3">, </span><span class="s4">'pkg.nspkg'</span><span class="s3">, </span><span class="s4">'pkg.subpkg'</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_pep420_ns_package_no_includes_or_excludes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_namespace_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= [</span><span class="s4">'docs'</span><span class="s3">, </span><span class="s4">'pkg'</span><span class="s3">, </span><span class="s4">'pkg.nspkg'</span><span class="s3">, </span><span class="s4">'pkg.subpkg'</span><span class="s3">, </span><span class="s4">'pkg.subpkg.assets'</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_assert_packages</span><span class="s3">(</span><span class="s1">packages</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_regular_package_with_nested_pep420_ns_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch</span><span class="s3">(</span><span class="s4">'__init__.py'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pkg_dir</span><span class="s3">)</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_namespace_packages</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">, </span><span class="s1">exclude</span><span class="s3">=[</span><span class="s4">'docs'</span><span class="s3">, </span><span class="s4">'pkg.subpkg.assets'</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_assert_packages</span><span class="s3">(</span><span class="s1">packages</span><span class="s3">, [</span><span class="s4">'pkg'</span><span class="s3">, </span><span class="s4">'pkg.nspkg'</span><span class="s3">, </span><span class="s4">'pkg.subpkg'</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_pep420_ns_package_no_non_package_dirs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">shutil</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">docs_dir</span><span class="s3">)</span>
        <span class="s1">shutil</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">, </span><span class="s4">'pkg/subpkg/assets'</span><span class="s3">))</span>
        <span class="s1">packages </span><span class="s3">= </span><span class="s1">find_namespace_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_assert_packages</span><span class="s3">(</span><span class="s1">packages</span><span class="s3">, [</span><span class="s4">'pkg'</span><span class="s3">, </span><span class="s4">'pkg.nspkg'</span><span class="s3">, </span><span class="s4">'pkg.subpkg'</span><span class="s3">])</span>


<span class="s2">class </span><span class="s1">TestFlatLayoutPackageFinder</span><span class="s3">:</span>
    <span class="s1">EXAMPLES </span><span class="s3">= {</span>
        <span class="s4">&quot;hidden-folders&quot;</span><span class="s3">: (</span>
            <span class="s3">[</span><span class="s4">&quot;.pkg/__init__.py&quot;</span><span class="s3">, </span><span class="s4">&quot;pkg/__init__.py&quot;</span><span class="s3">, </span><span class="s4">&quot;pkg/nested/file.txt&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">&quot;pkg&quot;</span><span class="s3">, </span><span class="s4">&quot;pkg.nested&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s4">&quot;private-packages&quot;</span><span class="s3">: (</span>
            <span class="s3">[</span><span class="s4">&quot;_pkg/__init__.py&quot;</span><span class="s3">, </span><span class="s4">&quot;pkg/_private/__init__.py&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">&quot;pkg&quot;</span><span class="s3">, </span><span class="s4">&quot;pkg._private&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s4">&quot;invalid-name&quot;</span><span class="s3">: (</span>
            <span class="s3">[</span><span class="s4">&quot;invalid-pkg/__init__.py&quot;</span><span class="s3">, </span><span class="s4">&quot;other.pkg/__init__.py&quot;</span><span class="s3">, </span><span class="s4">&quot;yet,another/file.py&quot;</span><span class="s3">],</span>
            <span class="s3">[],</span>
        <span class="s3">),</span>
        <span class="s4">&quot;docs&quot;</span><span class="s3">: ([</span><span class="s4">&quot;pkg/__init__.py&quot;</span><span class="s3">, </span><span class="s4">&quot;docs/conf.py&quot;</span><span class="s3">, </span><span class="s4">&quot;docs/readme.rst&quot;</span><span class="s3">], [</span><span class="s4">&quot;pkg&quot;</span><span class="s3">]),</span>
        <span class="s4">&quot;tests&quot;</span><span class="s3">: (</span>
            <span class="s3">[</span><span class="s4">&quot;pkg/__init__.py&quot;</span><span class="s3">, </span><span class="s4">&quot;tests/test_pkg.py&quot;</span><span class="s3">, </span><span class="s4">&quot;tests/__init__.py&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">&quot;pkg&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s4">&quot;examples&quot;</span><span class="s3">: (</span>
            <span class="s3">[</span>
                <span class="s4">&quot;pkg/__init__.py&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;examples/__init__.py&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;examples/file.py&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;example/other_file.py&quot;</span><span class="s3">,</span>
                <span class="s5"># Sub-packages should always be fine</span>
                <span class="s4">&quot;pkg/example/__init__.py&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;pkg/examples/__init__.py&quot;</span><span class="s3">,</span>
            <span class="s3">],</span>
            <span class="s3">[</span><span class="s4">&quot;pkg&quot;</span><span class="s3">, </span><span class="s4">&quot;pkg.examples&quot;</span><span class="s3">, </span><span class="s4">&quot;pkg.example&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s4">&quot;tool-specific&quot;</span><span class="s3">: (</span>
            <span class="s3">[</span>
                <span class="s4">&quot;htmlcov/index.html&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;pkg/__init__.py&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;tasks/__init__.py&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;tasks/subpackage/__init__.py&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;fabfile/__init__.py&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;fabfile/subpackage/__init__.py&quot;</span><span class="s3">,</span>
                <span class="s5"># Sub-packages should always be fine</span>
                <span class="s4">&quot;pkg/tasks/__init__.py&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;pkg/fabfile/__init__.py&quot;</span><span class="s3">,</span>
            <span class="s3">],</span>
            <span class="s3">[</span><span class="s4">&quot;pkg&quot;</span><span class="s3">, </span><span class="s4">&quot;pkg.tasks&quot;</span><span class="s3">, </span><span class="s4">&quot;pkg.fabfile&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
    <span class="s3">}</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;example&quot;</span><span class="s3">, </span><span class="s1">EXAMPLES</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())</span>
    <span class="s2">def </span><span class="s1">test_unwanted_directories_not_included</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">example</span><span class="s3">):</span>
        <span class="s1">files</span><span class="s3">, </span><span class="s1">expected_packages </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">EXAMPLES</span><span class="s3">[</span><span class="s1">example</span><span class="s3">]</span>
        <span class="s1">ensure_files</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">files</span><span class="s3">)</span>
        <span class="s1">found_packages </span><span class="s3">= </span><span class="s1">FlatLayoutPackageFinder</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">set</span><span class="s3">(</span><span class="s1">found_packages</span><span class="s3">) == </span><span class="s1">set</span><span class="s3">(</span><span class="s1">expected_packages</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">ensure_files</span><span class="s3">(</span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">files</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">file </span><span class="s2">in </span><span class="s1">files</span><span class="s3">:</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">root_path </span><span class="s3">/ </span><span class="s1">file</span>
        <span class="s1">path</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s1">parents</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">exist_ok</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">path</span><span class="s3">.</span><span class="s1">touch</span><span class="s3">()</span>
</pre>
</body>
</html>