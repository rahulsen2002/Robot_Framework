<html>
<head>
<title>_parser.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_parser.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Handwritten parser of dependency specifiers. 
 
The docstring for each __parse_* function contains EBNF-inspired grammar representing 
the implementation. 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">ast</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">NamedTuple</span><span class="s3">, </span><span class="s1">Sequence</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">, </span><span class="s1">Union</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">_tokenizer </span><span class="s2">import </span><span class="s1">DEFAULT_RULES</span><span class="s3">, </span><span class="s1">Tokenizer</span>


<span class="s2">class </span><span class="s1">Node</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">value</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">value </span><span class="s3">= </span><span class="s1">value</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">value</span>

    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s4">f&quot;&lt;</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">}</span><span class="s4">('</span><span class="s2">{</span><span class="s1">self</span><span class="s2">}</span><span class="s4">')&gt;&quot;</span>

    <span class="s2">def </span><span class="s1">serialize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>


<span class="s2">class </span><span class="s1">Variable</span><span class="s3">(</span><span class="s1">Node</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">serialize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">Value</span><span class="s3">(</span><span class="s1">Node</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">serialize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s4">f'&quot;</span><span class="s2">{</span><span class="s1">self</span><span class="s2">}</span><span class="s4">&quot;'</span>


<span class="s2">class </span><span class="s1">Op</span><span class="s3">(</span><span class="s1">Node</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">serialize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>


<span class="s1">MarkerVar </span><span class="s3">= </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">Variable</span><span class="s3">, </span><span class="s1">Value</span><span class="s3">]</span>
<span class="s1">MarkerItem </span><span class="s3">= </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">MarkerVar</span><span class="s3">, </span><span class="s1">Op</span><span class="s3">, </span><span class="s1">MarkerVar</span><span class="s3">]</span>
<span class="s1">MarkerAtom </span><span class="s3">= </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">MarkerItem</span><span class="s3">, </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s4">&quot;MarkerAtom&quot;</span><span class="s3">]]</span>
<span class="s1">MarkerList </span><span class="s3">= </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Union</span><span class="s3">[</span><span class="s4">&quot;MarkerList&quot;</span><span class="s3">, </span><span class="s1">MarkerAtom</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]</span>


<span class="s2">class </span><span class="s1">ParsedRequirement</span><span class="s3">(</span><span class="s1">NamedTuple</span><span class="s3">):</span>
    <span class="s1">name</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">url</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">extras</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]</span>
    <span class="s1">specifier</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">marker</span><span class="s3">: </span><span class="s1">MarkerList </span><span class="s3">| </span><span class="s2">None</span>


<span class="s5"># --------------------------------------------------------------------------------------</span>
<span class="s5"># Recursive descent parser for dependency specifier</span>
<span class="s5"># --------------------------------------------------------------------------------------</span>
<span class="s2">def </span><span class="s1">parse_requirement</span><span class="s3">(</span><span class="s1">source</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; ParsedRequirement</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s1">_parse_requirement</span><span class="s3">(</span><span class="s1">Tokenizer</span><span class="s3">(</span><span class="s1">source</span><span class="s3">, </span><span class="s1">rules</span><span class="s3">=</span><span class="s1">DEFAULT_RULES</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">_parse_requirement</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; ParsedRequirement</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    requirement = WS? IDENTIFIER WS? extras WS? requirement_details 
    &quot;&quot;&quot;</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

    <span class="s1">name_token </span><span class="s3">= </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">expect</span><span class="s3">(</span>
        <span class="s4">&quot;IDENTIFIER&quot;</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s4">&quot;package name at the start of dependency specifier&quot;</span>
    <span class="s3">)</span>
    <span class="s1">name </span><span class="s3">= </span><span class="s1">name_token</span><span class="s3">.</span><span class="s1">text</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

    <span class="s1">extras </span><span class="s3">= </span><span class="s1">_parse_extras</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

    <span class="s1">url</span><span class="s3">, </span><span class="s1">specifier</span><span class="s3">, </span><span class="s1">marker </span><span class="s3">= </span><span class="s1">_parse_requirement_details</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">expect</span><span class="s3">(</span><span class="s4">&quot;END&quot;</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s4">&quot;end of dependency specifier&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">ParsedRequirement</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">extras</span><span class="s3">, </span><span class="s1">specifier</span><span class="s3">, </span><span class="s1">marker</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_parse_requirement_details</span><span class="s3">(</span>
    <span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">, </span><span class="s1">MarkerList </span><span class="s3">| </span><span class="s2">None</span><span class="s3">]:</span>
    <span class="s0">&quot;&quot;&quot; 
    requirement_details = AT URL (WS requirement_marker?)? 
                        | specifier WS? (requirement_marker)? 
    &quot;&quot;&quot;</span>

    <span class="s1">specifier </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>
    <span class="s1">url </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>
    <span class="s1">marker </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;AT&quot;</span><span class="s3">):</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

        <span class="s1">url_start </span><span class="s3">= </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">position</span>
        <span class="s1">url </span><span class="s3">= </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">expect</span><span class="s3">(</span><span class="s4">&quot;URL&quot;</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s4">&quot;URL after @&quot;</span><span class="s3">).</span><span class="s1">text</span>
        <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;END&quot;</span><span class="s3">, </span><span class="s1">peek</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">specifier</span><span class="s3">, </span><span class="s1">marker</span><span class="s3">)</span>

        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">expect</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s4">&quot;whitespace after URL&quot;</span><span class="s3">)</span>

        <span class="s5"># The input might end after whitespace.</span>
        <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;END&quot;</span><span class="s3">, </span><span class="s1">peek</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">specifier</span><span class="s3">, </span><span class="s1">marker</span><span class="s3">)</span>

        <span class="s1">marker </span><span class="s3">= </span><span class="s1">_parse_requirement_marker</span><span class="s3">(</span>
            <span class="s1">tokenizer</span><span class="s3">, </span><span class="s1">span_start</span><span class="s3">=</span><span class="s1">url_start</span><span class="s3">, </span><span class="s1">after</span><span class="s3">=</span><span class="s4">&quot;URL and whitespace&quot;</span>
        <span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">specifier_start </span><span class="s3">= </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">position</span>
        <span class="s1">specifier </span><span class="s3">= </span><span class="s1">_parse_specifier</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;END&quot;</span><span class="s3">, </span><span class="s1">peek</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">specifier</span><span class="s3">, </span><span class="s1">marker</span><span class="s3">)</span>

        <span class="s1">marker </span><span class="s3">= </span><span class="s1">_parse_requirement_marker</span><span class="s3">(</span>
            <span class="s1">tokenizer</span><span class="s3">,</span>
            <span class="s1">span_start</span><span class="s3">=</span><span class="s1">specifier_start</span><span class="s3">,</span>
            <span class="s1">after</span><span class="s3">=(</span>
                <span class="s4">&quot;version specifier&quot;</span>
                <span class="s2">if </span><span class="s1">specifier</span>
                <span class="s2">else </span><span class="s4">&quot;name and no valid version specifier&quot;</span>
            <span class="s3">),</span>
        <span class="s3">)</span>

    <span class="s2">return </span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">specifier</span><span class="s3">, </span><span class="s1">marker</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_parse_requirement_marker</span><span class="s3">(</span>
    <span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">, *, </span><span class="s1">span_start</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">after</span><span class="s3">: </span><span class="s1">str</span>
<span class="s3">) </span><span class="s1">-&gt; MarkerList</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    requirement_marker = SEMICOLON marker WS? 
    &quot;&quot;&quot;</span>

    <span class="s2">if not </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;SEMICOLON&quot;</span><span class="s3">):</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">raise_syntax_error</span><span class="s3">(</span>
            <span class="s4">f&quot;Expected end or semicolon (after </span><span class="s2">{</span><span class="s1">after</span><span class="s2">}</span><span class="s4">)&quot;</span><span class="s3">,</span>
            <span class="s1">span_start</span><span class="s3">=</span><span class="s1">span_start</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

    <span class="s1">marker </span><span class="s3">= </span><span class="s1">_parse_marker</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">marker</span>


<span class="s2">def </span><span class="s1">_parse_extras</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; list</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s0">&quot;&quot;&quot; 
    extras = (LEFT_BRACKET wsp* extras_list? wsp* RIGHT_BRACKET)? 
    &quot;&quot;&quot;</span>
    <span class="s2">if not </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;LEFT_BRACKET&quot;</span><span class="s3">, </span><span class="s1">peek</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">[]</span>

    <span class="s2">with </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">enclosing_tokens</span><span class="s3">(</span>
        <span class="s4">&quot;LEFT_BRACKET&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;RIGHT_BRACKET&quot;</span><span class="s3">,</span>
        <span class="s1">around</span><span class="s3">=</span><span class="s4">&quot;extras&quot;</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
        <span class="s1">extras </span><span class="s3">= </span><span class="s1">_parse_extras_list</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">extras</span>


<span class="s2">def </span><span class="s1">_parse_extras_list</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; list</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s0">&quot;&quot;&quot; 
    extras_list = identifier (wsp* ',' wsp* identifier)* 
    &quot;&quot;&quot;</span>
    <span class="s1">extras</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = []</span>

    <span class="s2">if not </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;IDENTIFIER&quot;</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">extras</span>

    <span class="s1">extras</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">text</span><span class="s3">)</span>

    <span class="s2">while True</span><span class="s3">:</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;IDENTIFIER&quot;</span><span class="s3">, </span><span class="s1">peek</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">raise_syntax_error</span><span class="s3">(</span><span class="s4">&quot;Expected comma between extra names&quot;</span><span class="s3">)</span>
        <span class="s2">elif not </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;COMMA&quot;</span><span class="s3">):</span>
            <span class="s2">break</span>

        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

        <span class="s1">extra_token </span><span class="s3">= </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">expect</span><span class="s3">(</span><span class="s4">&quot;IDENTIFIER&quot;</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s4">&quot;extra name after comma&quot;</span><span class="s3">)</span>
        <span class="s1">extras</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">extra_token</span><span class="s3">.</span><span class="s1">text</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">extras</span>


<span class="s2">def </span><span class="s1">_parse_specifier</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    specifier = LEFT_PARENTHESIS WS? version_many WS? RIGHT_PARENTHESIS 
              | WS? version_many WS? 
    &quot;&quot;&quot;</span>
    <span class="s2">with </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">enclosing_tokens</span><span class="s3">(</span>
        <span class="s4">&quot;LEFT_PARENTHESIS&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;RIGHT_PARENTHESIS&quot;</span><span class="s3">,</span>
        <span class="s1">around</span><span class="s3">=</span><span class="s4">&quot;version specifier&quot;</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
        <span class="s1">parsed_specifiers </span><span class="s3">= </span><span class="s1">_parse_version_many</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">parsed_specifiers</span>


<span class="s2">def </span><span class="s1">_parse_version_many</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    version_many = (SPECIFIER (WS? COMMA WS? SPECIFIER)*)? 
    &quot;&quot;&quot;</span>
    <span class="s1">parsed_specifiers </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>
    <span class="s2">while </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;SPECIFIER&quot;</span><span class="s3">):</span>
        <span class="s1">span_start </span><span class="s3">= </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">position</span>
        <span class="s1">parsed_specifiers </span><span class="s3">+= </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">text</span>
        <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;VERSION_PREFIX_TRAIL&quot;</span><span class="s3">, </span><span class="s1">peek</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">raise_syntax_error</span><span class="s3">(</span>
                <span class="s4">&quot;.* suffix can only be used with `==` or `!=` operators&quot;</span><span class="s3">,</span>
                <span class="s1">span_start</span><span class="s3">=</span><span class="s1">span_start</span><span class="s3">,</span>
                <span class="s1">span_end</span><span class="s3">=</span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">position </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;VERSION_LOCAL_LABEL_TRAIL&quot;</span><span class="s3">, </span><span class="s1">peek</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">raise_syntax_error</span><span class="s3">(</span>
                <span class="s4">&quot;Local version label can only be used with `==` or `!=` operators&quot;</span><span class="s3">,</span>
                <span class="s1">span_start</span><span class="s3">=</span><span class="s1">span_start</span><span class="s3">,</span>
                <span class="s1">span_end</span><span class="s3">=</span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">position</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;COMMA&quot;</span><span class="s3">):</span>
            <span class="s2">break</span>
        <span class="s1">parsed_specifiers </span><span class="s3">+= </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">text</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">parsed_specifiers</span>


<span class="s5"># --------------------------------------------------------------------------------------</span>
<span class="s5"># Recursive descent parser for marker expression</span>
<span class="s5"># --------------------------------------------------------------------------------------</span>
<span class="s2">def </span><span class="s1">parse_marker</span><span class="s3">(</span><span class="s1">source</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; MarkerList</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s1">_parse_full_marker</span><span class="s3">(</span><span class="s1">Tokenizer</span><span class="s3">(</span><span class="s1">source</span><span class="s3">, </span><span class="s1">rules</span><span class="s3">=</span><span class="s1">DEFAULT_RULES</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">_parse_full_marker</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; MarkerList</span><span class="s3">:</span>
    <span class="s1">retval </span><span class="s3">= </span><span class="s1">_parse_marker</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">expect</span><span class="s3">(</span><span class="s4">&quot;END&quot;</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s4">&quot;end of marker expression&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">retval</span>


<span class="s2">def </span><span class="s1">_parse_marker</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; MarkerList</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    marker = marker_atom (BOOLOP marker_atom)+ 
    &quot;&quot;&quot;</span>
    <span class="s1">expression </span><span class="s3">= [</span><span class="s1">_parse_marker_atom</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)]</span>
    <span class="s2">while </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;BOOLOP&quot;</span><span class="s3">):</span>
        <span class="s1">token </span><span class="s3">= </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s1">expr_right </span><span class="s3">= </span><span class="s1">_parse_marker_atom</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
        <span class="s1">expression</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">((</span><span class="s1">token</span><span class="s3">.</span><span class="s1">text</span><span class="s3">, </span><span class="s1">expr_right</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">expression</span>


<span class="s2">def </span><span class="s1">_parse_marker_atom</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; MarkerAtom</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    marker_atom = WS? LEFT_PARENTHESIS WS? marker WS? RIGHT_PARENTHESIS WS? 
                | WS? marker_item WS? 
    &quot;&quot;&quot;</span>

    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;LEFT_PARENTHESIS&quot;</span><span class="s3">, </span><span class="s1">peek</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">enclosing_tokens</span><span class="s3">(</span>
            <span class="s4">&quot;LEFT_PARENTHESIS&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;RIGHT_PARENTHESIS&quot;</span><span class="s3">,</span>
            <span class="s1">around</span><span class="s3">=</span><span class="s4">&quot;marker expression&quot;</span><span class="s3">,</span>
        <span class="s3">):</span>
            <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
            <span class="s1">marker</span><span class="s3">: </span><span class="s1">MarkerAtom </span><span class="s3">= </span><span class="s1">_parse_marker</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
            <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">marker </span><span class="s3">= </span><span class="s1">_parse_marker_item</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">marker</span>


<span class="s2">def </span><span class="s1">_parse_marker_item</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; MarkerItem</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    marker_item = WS? marker_var WS? marker_op WS? marker_var WS? 
    &quot;&quot;&quot;</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
    <span class="s1">marker_var_left </span><span class="s3">= </span><span class="s1">_parse_marker_var</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
    <span class="s1">marker_op </span><span class="s3">= </span><span class="s1">_parse_marker_op</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
    <span class="s1">marker_var_right </span><span class="s3">= </span><span class="s1">_parse_marker_var</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">)</span>
    <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">consume</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s1">marker_var_left</span><span class="s3">, </span><span class="s1">marker_op</span><span class="s3">, </span><span class="s1">marker_var_right</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_parse_marker_var</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; MarkerVar</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    marker_var = VARIABLE | QUOTED_STRING 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;VARIABLE&quot;</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">process_env_var</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">text</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;.&quot;</span><span class="s3">, </span><span class="s4">&quot;_&quot;</span><span class="s3">))</span>
    <span class="s2">elif </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;QUOTED_STRING&quot;</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">process_python_str</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">text</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">raise_syntax_error</span><span class="s3">(</span>
            <span class="s1">message</span><span class="s3">=</span><span class="s4">&quot;Expected a marker variable or quoted string&quot;</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">process_env_var</span><span class="s3">(</span><span class="s1">env_var</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; Variable</span><span class="s3">:</span>
    <span class="s2">if </span><span class="s1">env_var </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;platform_python_implementation&quot;</span><span class="s3">, </span><span class="s4">&quot;python_implementation&quot;</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">Variable</span><span class="s3">(</span><span class="s4">&quot;platform_python_implementation&quot;</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">Variable</span><span class="s3">(</span><span class="s1">env_var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">process_python_str</span><span class="s3">(</span><span class="s1">python_str</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; Value</span><span class="s3">:</span>
    <span class="s1">value </span><span class="s3">= </span><span class="s1">ast</span><span class="s3">.</span><span class="s1">literal_eval</span><span class="s3">(</span><span class="s1">python_str</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">Value</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">value</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">_parse_marker_op</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">: </span><span class="s1">Tokenizer</span><span class="s3">) </span><span class="s1">-&gt; Op</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    marker_op = IN | NOT IN | OP 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;IN&quot;</span><span class="s3">):</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">Op</span><span class="s3">(</span><span class="s4">&quot;in&quot;</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;NOT&quot;</span><span class="s3">):</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">expect</span><span class="s3">(</span><span class="s4">&quot;WS&quot;</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s4">&quot;whitespace after 'not'&quot;</span><span class="s3">)</span>
        <span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">expect</span><span class="s3">(</span><span class="s4">&quot;IN&quot;</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s4">&quot;'in' after 'not'&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">Op</span><span class="s3">(</span><span class="s4">&quot;not in&quot;</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s4">&quot;OP&quot;</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">Op</span><span class="s3">(</span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">text</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">tokenizer</span><span class="s3">.</span><span class="s1">raise_syntax_error</span><span class="s3">(</span>
            <span class="s4">&quot;Expected marker operator, one of &quot;</span>
            <span class="s4">&quot;&lt;=, &lt;, !=, ==, &gt;=, &gt;, ~=, ===, in, not in&quot;</span>
        <span class="s3">)</span>
</pre>
</body>
</html>