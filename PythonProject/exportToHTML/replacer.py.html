<html>
<head>
<title>replacer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
.s7 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
replacer.py</font>
</center></td></tr></table>
<pre><span class="s0">#  Copyright 2008-2015 Nokia Networks</span>
<span class="s0">#  Copyright 2016-     Robot Framework Foundation</span>
<span class="s0">#</span>
<span class="s0">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0">#  you may not use this file except in compliance with the License.</span>
<span class="s0">#  You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="s0">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0">#  See the License for the specific language governing permissions and</span>
<span class="s0">#  limitations under the License.</span>

<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">DataError</span><span class="s3">, </span><span class="s1">VariableError</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">output </span><span class="s2">import </span><span class="s1">librarylogger </span><span class="s2">as </span><span class="s1">logger</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">DotDict</span><span class="s3">, </span><span class="s1">escape</span><span class="s3">, </span><span class="s1">get_error_message</span><span class="s3">, </span><span class="s1">is_dict_like</span><span class="s3">, </span><span class="s1">is_list_like</span><span class="s3">, </span><span class="s1">safe_str</span><span class="s3">, </span><span class="s1">type_name</span><span class="s3">,</span>
    <span class="s1">unescape</span>
<span class="s3">)</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">finders </span><span class="s2">import </span><span class="s1">VariableFinder</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">search </span><span class="s2">import </span><span class="s1">search_variable</span><span class="s3">, </span><span class="s1">VariableMatch</span>


<span class="s2">class </span><span class="s1">VariableReplacer</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">variables</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_finder </span><span class="s3">= </span><span class="s1">VariableFinder</span><span class="s3">(</span><span class="s1">variables</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">replace_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">items</span><span class="s3">, </span><span class="s1">replace_until</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Replaces variables from a list of items. 
 
        If an item in a list is a @{list} variable its value is returned. 
        Possible variables from other items are replaced using 'replace_scalar'. 
        Result is always a list. 
 
        'replace_until' can be used to limit replacing arguments to certain 
        index from the beginning. Used with Run Keyword variants that only 
        want to resolve some arguments in the beginning and pass others 
        to called keywords unmodified. 
        &quot;&quot;&quot;</span>
        <span class="s1">items </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">items </span><span class="s2">or </span><span class="s3">[])</span>
        <span class="s2">if </span><span class="s1">replace_until </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_replace_list_until</span><span class="s3">(</span><span class="s1">items</span><span class="s3">, </span><span class="s1">replace_until</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_replace_list</span><span class="s3">(</span><span class="s1">items</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_replace_list_until</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">items</span><span class="s3">, </span><span class="s1">limit</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">):</span>
        <span class="s0"># @{list} variables can contain more or less arguments than needed.</span>
        <span class="s0"># Therefore, we need to go through items one by one, and escape</span>
        <span class="s0"># possible extra items we got.</span>
        <span class="s1">replaced </span><span class="s3">= []</span>
        <span class="s2">while </span><span class="s1">len</span><span class="s3">(</span><span class="s1">replaced</span><span class="s3">) &lt; </span><span class="s1">limit </span><span class="s2">and </span><span class="s1">items</span><span class="s3">:</span>
            <span class="s1">replaced</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_replace_list</span><span class="s3">([</span><span class="s1">items</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)], </span><span class="s1">ignore_errors</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">replaced</span><span class="s3">) &gt; </span><span class="s1">limit</span><span class="s3">:</span>
            <span class="s1">replaced</span><span class="s3">[</span><span class="s1">limit</span><span class="s3">:] = [</span><span class="s1">escape</span><span class="s3">(</span><span class="s1">item</span><span class="s3">) </span><span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">replaced</span><span class="s3">[</span><span class="s1">limit</span><span class="s3">:]]</span>
        <span class="s2">return </span><span class="s1">replaced </span><span class="s3">+ </span><span class="s1">items</span>

    <span class="s2">def </span><span class="s1">_replace_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">items</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">):</span>
        <span class="s1">result </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">items</span><span class="s3">:</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s1">search_variable</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">=</span><span class="s1">ignore_errors</span><span class="s3">)</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_replace</span><span class="s3">(</span><span class="s1">match</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">is_list_variable</span><span class="s3">() </span><span class="s2">and </span><span class="s1">is_list_like</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
                <span class="s1">result</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">result</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">replace_scalar</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Replaces variables from a scalar item. 
 
        If the item is not a string it is returned as is. If it is a variable, 
        its value is returned. Otherwise, possible variables are replaced with 
        'replace_string'. Result may be any object. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">VariableMatch</span><span class="s3">):</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s1">item</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s1">search_variable</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">=</span><span class="s1">ignore_errors</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_replace</span><span class="s3">(</span><span class="s1">match</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">replace_string</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s1">custom_unescaper</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Replaces variables from a string. Result is always a string. 
 
        Input can also be an already found VariableMatch. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">VariableMatch</span><span class="s3">):</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s1">item</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s1">search_variable</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">=</span><span class="s1">ignore_errors</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_replace</span><span class="s3">(</span><span class="s1">match</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">, </span><span class="s1">custom_unescaper </span><span class="s2">or </span><span class="s1">unescape</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">safe_str</span><span class="s3">(</span><span class="s1">result</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_replace</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">match</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">, </span><span class="s1">unescaper</span><span class="s3">=</span><span class="s1">unescape</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">match</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">unescaper</span><span class="s3">(</span><span class="s1">match</span><span class="s3">.</span><span class="s1">string</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">is_variable</span><span class="s3">():</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_variable_value</span><span class="s3">(</span><span class="s1">match</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">)</span>
        <span class="s1">parts </span><span class="s3">= []</span>
        <span class="s2">while </span><span class="s1">match</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">before</span><span class="s3">:</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">unescaper</span><span class="s3">(</span><span class="s1">match</span><span class="s3">.</span><span class="s1">before</span><span class="s3">))</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_variable_value</span><span class="s3">(</span><span class="s1">match</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">))</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s1">search_variable</span><span class="s3">(</span><span class="s1">match</span><span class="s3">.</span><span class="s1">after</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">=</span><span class="s1">ignore_errors</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">string</span><span class="s3">:</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">unescaper</span><span class="s3">(</span><span class="s1">match</span><span class="s3">.</span><span class="s1">string</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">all</span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, (</span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">bytearray</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">parts</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s6">b&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s7">&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">safe_str</span><span class="s3">(</span><span class="s1">p</span><span class="s3">) </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">parts</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_variable_value</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">match</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">):</span>
        <span class="s1">match</span><span class="s3">.</span><span class="s1">resolve_base</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">)</span>
        <span class="s0"># TODO: Do we anymore need to reserve `*{var}` syntax for anything?</span>
        <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">identifier </span><span class="s3">== </span><span class="s7">&quot;*&quot;</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                <span class="s7">rf&quot;Syntax '</span><span class="s2">{</span><span class="s1">match</span><span class="s2">}</span><span class="s7">' is reserved for future use. &quot;</span>
                <span class="s7">rf&quot;Please escape it like '\</span><span class="s2">{</span><span class="s1">match</span><span class="s2">}</span><span class="s7">'.&quot;</span>
            <span class="s3">)</span>
            <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">match</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_finder</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s1">match</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">items</span><span class="s3">:</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_variable_item</span><span class="s3">(</span><span class="s1">match</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_validate_value</span><span class="s3">(</span><span class="s1">match</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">VariableError</span><span class="s3">:</span>
                <span class="s2">raise</span>
            <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
                <span class="s1">error </span><span class="s3">= </span><span class="s1">get_error_message</span><span class="s3">()</span>
                <span class="s2">raise </span><span class="s1">VariableError</span><span class="s3">(</span><span class="s7">f&quot;Resolving variable '</span><span class="s2">{</span><span class="s1">match</span><span class="s2">}</span><span class="s7">' failed: </span><span class="s2">{</span><span class="s1">error</span><span class="s2">}</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">DataError</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ignore_errors</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">unescape</span><span class="s3">(</span><span class="s1">match</span><span class="s3">.</span><span class="s1">match</span><span class="s3">)</span>
            <span class="s2">raise</span>

    <span class="s2">def </span><span class="s1">_get_variable_item</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">match</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">match</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">match</span><span class="s3">.</span><span class="s1">items</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">is_dict_like</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_dict_variable_item</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s7">&quot;__getitem__&quot;</span><span class="s3">):</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sequence_variable_item</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">VariableError</span><span class="s3">(</span>
                    <span class="s7">f&quot;Variable '</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s7">' is </span><span class="s2">{</span><span class="s1">type_name</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span><span class="s2">}</span><span class="s7">, which is not &quot;</span>
                    <span class="s7">f&quot;subscriptable, and thus accessing item '</span><span class="s2">{</span><span class="s1">item</span><span class="s2">}</span><span class="s7">' from it &quot;</span>
                    <span class="s7">f&quot;is not possible. To use '[</span><span class="s2">{</span><span class="s1">item</span><span class="s2">}</span><span class="s7">]' as a literal value, &quot;</span>
                    <span class="s7">f&quot;it needs to be escaped like '</span><span class="s2">\\</span><span class="s7">[</span><span class="s2">{</span><span class="s1">item</span><span class="s2">}</span><span class="s7">]'.&quot;</span>
                <span class="s3">)</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s7">f&quot;</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s7">[</span><span class="s2">{</span><span class="s1">item</span><span class="s2">}</span><span class="s7">]&quot;</span>
        <span class="s2">return </span><span class="s1">value</span>

    <span class="s2">def </span><span class="s1">_get_sequence_variable_item</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">variable</span><span class="s3">, </span><span class="s1">index</span><span class="s3">):</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">replace_scalar</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">index </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parse_sequence_variable_index</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">variable</span><span class="s3">[</span><span class="s1">index</span><span class="s3">]</span>
            <span class="s2">except </span><span class="s1">TypeError</span><span class="s3">:</span>
                <span class="s1">var_type </span><span class="s3">= </span><span class="s1">type_name</span><span class="s3">(</span><span class="s1">variable</span><span class="s3">, </span><span class="s1">capitalize</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s2">raise </span><span class="s1">VariableError</span><span class="s3">(</span>
                    <span class="s7">f&quot;</span><span class="s2">{</span><span class="s1">var_type</span><span class="s2">} </span><span class="s7">'</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s7">' used with invalid index '</span><span class="s2">{</span><span class="s1">index</span><span class="s2">}</span><span class="s7">'. &quot;</span>
                    <span class="s7">f&quot;To use '[</span><span class="s2">{</span><span class="s1">index</span><span class="s2">}</span><span class="s7">]' as a literal value, it needs to be &quot;</span>
                    <span class="s7">f&quot;escaped like '</span><span class="s2">\\</span><span class="s7">[</span><span class="s2">{</span><span class="s1">index</span><span class="s2">}</span><span class="s7">]'.&quot;</span>
                <span class="s3">)</span>
            <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
                <span class="s1">error </span><span class="s3">= </span><span class="s1">get_error_message</span><span class="s3">()</span>
                <span class="s2">raise </span><span class="s1">VariableError</span><span class="s3">(</span><span class="s7">f&quot;Accessing '</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s7">[</span><span class="s2">{</span><span class="s1">index</span><span class="s2">}</span><span class="s7">]' failed: </span><span class="s2">{</span><span class="s1">error</span><span class="s2">}</span><span class="s7">&quot;</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">variable</span><span class="s3">[</span><span class="s1">index</span><span class="s3">]</span>
        <span class="s2">except </span><span class="s1">IndexError</span><span class="s3">:</span>
            <span class="s1">var_type </span><span class="s3">= </span><span class="s1">type_name</span><span class="s3">(</span><span class="s1">variable</span><span class="s3">, </span><span class="s1">capitalize</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">raise </span><span class="s1">VariableError</span><span class="s3">(</span><span class="s7">f&quot;</span><span class="s2">{</span><span class="s1">var_type</span><span class="s2">} </span><span class="s7">'</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s7">' has no item in index </span><span class="s2">{</span><span class="s1">index</span><span class="s2">}</span><span class="s7">.&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_parse_sequence_variable_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">index</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">index</span><span class="s3">, (</span><span class="s1">int</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">)):</span>
            <span class="s2">return </span><span class="s1">index</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">index</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">ValueError</span>
        <span class="s2">if </span><span class="s7">&quot;:&quot; </span><span class="s2">not in </span><span class="s1">index</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">int</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">index</span><span class="s3">.</span><span class="s1">count</span><span class="s3">(</span><span class="s7">&quot;:&quot;</span><span class="s3">) &gt; </span><span class="s5">2</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span>
        <span class="s2">return </span><span class="s1">slice</span><span class="s3">(*[</span><span class="s1">int</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) </span><span class="s2">if </span><span class="s1">i </span><span class="s2">else None for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">index</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s7">&quot;:&quot;</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">_get_dict_variable_item</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">variable</span><span class="s3">, </span><span class="s1">key</span><span class="s3">):</span>
        <span class="s1">key </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">replace_scalar</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">variable</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>
        <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">VariableError</span><span class="s3">(</span><span class="s7">f&quot;Dictionary '</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s7">' has no key '</span><span class="s2">{</span><span class="s1">key</span><span class="s2">}</span><span class="s7">'.&quot;</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">TypeError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">VariableError</span><span class="s3">(</span><span class="s7">f&quot;Dictionary '</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s7">' used with invalid key: </span><span class="s2">{</span><span class="s1">err</span><span class="s2">}</span><span class="s7">&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_validate_value</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">match</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">identifier </span><span class="s3">== </span><span class="s7">&quot;@&quot;</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">is_list_like</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">VariableError</span><span class="s3">(</span>
                    <span class="s7">f&quot;Value of variable '</span><span class="s2">{</span><span class="s1">match</span><span class="s2">}</span><span class="s7">' is not list or list-like.&quot;</span>
                <span class="s3">)</span>
            <span class="s2">return </span><span class="s1">list</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">identifier </span><span class="s3">== </span><span class="s7">&quot;&amp;&quot;</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">is_dict_like</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">VariableError</span><span class="s3">(</span>
                    <span class="s7">f&quot;Value of variable '</span><span class="s2">{</span><span class="s1">match</span><span class="s2">}</span><span class="s7">' is not dictionary or dictionary-like.&quot;</span>
                <span class="s3">)</span>
            <span class="s2">return </span><span class="s1">DotDict</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">value</span>
</pre>
</body>
</html>