<html>
<head>
<title>test_http.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_http.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s0">#</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span>
<span class="s2">import </span><span class="s1">socket</span>
<span class="s2">import </span><span class="s1">ssl</span>
<span class="s2">import </span><span class="s1">unittest</span>

<span class="s2">import </span><span class="s1">websocket</span>
<span class="s2">from </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_exceptions </span><span class="s2">import </span><span class="s1">WebSocketProxyException</span><span class="s3">, </span><span class="s1">WebSocketException</span>
<span class="s2">from </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_http </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">_get_addrinfo_list</span><span class="s3">,</span>
    <span class="s1">_start_proxied_socket</span><span class="s3">,</span>
    <span class="s1">_tunnel</span><span class="s3">,</span>
    <span class="s1">connect</span><span class="s3">,</span>
    <span class="s1">proxy_info</span><span class="s3">,</span>
    <span class="s1">read_headers</span><span class="s3">,</span>
    <span class="s1">HAVE_PYTHON_SOCKS</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s4">&quot;&quot;&quot; 
test_http.py 
websocket - WebSocket client library for Python 
 
Copyright 2024 engn33r 
 
Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); 
you may not use this file except in compliance with the License. 
You may obtain a copy of the License at 
 
    http://www.apache.org/licenses/LICENSE-2.0 
 
Unless required by applicable law or agreed to in writing, software 
distributed under the License is distributed on an &quot;AS IS&quot; BASIS, 
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
See the License for the specific language governing permissions and 
limitations under the License. 
&quot;&quot;&quot;</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">python_socks</span><span class="s3">.</span><span class="s1">_errors </span><span class="s2">import </span><span class="s1">ProxyConnectionError</span><span class="s3">, </span><span class="s1">ProxyError</span><span class="s3">, </span><span class="s1">ProxyTimeoutError</span>
<span class="s2">except</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_http </span><span class="s2">import </span><span class="s1">ProxyConnectionError</span><span class="s3">, </span><span class="s1">ProxyError</span><span class="s3">, </span><span class="s1">ProxyTimeoutError</span>

<span class="s0"># Skip test to access the internet unless TEST_WITH_INTERNET == 1</span>
<span class="s1">TEST_WITH_INTERNET </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;TEST_WITH_INTERNET&quot;</span><span class="s3">, </span><span class="s4">&quot;0&quot;</span><span class="s3">) == </span><span class="s4">&quot;1&quot;</span>
<span class="s1">TEST_WITH_PROXY </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;TEST_WITH_PROXY&quot;</span><span class="s3">, </span><span class="s4">&quot;0&quot;</span><span class="s3">) == </span><span class="s4">&quot;1&quot;</span>
<span class="s0"># Skip tests relying on local websockets server unless LOCAL_WS_SERVER_PORT != -1</span>
<span class="s1">LOCAL_WS_SERVER_PORT </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;LOCAL_WS_SERVER_PORT&quot;</span><span class="s3">, </span><span class="s4">&quot;-1&quot;</span><span class="s3">)</span>
<span class="s1">TEST_WITH_LOCAL_SERVER </span><span class="s3">= </span><span class="s1">LOCAL_WS_SERVER_PORT </span><span class="s3">!= </span><span class="s4">&quot;-1&quot;</span>


<span class="s2">class </span><span class="s1">SockMock</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">data </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sent </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">add_packet</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">gettimeout</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">recv</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">bufsize</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">:</span>
            <span class="s1">e </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">Exception</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">e</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) &gt; </span><span class="s1">bufsize</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">e</span><span class="s3">[</span><span class="s1">bufsize</span><span class="s3">:])</span>
            <span class="s2">return </span><span class="s1">e</span><span class="s3">[:</span><span class="s1">bufsize</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">send</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sent</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">pass</span>


<span class="s2">class </span><span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s1">SockMock</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fname</span><span class="s3">):</span>
        <span class="s1">SockMock</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">__file__</span><span class="s3">), </span><span class="s1">fname</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">add_packet</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>


<span class="s2">class </span><span class="s1">OptsList</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">timeout </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sockopt </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sslopt </span><span class="s3">= {</span><span class="s4">&quot;cert_reqs&quot;</span><span class="s3">: </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">CERT_NONE</span><span class="s3">}</span>


<span class="s2">class </span><span class="s1">HttpTest</span><span class="s3">(</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">TestCase</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">test_read_header</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">status</span><span class="s3">, </span><span class="s1">header</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">read_headers</span><span class="s3">(</span><span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s4">&quot;data/header01.txt&quot;</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">status</span><span class="s3">, </span><span class="s5">101</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">header</span><span class="s3">[</span><span class="s4">&quot;connection&quot;</span><span class="s3">], </span><span class="s4">&quot;Upgrade&quot;</span><span class="s3">)</span>
        <span class="s0"># header02.txt is intentionally malformed</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">WebSocketException</span><span class="s3">, </span><span class="s1">read_headers</span><span class="s3">, </span><span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s4">&quot;data/header02.txt&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_tunnel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">WebSocketProxyException</span><span class="s3">,</span>
            <span class="s1">_tunnel</span><span class="s3">,</span>
            <span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s4">&quot;data/header01.txt&quot;</span><span class="s3">),</span>
            <span class="s4">&quot;example.com&quot;</span><span class="s3">,</span>
            <span class="s5">80</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s4">&quot;username&quot;</span><span class="s3">, </span><span class="s4">&quot;password&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">WebSocketProxyException</span><span class="s3">,</span>
            <span class="s1">_tunnel</span><span class="s3">,</span>
            <span class="s1">HeaderSockMock</span><span class="s3">(</span><span class="s4">&quot;data/header02.txt&quot;</span><span class="s3">),</span>
            <span class="s4">&quot;example.com&quot;</span><span class="s3">,</span>
            <span class="s5">80</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s4">&quot;username&quot;</span><span class="s3">, </span><span class="s4">&quot;password&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span><span class="s1">TEST_WITH_INTERNET</span><span class="s3">, </span><span class="s4">&quot;Internet-requiring tests are disabled&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_connect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Not currently testing an actual proxy connection, so just check whether proxy errors are raised. This requires internet for a DNS lookup</span>
        <span class="s2">if </span><span class="s1">HAVE_PYTHON_SOCKS</span><span class="s3">:</span>
            <span class="s0"># Need this check, otherwise case where python_socks is not installed triggers</span>
            <span class="s0"># websocket._exceptions.WebSocketException: Python Socks is needed for SOCKS proxying but is not available</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">ProxyTimeoutError</span><span class="s3">, </span><span class="s1">OSError</span><span class="s3">),</span>
                <span class="s1">_start_proxied_socket</span><span class="s3">,</span>
                <span class="s4">&quot;wss://example.com&quot;</span><span class="s3">,</span>
                <span class="s1">OptsList</span><span class="s3">(),</span>
                <span class="s1">proxy_info</span><span class="s3">(</span>
                    <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;example.com&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">,</span>
                    <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;socks4&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_timeout</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">ProxyTimeoutError</span><span class="s3">, </span><span class="s1">OSError</span><span class="s3">),</span>
                <span class="s1">_start_proxied_socket</span><span class="s3">,</span>
                <span class="s4">&quot;wss://example.com&quot;</span><span class="s3">,</span>
                <span class="s1">OptsList</span><span class="s3">(),</span>
                <span class="s1">proxy_info</span><span class="s3">(</span>
                    <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;example.com&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">,</span>
                    <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;socks4a&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_timeout</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">ProxyTimeoutError</span><span class="s3">, </span><span class="s1">OSError</span><span class="s3">),</span>
                <span class="s1">_start_proxied_socket</span><span class="s3">,</span>
                <span class="s4">&quot;wss://example.com&quot;</span><span class="s3">,</span>
                <span class="s1">OptsList</span><span class="s3">(),</span>
                <span class="s1">proxy_info</span><span class="s3">(</span>
                    <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;example.com&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">,</span>
                    <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;socks5&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_timeout</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">ProxyTimeoutError</span><span class="s3">, </span><span class="s1">OSError</span><span class="s3">),</span>
                <span class="s1">_start_proxied_socket</span><span class="s3">,</span>
                <span class="s4">&quot;wss://example.com&quot;</span><span class="s3">,</span>
                <span class="s1">OptsList</span><span class="s3">(),</span>
                <span class="s1">proxy_info</span><span class="s3">(</span>
                    <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;example.com&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">,</span>
                    <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;socks5h&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_timeout</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
                <span class="s1">ProxyConnectionError</span><span class="s3">,</span>
                <span class="s1">connect</span><span class="s3">,</span>
                <span class="s4">&quot;wss://example.com&quot;</span><span class="s3">,</span>
                <span class="s1">OptsList</span><span class="s3">(),</span>
                <span class="s1">proxy_info</span><span class="s3">(</span>
                    <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s5">9999</span><span class="s3">,</span>
                    <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;socks4&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_timeout</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                <span class="s3">),</span>
                <span class="s2">None</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">TypeError</span><span class="s3">,</span>
            <span class="s1">_get_addrinfo_list</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s5">80</span><span class="s3">,</span>
            <span class="s2">True</span><span class="s3">,</span>
            <span class="s1">proxy_info</span><span class="s3">(</span>
                <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">, </span><span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;9999&quot;</span><span class="s3">, </span><span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span>
            <span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">TypeError</span><span class="s3">,</span>
            <span class="s1">_get_addrinfo_list</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s5">80</span><span class="s3">,</span>
            <span class="s2">True</span><span class="s3">,</span>
            <span class="s1">proxy_info</span><span class="s3">(</span>
                <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">, </span><span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;9999&quot;</span><span class="s3">, </span><span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span>
            <span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">socket</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">,</span>
            <span class="s1">connect</span><span class="s3">,</span>
            <span class="s4">&quot;wss://google.com&quot;</span><span class="s3">,</span>
            <span class="s1">OptsList</span><span class="s3">(),</span>
            <span class="s1">proxy_info</span><span class="s3">(</span>
                <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;8.8.8.8&quot;</span><span class="s3">,</span>
                <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s5">9999</span><span class="s3">,</span>
                <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span><span class="s3">,</span>
                <span class="s1">http_proxy_timeout</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s2">None</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">connect</span><span class="s3">(</span>
                <span class="s4">&quot;wss://google.com&quot;</span><span class="s3">,</span>
                <span class="s1">OptsList</span><span class="s3">(),</span>
                <span class="s1">proxy_info</span><span class="s3">(</span>
                    <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;8.8.8.8&quot;</span><span class="s3">, </span><span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s5">8080</span><span class="s3">, </span><span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span>
                <span class="s3">),</span>
                <span class="s2">True</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span><span class="s2">True</span><span class="s3">, (</span><span class="s4">&quot;google.com&quot;</span><span class="s3">, </span><span class="s5">443</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span><span class="s3">)),</span>
        <span class="s3">)</span>
        <span class="s0"># The following test fails on Mac OS with a gaierror, not an OverflowError</span>
        <span class="s0"># self.assertRaises(OverflowError, connect, &quot;wss://example.com&quot;, OptsList(), proxy_info(http_proxy_host=&quot;127.0.0.1&quot;, http_proxy_port=99999, proxy_type=&quot;socks4&quot;, timeout=2), False)</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span><span class="s1">TEST_WITH_INTERNET</span><span class="s3">, </span><span class="s4">&quot;Internet-requiring tests are disabled&quot;</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span>
        <span class="s1">TEST_WITH_PROXY</span><span class="s3">, </span><span class="s4">&quot;This test requires a HTTP proxy to be running on port 8899&quot;</span>
    <span class="s3">)</span>
    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span>
        <span class="s1">TEST_WITH_LOCAL_SERVER</span><span class="s3">, </span><span class="s4">&quot;Tests using local websocket server are disabled&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_proxy_connect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">ws </span><span class="s3">= </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">()</span>
        <span class="s1">ws</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span>
            <span class="s4">f&quot;ws://127.0.0.1:</span><span class="s2">{</span><span class="s1">LOCAL_WS_SERVER_PORT</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
            <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">,</span>
            <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8899&quot;</span><span class="s3">,</span>
            <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">ws</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s4">&quot;Hello, Server&quot;</span><span class="s3">)</span>
        <span class="s1">server_response </span><span class="s3">= </span><span class="s1">ws</span><span class="s3">.</span><span class="s1">recv</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span><span class="s1">server_response</span><span class="s3">, </span><span class="s4">&quot;Hello, Server&quot;</span><span class="s3">)</span>
        <span class="s0"># self.assertEqual(_start_proxied_socket(&quot;wss://api.bitfinex.com/ws/2&quot;, OptsList(), proxy_info(http_proxy_host=&quot;127.0.0.1&quot;, http_proxy_port=&quot;8899&quot;, proxy_type=&quot;http&quot;))[1], (&quot;api.bitfinex.com&quot;, 443, '/ws/2'))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">_get_addrinfo_list</span><span class="s3">(</span>
                <span class="s4">&quot;api.bitfinex.com&quot;</span><span class="s3">,</span>
                <span class="s5">443</span><span class="s3">,</span>
                <span class="s2">True</span><span class="s3">,</span>
                <span class="s1">proxy_info</span><span class="s3">(</span>
                    <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">,</span>
                    <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8899&quot;</span><span class="s3">,</span>
                    <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s1">socket</span><span class="s3">.</span><span class="s1">getaddrinfo</span><span class="s3">(</span>
                    <span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">, </span><span class="s5">8899</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">SOCK_STREAM</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">SOL_TCP</span>
                <span class="s3">),</span>
                <span class="s2">True</span><span class="s3">,</span>
                <span class="s2">None</span><span class="s3">,</span>
            <span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">connect</span><span class="s3">(</span>
                <span class="s4">&quot;wss://api.bitfinex.com/ws/2&quot;</span><span class="s3">,</span>
                <span class="s1">OptsList</span><span class="s3">(),</span>
                <span class="s1">proxy_info</span><span class="s3">(</span>
                    <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">, </span><span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s5">8899</span><span class="s3">, </span><span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span>
                <span class="s3">),</span>
                <span class="s2">None</span><span class="s3">,</span>
            <span class="s3">)[</span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">(</span><span class="s4">&quot;api.bitfinex.com&quot;</span><span class="s3">, </span><span class="s5">443</span><span class="s3">, </span><span class="s4">&quot;/ws/2&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s0"># TODO: Test SOCKS4 and SOCK5 proxies with unit tests</span>

    <span class="s3">@</span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">skipUnless</span><span class="s3">(</span><span class="s1">TEST_WITH_INTERNET</span><span class="s3">, </span><span class="s4">&quot;Internet-requiring tests are disabled&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_sslopt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">ssloptions </span><span class="s3">= {</span>
            <span class="s4">&quot;check_hostname&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
            <span class="s4">&quot;server_hostname&quot;</span><span class="s3">: </span><span class="s4">&quot;ServerName&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ssl_version&quot;</span><span class="s3">: </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">PROTOCOL_TLS_CLIENT</span><span class="s3">,</span>
            <span class="s4">&quot;ciphers&quot;</span><span class="s3">: </span><span class="s4">&quot;TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:</span><span class="s2">\ 
                        </span><span class="s4">TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:</span><span class="s2">\ 
                        </span><span class="s4">ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:</span><span class="s2">\ 
                        </span><span class="s4">ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:</span><span class="s2">\ 
                        </span><span class="s4">DHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:</span><span class="s2">\ 
                        </span><span class="s4">ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:</span><span class="s2">\ 
                        </span><span class="s4">ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:</span><span class="s2">\ 
                        </span><span class="s4">DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES128-SHA256:</span><span class="s2">\ 
                        </span><span class="s4">ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:</span><span class="s2">\ 
                        </span><span class="s4">ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ecdh_curve&quot;</span><span class="s3">: </span><span class="s4">&quot;prime256v1&quot;</span><span class="s3">,</span>
        <span class="s3">}</span>
        <span class="s1">ws_ssl1 </span><span class="s3">= </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">(</span><span class="s1">sslopt</span><span class="s3">=</span><span class="s1">ssloptions</span><span class="s3">)</span>
        <span class="s1">ws_ssl1</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s4">&quot;wss://api.bitfinex.com/ws/2&quot;</span><span class="s3">)</span>
        <span class="s1">ws_ssl1</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s4">&quot;Hello&quot;</span><span class="s3">)</span>
        <span class="s1">ws_ssl1</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s1">ws_ssl2 </span><span class="s3">= </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">WebSocket</span><span class="s3">(</span><span class="s1">sslopt</span><span class="s3">={</span><span class="s4">&quot;check_hostname&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})</span>
        <span class="s1">ws_ssl2</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s4">&quot;wss://api.bitfinex.com/ws/2&quot;</span><span class="s3">)</span>
        <span class="s1">ws_ssl2</span><span class="s3">.</span><span class="s1">close</span>

    <span class="s2">def </span><span class="s1">test_proxy_info</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">proxy_info</span><span class="s3">(</span>
                <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">, </span><span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">, </span><span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span>
            <span class="s3">).</span><span class="s1">proxy_protocol</span><span class="s3">,</span>
            <span class="s4">&quot;http&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertRaises</span><span class="s3">(</span>
            <span class="s1">ProxyError</span><span class="s3">,</span>
            <span class="s1">proxy_info</span><span class="s3">,</span>
            <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">,</span>
            <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">,</span>
            <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;badval&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">proxy_info</span><span class="s3">(</span>
                <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;example.com&quot;</span><span class="s3">, </span><span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">, </span><span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span>
            <span class="s3">).</span><span class="s1">proxy_host</span><span class="s3">,</span>
            <span class="s4">&quot;example.com&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">proxy_info</span><span class="s3">(</span>
                <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">, </span><span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">, </span><span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span>
            <span class="s3">).</span><span class="s1">proxy_port</span><span class="s3">,</span>
            <span class="s4">&quot;8080&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">proxy_info</span><span class="s3">(</span>
                <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">, </span><span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">, </span><span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span>
            <span class="s3">).</span><span class="s1">auth</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">proxy_info</span><span class="s3">(</span>
                <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">,</span>
                <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">,</span>
                <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span><span class="s3">,</span>
                <span class="s1">http_proxy_auth</span><span class="s3">=(</span><span class="s4">&quot;my_username123&quot;</span><span class="s3">, </span><span class="s4">&quot;my_pass321&quot;</span><span class="s3">),</span>
            <span class="s3">).</span><span class="s1">auth</span><span class="s3">[</span><span class="s5">0</span><span class="s3">],</span>
            <span class="s4">&quot;my_username123&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assertEqual</span><span class="s3">(</span>
            <span class="s1">proxy_info</span><span class="s3">(</span>
                <span class="s1">http_proxy_host</span><span class="s3">=</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s3">,</span>
                <span class="s1">http_proxy_port</span><span class="s3">=</span><span class="s4">&quot;8080&quot;</span><span class="s3">,</span>
                <span class="s1">proxy_type</span><span class="s3">=</span><span class="s4">&quot;http&quot;</span><span class="s3">,</span>
                <span class="s1">http_proxy_auth</span><span class="s3">=(</span><span class="s4">&quot;my_username123&quot;</span><span class="s3">, </span><span class="s4">&quot;my_pass321&quot;</span><span class="s3">),</span>
            <span class="s3">).</span><span class="s1">auth</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],</span>
            <span class="s4">&quot;my_pass321&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s4">&quot;__main__&quot;</span><span class="s3">:</span>
    <span class="s1">unittest</span><span class="s3">.</span><span class="s1">main</span><span class="s3">()</span>
</pre>
</body>
</html>