<html>
<head>
<title>_core_metadata.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_core_metadata.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Handling of Core Metadata for Python packages (including reading and writing). 
 
See: https://packaging.python.org/en/latest/specifications/core-metadata/ 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">stat</span>
<span class="s2">import </span><span class="s1">textwrap</span>
<span class="s2">from </span><span class="s1">email </span><span class="s2">import </span><span class="s1">message_from_file</span>
<span class="s2">from </span><span class="s1">email</span><span class="s3">.</span><span class="s1">message </span><span class="s2">import </span><span class="s1">Message</span>
<span class="s2">from </span><span class="s1">tempfile </span><span class="s2">import </span><span class="s1">NamedTemporaryFile</span>

<span class="s2">from </span><span class="s1">packaging</span><span class="s3">.</span><span class="s1">markers </span><span class="s2">import </span><span class="s1">Marker</span>
<span class="s2">from </span><span class="s1">packaging</span><span class="s3">.</span><span class="s1">requirements </span><span class="s2">import </span><span class="s1">Requirement</span>
<span class="s2">from </span><span class="s1">packaging</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">canonicalize_name</span><span class="s3">, </span><span class="s1">canonicalize_version</span>
<span class="s2">from </span><span class="s1">packaging</span><span class="s3">.</span><span class="s1">version </span><span class="s2">import </span><span class="s1">Version</span>

<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">_normalization</span><span class="s3">, </span><span class="s1">_reqs</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_static </span><span class="s2">import </span><span class="s1">is_static</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">warnings </span><span class="s2">import </span><span class="s1">SetuptoolsDeprecationWarning</span>

<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">util </span><span class="s2">import </span><span class="s1">rfc822_escape</span>


<span class="s2">def </span><span class="s1">get_metadata_version</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
    <span class="s1">mv </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s4">'metadata_version'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">mv </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">mv </span><span class="s3">= </span><span class="s1">Version</span><span class="s3">(</span><span class="s4">'2.4'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">metadata_version </span><span class="s3">= </span><span class="s1">mv</span>
    <span class="s2">return </span><span class="s1">mv</span>


<span class="s2">def </span><span class="s1">rfc822_unescape</span><span class="s3">(</span><span class="s1">content</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Reverse RFC-822 escaping by removing leading whitespaces from content.&quot;&quot;&quot;</span>
    <span class="s1">lines </span><span class="s3">= </span><span class="s1">content</span><span class="s3">.</span><span class="s1">splitlines</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) == </span><span class="s5">1</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">lines</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">lstrip</span><span class="s3">()</span>
    <span class="s2">return </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">((</span><span class="s1">lines</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">lstrip</span><span class="s3">(), </span><span class="s1">textwrap</span><span class="s3">.</span><span class="s1">dedent</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:]))))</span>


<span class="s2">def </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">: </span><span class="s1">Message</span><span class="s3">, </span><span class="s1">field</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Read Message header field.&quot;&quot;&quot;</span>
    <span class="s1">value </span><span class="s3">= </span><span class="s1">msg</span><span class="s3">[</span><span class="s1">field</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">value </span><span class="s3">== </span><span class="s4">'UNKNOWN'</span><span class="s3">:</span>
        <span class="s2">return None</span>
    <span class="s2">return </span><span class="s1">value</span>


<span class="s2">def </span><span class="s1">_read_field_unescaped_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">: </span><span class="s1">Message</span><span class="s3">, </span><span class="s1">field</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Read Message header field and apply rfc822_unescape.&quot;&quot;&quot;</span>
    <span class="s1">value </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s1">field</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">value </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">value</span>
    <span class="s2">return </span><span class="s1">rfc822_unescape</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_read_list_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">: </span><span class="s1">Message</span><span class="s3">, </span><span class="s1">field</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; list</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] | </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Read Message header field and return all results as list.&quot;&quot;&quot;</span>
    <span class="s1">values </span><span class="s3">= </span><span class="s1">msg</span><span class="s3">.</span><span class="s1">get_all</span><span class="s3">(</span><span class="s1">field</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">values </span><span class="s3">== []:</span>
        <span class="s2">return None</span>
    <span class="s2">return </span><span class="s1">values</span>


<span class="s2">def </span><span class="s1">_read_payload_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">: </span><span class="s1">Message</span><span class="s3">) </span><span class="s1">-&gt; str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">value </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">.</span><span class="s1">get_payload</span><span class="s3">()).</span><span class="s1">strip</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">value </span><span class="s3">== </span><span class="s4">'UNKNOWN' </span><span class="s2">or not </span><span class="s1">value</span><span class="s3">:</span>
        <span class="s2">return None</span>
    <span class="s2">return </span><span class="s1">value</span>


<span class="s2">def </span><span class="s1">read_pkg_file</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Reads the metadata values from a file object.&quot;&quot;&quot;</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">message_from_file</span><span class="s3">(</span><span class="s1">file</span><span class="s3">)</span>

    <span class="s1">self</span><span class="s3">.</span><span class="s1">metadata_version </span><span class="s3">= </span><span class="s1">Version</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">[</span><span class="s4">'metadata-version'</span><span class="s3">])</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'name'</span><span class="s3">)</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">version </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'version'</span><span class="s3">)</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">description </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'summary'</span><span class="s3">)</span>
    <span class="s6"># we are filling author only.</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">author </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'author'</span><span class="s3">)</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">maintainer </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">author_email </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'author-email'</span><span class="s3">)</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">maintainer_email </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">url </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'home-page'</span><span class="s3">)</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">download_url </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'download-url'</span><span class="s3">)</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">license </span><span class="s3">= </span><span class="s1">_read_field_unescaped_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'license'</span><span class="s3">)</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">license_expression </span><span class="s3">= </span><span class="s1">_read_field_unescaped_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'license-expression'</span><span class="s3">)</span>

    <span class="s1">self</span><span class="s3">.</span><span class="s1">long_description </span><span class="s3">= </span><span class="s1">_read_field_unescaped_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'description'</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">long_description </span><span class="s2">is None and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">metadata_version </span><span class="s3">&gt;= </span><span class="s1">Version</span><span class="s3">(</span><span class="s4">'2.1'</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">long_description </span><span class="s3">= </span><span class="s1">_read_payload_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">description </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'summary'</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s4">'keywords' </span><span class="s2">in </span><span class="s1">msg</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">keywords </span><span class="s3">= </span><span class="s1">_read_field_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'keywords'</span><span class="s3">).</span><span class="s1">split</span><span class="s3">(</span><span class="s4">','</span><span class="s3">)</span>

    <span class="s1">self</span><span class="s3">.</span><span class="s1">platforms </span><span class="s3">= </span><span class="s1">_read_list_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'platform'</span><span class="s3">)</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">classifiers </span><span class="s3">= </span><span class="s1">_read_list_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'classifier'</span><span class="s3">)</span>

    <span class="s6"># PEP 314 - these fields only exist in 1.1</span>
    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">metadata_version </span><span class="s3">== </span><span class="s1">Version</span><span class="s3">(</span><span class="s4">'1.1'</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">requires </span><span class="s3">= </span><span class="s1">_read_list_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'requires'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">provides </span><span class="s3">= </span><span class="s1">_read_list_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'provides'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">obsoletes </span><span class="s3">= </span><span class="s1">_read_list_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'obsoletes'</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">requires </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">provides </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">obsoletes </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s1">self</span><span class="s3">.</span><span class="s1">license_files </span><span class="s3">= </span><span class="s1">_read_list_from_msg</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s4">'license-file'</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">single_line</span><span class="s3">(</span><span class="s1">val</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Quick and dirty validation for Summary pypa/setuptools#1390. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s2">in </span><span class="s1">val</span><span class="s3">:</span>
        <span class="s6"># TODO: Replace with `raise ValueError(&quot;newlines not allowed&quot;)`</span>
        <span class="s6"># after reviewing #2893.</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;newlines are not allowed in `summary` and will break in the future&quot;</span>
        <span class="s1">SetuptoolsDeprecationWarning</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s4">&quot;Invalid config.&quot;</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s6"># due_date is undefined. Controversial change, there was a lot of push back.</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">val</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">val</span>


<span class="s2">def </span><span class="s1">write_pkg_info</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">base_dir</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Write the PKG-INFO file into the release tree.&quot;&quot;&quot;</span>
    <span class="s1">temp </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>
    <span class="s1">final </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">base_dir</span><span class="s3">, </span><span class="s4">'PKG-INFO'</span><span class="s3">)</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s6"># Use a temporary file while writing to avoid race conditions</span>
        <span class="s6"># (e.g. `importlib.metadata` reading `.egg-info/PKG-INFO`):</span>
        <span class="s2">with </span><span class="s1">NamedTemporaryFile</span><span class="s3">(</span><span class="s4">&quot;w&quot;</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s1">dir</span><span class="s3">=</span><span class="s1">base_dir</span><span class="s3">, </span><span class="s1">delete</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">temp </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">name</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_pkg_file</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
        <span class="s1">permissions </span><span class="s3">= </span><span class="s1">stat</span><span class="s3">.</span><span class="s1">S_IMODE</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">lstat</span><span class="s3">(</span><span class="s1">temp</span><span class="s3">).</span><span class="s1">st_mode</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">chmod</span><span class="s3">(</span><span class="s1">temp</span><span class="s3">, </span><span class="s1">permissions </span><span class="s3">| </span><span class="s1">stat</span><span class="s3">.</span><span class="s1">S_IRGRP </span><span class="s3">| </span><span class="s1">stat</span><span class="s3">.</span><span class="s1">S_IROTH</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">temp</span><span class="s3">, </span><span class="s1">final</span><span class="s3">)  </span><span class="s6"># atomic operation.</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">temp </span><span class="s2">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">temp</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">temp</span><span class="s3">)</span>


<span class="s6"># Based on Python 3.5 version</span>
<span class="s2">def </span><span class="s1">write_pkg_file</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file</span><span class="s3">):  </span><span class="s6"># noqa: C901  # is too complex (14)  # FIXME</span>
    <span class="s0">&quot;&quot;&quot;Write the PKG-INFO format data to a file object.&quot;&quot;&quot;</span>
    <span class="s1">version </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_metadata_version</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">write_field</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s1">file</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">key</span><span class="s2">}</span><span class="s4">: </span><span class="s2">{</span><span class="s1">value</span><span class="s2">}\n</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Metadata-Version'</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">version</span><span class="s3">))</span>
    <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Name'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_name</span><span class="s3">())</span>
    <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Version'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_version</span><span class="s3">())</span>

    <span class="s1">summary </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_description</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">summary</span><span class="s3">:</span>
        <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Summary'</span><span class="s3">, </span><span class="s1">single_line</span><span class="s3">(</span><span class="s1">summary</span><span class="s3">))</span>

    <span class="s1">optional_fields </span><span class="s3">= (</span>
        <span class="s3">(</span><span class="s4">'Home-page'</span><span class="s3">, </span><span class="s4">'url'</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">'Download-URL'</span><span class="s3">, </span><span class="s4">'download_url'</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">'Author'</span><span class="s3">, </span><span class="s4">'author'</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">'Author-email'</span><span class="s3">, </span><span class="s4">'author_email'</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">'Maintainer'</span><span class="s3">, </span><span class="s4">'maintainer'</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">'Maintainer-email'</span><span class="s3">, </span><span class="s4">'maintainer_email'</span><span class="s3">),</span>
    <span class="s3">)</span>

    <span class="s2">for </span><span class="s1">field</span><span class="s3">, </span><span class="s1">attr </span><span class="s2">in </span><span class="s1">optional_fields</span><span class="s3">:</span>
        <span class="s1">attr_val </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">attr_val </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">write_field</span><span class="s3">(</span><span class="s1">field</span><span class="s3">, </span><span class="s1">attr_val</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">license_expression </span><span class="s3">:= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">license_expression</span><span class="s3">:</span>
        <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'License-Expression'</span><span class="s3">, </span><span class="s1">license_expression</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">license </span><span class="s3">:= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_license</span><span class="s3">():</span>
        <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'License'</span><span class="s3">, </span><span class="s1">rfc822_escape</span><span class="s3">(</span><span class="s1">license</span><span class="s3">))</span>

    <span class="s2">for </span><span class="s1">label</span><span class="s3">, </span><span class="s1">url </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">project_urls</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Project-URL'</span><span class="s3">, </span><span class="s4">f'</span><span class="s2">{</span><span class="s1">label</span><span class="s2">}</span><span class="s4">, </span><span class="s2">{</span><span class="s1">url</span><span class="s2">}</span><span class="s4">'</span><span class="s3">)</span>

    <span class="s1">keywords </span><span class="s3">= </span><span class="s4">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_keywords</span><span class="s3">())</span>
    <span class="s2">if </span><span class="s1">keywords</span><span class="s3">:</span>
        <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Keywords'</span><span class="s3">, </span><span class="s1">keywords</span><span class="s3">)</span>

    <span class="s1">platforms </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_platforms</span><span class="s3">() </span><span class="s2">or </span><span class="s3">[]</span>
    <span class="s2">for </span><span class="s1">platform </span><span class="s2">in </span><span class="s1">platforms</span><span class="s3">:</span>
        <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Platform'</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">)</span>

    <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_list</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s4">'Classifier'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_classifiers</span><span class="s3">())</span>

    <span class="s6"># PEP 314</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_list</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s4">'Requires'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_requires</span><span class="s3">())</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_list</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s4">'Provides'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_provides</span><span class="s3">())</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_list</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s4">'Obsoletes'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_obsoletes</span><span class="s3">())</span>

    <span class="s6"># Setuptools specific for PEP 345</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s4">'python_requires'</span><span class="s3">):</span>
        <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Requires-Python'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">python_requires</span><span class="s3">)</span>

    <span class="s6"># PEP 566</span>
    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">long_description_content_type</span><span class="s3">:</span>
        <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Description-Content-Type'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">long_description_content_type</span><span class="s3">)</span>

    <span class="s1">safe_license_files </span><span class="s3">= </span><span class="s1">map</span><span class="s3">(</span><span class="s1">_safe_license_file</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">license_files </span><span class="s2">or </span><span class="s3">[])</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_list</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s4">'License-File'</span><span class="s3">, </span><span class="s1">safe_license_files</span><span class="s3">)</span>
    <span class="s1">_write_requirements</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">field</span><span class="s3">, </span><span class="s1">attr </span><span class="s2">in </span><span class="s1">_POSSIBLE_DYNAMIC_FIELDS</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">val </span><span class="s3">:= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)) </span><span class="s2">and not </span><span class="s1">is_static</span><span class="s3">(</span><span class="s1">val</span><span class="s3">):</span>
            <span class="s1">write_field</span><span class="s3">(</span><span class="s4">'Dynamic'</span><span class="s3">, </span><span class="s1">field</span><span class="s3">)</span>

    <span class="s1">long_description </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_long_description</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">long_description</span><span class="s3">:</span>
        <span class="s1">file</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">\n{</span><span class="s1">long_description</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">long_description</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">):</span>
            <span class="s1">file</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_write_requirements</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">req </span><span class="s2">in </span><span class="s1">_reqs</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">install_requires</span><span class="s3">):</span>
        <span class="s1">file</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">f&quot;Requires-Dist: </span><span class="s2">{</span><span class="s1">req</span><span class="s2">}\n</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s1">processed_extras </span><span class="s3">= {}</span>
    <span class="s2">for </span><span class="s1">augmented_extra</span><span class="s3">, </span><span class="s1">reqs </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">extras_require</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s6"># Historically, setuptools allows &quot;augmented extras&quot;: `&lt;extra&gt;:&lt;condition&gt;`</span>
        <span class="s1">unsafe_extra</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">condition </span><span class="s3">= </span><span class="s1">augmented_extra</span><span class="s3">.</span><span class="s1">partition</span><span class="s3">(</span><span class="s4">&quot;:&quot;</span><span class="s3">)</span>
        <span class="s1">unsafe_extra </span><span class="s3">= </span><span class="s1">unsafe_extra</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s1">extra </span><span class="s3">= </span><span class="s1">_normalization</span><span class="s3">.</span><span class="s1">safe_extra</span><span class="s3">(</span><span class="s1">unsafe_extra</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">extra</span><span class="s3">:</span>
            <span class="s1">_write_provides_extra</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">processed_extras</span><span class="s3">, </span><span class="s1">extra</span><span class="s3">, </span><span class="s1">unsafe_extra</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">req </span><span class="s2">in </span><span class="s1">_reqs</span><span class="s3">.</span><span class="s1">parse_strings</span><span class="s3">(</span><span class="s1">reqs</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">_include_extra</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s1">extra</span><span class="s3">, </span><span class="s1">condition</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">())</span>
            <span class="s1">file</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">f&quot;Requires-Dist: </span><span class="s2">{</span><span class="s1">r</span><span class="s2">}\n</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">processed_extras</span>


<span class="s2">def </span><span class="s1">_include_extra</span><span class="s3">(</span><span class="s1">req</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">extra</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">condition</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; Requirement</span><span class="s3">:</span>
    <span class="s1">r </span><span class="s3">= </span><span class="s1">Requirement</span><span class="s3">(</span><span class="s1">req</span><span class="s3">)  </span><span class="s6"># create a fresh object that can be modified</span>
    <span class="s1">parts </span><span class="s3">= (</span>
        <span class="s4">f&quot;(</span><span class="s2">{</span><span class="s1">r</span><span class="s3">.</span><span class="s1">marker</span><span class="s2">}</span><span class="s4">)&quot; </span><span class="s2">if </span><span class="s1">r</span><span class="s3">.</span><span class="s1">marker </span><span class="s2">else None</span><span class="s3">,</span>
        <span class="s4">f&quot;(</span><span class="s2">{</span><span class="s1">condition</span><span class="s2">}</span><span class="s4">)&quot; </span><span class="s2">if </span><span class="s1">condition </span><span class="s2">else None</span><span class="s3">,</span>
        <span class="s4">f&quot;extra == </span><span class="s2">{</span><span class="s1">extra</span><span class="s2">!r}</span><span class="s4">&quot; </span><span class="s2">if </span><span class="s1">extra </span><span class="s2">else None</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">r</span><span class="s3">.</span><span class="s1">marker </span><span class="s3">= </span><span class="s1">Marker</span><span class="s3">(</span><span class="s4">&quot; and &quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">parts </span><span class="s2">if </span><span class="s1">x</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">r</span>


<span class="s2">def </span><span class="s1">_write_provides_extra</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">processed_extras</span><span class="s3">, </span><span class="s1">safe</span><span class="s3">, </span><span class="s1">unsafe</span><span class="s3">):</span>
    <span class="s1">previous </span><span class="s3">= </span><span class="s1">processed_extras</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">safe</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">previous </span><span class="s3">== </span><span class="s1">unsafe</span><span class="s3">:</span>
        <span class="s1">SetuptoolsDeprecationWarning</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span>
            <span class="s4">'Ambiguity during &quot;extra&quot; normalization for dependencies.'</span><span class="s3">,</span>
            <span class="s4">f&quot;&quot;&quot;</span>
            <span class="s2">{</span><span class="s1">previous</span><span class="s2">!r} </span><span class="s4">and </span><span class="s2">{</span><span class="s1">unsafe</span><span class="s2">!r} </span><span class="s4">normalize to the same value:</span><span class="s2">\n</span>
                <span class="s2">{</span><span class="s1">safe</span><span class="s2">!r}\n</span>
            <span class="s4">In future versions, setuptools might halt the build process.</span>
            <span class="s4">&quot;&quot;&quot;</span><span class="s3">,</span>
            <span class="s1">see_url</span><span class="s3">=</span><span class="s4">&quot;https://peps.python.org/pep-0685/&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">processed_extras</span><span class="s3">[</span><span class="s1">safe</span><span class="s3">] = </span><span class="s1">unsafe</span>
        <span class="s1">file</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">f&quot;Provides-Extra: </span><span class="s2">{</span><span class="s1">safe</span><span class="s2">}\n</span><span class="s4">&quot;</span><span class="s3">)</span>


<span class="s6"># from pypa/distutils#244; needed only until that logic is always available</span>
<span class="s2">def </span><span class="s1">get_fullname</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">_distribution_fullname</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_name</span><span class="s3">(), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_version</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">_distribution_fullname</span><span class="s3">(</span><span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">version</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    &gt;&gt;&gt; _distribution_fullname('setup.tools', '1.0-2') 
    'setup_tools-1.0.post2' 
    &gt;&gt;&gt; _distribution_fullname('setup-tools', '1.2post2') 
    'setup_tools-1.2.post2' 
    &gt;&gt;&gt; _distribution_fullname('setup-tools', '1.0-r2') 
    'setup_tools-1.0.post2' 
    &gt;&gt;&gt; _distribution_fullname('setup.tools', '1.0.post') 
    'setup_tools-1.0.post0' 
    &gt;&gt;&gt; _distribution_fullname('setup.tools', '1.0+ubuntu-1') 
    'setup_tools-1.0+ubuntu.1' 
    &quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s4">&quot;{}-{}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
        <span class="s1">canonicalize_name</span><span class="s3">(</span><span class="s1">name</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'-'</span><span class="s3">, </span><span class="s4">'_'</span><span class="s3">),</span>
        <span class="s1">canonicalize_version</span><span class="s3">(</span><span class="s1">version</span><span class="s3">, </span><span class="s1">strip_trailing_zero</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">_safe_license_file</span><span class="s3">(</span><span class="s1">file</span><span class="s3">):</span>
    <span class="s6"># XXX: Do we need this after the deprecation discussed in #4892, #4896??</span>
    <span class="s1">normalized </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">file</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s4">&quot;../&quot; </span><span class="s2">in </span><span class="s1">normalized</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">normalized</span><span class="s3">)  </span><span class="s6"># Temporarily restore pre PEP639 behaviour</span>
    <span class="s2">return </span><span class="s1">normalized</span>


<span class="s1">_POSSIBLE_DYNAMIC_FIELDS </span><span class="s3">= {</span>
    <span class="s6"># Core Metadata Field x related Distribution attribute</span>
    <span class="s4">&quot;author&quot;</span><span class="s3">: </span><span class="s4">&quot;author&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;author-email&quot;</span><span class="s3">: </span><span class="s4">&quot;author_email&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;classifier&quot;</span><span class="s3">: </span><span class="s4">&quot;classifiers&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;description&quot;</span><span class="s3">: </span><span class="s4">&quot;long_description&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;description-content-type&quot;</span><span class="s3">: </span><span class="s4">&quot;long_description_content_type&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;download-url&quot;</span><span class="s3">: </span><span class="s4">&quot;download_url&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;home-page&quot;</span><span class="s3">: </span><span class="s4">&quot;url&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;keywords&quot;</span><span class="s3">: </span><span class="s4">&quot;keywords&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;license&quot;</span><span class="s3">: </span><span class="s4">&quot;license&quot;</span><span class="s3">,</span>
    <span class="s6"># XXX: License-File is complicated because the user gives globs that are expanded</span>
    <span class="s6">#      during the build. Without special handling it is likely always</span>
    <span class="s6">#      marked as Dynamic, which is an acceptable outcome according to:</span>
    <span class="s6">#      https://github.com/pypa/setuptools/issues/4629#issuecomment-2331233677</span>
    <span class="s4">&quot;license-file&quot;</span><span class="s3">: </span><span class="s4">&quot;license_files&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;license-expression&quot;</span><span class="s3">: </span><span class="s4">&quot;license_expression&quot;</span><span class="s3">,  </span><span class="s6"># PEP 639</span>
    <span class="s4">&quot;maintainer&quot;</span><span class="s3">: </span><span class="s4">&quot;maintainer&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;maintainer-email&quot;</span><span class="s3">: </span><span class="s4">&quot;maintainer_email&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;obsoletes&quot;</span><span class="s3">: </span><span class="s4">&quot;obsoletes&quot;</span><span class="s3">,</span>
    <span class="s6"># &quot;obsoletes-dist&quot;: &quot;obsoletes_dist&quot;,  # NOT USED</span>
    <span class="s4">&quot;platform&quot;</span><span class="s3">: </span><span class="s4">&quot;platforms&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;project-url&quot;</span><span class="s3">: </span><span class="s4">&quot;project_urls&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;provides&quot;</span><span class="s3">: </span><span class="s4">&quot;provides&quot;</span><span class="s3">,</span>
    <span class="s6"># &quot;provides-dist&quot;: &quot;provides_dist&quot;,  # NOT USED</span>
    <span class="s4">&quot;provides-extra&quot;</span><span class="s3">: </span><span class="s4">&quot;extras_require&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;requires&quot;</span><span class="s3">: </span><span class="s4">&quot;requires&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;requires-dist&quot;</span><span class="s3">: </span><span class="s4">&quot;install_requires&quot;</span><span class="s3">,</span>
    <span class="s6"># &quot;requires-external&quot;: &quot;requires_external&quot;,  # NOT USED</span>
    <span class="s4">&quot;requires-python&quot;</span><span class="s3">: </span><span class="s4">&quot;python_requires&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;summary&quot;</span><span class="s3">: </span><span class="s4">&quot;description&quot;</span><span class="s3">,</span>
    <span class="s6"># &quot;supported-platform&quot;: &quot;supported_platforms&quot;,  # NOT USED</span>
<span class="s3">}</span>
</pre>
</body>
</html>