<html>
<head>
<title>_static.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_static.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">wraps</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">TypeVar</span>

<span class="s0">import </span><span class="s1">packaging</span><span class="s2">.</span><span class="s1">specifiers</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">warnings </span><span class="s0">import </span><span class="s1">SetuptoolsDeprecationWarning</span>


<span class="s0">class </span><span class="s1">Static</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; 
    Wrapper for built-in object types that are allow setuptools to identify 
    static core metadata (in opposition to ``Dynamic``, as defined :pep:`643`). 
 
    The trick is to mark values with :class:`Static` when they come from 
    ``pyproject.toml`` or ``setup.cfg``, so if any plugin overwrite the value 
    with a built-in, setuptools will be able to recognise the change. 
 
    We inherit from built-in classes, so that we don't need to change the existing 
    code base to deal with the new types. 
    We also should strive for immutability objects to avoid changes after the 
    initial parsing. 
    &quot;&quot;&quot;</span>

    <span class="s1">_mutated_</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False  </span><span class="s4"># TODO: Remove after deprecation warning is solved</span>


<span class="s0">def </span><span class="s1">_prevent_modification</span><span class="s2">(</span><span class="s1">target</span><span class="s2">: </span><span class="s1">type</span><span class="s2">, </span><span class="s1">method</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">copying</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; 
    Because setuptools is very flexible we cannot fully prevent 
    plugins and user customizations from modifying static values that were 
    parsed from config files. 
    But we can attempt to block &quot;in-place&quot; mutations and identify when they 
    were done. 
    &quot;&quot;&quot;</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">fn </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">return</span>

    <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">_replacement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">: </span><span class="s1">Static</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4"># TODO: After deprecation period raise NotImplementedError instead of warning</span>
        <span class="s4">#       which obviated the existence and checks of the `_mutated_` attribute.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_mutated_ </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">SetuptoolsDeprecationWarning</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span>
            <span class="s5">&quot;Direct modification of value will be disallowed&quot;</span><span class="s2">,</span>
            <span class="s5">f&quot;&quot;&quot;</span>
            <span class="s5">In an effort to implement PEP 643, direct/in-place changes of static values</span>
            <span class="s5">that come from configuration files are deprecated.</span>
            <span class="s5">If you need to modify this value, please first create a copy with </span><span class="s0">{</span><span class="s1">copying</span><span class="s0">}</span>
            <span class="s5">and make sure conform to all relevant standards when overriding setuptools</span>
            <span class="s5">functionality (https://packaging.python.org/en/latest/specifications/).</span>
            <span class="s5">&quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s1">due_date</span><span class="s2">=(</span><span class="s6">2025</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">),  </span><span class="s4"># Initially introduced in 2024-09-06</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s1">_replacement</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s5">&quot;&quot;  </span><span class="s4"># otherwise doctest may fail.</span>
    <span class="s1">setattr</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">_replacement</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Str</span><span class="s2">(</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Static</span><span class="s2">):</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">Tuple</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">, </span><span class="s1">Static</span><span class="s2">):</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">List</span><span class="s2">(</span><span class="s1">list</span><span class="s2">, </span><span class="s1">Static</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    :meta private: 
    &gt;&gt;&gt; x = List([1, 2, 3]) 
    &gt;&gt;&gt; is_static(x) 
    True 
    &gt;&gt;&gt; x += [0]  # doctest: +IGNORE_EXCEPTION_DETAIL 
    Traceback (most recent call last): 
    SetuptoolsDeprecationWarning: Direct modification ... 
    &gt;&gt;&gt; is_static(x)  # no longer static after modification 
    False 
    &gt;&gt;&gt; y = list(x) 
    &gt;&gt;&gt; y.clear() 
    &gt;&gt;&gt; y 
    [] 
    &gt;&gt;&gt; y == x 
    False 
    &gt;&gt;&gt; is_static(List(y)) 
    True 
    &quot;&quot;&quot;</span>


<span class="s4"># Make `List` immutable-ish</span>
<span class="s4"># (certain places of setuptools/distutils issue a warn if we use tuple instead of list)</span>
<span class="s0">for </span><span class="s1">_method </span><span class="s0">in </span><span class="s2">(</span>
    <span class="s5">'__delitem__'</span><span class="s2">,</span>
    <span class="s5">'__iadd__'</span><span class="s2">,</span>
    <span class="s5">'__setitem__'</span><span class="s2">,</span>
    <span class="s5">'append'</span><span class="s2">,</span>
    <span class="s5">'clear'</span><span class="s2">,</span>
    <span class="s5">'extend'</span><span class="s2">,</span>
    <span class="s5">'insert'</span><span class="s2">,</span>
    <span class="s5">'remove'</span><span class="s2">,</span>
    <span class="s5">'reverse'</span><span class="s2">,</span>
    <span class="s5">'pop'</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s1">_prevent_modification</span><span class="s2">(</span><span class="s1">List</span><span class="s2">, </span><span class="s1">_method</span><span class="s2">, </span><span class="s5">&quot;`list(value)`&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Dict</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">, </span><span class="s1">Static</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    :meta private: 
    &gt;&gt;&gt; x = Dict({'a': 1, 'b': 2}) 
    &gt;&gt;&gt; is_static(x) 
    True 
    &gt;&gt;&gt; x['c'] = 0  # doctest: +IGNORE_EXCEPTION_DETAIL 
    Traceback (most recent call last): 
    SetuptoolsDeprecationWarning: Direct modification ... 
    &gt;&gt;&gt; x._mutated_ 
    True 
    &gt;&gt;&gt; is_static(x)  # no longer static after modification 
    False 
    &gt;&gt;&gt; y = dict(x) 
    &gt;&gt;&gt; y.popitem() 
    ('b', 2) 
    &gt;&gt;&gt; y == x 
    False 
    &gt;&gt;&gt; is_static(Dict(y)) 
    True 
    &quot;&quot;&quot;</span>


<span class="s4"># Make `Dict` immutable-ish (we cannot inherit from types.MappingProxyType):</span>
<span class="s0">for </span><span class="s1">_method </span><span class="s0">in </span><span class="s2">(</span>
    <span class="s5">'__delitem__'</span><span class="s2">,</span>
    <span class="s5">'__ior__'</span><span class="s2">,</span>
    <span class="s5">'__setitem__'</span><span class="s2">,</span>
    <span class="s5">'clear'</span><span class="s2">,</span>
    <span class="s5">'pop'</span><span class="s2">,</span>
    <span class="s5">'popitem'</span><span class="s2">,</span>
    <span class="s5">'setdefault'</span><span class="s2">,</span>
    <span class="s5">'update'</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s1">_prevent_modification</span><span class="s2">(</span><span class="s1">Dict</span><span class="s2">, </span><span class="s1">_method</span><span class="s2">, </span><span class="s5">&quot;`dict(value)`&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">SpecifierSet</span><span class="s2">(</span><span class="s1">packaging</span><span class="s2">.</span><span class="s1">specifiers</span><span class="s2">.</span><span class="s1">SpecifierSet</span><span class="s2">, </span><span class="s1">Static</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Not exactly a built-in type but useful for ``requires-python``&quot;&quot;&quot;</span>


<span class="s1">T </span><span class="s2">= </span><span class="s1">TypeVar</span><span class="s2">(</span><span class="s5">&quot;T&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">noop</span><span class="s2">(</span><span class="s1">value</span><span class="s2">: </span><span class="s1">T</span><span class="s2">) </span><span class="s1">-&gt; T</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; 
    &gt;&gt;&gt; noop(42) 
    42 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">value</span>


<span class="s1">_CONVERSIONS </span><span class="s2">= {</span><span class="s1">str</span><span class="s2">: </span><span class="s1">Str</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">: </span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">list</span><span class="s2">: </span><span class="s1">List</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">: </span><span class="s1">Dict</span><span class="s2">}</span>


<span class="s0">def </span><span class="s1">attempt_conversion</span><span class="s2">(</span><span class="s1">value</span><span class="s2">: </span><span class="s1">T</span><span class="s2">) </span><span class="s1">-&gt; T</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; 
    &gt;&gt;&gt; is_static(attempt_conversion(&quot;hello&quot;)) 
    True 
    &gt;&gt;&gt; is_static(object()) 
    False 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">_CONVERSIONS</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">), </span><span class="s1">noop</span><span class="s2">)(</span><span class="s1">value</span><span class="s2">)  </span><span class="s4"># type: ignore[call-overload]</span>


<span class="s0">def </span><span class="s1">is_static</span><span class="s2">(</span><span class="s1">value</span><span class="s2">: </span><span class="s1">object</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; 
    &gt;&gt;&gt; is_static(a := Dict({'a': 1})) 
    True 
    &gt;&gt;&gt; is_static(dict(a)) 
    False 
    &gt;&gt;&gt; is_static(b := List([1, 2, 3])) 
    True 
    &gt;&gt;&gt; is_static(list(b)) 
    False 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Static</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">value</span><span class="s2">.</span><span class="s1">_mutated_</span>


<span class="s1">EMPTY_LIST </span><span class="s2">= </span><span class="s1">List</span><span class="s2">()</span>
<span class="s1">EMPTY_DICT </span><span class="s2">= </span><span class="s1">Dict</span><span class="s2">()</span>
</pre>
</body>
</html>