<html>
<head>
<title>fixtures.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
fixtures.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">contextlib</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">tarfile</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>

<span class="s0">import </span><span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span>
<span class="s0">import </span><span class="s1">path</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">_normalization </span><span class="s0">import </span><span class="s1">safer_name</span>

<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">contexts</span><span class="s2">, </span><span class="s1">environment</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">textwrap </span><span class="s0">import </span><span class="s1">DALS</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">user_override</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Override site.USER_BASE and site.USER_SITE with temporary directories in 
    a context. 
    &quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">tempdir</span><span class="s2">() </span><span class="s0">as </span><span class="s1">user_base</span><span class="s2">:</span>
        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s4">'site.USER_BASE'</span><span class="s2">, </span><span class="s1">user_base</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">tempdir</span><span class="s2">() </span><span class="s0">as </span><span class="s1">user_site</span><span class="s2">:</span>
            <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s4">'site.USER_SITE'</span><span class="s2">, </span><span class="s1">user_site</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">save_user_site_setting</span><span class="s2">():</span>
                <span class="s0">yield</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">tmpdir_cwd</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">() </span><span class="s0">as </span><span class="s1">orig</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">orig</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">autouse</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">=</span><span class="s4">&quot;session&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">workaround_xdist_376</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Workaround pytest-dev/pytest-xdist#376 
 
    ``pytest-xdist`` tends to inject '' into ``sys.path``, 
    which may break certain isolation expectations. 
    Remove the entry so the import 
    machinery behaves the same irrespective of xdist. 
    &quot;&quot;&quot;</span>
    <span class="s0">if not </span><span class="s1">request</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">pluginmanager</span><span class="s2">.</span><span class="s1">has_plugin</span><span class="s2">(</span><span class="s4">'xdist'</span><span class="s2">):</span>
        <span class="s0">return</span>

    <span class="s0">with </span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">suppress</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sample_project</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Clone the 'sampleproject' and return a path to it. 
    &quot;&quot;&quot;</span>
    <span class="s1">cmd </span><span class="s2">= [</span><span class="s4">'git'</span><span class="s2">, </span><span class="s4">'clone'</span><span class="s2">, </span><span class="s4">'https://github.com/pypa/sampleproject'</span><span class="s2">]</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_call</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">cwd</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">))</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;Unable to clone sampleproject&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">'sampleproject'</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sample_project_cwd</span><span class="s2">(</span><span class="s1">sample_project</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">path</span><span class="s2">.</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">sample_project</span><span class="s2">):</span>
        <span class="s0">yield</span>


<span class="s5"># sdist and wheel artifacts should be stable across a round of tests</span>
<span class="s5"># so we can build them once per session and use the files as &quot;readonly&quot;</span>

<span class="s5"># In the case of setuptools, building the wheel without sdist may cause</span>
<span class="s5"># it to contain the `build` directory, and therefore create situations with</span>
<span class="s5"># `setuptools/build/lib/build/lib/...`. To avoid that, build both artifacts at once.</span>


<span class="s0">def </span><span class="s1">_build_distributions</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">session_locked_tmp_dir</span><span class="s2">(</span>
        <span class="s1">request</span><span class="s2">, </span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s4">&quot;dist_build&quot;</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">tmp</span><span class="s2">:  </span><span class="s5"># pragma: no cover</span>
        <span class="s1">sdist </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s4">&quot;*.tar.gz&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">wheel </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s4">&quot;*.whl&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">sdist </span><span class="s0">and </span><span class="s1">wheel</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">sdist</span><span class="s2">, </span><span class="s1">wheel</span><span class="s2">)</span>

        <span class="s5"># Sanity check: should not create recursive setuptools/build/lib/build/lib/...</span>
        <span class="s0">assert not </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">rootdir</span><span class="s2">, </span><span class="s4">&quot;build/lib/build&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>

        <span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_output</span><span class="s2">([</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">,</span>
            <span class="s4">&quot;-m&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;build&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;--outdir&quot;</span><span class="s2">,</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">),</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">rootdir</span><span class="s2">),</span>
        <span class="s2">])</span>

        <span class="s5"># Sanity check: should not create recursive setuptools/build/lib/build/lib/...</span>
        <span class="s0">assert not </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">rootdir</span><span class="s2">, </span><span class="s4">&quot;build/lib/build&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">()</span>

        <span class="s0">return </span><span class="s1">next</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s4">&quot;*.tar.gz&quot;</span><span class="s2">)), </span><span class="s1">next</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s4">&quot;*.whl&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s4">&quot;session&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">setuptools_sdist</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">prebuilt </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">getenv</span><span class="s2">(</span><span class="s4">&quot;PRE_BUILT_SETUPTOOLS_SDIST&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">prebuilt </span><span class="s0">and </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">prebuilt</span><span class="s2">):  </span><span class="s5"># pragma: no cover</span>
        <span class="s0">return </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">prebuilt</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">()</span>

    <span class="s1">sdist</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">_build_distributions</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s1">request</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">sdist</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s4">&quot;session&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">setuptools_wheel</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">prebuilt </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">getenv</span><span class="s2">(</span><span class="s4">&quot;PRE_BUILT_SETUPTOOLS_WHEEL&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">prebuilt </span><span class="s0">and </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">prebuilt</span><span class="s2">):  </span><span class="s5"># pragma: no cover</span>
        <span class="s0">return </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">prebuilt</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">()</span>

    <span class="s1">_</span><span class="s2">, </span><span class="s1">wheel </span><span class="s2">= </span><span class="s1">_build_distributions</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s1">request</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">wheel</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">venv</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setuptools_wheel</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Virtual env with the version of setuptools under test installed&quot;&quot;&quot;</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">environment</span><span class="s2">.</span><span class="s1">VirtualEnv</span><span class="s2">()</span>
    <span class="s1">env</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">'venv'</span><span class="s2">)</span>
    <span class="s1">env</span><span class="s2">.</span><span class="s1">create_opts </span><span class="s2">= [</span><span class="s4">'--no-setuptools'</span><span class="s2">, </span><span class="s4">'--wheel=bundle'</span><span class="s2">]</span>
    <span class="s5"># TODO: Use `--no-wheel` when setuptools implements its own bdist_wheel</span>
    <span class="s1">env</span><span class="s2">.</span><span class="s1">req </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">setuptools_wheel</span><span class="s2">)</span>
    <span class="s5"># In some environments (eg. downstream distro packaging),</span>
    <span class="s5"># where tox isn't used to run tests and PYTHONPATH is set to point to</span>
    <span class="s5"># a specific setuptools codebase, PYTHONPATH will leak into the spawned</span>
    <span class="s5"># processes.</span>
    <span class="s5"># env.create() should install the just created setuptools</span>
    <span class="s5"># wheel, but it doesn't if it finds another existing matching setuptools</span>
    <span class="s5"># installation present on PYTHONPATH:</span>
    <span class="s5"># `setuptools is already installed with the same version as the provided</span>
    <span class="s5"># wheel. Use --force-reinstall to force an installation of the wheel.`</span>
    <span class="s5"># This prevents leaking PYTHONPATH to the created environment.</span>
    <span class="s0">with </span><span class="s1">contexts</span><span class="s2">.</span><span class="s1">environment</span><span class="s2">(</span><span class="s1">PYTHONPATH</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">env</span><span class="s2">.</span><span class="s1">create</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">venv_without_setuptools</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Virtual env without any version of setuptools installed&quot;&quot;&quot;</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">environment</span><span class="s2">.</span><span class="s1">VirtualEnv</span><span class="s2">()</span>
    <span class="s1">env</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">'venv_without_setuptools'</span><span class="s2">)</span>
    <span class="s1">env</span><span class="s2">.</span><span class="s1">create_opts </span><span class="s2">= [</span><span class="s4">'--no-setuptools'</span><span class="s2">, </span><span class="s4">'--no-wheel'</span><span class="s2">]</span>
    <span class="s1">env</span><span class="s2">.</span><span class="s1">ensure_env</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">env</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">bare_venv</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Virtual env without any common packages installed&quot;&quot;&quot;</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">environment</span><span class="s2">.</span><span class="s1">VirtualEnv</span><span class="s2">()</span>
    <span class="s1">env</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">'bare_venv'</span><span class="s2">)</span>
    <span class="s1">env</span><span class="s2">.</span><span class="s1">create_opts </span><span class="s2">= [</span><span class="s4">'--no-setuptools'</span><span class="s2">, </span><span class="s4">'--no-pip'</span><span class="s2">, </span><span class="s4">'--no-wheel'</span><span class="s2">, </span><span class="s4">'--no-seed'</span><span class="s2">]</span>
    <span class="s1">env</span><span class="s2">.</span><span class="s1">ensure_env</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">env</span>


<span class="s0">def </span><span class="s1">make_sdist</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Create a simple sdist tarball at dist_path, containing the files 
    listed in ``files`` as ``(filename, content)`` tuples. 
    &quot;&quot;&quot;</span>

    <span class="s5"># Distributions with only one file don't play well with pip.</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">files</span><span class="s2">) &gt; </span><span class="s6">1</span>
    <span class="s0">with </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">, </span><span class="s4">'w:gz'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">dist</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">content </span><span class="s0">in </span><span class="s1">files</span><span class="s2">:</span>
            <span class="s1">file_bytes </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">content</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">'utf-8'</span><span class="s2">))</span>
            <span class="s1">file_info </span><span class="s2">= </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">TarInfo</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">filename</span><span class="s2">)</span>
            <span class="s1">file_info</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">file_bytes</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">())</span>
            <span class="s1">file_info</span><span class="s2">.</span><span class="s1">mtime </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">())</span>
            <span class="s1">dist</span><span class="s2">.</span><span class="s1">addfile</span><span class="s2">(</span><span class="s1">file_info</span><span class="s2">, </span><span class="s1">fileobj</span><span class="s2">=</span><span class="s1">file_bytes</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">make_trivial_sdist</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">, </span><span class="s1">distname</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Create a simple sdist tarball at dist_path, containing just a simple 
    setup.py. 
    &quot;&quot;&quot;</span>

    <span class="s1">make_sdist</span><span class="s2">(</span>
        <span class="s1">dist_path</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span>
                <span class="s4">'setup.py'</span><span class="s2">,</span>
                <span class="s1">DALS</span><span class="s2">(</span>
                    <span class="s4">f&quot;&quot;&quot;</span><span class="s0">\ 
             </span><span class="s4">import setuptools</span>
             <span class="s4">setuptools.setup(</span>
                 <span class="s4">name=</span><span class="s0">{</span><span class="s1">distname</span><span class="s0">!r}</span><span class="s4">,</span>
                 <span class="s4">version=</span><span class="s0">{</span><span class="s1">version</span><span class="s0">!r}</span>
             <span class="s4">)</span>
         <span class="s4">&quot;&quot;&quot;</span>
                <span class="s2">),</span>
            <span class="s2">),</span>
            <span class="s2">(</span><span class="s4">'setup.cfg'</span><span class="s2">, </span><span class="s4">''</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">make_nspkg_sdist</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">, </span><span class="s1">distname</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Make an sdist tarball with distname and version which also contains one 
    package with the same name as distname.  The top-level package is 
    designated a namespace package). 
    &quot;&quot;&quot;</span>
    <span class="s5"># Assert that the distname contains at least one period</span>
    <span class="s0">assert </span><span class="s4">'.' </span><span class="s0">in </span><span class="s1">distname</span>

    <span class="s1">parts </span><span class="s2">= </span><span class="s1">distname</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">'.'</span><span class="s2">)</span>
    <span class="s1">nspackage </span><span class="s2">= </span><span class="s1">parts</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>

    <span class="s1">packages </span><span class="s2">= [</span><span class="s4">'.'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">parts</span><span class="s2">[:</span><span class="s1">idx</span><span class="s2">]) </span><span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">parts</span><span class="s2">) + </span><span class="s6">1</span><span class="s2">)]</span>

    <span class="s1">setup_py </span><span class="s2">= </span><span class="s1">DALS</span><span class="s2">(</span>
        <span class="s4">f&quot;&quot;&quot;</span><span class="s0">\ 
        </span><span class="s4">import setuptools</span>
        <span class="s4">setuptools.setup(</span>
            <span class="s4">name=</span><span class="s0">{</span><span class="s1">distname</span><span class="s0">!r}</span><span class="s4">,</span>
            <span class="s4">version=</span><span class="s0">{</span><span class="s1">version</span><span class="s0">!r}</span><span class="s4">,</span>
            <span class="s4">packages=</span><span class="s0">{</span><span class="s1">packages</span><span class="s0">!r}</span><span class="s4">,</span>
            <span class="s4">namespace_packages=[</span><span class="s0">{</span><span class="s1">nspackage</span><span class="s0">!r}</span><span class="s4">]</span>
        <span class="s4">)</span>
    <span class="s4">&quot;&quot;&quot;</span>
    <span class="s2">)</span>

    <span class="s1">init </span><span class="s2">= </span><span class="s4">&quot;__import__('pkg_resources').declare_namespace(__name__)&quot;</span>

    <span class="s1">files </span><span class="s2">= [(</span><span class="s4">'setup.py'</span><span class="s2">, </span><span class="s1">setup_py</span><span class="s2">), (</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">nspackage</span><span class="s2">, </span><span class="s4">'__init__.py'</span><span class="s2">), </span><span class="s1">init</span><span class="s2">)]</span>
    <span class="s0">for </span><span class="s1">package </span><span class="s0">in </span><span class="s1">packages</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(*(</span><span class="s1">package</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">'.'</span><span class="s2">) + [</span><span class="s4">'__init__.py'</span><span class="s2">]))</span>
        <span class="s1">files</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">filename</span><span class="s2">, </span><span class="s4">''</span><span class="s2">))</span>

    <span class="s1">make_sdist</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">, </span><span class="s1">files</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">make_python_requires_sdist</span><span class="s2">(</span><span class="s1">dist_path</span><span class="s2">, </span><span class="s1">distname</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">python_requires</span><span class="s2">):</span>
    <span class="s1">make_sdist</span><span class="s2">(</span>
        <span class="s1">dist_path</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span>
                <span class="s4">'setup.py'</span><span class="s2">,</span>
                <span class="s1">DALS</span><span class="s2">(</span>
                    <span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
                </span><span class="s4">import setuptools 
                setuptools.setup( 
                  name={name!r}, 
                  version={version!r}, 
                  python_requires={python_requires!r}, 
                ) 
                &quot;&quot;&quot;</span>
                <span class="s2">).</span><span class="s1">format</span><span class="s2">(</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s1">distname</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">, </span><span class="s1">python_requires</span><span class="s2">=</span><span class="s1">python_requires</span>
                <span class="s2">),</span>
            <span class="s2">),</span>
            <span class="s2">(</span><span class="s4">'setup.cfg'</span><span class="s2">, </span><span class="s4">''</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">create_setup_requires_package</span><span class="s2">(</span>
    <span class="s1">path</span><span class="s2">,</span>
    <span class="s1">distname</span><span class="s2">=</span><span class="s4">'foobar'</span><span class="s2">,</span>
    <span class="s1">version</span><span class="s2">=</span><span class="s4">'0.1'</span><span class="s2">,</span>
    <span class="s1">make_package</span><span class="s2">=</span><span class="s1">make_trivial_sdist</span><span class="s2">,</span>
    <span class="s1">setup_py_template</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">setup_attrs</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">use_setup_cfg</span><span class="s2">=(),</span>
<span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Creates a source tree under path for a trivial test package that has a 
    single requirement in setup_requires--a tarball for that requirement is 
    also created and added to the dependency_links argument. 
 
    ``distname`` and ``version`` refer to the name/version of the package that 
    the test package requires via ``setup_requires``.  The name of the test 
    package itself is just 'test_pkg'. 
    &quot;&quot;&quot;</span>

    <span class="s1">normalized_distname </span><span class="s2">= </span><span class="s1">safer_name</span><span class="s2">(</span><span class="s1">distname</span><span class="s2">)</span>
    <span class="s1">test_setup_attrs </span><span class="s2">= {</span>
        <span class="s4">'name'</span><span class="s2">: </span><span class="s4">'test_pkg'</span><span class="s2">,</span>
        <span class="s4">'version'</span><span class="s2">: </span><span class="s4">'0.0'</span><span class="s2">,</span>
        <span class="s4">'setup_requires'</span><span class="s2">: [</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">normalized_distname</span><span class="s0">}</span><span class="s4">==</span><span class="s0">{</span><span class="s1">version</span><span class="s0">}</span><span class="s4">'</span><span class="s2">],</span>
        <span class="s4">'dependency_links'</span><span class="s2">: [</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)],</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s1">setup_attrs</span><span class="s2">:</span>
        <span class="s1">test_setup_attrs</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">setup_attrs</span><span class="s2">)</span>

    <span class="s1">test_pkg </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">'test_pkg'</span><span class="s2">)</span>
    <span class="s1">os</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s1">test_pkg</span><span class="s2">)</span>

    <span class="s5"># setup.cfg</span>
    <span class="s0">if </span><span class="s1">use_setup_cfg</span><span class="s2">:</span>
        <span class="s1">options </span><span class="s2">= []</span>
        <span class="s1">metadata </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">use_setup_cfg</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">test_setup_attrs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s4">'name version'</span><span class="s2">.</span><span class="s1">split</span><span class="s2">():</span>
                <span class="s1">section </span><span class="s2">= </span><span class="s1">metadata</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">section </span><span class="s2">= </span><span class="s1">options</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, (</span><span class="s1">tuple</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)):</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s4">';'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">section</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s4">: </span><span class="s0">{</span><span class="s1">value</span><span class="s0">}</span><span class="s4">'</span><span class="s2">)</span>
        <span class="s1">test_setup_cfg_contents </span><span class="s2">= </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            [metadata] 
            {metadata} 
            [options] 
            {options} 
            &quot;&quot;&quot;</span>
        <span class="s2">).</span><span class="s1">format</span><span class="s2">(</span>
            <span class="s1">options</span><span class="s2">=</span><span class="s4">'</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">options</span><span class="s2">),</span>
            <span class="s1">metadata</span><span class="s2">=</span><span class="s4">'</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">),</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">test_setup_cfg_contents </span><span class="s2">= </span><span class="s4">''</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">test_pkg</span><span class="s2">, </span><span class="s4">'setup.cfg'</span><span class="s2">), </span><span class="s4">'w'</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">test_setup_cfg_contents</span><span class="s2">)</span>

    <span class="s5"># setup.py</span>
    <span class="s0">if </span><span class="s1">setup_py_template </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">setup_py_template </span><span class="s2">= </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
            </span><span class="s4">import setuptools 
            setuptools.setup(**%r) 
        &quot;&quot;&quot;</span>
        <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">test_pkg</span><span class="s2">, </span><span class="s4">'setup.py'</span><span class="s2">), </span><span class="s4">'w'</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">setup_py_template </span><span class="s2">% </span><span class="s1">test_setup_attrs</span><span class="s2">)</span>

    <span class="s1">foobar_path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">f'</span><span class="s0">{</span><span class="s1">normalized_distname</span><span class="s0">}</span><span class="s4">-</span><span class="s0">{</span><span class="s1">version</span><span class="s0">}</span><span class="s4">.tar.gz'</span><span class="s2">)</span>
    <span class="s1">make_package</span><span class="s2">(</span><span class="s1">foobar_path</span><span class="s2">, </span><span class="s1">distname</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">test_pkg</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">pbr_package</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">):</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            [build-system] 
            requires = [&quot;setuptools&quot;] 
            build-backend = &quot;setuptools.build_meta&quot; 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s4">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            __import__('setuptools').setup( 
                pbr=True, 
                setup_requires=[&quot;pbr&quot;], 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s4">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s1">DALS</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            [metadata] 
            name = mypkg 
 
            [files] 
            packages = 
                mypkg 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s4">&quot;mypkg&quot;</span><span class="s2">: {</span>
            <span class="s4">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;hello.py&quot;</span><span class="s2">: </span><span class="s4">&quot;print('Hello world!')&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s4">&quot;other&quot;</span><span class="s2">: {</span><span class="s4">&quot;test.txt&quot;</span><span class="s2">: </span><span class="s4">&quot;Another file in here.&quot;</span><span class="s2">},</span>
    <span class="s2">}</span>
    <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">([</span><span class="s4">&quot;python&quot;</span><span class="s2">, </span><span class="s4">&quot;-m&quot;</span><span class="s2">, </span><span class="s4">&quot;pip&quot;</span><span class="s2">, </span><span class="s4">&quot;install&quot;</span><span class="s2">, </span><span class="s4">&quot;pbr&quot;</span><span class="s2">])</span>
    <span class="s1">prefix </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">'mypkg'</span>
    <span class="s1">prefix</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">()</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">prefix</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setenv</span><span class="s2">(</span><span class="s4">'PBR_VERSION'</span><span class="s2">, </span><span class="s4">&quot;0.42&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">prefix</span>
</pre>
</body>
</html>