<html>
<head>
<title>test_bdist_wheel.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #a5c261;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_bdist_wheel.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">builtins</span>
<span class="s0">import </span><span class="s1">importlib</span>
<span class="s0">import </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">stat</span>
<span class="s0">import </span><span class="s1">struct</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">sysconfig</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">suppress</span>
<span class="s0">from </span><span class="s1">inspect </span><span class="s0">import </span><span class="s1">cleandoc</span>
<span class="s0">from </span><span class="s1">zipfile </span><span class="s0">import </span><span class="s1">ZipFile</span>

<span class="s0">import </span><span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">packaging </span><span class="s0">import </span><span class="s1">tags</span>

<span class="s0">import </span><span class="s1">setuptools</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">command</span><span class="s2">.</span><span class="s1">bdist_wheel </span><span class="s0">import </span><span class="s1">bdist_wheel</span><span class="s2">, </span><span class="s1">get_abi_tag</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">dist </span><span class="s0">import </span><span class="s1">Distribution</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">warnings </span><span class="s0">import </span><span class="s1">SetuptoolsDeprecationWarning</span>

<span class="s0">from </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">run_setup</span>

<span class="s1">DEFAULT_FILES </span><span class="s2">= {</span>
    <span class="s3">&quot;dummy_dist-1.0.dist-info/top_level.txt&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;dummy_dist-1.0.dist-info/METADATA&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;dummy_dist-1.0.dist-info/WHEEL&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;dummy_dist-1.0.dist-info/RECORD&quot;</span><span class="s2">,</span>
<span class="s2">}</span>
<span class="s1">DEFAULT_LICENSE_FILES </span><span class="s2">= {</span>
    <span class="s3">&quot;LICENSE&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;LICENSE.txt&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;LICENCE&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;LICENCE.txt&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;COPYING&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;COPYING.md&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;NOTICE&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;NOTICE.rst&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;AUTHORS&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;AUTHORS.txt&quot;</span><span class="s2">,</span>
<span class="s2">}</span>
<span class="s1">OTHER_IGNORED_FILES </span><span class="s2">= {</span>
    <span class="s3">&quot;LICENSE~&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;AUTHORS~&quot;</span><span class="s2">,</span>
<span class="s2">}</span>
<span class="s1">SETUPPY_EXAMPLE </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s3">from setuptools import setup 
 
setup( 
    name='dummy_dist', 
    version='1.0', 
) 
&quot;&quot;&quot;</span>


<span class="s1">EXAMPLES </span><span class="s2">= {</span>
    <span class="s3">&quot;dummy-dist&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">SETUPPY_EXAMPLE</span><span class="s2">,</span>
        <span class="s3">&quot;licenses_dir&quot;</span><span class="s2">: {</span><span class="s3">&quot;DUMMYFILE&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">},</span>
        <span class="s2">**</span><span class="s1">dict</span><span class="s2">.</span><span class="s1">fromkeys</span><span class="s2">(</span><span class="s1">DEFAULT_LICENSE_FILES </span><span class="s2">| </span><span class="s1">OTHER_IGNORED_FILES</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">),</span>
    <span class="s2">},</span>
    <span class="s3">&quot;simple-dist&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            from setuptools import setup 
 
            setup( 
                name=&quot;simple.dist&quot;, 
                version=&quot;0.1&quot;, 
                description=&quot;A testing distribution </span><span class="s0">\N{SNOWMAN}</span><span class="s3">&quot;, 
                extras_require={&quot;voting&quot;: [&quot;beaglevote&quot;]}, 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">&quot;simpledist&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
    <span class="s2">},</span>
    <span class="s3">&quot;complex-dist&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            from setuptools import setup 
 
            setup( 
                name=&quot;complex-dist&quot;, 
                version=&quot;0.1&quot;, 
                description=&quot;Another testing distribution </span><span class="s0">\N{SNOWMAN}</span><span class="s3">&quot;, 
                long_description=&quot;Another testing distribution </span><span class="s0">\N{SNOWMAN}</span><span class="s3">&quot;, 
                author=&quot;Illustrious Author&quot;, 
                author_email=&quot;illustrious@example.org&quot;, 
                url=&quot;http://example.org/exemplary&quot;, 
                packages=[&quot;complexdist&quot;], 
                setup_requires=[&quot;setuptools&quot;], 
                install_requires=[&quot;quux&quot;, &quot;splort&quot;], 
                extras_require={&quot;simple&quot;: [&quot;simple.dist&quot;]}, 
                entry_points={ 
                    &quot;console_scripts&quot;: [ 
                        &quot;complex-dist=complexdist:main&quot;, 
                        &quot;complex-dist2=complexdist:main&quot;, 
                    ], 
                }, 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">&quot;complexdist&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;def main(): return&quot;</span><span class="s2">},</span>
    <span class="s2">},</span>
    <span class="s3">&quot;headers-dist&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            from setuptools import setup 
 
            setup( 
                name=&quot;headers.dist&quot;, 
                version=&quot;0.1&quot;, 
                description=&quot;A distribution with headers&quot;, 
                headers=[&quot;header.h&quot;], 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">&quot;headersdist.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;header.h&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
    <span class="s2">},</span>
    <span class="s3">&quot;commasinfilenames-dist&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            from setuptools import setup 
 
            setup( 
                name=&quot;testrepo&quot;, 
                version=&quot;0.1&quot;, 
                packages=[&quot;mypackage&quot;], 
                description=&quot;A test package with commas in file names&quot;, 
                include_package_data=True, 
                package_data={&quot;mypackage.data&quot;: [&quot;*&quot;]}, 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">&quot;mypackage&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;data&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;1,2,3.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">},</span>
        <span class="s2">},</span>
        <span class="s3">&quot;testrepo-0.1.0&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;mypackage&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">},</span>
        <span class="s2">},</span>
    <span class="s2">},</span>
    <span class="s3">&quot;unicode-dist&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            from setuptools import setup 
 
            setup( 
                name=&quot;unicode.dist&quot;, 
                version=&quot;0.1&quot;, 
                description=&quot;A testing distribution </span><span class="s0">\N{SNOWMAN}</span><span class="s3">&quot;, 
                packages=[&quot;unicodedist&quot;], 
                zip_safe=True, 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">&quot;unicodedist&quot;</span><span class="s2">: {</span><span class="s3">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;åäö_日本語.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">},</span>
    <span class="s2">},</span>
    <span class="s3">&quot;utf8-metadata-dist&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            [metadata] 
            name = utf8-metadata-dist 
            version = 42 
            author_email = &quot;John X. Ãørçeč&quot; &lt;john@utf8.org&gt;, Γαμα קּ 東 &lt;gama@utf8.org&gt; 
            long_description = file: README.rst 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">&quot;README.rst&quot;</span><span class="s2">: </span><span class="s3">&quot;UTF-8 描述 説明&quot;</span><span class="s2">,</span>
    <span class="s2">},</span>
    <span class="s3">&quot;licenses-dist&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            [metadata] 
            name = licenses-dist 
            version = 1.0 
            license_files = **/LICENSE 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">&quot;LICENSE&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;src&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;vendor&quot;</span><span class="s2">: {</span><span class="s3">&quot;LICENSE&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">},</span>
        <span class="s2">},</span>
    <span class="s2">},</span>
<span class="s2">}</span>


<span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s3">&quot;win32&quot;</span><span class="s2">:</span>
    <span class="s4"># ABI3 extensions don't really work on Windows</span>
    <span class="s1">EXAMPLES</span><span class="s2">[</span><span class="s3">&quot;abi3extension-dist&quot;</span><span class="s2">] = {</span>
        <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
            <span class="s3">&quot;&quot;&quot; 
            from setuptools import Extension, setup 
 
            setup( 
                name=&quot;extension.dist&quot;, 
                version=&quot;0.1&quot;, 
                description=&quot;A testing distribution </span><span class="s0">\N{SNOWMAN}</span><span class="s3">&quot;, 
                ext_modules=[ 
                    Extension( 
                        name=&quot;extension&quot;, sources=[&quot;extension.c&quot;], py_limited_api=True 
                    ) 
                ], 
            ) 
            &quot;&quot;&quot;</span>
        <span class="s2">),</span>
        <span class="s3">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s3">&quot;[bdist_wheel]</span><span class="s0">\n</span><span class="s3">py_limited_api=cp32&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;extension.c&quot;</span><span class="s2">: </span><span class="s3">&quot;#define Py_LIMITED_API 0x03020000</span><span class="s0">\n</span><span class="s3">#include &lt;Python.h&gt;&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>


<span class="s0">def </span><span class="s1">bdist_wheel_cmd</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Run command in the same process so that it is easier to collect coverage&quot;&quot;&quot;</span>
    <span class="s1">dist_obj </span><span class="s2">= (</span>
        <span class="s1">run_setup</span><span class="s2">(</span><span class="s3">&quot;setup.py&quot;</span><span class="s2">, </span><span class="s1">stop_after</span><span class="s2">=</span><span class="s3">&quot;init&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s3">&quot;setup.py&quot;</span><span class="s2">)</span>
        <span class="s0">else </span><span class="s1">Distribution</span><span class="s2">({</span><span class="s3">&quot;script_name&quot;</span><span class="s2">: </span><span class="s3">&quot;%%build_meta%%&quot;</span><span class="s2">})</span>
    <span class="s2">)</span>
    <span class="s1">dist_obj</span><span class="s2">.</span><span class="s1">parse_config_files</span><span class="s2">()</span>
    <span class="s1">cmd </span><span class="s2">= </span><span class="s1">bdist_wheel</span><span class="s2">(</span><span class="s1">dist_obj</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s1">setattr</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">finalize_options</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">cmd</span>


<span class="s0">def </span><span class="s1">mkexample</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
    <span class="s1">basedir </span><span class="s2">= </span><span class="s1">tmp_path_factory</span><span class="s2">.</span><span class="s1">mktemp</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">EXAMPLES</span><span class="s2">[</span><span class="s1">name</span><span class="s2">], </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">basedir</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">basedir</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s3">&quot;session&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">wheel_paths</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">):</span>
    <span class="s1">build_base </span><span class="s2">= </span><span class="s1">tmp_path_factory</span><span class="s2">.</span><span class="s1">mktemp</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">)</span>
    <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">tmp_path_factory</span><span class="s2">.</span><span class="s1">mktemp</span><span class="s2">(</span><span class="s3">&quot;dist&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">EXAMPLES</span><span class="s2">:</span>
        <span class="s1">example_dir </span><span class="s2">= </span><span class="s1">mkexample</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">build_dir </span><span class="s2">= </span><span class="s1">build_base </span><span class="s2">/ </span><span class="s1">name</span>
        <span class="s0">with </span><span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">DirectoryStack</span><span class="s2">().</span><span class="s1">context</span><span class="s2">(</span><span class="s1">example_dir</span><span class="s2">):</span>
            <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">build_dir</span><span class="s2">), </span><span class="s1">dist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)).</span><span class="s1">run</span><span class="s2">()</span>

    <span class="s0">return </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">) </span><span class="s0">for </span><span class="s1">fname </span><span class="s0">in </span><span class="s1">dist_dir</span><span class="s2">.</span><span class="s1">glob</span><span class="s2">(</span><span class="s3">&quot;*.whl&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">dummy_dist</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">mkexample</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s3">&quot;dummy-dist&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">licenses_dist</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">mkexample</span><span class="s2">(</span><span class="s1">tmp_path_factory</span><span class="s2">, </span><span class="s3">&quot;licenses-dist&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_no_scripts</span><span class="s2">(</span><span class="s1">wheel_paths</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Make sure entry point scripts are not generated.&quot;&quot;&quot;</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">path </span><span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">wheel_paths </span><span class="s0">if </span><span class="s3">&quot;complex_dist&quot; </span><span class="s0">in </span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">entry </span><span class="s0">in </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">).</span><span class="s1">infolist</span><span class="s2">():</span>
        <span class="s0">assert </span><span class="s3">&quot;.data/scripts/&quot; </span><span class="s0">not in </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">filename</span>


<span class="s0">def </span><span class="s1">test_unicode_record</span><span class="s2">(</span><span class="s1">wheel_paths</span><span class="s2">):</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">path </span><span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">wheel_paths </span><span class="s0">if </span><span class="s3">&quot;unicode_dist&quot; </span><span class="s0">in </span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">zf</span><span class="s2">:</span>
        <span class="s1">record </span><span class="s2">= </span><span class="s1">zf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s3">&quot;unicode_dist-0.1.dist-info/RECORD&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s3">&quot;åäö_日本語.py&quot;</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">() </span><span class="s0">in </span><span class="s1">record</span>


<span class="s1">UTF8_PKG_INFO </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s3">Metadata-Version: 2.1 
Name: helloworld 
Version: 42 
Author-email: &quot;John X. Ãørçeč&quot; &lt;john@utf8.org&gt;, Γαμα קּ 東 &lt;gama@utf8.org&gt; 
 
 
UTF-8 描述 説明 
&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_preserve_unicode_metadata</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">egginfo </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;dummy_dist.egg-info&quot;</span>
    <span class="s1">distinfo </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;dummy_dist.dist-info&quot;</span>

    <span class="s1">egginfo</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">()</span>
    <span class="s2">(</span><span class="s1">egginfo </span><span class="s2">/ </span><span class="s3">&quot;PKG-INFO&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">UTF8_PKG_INFO</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s2">(</span><span class="s1">egginfo </span><span class="s2">/ </span><span class="s3">&quot;dependency_links.txt&quot;</span><span class="s2">).</span><span class="s1">touch</span><span class="s2">()</span>

    <span class="s0">class </span><span class="s1">simpler_bdist_wheel</span><span class="s2">(</span><span class="s1">bdist_wheel</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Avoid messing with setuptools/distutils internals&quot;&quot;&quot;</span>

        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s2">@</span><span class="s1">property</span>
        <span class="s0">def </span><span class="s1">license_paths</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">[]</span>

    <span class="s1">cmd_obj </span><span class="s2">= </span><span class="s1">simpler_bdist_wheel</span><span class="s2">()</span>
    <span class="s1">cmd_obj</span><span class="s2">.</span><span class="s1">egg2dist</span><span class="s2">(</span><span class="s1">egginfo</span><span class="s2">, </span><span class="s1">distinfo</span><span class="s2">)</span>

    <span class="s1">metadata </span><span class="s2">= (</span><span class="s1">distinfo </span><span class="s2">/ </span><span class="s3">&quot;METADATA&quot;</span><span class="s2">).</span><span class="s1">read_text</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">'Author-email: &quot;John X. Ãørçeč&quot;' </span><span class="s0">in </span><span class="s1">metadata</span>
    <span class="s0">assert </span><span class="s3">&quot;Γαμα קּ 東 &quot; </span><span class="s0">in </span><span class="s1">metadata</span>
    <span class="s0">assert </span><span class="s3">&quot;UTF-8 描述 説明&quot; </span><span class="s0">in </span><span class="s1">metadata</span>


<span class="s0">def </span><span class="s1">test_licenses_default</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>
    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)).</span><span class="s1">run</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/dummy_dist-1.0-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s1">license_files </span><span class="s2">= {</span>
            <span class="s3">&quot;dummy_dist-1.0.dist-info/licenses/&quot; </span><span class="s2">+ </span><span class="s1">fname</span>
            <span class="s0">for </span><span class="s1">fname </span><span class="s0">in </span><span class="s1">DEFAULT_LICENSE_FILES</span>
        <span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">wf</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">()) == </span><span class="s1">DEFAULT_FILES </span><span class="s2">| </span><span class="s1">license_files</span>


<span class="s0">def </span><span class="s1">test_licenses_deprecated</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">dummy_dist</span><span class="s2">.</span><span class="s1">joinpath</span><span class="s2">(</span><span class="s3">&quot;setup.cfg&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span>
        <span class="s3">&quot;[metadata]</span><span class="s0">\n</span><span class="s3">license_file=licenses_dir/DUMMYFILE&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span>
    <span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>

    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)).</span><span class="s1">run</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/dummy_dist-1.0-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s1">license_files </span><span class="s2">= {</span><span class="s3">&quot;dummy_dist-1.0.dist-info/licenses/licenses_dir/DUMMYFILE&quot;</span><span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">wf</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">()) == </span><span class="s1">DEFAULT_FILES </span><span class="s2">| </span><span class="s1">license_files</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;config_file&quot;</span><span class="s2">, </span><span class="s3">&quot;config&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">&quot;setup.cfg&quot;</span><span class="s2">, </span><span class="s3">&quot;[metadata]</span><span class="s0">\n</span><span class="s3">license_files=licenses_dir/*</span><span class="s0">\n  </span><span class="s3">LICENSE&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;setup.cfg&quot;</span><span class="s2">, </span><span class="s3">&quot;[metadata]</span><span class="s0">\n</span><span class="s3">license_files=licenses_dir/*, LICENSE&quot;</span><span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s3">&quot;setup.py&quot;</span><span class="s2">,</span>
            <span class="s1">SETUPPY_EXAMPLE</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span>
                <span class="s3">&quot;)&quot;</span><span class="s2">, </span><span class="s3">&quot;  license_files=['licenses_dir/DUMMYFILE', 'LICENSE'])&quot;</span>
            <span class="s2">),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_licenses_override</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">config_file</span><span class="s2">, </span><span class="s1">config</span><span class="s2">):</span>
    <span class="s1">dummy_dist</span><span class="s2">.</span><span class="s1">joinpath</span><span class="s2">(</span><span class="s1">config_file</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>
    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)).</span><span class="s1">run</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/dummy_dist-1.0-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s1">license_files </span><span class="s2">= {</span>
            <span class="s3">&quot;dummy_dist-1.0.dist-info/licenses/&quot; </span><span class="s2">+ </span><span class="s1">fname</span>
            <span class="s0">for </span><span class="s1">fname </span><span class="s0">in </span><span class="s2">{</span><span class="s3">&quot;licenses_dir/DUMMYFILE&quot;</span><span class="s2">, </span><span class="s3">&quot;LICENSE&quot;</span><span class="s2">}</span>
        <span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">wf</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">()) == </span><span class="s1">DEFAULT_FILES </span><span class="s2">| </span><span class="s1">license_files</span>
        <span class="s1">metadata </span><span class="s2">= </span><span class="s1">wf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s3">&quot;dummy_dist-1.0.dist-info/METADATA&quot;</span><span class="s2">).</span><span class="s1">decode</span><span class="s2">(</span><span class="s3">&quot;utf8&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s3">&quot;License-File: licenses_dir/DUMMYFILE&quot; </span><span class="s0">in </span><span class="s1">metadata</span>
        <span class="s0">assert </span><span class="s3">&quot;License-File: LICENSE&quot; </span><span class="s0">in </span><span class="s1">metadata</span>


<span class="s0">def </span><span class="s1">test_licenses_preserve_folder_structure</span><span class="s2">(</span><span class="s1">licenses_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">licenses_dist</span><span class="s2">)</span>
    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)).</span><span class="s1">run</span><span class="s2">()</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">listdir</span><span class="s2">(</span><span class="s3">&quot;dist&quot;</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/licenses_dist-1.0-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s1">default_files </span><span class="s2">= {</span><span class="s1">name</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">&quot;dummy_&quot;</span><span class="s2">, </span><span class="s3">&quot;licenses_&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">DEFAULT_FILES</span><span class="s2">}</span>
        <span class="s1">license_files </span><span class="s2">= {</span>
            <span class="s3">&quot;licenses_dist-1.0.dist-info/licenses/LICENSE&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;licenses_dist-1.0.dist-info/licenses/src/vendor/LICENSE&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">wf</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">()) == </span><span class="s1">default_files </span><span class="s2">| </span><span class="s1">license_files</span>
        <span class="s1">metadata </span><span class="s2">= </span><span class="s1">wf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s3">&quot;licenses_dist-1.0.dist-info/METADATA&quot;</span><span class="s2">).</span><span class="s1">decode</span><span class="s2">(</span><span class="s3">&quot;utf8&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s3">&quot;License-File: src/vendor/LICENSE&quot; </span><span class="s0">in </span><span class="s1">metadata</span>
        <span class="s0">assert </span><span class="s3">&quot;License-File: LICENSE&quot; </span><span class="s0">in </span><span class="s1">metadata</span>


<span class="s0">def </span><span class="s1">test_licenses_disabled</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">dummy_dist</span><span class="s2">.</span><span class="s1">joinpath</span><span class="s2">(</span><span class="s3">&quot;setup.cfg&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span>
        <span class="s3">&quot;[metadata]</span><span class="s0">\n</span><span class="s3">license_files=</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span>
    <span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>
    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)).</span><span class="s1">run</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/dummy_dist-1.0-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">wf</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">()) == </span><span class="s1">DEFAULT_FILES</span>


<span class="s0">def </span><span class="s1">test_build_number</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>
    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">), </span><span class="s1">build_number</span><span class="s2">=</span><span class="s3">&quot;2&quot;</span><span class="s2">).</span><span class="s1">run</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/dummy_dist-1.0-2-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s1">filenames </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">wf</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">())</span>
        <span class="s0">assert </span><span class="s3">&quot;dummy_dist-1.0.dist-info/RECORD&quot; </span><span class="s0">in </span><span class="s1">filenames</span>
        <span class="s0">assert </span><span class="s3">&quot;dummy_dist-1.0.dist-info/METADATA&quot; </span><span class="s0">in </span><span class="s1">filenames</span>


<span class="s0">def </span><span class="s1">test_universal_deprecated</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">SetuptoolsDeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;.*universal is deprecated&quot;</span><span class="s2">):</span>
        <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">), </span><span class="s1">universal</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">run</span><span class="s2">()</span>

    <span class="s4"># For now we still respect the option</span>
    <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s3">&quot;dist/dummy_dist-1.0-py2.py3-none-any.whl&quot;</span><span class="s2">)</span>


<span class="s1">EXTENSION_EXAMPLE </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s3">#include &lt;Python.h&gt; 
 
static PyMethodDef methods[] = { 
  { NULL, NULL, 0, NULL } 
}; 
 
static struct PyModuleDef module_def = { 
  PyModuleDef_HEAD_INIT, 
  &quot;extension&quot;, 
  &quot;Dummy extension module&quot;, 
  -1, 
  methods 
}; 
 
PyMODINIT_FUNC PyInit_extension(void) { 
  return PyModule_Create(&amp;module_def); 
} 
&quot;&quot;&quot;</span>
<span class="s1">EXTENSION_SETUPPY </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s3">from __future__ import annotations 
 
from setuptools import Extension, setup 
 
setup( 
    name=&quot;extension.dist&quot;, 
    version=&quot;0.1&quot;, 
    description=&quot;A testing distribution </span><span class="s0">\N{SNOWMAN}</span><span class="s3">&quot;, 
    ext_modules=[Extension(name=&quot;extension&quot;, sources=[&quot;extension.c&quot;])], 
) 
&quot;&quot;&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s3">&quot;once:Config variable '.*' is unset.*, Python ABI tag may be incorrect&quot;</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_limited_abi</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">tmp_path_factory</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Test that building a binary wheel with the limited ABI works.&quot;&quot;&quot;</span>
    <span class="s1">source_dir </span><span class="s2">= </span><span class="s1">tmp_path_factory</span><span class="s2">.</span><span class="s1">mktemp</span><span class="s2">(</span><span class="s3">&quot;extension_dist&quot;</span><span class="s2">)</span>
    <span class="s2">(</span><span class="s1">source_dir </span><span class="s2">/ </span><span class="s3">&quot;setup.py&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">EXTENSION_SETUPPY</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s2">(</span><span class="s1">source_dir </span><span class="s2">/ </span><span class="s3">&quot;extension.c&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">EXTENSION_EXAMPLE</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s1">build_dir </span><span class="s2">= </span><span class="s1">tmp_path</span><span class="s2">.</span><span class="s1">joinpath</span><span class="s2">(</span><span class="s3">&quot;build&quot;</span><span class="s2">)</span>
    <span class="s1">dist_dir </span><span class="s2">= </span><span class="s1">tmp_path</span><span class="s2">.</span><span class="s1">joinpath</span><span class="s2">(</span><span class="s3">&quot;dist&quot;</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">source_dir</span><span class="s2">)</span>
    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">build_dir</span><span class="s2">), </span><span class="s1">dist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">dist_dir</span><span class="s2">)).</span><span class="s1">run</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_build_from_readonly_tree</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">basedir </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">.</span><span class="s1">joinpath</span><span class="s2">(</span><span class="s3">&quot;dummy&quot;</span><span class="s2">))</span>
    <span class="s1">shutil</span><span class="s2">.</span><span class="s1">copytree</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">), </span><span class="s1">basedir</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">basedir</span><span class="s2">)</span>

    <span class="s4"># Make the tree read-only</span>
    <span class="s0">for </span><span class="s1">root</span><span class="s2">, </span><span class="s1">_dirs</span><span class="s2">, </span><span class="s1">files </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">walk</span><span class="s2">(</span><span class="s1">basedir</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">fname </span><span class="s0">in </span><span class="s1">files</span><span class="s2">:</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">chmod</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">), </span><span class="s1">stat</span><span class="s2">.</span><span class="s1">S_IREAD</span><span class="s2">)</span>

    <span class="s1">bdist_wheel_cmd</span><span class="s2">().</span><span class="s1">run</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;option&quot;</span><span class="s2">, </span><span class="s3">&quot;compress_type&quot;</span><span class="s2">),</span>
    <span class="s1">list</span><span class="s2">(</span><span class="s1">bdist_wheel</span><span class="s2">.</span><span class="s1">supported_compressions</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()),</span>
    <span class="s1">ids</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s1">bdist_wheel</span><span class="s2">.</span><span class="s1">supported_compressions</span><span class="s2">),</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_compression</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">option</span><span class="s2">, </span><span class="s1">compress_type</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>
    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">), </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">option</span><span class="s2">).</span><span class="s1">run</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/dummy_dist-1.0-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s1">filenames </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">wf</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">())</span>
        <span class="s0">assert </span><span class="s3">&quot;dummy_dist-1.0.dist-info/RECORD&quot; </span><span class="s0">in </span><span class="s1">filenames</span>
        <span class="s0">assert </span><span class="s3">&quot;dummy_dist-1.0.dist-info/METADATA&quot; </span><span class="s0">in </span><span class="s1">filenames</span>
        <span class="s0">for </span><span class="s1">zinfo </span><span class="s0">in </span><span class="s1">wf</span><span class="s2">.</span><span class="s1">filelist</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">zinfo</span><span class="s2">.</span><span class="s1">compress_type </span><span class="s2">== </span><span class="s1">compress_type</span>


<span class="s0">def </span><span class="s1">test_wheelfile_line_endings</span><span class="s2">(</span><span class="s1">wheel_paths</span><span class="s2">):</span>
    <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">wheel_paths</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
            <span class="s1">wheelfile </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">fn </span><span class="s0">for </span><span class="s1">fn </span><span class="s0">in </span><span class="s1">wf</span><span class="s2">.</span><span class="s1">filelist </span><span class="s0">if </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">&quot;WHEEL&quot;</span><span class="s2">))</span>
            <span class="s1">wheelfile_contents </span><span class="s2">= </span><span class="s1">wf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">wheelfile</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s6">b&quot;</span><span class="s0">\r</span><span class="s6">&quot; </span><span class="s0">not in </span><span class="s1">wheelfile_contents</span>


<span class="s0">def </span><span class="s1">test_unix_epoch_timestamps</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setenv</span><span class="s2">(</span><span class="s3">&quot;SOURCE_DATE_EPOCH&quot;</span><span class="s2">, </span><span class="s3">&quot;0&quot;</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>
    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">), </span><span class="s1">build_number</span><span class="s2">=</span><span class="s3">&quot;2a&quot;</span><span class="s2">).</span><span class="s1">run</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/dummy_dist-1.0-2a-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">zinfo </span><span class="s0">in </span><span class="s1">wf</span><span class="s2">.</span><span class="s1">filelist</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">zinfo</span><span class="s2">.</span><span class="s1">date_time </span><span class="s2">&gt;= (</span><span class="s7">1980</span><span class="s2">, </span><span class="s7">1</span><span class="s2">, </span><span class="s7">1</span><span class="s2">, </span><span class="s7">0</span><span class="s2">, </span><span class="s7">0</span><span class="s2">, </span><span class="s7">0</span><span class="s2">)  </span><span class="s4"># min epoch is used</span>


<span class="s0">def </span><span class="s1">test_get_abi_tag_windows</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">tags</span><span class="s2">, </span><span class="s3">&quot;interpreter_name&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s3">&quot;cp&quot;</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">sysconfig</span><span class="s2">, </span><span class="s3">&quot;get_config_var&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s3">&quot;cp313-win_amd64&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">get_abi_tag</span><span class="s2">() == </span><span class="s3">&quot;cp313&quot;</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">, </span><span class="s3">&quot;gettotalrefcount&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">get_abi_tag</span><span class="s2">() == </span><span class="s3">&quot;cp313d&quot;</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">sysconfig</span><span class="s2">, </span><span class="s3">&quot;get_config_var&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s3">&quot;cp313t-win_amd64&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">get_abi_tag</span><span class="s2">() == </span><span class="s3">&quot;cp313td&quot;</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">delattr</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">, </span><span class="s3">&quot;gettotalrefcount&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">get_abi_tag</span><span class="s2">() == </span><span class="s3">&quot;cp313t&quot;</span>


<span class="s0">def </span><span class="s1">test_get_abi_tag_pypy_old</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">tags</span><span class="s2">, </span><span class="s3">&quot;interpreter_name&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s3">&quot;pp&quot;</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">sysconfig</span><span class="s2">, </span><span class="s3">&quot;get_config_var&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s3">&quot;pypy36-pp73&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">get_abi_tag</span><span class="s2">() == </span><span class="s3">&quot;pypy36_pp73&quot;</span>


<span class="s0">def </span><span class="s1">test_get_abi_tag_pypy_new</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">sysconfig</span><span class="s2">, </span><span class="s3">&quot;get_config_var&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s3">&quot;pypy37-pp73-darwin&quot;</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">tags</span><span class="s2">, </span><span class="s3">&quot;interpreter_name&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s3">&quot;pp&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">get_abi_tag</span><span class="s2">() == </span><span class="s3">&quot;pypy37_pp73&quot;</span>


<span class="s0">def </span><span class="s1">test_get_abi_tag_graalpy</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span>
        <span class="s1">sysconfig</span><span class="s2">, </span><span class="s3">&quot;get_config_var&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s3">&quot;graalpy231-310-native-x86_64-linux&quot;</span>
    <span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">tags</span><span class="s2">, </span><span class="s3">&quot;interpreter_name&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s3">&quot;graalpy&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">get_abi_tag</span><span class="s2">() == </span><span class="s3">&quot;graalpy231_310_native&quot;</span>


<span class="s0">def </span><span class="s1">test_get_abi_tag_fallback</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">sysconfig</span><span class="s2">, </span><span class="s3">&quot;get_config_var&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s3">&quot;unknown-python-310&quot;</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">tags</span><span class="s2">, </span><span class="s3">&quot;interpreter_name&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s3">&quot;unknown-python&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">get_abi_tag</span><span class="s2">() == </span><span class="s3">&quot;unknown_python_310&quot;</span>


<span class="s0">def </span><span class="s1">test_platform_with_space</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Ensure building on platforms with a space in the name succeed.&quot;&quot;&quot;</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>
    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">plat_name</span><span class="s2">=</span><span class="s3">&quot;isilon onefs&quot;</span><span class="s2">).</span><span class="s1">run</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_data_dir_with_tag_build</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Setuptools allow authors to set PEP 440's local version segments 
    using ``egg_info.tag_build``. This should be reflected not only in the 
    ``.whl`` file name, but also in the ``.dist-info`` and ``.data`` dirs. 
    See pypa/setuptools#3997. 
    &quot;&quot;&quot;</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s3">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;&quot; 
            from setuptools import setup 
            setup(headers=[&quot;hello.h&quot;]) 
            &quot;&quot;&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;&quot; 
            [metadata] 
            name = test 
            version = 1.0 
 
            [options.data_files] 
            hello/world = file.txt 
 
            [egg_info] 
            tag_build = +what 
            tag_date = 0 
            &quot;&quot;&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;file.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;hello.h&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s0">for </span><span class="s1">file</span><span class="s2">, </span><span class="s1">content </span><span class="s0">in </span><span class="s1">files</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s3">&quot;w&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fh</span><span class="s2">:</span>
            <span class="s1">fh</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">cleandoc</span><span class="s2">(</span><span class="s1">content</span><span class="s2">))</span>

    <span class="s1">bdist_wheel_cmd</span><span class="s2">().</span><span class="s1">run</span><span class="s2">()</span>

    <span class="s4"># Ensure .whl, .dist-info and .data contain the local segment</span>
    <span class="s1">wheel_path </span><span class="s2">= </span><span class="s3">&quot;dist/test-1.0+what-py3-none-any.whl&quot;</span>
    <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">wheel_path</span><span class="s2">)</span>
    <span class="s1">entries </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">wheel_path</span><span class="s2">).</span><span class="s1">namelist</span><span class="s2">())</span>
    <span class="s0">for </span><span class="s1">expected </span><span class="s0">in </span><span class="s2">(</span>
        <span class="s3">&quot;test-1.0+what.data/headers/hello.h&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;test-1.0+what.data/data/hello/world/file.txt&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;test-1.0+what.dist-info/METADATA&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;test-1.0+what.dist-info/WHEEL&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">entries</span>

    <span class="s0">for </span><span class="s1">not_expected </span><span class="s0">in </span><span class="s2">(</span>
        <span class="s3">&quot;test.data/headers/hello.h&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;test-1.0.data/data/hello/world/file.txt&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;test.dist-info/METADATA&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;test-1.0.dist-info/WHEEL&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">not_expected </span><span class="s0">not in </span><span class="s1">entries</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;reported&quot;</span><span class="s2">, </span><span class="s3">&quot;expected&quot;</span><span class="s2">),</span>
    <span class="s2">[(</span><span class="s3">&quot;linux-x86_64&quot;</span><span class="s2">, </span><span class="s3">&quot;linux_i686&quot;</span><span class="s2">), (</span><span class="s3">&quot;linux-aarch64&quot;</span><span class="s2">, </span><span class="s3">&quot;linux_armv7l&quot;</span><span class="s2">)],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">platform</span><span class="s2">.</span><span class="s1">system</span><span class="s2">() != </span><span class="s3">&quot;Linux&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Only makes sense to test on Linux&quot;</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_platform_linux32</span><span class="s2">(</span><span class="s1">reported</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">, </span><span class="s3">&quot;calcsize&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s7">4</span><span class="s2">)</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">Distribution</span><span class="s2">()</span>
    <span class="s1">cmd </span><span class="s2">= </span><span class="s1">bdist_wheel</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">plat_name </span><span class="s2">= </span><span class="s1">reported</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">root_is_pure </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">actual </span><span class="s2">= </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">get_tag</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">actual </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_no_ctypes</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">_fake_import</span><span class="s2">(</span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;ctypes&quot;</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ModuleNotFoundError</span><span class="s2">(</span><span class="s3">f&quot;No module named </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">__import__</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">suppress</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">):</span>
        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">delitem</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">, </span><span class="s3">&quot;wheel.macosx_libfile&quot;</span><span class="s2">)</span>

    <span class="s4"># Install an importer shim that refuses to load ctypes</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">builtins</span><span class="s2">, </span><span class="s3">&quot;__import__&quot;</span><span class="s2">, </span><span class="s1">_fake_import</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ModuleNotFoundError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;No module named ctypes&quot;</span><span class="s2">):</span>
        <span class="s0">import </span><span class="s1">wheel</span><span class="s2">.</span><span class="s1">macosx_libfile  </span><span class="s4"># noqa: F401</span>

    <span class="s4"># Unload and reimport the bdist_wheel command module to make sure it won't try to</span>
    <span class="s4"># import ctypes</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">delitem</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">, </span><span class="s3">&quot;setuptools.command.bdist_wheel&quot;</span><span class="s2">)</span>

    <span class="s0">import </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">command</span><span class="s2">.</span><span class="s1">bdist_wheel  </span><span class="s4"># noqa: F401</span>


<span class="s0">def </span><span class="s1">test_dist_info_provided</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">dummy_dist</span><span class="s2">)</span>
    <span class="s1">distinfo </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;dummy_dist.dist-info&quot;</span>

    <span class="s1">distinfo</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">()</span>
    <span class="s2">(</span><span class="s1">distinfo </span><span class="s2">/ </span><span class="s3">&quot;METADATA&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s3">&quot;name: helloworld&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s4"># We don't control the metadata. According to PEP-517, &quot;The hook MAY also</span>
    <span class="s4"># create other files inside this directory, and a build frontend MUST</span>
    <span class="s4"># preserve&quot;.</span>
    <span class="s2">(</span><span class="s1">distinfo </span><span class="s2">/ </span><span class="s3">&quot;FOO&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s3">&quot;bar&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s1">bdist_wheel_cmd</span><span class="s2">(</span><span class="s1">bdist_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">), </span><span class="s1">dist_info_dir</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">distinfo</span><span class="s2">)).</span><span class="s1">run</span><span class="s2">()</span>
    <span class="s1">expected </span><span class="s2">= {</span>
        <span class="s3">&quot;dummy_dist-1.0.dist-info/FOO&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;dummy_dist-1.0.dist-info/RECORD&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/dummy_dist-1.0-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s1">files_found </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">wf</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">())</span>
    <span class="s4"># Check that all expected files are there.</span>
    <span class="s0">assert </span><span class="s1">expected </span><span class="s2">- </span><span class="s1">files_found </span><span class="s2">== </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s4"># Make sure there is no accidental egg-info bleeding into the wheel.</span>
    <span class="s0">assert not </span><span class="s2">[</span><span class="s1">path </span><span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">files_found </span><span class="s0">if </span><span class="s3">'egg-info' </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)]</span>


<span class="s0">def </span><span class="s1">test_allow_grace_period_parent_directory_license</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s4"># Motivation: https://github.com/pypa/setuptools/issues/4892</span>
    <span class="s4"># TODO: Remove this test after deprecation period is over</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s3">&quot;LICENSE.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;parent license&quot;</span><span class="s2">,  </span><span class="s4"># &lt;---- the license files are outside</span>
        <span class="s3">&quot;NOTICE.txt&quot;</span><span class="s2">: </span><span class="s3">&quot;parent notice&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;python&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                [project] 
                name = &quot;test-proj&quot; 
                dynamic = [&quot;version&quot;]      # &lt;---- testing dynamic will not break 
                [tool.setuptools.dynamic] 
                version.file = &quot;VERSION&quot; 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;setup.cfg&quot;</span><span class="s2">: </span><span class="s1">cleandoc</span><span class="s2">(</span>
                <span class="s3">&quot;&quot;&quot; 
                [metadata] 
                license_files = 
                  ../LICENSE.txt 
                  ../NOTICE.txt 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;VERSION&quot;</span><span class="s2">: </span><span class="s3">&quot;42&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
    <span class="s2">}</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">))</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">chdir</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;python&quot;</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Pattern '../.*.txt' cannot contain '..'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">SetuptoolsDeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">bdist_wheel_cmd</span><span class="s2">().</span><span class="s1">run</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s3">&quot;dist/test_proj-42-py3-none-any.whl&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">wf</span><span class="s2">:</span>
        <span class="s1">files_found </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">wf</span><span class="s2">.</span><span class="s1">namelist</span><span class="s2">())</span>
        <span class="s1">expected_files </span><span class="s2">= {</span>
            <span class="s3">&quot;test_proj-42.dist-info/licenses/LICENSE.txt&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;test_proj-42.dist-info/licenses/NOTICE.txt&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">expected_files </span><span class="s2">&lt;= </span><span class="s1">files_found</span>

        <span class="s1">metadata </span><span class="s2">= </span><span class="s1">wf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s3">&quot;test_proj-42.dist-info/METADATA&quot;</span><span class="s2">).</span><span class="s1">decode</span><span class="s2">(</span><span class="s3">&quot;utf8&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s3">&quot;License-File: LICENSE.txt&quot; </span><span class="s0">in </span><span class="s1">metadata</span>
        <span class="s0">assert </span><span class="s3">&quot;License-File: NOTICE.txt&quot; </span><span class="s0">in </span><span class="s1">metadata</span>
</pre>
</body>
</html>