<html>
<head>
<title>webdrivertools.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
webdrivertools.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright 2008-2011 Nokia Networks</span>
<span class="s0"># Copyright 2011-2016 Ryan Tomac, Ed Manlove and contributors</span>
<span class="s0"># Copyright 2016-     Robot Framework Foundation</span>
<span class="s0">#</span>
<span class="s0"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0"># you may not use this file except in compliance with the License.</span>
<span class="s0"># You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0"># Unless required by applicable law or agreed to in writing, software</span>
<span class="s0"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0"># See the License for the specific language governing permissions and</span>
<span class="s0"># limitations under the License.</span>
<span class="s2">import </span><span class="s1">ast</span>
<span class="s2">import </span><span class="s1">importlib</span>
<span class="s2">import </span><span class="s1">inspect</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">token</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">StringIO</span>
<span class="s2">from </span><span class="s1">tokenize </span><span class="s2">import </span><span class="s1">generate_tokens</span>

<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">api </span><span class="s2">import </span><span class="s1">logger</span>
<span class="s2">from </span><span class="s1">robot</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">ConnectionCache</span>
<span class="s2">from </span><span class="s1">selenium </span><span class="s2">import </span><span class="s1">webdriver</span>
<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver </span><span class="s2">import </span><span class="s1">FirefoxProfile</span>

<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">chrome</span><span class="s3">.</span><span class="s1">service </span><span class="s2">import </span><span class="s1">Service </span><span class="s2">as </span><span class="s1">ChromeService</span>
<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">service </span><span class="s2">import </span><span class="s1">Service </span><span class="s2">as </span><span class="s1">EdgeService</span>
<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">firefox</span><span class="s3">.</span><span class="s1">service </span><span class="s2">import </span><span class="s1">Service </span><span class="s2">as </span><span class="s1">FirefoxService</span>
<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">ie</span><span class="s3">.</span><span class="s1">service </span><span class="s2">import </span><span class="s1">Service </span><span class="s2">as </span><span class="s1">IeService</span>
<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">safari</span><span class="s3">.</span><span class="s1">service </span><span class="s2">import </span><span class="s1">Service </span><span class="s2">as </span><span class="s1">SafariService</span>

<span class="s2">from </span><span class="s1">SeleniumLibrary</span><span class="s3">.</span><span class="s1">keywords</span><span class="s3">.</span><span class="s1">webdrivertools</span><span class="s3">.</span><span class="s1">sl_file_detector </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">SelLibLocalFileDetector</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">SeleniumLibrary</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">path_formatter </span><span class="s2">import </span><span class="s1">_format_path</span>


<span class="s2">class </span><span class="s1">WebDriverCreator</span><span class="s3">:</span>

    <span class="s1">browser_names </span><span class="s3">= {</span>
        <span class="s4">&quot;googlechrome&quot;</span><span class="s3">: </span><span class="s4">&quot;chrome&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;gc&quot;</span><span class="s3">: </span><span class="s4">&quot;chrome&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;chrome&quot;</span><span class="s3">: </span><span class="s4">&quot;chrome&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;headlesschrome&quot;</span><span class="s3">: </span><span class="s4">&quot;headless_chrome&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;ff&quot;</span><span class="s3">: </span><span class="s4">&quot;firefox&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;firefox&quot;</span><span class="s3">: </span><span class="s4">&quot;firefox&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;headlessfirefox&quot;</span><span class="s3">: </span><span class="s4">&quot;headless_firefox&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;ie&quot;</span><span class="s3">: </span><span class="s4">&quot;ie&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;internetexplorer&quot;</span><span class="s3">: </span><span class="s4">&quot;ie&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;edge&quot;</span><span class="s3">: </span><span class="s4">&quot;edge&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;safari&quot;</span><span class="s3">: </span><span class="s4">&quot;safari&quot;</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">log_dir</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">log_dir </span><span class="s3">= </span><span class="s1">log_dir</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">selenium_options </span><span class="s3">= </span><span class="s1">SeleniumOptions</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">selenium_service </span><span class="s3">= </span><span class="s1">SeleniumService</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">create_driver</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">browser</span><span class="s3">,</span>
        <span class="s1">desired_capabilities</span><span class="s3">,</span>
        <span class="s1">remote_url</span><span class="s3">,</span>
        <span class="s1">profile_dir</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">options</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">service_log_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">executable_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">service</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">browser </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_normalise_browser_name</span><span class="s3">(</span><span class="s1">browser</span><span class="s3">)</span>
        <span class="s1">creation_method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_creator_method</span><span class="s3">(</span><span class="s1">browser</span><span class="s3">)</span>
        <span class="s1">desired_capabilities </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parse_capabilities</span><span class="s3">(</span><span class="s1">desired_capabilities</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">)</span>
        <span class="s1">service_log_path </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_log_path</span><span class="s3">(</span><span class="s1">service_log_path</span><span class="s3">)</span>
        <span class="s1">options </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selenium_options</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">browser_names</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">browser</span><span class="s3">), </span><span class="s1">options</span><span class="s3">)</span>
        <span class="s1">service </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selenium_service</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">browser_names</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">browser</span><span class="s3">), </span><span class="s1">service</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">service_log_path</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;Browser driver log file created to: </span><span class="s2">{</span><span class="s1">service_log_path</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_create_directory</span><span class="s3">(</span><span class="s1">service_log_path</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s1">creation_method </span><span class="s3">== </span><span class="s1">self</span><span class="s3">.</span><span class="s1">create_firefox</span>
            <span class="s2">or </span><span class="s1">creation_method </span><span class="s3">== </span><span class="s1">self</span><span class="s3">.</span><span class="s1">create_headless_firefox</span>
        <span class="s3">):</span>
            <span class="s2">return </span><span class="s1">creation_method</span><span class="s3">(</span>
                <span class="s1">desired_capabilities</span><span class="s3">,</span>
                <span class="s1">remote_url</span><span class="s3">,</span>
                <span class="s1">profile_dir</span><span class="s3">,</span>
                <span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">,</span>
                <span class="s1">service_log_path</span><span class="s3">=</span><span class="s1">service_log_path</span><span class="s3">,</span>
                <span class="s1">executable_path</span><span class="s3">=</span><span class="s1">executable_path</span><span class="s3">,</span>
                <span class="s1">service</span><span class="s3">=</span><span class="s1">service</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">creation_method</span><span class="s3">(</span>
            <span class="s1">desired_capabilities</span><span class="s3">,</span>
            <span class="s1">remote_url</span><span class="s3">,</span>
            <span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">,</span>
            <span class="s1">service_log_path</span><span class="s3">=</span><span class="s1">service_log_path</span><span class="s3">,</span>
            <span class="s1">executable_path</span><span class="s3">=</span><span class="s1">executable_path</span><span class="s3">,</span>
            <span class="s1">service</span><span class="s3">=</span><span class="s1">service</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_creator_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">browser </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">browser_names</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s4">f&quot;create_</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">browser_names</span><span class="s3">[</span><span class="s1">browser</span><span class="s3">]</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">browser</span><span class="s2">} </span><span class="s4">is not a supported browser.&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_parse_capabilities</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">capabilities</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">capabilities</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">{}</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">capabilities</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
            <span class="s1">capabilities </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_string_to_dict</span><span class="s3">(</span><span class="s1">capabilities</span><span class="s3">)</span>
        <span class="s1">browser </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">browser_names</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">browser</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">browser </span><span class="s2">in </span><span class="s3">[</span><span class="s4">&quot;ie&quot;</span><span class="s3">, </span><span class="s4">&quot;firefox&quot;</span><span class="s3">, </span><span class="s4">&quot;edge&quot;</span><span class="s3">]:</span>
            <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;capabilities&quot;</span><span class="s3">: </span><span class="s1">capabilities</span><span class="s3">}</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;desired_capabilities&quot;</span><span class="s3">: </span><span class="s1">capabilities</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">_string_to_dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">capabilities</span><span class="s3">):</span>
        <span class="s1">desired_capabilities </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">part </span><span class="s2">in </span><span class="s1">capabilities</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;,&quot;</span><span class="s3">):</span>
            <span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s3">= </span><span class="s1">part</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;:&quot;</span><span class="s3">)</span>
            <span class="s1">desired_capabilities</span><span class="s3">[</span><span class="s1">key</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()] = </span><span class="s1">value</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">desired_capabilities</span>

    <span class="s2">def </span><span class="s1">_remote_capabilities_resolver</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">set_capabilities</span><span class="s3">, </span><span class="s1">default_capabilities</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">set_capabilities</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;desired_capabilities&quot;</span><span class="s3">: </span><span class="s1">default_capabilities</span><span class="s3">}</span>
        <span class="s2">if </span><span class="s4">&quot;capabilities&quot; </span><span class="s2">in </span><span class="s1">set_capabilities</span><span class="s3">:</span>
            <span class="s1">caps </span><span class="s3">= </span><span class="s1">set_capabilities</span><span class="s3">[</span><span class="s4">&quot;capabilities&quot;</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">caps </span><span class="s3">= </span><span class="s1">set_capabilities</span><span class="s3">[</span><span class="s4">&quot;desired_capabilities&quot;</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s4">&quot;browserName&quot; </span><span class="s2">not in </span><span class="s1">caps</span><span class="s3">:</span>
            <span class="s1">caps</span><span class="s3">[</span><span class="s4">&quot;browserName&quot;</span><span class="s3">] = </span><span class="s1">default_capabilities</span><span class="s3">[</span><span class="s4">&quot;browserName&quot;</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;desired_capabilities&quot;</span><span class="s3">: </span><span class="s1">caps</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">_get_log_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">service_cls</span><span class="s3">, </span><span class="s1">service_log_path</span><span class="s3">):</span>
        <span class="s0"># -- temporary fix to transition selenium to v4.13 from v4.11 and prior</span>
        <span class="s2">from </span><span class="s1">inspect </span><span class="s2">import </span><span class="s1">signature</span>
        <span class="s1">sig </span><span class="s3">= </span><span class="s1">signature</span><span class="s3">(</span><span class="s1">service_cls</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s4">'log_output' </span><span class="s2">in </span><span class="s1">str</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">{</span><span class="s4">'log_output'</span><span class="s3">: </span><span class="s1">service_log_path</span><span class="s3">}</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">{</span><span class="s4">'log_path'</span><span class="s3">: </span><span class="s1">service_log_path</span><span class="s3">}</span>
        <span class="s0"># --</span>

    <span class="s2">def </span><span class="s1">create_chrome</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">desired_capabilities</span><span class="s3">,</span>
        <span class="s1">remote_url</span><span class="s3">,</span>
        <span class="s1">options</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">service_log_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">executable_path</span><span class="s3">=</span><span class="s4">&quot;chromedriver&quot;</span><span class="s3">,</span>
        <span class="s1">service</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">if </span><span class="s1">remote_url</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">options</span><span class="s3">:</span>
                <span class="s1">options </span><span class="s3">= </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">ChromeOptions</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_remote</span><span class="s3">(</span><span class="s1">remote_url</span><span class="s3">, </span><span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">executable_path</span><span class="s3">:</span>
            <span class="s1">executable_path </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_executable_path</span><span class="s3">(</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">chrome</span><span class="s3">.</span><span class="s1">service</span><span class="s3">.</span><span class="s1">Service</span><span class="s3">)</span>
        <span class="s1">log_method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_log_method</span><span class="s3">(</span><span class="s1">ChromeService</span><span class="s3">, </span><span class="s1">service_log_path</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">service</span><span class="s3">:</span>
            <span class="s1">service </span><span class="s3">= </span><span class="s1">ChromeService</span><span class="s3">(</span><span class="s1">executable_path</span><span class="s3">=</span><span class="s1">executable_path</span><span class="s3">, **</span><span class="s1">log_method</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">Chrome</span><span class="s3">(</span>
            <span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">,</span>
            <span class="s1">service</span><span class="s3">=</span><span class="s1">service</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">create_headless_chrome</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">desired_capabilities</span><span class="s3">,</span>
        <span class="s1">remote_url</span><span class="s3">,</span>
        <span class="s1">options</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">service_log_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">executable_path</span><span class="s3">=</span><span class="s4">&quot;chromedriver&quot;</span><span class="s3">,</span>
        <span class="s1">service</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">options</span><span class="s3">:</span>
            <span class="s1">options </span><span class="s3">= </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">ChromeOptions</span><span class="s3">()</span>
        <span class="s1">options</span><span class="s3">.</span><span class="s1">add_argument</span><span class="s3">(</span><span class="s4">'--headless=new'</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">create_chrome</span><span class="s3">(</span>
            <span class="s1">desired_capabilities</span><span class="s3">, </span><span class="s1">remote_url</span><span class="s3">, </span><span class="s1">options</span><span class="s3">, </span><span class="s1">service_log_path</span><span class="s3">, </span><span class="s1">executable_path</span><span class="s3">, </span><span class="s1">service</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_executable_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">webdriver</span><span class="s3">):</span>
        <span class="s1">signature </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">)</span>
        <span class="s1">parameters </span><span class="s3">= </span><span class="s1">signature</span><span class="s3">.</span><span class="s1">parameters</span>
        <span class="s1">executable_path </span><span class="s3">= </span><span class="s1">parameters</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;executable_path&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">executable_path</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">return </span><span class="s1">executable_path</span><span class="s3">.</span><span class="s1">default</span>

    <span class="s2">def </span><span class="s1">create_firefox</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">desired_capabilities</span><span class="s3">,</span>
        <span class="s1">remote_url</span><span class="s3">,</span>
        <span class="s1">ff_profile_dir</span><span class="s3">,</span>
        <span class="s1">options</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">service_log_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">executable_path</span><span class="s3">=</span><span class="s4">&quot;geckodriver&quot;</span><span class="s3">,</span>
        <span class="s1">service</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">profile </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_ff_profile</span><span class="s3">(</span><span class="s1">ff_profile_dir</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">options</span><span class="s3">:</span>
            <span class="s1">options </span><span class="s3">= </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">FirefoxOptions</span><span class="s3">()</span>
        <span class="s1">options</span><span class="s3">.</span><span class="s1">profile </span><span class="s3">= </span><span class="s1">profile  </span><span class="s0"># &lt;- moved to here :)</span>

        <span class="s0"># Something I question here is/was whether or not we should create the option, not</span>
        <span class="s0"># only on whether it exists, but if there is a profile provided. That is previously we just pass</span>
        <span class="s0"># None along as options if there were none. But now no matter what we create an Options class so</span>
        <span class="s0"># as to attach the profile to it. If there a scenario in which we don't want to do this???</span>

        <span class="s2">if </span><span class="s1">remote_url</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_remote</span><span class="s3">(</span><span class="s1">remote_url</span><span class="s3">, </span><span class="s1">options</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">executable_path</span><span class="s3">:</span>
            <span class="s1">executable_path </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_executable_path</span><span class="s3">(</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">firefox</span><span class="s3">.</span><span class="s1">service</span><span class="s3">.</span><span class="s1">Service</span><span class="s3">)</span>
        <span class="s1">log_method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_log_method</span><span class="s3">(</span><span class="s1">FirefoxService</span><span class="s3">, </span><span class="s1">service_log_path </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_geckodriver_log</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">service </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">service </span><span class="s3">= </span><span class="s1">FirefoxService</span><span class="s3">(</span><span class="s1">executable_path</span><span class="s3">=</span><span class="s1">executable_path</span><span class="s3">, **</span><span class="s1">log_method</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">Firefox</span><span class="s3">(</span>
            <span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">,</span>
            <span class="s1">service</span><span class="s3">=</span><span class="s1">service</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_ff_profile</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">ff_profile_dir</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ff_profile_dir</span><span class="s3">, </span><span class="s1">FirefoxProfile</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">ff_profile_dir</span>
        <span class="s2">if not </span><span class="s1">ff_profile_dir</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">FirefoxProfile</span><span class="s3">()</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">FirefoxProfile</span><span class="s3">(</span><span class="s1">ff_profile_dir</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s3">(</span><span class="s1">OSError</span><span class="s3">, </span><span class="s1">FileNotFoundError</span><span class="s3">):</span>
            <span class="s1">ff_options </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selenium_options</span><span class="s3">.</span><span class="s1">_parse</span><span class="s3">(</span><span class="s1">ff_profile_dir</span><span class="s3">)</span>
            <span class="s1">ff_profile </span><span class="s3">= </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">FirefoxProfile</span><span class="s3">()</span>
            <span class="s2">for </span><span class="s1">option </span><span class="s2">in </span><span class="s1">ff_options</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">option</span><span class="s3">:</span>
                    <span class="s1">attr </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">ff_profile</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">callable</span><span class="s3">(</span><span class="s1">attr</span><span class="s3">):</span>
                        <span class="s1">attr</span><span class="s3">(*</span><span class="s1">option</span><span class="s3">[</span><span class="s1">key</span><span class="s3">])</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">setattr</span><span class="s3">(</span><span class="s1">ff_profile</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, *</span><span class="s1">option</span><span class="s3">[</span><span class="s1">key</span><span class="s3">])</span>
            <span class="s2">return </span><span class="s1">ff_profile</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_geckodriver_log</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">log_file </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_log_path</span><span class="s3">(</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">log_dir</span><span class="s3">, </span><span class="s4">&quot;geckodriver-{index}.log&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">(</span><span class="s4">f&quot;Firefox driver log is always forced to to: </span><span class="s2">{</span><span class="s1">log_file</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">log_file</span>

    <span class="s2">def </span><span class="s1">create_headless_firefox</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">desired_capabilities</span><span class="s3">,</span>
        <span class="s1">remote_url</span><span class="s3">,</span>
        <span class="s1">ff_profile_dir</span><span class="s3">,</span>
        <span class="s1">options</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">service_log_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">executable_path</span><span class="s3">=</span><span class="s4">&quot;geckodriver&quot;</span><span class="s3">,</span>
        <span class="s1">service</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">options</span><span class="s3">:</span>
            <span class="s1">options </span><span class="s3">= </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">FirefoxOptions</span><span class="s3">()</span>
        <span class="s1">options</span><span class="s3">.</span><span class="s1">add_argument</span><span class="s3">(</span><span class="s4">'-headless'</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">create_firefox</span><span class="s3">(</span>
            <span class="s1">desired_capabilities</span><span class="s3">,</span>
            <span class="s1">remote_url</span><span class="s3">,</span>
            <span class="s1">ff_profile_dir</span><span class="s3">,</span>
            <span class="s1">options</span><span class="s3">,</span>
            <span class="s1">service_log_path</span><span class="s3">,</span>
            <span class="s1">executable_path</span><span class="s3">,</span>
            <span class="s1">service</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">create_ie</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">desired_capabilities</span><span class="s3">,</span>
        <span class="s1">remote_url</span><span class="s3">,</span>
        <span class="s1">options</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">service_log_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">executable_path</span><span class="s3">=</span><span class="s4">&quot;IEDriverServer.exe&quot;</span><span class="s3">,</span>
        <span class="s1">service</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">if </span><span class="s1">remote_url</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">options</span><span class="s3">:</span>
                <span class="s1">options </span><span class="s3">= </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">IeOptions</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_remote</span><span class="s3">(</span><span class="s1">remote_url</span><span class="s3">, </span><span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">executable_path</span><span class="s3">:</span>
            <span class="s1">executable_path </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_executable_path</span><span class="s3">(</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">ie</span><span class="s3">.</span><span class="s1">service</span><span class="s3">.</span><span class="s1">Service</span><span class="s3">)</span>
        <span class="s1">log_method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_log_method</span><span class="s3">(</span><span class="s1">IeService</span><span class="s3">, </span><span class="s1">service_log_path</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">service </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">service </span><span class="s3">= </span><span class="s1">IeService</span><span class="s3">(</span><span class="s1">executable_path</span><span class="s3">=</span><span class="s1">executable_path</span><span class="s3">, **</span><span class="s1">log_method</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">Ie</span><span class="s3">(</span>
            <span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">,</span>
            <span class="s1">service</span><span class="s3">=</span><span class="s1">service</span><span class="s3">,</span>
            <span class="s0">#**desired_capabilities,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_has_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">web_driver</span><span class="s3">):</span>
        <span class="s1">signature </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">web_driver</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s4">&quot;options&quot; </span><span class="s2">in </span><span class="s1">signature</span><span class="s3">.</span><span class="s1">parameters</span>

    <span class="s2">def </span><span class="s1">create_edge</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">desired_capabilities</span><span class="s3">,</span>
        <span class="s1">remote_url</span><span class="s3">,</span>
        <span class="s1">options</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">service_log_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">executable_path</span><span class="s3">=</span><span class="s4">&quot;msedgedriver&quot;</span><span class="s3">,</span>
        <span class="s1">service</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">if </span><span class="s1">remote_url</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">options</span><span class="s3">:</span>
                <span class="s1">options </span><span class="s3">= </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">EdgeOptions</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_remote</span><span class="s3">(</span><span class="s1">remote_url</span><span class="s3">, </span><span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">executable_path</span><span class="s3">:</span>
            <span class="s1">executable_path </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_executable_path</span><span class="s3">(</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">service</span><span class="s3">.</span><span class="s1">Service</span><span class="s3">)</span>
        <span class="s1">log_method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_log_method</span><span class="s3">(</span><span class="s1">EdgeService</span><span class="s3">, </span><span class="s1">service_log_path</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">service </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">service </span><span class="s3">= </span><span class="s1">EdgeService</span><span class="s3">(</span><span class="s1">executable_path</span><span class="s3">=</span><span class="s1">executable_path</span><span class="s3">, **</span><span class="s1">log_method</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">Edge</span><span class="s3">(</span>
            <span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">,</span>
            <span class="s1">service</span><span class="s3">=</span><span class="s1">service</span><span class="s3">,</span>
            <span class="s0">#**desired_capabilities,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">create_safari</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">desired_capabilities</span><span class="s3">,</span>
        <span class="s1">remote_url</span><span class="s3">,</span>
        <span class="s1">options</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">service_log_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">executable_path</span><span class="s3">=</span><span class="s4">&quot;/usr/bin/safaridriver&quot;</span><span class="s3">,</span>
        <span class="s1">service</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">if </span><span class="s1">remote_url</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">options</span><span class="s3">:</span>
                <span class="s1">options </span><span class="s3">= </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">SafariOptions</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_remote</span><span class="s3">(</span><span class="s1">remote_url</span><span class="s3">, </span><span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">executable_path</span><span class="s3">:</span>
            <span class="s1">executable_path </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_executable_path</span><span class="s3">(</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">Safari</span><span class="s3">)</span>
        <span class="s1">log_method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_log_method</span><span class="s3">(</span><span class="s1">SafariService</span><span class="s3">, </span><span class="s1">service_log_path</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">service </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">service </span><span class="s3">= </span><span class="s1">SafariService</span><span class="s3">(</span><span class="s1">executable_path</span><span class="s3">=</span><span class="s1">executable_path</span><span class="s3">, **</span><span class="s1">log_method</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">Safari</span><span class="s3">(</span><span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">, </span><span class="s1">service</span><span class="s3">=</span><span class="s1">service</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_remote</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">remote_url</span><span class="s3">, </span><span class="s1">options</span><span class="s3">):</span>
        <span class="s1">remote_url </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">remote_url</span><span class="s3">)</span>
        <span class="s1">file_detector </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_sl_file_detector</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">Remote</span><span class="s3">(</span>
            <span class="s1">command_executor</span><span class="s3">=</span><span class="s1">remote_url</span><span class="s3">,</span>
            <span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">,</span>
            <span class="s1">file_detector</span><span class="s3">=</span><span class="s1">file_detector</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_sl_file_detector</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># To ease unit testing.</span>
        <span class="s2">return </span><span class="s1">SelLibLocalFileDetector</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_get_log_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">log_file</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">log_file </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s1">formatted </span><span class="s3">= </span><span class="s1">_format_path</span><span class="s3">(</span><span class="s1">log_file</span><span class="s3">, </span><span class="s1">index</span><span class="s3">)</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">log_dir</span><span class="s3">, </span><span class="s1">formatted</span><span class="s3">)</span>
            <span class="s0"># filename didn't contain {index} or unique path was found</span>
            <span class="s2">if </span><span class="s1">formatted </span><span class="s3">== </span><span class="s1">log_file </span><span class="s2">or not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">path</span>
            <span class="s1">index </span><span class="s3">+= </span><span class="s5">1</span>

    <span class="s2">def </span><span class="s1">_create_directory</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s1">target_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">target_dir</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_normalise_browser_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">browser</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot; &quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">WebDriverCache</span><span class="s3">(</span><span class="s1">ConnectionCache</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">ConnectionCache</span><span class="s3">.</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">no_current_msg</span><span class="s3">=</span><span class="s4">&quot;No current browser&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_closed </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">drivers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">active_drivers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">open_drivers </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">driver </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">driver </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_closed</span><span class="s3">:</span>
                <span class="s1">open_drivers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">open_drivers</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">active_driver_ids</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">open_driver_ids </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">index</span><span class="s3">, </span><span class="s1">driver </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">driver </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_closed</span><span class="s3">:</span>
                <span class="s1">open_driver_ids</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">index </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">open_driver_ids</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">active_aliases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_aliases</span>

    <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current</span><span class="s3">:</span>
            <span class="s1">driver </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current</span>
            <span class="s1">error </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_quit</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">alias </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_aliases</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_aliases</span><span class="s3">[</span><span class="s1">alias</span><span class="s3">] == </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current_index</span><span class="s3">:</span>
                    <span class="s2">del </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_aliases</span><span class="s3">[</span><span class="s1">alias</span><span class="s3">]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">current </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_no_current</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_closed</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">error</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">error</span>

    <span class="s2">def </span><span class="s1">close_all</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">error </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">for </span><span class="s1">driver </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connections</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">driver </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_closed</span><span class="s3">:</span>
                <span class="s1">error </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_quit</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">error</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">empty_cache</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">error</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">error</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current</span>

    <span class="s2">def </span><span class="s1">_quit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">driver</span><span class="s3">, </span><span class="s1">error</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">driver</span><span class="s3">.</span><span class="s1">quit</span><span class="s3">()</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">exception</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">f&quot;When closing browser, received exception: </span><span class="s2">{</span><span class="s1">exception</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s1">error </span><span class="s3">= </span><span class="s1">exception</span>
        <span class="s2">return </span><span class="s1">error</span>

    <span class="s2">def </span><span class="s1">get_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">alias_or_index</span><span class="s3">):</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_index</span><span class="s3">(</span><span class="s1">alias_or_index</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">driver </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_connection</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">RuntimeError</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">return None if </span><span class="s1">driver </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_closed </span><span class="s2">else </span><span class="s1">index</span>

    <span class="s2">def </span><span class="s1">_get_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">alias_or_index</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">resolve_alias_or_index</span><span class="s3">(</span><span class="s1">alias_or_index</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
            <span class="s2">pass</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s0"># TODO: This try/except block can be removed when minimum</span>
        <span class="s0">#  required Robot Framework version is 3.3 or greater.</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_alias_or_index</span><span class="s3">(</span><span class="s1">alias_or_index</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s2">return None</span>

<span class="s2">class </span><span class="s1">SeleniumService</span><span class="s3">:</span>
    <span class="s6">&quot;&quot;&quot; 
 
    &quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">create</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">, </span><span class="s1">service</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">service</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s1">selenium_service </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_import_service</span><span class="s3">(</span><span class="s1">browser</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">service</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">service</span>

        <span class="s0"># Throw error is used with remote .. &quot;They cannot be used with a Remote WebDriver session.&quot; [ref doc]</span>
        <span class="s1">attrs </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parse</span><span class="s3">(</span><span class="s1">service</span><span class="s3">)</span>
        <span class="s0"># verify attribute a member of service class parameters</span>
        <span class="s1">service_parameters </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">selenium_service</span><span class="s3">).</span><span class="s1">parameters</span>
        <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">attrs</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">key </span><span class="s2">not in </span><span class="s1">service_parameters</span><span class="s3">:</span>
                <span class="s1">service_module </span><span class="s3">= </span><span class="s4">'.'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">((</span><span class="s1">selenium_service</span><span class="s3">.</span><span class="s1">__module__</span><span class="s3">, </span><span class="s1">selenium_service</span><span class="s3">.</span><span class="s1">__qualname__</span><span class="s3">))</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">key</span><span class="s2">} </span><span class="s4">is not a member of </span><span class="s2">{</span><span class="s1">service_module</span><span class="s2">} </span><span class="s4">Service class&quot;</span><span class="s3">)</span>
        <span class="s1">selenium_service_inst </span><span class="s3">= </span><span class="s1">selenium_service</span><span class="s3">(**</span><span class="s1">attrs</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">selenium_service_inst</span>

    <span class="s2">def </span><span class="s1">_parse</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">service</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;The service argument parses slightly different than the options argument. As of 
        Selenium v4.20.0, all the service items are arguments applied to the service class 
        instantiation. Thus each item is split instead parsed as done with options. 
        &quot;&quot;&quot;</span>
        <span class="s1">result </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_split</span><span class="s3">(</span><span class="s1">service</span><span class="s3">,</span><span class="s4">';'</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">attr</span><span class="s3">, </span><span class="s1">val </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_split</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s4">'='</span><span class="s3">)</span>
                <span class="s1">result</span><span class="s3">[</span><span class="s1">attr</span><span class="s3">]=</span><span class="s1">ast</span><span class="s3">.</span><span class="s1">literal_eval</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">SyntaxError</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f'Unable to parse service: &quot;</span><span class="s2">{</span><span class="s1">item</span><span class="s2">}</span><span class="s4">&quot;'</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">_import_service</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">):</span>
        <span class="s1">browser </span><span class="s3">= </span><span class="s1">browser</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;headless_&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s0"># Throw error is used with remote .. &quot;They cannot be used with a Remote WebDriver session.&quot; [ref doc]</span>
        <span class="s1">service </span><span class="s3">= </span><span class="s1">importlib</span><span class="s3">.</span><span class="s1">import_module</span><span class="s3">(</span><span class="s4">f&quot;selenium.webdriver.</span><span class="s2">{</span><span class="s1">browser</span><span class="s2">}</span><span class="s4">.service&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">service</span><span class="s3">.</span><span class="s1">Service</span>

    <span class="s2">def </span><span class="s1">_split</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">service_or_attr</span><span class="s3">, </span><span class="s1">splittok</span><span class="s3">):</span>
        <span class="s1">split_string </span><span class="s3">= []</span>
        <span class="s1">start_position </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">tokens </span><span class="s3">= </span><span class="s1">generate_tokens</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">service_or_attr</span><span class="s3">).</span><span class="s1">readline</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">toknum</span><span class="s3">, </span><span class="s1">tokval</span><span class="s3">, </span><span class="s1">tokpos</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">tokens</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">toknum </span><span class="s3">== </span><span class="s1">token</span><span class="s3">.</span><span class="s1">OP </span><span class="s2">and </span><span class="s1">tokval </span><span class="s3">== </span><span class="s1">splittok</span><span class="s3">:</span>
                <span class="s1">split_string</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">service_or_attr</span><span class="s3">[</span><span class="s1">start_position </span><span class="s3">: </span><span class="s1">tokpos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]].</span><span class="s1">strip</span><span class="s3">())</span>
                <span class="s1">start_position </span><span class="s3">= </span><span class="s1">tokpos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] + </span><span class="s5">1</span>
        <span class="s1">split_string</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">service_or_attr</span><span class="s3">[</span><span class="s1">start_position</span><span class="s3">:])</span>
        <span class="s2">return </span><span class="s1">split_string</span>

<span class="s2">class </span><span class="s1">SeleniumOptions</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">create</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">, </span><span class="s1">options</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">options</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s1">selenium_options </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_import_options</span><span class="s3">(</span><span class="s1">browser</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">options</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">options</span>
        <span class="s1">options </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parse</span><span class="s3">(</span><span class="s1">options</span><span class="s3">)</span>
        <span class="s1">selenium_options </span><span class="s3">= </span><span class="s1">selenium_options</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">option </span><span class="s2">in </span><span class="s1">options</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">option</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">key </span><span class="s3">== </span><span class="s4">'' </span><span class="s2">and </span><span class="s1">option</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]==[]:</span>
                    <span class="s1">logger</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">'Empty selenium option found and ignored. Suggested you review options passed to `Open Browser` keyword'</span><span class="s3">)</span>
                    <span class="s2">continue</span>
                <span class="s1">attr </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">selenium_options</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">callable</span><span class="s3">(</span><span class="s1">attr</span><span class="s3">):</span>
                    <span class="s1">attr</span><span class="s3">(*</span><span class="s1">option</span><span class="s3">[</span><span class="s1">key</span><span class="s3">])</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">setattr</span><span class="s3">(</span><span class="s1">selenium_options</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, *</span><span class="s1">option</span><span class="s3">[</span><span class="s1">key</span><span class="s3">])</span>
        <span class="s2">return </span><span class="s1">selenium_options</span>

    <span class="s2">def </span><span class="s1">_import_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">):</span>
        <span class="s1">browser </span><span class="s3">= </span><span class="s1">browser</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;headless_&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">options </span><span class="s3">= </span><span class="s1">importlib</span><span class="s3">.</span><span class="s1">import_module</span><span class="s3">(</span><span class="s4">f&quot;selenium.webdriver.</span><span class="s2">{</span><span class="s1">browser</span><span class="s2">}</span><span class="s4">.options&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">options</span><span class="s3">.</span><span class="s1">Options</span>

    <span class="s2">def </span><span class="s1">_parse_to_tokens</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">item</span><span class="s3">):</span>
        <span class="s1">result </span><span class="s3">= {}</span>
        <span class="s1">index</span><span class="s3">, </span><span class="s1">method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_arument_index</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">index </span><span class="s3">== -</span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">result</span><span class="s3">[</span><span class="s1">item</span><span class="s3">] = []</span>
            <span class="s2">return </span><span class="s1">result</span>
        <span class="s2">if </span><span class="s1">method</span><span class="s3">:</span>
            <span class="s1">args_as_string </span><span class="s3">= </span><span class="s1">item</span><span class="s3">[</span><span class="s1">index </span><span class="s3">+ </span><span class="s5">1 </span><span class="s3">: -</span><span class="s5">1</span><span class="s3">].</span><span class="s1">strip</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">args_as_string</span><span class="s3">:</span>
                <span class="s1">args </span><span class="s3">= </span><span class="s1">ast</span><span class="s3">.</span><span class="s1">literal_eval</span><span class="s3">(</span><span class="s1">args_as_string</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">args </span><span class="s3">= </span><span class="s1">args_as_string</span>
            <span class="s1">is_tuple </span><span class="s3">= </span><span class="s1">args_as_string</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;(&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">args_as_string </span><span class="s3">= </span><span class="s1">item</span><span class="s3">[</span><span class="s1">index </span><span class="s3">+ </span><span class="s5">1 </span><span class="s3">:].</span><span class="s1">strip</span><span class="s3">()</span>
            <span class="s1">args </span><span class="s3">= </span><span class="s1">ast</span><span class="s3">.</span><span class="s1">literal_eval</span><span class="s3">(</span><span class="s1">args_as_string</span><span class="s3">)</span>
            <span class="s1">is_tuple </span><span class="s3">= </span><span class="s1">args_as_string</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;(&quot;</span><span class="s3">)</span>
        <span class="s1">method_or_attribute </span><span class="s3">= </span><span class="s1">item</span><span class="s3">[:</span><span class="s1">index</span><span class="s3">].</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s1">result</span><span class="s3">[</span><span class="s1">method_or_attribute</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parse_arguments</span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">is_tuple</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">_parse_arguments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">argument</span><span class="s3">, </span><span class="s1">is_tuple</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">argument </span><span class="s3">== </span><span class="s4">&quot;&quot;</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">[]</span>
        <span class="s2">if </span><span class="s1">is_tuple</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">[</span><span class="s1">argument</span><span class="s3">]</span>
        <span class="s2">if not </span><span class="s1">is_tuple </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">argument</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">list</span><span class="s3">(</span><span class="s1">argument</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">argument</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">_parse</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">options</span><span class="s3">):</span>
        <span class="s1">result </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_split</span><span class="s3">(</span><span class="s1">options</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">result</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parse_to_tokens</span><span class="s3">(</span><span class="s1">item</span><span class="s3">))</span>
            <span class="s2">except </span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">SyntaxError</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f'Unable to parse option: &quot;</span><span class="s2">{</span><span class="s1">item</span><span class="s2">}</span><span class="s4">&quot;'</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">_parse_to_tokens</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">item</span><span class="s3">):</span>
        <span class="s1">result </span><span class="s3">= {}</span>
        <span class="s1">index</span><span class="s3">, </span><span class="s1">method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_arument_index</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">index </span><span class="s3">== -</span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">result</span><span class="s3">[</span><span class="s1">item</span><span class="s3">] = []</span>
            <span class="s2">return </span><span class="s1">result</span>
        <span class="s2">if </span><span class="s1">method</span><span class="s3">:</span>
            <span class="s1">args_as_string </span><span class="s3">= </span><span class="s1">item</span><span class="s3">[</span><span class="s1">index </span><span class="s3">+ </span><span class="s5">1 </span><span class="s3">: -</span><span class="s5">1</span><span class="s3">].</span><span class="s1">strip</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">args_as_string</span><span class="s3">:</span>
                <span class="s1">args </span><span class="s3">= </span><span class="s1">ast</span><span class="s3">.</span><span class="s1">literal_eval</span><span class="s3">(</span><span class="s1">args_as_string</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">args </span><span class="s3">= </span><span class="s1">args_as_string</span>
            <span class="s1">is_tuple </span><span class="s3">= </span><span class="s1">args_as_string</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;(&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">args_as_string </span><span class="s3">= </span><span class="s1">item</span><span class="s3">[</span><span class="s1">index </span><span class="s3">+ </span><span class="s5">1 </span><span class="s3">:].</span><span class="s1">strip</span><span class="s3">()</span>
            <span class="s1">args </span><span class="s3">= </span><span class="s1">ast</span><span class="s3">.</span><span class="s1">literal_eval</span><span class="s3">(</span><span class="s1">args_as_string</span><span class="s3">)</span>
            <span class="s1">is_tuple </span><span class="s3">= </span><span class="s1">args_as_string</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;(&quot;</span><span class="s3">)</span>
        <span class="s1">method_or_attribute </span><span class="s3">= </span><span class="s1">item</span><span class="s3">[:</span><span class="s1">index</span><span class="s3">].</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s1">result</span><span class="s3">[</span><span class="s1">method_or_attribute</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parse_arguments</span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">is_tuple</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">_parse_arguments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">argument</span><span class="s3">, </span><span class="s1">is_tuple</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">argument </span><span class="s3">== </span><span class="s4">&quot;&quot;</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">[]</span>
        <span class="s2">if </span><span class="s1">is_tuple</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">[</span><span class="s1">argument</span><span class="s3">]</span>
        <span class="s2">if not </span><span class="s1">is_tuple </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">argument</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">list</span><span class="s3">(</span><span class="s1">argument</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">argument</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">_get_arument_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">item</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s4">&quot;=&quot; </span><span class="s2">not in </span><span class="s1">item</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">item</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">&quot;(&quot;</span><span class="s3">), </span><span class="s2">True</span>
        <span class="s2">if </span><span class="s4">&quot;(&quot; </span><span class="s2">not in </span><span class="s1">item</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">item</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">&quot;=&quot;</span><span class="s3">), </span><span class="s2">False</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">item</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">&quot;(&quot;</span><span class="s3">), </span><span class="s1">item</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">&quot;=&quot;</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">index</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">&quot;(&quot;</span><span class="s3">) == </span><span class="s1">index</span>

    <span class="s2">def </span><span class="s1">_split</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">options</span><span class="s3">):</span>
        <span class="s1">split_options </span><span class="s3">= []</span>
        <span class="s1">start_position </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">tokens </span><span class="s3">= </span><span class="s1">generate_tokens</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">options</span><span class="s3">).</span><span class="s1">readline</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">toktype</span><span class="s3">, </span><span class="s1">tokval</span><span class="s3">, </span><span class="s1">tokpos</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">tokens</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">toktype </span><span class="s3">== </span><span class="s1">token</span><span class="s3">.</span><span class="s1">OP </span><span class="s2">and </span><span class="s1">tokval </span><span class="s3">== </span><span class="s4">&quot;;&quot;</span><span class="s3">:</span>
                <span class="s1">split_options</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">options</span><span class="s3">[</span><span class="s1">start_position </span><span class="s3">: </span><span class="s1">tokpos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]].</span><span class="s1">strip</span><span class="s3">())</span>
                <span class="s1">start_position </span><span class="s3">= </span><span class="s1">tokpos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] + </span><span class="s5">1</span>
            <span class="s0"># Handles trailing semicolon</span>
            <span class="s0"># !! Note: If multiline options allowed this splitter might fail !!</span>
            <span class="s2">if </span><span class="s1">toktype </span><span class="s3">== </span><span class="s1">token</span><span class="s3">.</span><span class="s1">NEWLINE </span><span class="s2">and </span><span class="s1">start_position </span><span class="s3">!= </span><span class="s1">tokpos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]:</span>
                <span class="s1">split_options</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">options</span><span class="s3">[</span><span class="s1">start_position </span><span class="s3">: </span><span class="s1">tokpos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]].</span><span class="s1">strip</span><span class="s3">())</span>
        <span class="s2">return </span><span class="s1">split_options</span>
</pre>
</body>
</html>