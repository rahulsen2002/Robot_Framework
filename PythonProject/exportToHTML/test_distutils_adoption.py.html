<html>
<head>
<title>test_distutils_adoption.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_distutils_adoption.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">textwrap</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s1">IS_PYPY </span><span class="s2">= </span><span class="s3">'__pypy__' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">builtin_module_names</span>

<span class="s1">_TEXT_KWARGS </span><span class="s2">= {</span><span class="s3">&quot;text&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;encoding&quot;</span><span class="s2">: </span><span class="s3">&quot;utf-8&quot;</span><span class="s2">}  </span><span class="s4"># For subprocess.run</span>


<span class="s0">def </span><span class="s1">win_sr</span><span class="s2">(</span><span class="s1">env</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    On Windows, SYSTEMROOT must be present to avoid 
 
    &gt; Fatal Python error: _Py_HashRandomization_Init: failed to 
    &gt; get random numbers to initialize Python 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">env </span><span class="s0">and </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">system</span><span class="s2">() == </span><span class="s3">'Windows'</span><span class="s2">:</span>
        <span class="s1">env</span><span class="s2">[</span><span class="s3">'SYSTEMROOT'</span><span class="s2">] = </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s3">'SYSTEMROOT'</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s1">env</span>


<span class="s0">def </span><span class="s1">find_distutils</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">, </span><span class="s1">imports</span><span class="s2">=</span><span class="s3">'distutils'</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">py_cmd </span><span class="s2">= </span><span class="s3">'import {imports}; print(distutils.__file__)'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(**</span><span class="s1">locals</span><span class="s2">())</span>
    <span class="s1">cmd </span><span class="s2">= [</span><span class="s3">'python'</span><span class="s2">, </span><span class="s3">'-c'</span><span class="s2">, </span><span class="s1">py_cmd</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">win_sr</span><span class="s2">(</span><span class="s1">env</span><span class="s2">), **</span><span class="s1">_TEXT_KWARGS</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">count_meta_path</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s1">py_cmd </span><span class="s2">= </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span>
        <span class="s3">&quot;&quot;&quot; 
        import sys 
        is_distutils = lambda finder: finder.__class__.__name__ == &quot;DistutilsMetaFinder&quot; 
        print(len(list(filter(is_distutils, sys.meta_path)))) 
        &quot;&quot;&quot;</span>
    <span class="s2">)</span>
    <span class="s1">cmd </span><span class="s2">= [</span><span class="s3">'python'</span><span class="s2">, </span><span class="s3">'-c'</span><span class="s2">, </span><span class="s1">py_cmd</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">win_sr</span><span class="s2">(</span><span class="s1">env</span><span class="s2">), **</span><span class="s1">_TEXT_KWARGS</span><span class="s2">))</span>


<span class="s1">skip_without_stdlib_distutils </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">12</span><span class="s2">),</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s3">'stdlib distutils is removed from Python 3.12+'</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s2">@</span><span class="s1">skip_without_stdlib_distutils</span>
<span class="s0">def </span><span class="s1">test_distutils_stdlib</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Ensure stdlib distutils is used when appropriate. 
    &quot;&quot;&quot;</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">SETUPTOOLS_USE_DISTUTILS</span><span class="s2">=</span><span class="s3">'stdlib'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s1">find_distutils</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_meta_path</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">) == </span><span class="s6">0</span>


<span class="s0">def </span><span class="s1">test_distutils_local_with_setuptools</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Ensure local distutils is used when appropriate. 
    &quot;&quot;&quot;</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">SETUPTOOLS_USE_DISTUTILS</span><span class="s2">=</span><span class="s3">'local'</span><span class="s2">)</span>
    <span class="s1">loc </span><span class="s2">= </span><span class="s1">find_distutils</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">, </span><span class="s1">imports</span><span class="s2">=</span><span class="s3">'setuptools, distutils'</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">loc</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_meta_path</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">) &lt;= </span><span class="s6">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s3">'IS_PYPY'</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">'pypy imports distutils on startup'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_distutils_local</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Even without importing, the setuptools-local copy of distutils is 
    preferred. 
    &quot;&quot;&quot;</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">SETUPTOOLS_USE_DISTUTILS</span><span class="s2">=</span><span class="s3">'local'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">find_distutils</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_meta_path</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">) &lt;= </span><span class="s6">1</span>


<span class="s0">def </span><span class="s1">test_pip_import</span><span class="s2">(</span><span class="s1">venv</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Ensure pip can be imported. 
    Regression test for #3002. 
    &quot;&quot;&quot;</span>
    <span class="s1">cmd </span><span class="s2">= [</span><span class="s3">'python'</span><span class="s2">, </span><span class="s3">'-c'</span><span class="s2">, </span><span class="s3">'import pip'</span><span class="s2">]</span>
    <span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, **</span><span class="s1">_TEXT_KWARGS</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_distutils_has_origin</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot; 
    Distutils module spec should have an origin. #2990. 
    &quot;&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">__import__</span><span class="s2">(</span><span class="s3">'distutils'</span><span class="s2">).</span><span class="s1">__spec__</span><span class="s2">.</span><span class="s1">origin</span>


<span class="s1">ENSURE_IMPORTS_ARE_NOT_DUPLICATED </span><span class="s2">= </span><span class="s3">r&quot;&quot;&quot; 
# Depending on the importlib machinery and _distutils_hack, some imports are 
# duplicated resulting in different module objects being loaded, which prevents 
# patches as shown in #3042. 
# This script provides a way of verifying if this duplication is happening. 
 
from distutils import cmd 
import distutils.command.sdist as sdist 
 
# import last to prevent caching 
from distutils import {imported_module} 
 
for mod in (cmd, sdist): 
    assert mod.{imported_module} == {imported_module}, ( 
        f&quot;\n{{mod.dir_util}}\n!=\n{{{imported_module}}}&quot; 
    ) 
 
print(&quot;success&quot;) 
&quot;&quot;&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">usefixtures</span><span class="s2">(</span><span class="s3">&quot;tmpdir_cwd&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">'distutils_version'</span><span class="s2">, </span><span class="s3">'imported_module'</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;stdlib&quot;</span><span class="s2">, </span><span class="s3">&quot;dir_util&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">skip_without_stdlib_distutils</span><span class="s2">),</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;stdlib&quot;</span><span class="s2">, </span><span class="s3">&quot;file_util&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">skip_without_stdlib_distutils</span><span class="s2">),</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;stdlib&quot;</span><span class="s2">, </span><span class="s3">&quot;archive_util&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">skip_without_stdlib_distutils</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;local&quot;</span><span class="s2">, </span><span class="s3">&quot;dir_util&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;local&quot;</span><span class="s2">, </span><span class="s3">&quot;file_util&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;local&quot;</span><span class="s2">, </span><span class="s3">&quot;archive_util&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_modules_are_not_duplicated_on_import</span><span class="s2">(</span><span class="s1">distutils_version</span><span class="s2">, </span><span class="s1">imported_module</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">):</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">SETUPTOOLS_USE_DISTUTILS</span><span class="s2">=</span><span class="s1">distutils_version</span><span class="s2">)</span>
    <span class="s1">script </span><span class="s2">= </span><span class="s1">ENSURE_IMPORTS_ARE_NOT_DUPLICATED</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">imported_module</span><span class="s2">=</span><span class="s1">imported_module</span><span class="s2">)</span>
    <span class="s1">cmd </span><span class="s2">= [</span><span class="s3">'python'</span><span class="s2">, </span><span class="s3">'-c'</span><span class="s2">, </span><span class="s1">script</span><span class="s2">]</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">win_sr</span><span class="s2">(</span><span class="s1">env</span><span class="s2">), **</span><span class="s1">_TEXT_KWARGS</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s3">&quot;success&quot;</span>


<span class="s1">ENSURE_LOG_IMPORT_IS_NOT_DUPLICATED </span><span class="s2">= </span><span class="s3">r&quot;&quot;&quot; 
import types 
import distutils.dist as dist 
from distutils import log 
if isinstance(dist.log, types.ModuleType): 
    assert dist.log == log, f&quot;\n{dist.log}\n!=\n{log}&quot; 
print(&quot;success&quot;) 
&quot;&quot;&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">usefixtures</span><span class="s2">(</span><span class="s3">&quot;tmpdir_cwd&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;distutils_version&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s3">&quot;local&quot;</span><span class="s2">,</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;stdlib&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">skip_without_stdlib_distutils</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_log_module_is_not_duplicated_on_import</span><span class="s2">(</span><span class="s1">distutils_version</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">):</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">SETUPTOOLS_USE_DISTUTILS</span><span class="s2">=</span><span class="s1">distutils_version</span><span class="s2">)</span>
    <span class="s1">cmd </span><span class="s2">= [</span><span class="s3">'python'</span><span class="s2">, </span><span class="s3">'-c'</span><span class="s2">, </span><span class="s1">ENSURE_LOG_IMPORT_IS_NOT_DUPLICATED</span><span class="s2">]</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">win_sr</span><span class="s2">(</span><span class="s1">env</span><span class="s2">), **</span><span class="s1">_TEXT_KWARGS</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s3">&quot;success&quot;</span>


<span class="s1">ENSURE_CONSISTENT_ERROR_FROM_MODIFIED_PY </span><span class="s2">= </span><span class="s3">r&quot;&quot;&quot; 
from setuptools.modified import newer 
from {imported_module}.errors import DistutilsError 
 
# Can't use pytest.raises in this context 
try: 
    newer(&quot;&quot;, &quot;&quot;) 
except DistutilsError: 
    print(&quot;success&quot;) 
else: 
    raise AssertionError(&quot;Expected to raise&quot;) 
&quot;&quot;&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">usefixtures</span><span class="s2">(</span><span class="s3">&quot;tmpdir_cwd&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">'distutils_version'</span><span class="s2">, </span><span class="s3">'imported_module'</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">&quot;local&quot;</span><span class="s2">, </span><span class="s3">&quot;distutils&quot;</span><span class="s2">),</span>
        <span class="s4"># Unfortunately we still get ._distutils.errors.DistutilsError with SETUPTOOLS_USE_DISTUTILS=stdlib</span>
        <span class="s4"># But that's a deprecated use-case we don't mind not fully supporting in newer code</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span>
            <span class="s3">&quot;stdlib&quot;</span><span class="s2">, </span><span class="s3">&quot;setuptools._distutils&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">skip_without_stdlib_distutils</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_consistent_error_from_modified_py</span><span class="s2">(</span><span class="s1">distutils_version</span><span class="s2">, </span><span class="s1">imported_module</span><span class="s2">, </span><span class="s1">venv</span><span class="s2">):</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">SETUPTOOLS_USE_DISTUTILS</span><span class="s2">=</span><span class="s1">distutils_version</span><span class="s2">)</span>
    <span class="s1">cmd </span><span class="s2">= [</span>
        <span class="s3">'python'</span><span class="s2">,</span>
        <span class="s3">'-c'</span><span class="s2">,</span>
        <span class="s1">ENSURE_CONSISTENT_ERROR_FROM_MODIFIED_PY</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
            <span class="s1">imported_module</span><span class="s2">=</span><span class="s1">imported_module</span>
        <span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">venv</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">win_sr</span><span class="s2">(</span><span class="s1">env</span><span class="s2">), **</span><span class="s1">_TEXT_KWARGS</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s3">&quot;success&quot;</span>
</pre>
</body>
</html>