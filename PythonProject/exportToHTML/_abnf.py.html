<html>
<head>
<title>_abnf.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_abnf.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">array</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">struct</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">threading </span><span class="s0">import </span><span class="s1">Lock</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Callable</span><span class="s2">, </span><span class="s1">Optional</span><span class="s2">, </span><span class="s1">Union</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">_exceptions </span><span class="s0">import </span><span class="s1">WebSocketPayloadException</span><span class="s2">, </span><span class="s1">WebSocketProtocolException</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_utils </span><span class="s0">import </span><span class="s1">validate_utf8</span>

<span class="s3">&quot;&quot;&quot; 
_abnf.py 
websocket - WebSocket client library for Python 
 
Copyright 2024 engn33r 
 
Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); 
you may not use this file except in compliance with the License. 
You may obtain a copy of the License at 
 
    http://www.apache.org/licenses/LICENSE-2.0 
 
Unless required by applicable law or agreed to in writing, software 
distributed under the License is distributed on an &quot;AS IS&quot; BASIS, 
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
See the License for the specific language governing permissions and 
limitations under the License. 
&quot;&quot;&quot;</span>

<span class="s0">try</span><span class="s2">:</span>
    <span class="s4"># If wsaccel is available, use compiled routines to mask data.</span>
    <span class="s4"># wsaccel only provides around a 10% speed boost compared</span>
    <span class="s4"># to the websocket-client _mask() implementation.</span>
    <span class="s4"># Note that wsaccel is unmaintained.</span>
    <span class="s0">from </span><span class="s1">wsaccel</span><span class="s2">.</span><span class="s1">xormask </span><span class="s0">import </span><span class="s1">XorMaskerSimple</span>

    <span class="s0">def </span><span class="s1">_mask</span><span class="s2">(</span><span class="s1">mask_value</span><span class="s2">: </span><span class="s1">array</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">data_value</span><span class="s2">: </span><span class="s1">array</span><span class="s2">.</span><span class="s1">array</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s1">mask_result</span><span class="s2">: </span><span class="s1">bytes </span><span class="s2">= </span><span class="s1">XorMaskerSimple</span><span class="s2">(</span><span class="s1">mask_value</span><span class="s2">).</span><span class="s1">process</span><span class="s2">(</span><span class="s1">data_value</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">mask_result</span>

<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s4"># wsaccel is not available, use websocket-client _mask()</span>
    <span class="s1">native_byteorder </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">byteorder</span>

    <span class="s0">def </span><span class="s1">_mask</span><span class="s2">(</span><span class="s1">mask_value</span><span class="s2">: </span><span class="s1">array</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">data_value</span><span class="s2">: </span><span class="s1">array</span><span class="s2">.</span><span class="s1">array</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s1">datalen </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data_value</span><span class="s2">)</span>
        <span class="s1">int_data_value </span><span class="s2">= </span><span class="s1">int</span><span class="s2">.</span><span class="s1">from_bytes</span><span class="s2">(</span><span class="s1">data_value</span><span class="s2">, </span><span class="s1">native_byteorder</span><span class="s2">)</span>
        <span class="s1">int_mask_value </span><span class="s2">= </span><span class="s1">int</span><span class="s2">.</span><span class="s1">from_bytes</span><span class="s2">(</span>
            <span class="s1">mask_value </span><span class="s2">* (</span><span class="s1">datalen </span><span class="s2">// </span><span class="s5">4</span><span class="s2">) + </span><span class="s1">mask_value</span><span class="s2">[: </span><span class="s1">datalen </span><span class="s2">% </span><span class="s5">4</span><span class="s2">], </span><span class="s1">native_byteorder</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">int_data_value </span><span class="s2">^ </span><span class="s1">int_mask_value</span><span class="s2">).</span><span class="s1">to_bytes</span><span class="s2">(</span><span class="s1">datalen</span><span class="s2">, </span><span class="s1">native_byteorder</span><span class="s2">)</span>


<span class="s1">__all__ </span><span class="s2">= [</span>
    <span class="s3">&quot;ABNF&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;continuous_frame&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;frame_buffer&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_NORMAL&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_GOING_AWAY&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_PROTOCOL_ERROR&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_UNSUPPORTED_DATA_TYPE&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_STATUS_NOT_AVAILABLE&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_ABNORMAL_CLOSED&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_INVALID_PAYLOAD&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_POLICY_VIOLATION&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_MESSAGE_TOO_BIG&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_INVALID_EXTENSION&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_UNEXPECTED_CONDITION&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_BAD_GATEWAY&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;STATUS_TLS_HANDSHAKE_ERROR&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s4"># closing frame status codes.</span>
<span class="s1">STATUS_NORMAL </span><span class="s2">= </span><span class="s5">1000</span>
<span class="s1">STATUS_GOING_AWAY </span><span class="s2">= </span><span class="s5">1001</span>
<span class="s1">STATUS_PROTOCOL_ERROR </span><span class="s2">= </span><span class="s5">1002</span>
<span class="s1">STATUS_UNSUPPORTED_DATA_TYPE </span><span class="s2">= </span><span class="s5">1003</span>
<span class="s1">STATUS_STATUS_NOT_AVAILABLE </span><span class="s2">= </span><span class="s5">1005</span>
<span class="s1">STATUS_ABNORMAL_CLOSED </span><span class="s2">= </span><span class="s5">1006</span>
<span class="s1">STATUS_INVALID_PAYLOAD </span><span class="s2">= </span><span class="s5">1007</span>
<span class="s1">STATUS_POLICY_VIOLATION </span><span class="s2">= </span><span class="s5">1008</span>
<span class="s1">STATUS_MESSAGE_TOO_BIG </span><span class="s2">= </span><span class="s5">1009</span>
<span class="s1">STATUS_INVALID_EXTENSION </span><span class="s2">= </span><span class="s5">1010</span>
<span class="s1">STATUS_UNEXPECTED_CONDITION </span><span class="s2">= </span><span class="s5">1011</span>
<span class="s1">STATUS_SERVICE_RESTART </span><span class="s2">= </span><span class="s5">1012</span>
<span class="s1">STATUS_TRY_AGAIN_LATER </span><span class="s2">= </span><span class="s5">1013</span>
<span class="s1">STATUS_BAD_GATEWAY </span><span class="s2">= </span><span class="s5">1014</span>
<span class="s1">STATUS_TLS_HANDSHAKE_ERROR </span><span class="s2">= </span><span class="s5">1015</span>

<span class="s1">VALID_CLOSE_STATUS </span><span class="s2">= (</span>
    <span class="s1">STATUS_NORMAL</span><span class="s2">,</span>
    <span class="s1">STATUS_GOING_AWAY</span><span class="s2">,</span>
    <span class="s1">STATUS_PROTOCOL_ERROR</span><span class="s2">,</span>
    <span class="s1">STATUS_UNSUPPORTED_DATA_TYPE</span><span class="s2">,</span>
    <span class="s1">STATUS_INVALID_PAYLOAD</span><span class="s2">,</span>
    <span class="s1">STATUS_POLICY_VIOLATION</span><span class="s2">,</span>
    <span class="s1">STATUS_MESSAGE_TOO_BIG</span><span class="s2">,</span>
    <span class="s1">STATUS_INVALID_EXTENSION</span><span class="s2">,</span>
    <span class="s1">STATUS_UNEXPECTED_CONDITION</span><span class="s2">,</span>
    <span class="s1">STATUS_SERVICE_RESTART</span><span class="s2">,</span>
    <span class="s1">STATUS_TRY_AGAIN_LATER</span><span class="s2">,</span>
    <span class="s1">STATUS_BAD_GATEWAY</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s0">class </span><span class="s1">ABNF</span><span class="s2">:</span>
    <span class="s6">&quot;&quot;&quot; 
    ABNF frame class. 
    See http://tools.ietf.org/html/rfc5234 
    and http://tools.ietf.org/html/rfc6455#section-5.2 
    &quot;&quot;&quot;</span>

    <span class="s4"># operation code values.</span>
    <span class="s1">OPCODE_CONT </span><span class="s2">= </span><span class="s5">0x0</span>
    <span class="s1">OPCODE_TEXT </span><span class="s2">= </span><span class="s5">0x1</span>
    <span class="s1">OPCODE_BINARY </span><span class="s2">= </span><span class="s5">0x2</span>
    <span class="s1">OPCODE_CLOSE </span><span class="s2">= </span><span class="s5">0x8</span>
    <span class="s1">OPCODE_PING </span><span class="s2">= </span><span class="s5">0x9</span>
    <span class="s1">OPCODE_PONG </span><span class="s2">= </span><span class="s5">0xA</span>

    <span class="s4"># available operation code value tuple</span>
    <span class="s1">OPCODES </span><span class="s2">= (</span>
        <span class="s1">OPCODE_CONT</span><span class="s2">,</span>
        <span class="s1">OPCODE_TEXT</span><span class="s2">,</span>
        <span class="s1">OPCODE_BINARY</span><span class="s2">,</span>
        <span class="s1">OPCODE_CLOSE</span><span class="s2">,</span>
        <span class="s1">OPCODE_PING</span><span class="s2">,</span>
        <span class="s1">OPCODE_PONG</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s4"># opcode human readable string</span>
    <span class="s1">OPCODE_MAP </span><span class="s2">= {</span>
        <span class="s1">OPCODE_CONT</span><span class="s2">: </span><span class="s3">&quot;cont&quot;</span><span class="s2">,</span>
        <span class="s1">OPCODE_TEXT</span><span class="s2">: </span><span class="s3">&quot;text&quot;</span><span class="s2">,</span>
        <span class="s1">OPCODE_BINARY</span><span class="s2">: </span><span class="s3">&quot;binary&quot;</span><span class="s2">,</span>
        <span class="s1">OPCODE_CLOSE</span><span class="s2">: </span><span class="s3">&quot;close&quot;</span><span class="s2">,</span>
        <span class="s1">OPCODE_PING</span><span class="s2">: </span><span class="s3">&quot;ping&quot;</span><span class="s2">,</span>
        <span class="s1">OPCODE_PONG</span><span class="s2">: </span><span class="s3">&quot;pong&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>

    <span class="s4"># data length threshold.</span>
    <span class="s1">LENGTH_7 </span><span class="s2">= </span><span class="s5">0x7E</span>
    <span class="s1">LENGTH_16 </span><span class="s2">= </span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s5">16</span>
    <span class="s1">LENGTH_63 </span><span class="s2">= </span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s5">63</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">fin</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">rsv1</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">rsv2</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">rsv3</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">opcode</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">OPCODE_TEXT</span><span class="s2">,</span>
        <span class="s1">mask_value</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">data</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">, </span><span class="s0">None</span><span class="s2">] = </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s6">&quot;&quot;&quot; 
        Constructor for ABNF. Please check RFC for arguments. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fin </span><span class="s2">= </span><span class="s1">fin</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rsv1 </span><span class="s2">= </span><span class="s1">rsv1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rsv2 </span><span class="s2">= </span><span class="s1">rsv2</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rsv3 </span><span class="s2">= </span><span class="s1">rsv3</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">opcode </span><span class="s2">= </span><span class="s1">opcode</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mask_value </span><span class="s2">= </span><span class="s1">mask_value</span>
        <span class="s0">if </span><span class="s1">data </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">get_mask_key </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">urandom</span>

    <span class="s0">def </span><span class="s1">validate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">skip_utf8_validation</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s6">&quot;&quot;&quot; 
        Validate the ABNF frame. 
 
        Parameters 
        ---------- 
        skip_utf8_validation: skip utf8 validation. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rsv1 </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rsv2 </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rsv3</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s3">&quot;rsv is not implemented, yet&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opcode </span><span class="s0">not in </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODES</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s3">&quot;Invalid opcode %r&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opcode</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opcode </span><span class="s2">== </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_PING </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fin</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s3">&quot;Invalid ping frame.&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opcode </span><span class="s2">== </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_CLOSE</span><span class="s2">:</span>
            <span class="s1">l </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">l</span><span class="s2">:</span>
                <span class="s0">return</span>
            <span class="s0">if </span><span class="s1">l </span><span class="s2">== </span><span class="s5">1 </span><span class="s0">or </span><span class="s1">l </span><span class="s2">&gt;= </span><span class="s5">126</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s3">&quot;Invalid close frame.&quot;</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s5">2 </span><span class="s0">and not </span><span class="s1">skip_utf8_validation </span><span class="s0">and not </span><span class="s1">validate_utf8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:]):</span>
                <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s3">&quot;Invalid close frame.&quot;</span><span class="s2">)</span>

            <span class="s1">code </span><span class="s2">= </span><span class="s5">256 </span><span class="s2">* </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]) + </span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_valid_close_status</span><span class="s2">(</span><span class="s1">code</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s3">&quot;Invalid close opcode %r&quot;</span><span class="s2">, </span><span class="s1">code</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">_is_valid_close_status</span><span class="s2">(</span><span class="s1">code</span><span class="s2">: </span><span class="s1">int</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">code </span><span class="s0">in </span><span class="s1">VALID_CLOSE_STATUS </span><span class="s0">or </span><span class="s2">(</span><span class="s5">3000 </span><span class="s2">&lt;= </span><span class="s1">code </span><span class="s2">&lt; </span><span class="s5">5000</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s3">f&quot;fin=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fin</span><span class="s0">} </span><span class="s3">opcode=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">opcode</span><span class="s0">} </span><span class="s3">data=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s0">}</span><span class="s3">&quot;</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">create_frame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">str</span><span class="s2">], </span><span class="s1">opcode</span><span class="s2">: </span><span class="s1">int</span><span class="s2">, </span><span class="s1">fin</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s5">1</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s3">&quot;ABNF&quot;</span><span class="s2">:</span>
        <span class="s6">&quot;&quot;&quot; 
        Create frame to send text, binary and other data. 
 
        Parameters 
        ---------- 
        data: str 
            data to send. This is string value(byte array). 
            If opcode is OPCODE_TEXT and this value is unicode, 
            data value is converted into unicode string, automatically. 
        opcode: int 
            operation code. please see OPCODE_MAP. 
        fin: int 
            fin flag. if set to 0, create continue fragmentation. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">opcode </span><span class="s2">== </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_TEXT </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s4"># mask must be set if send data from client</span>
        <span class="s0">return </span><span class="s1">ABNF</span><span class="s2">(</span><span class="s1">fin</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">opcode</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">format</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s6">&quot;&quot;&quot; 
        Format this object to string(byte array) to send data to server. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">x </span><span class="s0">not in </span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fin</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rsv1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rsv2</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rsv3</span><span class="s2">]):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;not 0 or 1&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opcode </span><span class="s0">not in </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODES</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;Invalid OPCODE&quot;</span><span class="s2">)</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">length </span><span class="s2">&gt;= </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">LENGTH_63</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;data is too long&quot;</span><span class="s2">)</span>

        <span class="s1">frame_header </span><span class="s2">= </span><span class="s1">chr</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fin </span><span class="s2">&lt;&lt; </span><span class="s5">7</span>
            <span class="s2">| </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rsv1 </span><span class="s2">&lt;&lt; </span><span class="s5">6</span>
            <span class="s2">| </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rsv2 </span><span class="s2">&lt;&lt; </span><span class="s5">5</span>
            <span class="s2">| </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rsv3 </span><span class="s2">&lt;&lt; </span><span class="s5">4</span>
            <span class="s2">| </span><span class="s1">self</span><span class="s2">.</span><span class="s1">opcode</span>
        <span class="s2">).</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;latin-1&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">length </span><span class="s2">&lt; </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">LENGTH_7</span><span class="s2">:</span>
            <span class="s1">frame_header </span><span class="s2">+= </span><span class="s1">chr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mask_value </span><span class="s2">&lt;&lt; </span><span class="s5">7 </span><span class="s2">| </span><span class="s1">length</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;latin-1&quot;</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">length </span><span class="s2">&lt; </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">LENGTH_16</span><span class="s2">:</span>
            <span class="s1">frame_header </span><span class="s2">+= </span><span class="s1">chr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mask_value </span><span class="s2">&lt;&lt; </span><span class="s5">7 </span><span class="s2">| </span><span class="s5">0x7E</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;latin-1&quot;</span><span class="s2">)</span>
            <span class="s1">frame_header </span><span class="s2">+= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">&quot;!H&quot;</span><span class="s2">, </span><span class="s1">length</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">frame_header </span><span class="s2">+= </span><span class="s1">chr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mask_value </span><span class="s2">&lt;&lt; </span><span class="s5">7 </span><span class="s2">| </span><span class="s5">0x7F</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;latin-1&quot;</span><span class="s2">)</span>
            <span class="s1">frame_header </span><span class="s2">+= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">&quot;!Q&quot;</span><span class="s2">, </span><span class="s1">length</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mask_value</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">frame_header </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">mask_key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_mask_key</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">frame_header </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_masked</span><span class="s2">(</span><span class="s1">mask_key</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_masked</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">mask_key</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">]) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">(</span><span class="s1">mask_key</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">mask_key</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">mask_key </span><span class="s2">= </span><span class="s1">mask_key</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">mask_key </span><span class="s2">+ </span><span class="s1">s</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">mask</span><span class="s2">(</span><span class="s1">mask_key</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">], </span><span class="s1">data</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">]) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s6">&quot;&quot;&quot; 
        Mask or unmask data. Just do xor for each byte 
 
        Parameters 
        ---------- 
        mask_key: bytes or str 
            4 byte mask. 
        data: bytes or str 
            data to mask/unmask. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">data </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">mask_key</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">mask_key </span><span class="s2">= </span><span class="s1">mask_key</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;latin-1&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;latin-1&quot;</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">_mask</span><span class="s2">(</span><span class="s1">array</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s1">mask_key</span><span class="s2">), </span><span class="s1">array</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">frame_buffer</span><span class="s2">:</span>
    <span class="s1">_HEADER_MASK_INDEX </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">_HEADER_LENGTH_INDEX </span><span class="s2">= </span><span class="s5">6</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">recv_fn</span><span class="s2">: </span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">int</span><span class="s2">], </span><span class="s1">int</span><span class="s2">], </span><span class="s1">skip_utf8_validation</span><span class="s2">: </span><span class="s1">bool</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">recv </span><span class="s2">= </span><span class="s1">recv_fn</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">skip_utf8_validation </span><span class="s2">= </span><span class="s1">skip_utf8_validation</span>
        <span class="s4"># Buffers over the packets from the layer beneath until desired amount</span>
        <span class="s4"># bytes of bytes are received.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">recv_buffer</span><span class="s2">: </span><span class="s1">list </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lock </span><span class="s2">= </span><span class="s1">Lock</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">clear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">header</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">length</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mask_value</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">] = </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">has_received_header</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">header </span><span class="s0">is None</span>

    <span class="s0">def </span><span class="s1">recv_header</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">header </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_strict</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">header</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">fin </span><span class="s2">= </span><span class="s1">b1 </span><span class="s2">&gt;&gt; </span><span class="s5">7 </span><span class="s2">&amp; </span><span class="s5">1</span>
        <span class="s1">rsv1 </span><span class="s2">= </span><span class="s1">b1 </span><span class="s2">&gt;&gt; </span><span class="s5">6 </span><span class="s2">&amp; </span><span class="s5">1</span>
        <span class="s1">rsv2 </span><span class="s2">= </span><span class="s1">b1 </span><span class="s2">&gt;&gt; </span><span class="s5">5 </span><span class="s2">&amp; </span><span class="s5">1</span>
        <span class="s1">rsv3 </span><span class="s2">= </span><span class="s1">b1 </span><span class="s2">&gt;&gt; </span><span class="s5">4 </span><span class="s2">&amp; </span><span class="s5">1</span>
        <span class="s1">opcode </span><span class="s2">= </span><span class="s1">b1 </span><span class="s2">&amp; </span><span class="s5">0xF</span>
        <span class="s1">b2 </span><span class="s2">= </span><span class="s1">header</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">has_mask </span><span class="s2">= </span><span class="s1">b2 </span><span class="s2">&gt;&gt; </span><span class="s5">7 </span><span class="s2">&amp; </span><span class="s5">1</span>
        <span class="s1">length_bits </span><span class="s2">= </span><span class="s1">b2 </span><span class="s2">&amp; </span><span class="s5">0x7F</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">header </span><span class="s2">= (</span><span class="s1">fin</span><span class="s2">, </span><span class="s1">rsv1</span><span class="s2">, </span><span class="s1">rsv2</span><span class="s2">, </span><span class="s1">rsv3</span><span class="s2">, </span><span class="s1">opcode</span><span class="s2">, </span><span class="s1">has_mask</span><span class="s2">, </span><span class="s1">length_bits</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">has_mask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; Union</span><span class="s2">[</span><span class="s1">bool</span><span class="s2">, </span><span class="s1">int</span><span class="s2">]:</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">header</span><span class="s2">:</span>
            <span class="s0">return False</span>
        <span class="s1">header_val</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">header</span><span class="s2">[</span><span class="s1">frame_buffer</span><span class="s2">.</span><span class="s1">_HEADER_MASK_INDEX</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">header_val</span>

    <span class="s0">def </span><span class="s1">has_received_length</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">length </span><span class="s0">is None</span>

    <span class="s0">def </span><span class="s1">recv_length</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">bits </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">header</span><span class="s2">[</span><span class="s1">frame_buffer</span><span class="s2">.</span><span class="s1">_HEADER_LENGTH_INDEX</span><span class="s2">]</span>
        <span class="s1">length_bits </span><span class="s2">= </span><span class="s1">bits </span><span class="s2">&amp; </span><span class="s5">0x7F</span>
        <span class="s0">if </span><span class="s1">length_bits </span><span class="s2">== </span><span class="s5">0x7E</span><span class="s2">:</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_strict</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;!H&quot;</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">length_bits </span><span class="s2">== </span><span class="s5">0x7F</span><span class="s2">:</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_strict</span><span class="s2">(</span><span class="s5">8</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;!Q&quot;</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s1">length_bits</span>

    <span class="s0">def </span><span class="s1">has_received_mask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mask_value </span><span class="s0">is None</span>

    <span class="s0">def </span><span class="s1">recv_mask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mask_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_strict</span><span class="s2">(</span><span class="s5">4</span><span class="s2">) </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_mask</span><span class="s2">() </span><span class="s0">else </span><span class="s3">&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">recv_frame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; ABNF</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lock</span><span class="s2">:</span>
            <span class="s4"># Header</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_received_header</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">recv_header</span><span class="s2">()</span>
            <span class="s2">(</span><span class="s1">fin</span><span class="s2">, </span><span class="s1">rsv1</span><span class="s2">, </span><span class="s1">rsv2</span><span class="s2">, </span><span class="s1">rsv3</span><span class="s2">, </span><span class="s1">opcode</span><span class="s2">, </span><span class="s1">has_mask</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">header</span>

            <span class="s4"># Frame length</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_received_length</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">recv_length</span><span class="s2">()</span>
            <span class="s1">length </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">length</span>

            <span class="s4"># Mask</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_received_mask</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">recv_mask</span><span class="s2">()</span>
            <span class="s1">mask_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mask_value</span>

            <span class="s4"># Payload</span>
            <span class="s1">payload </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_strict</span><span class="s2">(</span><span class="s1">length</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">has_mask</span><span class="s2">:</span>
                <span class="s1">payload </span><span class="s2">= </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">(</span><span class="s1">mask_value</span><span class="s2">, </span><span class="s1">payload</span><span class="s2">)</span>

            <span class="s4"># Reset for next frame</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

            <span class="s1">frame </span><span class="s2">= </span><span class="s1">ABNF</span><span class="s2">(</span><span class="s1">fin</span><span class="s2">, </span><span class="s1">rsv1</span><span class="s2">, </span><span class="s1">rsv2</span><span class="s2">, </span><span class="s1">rsv3</span><span class="s2">, </span><span class="s1">opcode</span><span class="s2">, </span><span class="s1">has_mask</span><span class="s2">, </span><span class="s1">payload</span><span class="s2">)</span>
            <span class="s1">frame</span><span class="s2">.</span><span class="s1">validate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">skip_utf8_validation</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">frame</span>

    <span class="s0">def </span><span class="s1">recv_strict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bufsize</span><span class="s2">: </span><span class="s1">int</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s1">shortage </span><span class="s2">= </span><span class="s1">bufsize </span><span class="s2">- </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">len</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_buffer</span><span class="s2">))</span>
        <span class="s0">while </span><span class="s1">shortage </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4"># Limit buffer size that we pass to socket.recv() to avoid</span>
            <span class="s4"># fragmenting the heap -- the number of bytes recv() actually</span>
            <span class="s4"># reads is limited by socket buffer and is relatively small,</span>
            <span class="s4"># yet passing large numbers repeatedly causes lots of large</span>
            <span class="s4"># buffers allocated and then shrunk, which results in</span>
            <span class="s4"># fragmentation.</span>
            <span class="s1">bytes_ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s1">min</span><span class="s2">(</span><span class="s5">16384</span><span class="s2">, </span><span class="s1">shortage</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recv_buffer</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bytes_</span><span class="s2">)</span>
            <span class="s1">shortage </span><span class="s2">-= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bytes_</span><span class="s2">)</span>

        <span class="s1">unified </span><span class="s2">= </span><span class="s7">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv_buffer</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">shortage </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recv_buffer </span><span class="s2">= []</span>
            <span class="s0">return </span><span class="s1">unified</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recv_buffer </span><span class="s2">= [</span><span class="s1">unified</span><span class="s2">[</span><span class="s1">bufsize</span><span class="s2">:]]</span>
            <span class="s0">return </span><span class="s1">unified</span><span class="s2">[:</span><span class="s1">bufsize</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">continuous_frame</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fire_cont_frame</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">, </span><span class="s1">skip_utf8_validation</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fire_cont_frame </span><span class="s2">= </span><span class="s1">fire_cont_frame</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">skip_utf8_validation </span><span class="s2">= </span><span class="s1">skip_utf8_validation</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cont_data</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">list</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">recving_frames</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">validate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">: </span><span class="s1">ABNF</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recving_frames </span><span class="s0">and </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode </span><span class="s2">== </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_CONT</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s3">&quot;Illegal frame&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recving_frames </span><span class="s0">and </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode </span><span class="s0">in </span><span class="s2">(</span>
            <span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_TEXT</span><span class="s2">,</span>
            <span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_BINARY</span><span class="s2">,</span>
        <span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">WebSocketProtocolException</span><span class="s2">(</span><span class="s3">&quot;Illegal frame&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">: </span><span class="s1">ABNF</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cont_data</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cont_data</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] += </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode </span><span class="s0">in </span><span class="s2">(</span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_TEXT</span><span class="s2">, </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_BINARY</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">recving_frames </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cont_data </span><span class="s2">= [</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">opcode</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">data</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">fin</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recving_frames </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">is_fire</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">: </span><span class="s1">ABNF</span><span class="s2">) </span><span class="s1">-&gt; Union</span><span class="s2">[</span><span class="s1">bool</span><span class="s2">, </span><span class="s1">int</span><span class="s2">]:</span>
        <span class="s0">return </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">fin </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fire_cont_frame</span>

    <span class="s0">def </span><span class="s1">extract</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">: </span><span class="s1">ABNF</span><span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">:</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cont_data</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cont_data </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">frame</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fire_cont_frame</span>
            <span class="s0">and </span><span class="s1">data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">ABNF</span><span class="s2">.</span><span class="s1">OPCODE_TEXT</span>
            <span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">skip_utf8_validation</span>
            <span class="s0">and not </span><span class="s1">validate_utf8</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">WebSocketPayloadException</span><span class="s2">(</span><span class="s3">f&quot;cannot decode: </span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">frame</span>
</pre>
</body>
</html>