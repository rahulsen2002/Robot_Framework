<html>
<head>
<title>test_pyprojecttoml.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_pyprojecttoml.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>
<span class="s0">from </span><span class="s1">configparser </span><span class="s0">import </span><span class="s1">ConfigParser</span>
<span class="s0">from </span><span class="s1">inspect </span><span class="s0">import </span><span class="s1">cleandoc</span>

<span class="s0">import </span><span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">tomli_w</span>
<span class="s0">from </span><span class="s1">path </span><span class="s0">import </span><span class="s1">Path</span>

<span class="s0">import </span><span class="s1">setuptools  </span><span class="s3"># noqa: F401 # force distutils.core to be patched</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">pyprojecttoml </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_ToolsTypoInMetadata</span><span class="s2">,</span>
    <span class="s1">apply_configuration</span><span class="s2">,</span>
    <span class="s1">expand_configuration</span><span class="s2">,</span>
    <span class="s1">read_configuration</span><span class="s2">,</span>
    <span class="s1">validate</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">dist </span><span class="s0">import </span><span class="s1">Distribution</span>
<span class="s0">from </span><span class="s1">setuptools</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">OptionError</span>

<span class="s0">import </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">core</span>

<span class="s1">EXAMPLE </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
[project] 
name = &quot;myproj&quot; 
keywords = [&quot;some&quot;, &quot;key&quot;, &quot;words&quot;] 
dynamic = [&quot;version&quot;, &quot;readme&quot;] 
requires-python = &quot;&gt;=2.7, !=3.0.*, !=3.1.*, !=3.2.*, !=3.3.*, !=3.4.*&quot; 
dependencies = [ 
    'importlib-metadata&gt;=0.12;python_version&lt;&quot;3.8&quot;', 
    'importlib-resources&gt;=1.0;python_version&lt;&quot;3.7&quot;', 
    'pathlib2&gt;=2.3.3,&lt;3;python_version &lt; &quot;3.4&quot; and sys.platform != &quot;win32&quot;', 
] 
 
[project.optional-dependencies] 
docs = [ 
    &quot;sphinx&gt;=3&quot;, 
    &quot;sphinx-argparse&gt;=0.2.5&quot;, 
    &quot;sphinx-rtd-theme&gt;=0.4.3&quot;, 
] 
testing = [ 
    &quot;pytest&gt;=1&quot;, 
    &quot;coverage&gt;=3,&lt;5&quot;, 
] 
 
[project.scripts] 
exec = &quot;pkg.__main__:exec&quot; 
 
[build-system] 
requires = [&quot;setuptools&quot;, &quot;wheel&quot;] 
build-backend = &quot;setuptools.build_meta&quot; 
 
[tool.setuptools] 
package-dir = {&quot;&quot; = &quot;src&quot;} 
zip-safe = true 
platforms = [&quot;any&quot;] 
 
[tool.setuptools.packages.find] 
where = [&quot;src&quot;] 
 
[tool.setuptools.cmdclass] 
sdist = &quot;pkg.mod.CustomSdist&quot; 
 
[tool.setuptools.dynamic.version] 
attr = &quot;pkg.__version__.VERSION&quot; 
 
[tool.setuptools.dynamic.readme] 
file = [&quot;README.md&quot;] 
content-type = &quot;text/markdown&quot; 
 
[tool.setuptools.package-data] 
&quot;*&quot; = [&quot;*.txt&quot;] 
 
[tool.setuptools.data-files] 
&quot;data&quot; = [&quot;_files/*.txt&quot;] 
 
[tool.distutils.sdist] 
formats = &quot;gztar&quot; 
 
[tool.distutils.bdist_wheel] 
universal = true 
&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">create_example</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">pkg_root</span><span class="s2">):</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s1">EXAMPLE</span><span class="s2">,</span>
        <span class="s4">&quot;README.md&quot;</span><span class="s2">: </span><span class="s4">&quot;hello world&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;_files&quot;</span><span class="s2">: {</span>
            <span class="s4">&quot;file.txt&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
    <span class="s2">}</span>
    <span class="s1">packages </span><span class="s2">= {</span>
        <span class="s4">&quot;pkg&quot;</span><span class="s2">: {</span>
            <span class="s4">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;mod.py&quot;</span><span class="s2">: </span><span class="s4">&quot;class CustomSdist: pass&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;__version__.py&quot;</span><span class="s2">: </span><span class="s4">&quot;VERSION = (3, 10)&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;__main__.py&quot;</span><span class="s2">: </span><span class="s4">&quot;def exec(): print('hello')&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
    <span class="s2">}</span>

    <span class="s0">assert </span><span class="s1">pkg_root  </span><span class="s3"># Meta-test: cannot be empty string.</span>

    <span class="s0">if </span><span class="s1">pkg_root </span><span class="s2">== </span><span class="s4">&quot;.&quot;</span><span class="s2">:</span>
        <span class="s1">files </span><span class="s2">= {**</span><span class="s1">files</span><span class="s2">, **</span><span class="s1">packages</span><span class="s2">}</span>
        <span class="s3"># skip other files: flat-layout will raise error for multi-package dist</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s3"># Use this opportunity to ensure namespaces are discovered</span>
        <span class="s1">files</span><span class="s2">[</span><span class="s1">pkg_root</span><span class="s2">] = {**</span><span class="s1">packages</span><span class="s2">, </span><span class="s4">&quot;other&quot;</span><span class="s2">: {</span><span class="s4">&quot;nested&quot;</span><span class="s2">: {</span><span class="s4">&quot;__init__.py&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;</span><span class="s2">}}}</span>

    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">path</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">verify_example</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">path</span><span class="s2">, </span><span class="s1">pkg_root</span><span class="s2">):</span>
    <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
    <span class="s1">pyproject</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">tomli_w</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">config</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
    <span class="s1">expanded </span><span class="s2">= </span><span class="s1">expand_configuration</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">path</span><span class="s2">)</span>
    <span class="s1">expanded_project </span><span class="s2">= </span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">, </span><span class="s1">expand</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) == </span><span class="s1">expanded</span>
    <span class="s0">assert </span><span class="s1">expanded_project</span><span class="s2">[</span><span class="s4">&quot;version&quot;</span><span class="s2">] == </span><span class="s4">&quot;3.10&quot;</span>
    <span class="s0">assert </span><span class="s1">expanded_project</span><span class="s2">[</span><span class="s4">&quot;readme&quot;</span><span class="s2">][</span><span class="s4">&quot;text&quot;</span><span class="s2">] == </span><span class="s4">&quot;hello world&quot;</span>
    <span class="s0">assert </span><span class="s4">&quot;packages&quot; </span><span class="s0">in </span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">pkg_root </span><span class="s2">== </span><span class="s4">&quot;.&quot;</span><span class="s2">:</span>
        <span class="s3"># Auto-discovery will raise error for multi-package dist</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">][</span><span class="s4">&quot;packages&quot;</span><span class="s2">]) == {</span><span class="s4">&quot;pkg&quot;</span><span class="s2">}</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">][</span><span class="s4">&quot;packages&quot;</span><span class="s2">]) == {</span>
            <span class="s4">&quot;pkg&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;other&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;other.nested&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
    <span class="s0">assert </span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">][</span><span class="s4">&quot;include-package-data&quot;</span><span class="s2">] </span><span class="s0">is True</span>
    <span class="s0">assert </span><span class="s4">&quot;&quot; </span><span class="s0">in </span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">][</span><span class="s4">&quot;package-data&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s4">&quot;*&quot; </span><span class="s0">not in </span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">][</span><span class="s4">&quot;package-data&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">][</span><span class="s4">&quot;data-files&quot;</span><span class="s2">] == [</span>
        <span class="s2">(</span><span class="s4">&quot;data&quot;</span><span class="s2">, [</span><span class="s4">&quot;_files/file.txt&quot;</span><span class="s2">])</span>
    <span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_read_configuration</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">create_example</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">)</span>
    <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>

    <span class="s1">config </span><span class="s2">= </span><span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">, </span><span class="s1">expand</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">].</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;version&quot;</span><span class="s2">) </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">].</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;readme&quot;</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s1">verify_example</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s4">&quot;pkg_root&quot;</span><span class="s2">, </span><span class="s4">&quot;opts&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">&quot;.&quot;</span><span class="s2">, {}),</span>
        <span class="s2">(</span><span class="s4">&quot;src&quot;</span><span class="s2">, {}),</span>
        <span class="s2">(</span><span class="s4">&quot;lib&quot;</span><span class="s2">, {</span><span class="s4">&quot;packages&quot;</span><span class="s2">: {</span><span class="s4">&quot;find&quot;</span><span class="s2">: {</span><span class="s4">&quot;where&quot;</span><span class="s2">: [</span><span class="s4">&quot;lib&quot;</span><span class="s2">]}}}),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_discovered_package_dir_with_attr_directive_in_config</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">pkg_root</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">):</span>
    <span class="s1">create_example</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">pkg_root</span><span class="s2">)</span>

    <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>

    <span class="s1">config </span><span class="s2">= </span><span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">, </span><span class="s1">expand</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">].</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;version&quot;</span><span class="s2">) </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">].</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;readme&quot;</span><span class="s2">) </span><span class="s0">is None</span>
    <span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">].</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;packages&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">].</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;package-dir&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">].</span><span class="s1">update</span><span class="s2">(</span><span class="s1">opts</span><span class="s2">)</span>
    <span class="s1">verify_example</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">pkg_root</span><span class="s2">)</span>


<span class="s1">ENTRY_POINTS </span><span class="s2">= {</span>
    <span class="s4">&quot;console_scripts&quot;</span><span class="s2">: {</span><span class="s4">&quot;a&quot;</span><span class="s2">: </span><span class="s4">&quot;mod.a:func&quot;</span><span class="s2">},</span>
    <span class="s4">&quot;gui_scripts&quot;</span><span class="s2">: {</span><span class="s4">&quot;b&quot;</span><span class="s2">: </span><span class="s4">&quot;mod.b:func&quot;</span><span class="s2">},</span>
    <span class="s4">&quot;other&quot;</span><span class="s2">: {</span><span class="s4">&quot;c&quot;</span><span class="s2">: </span><span class="s4">&quot;mod.c:func [extra]&quot;</span><span class="s2">},</span>
<span class="s2">}</span>


<span class="s0">class </span><span class="s1">TestEntryPoints</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">write_entry_points</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">entry_points </span><span class="s2">= </span><span class="s1">ConfigParser</span><span class="s2">()</span>
        <span class="s1">entry_points</span><span class="s2">.</span><span class="s1">read_dict</span><span class="s2">(</span><span class="s1">ENTRY_POINTS</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;entry-points.txt&quot;</span><span class="s2">, </span><span class="s4">&quot;w&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">entry_points</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">pyproject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dynamic</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">project </span><span class="s2">= {</span><span class="s4">&quot;dynamic&quot;</span><span class="s2">: </span><span class="s1">dynamic </span><span class="s0">or </span><span class="s2">[</span><span class="s4">&quot;scripts&quot;</span><span class="s2">, </span><span class="s4">&quot;gui-scripts&quot;</span><span class="s2">, </span><span class="s4">&quot;entry-points&quot;</span><span class="s2">]}</span>
        <span class="s1">tool </span><span class="s2">= {</span><span class="s4">&quot;dynamic&quot;</span><span class="s2">: {</span><span class="s4">&quot;entry-points&quot;</span><span class="s2">: {</span><span class="s4">&quot;file&quot;</span><span class="s2">: </span><span class="s4">&quot;entry-points.txt&quot;</span><span class="s2">}}}</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s4">&quot;project&quot;</span><span class="s2">: </span><span class="s1">project</span><span class="s2">, </span><span class="s4">&quot;tool&quot;</span><span class="s2">: {</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">: </span><span class="s1">tool</span><span class="s2">}}</span>

    <span class="s0">def </span><span class="s1">test_all_listed_in_dynamic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">write_entry_points</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">expanded </span><span class="s2">= </span><span class="s1">expand_configuration</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyproject</span><span class="s2">(), </span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">expanded_project </span><span class="s2">= </span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">expanded_project</span><span class="s2">[</span><span class="s4">&quot;scripts&quot;</span><span class="s2">]) == </span><span class="s5">1</span>
        <span class="s0">assert </span><span class="s1">expanded_project</span><span class="s2">[</span><span class="s4">&quot;scripts&quot;</span><span class="s2">][</span><span class="s4">&quot;a&quot;</span><span class="s2">] == </span><span class="s4">&quot;mod.a:func&quot;</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">expanded_project</span><span class="s2">[</span><span class="s4">&quot;gui-scripts&quot;</span><span class="s2">]) == </span><span class="s5">1</span>
        <span class="s0">assert </span><span class="s1">expanded_project</span><span class="s2">[</span><span class="s4">&quot;gui-scripts&quot;</span><span class="s2">][</span><span class="s4">&quot;b&quot;</span><span class="s2">] == </span><span class="s4">&quot;mod.b:func&quot;</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">expanded_project</span><span class="s2">[</span><span class="s4">&quot;entry-points&quot;</span><span class="s2">]) == </span><span class="s5">1</span>
        <span class="s0">assert </span><span class="s1">expanded_project</span><span class="s2">[</span><span class="s4">&quot;entry-points&quot;</span><span class="s2">][</span><span class="s4">&quot;other&quot;</span><span class="s2">][</span><span class="s4">&quot;c&quot;</span><span class="s2">] == </span><span class="s4">&quot;mod.c:func [extra]&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;missing_dynamic&quot;</span><span class="s2">, (</span><span class="s4">&quot;scripts&quot;</span><span class="s2">, </span><span class="s4">&quot;gui-scripts&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_scripts_not_listed_in_dynamic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">missing_dynamic</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">write_entry_points</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)</span>
        <span class="s1">dynamic </span><span class="s2">= {</span><span class="s4">&quot;scripts&quot;</span><span class="s2">, </span><span class="s4">&quot;gui-scripts&quot;</span><span class="s2">, </span><span class="s4">&quot;entry-points&quot;</span><span class="s2">} - {</span><span class="s1">missing_dynamic</span><span class="s2">}</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s4">f&quot;defined outside of `pyproject.toml`:.*</span><span class="s0">{</span><span class="s1">missing_dynamic</span><span class="s0">}</span><span class="s4">&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">OptionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">re</span><span class="s2">.</span><span class="s1">S</span><span class="s2">)):</span>
            <span class="s1">expand_configuration</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyproject</span><span class="s2">(</span><span class="s1">dynamic</span><span class="s2">), </span><span class="s1">tmp_path</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestClassifiers</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_dynamic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s3"># Let's create a project example that has dynamic classifiers</span>
        <span class="s3"># coming from a txt file.</span>
        <span class="s1">create_example</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">)</span>
        <span class="s1">classifiers </span><span class="s2">= </span><span class="s1">cleandoc</span><span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            Framework :: Flask 
            Programming Language :: Haskell 
            &quot;&quot;&quot;</span>
        <span class="s2">)</span>
        <span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;classifiers.txt&quot;</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">classifiers</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

        <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">, </span><span class="s1">expand</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">dynamic </span><span class="s2">= </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">][</span><span class="s4">&quot;dynamic&quot;</span><span class="s2">]</span>
        <span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">][</span><span class="s4">&quot;dynamic&quot;</span><span class="s2">] = </span><span class="s1">list</span><span class="s2">({*</span><span class="s1">dynamic</span><span class="s2">, </span><span class="s4">&quot;classifiers&quot;</span><span class="s2">})</span>
        <span class="s1">dynamic_config </span><span class="s2">= </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">][</span><span class="s4">&quot;dynamic&quot;</span><span class="s2">]</span>
        <span class="s1">dynamic_config</span><span class="s2">[</span><span class="s4">&quot;classifiers&quot;</span><span class="s2">] = {</span><span class="s4">&quot;file&quot;</span><span class="s2">: </span><span class="s4">&quot;classifiers.txt&quot;</span><span class="s2">}</span>

        <span class="s3"># When the configuration is expanded,</span>
        <span class="s3"># each line of the file should be an different classifier.</span>
        <span class="s1">validate</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">pyproject</span><span class="s2">)</span>
        <span class="s1">expanded </span><span class="s2">= </span><span class="s1">expand_configuration</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">][</span><span class="s4">&quot;classifiers&quot;</span><span class="s2">]) == {</span>
            <span class="s4">&quot;Framework :: Flask&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;Programming Language :: Haskell&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">test_dynamic_without_config</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
        [project] 
        name = &quot;myproj&quot; 
        version = '42' 
        dynamic = [&quot;classifiers&quot;] 
        &quot;&quot;&quot;</span>

        <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
        <span class="s1">pyproject</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">cleandoc</span><span class="s2">(</span><span class="s1">config</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">OptionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;No configuration .* .classifiers.&quot;</span><span class="s2">):</span>
            <span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_dynamic_readme_from_setup_script_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
        [project] 
        name = &quot;myproj&quot; 
        version = '42' 
        dynamic = [&quot;readme&quot;] 
        &quot;&quot;&quot;</span>
        <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
        <span class="s1">pyproject</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">cleandoc</span><span class="s2">(</span><span class="s1">config</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">={</span><span class="s4">&quot;long_description&quot;</span><span class="s2">: </span><span class="s4">&quot;42&quot;</span><span class="s2">})</span>
        <span class="s3"># No error should occur because of missing `readme`</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">apply_configuration</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">pyproject</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">metadata</span><span class="s2">.</span><span class="s1">long_description </span><span class="s2">== </span><span class="s4">&quot;42&quot;</span>

    <span class="s0">def </span><span class="s1">test_dynamic_without_file</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
        [project] 
        name = &quot;myproj&quot; 
        version = '42' 
        dynamic = [&quot;classifiers&quot;] 
 
        [tool.setuptools.dynamic] 
        classifiers = {file = [&quot;classifiers.txt&quot;]} 
        &quot;&quot;&quot;</span>

        <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
        <span class="s1">pyproject</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">cleandoc</span><span class="s2">(</span><span class="s1">config</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;File .*classifiers.txt. cannot be found&quot;</span><span class="s2">):</span>
            <span class="s1">expanded </span><span class="s2">= </span><span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s4">&quot;classifiers&quot; </span><span class="s0">not in </span><span class="s1">expanded</span><span class="s2">[</span><span class="s4">&quot;project&quot;</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;example&quot;</span><span class="s2">,</span>
    <span class="s2">(</span>
        <span class="s4">&quot;&quot;&quot; 
        [project] 
        name = &quot;myproj&quot; 
        version = &quot;1.2&quot; 
 
        [my-tool.that-disrespect.pep518] 
        value = 42 
        &quot;&quot;&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ignore_unrelated_config</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">example</span><span class="s2">):</span>
    <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
    <span class="s1">pyproject</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">cleandoc</span><span class="s2">(</span><span class="s1">example</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s3"># Make sure no error is raised due to 3rd party configs in pyproject.toml</span>
    <span class="s0">assert </span><span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">) </span><span class="s0">is not None</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s4">&quot;example&quot;</span><span class="s2">, </span><span class="s4">&quot;error_msg&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s4">&quot;&quot;&quot; 
            [project] 
            name = &quot;myproj&quot; 
            version = &quot;1.2&quot; 
            requires = ['pywin32; platform_system==&quot;Windows&quot;' ] 
            &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;configuration error: .project. must not contain ..requires.. properties&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_invalid_example</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">example</span><span class="s2">, </span><span class="s1">error_msg</span><span class="s2">):</span>
    <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
    <span class="s1">pyproject</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">cleandoc</span><span class="s2">(</span><span class="s1">example</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s1">pattern </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s4">f&quot;invalid pyproject.toml.*</span><span class="s0">{</span><span class="s1">error_msg</span><span class="s0">}</span><span class="s4">.*&quot;</span><span class="s2">, </span><span class="s1">re</span><span class="s2">.</span><span class="s1">M </span><span class="s2">| </span><span class="s1">re</span><span class="s2">.</span><span class="s1">S</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">pattern</span><span class="s2">):</span>
        <span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;config&quot;</span><span class="s2">, (</span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s4">&quot;[tool.something]</span><span class="s0">\n</span><span class="s4">value = 42&quot;</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">config</span><span class="s2">):</span>
    <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
    <span class="s1">pyproject</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s3"># Make sure no error is raised</span>
    <span class="s0">assert </span><span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">) == {}</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;config&quot;</span><span class="s2">, (</span><span class="s4">&quot;[project]</span><span class="s0">\n</span><span class="s4">name = 'myproj'</span><span class="s0">\n</span><span class="s4">version='42'</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">,))</span>
<span class="s0">def </span><span class="s1">test_include_package_data_by_default</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">config</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Builds with ``pyproject.toml`` should consider ``include-package-data=True`` as 
    default. 
    &quot;&quot;&quot;</span>
    <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
    <span class="s1">pyproject</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s1">config </span><span class="s2">= </span><span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;tool&quot;</span><span class="s2">][</span><span class="s4">&quot;setuptools&quot;</span><span class="s2">][</span><span class="s4">&quot;include-package-data&quot;</span><span class="s2">] </span><span class="s0">is True</span>


<span class="s0">def </span><span class="s1">test_include_package_data_in_setuppy</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Builds with ``pyproject.toml`` should consider ``include_package_data`` set in 
    ``setup.py``. 
 
    See https://github.com/pypa/setuptools/issues/3197#issuecomment-1079023889 
    &quot;&quot;&quot;</span>
    <span class="s1">files </span><span class="s2">= {</span>
        <span class="s4">&quot;pyproject.toml&quot;</span><span class="s2">: </span><span class="s4">&quot;[project]</span><span class="s0">\n</span><span class="s4">name = 'myproj'</span><span class="s0">\n</span><span class="s4">version='42'</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;setup.py&quot;</span><span class="s2">: </span><span class="s4">&quot;__import__('setuptools').setup(include_package_data=False)&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s1">jaraco</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s1">tmp_path</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">distutils</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">run_setup</span><span class="s2">(</span><span class="s4">&quot;setup.py&quot;</span><span class="s2">, {}, </span><span class="s1">stop_after</span><span class="s2">=</span><span class="s4">&quot;config&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_name</span><span class="s2">() == </span><span class="s4">&quot;myproj&quot;</span>
    <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">get_version</span><span class="s2">() == </span><span class="s4">&quot;42&quot;</span>
    <span class="s0">assert </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">include_package_data </span><span class="s0">is False</span>


<span class="s0">def </span><span class="s1">test_warn_tools_typo</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test that the common ``tools.setuptools`` typo in ``pyproject.toml`` issues a warning 
 
    See https://github.com/pypa/setuptools/issues/4150 
    &quot;&quot;&quot;</span>
    <span class="s1">config </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
    [build-system] 
    requires = [&quot;setuptools&quot;] 
    build-backend = &quot;setuptools.build_meta&quot; 
 
    [project] 
    name = &quot;myproj&quot; 
    version = '42' 
 
    [tools.setuptools] 
    packages = [&quot;package&quot;] 
    &quot;&quot;&quot;</span>

    <span class="s1">pyproject </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">&quot;pyproject.toml&quot;</span>
    <span class="s1">pyproject</span><span class="s2">.</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">cleandoc</span><span class="s2">(</span><span class="s1">config</span><span class="s2">), </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">_ToolsTypoInMetadata</span><span class="s2">):</span>
        <span class="s1">read_configuration</span><span class="s2">(</span><span class="s1">pyproject</span><span class="s2">)</span>
</pre>
</body>
</html>