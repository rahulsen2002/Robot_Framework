<html>
<head>
<title>test_wheel.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_wheel.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;wheel tests&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">contextlib</span>
<span class="s2">import </span><span class="s1">glob</span>
<span class="s2">import </span><span class="s1">inspect</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">pathlib</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">stat</span>
<span class="s2">import </span><span class="s1">subprocess</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">zipfile</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span>

<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">jaraco </span><span class="s2">import </span><span class="s1">path</span>
<span class="s2">from </span><span class="s1">packaging</span><span class="s3">.</span><span class="s1">tags </span><span class="s2">import </span><span class="s1">parse_tag</span>
<span class="s2">from </span><span class="s1">packaging</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">canonicalize_name</span>

<span class="s2">from </span><span class="s1">pkg_resources </span><span class="s2">import </span><span class="s1">PY_MAJOR</span><span class="s3">, </span><span class="s1">Distribution</span><span class="s3">, </span><span class="s1">PathMetadata</span>
<span class="s2">from </span><span class="s1">setuptools</span><span class="s3">.</span><span class="s1">wheel </span><span class="s2">import </span><span class="s1">Wheel</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">contexts </span><span class="s2">import </span><span class="s1">tempdir</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">textwrap </span><span class="s2">import </span><span class="s1">DALS</span>

<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">sysconfig </span><span class="s2">import </span><span class="s1">get_config_var</span>
<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">util </span><span class="s2">import </span><span class="s1">get_platform</span>

<span class="s1">WHEEL_INFO_TESTS </span><span class="s3">= (</span>
    <span class="s3">(</span><span class="s4">'invalid.whl'</span><span class="s3">, </span><span class="s1">ValueError</span><span class="s3">),</span>
    <span class="s3">(</span>
        <span class="s4">'simplewheel-2.0-1-py2.py3-none-any.whl'</span><span class="s3">,</span>
        <span class="s3">{</span>
            <span class="s4">'project_name'</span><span class="s3">: </span><span class="s4">'simplewheel'</span><span class="s3">,</span>
            <span class="s4">'version'</span><span class="s3">: </span><span class="s4">'2.0'</span><span class="s3">,</span>
            <span class="s4">'build'</span><span class="s3">: </span><span class="s4">'1'</span><span class="s3">,</span>
            <span class="s4">'py_version'</span><span class="s3">: </span><span class="s4">'py2.py3'</span><span class="s3">,</span>
            <span class="s4">'abi'</span><span class="s3">: </span><span class="s4">'none'</span><span class="s3">,</span>
            <span class="s4">'platform'</span><span class="s3">: </span><span class="s4">'any'</span><span class="s3">,</span>
        <span class="s3">},</span>
    <span class="s3">),</span>
    <span class="s3">(</span>
        <span class="s4">'simple.dist-0.1-py2.py3-none-any.whl'</span><span class="s3">,</span>
        <span class="s3">{</span>
            <span class="s4">'project_name'</span><span class="s3">: </span><span class="s4">'simple.dist'</span><span class="s3">,</span>
            <span class="s4">'version'</span><span class="s3">: </span><span class="s4">'0.1'</span><span class="s3">,</span>
            <span class="s4">'build'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
            <span class="s4">'py_version'</span><span class="s3">: </span><span class="s4">'py2.py3'</span><span class="s3">,</span>
            <span class="s4">'abi'</span><span class="s3">: </span><span class="s4">'none'</span><span class="s3">,</span>
            <span class="s4">'platform'</span><span class="s3">: </span><span class="s4">'any'</span><span class="s3">,</span>
        <span class="s3">},</span>
    <span class="s3">),</span>
    <span class="s3">(</span>
        <span class="s4">'example_pkg_a-1-py3-none-any.whl'</span><span class="s3">,</span>
        <span class="s3">{</span>
            <span class="s4">'project_name'</span><span class="s3">: </span><span class="s4">'example_pkg_a'</span><span class="s3">,</span>
            <span class="s4">'version'</span><span class="s3">: </span><span class="s4">'1'</span><span class="s3">,</span>
            <span class="s4">'build'</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
            <span class="s4">'py_version'</span><span class="s3">: </span><span class="s4">'py3'</span><span class="s3">,</span>
            <span class="s4">'abi'</span><span class="s3">: </span><span class="s4">'none'</span><span class="s3">,</span>
            <span class="s4">'platform'</span><span class="s3">: </span><span class="s4">'any'</span><span class="s3">,</span>
        <span class="s3">},</span>
    <span class="s3">),</span>
    <span class="s3">(</span>
        <span class="s4">'PyQt5-5.9-5.9.1-cp35.cp36.cp37-abi3-manylinux1_x86_64.whl'</span><span class="s3">,</span>
        <span class="s3">{</span>
            <span class="s4">'project_name'</span><span class="s3">: </span><span class="s4">'PyQt5'</span><span class="s3">,</span>
            <span class="s4">'version'</span><span class="s3">: </span><span class="s4">'5.9'</span><span class="s3">,</span>
            <span class="s4">'build'</span><span class="s3">: </span><span class="s4">'5.9.1'</span><span class="s3">,</span>
            <span class="s4">'py_version'</span><span class="s3">: </span><span class="s4">'cp35.cp36.cp37'</span><span class="s3">,</span>
            <span class="s4">'abi'</span><span class="s3">: </span><span class="s4">'abi3'</span><span class="s3">,</span>
            <span class="s4">'platform'</span><span class="s3">: </span><span class="s4">'manylinux1_x86_64'</span><span class="s3">,</span>
        <span class="s3">},</span>
    <span class="s3">),</span>
<span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s3">(</span><span class="s4">'filename'</span><span class="s3">, </span><span class="s4">'info'</span><span class="s3">), </span><span class="s1">WHEEL_INFO_TESTS</span><span class="s3">, </span><span class="s1">ids</span><span class="s3">=[</span><span class="s1">t</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">WHEEL_INFO_TESTS</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_wheel_info</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">info</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">isclass</span><span class="s3">(</span><span class="s1">info</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">info</span><span class="s3">):</span>
            <span class="s1">Wheel</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s2">return</span>
    <span class="s1">w </span><span class="s3">= </span><span class="s1">Wheel</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s3">{</span><span class="s1">k</span><span class="s3">: </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s1">k</span><span class="s3">) </span><span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">info</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()} == </span><span class="s1">info</span>


<span class="s3">@</span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">contextmanager</span>
<span class="s2">def </span><span class="s1">build_wheel</span><span class="s3">(</span><span class="s1">extra_file_defs</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
    <span class="s1">file_defs </span><span class="s3">= {</span>
        <span class="s4">'setup.py'</span><span class="s3">: (</span>
            <span class="s1">DALS</span><span class="s3">(</span>
                <span class="s4">&quot;&quot;&quot; 
            # -*- coding: utf-8 -*- 
            from setuptools import setup 
            import setuptools 
            setup(**%r) 
            &quot;&quot;&quot;</span>
            <span class="s3">)</span>
            <span class="s3">% </span><span class="s1">kwargs</span>
        <span class="s3">).</span><span class="s1">encode</span><span class="s3">(</span><span class="s4">'utf-8'</span><span class="s3">),</span>
    <span class="s3">}</span>
    <span class="s2">if </span><span class="s1">extra_file_defs</span><span class="s3">:</span>
        <span class="s1">file_defs</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">extra_file_defs</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">tempdir</span><span class="s3">() </span><span class="s2">as </span><span class="s1">source_dir</span><span class="s3">:</span>
        <span class="s1">path</span><span class="s3">.</span><span class="s1">build</span><span class="s3">(</span><span class="s1">file_defs</span><span class="s3">, </span><span class="s1">source_dir</span><span class="s3">)</span>
        <span class="s1">subprocess</span><span class="s3">.</span><span class="s1">check_call</span><span class="s3">(</span>
            <span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">executable</span><span class="s3">, </span><span class="s4">'setup.py'</span><span class="s3">, </span><span class="s4">'-q'</span><span class="s3">, </span><span class="s4">'bdist_wheel'</span><span class="s3">), </span><span class="s1">cwd</span><span class="s3">=</span><span class="s1">source_dir</span>
        <span class="s3">)</span>
        <span class="s2">yield </span><span class="s1">glob</span><span class="s3">.</span><span class="s1">glob</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">source_dir</span><span class="s3">, </span><span class="s4">'dist'</span><span class="s3">, </span><span class="s4">'*.whl'</span><span class="s3">))[</span><span class="s5">0</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">tree_set</span><span class="s3">(</span><span class="s1">root</span><span class="s3">):</span>
    <span class="s1">contents </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">dirnames</span><span class="s3">, </span><span class="s1">filenames </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">walk</span><span class="s3">(</span><span class="s1">root</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">filename </span><span class="s2">in </span><span class="s1">filenames</span><span class="s3">:</span>
            <span class="s1">contents</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">relpath</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">root</span><span class="s3">), </span><span class="s1">filename</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">contents</span>


<span class="s2">def </span><span class="s1">flatten_tree</span><span class="s3">(</span><span class="s1">tree</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Flatten nested dicts and lists into a full list of paths&quot;&quot;&quot;</span>
    <span class="s1">output </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">node</span><span class="s3">, </span><span class="s1">contents </span><span class="s2">in </span><span class="s1">tree</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">contents</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
            <span class="s1">contents </span><span class="s3">= </span><span class="s1">flatten_tree</span><span class="s3">(</span><span class="s1">contents</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">elem </span><span class="s2">in </span><span class="s1">contents</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">elem</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
                <span class="s1">output </span><span class="s3">|= {</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">node</span><span class="s3">, </span><span class="s1">val</span><span class="s3">) </span><span class="s2">for </span><span class="s1">val </span><span class="s2">in </span><span class="s1">flatten_tree</span><span class="s3">(</span><span class="s1">elem</span><span class="s3">)}</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">output</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">node</span><span class="s3">, </span><span class="s1">elem</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">output</span>


<span class="s2">def </span><span class="s1">format_install_tree</span><span class="s3">(</span><span class="s1">tree</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s3">{</span>
        <span class="s1">x</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
            <span class="s1">py_version</span><span class="s3">=</span><span class="s1">PY_MAJOR</span><span class="s3">,</span>
            <span class="s1">platform</span><span class="s3">=</span><span class="s1">get_platform</span><span class="s3">(),</span>
            <span class="s1">shlib_ext</span><span class="s3">=</span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s4">'EXT_SUFFIX'</span><span class="s3">) </span><span class="s2">or </span><span class="s1">get_config_var</span><span class="s3">(</span><span class="s4">'SO'</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">tree</span>
    <span class="s3">}</span>


<span class="s2">def </span><span class="s1">_check_wheel_install</span><span class="s3">(</span>
    <span class="s1">filename</span><span class="s3">, </span><span class="s1">install_dir</span><span class="s3">, </span><span class="s1">install_tree_includes</span><span class="s3">, </span><span class="s1">project_name</span><span class="s3">, </span><span class="s1">version</span><span class="s3">, </span><span class="s1">requires_txt</span>
<span class="s3">):</span>
    <span class="s1">w </span><span class="s3">= </span><span class="s1">Wheel</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
    <span class="s1">egg_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">install_dir</span><span class="s3">, </span><span class="s1">w</span><span class="s3">.</span><span class="s1">egg_name</span><span class="s3">())</span>
    <span class="s1">w</span><span class="s3">.</span><span class="s1">install_as_egg</span><span class="s3">(</span><span class="s1">egg_path</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">install_tree_includes </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">install_tree </span><span class="s3">= </span><span class="s1">format_install_tree</span><span class="s3">(</span><span class="s1">install_tree_includes</span><span class="s3">)</span>
        <span class="s1">exp </span><span class="s3">= </span><span class="s1">tree_set</span><span class="s3">(</span><span class="s1">install_dir</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">install_tree</span><span class="s3">.</span><span class="s1">issubset</span><span class="s3">(</span><span class="s1">exp</span><span class="s3">), </span><span class="s1">install_tree </span><span class="s3">- </span><span class="s1">exp</span>

    <span class="s1">metadata </span><span class="s3">= </span><span class="s1">PathMetadata</span><span class="s3">(</span><span class="s1">egg_path</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">egg_path</span><span class="s3">, </span><span class="s4">'EGG-INFO'</span><span class="s3">))</span>
    <span class="s1">dist </span><span class="s3">= </span><span class="s1">Distribution</span><span class="s3">.</span><span class="s1">from_filename</span><span class="s3">(</span><span class="s1">egg_path</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">project_name </span><span class="s3">== </span><span class="s1">project_name</span>
    <span class="s2">assert </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">version </span><span class="s3">== </span><span class="s1">version</span>
    <span class="s2">if </span><span class="s1">requires_txt </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">assert not </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">has_metadata</span><span class="s3">(</span><span class="s4">'requires.txt'</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s6"># Order must match to ensure reproducibility.</span>
        <span class="s2">assert </span><span class="s1">requires_txt </span><span class="s3">== </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">get_metadata</span><span class="s3">(</span><span class="s4">'requires.txt'</span><span class="s3">).</span><span class="s1">lstrip</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">Record</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">id</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_id </span><span class="s3">= </span><span class="s1">id</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_fields </span><span class="s3">= </span><span class="s1">kwargs</span>

    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s4">f'</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_id</span><span class="s2">}</span><span class="s4">(**</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_fields</span><span class="s2">!r}</span><span class="s4">)'</span>


<span class="s6"># Using Any to avoid possible type union issues later in test</span>
<span class="s6"># making a TypedDict is not worth in a test and anonymous/inline TypedDict are experimental</span>
<span class="s6"># https://github.com/python/mypy/issues/9884</span>
<span class="s1">WHEEL_INSTALL_TESTS</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">], ...] = (</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'basic'</span><span class="s3">,</span>
        <span class="s1">file_defs</span><span class="s3">={</span><span class="s4">'foo'</span><span class="s3">: {</span><span class="s4">'__init__.py'</span><span class="s3">: </span><span class="s4">''</span><span class="s3">}},</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">packages</span><span class="s3">=[</span><span class="s4">'foo'</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}.egg'</span><span class="s3">: {</span>
                <span class="s4">'EGG-INFO'</span><span class="s3">: [</span><span class="s4">'PKG-INFO'</span><span class="s3">, </span><span class="s4">'RECORD'</span><span class="s3">, </span><span class="s4">'WHEEL'</span><span class="s3">, </span><span class="s4">'top_level.txt'</span><span class="s3">],</span>
                <span class="s4">'foo'</span><span class="s3">: [</span><span class="s4">'__init__.py'</span><span class="s3">],</span>
            <span class="s3">}</span>
        <span class="s3">}),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'utf-8'</span><span class="s3">,</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">description</span><span class="s3">=</span><span class="s4">'Description accentu√©e'</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'data'</span><span class="s3">,</span>
        <span class="s1">file_defs</span><span class="s3">={</span>
            <span class="s4">'data.txt'</span><span class="s3">: </span><span class="s1">DALS</span><span class="s3">(</span>
                <span class="s4">&quot;&quot;&quot; 
                Some data... 
                &quot;&quot;&quot;</span>
            <span class="s3">),</span>
        <span class="s3">},</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">data_files</span><span class="s3">=[(</span><span class="s4">'data_dir'</span><span class="s3">, [</span><span class="s4">'data.txt'</span><span class="s3">])],</span>
        <span class="s3">),</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}.egg'</span><span class="s3">: {</span>
                <span class="s4">'EGG-INFO'</span><span class="s3">: [</span><span class="s4">'PKG-INFO'</span><span class="s3">, </span><span class="s4">'RECORD'</span><span class="s3">, </span><span class="s4">'WHEEL'</span><span class="s3">, </span><span class="s4">'top_level.txt'</span><span class="s3">],</span>
                <span class="s4">'data_dir'</span><span class="s3">: [</span><span class="s4">'data.txt'</span><span class="s3">],</span>
            <span class="s3">}</span>
        <span class="s3">}),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'extension'</span><span class="s3">,</span>
        <span class="s1">file_defs</span><span class="s3">={</span>
            <span class="s4">'extension.c'</span><span class="s3">: </span><span class="s1">DALS</span><span class="s3">(</span>
                <span class="s4">&quot;&quot;&quot; 
                #include &quot;Python.h&quot; 
 
                #if PY_MAJOR_VERSION &gt;= 3 
 
                static struct PyModuleDef moduledef = { 
                        PyModuleDef_HEAD_INIT, 
                        &quot;extension&quot;, 
                        NULL, 
                        0, 
                        NULL, 
                        NULL, 
                        NULL, 
                        NULL, 
                        NULL 
                }; 
 
                #define INITERROR return NULL 
 
                PyMODINIT_FUNC PyInit_extension(void) 
 
                #else 
 
                #define INITERROR return 
 
                void initextension(void) 
 
                #endif 
                { 
                #if PY_MAJOR_VERSION &gt;= 3 
                    PyObject *module = PyModule_Create(&amp;moduledef); 
                #else 
                    PyObject *module = Py_InitModule(&quot;extension&quot;, NULL); 
                #endif 
                    if (module == NULL) 
                        INITERROR; 
                #if PY_MAJOR_VERSION &gt;= 3 
                    return module; 
                #endif 
                } 
                &quot;&quot;&quot;</span>
            <span class="s3">),</span>
        <span class="s3">},</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">ext_modules</span><span class="s3">=[</span>
                <span class="s1">Record</span><span class="s3">(</span>
                    <span class="s4">'setuptools.Extension'</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">'extension'</span><span class="s3">, </span><span class="s1">sources</span><span class="s3">=[</span><span class="s4">'extension.c'</span><span class="s3">]</span>
                <span class="s3">)</span>
            <span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}-{platform}.egg'</span><span class="s3">: [</span>
                <span class="s4">'extension{shlib_ext}'</span><span class="s3">,</span>
                <span class="s3">{</span>
                    <span class="s4">'EGG-INFO'</span><span class="s3">: [</span>
                        <span class="s4">'PKG-INFO'</span><span class="s3">,</span>
                        <span class="s4">'RECORD'</span><span class="s3">,</span>
                        <span class="s4">'WHEEL'</span><span class="s3">,</span>
                        <span class="s4">'top_level.txt'</span><span class="s3">,</span>
                    <span class="s3">]</span>
                <span class="s3">},</span>
            <span class="s3">]</span>
        <span class="s3">}),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'header'</span><span class="s3">,</span>
        <span class="s1">file_defs</span><span class="s3">={</span>
            <span class="s4">'header.h'</span><span class="s3">: </span><span class="s1">DALS</span><span class="s3">(</span>
                <span class="s4">&quot;&quot;&quot; 
                &quot;&quot;&quot;</span>
            <span class="s3">),</span>
        <span class="s3">},</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">headers</span><span class="s3">=[</span><span class="s4">'header.h'</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}.egg'</span><span class="s3">: [</span>
                <span class="s4">'header.h'</span><span class="s3">,</span>
                <span class="s3">{</span>
                    <span class="s4">'EGG-INFO'</span><span class="s3">: [</span>
                        <span class="s4">'PKG-INFO'</span><span class="s3">,</span>
                        <span class="s4">'RECORD'</span><span class="s3">,</span>
                        <span class="s4">'WHEEL'</span><span class="s3">,</span>
                        <span class="s4">'top_level.txt'</span><span class="s3">,</span>
                    <span class="s3">]</span>
                <span class="s3">},</span>
            <span class="s3">]</span>
        <span class="s3">}),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'script'</span><span class="s3">,</span>
        <span class="s1">file_defs</span><span class="s3">={</span>
            <span class="s4">'script.py'</span><span class="s3">: </span><span class="s1">DALS</span><span class="s3">(</span>
                <span class="s4">&quot;&quot;&quot; 
                #/usr/bin/python 
                print('hello world!') 
                &quot;&quot;&quot;</span>
            <span class="s3">),</span>
            <span class="s4">'script.sh'</span><span class="s3">: </span><span class="s1">DALS</span><span class="s3">(</span>
                <span class="s4">&quot;&quot;&quot; 
                #/bin/sh 
                echo 'hello world!' 
                &quot;&quot;&quot;</span>
            <span class="s3">),</span>
        <span class="s3">},</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">scripts</span><span class="s3">=[</span><span class="s4">'script.py'</span><span class="s3">, </span><span class="s4">'script.sh'</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}.egg'</span><span class="s3">: {</span>
                <span class="s4">'EGG-INFO'</span><span class="s3">: [</span>
                    <span class="s4">'PKG-INFO'</span><span class="s3">,</span>
                    <span class="s4">'RECORD'</span><span class="s3">,</span>
                    <span class="s4">'WHEEL'</span><span class="s3">,</span>
                    <span class="s4">'top_level.txt'</span><span class="s3">,</span>
                    <span class="s3">{</span><span class="s4">'scripts'</span><span class="s3">: [</span><span class="s4">'script.py'</span><span class="s3">, </span><span class="s4">'script.sh'</span><span class="s3">]},</span>
                <span class="s3">]</span>
            <span class="s3">}</span>
        <span class="s3">}),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'requires1'</span><span class="s3">,</span>
        <span class="s1">install_requires</span><span class="s3">=</span><span class="s4">'foobar==2.0'</span><span class="s3">,</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}.egg'</span><span class="s3">: {</span>
                <span class="s4">'EGG-INFO'</span><span class="s3">: [</span>
                    <span class="s4">'PKG-INFO'</span><span class="s3">,</span>
                    <span class="s4">'RECORD'</span><span class="s3">,</span>
                    <span class="s4">'WHEEL'</span><span class="s3">,</span>
                    <span class="s4">'requires.txt'</span><span class="s3">,</span>
                    <span class="s4">'top_level.txt'</span><span class="s3">,</span>
                <span class="s3">]</span>
            <span class="s3">}</span>
        <span class="s3">}),</span>
        <span class="s1">requires_txt</span><span class="s3">=</span><span class="s1">DALS</span><span class="s3">(</span>
            <span class="s4">&quot;&quot;&quot; 
            foobar==2.0 
            &quot;&quot;&quot;</span>
        <span class="s3">),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'requires2'</span><span class="s3">,</span>
        <span class="s1">install_requires</span><span class="s3">=</span><span class="s4">f&quot;&quot;&quot;</span>
        <span class="s4">bar</span>
        <span class="s4">foo&lt;=2.0; </span><span class="s2">{</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform</span><span class="s2">!r} </span><span class="s4">in sys_platform</span>
        <span class="s4">&quot;&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">requires_txt</span><span class="s3">=</span><span class="s1">DALS</span><span class="s3">(</span>
            <span class="s4">&quot;&quot;&quot; 
            bar 
            foo&lt;=2.0 
            &quot;&quot;&quot;</span>
        <span class="s3">),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'requires3'</span><span class="s3">,</span>
        <span class="s1">install_requires</span><span class="s3">=</span><span class="s4">f&quot;&quot;&quot;</span>
        <span class="s4">bar; </span><span class="s2">{</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform</span><span class="s2">!r} </span><span class="s4">!= sys_platform</span>
        <span class="s4">&quot;&quot;&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'requires4'</span><span class="s3">,</span>
        <span class="s1">install_requires</span><span class="s3">=</span><span class="s4">&quot;&quot;&quot; 
        foo 
        &quot;&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">extras_require</span><span class="s3">={</span>
            <span class="s4">'extra'</span><span class="s3">: </span><span class="s4">'foobar&gt;3'</span><span class="s3">,</span>
        <span class="s3">},</span>
        <span class="s1">requires_txt</span><span class="s3">=</span><span class="s1">DALS</span><span class="s3">(</span>
            <span class="s4">&quot;&quot;&quot; 
            foo 
 
            [extra] 
            foobar&gt;3 
            &quot;&quot;&quot;</span>
        <span class="s3">),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'requires5'</span><span class="s3">,</span>
        <span class="s1">extras_require</span><span class="s3">={</span>
            <span class="s4">'extra'</span><span class="s3">: </span><span class="s4">f'foobar; </span><span class="s2">{</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform</span><span class="s2">!r} </span><span class="s4">!= sys_platform'</span><span class="s3">,</span>
        <span class="s3">},</span>
        <span class="s1">requires_txt</span><span class="s3">=</span><span class="s1">DALS</span><span class="s3">(</span>
            <span class="s4">&quot;&quot;&quot; 
            [extra] 
            &quot;&quot;&quot;</span>
        <span class="s3">),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'requires_ensure_order'</span><span class="s3">,</span>
        <span class="s1">install_requires</span><span class="s3">=</span><span class="s4">&quot;&quot;&quot; 
        foo 
        bar 
        baz 
        qux 
        &quot;&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">extras_require</span><span class="s3">={</span>
            <span class="s4">'extra'</span><span class="s3">: </span><span class="s4">&quot;&quot;&quot; 
            foobar&gt;3 
            barbaz&gt;4 
            bazqux&gt;5 
            quxzap&gt;6 
            &quot;&quot;&quot;</span><span class="s3">,</span>
        <span class="s3">},</span>
        <span class="s1">requires_txt</span><span class="s3">=</span><span class="s1">DALS</span><span class="s3">(</span>
            <span class="s4">&quot;&quot;&quot; 
            foo 
            bar 
            baz 
            qux 
 
            [extra] 
            foobar&gt;3 
            barbaz&gt;4 
            bazqux&gt;5 
            quxzap&gt;6 
            &quot;&quot;&quot;</span>
        <span class="s3">),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'namespace_package'</span><span class="s3">,</span>
        <span class="s1">file_defs</span><span class="s3">={</span>
            <span class="s4">'foo'</span><span class="s3">: {</span>
                <span class="s4">'bar'</span><span class="s3">: {</span><span class="s4">'__init__.py'</span><span class="s3">: </span><span class="s4">''</span><span class="s3">},</span>
            <span class="s3">},</span>
        <span class="s3">},</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">namespace_packages</span><span class="s3">=[</span><span class="s4">'foo'</span><span class="s3">],</span>
            <span class="s1">packages</span><span class="s3">=[</span><span class="s4">'foo.bar'</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}.egg'</span><span class="s3">: [</span>
                <span class="s4">'foo-1.0-py{py_version}-nspkg.pth'</span><span class="s3">,</span>
                <span class="s3">{</span>
                    <span class="s4">'EGG-INFO'</span><span class="s3">: [</span>
                        <span class="s4">'PKG-INFO'</span><span class="s3">,</span>
                        <span class="s4">'RECORD'</span><span class="s3">,</span>
                        <span class="s4">'WHEEL'</span><span class="s3">,</span>
                        <span class="s4">'namespace_packages.txt'</span><span class="s3">,</span>
                        <span class="s4">'top_level.txt'</span><span class="s3">,</span>
                    <span class="s3">]</span>
                <span class="s3">},</span>
                <span class="s3">{</span>
                    <span class="s4">'foo'</span><span class="s3">: [</span>
                        <span class="s4">'__init__.py'</span><span class="s3">,</span>
                        <span class="s3">{</span><span class="s4">'bar'</span><span class="s3">: [</span><span class="s4">'__init__.py'</span><span class="s3">]},</span>
                    <span class="s3">]</span>
                <span class="s3">},</span>
            <span class="s3">]</span>
        <span class="s3">}),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'empty_namespace_package'</span><span class="s3">,</span>
        <span class="s1">file_defs</span><span class="s3">={</span>
            <span class="s4">'foobar'</span><span class="s3">: {</span>
                <span class="s4">'__init__.py'</span><span class="s3">: (</span>
                    <span class="s4">&quot;__import__('pkg_resources').declare_namespace(__name__)&quot;</span>
                <span class="s3">)</span>
            <span class="s3">},</span>
        <span class="s3">},</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">namespace_packages</span><span class="s3">=[</span><span class="s4">'foobar'</span><span class="s3">],</span>
            <span class="s1">packages</span><span class="s3">=[</span><span class="s4">'foobar'</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}.egg'</span><span class="s3">: [</span>
                <span class="s4">'foo-1.0-py{py_version}-nspkg.pth'</span><span class="s3">,</span>
                <span class="s3">{</span>
                    <span class="s4">'EGG-INFO'</span><span class="s3">: [</span>
                        <span class="s4">'PKG-INFO'</span><span class="s3">,</span>
                        <span class="s4">'RECORD'</span><span class="s3">,</span>
                        <span class="s4">'WHEEL'</span><span class="s3">,</span>
                        <span class="s4">'namespace_packages.txt'</span><span class="s3">,</span>
                        <span class="s4">'top_level.txt'</span><span class="s3">,</span>
                    <span class="s3">]</span>
                <span class="s3">},</span>
                <span class="s3">{</span>
                    <span class="s4">'foobar'</span><span class="s3">: [</span>
                        <span class="s4">'__init__.py'</span><span class="s3">,</span>
                    <span class="s3">]</span>
                <span class="s3">},</span>
            <span class="s3">]</span>
        <span class="s3">}),</span>
    <span class="s3">),</span>
    <span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'data_in_package'</span><span class="s3">,</span>
        <span class="s1">file_defs</span><span class="s3">={</span>
            <span class="s4">'foo'</span><span class="s3">: {</span>
                <span class="s4">'__init__.py'</span><span class="s3">: </span><span class="s4">''</span><span class="s3">,</span>
                <span class="s4">'data_dir'</span><span class="s3">: {</span>
                    <span class="s4">'data.txt'</span><span class="s3">: </span><span class="s1">DALS</span><span class="s3">(</span>
                        <span class="s4">&quot;&quot;&quot; 
                        Some data... 
                        &quot;&quot;&quot;</span>
                    <span class="s3">),</span>
                <span class="s3">},</span>
            <span class="s3">}</span>
        <span class="s3">},</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">packages</span><span class="s3">=[</span><span class="s4">'foo'</span><span class="s3">],</span>
            <span class="s1">data_files</span><span class="s3">=[(</span><span class="s4">'foo/data_dir'</span><span class="s3">, [</span><span class="s4">'foo/data_dir/data.txt'</span><span class="s3">])],</span>
        <span class="s3">),</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}.egg'</span><span class="s3">: {</span>
                <span class="s4">'EGG-INFO'</span><span class="s3">: [</span>
                    <span class="s4">'PKG-INFO'</span><span class="s3">,</span>
                    <span class="s4">'RECORD'</span><span class="s3">,</span>
                    <span class="s4">'WHEEL'</span><span class="s3">,</span>
                    <span class="s4">'top_level.txt'</span><span class="s3">,</span>
                <span class="s3">],</span>
                <span class="s4">'foo'</span><span class="s3">: [</span>
                    <span class="s4">'__init__.py'</span><span class="s3">,</span>
                    <span class="s3">{</span>
                        <span class="s4">'data_dir'</span><span class="s3">: [</span>
                            <span class="s4">'data.txt'</span><span class="s3">,</span>
                        <span class="s3">]</span>
                    <span class="s3">},</span>
                <span class="s3">],</span>
            <span class="s3">}</span>
        <span class="s3">}),</span>
    <span class="s3">),</span>
<span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">'params'</span><span class="s3">,</span>
    <span class="s1">WHEEL_INSTALL_TESTS</span><span class="s3">,</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'id'</span><span class="s3">] </span><span class="s2">for </span><span class="s1">params </span><span class="s2">in </span><span class="s1">WHEEL_INSTALL_TESTS</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_wheel_install</span><span class="s3">(</span><span class="s1">params</span><span class="s3">):</span>
    <span class="s1">project_name </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'name'</span><span class="s3">, </span><span class="s4">'foo'</span><span class="s3">)</span>
    <span class="s1">version </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'version'</span><span class="s3">, </span><span class="s4">'1.0'</span><span class="s3">)</span>
    <span class="s1">install_requires </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'install_requires'</span><span class="s3">, [])</span>
    <span class="s1">extras_require </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'extras_require'</span><span class="s3">, {})</span>
    <span class="s1">requires_txt </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'requires_txt'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">install_tree </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'install_tree'</span><span class="s3">)</span>
    <span class="s1">file_defs </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'file_defs'</span><span class="s3">, {})</span>
    <span class="s1">setup_kwargs </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'setup_kwargs'</span><span class="s3">, {})</span>
    <span class="s2">with </span><span class="s3">(</span>
        <span class="s1">build_wheel</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">project_name</span><span class="s3">,</span>
            <span class="s1">version</span><span class="s3">=</span><span class="s1">version</span><span class="s3">,</span>
            <span class="s1">install_requires</span><span class="s3">=</span><span class="s1">install_requires</span><span class="s3">,</span>
            <span class="s1">extras_require</span><span class="s3">=</span><span class="s1">extras_require</span><span class="s3">,</span>
            <span class="s1">extra_file_defs</span><span class="s3">=</span><span class="s1">file_defs</span><span class="s3">,</span>
            <span class="s3">**</span><span class="s1">setup_kwargs</span><span class="s3">,</span>
        <span class="s3">) </span><span class="s2">as </span><span class="s1">filename</span><span class="s3">,</span>
        <span class="s1">tempdir</span><span class="s3">() </span><span class="s2">as </span><span class="s1">install_dir</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">_check_wheel_install</span><span class="s3">(</span>
            <span class="s1">filename</span><span class="s3">, </span><span class="s1">install_dir</span><span class="s3">, </span><span class="s1">install_tree</span><span class="s3">, </span><span class="s1">project_name</span><span class="s3">, </span><span class="s1">version</span><span class="s3">, </span><span class="s1">requires_txt</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_wheel_install_pep_503</span><span class="s3">():</span>
    <span class="s1">project_name </span><span class="s3">= </span><span class="s4">'Foo_Bar'  </span><span class="s6"># PEP 503 canonicalized name is &quot;foo-bar&quot;</span>
    <span class="s1">version </span><span class="s3">= </span><span class="s4">'1.0'</span>
    <span class="s2">with </span><span class="s3">(</span>
        <span class="s1">build_wheel</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">project_name</span><span class="s3">,</span>
            <span class="s1">version</span><span class="s3">=</span><span class="s1">version</span><span class="s3">,</span>
        <span class="s3">) </span><span class="s2">as </span><span class="s1">filename</span><span class="s3">,</span>
        <span class="s1">tempdir</span><span class="s3">() </span><span class="s2">as </span><span class="s1">install_dir</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">new_filename </span><span class="s3">= </span><span class="s1">filename</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">project_name</span><span class="s3">, </span><span class="s1">canonicalize_name</span><span class="s3">(</span><span class="s1">project_name</span><span class="s3">))</span>
        <span class="s1">shutil</span><span class="s3">.</span><span class="s1">move</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">new_filename</span><span class="s3">)</span>
        <span class="s1">_check_wheel_install</span><span class="s3">(</span>
            <span class="s1">new_filename</span><span class="s3">,</span>
            <span class="s1">install_dir</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s1">canonicalize_name</span><span class="s3">(</span><span class="s1">project_name</span><span class="s3">),</span>
            <span class="s1">version</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_wheel_no_dist_dir</span><span class="s3">():</span>
    <span class="s1">project_name </span><span class="s3">= </span><span class="s4">'nodistinfo'</span>
    <span class="s1">version </span><span class="s3">= </span><span class="s4">'1.0'</span>
    <span class="s1">wheel_name </span><span class="s3">= </span><span class="s4">f'</span><span class="s2">{</span><span class="s1">project_name</span><span class="s2">}</span><span class="s4">-</span><span class="s2">{</span><span class="s1">version</span><span class="s2">}</span><span class="s4">-py2.py3-none-any.whl'</span>
    <span class="s2">with </span><span class="s1">tempdir</span><span class="s3">() </span><span class="s2">as </span><span class="s1">source_dir</span><span class="s3">:</span>
        <span class="s1">wheel_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">source_dir</span><span class="s3">, </span><span class="s1">wheel_name</span><span class="s3">)</span>
        <span class="s6"># create an empty zip file</span>
        <span class="s1">zipfile</span><span class="s3">.</span><span class="s1">ZipFile</span><span class="s3">(</span><span class="s1">wheel_path</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">).</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s2">with </span><span class="s1">tempdir</span><span class="s3">() </span><span class="s2">as </span><span class="s1">install_dir</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
                <span class="s1">_check_wheel_install</span><span class="s3">(</span>
                    <span class="s1">wheel_path</span><span class="s3">, </span><span class="s1">install_dir</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">project_name</span><span class="s3">, </span><span class="s1">version</span><span class="s3">, </span><span class="s2">None</span>
                <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_wheel_is_compatible</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">sys_tags</span><span class="s3">():</span>
        <span class="s2">return </span><span class="s3">{</span>
            <span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">interpreter</span><span class="s3">, </span><span class="s1">t</span><span class="s3">.</span><span class="s1">abi</span><span class="s3">, </span><span class="s1">t</span><span class="s3">.</span><span class="s1">platform</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">parse_tag</span><span class="s3">(</span><span class="s4">'cp36-cp36m-manylinux1_x86_64'</span><span class="s3">)</span>
        <span class="s3">}</span>

    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s4">'setuptools.wheel._get_supported_tags'</span><span class="s3">, </span><span class="s1">sys_tags</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">Wheel</span><span class="s3">(</span><span class="s4">'onnxruntime-0.1.2-cp36-cp36m-manylinux1_x86_64.whl'</span><span class="s3">).</span><span class="s1">is_compatible</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_wheel_mode</span><span class="s3">():</span>
    <span class="s3">@</span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">contextmanager</span>
    <span class="s2">def </span><span class="s1">build_wheel</span><span class="s3">(</span><span class="s1">extra_file_defs</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">file_defs </span><span class="s3">= {</span>
            <span class="s4">'setup.py'</span><span class="s3">: (</span>
                <span class="s1">DALS</span><span class="s3">(</span>
                    <span class="s4">&quot;&quot;&quot; 
                # -*- coding: utf-8 -*- 
                from setuptools import setup 
                import setuptools 
                setup(**%r) 
                &quot;&quot;&quot;</span>
                <span class="s3">)</span>
                <span class="s3">% </span><span class="s1">kwargs</span>
            <span class="s3">).</span><span class="s1">encode</span><span class="s3">(</span><span class="s4">'utf-8'</span><span class="s3">),</span>
        <span class="s3">}</span>
        <span class="s2">if </span><span class="s1">extra_file_defs</span><span class="s3">:</span>
            <span class="s1">file_defs</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">extra_file_defs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">tempdir</span><span class="s3">() </span><span class="s2">as </span><span class="s1">source_dir</span><span class="s3">:</span>
            <span class="s1">path</span><span class="s3">.</span><span class="s1">build</span><span class="s3">(</span><span class="s1">file_defs</span><span class="s3">, </span><span class="s1">source_dir</span><span class="s3">)</span>
            <span class="s1">runsh </span><span class="s3">= </span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">source_dir</span><span class="s3">) / </span><span class="s4">&quot;script.sh&quot;</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">chmod</span><span class="s3">(</span><span class="s1">runsh</span><span class="s3">, </span><span class="s5">0o777</span><span class="s3">)</span>
            <span class="s1">subprocess</span><span class="s3">.</span><span class="s1">check_call</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">executable</span><span class="s3">, </span><span class="s4">'setup.py'</span><span class="s3">, </span><span class="s4">'-q'</span><span class="s3">, </span><span class="s4">'bdist_wheel'</span><span class="s3">), </span><span class="s1">cwd</span><span class="s3">=</span><span class="s1">source_dir</span>
            <span class="s3">)</span>
            <span class="s2">yield </span><span class="s1">glob</span><span class="s3">.</span><span class="s1">glob</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">source_dir</span><span class="s3">, </span><span class="s4">'dist'</span><span class="s3">, </span><span class="s4">'*.whl'</span><span class="s3">))[</span><span class="s5">0</span><span class="s3">]</span>

    <span class="s1">params </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">id</span><span class="s3">=</span><span class="s4">'script'</span><span class="s3">,</span>
        <span class="s1">file_defs</span><span class="s3">={</span>
            <span class="s4">'script.py'</span><span class="s3">: </span><span class="s1">DALS</span><span class="s3">(</span>
                <span class="s4">&quot;&quot;&quot; 
                #/usr/bin/python 
                print('hello world!') 
                &quot;&quot;&quot;</span>
            <span class="s3">),</span>
            <span class="s4">'script.sh'</span><span class="s3">: </span><span class="s1">DALS</span><span class="s3">(</span>
                <span class="s4">&quot;&quot;&quot; 
                #/bin/sh 
                echo 'hello world!' 
                &quot;&quot;&quot;</span>
            <span class="s3">),</span>
        <span class="s3">},</span>
        <span class="s1">setup_kwargs</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">scripts</span><span class="s3">=[</span><span class="s4">'script.py'</span><span class="s3">, </span><span class="s4">'script.sh'</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s1">install_tree</span><span class="s3">=</span><span class="s1">flatten_tree</span><span class="s3">({</span>
            <span class="s4">'foo-1.0-py{py_version}.egg'</span><span class="s3">: {</span>
                <span class="s4">'EGG-INFO'</span><span class="s3">: [</span>
                    <span class="s4">'PKG-INFO'</span><span class="s3">,</span>
                    <span class="s4">'RECORD'</span><span class="s3">,</span>
                    <span class="s4">'WHEEL'</span><span class="s3">,</span>
                    <span class="s4">'top_level.txt'</span><span class="s3">,</span>
                    <span class="s3">{</span><span class="s4">'scripts'</span><span class="s3">: [</span><span class="s4">'script.py'</span><span class="s3">, </span><span class="s4">'script.sh'</span><span class="s3">]},</span>
                <span class="s3">]</span>
            <span class="s3">}</span>
        <span class="s3">}),</span>
    <span class="s3">)</span>

    <span class="s1">project_name </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'name'</span><span class="s3">, </span><span class="s4">'foo'</span><span class="s3">)</span>
    <span class="s1">version </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'version'</span><span class="s3">, </span><span class="s4">'1.0'</span><span class="s3">)</span>
    <span class="s1">install_tree </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'install_tree'</span><span class="s3">)</span>
    <span class="s1">file_defs </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'file_defs'</span><span class="s3">, {})</span>
    <span class="s1">setup_kwargs </span><span class="s3">= </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'setup_kwargs'</span><span class="s3">, {})</span>

    <span class="s2">with </span><span class="s3">(</span>
        <span class="s1">build_wheel</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">project_name</span><span class="s3">,</span>
            <span class="s1">version</span><span class="s3">=</span><span class="s1">version</span><span class="s3">,</span>
            <span class="s1">install_requires</span><span class="s3">=[],</span>
            <span class="s1">extras_require</span><span class="s3">={},</span>
            <span class="s1">extra_file_defs</span><span class="s3">=</span><span class="s1">file_defs</span><span class="s3">,</span>
            <span class="s3">**</span><span class="s1">setup_kwargs</span><span class="s3">,</span>
        <span class="s3">) </span><span class="s2">as </span><span class="s1">filename</span><span class="s3">,</span>
        <span class="s1">tempdir</span><span class="s3">() </span><span class="s2">as </span><span class="s1">install_dir</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">_check_wheel_install</span><span class="s3">(</span>
            <span class="s1">filename</span><span class="s3">, </span><span class="s1">install_dir</span><span class="s3">, </span><span class="s1">install_tree</span><span class="s3">, </span><span class="s1">project_name</span><span class="s3">, </span><span class="s1">version</span><span class="s3">, </span><span class="s2">None</span>
        <span class="s3">)</span>
        <span class="s1">w </span><span class="s3">= </span><span class="s1">Wheel</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s1">base </span><span class="s3">= </span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">install_dir</span><span class="s3">) / </span><span class="s1">w</span><span class="s3">.</span><span class="s1">egg_name</span><span class="s3">()</span>
        <span class="s1">script_sh </span><span class="s3">= </span><span class="s1">base </span><span class="s3">/ </span><span class="s4">&quot;EGG-INFO&quot; </span><span class="s3">/ </span><span class="s4">&quot;scripts&quot; </span><span class="s3">/ </span><span class="s4">&quot;script.sh&quot;</span>
        <span class="s2">assert </span><span class="s1">script_sh</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">!= </span><span class="s4">'win32'</span><span class="s3">:</span>
            <span class="s6"># Editable file mode has no effect on Windows</span>
            <span class="s2">assert </span><span class="s1">oct</span><span class="s3">(</span><span class="s1">stat</span><span class="s3">.</span><span class="s1">S_IMODE</span><span class="s3">(</span><span class="s1">script_sh</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">().</span><span class="s1">st_mode</span><span class="s3">)) == </span><span class="s4">&quot;0o777&quot;</span>
</pre>
</body>
</html>