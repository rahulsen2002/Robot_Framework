<html>
<head>
<title>test_resources.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_resources.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">string</span>
<span class="s0">import </span><span class="s1">sys</span>

<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">packaging</span><span class="s2">.</span><span class="s1">specifiers </span><span class="s0">import </span><span class="s1">SpecifierSet</span>

<span class="s0">import </span><span class="s1">pkg_resources</span>
<span class="s0">from </span><span class="s1">pkg_resources </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">Distribution</span><span class="s2">,</span>
    <span class="s1">EntryPoint</span><span class="s2">,</span>
    <span class="s1">Requirement</span><span class="s2">,</span>
    <span class="s1">VersionConflict</span><span class="s2">,</span>
    <span class="s1">WorkingSet</span><span class="s2">,</span>
    <span class="s1">parse_requirements</span><span class="s2">,</span>
    <span class="s1">parse_version</span><span class="s2">,</span>
    <span class="s1">safe_name</span><span class="s2">,</span>
    <span class="s1">safe_version</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s3"># from Python 3.6 docs. Available from itertools on Python 3.10</span>
<span class="s0">def </span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">iterable</span><span class="s2">):</span>
    <span class="s4">&quot;s -&gt; (s0,s1), (s1,s2), (s2, s3), ...&quot;</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">tee</span><span class="s2">(</span><span class="s1">iterable</span><span class="s2">)</span>
    <span class="s1">next</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Metadata</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">EmptyProvider</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Mock object to return metadata as if from an on-disk distribution&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">pairs</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">metadata </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">pairs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">has_metadata</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metadata</span>

    <span class="s0">def </span><span class="s1">get_metadata</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metadata</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">get_metadata_lines</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">yield_lines</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_metadata</span><span class="s2">(</span><span class="s1">name</span><span class="s2">))</span>


<span class="s1">dist_from_fn </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span>


<span class="s0">class </span><span class="s1">TestDistro</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">testCollection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># empty path should produce no distributions</span>
        <span class="s1">ad </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">([], </span><span class="s1">platform</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">python</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ad</span><span class="s2">) == []</span>
        <span class="s0">assert </span><span class="s1">ad</span><span class="s2">[</span><span class="s5">'FooPkg'</span><span class="s2">] == []</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">dist_from_fn</span><span class="s2">(</span><span class="s5">&quot;FooPkg-1.3_1.egg&quot;</span><span class="s2">))</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">dist_from_fn</span><span class="s2">(</span><span class="s5">&quot;FooPkg-1.4-py2.4-win32.egg&quot;</span><span class="s2">))</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">dist_from_fn</span><span class="s2">(</span><span class="s5">&quot;FooPkg-1.2-py2.4.egg&quot;</span><span class="s2">))</span>

        <span class="s3"># Name is in there now</span>
        <span class="s0">assert </span><span class="s1">ad</span><span class="s2">[</span><span class="s5">'FooPkg'</span><span class="s2">]</span>
        <span class="s3"># But only 1 package</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ad</span><span class="s2">) == [</span><span class="s5">'foopkg'</span><span class="s2">]</span>

        <span class="s3"># Distributions sort by version</span>
        <span class="s1">expected </span><span class="s2">= [</span><span class="s5">'1.4'</span><span class="s2">, </span><span class="s5">'1.3-1'</span><span class="s2">, </span><span class="s5">'1.2'</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s2">[</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">version </span><span class="s0">for </span><span class="s1">dist </span><span class="s0">in </span><span class="s1">ad</span><span class="s2">[</span><span class="s5">'FooPkg'</span><span class="s2">]] == </span><span class="s1">expected</span>

        <span class="s3"># Removing a distribution leaves sequence alone</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">ad</span><span class="s2">[</span><span class="s5">'FooPkg'</span><span class="s2">][</span><span class="s6">1</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s2">[</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">version </span><span class="s0">for </span><span class="s1">dist </span><span class="s0">in </span><span class="s1">ad</span><span class="s2">[</span><span class="s5">'FooPkg'</span><span class="s2">]] == [</span><span class="s5">'1.4'</span><span class="s2">, </span><span class="s5">'1.2'</span><span class="s2">]</span>

        <span class="s3"># And inserting adds them in order</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">dist_from_fn</span><span class="s2">(</span><span class="s5">&quot;FooPkg-1.9.egg&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s2">[</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">version </span><span class="s0">for </span><span class="s1">dist </span><span class="s0">in </span><span class="s1">ad</span><span class="s2">[</span><span class="s5">'FooPkg'</span><span class="s2">]] == [</span><span class="s5">'1.9'</span><span class="s2">, </span><span class="s5">'1.4'</span><span class="s2">, </span><span class="s5">'1.2'</span><span class="s2">]</span>

        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">foo12 </span><span class="s2">= </span><span class="s1">dist_from_fn</span><span class="s2">(</span><span class="s5">&quot;FooPkg-1.2-py2.4.egg&quot;</span><span class="s2">)</span>
        <span class="s1">foo14 </span><span class="s2">= </span><span class="s1">dist_from_fn</span><span class="s2">(</span><span class="s5">&quot;FooPkg-1.4-py2.4-win32.egg&quot;</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">req</span><span class="s2">,) = </span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;FooPkg&gt;=1.3&quot;</span><span class="s2">)</span>

        <span class="s3"># Nominal case: no distros on path, should yield all applicable</span>
        <span class="s0">assert </span><span class="s1">ad</span><span class="s2">.</span><span class="s1">best_match</span><span class="s2">(</span><span class="s1">req</span><span class="s2">, </span><span class="s1">ws</span><span class="s2">).</span><span class="s1">version </span><span class="s2">== </span><span class="s5">'1.9'</span>
        <span class="s3"># If a matching distro is already installed, should return only that</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">foo14</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ad</span><span class="s2">.</span><span class="s1">best_match</span><span class="s2">(</span><span class="s1">req</span><span class="s2">, </span><span class="s1">ws</span><span class="s2">).</span><span class="s1">version </span><span class="s2">== </span><span class="s5">'1.4'</span>

        <span class="s3"># If the first matching distro is unsuitable, it's a version conflict</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">foo12</span><span class="s2">)</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">foo14</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">VersionConflict</span><span class="s2">):</span>
            <span class="s1">ad</span><span class="s2">.</span><span class="s1">best_match</span><span class="s2">(</span><span class="s1">req</span><span class="s2">, </span><span class="s1">ws</span><span class="s2">)</span>

        <span class="s3"># If more than one match on the path, the first one takes precedence</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">foo14</span><span class="s2">)</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">foo12</span><span class="s2">)</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">foo14</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ad</span><span class="s2">.</span><span class="s1">best_match</span><span class="s2">(</span><span class="s1">req</span><span class="s2">, </span><span class="s1">ws</span><span class="s2">).</span><span class="s1">version </span><span class="s2">== </span><span class="s5">'1.4'</span>

    <span class="s0">def </span><span class="s1">checkFooPkg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">d</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">.</span><span class="s1">project_name </span><span class="s2">== </span><span class="s5">&quot;FooPkg&quot;</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">.</span><span class="s1">key </span><span class="s2">== </span><span class="s5">&quot;foopkg&quot;</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">.</span><span class="s1">version </span><span class="s2">== </span><span class="s5">&quot;1.3.post1&quot;</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">.</span><span class="s1">py_version </span><span class="s2">== </span><span class="s5">&quot;2.4&quot;</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s5">&quot;win32&quot;</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">.</span><span class="s1">parsed_version </span><span class="s2">== </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s5">&quot;1.3-1&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">testDistroBasics</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">(</span>
            <span class="s5">&quot;/some/path&quot;</span><span class="s2">,</span>
            <span class="s1">project_name</span><span class="s2">=</span><span class="s5">&quot;FooPkg&quot;</span><span class="s2">,</span>
            <span class="s1">version</span><span class="s2">=</span><span class="s5">&quot;1.3-1&quot;</span><span class="s2">,</span>
            <span class="s1">py_version</span><span class="s2">=</span><span class="s5">&quot;2.4&quot;</span><span class="s2">,</span>
            <span class="s1">platform</span><span class="s2">=</span><span class="s5">&quot;win32&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkFooPkg</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>

        <span class="s1">d </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">(</span><span class="s5">&quot;/some/path&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">.</span><span class="s1">py_version </span><span class="s2">== </span><span class="s5">f'</span><span class="s0">{</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">.</span><span class="s1">major</span><span class="s0">}</span><span class="s5">.</span><span class="s0">{</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">.</span><span class="s1">minor</span><span class="s0">}</span><span class="s5">'</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">.</span><span class="s1">platform </span><span class="s0">is None</span>

    <span class="s0">def </span><span class="s1">testDistroParse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">dist_from_fn</span><span class="s2">(</span><span class="s5">&quot;FooPkg-1.3.post1-py2.4-win32.egg&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkFooPkg</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">dist_from_fn</span><span class="s2">(</span><span class="s5">&quot;FooPkg-1.3.post1-py2.4-win32.egg-info&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkFooPkg</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">testDistroMetadata</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">(</span>
            <span class="s5">&quot;/some/path&quot;</span><span class="s2">,</span>
            <span class="s1">project_name</span><span class="s2">=</span><span class="s5">&quot;FooPkg&quot;</span><span class="s2">,</span>
            <span class="s1">py_version</span><span class="s2">=</span><span class="s5">&quot;2.4&quot;</span><span class="s2">,</span>
            <span class="s1">platform</span><span class="s2">=</span><span class="s5">&quot;win32&quot;</span><span class="s2">,</span>
            <span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span><span class="s5">'PKG-INFO'</span><span class="s2">, </span><span class="s5">&quot;Metadata-Version: 1.0</span><span class="s0">\n</span><span class="s5">Version: 1.3-1</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s2">)),</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkFooPkg</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">distRequires</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">txt</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Distribution</span><span class="s2">(</span><span class="s5">&quot;/foo&quot;</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span><span class="s5">'depends.txt'</span><span class="s2">, </span><span class="s1">txt</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">checkRequires</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">, </span><span class="s1">txt</span><span class="s2">, </span><span class="s1">extras</span><span class="s2">=()):</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">(</span><span class="s1">extras</span><span class="s2">)) == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s1">txt</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">testDistroDependsSimple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s5">&quot;Twisted&gt;=1.5&quot;</span><span class="s2">, </span><span class="s5">&quot;Twisted&gt;=1.5</span><span class="s0">\n</span><span class="s5">ZConfig&gt;=2.0&quot;</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">checkRequires</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">distRequires</span><span class="s2">(</span><span class="s1">v</span><span class="s2">), </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s1">needs_object_dir </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
        <span class="s0">not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">object</span><span class="s2">, </span><span class="s5">'__dir__'</span><span class="s2">),</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s5">'object.__dir__ necessary for self.__dir__ implementation'</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_distribution_dir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Distribution</span><span class="s2">()</span>
        <span class="s1">dir</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">needs_object_dir</span>
    <span class="s0">def </span><span class="s1">test_distribution_dir_includes_provider_dir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Distribution</span><span class="s2">()</span>
        <span class="s1">before </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">__dir__</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s5">'test_attr' </span><span class="s0">not in </span><span class="s1">before</span>
        <span class="s1">d</span><span class="s2">.</span><span class="s1">_provider</span><span class="s2">.</span><span class="s1">test_attr </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">after </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">__dir__</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">after</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">before</span><span class="s2">) + </span><span class="s6">1</span>
        <span class="s0">assert </span><span class="s5">'test_attr' </span><span class="s0">in </span><span class="s1">after</span>

    <span class="s2">@</span><span class="s1">needs_object_dir</span>
    <span class="s0">def </span><span class="s1">test_distribution_dir_ignores_provider_dir_leading_underscore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Distribution</span><span class="s2">()</span>
        <span class="s1">before </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">__dir__</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s5">'_test_attr' </span><span class="s0">not in </span><span class="s1">before</span>
        <span class="s1">d</span><span class="s2">.</span><span class="s1">_provider</span><span class="s2">.</span><span class="s1">_test_attr </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">after </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">__dir__</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">after</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">before</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s5">'_test_attr' </span><span class="s0">not in </span><span class="s1">after</span>

    <span class="s0">def </span><span class="s1">testResolve</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ad </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">([])</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s3"># Resolving no requirements -&gt; nothing to install</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">([], </span><span class="s1">ad</span><span class="s2">)) == []</span>
        <span class="s3"># Request something not in the collection -&gt; DistributionNotFound</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">DistributionNotFound</span><span class="s2">):</span>
            <span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">)</span>

        <span class="s1">Foo </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span>
            <span class="s5">&quot;/foo_dir/Foo-1.2.egg&quot;</span><span class="s2">,</span>
            <span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span><span class="s5">'depends.txt'</span><span class="s2">, </span><span class="s5">&quot;[bar]</span><span class="s0">\n</span><span class="s5">Baz&gt;=2.0&quot;</span><span class="s2">)),</span>
        <span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Foo</span><span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;Foo-0.9.egg&quot;</span><span class="s2">))</span>

        <span class="s3"># Request thing(s) that are available -&gt; list to activate</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s6">3</span><span class="s2">):</span>
            <span class="s1">targets </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">))</span>
            <span class="s0">assert </span><span class="s1">targets </span><span class="s2">== [</span><span class="s1">Foo</span><span class="s2">]</span>
            <span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">targets</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">VersionConflict</span><span class="s2">):</span>
            <span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo==0.9&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">)</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])  </span><span class="s3"># reset</span>

        <span class="s3"># Request an extra that causes an unresolved dependency for &quot;Baz&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">DistributionNotFound</span><span class="s2">):</span>
            <span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo[bar]&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">)</span>
        <span class="s1">Baz </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span>
            <span class="s5">&quot;/foo_dir/Baz-2.1.egg&quot;</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span><span class="s5">'depends.txt'</span><span class="s2">, </span><span class="s5">&quot;Foo&quot;</span><span class="s2">))</span>
        <span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Baz</span><span class="s2">)</span>

        <span class="s3"># Activation list now includes resolved dependency</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo[bar]&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">)) == [</span><span class="s1">Foo</span><span class="s2">, </span><span class="s1">Baz</span><span class="s2">]</span>
        <span class="s3"># Requests for conflicting versions produce VersionConflict</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">VersionConflict</span><span class="s2">) </span><span class="s0">as </span><span class="s1">vc</span><span class="s2">:</span>
            <span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo==1.2</span><span class="s0">\n</span><span class="s5">Foo!=1.2&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s5">'Foo 0.9 is installed but Foo==1.2 is required'</span>
        <span class="s0">assert </span><span class="s1">vc</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">report</span><span class="s2">() == </span><span class="s1">msg</span>

    <span class="s0">def </span><span class="s1">test_environment_marker_evaluation_negative</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Environment markers are evaluated at resolution time.&quot;&quot;&quot;</span>
        <span class="s1">ad </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">([])</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo;python_version&lt;'2'&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) == []</span>

    <span class="s0">def </span><span class="s1">test_environment_marker_evaluation_positive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ad </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">([])</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">Foo </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/Foo-1.2.dist-info&quot;</span><span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Foo</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo;python_version&gt;='2'&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) == [</span><span class="s1">Foo</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_environment_marker_evaluation_called</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        If one package foo requires bar without any extras, 
        markers should pass for bar without extras. 
        &quot;&quot;&quot;</span>
        <span class="s2">(</span><span class="s1">parent_req</span><span class="s2">,) = </span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;foo&quot;</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">req</span><span class="s2">,) = </span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;bar;python_version&gt;='2'&quot;</span><span class="s2">)</span>
        <span class="s1">req_extras </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_ReqExtras</span><span class="s2">({</span><span class="s1">req</span><span class="s2">: </span><span class="s1">parent_req</span><span class="s2">.</span><span class="s1">extras</span><span class="s2">})</span>
        <span class="s0">assert </span><span class="s1">req_extras</span><span class="s2">.</span><span class="s1">markers_pass</span><span class="s2">(</span><span class="s1">req</span><span class="s2">)</span>

        <span class="s2">(</span><span class="s1">parent_req</span><span class="s2">,) = </span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;foo[]&quot;</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">req</span><span class="s2">,) = </span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;bar;python_version&gt;='2'&quot;</span><span class="s2">)</span>
        <span class="s1">req_extras </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_ReqExtras</span><span class="s2">({</span><span class="s1">req</span><span class="s2">: </span><span class="s1">parent_req</span><span class="s2">.</span><span class="s1">extras</span><span class="s2">})</span>
        <span class="s0">assert </span><span class="s1">req_extras</span><span class="s2">.</span><span class="s1">markers_pass</span><span class="s2">(</span><span class="s1">req</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_marker_evaluation_with_extras</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Extras are also evaluated as markers at resolution time.&quot;&quot;&quot;</span>
        <span class="s1">ad </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">([])</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">Foo </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span>
            <span class="s5">&quot;/foo_dir/Foo-1.2.dist-info&quot;</span><span class="s2">,</span>
            <span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span>
                <span class="s5">&quot;METADATA&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;Provides-Extra: baz</span><span class="s0">\n</span><span class="s5">Requires-Dist: quux; extra=='baz'&quot;</span><span class="s2">,</span>
            <span class="s2">)),</span>
        <span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Foo</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">)) == [</span><span class="s1">Foo</span><span class="s2">]</span>
        <span class="s1">quux </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/quux-1.0.dist-info&quot;</span><span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">quux</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo[baz]&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">res </span><span class="s2">== [</span><span class="s1">Foo</span><span class="s2">, </span><span class="s1">quux</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_marker_evaluation_with_extras_normlized</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Extras are also evaluated as markers at resolution time.&quot;&quot;&quot;</span>
        <span class="s1">ad </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">([])</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">Foo </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span>
            <span class="s5">&quot;/foo_dir/Foo-1.2.dist-info&quot;</span><span class="s2">,</span>
            <span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span>
                <span class="s5">&quot;METADATA&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;Provides-Extra: baz-lightyear</span><span class="s0">\n</span><span class="s5">&quot;</span>
                <span class="s5">&quot;Requires-Dist: quux; extra=='baz-lightyear'&quot;</span><span class="s2">,</span>
            <span class="s2">)),</span>
        <span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Foo</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">)) == [</span><span class="s1">Foo</span><span class="s2">]</span>
        <span class="s1">quux </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/quux-1.0.dist-info&quot;</span><span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">quux</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo[baz-lightyear]&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">res </span><span class="s2">== [</span><span class="s1">Foo</span><span class="s2">, </span><span class="s1">quux</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_marker_evaluation_with_multiple_extras</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ad </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">([])</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">Foo </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span>
            <span class="s5">&quot;/foo_dir/Foo-1.2.dist-info&quot;</span><span class="s2">,</span>
            <span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span>
                <span class="s5">&quot;METADATA&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;Provides-Extra: baz</span><span class="s0">\n</span><span class="s5">&quot;</span>
                <span class="s5">&quot;Requires-Dist: quux; extra=='baz'</span><span class="s0">\n</span><span class="s5">&quot;</span>
                <span class="s5">&quot;Provides-Extra: bar</span><span class="s0">\n</span><span class="s5">&quot;</span>
                <span class="s5">&quot;Requires-Dist: fred; extra=='bar'</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s2">,</span>
            <span class="s2">)),</span>
        <span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Foo</span><span class="s2">)</span>
        <span class="s1">quux </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/quux-1.0.dist-info&quot;</span><span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">quux</span><span class="s2">)</span>
        <span class="s1">fred </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/fred-0.1.dist-info&quot;</span><span class="s2">)</span>
        <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">fred</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo[baz,bar]&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) == [</span><span class="s1">fred</span><span class="s2">, </span><span class="s1">quux</span><span class="s2">, </span><span class="s1">Foo</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_marker_evaluation_with_extras_loop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ad </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">([])</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span>
            <span class="s5">&quot;/foo_dir/a-0.2.dist-info&quot;</span><span class="s2">,</span>
            <span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span><span class="s5">&quot;METADATA&quot;</span><span class="s2">, </span><span class="s5">&quot;Requires-Dist: c[a]&quot;</span><span class="s2">)),</span>
        <span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span>
            <span class="s5">&quot;/foo_dir/b-0.3.dist-info&quot;</span><span class="s2">,</span>
            <span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span><span class="s5">&quot;METADATA&quot;</span><span class="s2">, </span><span class="s5">&quot;Requires-Dist: c[b]&quot;</span><span class="s2">)),</span>
        <span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span>
            <span class="s5">&quot;/foo_dir/c-1.0.dist-info&quot;</span><span class="s2">,</span>
            <span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span>
                <span class="s5">&quot;METADATA&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;Provides-Extra: a</span><span class="s0">\n</span><span class="s5">&quot;</span>
                <span class="s5">&quot;Requires-Dist: b;extra=='a'</span><span class="s0">\n</span><span class="s5">&quot;</span>
                <span class="s5">&quot;Provides-Extra: b</span><span class="s0">\n</span><span class="s5">&quot;</span>
                <span class="s5">&quot;Requires-Dist: foo;extra=='b'&quot;</span><span class="s2">,</span>
            <span class="s2">)),</span>
        <span class="s2">)</span>
        <span class="s1">foo </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/foo-0.1.dist-info&quot;</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dist </span><span class="s0">in </span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">foo</span><span class="s2">):</span>
            <span class="s1">ad</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;a&quot;</span><span class="s2">), </span><span class="s1">ad</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">res </span><span class="s2">== [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">foo</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[:</span><span class="s6">2</span><span class="s2">] == (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">12</span><span class="s2">) </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">.</span><span class="s1">releaselevel </span><span class="s2">!= </span><span class="s5">'final'</span><span class="s2">,</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;https://github.com/python/cpython/issues/103632&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">testDistroDependsOptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">distRequires</span><span class="s2">(</span>
            <span class="s5">&quot;&quot;&quot; 
            Twisted&gt;=1.5 
            [docgen] 
            ZConfig&gt;=2.0 
            docutils&gt;=0.3 
            [fastcgi] 
            fcgiapp&gt;=0.1&quot;&quot;&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkRequires</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s5">&quot;Twisted&gt;=1.5&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkRequires</span><span class="s2">(</span>
            <span class="s1">d</span><span class="s2">, </span><span class="s5">&quot;Twisted&gt;=1.5 ZConfig&gt;=2.0 docutils&gt;=0.3&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(), [</span><span class="s5">&quot;docgen&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkRequires</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s5">&quot;Twisted&gt;=1.5 fcgiapp&gt;=0.1&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(), [</span><span class="s5">&quot;fastcgi&quot;</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkRequires</span><span class="s2">(</span>
            <span class="s1">d</span><span class="s2">,</span>
            <span class="s5">&quot;Twisted&gt;=1.5 ZConfig&gt;=2.0 docutils&gt;=0.3 fcgiapp&gt;=0.1&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(),</span>
            <span class="s2">[</span><span class="s5">&quot;docgen&quot;</span><span class="s2">, </span><span class="s5">&quot;fastcgi&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkRequires</span><span class="s2">(</span>
            <span class="s1">d</span><span class="s2">,</span>
            <span class="s5">&quot;Twisted&gt;=1.5 fcgiapp&gt;=0.1 ZConfig&gt;=2.0 docutils&gt;=0.3&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(),</span>
            <span class="s2">[</span><span class="s5">&quot;fastcgi&quot;</span><span class="s2">, </span><span class="s5">&quot;docgen&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">UnknownExtra</span><span class="s2">):</span>
            <span class="s1">d</span><span class="s2">.</span><span class="s1">requires</span><span class="s2">([</span><span class="s5">&quot;foo&quot;</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">TestWorkingSet</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_find_conflicting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">Foo </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/Foo-1.2.egg&quot;</span><span class="s2">)</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Foo</span><span class="s2">)</span>

        <span class="s3"># create a requirement that conflicts with Foo 1.2</span>
        <span class="s1">req </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo&lt;1.2&quot;</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">VersionConflict</span><span class="s2">) </span><span class="s0">as </span><span class="s1">vc</span><span class="s2">:</span>
            <span class="s1">ws</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s1">req</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s5">'Foo 1.2 is installed but Foo&lt;1.2 is required'</span>
        <span class="s0">assert </span><span class="s1">vc</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">report</span><span class="s2">() == </span><span class="s1">msg</span>

    <span class="s0">def </span><span class="s1">test_resolve_conflicts_with_prior</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        A ContextualVersionConflict should be raised when a requirement 
        conflicts with a prior requirement for a different package. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Create installation where Foo depends on Baz 1.0 and Bar depends on</span>
        <span class="s3"># Baz 2.0.</span>
        <span class="s1">ws </span><span class="s2">= </span><span class="s1">WorkingSet</span><span class="s2">([])</span>
        <span class="s1">md </span><span class="s2">= </span><span class="s1">Metadata</span><span class="s2">((</span><span class="s5">'depends.txt'</span><span class="s2">, </span><span class="s5">&quot;Baz==1.0&quot;</span><span class="s2">))</span>
        <span class="s1">Foo </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/Foo-1.0.egg&quot;</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">md</span><span class="s2">)</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Foo</span><span class="s2">)</span>
        <span class="s1">md </span><span class="s2">= </span><span class="s1">Metadata</span><span class="s2">((</span><span class="s5">'depends.txt'</span><span class="s2">, </span><span class="s5">&quot;Baz==2.0&quot;</span><span class="s2">))</span>
        <span class="s1">Bar </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/Bar-1.0.egg&quot;</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">md</span><span class="s2">)</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Bar</span><span class="s2">)</span>
        <span class="s1">Baz </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/Baz-1.0.egg&quot;</span><span class="s2">)</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Baz</span><span class="s2">)</span>
        <span class="s1">Baz </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;/foo_dir/Baz-2.0.egg&quot;</span><span class="s2">)</span>
        <span class="s1">ws</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Baz</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">VersionConflict</span><span class="s2">) </span><span class="s0">as </span><span class="s1">vc</span><span class="s2">:</span>
            <span class="s1">ws</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">&quot;Foo</span><span class="s0">\n</span><span class="s5">Bar</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s2">))</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Baz 1.0 is installed but Baz==2.0 is required by &quot;</span>
        <span class="s1">msg </span><span class="s2">+= </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">set</span><span class="s2">([</span><span class="s5">'Bar'</span><span class="s2">]))</span>
        <span class="s0">assert </span><span class="s1">vc</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">report</span><span class="s2">() == </span><span class="s1">msg</span>


<span class="s0">class </span><span class="s1">TestEntryPoints</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">assertfields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ep</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">&quot;foo&quot;</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">module_name </span><span class="s2">== </span><span class="s5">&quot;pkg_resources.tests.test_resources&quot;</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">attrs </span><span class="s2">== (</span><span class="s5">&quot;TestEntryPoints&quot;</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">extras </span><span class="s2">== (</span><span class="s5">&quot;x&quot;</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">load</span><span class="s2">() </span><span class="s0">is </span><span class="s1">TestEntryPoints</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s5">&quot;foo = pkg_resources.tests.test_resources:TestEntryPoints [x]&quot;</span>
        <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">ep</span><span class="s2">) == </span><span class="s1">expect</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">method</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span>
            <span class="s5">&quot;FooPkg-1.2-py2.4.egg&quot;</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">Metadata</span><span class="s2">((</span><span class="s5">'requires.txt'</span><span class="s2">, </span><span class="s5">'[x]'</span><span class="s2">))</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">testBasics</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ep </span><span class="s2">= </span><span class="s1">EntryPoint</span><span class="s2">(</span>
            <span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;pkg_resources.tests.test_resources&quot;</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s5">&quot;TestEntryPoints&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">&quot;x&quot;</span><span class="s2">],</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dist</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertfields</span><span class="s2">(</span><span class="s1">ep</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">testParse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s5">&quot;foo = pkg_resources.tests.test_resources:TestEntryPoints [x]&quot;</span>
        <span class="s1">ep </span><span class="s2">= </span><span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertfields</span><span class="s2">(</span><span class="s1">ep</span><span class="s2">)</span>

        <span class="s1">ep </span><span class="s2">= </span><span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;bar baz=  spammity[PING]&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">&quot;bar baz&quot;</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">module_name </span><span class="s2">== </span><span class="s5">&quot;spammity&quot;</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">attrs </span><span class="s2">== ()</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">extras </span><span class="s2">== (</span><span class="s5">&quot;ping&quot;</span><span class="s2">,)</span>

        <span class="s1">ep </span><span class="s2">= </span><span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot; fizzly =  wocka:foo&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">&quot;fizzly&quot;</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">module_name </span><span class="s2">== </span><span class="s5">&quot;wocka&quot;</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">attrs </span><span class="s2">== (</span><span class="s5">&quot;foo&quot;</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">extras </span><span class="s2">== ()</span>

        <span class="s3"># plus in the name</span>
        <span class="s1">spec </span><span class="s2">= </span><span class="s5">&quot;html+mako = mako.ext.pygmentplugin:MakoHtmlLexer&quot;</span>
        <span class="s1">ep </span><span class="s2">= </span><span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">spec</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">'html+mako'</span>

    <span class="s1">reject_specs </span><span class="s2">= </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;x=a:b:c&quot;</span><span class="s2">, </span><span class="s5">&quot;q=x/na&quot;</span><span class="s2">, </span><span class="s5">&quot;fez=pish:tush-z&quot;</span><span class="s2">, </span><span class="s5">&quot;x=f[a]&gt;2&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;reject_spec&quot;</span><span class="s2">, </span><span class="s1">reject_specs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_reject_spec</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reject_spec</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">reject_spec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_printable_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Allow any printable character in the name. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Create a name with all printable characters; strip the whitespace.</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s1">string</span><span class="s2">.</span><span class="s1">printable</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
        <span class="s1">spec </span><span class="s2">= </span><span class="s5">&quot;{name} = module:attr&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(**</span><span class="s1">locals</span><span class="s2">())</span>
        <span class="s1">ep </span><span class="s2">= </span><span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">spec</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">name</span>

    <span class="s0">def </span><span class="s1">checkSubMap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">m</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">m</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">submap_expect</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">ep </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">submap_expect</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">assert </span><span class="s1">m</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">).</span><span class="s1">name </span><span class="s2">== </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s0">assert </span><span class="s1">m</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">).</span><span class="s1">module_name </span><span class="s2">== </span><span class="s1">ep</span><span class="s2">.</span><span class="s1">module_name</span>
            <span class="s0">assert </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">).</span><span class="s1">attrs</span><span class="s2">) == </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">ep</span><span class="s2">.</span><span class="s1">attrs</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">).</span><span class="s1">extras</span><span class="s2">) == </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">ep</span><span class="s2">.</span><span class="s1">extras</span><span class="s2">)</span>

    <span class="s1">submap_expect </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span>
        <span class="s1">feature1</span><span class="s2">=</span><span class="s1">EntryPoint</span><span class="s2">(</span><span class="s5">'feature1'</span><span class="s2">, </span><span class="s5">'somemodule'</span><span class="s2">, [</span><span class="s5">'somefunction'</span><span class="s2">]),</span>
        <span class="s1">feature2</span><span class="s2">=</span><span class="s1">EntryPoint</span><span class="s2">(</span>
            <span class="s5">'feature2'</span><span class="s2">, </span><span class="s5">'another.module'</span><span class="s2">, [</span><span class="s5">'SomeClass'</span><span class="s2">], [</span><span class="s5">'extra1'</span><span class="s2">, </span><span class="s5">'extra2'</span><span class="s2">]</span>
        <span class="s2">),</span>
        <span class="s1">feature3</span><span class="s2">=</span><span class="s1">EntryPoint</span><span class="s2">(</span><span class="s5">'feature3'</span><span class="s2">, </span><span class="s5">'this.module'</span><span class="s2">, </span><span class="s1">extras</span><span class="s2">=[</span><span class="s5">'something'</span><span class="s2">]),</span>
    <span class="s2">)</span>
    <span class="s1">submap_str </span><span class="s2">= </span><span class="s5">&quot;&quot;&quot; 
            # define features for blah blah 
            feature1 = somemodule:somefunction 
            feature2 = another.module:SomeClass [extra1,extra2] 
            feature3 = this.module [something] 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">testParseList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkSubMap</span><span class="s2">(</span><span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse_group</span><span class="s2">(</span><span class="s5">&quot;xyz&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">submap_str</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse_group</span><span class="s2">(</span><span class="s5">&quot;x a&quot;</span><span class="s2">, </span><span class="s5">&quot;foo=bar&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse_group</span><span class="s2">(</span><span class="s5">&quot;x&quot;</span><span class="s2">, [</span><span class="s5">&quot;foo=baz&quot;</span><span class="s2">, </span><span class="s5">&quot;foo=bar&quot;</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">testParseMap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse_map</span><span class="s2">({</span><span class="s5">'xyz'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">submap_str</span><span class="s2">})</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkSubMap</span><span class="s2">(</span><span class="s1">m</span><span class="s2">[</span><span class="s5">'xyz'</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()) == [</span><span class="s5">'xyz'</span><span class="s2">]</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse_map</span><span class="s2">(</span><span class="s5">&quot;[xyz]</span><span class="s0">\n</span><span class="s5">&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">submap_str</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">checkSubMap</span><span class="s2">(</span><span class="s1">m</span><span class="s2">[</span><span class="s5">'xyz'</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()) == [</span><span class="s5">'xyz'</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse_map</span><span class="s2">([</span><span class="s5">&quot;[xyz]&quot;</span><span class="s2">, </span><span class="s5">&quot;[xyz]&quot;</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">EntryPoint</span><span class="s2">.</span><span class="s1">parse_map</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">submap_str</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">testDeprecationWarnings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ep </span><span class="s2">= </span><span class="s1">EntryPoint</span><span class="s2">(</span>
            <span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;pkg_resources.tests.test_resources&quot;</span><span class="s2">, [</span><span class="s5">&quot;TestEntryPoints&quot;</span><span class="s2">], [</span><span class="s5">&quot;x&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">PkgResourcesDeprecationWarning</span><span class="s2">):</span>
            <span class="s1">ep</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">require</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRequirements</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">testBasics</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;Twisted&gt;=1.2&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) == </span><span class="s5">&quot;Twisted&gt;=1.2&quot;</span>
        <span class="s0">assert </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) == </span><span class="s5">&quot;Requirement.parse('Twisted&gt;=1.2')&quot;</span>
        <span class="s0">assert </span><span class="s1">r </span><span class="s2">== </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;Twisted&gt;=1.2&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">r </span><span class="s2">== </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;twisTed&gt;=1.2&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">r </span><span class="s2">!= </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;Twisted&gt;=2.0&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">r </span><span class="s2">!= </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;Zope&gt;=1.2&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">r </span><span class="s2">!= </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;Zope&gt;=3.0&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">r </span><span class="s2">!= </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;Twisted[extras]&gt;=1.2&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">testOrdering</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;Twisted==1.2c1,&gt;=1.2&quot;</span><span class="s2">)</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;Twisted&gt;=1.2,==1.2c1&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">r1 </span><span class="s2">== </span><span class="s1">r2</span>
        <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">) == </span><span class="s1">str</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">) == </span><span class="s5">&quot;Twisted==1.2c1,&gt;=1.2&quot;</span>
        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;Twisted&quot;</span><span class="s2">) != </span><span class="s1">Requirement</span><span class="s2">(</span>
            <span class="s5">&quot;Twisted @ https://localhost/twisted.zip&quot;</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">testBasicContains</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;Twisted&gt;=1.2&quot;</span><span class="s2">)</span>
        <span class="s1">foo_dist </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;FooPkg-1.3_1.egg&quot;</span><span class="s2">)</span>
        <span class="s1">twist11 </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;Twisted-1.1.egg&quot;</span><span class="s2">)</span>
        <span class="s1">twist12 </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span><span class="s2">(</span><span class="s5">&quot;Twisted-1.2.egg&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s5">'1.2'</span><span class="s2">) </span><span class="s0">in </span><span class="s1">r</span>
        <span class="s0">assert </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s5">'1.1'</span><span class="s2">) </span><span class="s0">not in </span><span class="s1">r</span>
        <span class="s0">assert </span><span class="s5">'1.2' </span><span class="s0">in </span><span class="s1">r</span>
        <span class="s0">assert </span><span class="s5">'1.1' </span><span class="s0">not in </span><span class="s1">r</span>
        <span class="s0">assert </span><span class="s1">foo_dist </span><span class="s0">not in </span><span class="s1">r</span>
        <span class="s0">assert </span><span class="s1">twist11 </span><span class="s0">not in </span><span class="s1">r</span>
        <span class="s0">assert </span><span class="s1">twist12 </span><span class="s0">in </span><span class="s1">r</span>

    <span class="s0">def </span><span class="s1">testOptionsAndHashing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;Twisted[foo,bar]&gt;=1.2&quot;</span><span class="s2">)</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;Twisted[bar,FOO]&gt;=1.2&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">r1 </span><span class="s2">== </span><span class="s1">r2</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">.</span><span class="s1">extras</span><span class="s2">) == </span><span class="s1">set</span><span class="s2">((</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">.</span><span class="s1">extras</span><span class="s2">) == </span><span class="s1">set</span><span class="s2">((</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">) == </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">) == </span><span class="s1">hash</span><span class="s2">((</span>
            <span class="s5">&quot;twisted&quot;</span><span class="s2">,</span>
            <span class="s0">None</span><span class="s2">,</span>
            <span class="s1">SpecifierSet</span><span class="s2">(</span><span class="s5">&quot;&gt;=1.2&quot;</span><span class="s2">),</span>
            <span class="s1">frozenset</span><span class="s2">([</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">]),</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">hash</span><span class="s2">(</span>
            <span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;Twisted @ https://localhost/twisted.zip&quot;</span><span class="s2">)</span>
        <span class="s2">) == </span><span class="s1">hash</span><span class="s2">((</span>
            <span class="s5">&quot;twisted&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;https://localhost/twisted.zip&quot;</span><span class="s2">,</span>
            <span class="s1">SpecifierSet</span><span class="s2">(),</span>
            <span class="s1">frozenset</span><span class="s2">(),</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">))</span>

    <span class="s0">def </span><span class="s1">testVersionEquality</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;foo==0.3a2&quot;</span><span class="s2">)</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;foo!=0.3a4&quot;</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">Distribution</span><span class="s2">.</span><span class="s1">from_filename</span>

        <span class="s0">assert </span><span class="s1">d</span><span class="s2">(</span><span class="s5">&quot;foo-0.3a4.egg&quot;</span><span class="s2">) </span><span class="s0">not in </span><span class="s1">r1</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">(</span><span class="s5">&quot;foo-0.3a1.egg&quot;</span><span class="s2">) </span><span class="s0">not in </span><span class="s1">r1</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">(</span><span class="s5">&quot;foo-0.3a4.egg&quot;</span><span class="s2">) </span><span class="s0">not in </span><span class="s1">r2</span>

        <span class="s0">assert </span><span class="s1">d</span><span class="s2">(</span><span class="s5">&quot;foo-0.3a2.egg&quot;</span><span class="s2">) </span><span class="s0">in </span><span class="s1">r1</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">(</span><span class="s5">&quot;foo-0.3a2.egg&quot;</span><span class="s2">) </span><span class="s0">in </span><span class="s1">r2</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">(</span><span class="s5">&quot;foo-0.3a3.egg&quot;</span><span class="s2">) </span><span class="s0">in </span><span class="s1">r2</span>
        <span class="s0">assert </span><span class="s1">d</span><span class="s2">(</span><span class="s5">&quot;foo-0.3a5.egg&quot;</span><span class="s2">) </span><span class="s0">in </span><span class="s1">r2</span>

    <span class="s0">def </span><span class="s1">testSetuptoolsProjectName</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        The setuptools project should implement the setuptools package. 
        &quot;&quot;&quot;</span>

        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">'setuptools'</span><span class="s2">).</span><span class="s1">project_name </span><span class="s2">== </span><span class="s5">'setuptools'</span>
        <span class="s3"># setuptools 0.7 and higher means setuptools.</span>
        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">'setuptools == 0.7'</span><span class="s2">).</span><span class="s1">project_name </span><span class="s2">== </span><span class="s5">'setuptools'</span>
        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">'setuptools == 0.7a1'</span><span class="s2">).</span><span class="s1">project_name </span><span class="s2">== </span><span class="s5">'setuptools'</span>
        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">'setuptools &gt;= 0.7'</span><span class="s2">).</span><span class="s1">project_name </span><span class="s2">== </span><span class="s5">'setuptools'</span>


<span class="s0">class </span><span class="s1">TestParsing</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">testEmptyParse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">''</span><span class="s2">)) == []</span>

    <span class="s0">def </span><span class="s1">testYielding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">inp</span><span class="s2">, </span><span class="s1">out </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s2">([], []),</span>
            <span class="s2">(</span><span class="s5">'x'</span><span class="s2">, [</span><span class="s5">'x'</span><span class="s2">]),</span>
            <span class="s2">([[]], []),</span>
            <span class="s2">(</span><span class="s5">' x</span><span class="s0">\n </span><span class="s5">y'</span><span class="s2">, [</span><span class="s5">'x'</span><span class="s2">, </span><span class="s5">'y'</span><span class="s2">]),</span>
            <span class="s2">([</span><span class="s5">'x</span><span class="s0">\n\n</span><span class="s5">'</span><span class="s2">, </span><span class="s5">'y'</span><span class="s2">], [</span><span class="s5">'x'</span><span class="s2">, </span><span class="s5">'y'</span><span class="s2">]),</span>
        <span class="s2">]:</span>
            <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">yield_lines</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">)) == </span><span class="s1">out</span>

    <span class="s0">def </span><span class="s1">testSplitting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s5">&quot;&quot;&quot; 
                    x 
                    [Y] 
                    z 
 
                    a 
                    [b ] 
                    # foo 
                    c 
                    [ d] 
                    [q] 
                    v 
                    &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">split_sections</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)) == [</span>
            <span class="s2">(</span><span class="s0">None</span><span class="s2">, [</span><span class="s5">&quot;x&quot;</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s5">&quot;Y&quot;</span><span class="s2">, [</span><span class="s5">&quot;z&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s5">&quot;b&quot;</span><span class="s2">, [</span><span class="s5">&quot;c&quot;</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s5">&quot;d&quot;</span><span class="s2">, []),</span>
            <span class="s2">(</span><span class="s5">&quot;q&quot;</span><span class="s2">, [</span><span class="s5">&quot;v&quot;</span><span class="s2">]),</span>
        <span class="s2">]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">list</span><span class="s2">(</span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">split_sections</span><span class="s2">(</span><span class="s5">&quot;[foo&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">testSafeName</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">safe_name</span><span class="s2">(</span><span class="s5">&quot;adns-python&quot;</span><span class="s2">) == </span><span class="s5">&quot;adns-python&quot;</span>
        <span class="s0">assert </span><span class="s1">safe_name</span><span class="s2">(</span><span class="s5">&quot;WSGI Utils&quot;</span><span class="s2">) == </span><span class="s5">&quot;WSGI-Utils&quot;</span>
        <span class="s0">assert </span><span class="s1">safe_name</span><span class="s2">(</span><span class="s5">&quot;WSGI  Utils&quot;</span><span class="s2">) == </span><span class="s5">&quot;WSGI-Utils&quot;</span>
        <span class="s0">assert </span><span class="s1">safe_name</span><span class="s2">(</span><span class="s5">&quot;Money$$$Maker&quot;</span><span class="s2">) == </span><span class="s5">&quot;Money-Maker&quot;</span>
        <span class="s0">assert </span><span class="s1">safe_name</span><span class="s2">(</span><span class="s5">&quot;peak.web&quot;</span><span class="s2">) != </span><span class="s5">&quot;peak-web&quot;</span>

    <span class="s0">def </span><span class="s1">testSafeVersion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">safe_version</span><span class="s2">(</span><span class="s5">&quot;1.2-1&quot;</span><span class="s2">) == </span><span class="s5">&quot;1.2.post1&quot;</span>
        <span class="s0">assert </span><span class="s1">safe_version</span><span class="s2">(</span><span class="s5">&quot;1.2 alpha&quot;</span><span class="s2">) == </span><span class="s5">&quot;1.2.alpha&quot;</span>
        <span class="s0">assert </span><span class="s1">safe_version</span><span class="s2">(</span><span class="s5">&quot;2.3.4 20050521&quot;</span><span class="s2">) == </span><span class="s5">&quot;2.3.4.20050521&quot;</span>
        <span class="s0">assert </span><span class="s1">safe_version</span><span class="s2">(</span><span class="s5">&quot;Money$$$Maker&quot;</span><span class="s2">) == </span><span class="s5">&quot;Money-Maker&quot;</span>
        <span class="s0">assert </span><span class="s1">safe_version</span><span class="s2">(</span><span class="s5">&quot;peak.web&quot;</span><span class="s2">) == </span><span class="s5">&quot;peak.web&quot;</span>

    <span class="s0">def </span><span class="s1">testSimpleRequirements</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">'Twis-Ted&gt;=1.2-1'</span><span class="s2">)) == [</span>
            <span class="s1">Requirement</span><span class="s2">(</span><span class="s5">'Twis-Ted&gt;=1.2-1'</span><span class="s2">)</span>
        <span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">'Twisted &gt;=1.2, </span><span class="s0">\\ </span><span class="s5"># more</span><span class="s0">\n</span><span class="s5">&lt;2.0'</span><span class="s2">)) == [</span>
            <span class="s1">Requirement</span><span class="s2">(</span><span class="s5">'Twisted&gt;=1.2,&lt;2.0'</span><span class="s2">)</span>
        <span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;FooBar==1.99a3&quot;</span><span class="s2">) == </span><span class="s1">Requirement</span><span class="s2">(</span><span class="s5">&quot;FooBar==1.99a3&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;&gt;=2.3&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;x</span><span class="s0">\\</span><span class="s5">&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;x==2 q&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;X==1</span><span class="s0">\n</span><span class="s5">Y==2&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;#&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_requirements_with_markers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;foobar;os_name=='a'&quot;</span><span class="s2">) == </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span>
            <span class="s5">&quot;foobar;os_name=='a'&quot;</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span>
            <span class="s5">&quot;name==1.1;python_version=='2.7'&quot;</span>
        <span class="s2">) != </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;name==1.1;python_version=='3.6'&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span>
            <span class="s5">&quot;name==1.0;python_version=='2.7'&quot;</span>
        <span class="s2">) != </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;name==1.2;python_version=='2.7'&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span>
            <span class="s5">&quot;name[foo]==1.0;python_version=='3.6'&quot;</span>
        <span class="s2">) != </span><span class="s1">Requirement</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s5">&quot;name[foo,bar]==1.0;python_version=='3.6'&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_local_version</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">'foo==1.0+org1'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_spaces_between_multiple_versions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">'foo&gt;=1.0, &lt;3'</span><span class="s2">)</span>
        <span class="s1">parse_requirements</span><span class="s2">(</span><span class="s5">'foo &gt;= 1.0, &lt; 3'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s5">&quot;lower&quot;</span><span class="s2">, </span><span class="s5">&quot;upper&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s5">'1.2-rc1'</span><span class="s2">, </span><span class="s5">'1.2rc1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0.4'</span><span class="s2">, </span><span class="s5">'0.4.0'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0.4.0.0'</span><span class="s2">, </span><span class="s5">'0.4.0'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0.4.0-0'</span><span class="s2">, </span><span class="s5">'0.4-0'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0post1'</span><span class="s2">, </span><span class="s5">'0.0post1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0pre1'</span><span class="s2">, </span><span class="s5">'0.0c1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0.0.0preview1'</span><span class="s2">, </span><span class="s5">'0c1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0.0c1'</span><span class="s2">, </span><span class="s5">'0-rc1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'1.2a1'</span><span class="s2">, </span><span class="s5">'1.2.a.1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'1.2.a'</span><span class="s2">, </span><span class="s5">'1.2a'</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">testVersionEquality</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lower</span><span class="s2">, </span><span class="s1">upper</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s1">lower</span><span class="s2">) == </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s1">upper</span><span class="s2">)</span>

    <span class="s1">torture </span><span class="s2">= </span><span class="s5">&quot;&quot;&quot; 
        0.80.1-3 0.80.1-2 0.80.1-1 0.79.9999+0.80.0pre4-1 
        0.79.9999+0.80.0pre2-3 0.79.9999+0.80.0pre2-2 
        0.77.2-1 0.77.1-1 0.77.0-1 
        &quot;&quot;&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s5">&quot;lower&quot;</span><span class="s2">, </span><span class="s5">&quot;upper&quot;</span><span class="s2">),</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s5">'2.1'</span><span class="s2">, </span><span class="s5">'2.1.1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'2a1'</span><span class="s2">, </span><span class="s5">'2b0'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'2a1'</span><span class="s2">, </span><span class="s5">'2.1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'2.3a1'</span><span class="s2">, </span><span class="s5">'2.3'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'2.1-1'</span><span class="s2">, </span><span class="s5">'2.1-2'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'2.1-1'</span><span class="s2">, </span><span class="s5">'2.1.1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'2.1'</span><span class="s2">, </span><span class="s5">'2.1post4'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'2.1a0-20040501'</span><span class="s2">, </span><span class="s5">'2.1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'1.1'</span><span class="s2">, </span><span class="s5">'02.1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'3.2'</span><span class="s2">, </span><span class="s5">'3.2.post0'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'3.2post1'</span><span class="s2">, </span><span class="s5">'3.2post2'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0.4'</span><span class="s2">, </span><span class="s5">'4.0'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0.0.4'</span><span class="s2">, </span><span class="s5">'0.4.0'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'0post1'</span><span class="s2">, </span><span class="s5">'0.4post1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'2.1.0-rc1'</span><span class="s2">, </span><span class="s5">'2.1.0'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">'2.1dev'</span><span class="s2">, </span><span class="s5">'2.1a0'</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s2">+ </span><span class="s1">list</span><span class="s2">(</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">torture</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()))),</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">testVersionOrdering</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lower</span><span class="s2">, </span><span class="s1">upper</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s1">lower</span><span class="s2">) &lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s1">upper</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">testVersionHashable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Ensure that our versions stay hashable even though we've subclassed 
        them and added some shim code to them. 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">parse_version</span><span class="s2">(</span><span class="s5">&quot;1.0&quot;</span><span class="s2">)) == </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">parse_version</span><span class="s2">(</span><span class="s5">&quot;1.0&quot;</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestNamespaces</span><span class="s2">:</span>
    <span class="s1">ns_str </span><span class="s2">= </span><span class="s5">&quot;__import__('pkg_resources').declare_namespace(__name__)</span><span class="s0">\n</span><span class="s5">&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">symlinked_tmpdir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Where available, return the tempdir as a symlink, 
        which as revealed in #231 is more fragile than 
        a natural tempdir. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">os</span><span class="s2">, </span><span class="s5">'symlink'</span><span class="s2">):</span>
            <span class="s0">yield </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">link_name </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">) + </span><span class="s5">'-linked'</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">symlink</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">), </span><span class="s1">link_name</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s1">type</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">)(</span><span class="s1">link_name</span><span class="s2">)</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">(</span><span class="s1">link_name</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">autouse</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">patched_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Patch sys.path to include the 'site-pkgs' dir. Also 
        restore pkg_resources._namespace_packages to its 
        former state. 
        &quot;&quot;&quot;</span>
        <span class="s1">saved_ns_pkgs </span><span class="s2">= </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_namespace_packages</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">saved_sys_path </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">[:]</span>
        <span class="s1">site_pkgs </span><span class="s2">= </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">mkdir</span><span class="s2">(</span><span class="s5">'site-pkgs'</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">site_pkgs</span><span class="s2">))</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">yield</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_namespace_packages </span><span class="s2">= </span><span class="s1">saved_ns_pkgs</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s1">saved_sys_path</span>

    <span class="s1">issue591 </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">system</span><span class="s2">() == </span><span class="s5">'Windows'</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;#591&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">issue591</span>
    <span class="s0">def </span><span class="s1">test_two_levels_deep</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">symlinked_tmpdir</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test nested namespace packages 
        Create namespace packages in the following tree : 
            site-packages-1/pkg1/pkg2 
            site-packages-2/pkg1/pkg2 
        Check both are in the _namespace_packages dict and that their __path__ 
        is correct 
        &quot;&quot;&quot;</span>
        <span class="s1">real_tmpdir </span><span class="s2">= </span><span class="s1">symlinked_tmpdir</span><span class="s2">.</span><span class="s1">realpath</span><span class="s2">()</span>
        <span class="s1">tmpdir </span><span class="s2">= </span><span class="s1">symlinked_tmpdir</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s5">'site-pkgs2'</span><span class="s2">))</span>
        <span class="s1">site_dirs </span><span class="s2">= </span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s5">'site-pkgs'</span><span class="s2">, </span><span class="s1">tmpdir </span><span class="s2">/ </span><span class="s5">'site-pkgs2'</span>
        <span class="s0">for </span><span class="s1">site </span><span class="s0">in </span><span class="s1">site_dirs</span><span class="s2">:</span>
            <span class="s1">pkg1 </span><span class="s2">= </span><span class="s1">site </span><span class="s2">/ </span><span class="s5">'pkg1'</span>
            <span class="s1">pkg2 </span><span class="s2">= </span><span class="s1">pkg1 </span><span class="s2">/ </span><span class="s5">'pkg2'</span>
            <span class="s1">pkg2</span><span class="s2">.</span><span class="s1">ensure_dir</span><span class="s2">()</span>
            <span class="s2">(</span><span class="s1">pkg1 </span><span class="s2">/ </span><span class="s5">'__init__.py'</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ns_str</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s5">'utf-8'</span><span class="s2">)</span>
            <span class="s2">(</span><span class="s1">pkg2 </span><span class="s2">/ </span><span class="s5">'__init__.py'</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ns_str</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s5">'utf-8'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;pkg_resources.declare_namespace&quot;</span><span class="s2">):</span>
            <span class="s0">import </span><span class="s1">pkg1  </span><span class="s3"># pyright: ignore[reportMissingImports] # Temporary package for test</span>
        <span class="s0">assert </span><span class="s5">&quot;pkg1&quot; </span><span class="s0">in </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_namespace_packages</span>
        <span class="s3"># attempt to import pkg2 from site-pkgs2</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;pkg_resources.declare_namespace&quot;</span><span class="s2">):</span>
            <span class="s0">import </span><span class="s1">pkg1</span><span class="s2">.</span><span class="s1">pkg2  </span><span class="s3"># pyright: ignore[reportMissingImports] # Temporary package for test</span>
        <span class="s3"># check the _namespace_packages dict</span>
        <span class="s0">assert </span><span class="s5">&quot;pkg1.pkg2&quot; </span><span class="s0">in </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_namespace_packages</span>
        <span class="s0">assert </span><span class="s1">pkg_resources</span><span class="s2">.</span><span class="s1">_namespace_packages</span><span class="s2">[</span><span class="s5">&quot;pkg1&quot;</span><span class="s2">] == [</span><span class="s5">&quot;pkg1.pkg2&quot;</span><span class="s2">]</span>
        <span class="s3"># check the __path__ attribute contains both paths</span>
        <span class="s1">expected </span><span class="s2">= [</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">real_tmpdir </span><span class="s2">/ </span><span class="s5">&quot;site-pkgs&quot; </span><span class="s2">/ </span><span class="s5">&quot;pkg1&quot; </span><span class="s2">/ </span><span class="s5">&quot;pkg2&quot;</span><span class="s2">),</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">real_tmpdir </span><span class="s2">/ </span><span class="s5">&quot;site-pkgs2&quot; </span><span class="s2">/ </span><span class="s5">&quot;pkg1&quot; </span><span class="s2">/ </span><span class="s5">&quot;pkg2&quot;</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">pkg1</span><span class="s2">.</span><span class="s1">pkg2</span><span class="s2">.</span><span class="s1">__path__ </span><span class="s2">== </span><span class="s1">expected</span>

    <span class="s2">@</span><span class="s1">issue591</span>
    <span class="s0">def </span><span class="s1">test_path_order</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">symlinked_tmpdir</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test that if multiple versions of the same namespace package subpackage 
        are on different sys.path entries, that only the one earliest on 
        sys.path is imported, and that the namespace package's __path__ is in 
        the correct order. 
 
        Regression test for https://github.com/pypa/setuptools/issues/207 
        &quot;&quot;&quot;</span>

        <span class="s1">tmpdir </span><span class="s2">= </span><span class="s1">symlinked_tmpdir</span>
        <span class="s1">site_dirs </span><span class="s2">= (</span>
            <span class="s1">tmpdir </span><span class="s2">/ </span><span class="s5">&quot;site-pkgs&quot;</span><span class="s2">,</span>
            <span class="s1">tmpdir </span><span class="s2">/ </span><span class="s5">&quot;site-pkgs2&quot;</span><span class="s2">,</span>
            <span class="s1">tmpdir </span><span class="s2">/ </span><span class="s5">&quot;site-pkgs3&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">vers_str </span><span class="s2">= </span><span class="s5">&quot;__version__ = %r&quot;</span>

        <span class="s0">for </span><span class="s1">number</span><span class="s2">, </span><span class="s1">site </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">site_dirs</span><span class="s2">, </span><span class="s6">1</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">number </span><span class="s2">&gt; </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s1">sys</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">site</span><span class="s2">))</span>
            <span class="s1">nspkg </span><span class="s2">= </span><span class="s1">site </span><span class="s2">/ </span><span class="s5">'nspkg'</span>
            <span class="s1">subpkg </span><span class="s2">= </span><span class="s1">nspkg </span><span class="s2">/ </span><span class="s5">'subpkg'</span>
            <span class="s1">subpkg</span><span class="s2">.</span><span class="s1">ensure_dir</span><span class="s2">()</span>
            <span class="s2">(</span><span class="s1">nspkg </span><span class="s2">/ </span><span class="s5">'__init__.py'</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ns_str</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s5">'utf-8'</span><span class="s2">)</span>
            <span class="s2">(</span><span class="s1">subpkg </span><span class="s2">/ </span><span class="s5">'__init__.py'</span><span class="s2">).</span><span class="s1">write_text</span><span class="s2">(</span><span class="s1">vers_str </span><span class="s2">% </span><span class="s1">number</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s5">'utf-8'</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;pkg_resources.declare_namespace&quot;</span><span class="s2">):</span>
            <span class="s0">import </span><span class="s1">nspkg  </span><span class="s3"># pyright: ignore[reportMissingImports] # Temporary package for test</span>
            <span class="s0">import </span><span class="s1">nspkg</span><span class="s2">.</span><span class="s1">subpkg  </span><span class="s3"># pyright: ignore[reportMissingImports] # Temporary package for test</span>
        <span class="s1">expected </span><span class="s2">= [</span><span class="s1">str</span><span class="s2">(</span><span class="s1">site</span><span class="s2">.</span><span class="s1">realpath</span><span class="s2">() / </span><span class="s5">'nspkg'</span><span class="s2">) </span><span class="s0">for </span><span class="s1">site </span><span class="s0">in </span><span class="s1">site_dirs</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">nspkg</span><span class="s2">.</span><span class="s1">__path__ </span><span class="s2">== </span><span class="s1">expected</span>
        <span class="s0">assert </span><span class="s1">nspkg</span><span class="s2">.</span><span class="s1">subpkg</span><span class="s2">.</span><span class="s1">__version__ </span><span class="s2">== </span><span class="s6">1</span>
</pre>
</body>
</html>