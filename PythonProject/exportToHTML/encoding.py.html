<html>
<head>
<title>encoding.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
encoding.py</font>
</center></td></tr></table>
<pre><span class="s0">#  Copyright 2008-2015 Nokia Networks</span>
<span class="s0">#  Copyright 2016-     Robot Framework Foundation</span>
<span class="s0">#</span>
<span class="s0">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0">#  you may not use this file except in compliance with the License.</span>
<span class="s0">#  You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="s0">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0">#  See the License for the specific language governing permissions and</span>
<span class="s0">#  limitations under the License.</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">sys</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">encodingsniffer </span><span class="s2">import </span><span class="s1">get_console_encoding</span><span class="s3">, </span><span class="s1">get_system_encoding</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">misc </span><span class="s2">import </span><span class="s1">isatty</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">unic </span><span class="s2">import </span><span class="s1">safe_str</span>

<span class="s1">CONSOLE_ENCODING </span><span class="s3">= </span><span class="s1">get_console_encoding</span><span class="s3">()</span>
<span class="s1">SYSTEM_ENCODING </span><span class="s3">= </span><span class="s1">get_system_encoding</span><span class="s3">()</span>
<span class="s1">CUSTOM_ENCODINGS </span><span class="s3">= {</span><span class="s4">&quot;CONSOLE&quot;</span><span class="s3">: </span><span class="s1">CONSOLE_ENCODING</span><span class="s3">, </span><span class="s4">&quot;SYSTEM&quot;</span><span class="s3">: </span><span class="s1">SYSTEM_ENCODING</span><span class="s3">}</span>
<span class="s1">PYTHONIOENCODING </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">getenv</span><span class="s3">(</span><span class="s4">&quot;PYTHONIOENCODING&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">console_decode</span><span class="s3">(</span><span class="s1">string</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">CONSOLE_ENCODING</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Decodes bytes from console encoding to Unicode. 
 
    Uses the system console encoding by default, but that can be configured 
    using the `encoding` argument. In addition to the normal encodings, 
    it is possible to use case-insensitive values `CONSOLE` and `SYSTEM` to 
    use the system console and system encoding, respectively. 
 
    If `string` is already Unicode, it is returned as-is. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">string</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">string</span>
    <span class="s1">encoding </span><span class="s3">= </span><span class="s1">CUSTOM_ENCODINGS</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">.</span><span class="s1">upper</span><span class="s3">(), </span><span class="s1">encoding</span><span class="s3">)</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">string</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">UnicodeError</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">safe_str</span><span class="s3">(</span><span class="s1">string</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">console_encode</span><span class="s3">(</span>
    <span class="s1">string</span><span class="s3">,</span>
    <span class="s1">encoding</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">errors</span><span class="s3">=</span><span class="s4">&quot;replace&quot;</span><span class="s3">,</span>
    <span class="s1">stream</span><span class="s3">=</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">__stdout__</span><span class="s3">,</span>
    <span class="s1">force</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
<span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Encodes the given string so that it can be used in the console. 
 
    If encoding is not given, determines it based on the given stream and system 
    configuration. In addition to the normal encodings, it is possible to use 
    case-insensitive values `CONSOLE` and `SYSTEM` to use the system console 
    and system encoding, respectively. 
 
    Decodes bytes back to Unicode by default, because Python 3 APIs in general 
    work with strings. Use `force=True` if that is not desired. 
    &quot;&quot;&quot;</span>
    <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">string</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s1">string </span><span class="s3">= </span><span class="s1">safe_str</span><span class="s3">(</span><span class="s1">string</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">encoding</span><span class="s3">:</span>
        <span class="s1">encoding </span><span class="s3">= </span><span class="s1">CUSTOM_ENCODINGS</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">.</span><span class="s1">upper</span><span class="s3">(), </span><span class="s1">encoding</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">encoding </span><span class="s3">= </span><span class="s1">_get_console_encoding</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">encoding</span><span class="s3">.</span><span class="s1">upper</span><span class="s3">() != </span><span class="s4">&quot;UTF-8&quot;</span><span class="s3">:</span>
        <span class="s1">encoded </span><span class="s3">= </span><span class="s1">string</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">, </span><span class="s1">errors</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">encoded </span><span class="s2">if </span><span class="s1">force </span><span class="s2">else </span><span class="s1">encoded</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">string</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">, </span><span class="s1">errors</span><span class="s3">) </span><span class="s2">if </span><span class="s1">force </span><span class="s2">else </span><span class="s1">string</span>


<span class="s2">def </span><span class="s1">_get_console_encoding</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">):</span>
    <span class="s1">encoding </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">, </span><span class="s4">&quot;encoding&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isatty</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">encoding </span><span class="s2">or </span><span class="s1">CONSOLE_ENCODING</span>
    <span class="s2">if </span><span class="s1">PYTHONIOENCODING</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">PYTHONIOENCODING</span>
    <span class="s2">return </span><span class="s1">encoding </span><span class="s2">or </span><span class="s1">SYSTEM_ENCODING</span>


<span class="s2">def </span><span class="s1">system_decode</span><span class="s3">(</span><span class="s1">string</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">string </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">string</span><span class="s3">, </span><span class="s1">str</span><span class="s3">) </span><span class="s2">else </span><span class="s1">safe_str</span><span class="s3">(</span><span class="s1">string</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">system_encode</span><span class="s3">(</span><span class="s1">string</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">string </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">string</span><span class="s3">, </span><span class="s1">str</span><span class="s3">) </span><span class="s2">else </span><span class="s1">safe_str</span><span class="s3">(</span><span class="s1">string</span><span class="s3">)</span>
</pre>
</body>
</html>